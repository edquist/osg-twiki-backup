%META:TOPICINFO{author="MatyasSelmeci" date="1318373235" format="1.1" version="1.2"}%
%META:TOPICPARENT{name="InternalDocs"}%
---+ Notes on Koji-Hub Setup (WIP)

---++ Machine setup

koji is run on =koji-hub.batlab.org=; right now a single machine is used for the hub (koji-hub), the web frontend (koji-web), repo generation (kojira), and building (kojid).

Two partitions are used specifically for koji: a 35G partition mounted on =/var/lib/mock= for the builder, and a 120G partition mounted on =/mnt/koji= for everything else.

The server was generally put together using the instructions at [[http://fedoraproject.org/wiki/Koji/ServerHowTo]]. We didn't use the instructions there to create a certs, but got some from DOEGrids instead. (Note that we had to run =dos2unix= on the certs we got from DOEGrids before they would work).

We have 2 certs, with the following subjects:
   * =/DC=org/DC=doegrids/OU=Services/CN=koji-hub.batlab.org= (for koji-hub, koji-web, and kojid)
   * =/DC=org/DC=doegrids/OU=Services/CN=kojira/koji-hub.batlab.org= (for kojira)
kojid needed a different cert than kojira because the two would connect to koji-hub at the same time and log each other off.

---++ Tags

---++++ dist-el5-build
This tag contains 3 external repos:
   $ dist-el5-updates-repo: This is probably badly named. It's a local mirror of the EPEL 5 repository. (url: http://mirror.batlab.org/cobbler/repo_mirror/epel-5-$arch/)
   $ dist-el5-external-repo: A local mirror of the CentOS repositories. (url: http://mirror.batlab.org/cobbler/repo_mirror/centos-5-$arch/)
   $ dist-el5-buildsys-repo: We use this for buildsys macros. (url: http://newman.ultralight.org/repos/buildsys/epel/$arch/RPMS/)
We don't put any packages in it, and generally don't build from it directly, but use tag inheritance.

---++++ el5-osg
This tag contains all the _package names_ that we put into OSG; =koji add-pkg= adds to it. (osg-build does this automatically).
The tag does not actually contain any builds (i.e. packages with version-release).
The el5-osg-development, testing and release tags all inherit from it (technically release does, then testing inherits from release, then development from testing).
The purpose of this is to make promoting builds easier, since it keeps you from having to run =add-pkg= when you promote.

---++++ el5-osg-build
This is used to initialize the buildroot of most packages we make.
It inherits from dist-el5-build and el5-osg-development.
It also contains the jpackage5-bin external repo (url: http://mirrors.dotsrc.org/jpackage/5.0/generic/free/) since we use that for some builds.

---++++ el5-osg-development
This contains the builds in the osg-minefield repo.
The osg-development repo hosted by the GOC takes packages from this, so osg-development is pretty much osg-minefield after a 30-min delay.
It inherits from el5-osg-testing, and also from the more specialized branches like el5-gt52-experimental and el5-gt52b.
Builds that are made using the el5-osg target (default if you're using osg-build) get their buildroot from el5-osg-build and put their results in el5-osg-development.

---++++ el5-osg-testing
This contains the builds in the osg-testing repo.
It inherits from el5-osg-release.

---++++ el5-osg-release
This contains the builds in the osg-release repo.
It inherits from el5-osg.

---++++ el5-gt52-experimental and el5-gt52-experimental-build
These tags were made for Brian Bockelman's work on Globus 5.2 packages.
Since they were a large update composed of multiple packages, having the packages live in a separate tag was necessary to avoid breaking the development repo for other people.
The el5-gt52-experimental target built from el5-gt52-experimental-build to el5-gt52-experimental.

---++++ el5-gt52b and el5-gt52b-build
These tags were made for Matyas Selmeci's work on some Globus 5.2 updates.
The reason separate tags were used instead of el5-gt52-experimental is because we wanted to use Globus's binary RPM repositories for bootstrapping (so we wouldn't have to build all of the packages in dependency order).
This was accomplished by adding the gt52b-external external repo (url: http://bamboo.globus.org/browse/GT512-RPMCENTOS5-7/artifact/repo/centos/5/$arch/) to the el5-gt52b-build tag.
Note that we had to inherit from dist-el5-build instead of el5-osg-build because builds inherited from a local tag trump builds from an external repository, regardless of version or priority, and so our old Globus builds would get picked over what was in gt52b-exeternal.
The el5-gt52b target builds from el5-gt52b-build to el5-gt52b.

When the updates were finished, we had el5-osg-development inherit from el5-gt52b.
However, this turned out not to be enough, since Koji preferred builds in the tag to builds that were inherited, regardless of version or priority.
So all of the updated Globus builds had to be retagged.

---++++ el5-osg-contrib
This contains the builds in the osg-contrib repo.

---++++ dist-el6, dist-el6-build, el6-osg-build, el6-osg-development
Experimental, used for EL 6 work.

---++++ el5-pegasus and el5-pegasus-build
These tags were made for Mats Rynge of the Pegasus project to build into.

---++++ kojira-fake
TODO: Ask Brian what this was used for and if it's still necessary.

