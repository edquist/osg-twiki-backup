%META:TOPICINFO{author="CarlEdquist" date="1425609711" format="1.1" version="1.2"}%
---+ Mass RPM Rebuilds in Koji

Whenever we move to a new OSG series (OSG 3.3) and/or a new RHEL version
(EL7), we want to make new builds for all of our packages in the new koji
build target (osg-3.3-el7).  Due to tricky build dependencies and unexpected
build failures, this can be a messy task; and in the past we have gone about
it in an ad-hoc manner.
 
This document will discuss some of the aspects of the task and issues
involved, some possible appoaches, and ultimately a proposal for a general
tool or procedure for doing our mass rebuilds.


---+++ New RHEL version vs new OSG series

---++++ New RHEL version

For a new RHEL version, we start with no osg packages to build against, so we
are forced to build things in dependency order.  Figuring out the dependency
order is possibly the most difficult (or interesting) part of doing mass
rebuilds -- more on that later.

---++++ New OSG series

For a new OSG series within an existing RHEL version, we have more options.
While it's possible to "start from scratch" the same way we would with a new
RHEL version and build everything in dependency order, this is not really
necessary if we take advantage of existing builds from the previous series.

A prior step is to determine the package list for the new series -- this will
be some combination of Upcoming and the current release series, minus any
packages pruned for the new series.  This should also be reflected in the new
trunk packaging area.  All the current builds for packages in that list (from
upcoming + current series) can be tagged into the new *-development (or
*-build) repos.  This should make all of the build dependencies available for
mass rebuilding the new series all at once:

<verbatim>
[trunk] $ osg-build koji [--nowait] *
</verbatim>

After some consideration, I wholeheartedly endorse this approach for new
OSG series -- for all but academic exercises.  Rebuilding in dependency order
when all the dependencies are already built just seems like wasted effort.


---+++ Doing scratch builds of everything first

Before doing the mass rebuilds in a new build target, it seems to be a good
idea to do scratch builds of all the packages in the current series first.
(Or, at least the ones we intend to bring into the new build target.) This
will give us a chance to see any build failures that have crept in (possibly
due to upstream changes in the OS or EPEL), and fix them first if desired, but
in any case avoid the confusion of seeing the failures for the first time in
the new build target.

Doing mass scratch rebuilds for an existing series is easy!

<verbatim>
[trunk] $ osg-build koji --scratch [--nowait] *
</verbatim>


---+++ options for calculating build dependencies

---+++ pre-computing (predictive) vs as-you-go

---+++ package list closure, pruning


-- Main.CarlEdquist - 05 Mar 2015
