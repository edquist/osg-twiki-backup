%META:TOPICINFO{author="AlainRoy" date="1337632282" format="1.1" version="1.26"}%
%META:TOPICPARENT{name="InternalDocs"}%
<!--
   * Set VERSION = %URLPARAM{"version"}%
-->

---+ How to Cut a Release

%RED%<b>This document is a work in progress.</b>%ENDCOLOR%

It's clear that a lot of things can and should be scripts to simplify the process. Right now, it documents the process as we think it should be, and we can script it later when we know the process is correct.

This document doesn't discuss the policy for deciding what goes into a release. [[SoftwareTeam.ReleasePolicy][The release policy is discussed elsewhere]].

---++ Step 1: Pick the version number

This page will help you get the various commands exactly right. To do this, enter the exact version number (such as %RED%3.0.5%ENDCOLOR%) and click submit. If you do not do this, the commands below will be missing essential text.

<form action="https://twiki.grid.iu.edu/bin/view/SoftwareTeam/HowToCutRelease">
Version: <input type="text" name="version" size="10" value="%URLPARAM{"version"}%"/>
<input type="submit"/>
</form>

---++ Step 2: Create two clean VMs per distro version

Make two VMs, probably in !FermiCloud, so you can do testing. One of them will be used to test a fresh installation on a clean machine (Step 5 below), while the other will be used to test an update from the current release (Step 6 below).

---++ Step 3: Update the osg-version RPM

Edit the osg-version RPM's spec file to update the version number to %VERSION%. Build it in koji:

<pre class="screen">
osg-build koji osg-version
</pre>

When it is finished building, push it to testing:
<pre class="screen">
for x in el5 el6; do
   koji tag-pkg $x-osg-testing osg-version-%VERSION%-1.osg.$x
done
</pre>

---++ Step 4: Populate the osg-prerelease repository

Make sure that the pre-release is empty:
<pre class="screen">
for x in el5 el6; do
   koji list-tagged --quiet $x-osg-prerelease
done
</pre>
should print nothing.

Populate the pre-release. This requires you to understand which packages should be in the release. This is a question of [[ReleasePolicy][policy]]. If you do not know which packages should be in the release, talk to the OSG Software Coordinator. 
<pre class="screen">
for x in el5 el6; do
   koji-tag-diff $x-osg-testing $x-osg-release > pkgs-to-release-$x
done
</pre>
%RED%Edit%ENDCOLOR% pkgs-to-release-* to remove packages not intended for this release.
%RED%Please verify that the =osg-version= RPM is in your set of packages for the release!%ENDCOLOR%
<pre class="screen">
for x in el5 el6; do
   xargs -a pkgs-to-release-$x koji tag-pkg $x-osg-prerelease
   koji regen-repo $x-osg-prerelease
done
</pre>


---++ Step 5: Test a fresh install in VM #1 

You will do a fresh installation. The =osg-test= command below will enable the =osg-prerelease= repository, and the =osg= repository will already be enabled. So packages will be taken from the =osg= repository unless there is a newer version in the =osg-prerelease= repository. 

<pre class="screen">
wget --quiet http://vdt.cs.wisc.edu/native/bootstrap-osg-test
chmod 0755 bootstrap-osg-test
./bootstrap-osg-test testing
osg-test -var osg-prerelease -i osg-tested-internal
</pre>

All tests should pass. If any tests fail, discuss with the OSG Software Coordinator.

---++ Step 6: Test update: in VM #2 

Now you will do an installation just from the =osg= repository, then update it from the =osg-prerelease= repository. This is an important double-check, because we want to know that updates work smoothly. Note that the =osg-test= command skips the installation.

<pre class="screen">
wget --quiet http://vdt.cs.wisc.edu/native/bootstrap-osg-test
chmod 0755 bootstrap-osg-test
./bootstrap-osg-test testing
yum install osg-tested-internal
yum update --enablerepo=osg-prerelease
osg-test -va
</pre>

All tests should pass. If any tests fail, discuss with the OSG Software Coordinator.

---++ Step 7: Wait

Wait for clearance. The OSG Software Coordinator (in consultation with the Software Team and any testers) need to sign off on the update before it is released.

---++ Step 8: Push from pre-release to release: 
<pre class="screen">
for x in el5 el6; do
   koji edit-tag --unlock $x-osg-release
   koji list-tagged --quiet $x-osg-prerelease | awk '{print $1}' > move-to-release-$x
   xargs --arg-file move-to-release-$x koji move-pkg $x-osg-prerelease $x-osg-release
done
</pre>

---++ Step 9: Create a new repo for the new release.

Create a new repo just for this release. This will normally not be seen by users, but can be used by them if necessary. It can also be used by us for testing purposes. <pre class="screen">
for x in el5 el6; do
   koji clone-tag $x-osg-release $x-osg-release-%VERSION%
done
</pre>

---++ Step 10: Lock the repositories

Lock repositories so they can't be messed with. We use edit-tag instead of lock-tag because lock-tag doesn't seem to work.

<pre class="screen">
for x in {el5,el6}-osg-release{,-%VERSION%}; do
   koji edit-tag --lock $x
done
</pre>

---++ Step 11: Regenerate the repositories

<pre class="screen">
for x in {el5,el6}-osg-release{,-%VERSION%}; do
   koji regen-repo $x --nowait
done
</pre>

---++ Step 12: Write release notes

Come up with the following lists to copy and paste into the release notes twiki page:
   1. A list of the updated packages with links to the koji builds that produced them. (=release-note-packages-*=)
   1. An architecture-neutral (i.e. without =i386=, =x86_64=, etc. in the name) list of updated RPMs so that site administrators know the set of RPMs to "yum update" if they want to do a limited update. (=release-note-rpms-*=)
<pre class="screen">
for x in el5 el6; do
   awk '{ print "   * [[https://koji-hub.batlab.org/koji/search?match=glob&type=build&terms=" $1 "][" $1 "]]"}'  move-to-release-$x > release-note-packages-$x 
   xargs --arg-file move-to-release-$x koji buildinfo | fgrep "/mnt" | xargs -n 1 basename | perl -p -e "s/\.(noarch|src|i386|x86_64)\.rpm//" | sort -u > release-note-rpms-$x
done
</pre>
<!--
   1. Come up with a nice table of updated packages that you can copy and paste into the release notes twiki page. <pre class="screen">
awk '{ print "   * [[https://koji-hub.batlab.org/koji/search?match=glob&type=build&terms=" $1 "][" $1 "]]"}'  move-to-release-el5 > release-note-packages-el5
awk '{ print "   * [[https://koji-hub.batlab.org/koji/search?match=glob&type=build&terms=" $1 "][" $1 "]]"}'  move-to-release-el6 > release-note-packages-el6
</pre>
   1. Come up with the architecture-neutral (i.e. without _i386_, _x86_64, etc in the name) list of updated RPMs so that site administrators know the set of RPMs to "yum update" if they want to do a limited update: <pre class="screen">
xargs --arg-file move-to-release-el5 koji buildinfo | fgrep "/mnt" | xargs -n 1 basename | perl -p -e "s/\.(noarch|src|i386|x86_64)\.rpm//" | sort -u > release-note-rpms-el5
xargs --arg-file move-to-release-el6 koji buildinfo | fgrep "/mnt" | xargs -n 1 basename | perl -p -e "s/\.(noarch|src|i386|x86_64)\.rpm//" | sort -u > release-note-rpms-el6
</pre>
-->

Write [[Documentation.Release3.ReleaseNotes][release notes]]. Use the package lists and RPM lists you created in the previous step.

---++ Step 13: Update the info we track for the releases

Using the lists of updated packages, create a full list of packages in the new release and a full list of RPMs in the new release. Copy the lists to an archival directory on the UW's AFS. Change the user name and host name as appropriate. <pre class="screen">
ruser=%RED%roy%ENDCOLOR%
rmachine=%RED%library.cs.wisc.edu%ENDCOLOR%
</pre><pre class="screen">
for x in el5 el6; do
   cp move-to-release-$x %VERSION%-updated-$x.txt
   koji list-tagged --quiet --latest $x-osg-release | awk '{print $1}' > %VERSION%-packages-$x.txt
   xargs --arg-file %VERSION%-packages-$x.txt koji buildinfo | fgrep "/mnt" | xargs -n 1 basename | sort > %VERSION%-rpms-$x.txt
   if [ -d /p/vdt/public/html/release-info/ ] then
      cp %VERSION%-updated-$x.txt %VERSION%-packages-$x.txt %VERSION%-rpms-$x.txt /p/vdt/public/html/release-info/
   else
      scp %VERSION%-updated-$x.txt %VERSION%-packages-$x.txt %VERSION%-rpms-$x.txt $ruser@$rmachine:/p/vdt/public/html/release-info/
   fi
done
</pre>
<!--
   1. Copy the list of updated packages. Change the user name and host name as appropriate. <pre class="screen">
# If not on a UW CS machine:
scp move-to-release-el5 %RED%roy@library.cs.wisc.edu%ENDCOLOR%:/p/vdt/public/html/release-info/%VERSION%-updated-el5.txt
scp move-to-release-el6 %RED%roy@library.cs.wisc.edu%ENDCOLOR%:/p/vdt/public/html/release-info/%VERSION%-updated-el6.txt
</pre><pre class="screen">
# If on a UW CS machine
cp move-to-release-el5 /p/vdt/public/html/release-info/%VERSION%-updated-el5.txt
cp move-to-release-el6 /p/vdt/public/html/release-info/%VERSION%-updated-el6.txt
</pre> 
   1. Find the full list of packages in the new release and copy the list. <pre class="screen">
koji list-tagged --quiet --latest el5-osg-release | awk '{print $1}' > new-packages-el5
koji list-tagged --quiet --latest el6-osg-release | awk '{print $1}' > new-packages-el6</pre><pre class="screen">
# If not on a UW CS machine:
scp new-packages-el5 %RED%roy@library.cs.wisc.edu%ENDCOLOR%:/p/vdt/public/html/release-info/%VERSION%-packages-el5.txt
scp new-packages-el6 %RED%roy@library.cs.wisc.edu%ENDCOLOR%:/p/vdt/public/html/release-info/%VERSION%-packages-el6.txt
</pre><pre class="screen">
# If on a UW CS machine
cp new-packages-el5 /p/vdt/public/html/release-info/%VERSION%-packages-el5.txt
cp new-packages-el6 /p/vdt/public/html/release-info/%VERSION%-packages-el6.txt
</pre> 
   1. Find the full list of new RPMs in the new release and copy the list. <pre class="screen">
xargs --arg-file new-packages-el5 koji buildinfo | fgrep "/mnt" | xargs -n 1 basename | sort > new-rpms-el5
xargs --arg-file new-packages-el6 koji buildinfo | fgrep "/mnt" | xargs -n 1 basename | sort > new-rpms-el6</pre><pre class="screen">
# If not on a UW CS machine:
scp new-rpms-el5 %RED%roy@library.cs.wisc.edu%ENDCOLOR%:/p/vdt/public/html/release-info/%VERSION%-rpms-el5.txt
scp new-rpms-el6 %RED%roy@library.cs.wisc.edu%ENDCOLOR%:/p/vdt/public/html/release-info/%VERSION%-rpms-el6.txt
</pre><pre class="screen">
# If on a UW CS machine
cp new-rpms-el5 /p/vdt/public/html/release-info/%VERSION%-rpms-el5.txt
cp new-rpms-el6 /p/vdt/public/html/release-info/%VERSION%-rpms-el6.txt
</pre>
-->

---++ Step 14: Announce the release

<ol>
<li>Write an announcement. Here is a sample you can edit:<div style="background: #E0F0E0; border: 1px solid gray; padding-right: 2px; padding-left: 2px; padding-top: .5em; padding-bottom: .5em;">
Subject: OSG Software version %VERSION%

Hello,

We're pleased to announce OSG Software version %VERSION%. This is the new OSG Software distributed via RPMs for Scientific Linux 5 and 6, !CentOS 5 and 6, and Red Hat Enterprise Linux 5 and 6. The changes in this release include changes that affect the %RED%SET-OF-METAPACKAGES (client, compute element, etc...)%ENDCOLOR%.

   1. Major change 1
   1. Major change 2
   1. Major change 3

Release notes and pointers to documentation can be found at:
https://twiki.grid.iu.edu/bin/view/Documentation/Release3/%RED%Release304%ENDCOLOR%

Need help? Let us know:
https://twiki.grid.iu.edu/bin/view/Documentation/Release3/HelpProcedure

We look forward to your feedback on this new release. 

-alain
<br>--------------------------------------<br>
Alain Roy<br>
Open Science Grid Software Coordinator<br>
roy@cs.wisc.edu<br>
http://opensciencegrid.org
</div>
<li>Send this announcement to =vdt-discuss@opensciencegrid.org=.
<li>Ask the GOC to distribute this announcement by [[https://ticket.grid.iu.edu/goc/other][opening a ticket]].
</ol>

---++ Step 15: CA Certificates

If this release involves an update to the CA certificates, please have a UW-Madison team member update the LIGO-specific RPM repository. [[CACertsUpdateForLIGO][Instructions on updating the CA certificates in the LIGO repository]]


<!-- vim:ft=twiki
-->