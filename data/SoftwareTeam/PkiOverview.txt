%META:TOPICINFO{author="BrianLin" date="1475014641" format="1.1" version="1.3"}%
%META:TOPICPARENT{name="InternalDocs"}%
---+ OSG PKI Overview

%TOC{depth="3"}%

---++ About this Doc

This document serves as a high-level overview of how users can interact with OIM and in turn, how OIM manages and forwards those interactions to OSG's CILogon CA.

---++ Overview

---+++ Clients

OIM provides a [[http://confluence.grid.iu.edu/display/CENTRAL/OIM+Rest+API+Guide][REST API]] that users can interact with through the [[http://oim.opensciencegrid.org][web interface]], the [[http://oim-itb.opensciencegrid.org][ITB web interface]], or the [[https://github.com/opensciencegrid/osg-pki-tools][OSG PKI tools]] (henceforth referred to as _clients_). Clients are responsible for sending properly formatted calls to the API and handling the responses. 

If the client sends an improperly formatted call (i.e. a bug), OIM should return a failure response.

---+++ OIM

OIM acts as the filter for incoming client calls: it verifies client calls (e.g. VO must be specified for host cert requests for domains that support multiple VOs ) and ensures sufficient authorization (e.g. Does the user have !GridAdmin privileges for the requested domain to approve the certificate?). Certificate issuances or revocations are forwarded onto CILogon while all other calls are used to manage certificates within OIM.

---+++ osg-gridadmin-cert-request

=osg-gridadmin-cert-request= serves as the Grid Admin's tool of choice for acquiring host certificates: it requests, approves, and retrieves certificates with a single command. Grid Admins are able to request certificates for single hosts or a series of hosts, up to 50 at a time.

The command-line tool performs its own argument verification, obtains the user's SSL credentials, and ensures that the user is below quota for the request they are making. After input is verified =osg-gridadmin-cert-request= generates CSRs for each host and submits them to OIM.

If the requesting user is authenticated as authenticated as a Grid Admin for the requestd domain and VO, which must be specified on the command-line if multiple VOs can issue certs for the requested domain, OIM approves the request and sends the =Request ID#= back to =osg-gridadmin-cert-request=.

Upon successful request, =osg-gridadmin-cert-request= sends an approval of the certificate to OIM, which is authenticatd and authorized as before, and OIM turns around and sends a request to CILogon. CILogon issues the certificate(s), sending it back to OIM, and OIM tells =osg-gridadmin-cert-request= that the certificate has been issued successfully.

At this point, =osg-gridadmin-cert-request= sends a retrieval request and OIM sends the certificate(s) back to the client.

<img src="%ATTACHURLPATH%/osg-gridadmin-cert-request.png" alt="osg-gridadmin-cert-request" width="500" length="500"/>

---+++ osg-cert-request

<img src="%ATTACHURLPATH%/osg-cert-request.png" alt="osg-cert-request" width="300" length="300" />

---+++ osg-cert-retrieve

<img src="%ATTACHURLPATH%/osg-cert-retrieve.png" alt="osg-cert-retrieve" width="300" length="300" />

---+++ osg-cert-revoke

<img src="%ATTACHURLPATH%/osg-cert-revoke.png" alt="osg-cert-revoke" width="400" length="400" />

---+++ osg-cert-renew

<img src="%ATTACHURLPATH%/osg-user-cert-renew.png" alt="osg-user-cert-renew" width="400" length="400" />

---+++ osg-user-cert-revoke

<img src="%ATTACHURLPATH%/osg-user-cert-revoke.png" alt="osg-user-cert-revoke" width="400" length="400" />

---++ Resources

   * [[http://confluence.grid.iu.edu/display/CENTRAL/OIM+Rest+API+Guide][OIM REST API]]
   * [[https://docs.google.com/document/d/1wGyV_P-oH3A26YvCtVwVYjW1suovjighCz6XN5VidJM/edit#][CILogon OSG CA Design Doc]]

%META:FILEATTACHMENT{name="osg-gridadmin-cert-request.png" attachment="osg-gridadmin-cert-request.png" attr="h" comment="" date="1474495178" path="osg-gridadmin-cert-request.png" size="28933" stream="osg-gridadmin-cert-request.png" tmpFilename="/usr/tmp/CGItemp12523" user="BrianLin" version="2"}%
%META:FILEATTACHMENT{name="osg-cert-request.png" attachment="osg-cert-request.png" attr="h" comment="" date="1474494189" path="osg-cert-request.png" size="10750" stream="osg-cert-request.png" tmpFilename="/usr/tmp/CGItemp12502" user="BrianLin" version="1"}%
%META:FILEATTACHMENT{name="osg-cert-retrieve.png" attachment="osg-cert-retrieve.png" attr="h" comment="" date="1474494207" path="osg-cert-retrieve.png" size="10863" stream="osg-cert-retrieve.png" tmpFilename="/usr/tmp/CGItemp12487" user="BrianLin" version="1"}%
%META:FILEATTACHMENT{name="osg-cert-revoke.png" attachment="osg-cert-revoke.png" attr="h" comment="" date="1474494219" path="osg-cert-revoke.png" size="16307" stream="osg-cert-revoke.png" tmpFilename="/usr/tmp/CGItemp12716" user="BrianLin" version="1"}%
%META:FILEATTACHMENT{name="osg-user-cert-revoke.png" attachment="osg-user-cert-revoke.png" attr="h" comment="" date="1474494234" path="osg-user-cert-revoke.png" size="16384" stream="osg-user-cert-revoke.png" tmpFilename="/usr/tmp/CGItemp12634" user="BrianLin" version="1"}%
%META:FILEATTACHMENT{name="osg-user-cert-renew.png" attachment="osg-user-cert-renew.png" attr="h" comment="" date="1474494293" path="osg-user-cert-renew.png" size="18310" stream="osg-user-cert-renew.png" tmpFilename="/usr/tmp/CGItemp12494" user="BrianLin" version="1"}%
