%META:TOPICINFO{author="CarlEdquist" date="1361555604" format="1.1" version="1.37"}%
%META:TOPICPARENT{name="InternalDocs"}%
---+!! Migrate from Oracle JDK 6: Technical Details

%TOC%

[[https://jira.opensciencegrid.org/browse/SOFTWARE-890][Main Oracle JDK 6 Deprecation Ticket (SOFTWARE-890)]]

---++ Background

Currently, several of our packages are Java-based, and we build them against
the Oracle JDK 6. Oracle is officially discontinuing public support for Java 6
at the end of February 2013, including security fixes. This is a problem for us due to the
numerous security flaws in Java that people keep discovering. Therefore we must
move away from Oracle JDK 6.

Our replacement for Oracle JDK 6 is !OpenJDK 7.
See the following ticket for discussion: 
[[https://jira.opensciencegrid.org/browse/SOFTWARE-892][Oracle JDK 6 Replacements Ticket (SOFTWARE-892)]]


---++ Java Software in Use (TODO)

Most of this software will need to be certified to work on whichever Oracle JDK 6
replacement we plan to switch to. However, see the notes below.

---+++ Lists

---++++!! Packages depending directly on Oracle JDK

   * bestman2
   * emi-trustmanager-tomcat
   * gridftp-hdfs
   * gums
   * hadoop-0.20
   * jclassads
   * voms-admin-server
   * voms-api-java
   * osg-ce
   * osg-client
   * osg-gridftp-xrootd
   * osg-se-bestman
   * osg-se-bestman-xrootd
   * osg-se-hadoop
   * osg-wn-client
   
---++++!! Packages depending indirectly on Oracle JDK

   * glite-ce-common-java
   * glite-ce-monitor
   * glite-jdl-api-java
   * glite-ce-cream (we don't ship it yet)
   * glite-ce-cream-api-java (we don't ship it yet)
   * glite-ce-osg-ce-plugin
   * rsv-metrics (via bestman2-client)
   * xrootd-hdfs
    
---++++!! OSG Software depending on Java
   * dcache-srmclient
   * gratia 
   * hadoop (ie Hadoop 2.0.0)
   * pegasus

---++++!! Dependencies of OSG Software depending on Java
   * argus-* (argus-pep-api-java, cemon build only)
   * cog-jglobus*
   * cryptix
   * emi-trustmanager*
   * jetty
   * jglobus
   * maven*
   * puretls
   * slf4j
   * xalan-j2
   * xerces
   * zookeeper (hadoop builds)

---+++ Notes:

Since we are planning to deprecate =glite-ce-monitor= (aka !CEMon) in favor of
=osg-info-services=, we may be able to get rid of it and its dependencies,
namely:
   * argus-*
   * glite-ce-monitor
   * glite-ce-osg-ce-plugin
   * jclassads

Since we are planning to deprecate =jglobus-1= in favor of =jglobus-2=, we may
be able to get rid of its dependencies, namely:
   * cog-jglobus
   * cryptix
   * puretls


---++ Groups to Contact (TODO)

Since we do not even remotely have the resources to re-certify all the software
we ship, we should ask the upstream developers for help and information
whenever we can.

(TODO: This list should probably also be a table, and should contain (a) group name; (b); contact info; (c) packages they support; (d) status)

   * gratia team (gratia)
   * EGI (glite-*?)
   * dCache team (dcache-srmclient, others?)
   * ...


---++ Other items

---+++ Koji and SVN

We will create use the "osg-upcoming" tags and targets for this:

Installs can be tested directly out of the osg-upcoming-minefield repos.
The .repo files for the osg-upcoming repos are available in the =osg-release-3.0-22= or newer RPM.

Builds should follow the "upcoming" promotion path, i.e. those that are ready to be tested by external users should go in the =osg-upcoming-testing= repo instead of =osg-testing=.

See UpcomingSoftwareRepoProposal.

We'll put any changes we need to make for the builds in =$SVN/native/redhat/upcoming=

---+++ java-1.7.0-openjdk

Currently, only the most up-to-date EL5 distros have !OpenJDK 7 (as the =java-1.7.0-openjdk= package).

We have no desire to ship !OpenJDK ourselves, so we will be telling users to update their distros if they want it.


---++ Upgrade instructions

NOTES: java uses the "alternatives" system, so in theory it is possible to
install different versions of the jdk side-by-side and pick which one to use.
In practice, not so much. The package =jdk= itself does not use alternatives
and instead creates a symlink =/usr/bin/java -&gt;
/usr/java/default/bin/java=, which alternatives is _not_ going to overwrite.
It's actually =java-1.6.0-sun-compat= that provides the alternatives support
for oracle =jdk=.  But that gets installed _after_ =jdk=, at which point the
=/usr/bin/java= symlink is already screwed up.

On the flip side, =jdk= isn't going to overwrite the =/usr/bin/java= symlink if
it already exists, so if some other version of java is installed _first_, then
the symlink will point to =/etc/alternatives/java=, and once
=java-1.6.0-sun-compat= is installed, the user can use =alternatives --config
java= to pick which runtime they want to use.

Since we can't be sure which situation the user is going to be in, we can
provide the following instructions which, while clunky, should work for either
the "installed oracle jdk first" or the "installed other jdk first" situation:

   1. One of these two:
      1. =yum install java-1.7.0-openjdk java-1.7.0-openjdk-devel=
         * If yum does not find those packages, STOP and update your distro
      1. (once we've switched our packages to require openjdk7) =yum update --enablerepo=osg-upcoming=
   1. =yum erase jdk java-1.6.0-sun-compat= (nothing else should get uninstalled by this)
   1. =yum reinstall java-1.7.0-openjdk java-1.7.0-openjdk-devel=
   1. =yum install jdk java-1.6.0-sun-compat=
   1. =alternatives --config java= and pick one of them
   1. =alternatives --config javac= and pick the same one
   1. Run =java -version= and =javac -version= to make sure the right versions are symlinked. They should both be 1.7.something
   1. Restart java services, for example tomcat. See if they work
   1. If everything works, =yum erase jdk java-1.6.0-sun-compat=

Once we're done with fixing our packages, here's the situations that need to
be tested:

   * ( ) Fresh install of osg, with java not already on the system
   * ( ) Fresh install of osg, with oracle jdk on the system
   * ( ) Fresh install of osg, with some other jdk on the system
   * ( ) Upgrade of osg, with oracle jdk on the system
   * ( ) Upgrade of osg, with some other jdk on the system

---++ Rebuilding notes and general wisdom

---+++!! Virtual dependency for JRE 7 / JDK 7

The virtual dependency provided by =java-1.7.0-openjdk= (which contains the Java Runtime) is _not_ =java=, but =java7=.
Likewise, the virtual dependency provided by =java-1.7.0-openjdk-devel= (which contains the Development Kit) is not =java-devel=, but =java7-devel=.

Also note that the Java packages have an epoch of 1.

This means that not only will Oracle JDK 6 falsely match the requirement
<code>java-devel &gt;= 1.7.0</code>, but !OpenJDK 7 will not match that requirement. Either
use <code>java7-devel</code> or <code>java7-devel &gt;= 1:1.7.0</code>.

The =jdk=, =java-sun=, =java-devel-sun=, and =java-1.6.0-sun-compat= requirements should be replaced by =java7-devel=.
The =java= requirement should be replaced by =java7=.

The Fedora packaging guidelines (which we try to follow when we can) for Java state that all Java builds should both Require and BuildRequire =jpackage-utils=.

---++ Testing

---+++ GUMS

Main.MatyasSelmeci: Briefly did a functional test of GUMS on EL6. 
Set up FC machines in parallel with GUMS from osg-testing:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% yum install -y osg-ca-certs gums-{client,service} fetch-crl globus-proxy-utils
%UCL_PROMPT_ROOT% service mysqld start
%UCL_PROMPT_ROOT% mysql_secure_installation
%UCL_PROMPT_ROOT% mysql -p mysql
&gt;&gt; create user 'gums'@'localhost' identified by 'GUMSPASSWORD';
&gt;&gt; grant all privileges on *.* to 'gums'@'localhost' with grant option;
%UCL_PROMPT_ROOT% gums-setup-mysql-database --user gums --host `hostname`:3306 --password GUMSPASSWORD
%UCL_PROMPT_ROOT% gums-add-mysql-admin YOUR_DN
%UCL_PROMPT_ROOT% fetch-crl
%UCL_PROMPT_ROOT% sed -i -e "s/localhost/`hostname`/" /etc/gums/gums-client.properties
%UCL_PROMPT_ROOT% mkdir -p /etc/grid-security/http
%UCL_PROMPT_ROOT% cd /etc/grid-security/http; for x in cert key; do rm -f http$x.pem; cp -f ../host$x.pem http$x.pem; done
%UCL_PROMPT_ROOT% chown -R tomcat:tomcat /etc/grid-security/http
%UCL_PROMPT_ROOT% /var/lib/trustmanager-tomcat/configure.sh
</pre>
(replace YOUR_DN with your DN, and GUMSPASSWORD with a password for the gums db user)
Then I edited =/etc/gums/gums.config= and made the following changes:
<verbatim class="file">
--- old 2012-04-25 16:29:14.000000000 -0500
+++ new 2012-04-25 16:32:31.000000000 -0500
@@ -31,6 +31,8 @@
                         access='read self'
                         description='Testing GUMS-status with GIP Probe'
                         persistenceFactory='mysql'/>
+
+                <manualUserGroup persistenceFactory='mysql' name='LOGIN'/>
        </userGroups>

        <accountMappers>
@@ -38,6 +40,8 @@
                        name='gums-test'
                        description='Testing GUMS-status with GIP Probe'
                        accountName='GumsTestUserMappingSuccessful'/>
+
+                <groupAccountMapper name='LOGIN' accountName='LOGIN'/>
        </accountMappers>

        <groupToAccountMappings>
@@ -48,13 +52,18 @@
                        accountingVo=''
                        userGroups='gums-test'
                        accountMappers='gums-test'/>
+
+                <groupToAccountMapping name='LOGIN' userGroups='LOGIN' accountMappers='LOGIN'/>
        </groupToAccountMappings>

        <hostToGroupMappings>
+        <!--
                <hostToGroupMapping
                        groupToAccountMappings='gums-test'
                        description=''
                        cn='*/?*.fnal.gov'/>
+        -->
+                <hostToGroupMapping cn='HOSTNAME' groupToAccountMappings='LOGIN'/>
        </hostToGroupMappings>

 </gums>
</verbatim>
(replace =HOSTNAME= with the hostname and =LOGIN= with your login)

At this point you can do the following:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% service tomcat6 start
%UCL_PROMPT_ROOT% gums manualGroupAdd LOGIN YOUR_DN
%UCL_PROMPT_ROOT% gums-host generateGridMapfile
%UCL_PROMPT_ROOT% gums-host mapUser YOUR_DN
</pre>
as well as try out the web interface by going to =https://HOSTNAME:8443/gums=


Once I verified that it worked on both machines, I shut off tomcat6 on the experimental machine, and did the following to replace oracle jdk with openjdk 7:
<pre class="rootscreen">
%UCL_PROMPT_ROOT%; yum install java-1.7.0-openjdk{,-devel}
%UCL_PROMPT_ROOT%; yum erase java-1.6.0-openjdk
%UCL_PROMPT_ROOT%; rpm -e --nodeps jdk java-1.6.0-sun-compat
</pre>
Then I restarted tomcat6, tried the previous tests, and had no problems.


---++ Tracking

For now, we can track the overall state of Java builds here. Try to keep the information brief, so that there is one line per row.

| *Package* | *Owner* | *VR* | *EL5 Status* | *EL6 Status* | *Ticket(s)* | *Notes* |
| bestman2 | Carl | | %ORANGE%Builds wrong (2)%ENDCOLOR% | %ORANGE%Builds wrong (2)%ENDCOLOR% | |
| dcache-srmclient | Mat | | %GREEN%Builds Ok (6)%ENDCOLOR% | %ORANGE%Builds wrong(2)%ENDCOLOR% | | |
| emi-trustmanager-tomcat | Carl | | %GREEN%Builds OK (6)%ENDCOLOR% | %GREEN%Builds OK (6)%ENDCOLOR% | | |
| glite-ce-common-java | Carl | | %GREEN%Builds OK (6)%ENDCOLOR% | %GREEN%Builds OK (6)%ENDCOLOR% | | |
| glite-jdl-api-java | Carl | | %GREEN%Builds OK (6)%ENDCOLOR% | %GREEN%Builds OK (6)%ENDCOLOR% | | |
| glite-ce-osg-ce-plugin | Carl | | %GREEN%Builds OK (6)%ENDCOLOR% | %GREEN%Builds OK (6)%ENDCOLOR% | | |
| gratia (package dir: gratia-service) | Carl | | %ORANGE%Builds wrong (2)%ENDCOLOR% | %ORANGE%Builds wrong (2)%ENDCOLOR% | | See (9) also |
| gridftp-hdfs | Carl | | %GREEN%Builds OK%ENDCOLOR% | %GREEN%Builds OK%ENDCOLOR% | | Doesn't actually contain any jars |
| gums | Carl | | %ORANGE%Builds wrong (2)%ENDCOLOR% | %ORANGE%Builds wrong (2)%ENDCOLOR% | | |
| hadoop | | | Not started | | | Maybe wait on this one |
| hadoop-0.20 | Carl | | %RED%Build Fails (10)%ENDCOLOR% | %RED%Build Fails (10)%ENDCOLOR% | | |
| jclassads | Carl | | %GREEN%Builds OK%ENDCOLOR% | %GREEN%Builds (*)%ENDCOLOR% | | See EL6 issue below.  Builds with JDK 7 |
| jglobus (2) | Carl | | %GREEN%Builds OK (6)%ENDCOLOR% | %GREEN%Builds OK (6)%ENDCOLOR% | | |
| pegasus | Mat | | %GREEN%Builds OK (6)%ENDCOLOR% | %ORANGE%Builds wrong (2)%ENDCOLOR% | | |
| voms-admin-server | Carl | | %ORANGE%Builds wrong (2)%ENDCOLOR% | %ORANGE%Builds wrong (2)%ENDCOLOR% | | |
| voms-api-java | Carl | | %GREEN%Builds OK (6)%ENDCOLOR% | %GREEN%Builds OK%ENDCOLOR% | | See (8) also |


---++ Known Issues

For now, this section contains known problems stemming from builds. For items that require fixing, we will create JIRA tickets eventually. But for now, the plan is simply to capture issues that we know we must address.

   * For EL6 koji builds, buildrequiring the !OpenJDK 7 JDK package brings in Java 5 and Java 6 JDKs as well, and it is unknown which one is actually used to compile in the general case.  The version used to build a jar file can be determined from the Created-By: line in META-INF/MANIFEST.MF (see the attached script below).  So far it varies  :(

   * (1) Ant Error: Could not find or load main class org.apache.tools.ant.launch.Launcher (see (6) for how we are dealing with it in EL5)

   * (2) Installs JDK 7 but still builds with JDK 6

   * (3) error: File not found: /builddir/build/BUILDROOT/glite-ce-common-java-1.14.0-4.2.osg.el6.noarch/usr/share/javadoc/glite-ce-common-java/html/resources/inherit.gif (or similar .../html/resources/inherit.gif)
     ... The issue with this one is a different set of .gif files under .../html/resources/ is generated for the -doc package.  The fix is just to list .../html/resources/*.gif instead

   * (4) Caused by: org.apache.maven.plugin.MojoExecutionException: An error has occurred in JavaDocs report generation:Exit code: 1 - /builddir/build/BUILD/JGlobus/gridftp/src/main/java/org/globus/ftp/FTPClient.java:2066: error: unmappable character for encoding ANSI_X3.4-1968

   * (5) Error: Could not find or load main class org.codehaus.classworlds.Launcher

   * (6) Uses the jpackage-utils package from centos in our upcoming repo

   * (7) [javac] javac: target release 1.5 conflicts with default source release 1.7

   * (8) The java version in the jar file is 23.2-b09, but apparently that is tied to 1.7.0_06 ... it would be nice to find a better way to identify which JDK it was built with

   * (9) For some reason with the EL6 build of gratia, the build finishes but javac gets stuck running indefinitely ... speculation is that there may be a race condition, and we may want to see if ant has an option to build serially

   * (10) BUILD FAILED
     /builddir/build/BUILD/hadoop-0.20.2+737/build.xml:400: Unable to find a javac compiler; com.sun.tools.javac.Main is not on the classpath.
     Perhaps JAVA_HOME does not point to the JDK.
     It is currently set to "/usr/lib/jvm/java-1.7.0-openjdk-1.7.0.9.x86_64/jre"

   * [[%ATTACHURL%/jar-jdk-version.sh][jar-jdk-version.sh]]: script to scrape Created-By: java version out of a .jar file

   * [[%ATTACHURL%/rpm-jar-creators.sh][rpm-jar-creators.sh]]: script to scrape Created-By: java version from jars inside an rpm

%META:FILEATTACHMENT{name="jar-jdk-version.sh" attachment="jar-jdk-version.sh" attr="" comment="script to scrape Created-By: java version out of a .jar file" date="1360949289" path="jar-jdk-version.sh" size="165" stream="jar-jdk-version.sh" tmpFilename="/usr/tmp/CGItemp58239" user="CarlEdquist" version="1"}%
%META:FILEATTACHMENT{name="package-deps.png" attachment="package-deps.png" attr="" comment="dependancy chart for these java packages, based on spec files" date="1360972624" path="package-deps.png" size="74088" stream="package-deps.png" tmpFilename="/usr/tmp/CGItemp62233" user="CarlEdquist" version="1"}%
%META:FILEATTACHMENT{name="rpm-jar-creators.sh" attachment="rpm-jar-creators.sh" attr="" comment="script to scrape Created-By: java version from jars inside an rpm" date="1361317701" path="rpm-jar-creators.sh" size="257" stream="rpm-jar-creators.sh" tmpFilename="/usr/tmp/CGItemp59725" user="CarlEdquist" version="1"}%
%META:TOPICMOVED{by="TimCartwright" date="1360863372" from="SoftwareTeam.Java6MigrationProject" to="SoftwareTeam.Java6MigrationDetails"}%
