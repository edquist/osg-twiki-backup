%META:TOPICINFO{author="ScotKronenfeld" date="1333381686" format="1.1" reprev="1.4" version="1.4"}%
%META:TOPICPARENT{name="TestingHome"}%
---+ Test Fest Ideas

These are the ideas for test development that came out of the Test Fest, Wednesday, March 28, 2012, partially expanded on by Tim afterward. In the near future we'll decide what we'll actually do and turn those things into JIRA tickets.

   * [SK:] Instead of the =-p= option to osg-test, which always requires that the password be given explicitly on the command line, allow for the user to enter a password interactively using =getpass()=.

   * [DS:] Allow for multiple, conflicting configurations of storage components. [TC:] Actually, this sits outside osg-test, and needs to be part of our system for running tests and their top-level packages. But, yes!

   * [DS:] Add optional timeout to =core.system()=. [TC:] Another approach, that *might* be more workable, is to put a timeout around the running of each test function. Obviously, this is something that would have to be done in the driver, which we do not have control over just yet. Also, it might be rather difficult to get right, if I understood the discussion around the table on Wednesday. Nonetheless, preventing a test from deadlocking the entire test run is a huge idea and one that we should pursue. [SK:] I think that every single test should have a default (but overridable) timeout associated with it - and that we should set the default to a low value such as 30 seconds or a minute.  That way, if things start hanging for some reason the test suite will still return in a reasonable length of time.  That said, a timeout to the system command would be useful because some commands might need cleanup post-timeout, or else maybe a timeout is expected.  I don't know if getting two levels of timeouts to play nicely is trivial...

   * [SK:] We probably want to start services using =/sbin/service= quite a bit. There might be certain things to look for from the service command (e.g., output, return code). Maybe we should wrap code like this into a core function with more error handling? [code omitted] [TC:] Mat and I talked about this idea on Thursday, and I believe that Mat has committed all or part of his solution already. The basic idea is to provide a new library file, =services=, with functions for starting and stopping services. These functions will register standardized keys in =core.config= and =core.state= to preserve critical data.

   * [NS:] The =-c= option should try to remove the test user if and only if the test user was created by the test run in the first place. [TC:] Yes, I believe that this should be done, plus more. I would change =special_cleanup= to *always* run, and therefore make each function therein more careful about acting only when appropriate. I *think* the RPM erase function is already quite safe, in that it carefully checks to see which packages were installed before removing any. For Neha’s suggestion, we would need to add state about whether *we* created the test user, and then skip the test-user removal accordingly. Also, see below for more ideas regarding the cleanup steps.

   * [MS:] Add calling test function name to =system()= logging output. [TC:] Mat hacked something in for this already.

Finally, *it was resolved* that we will follow the PEP 8 coding style guidelines, except that the maximum length of a code line will be 120 characters, and the maximum length of a comment or docstring line will be 80 characters.

---++ Later Ideas

   * In =files=, the system for backing up and restoring files is weak. Here’s what TC and SK settled on for a next-better solution: When backing up a file, back it up to =/usr/share/osgtest/= or somewhere like that, and then record a tuple of the “owner” (an arbitrary key, perhaps conventionally the calling function class and name?), the original path, and the backup path. The restore function would have to change to take the owner information. Then, at the very end of all tests (after the RPM erase bit, now always run), assert that then dictionary of backup files is empty. Thus, anyone who writes a file (with a backup) is responsible for restoring the file later. It is not a perfect system, but it helps with a couple key issues: Knowing what to restore and when, and not leaving stray backups around.

   * Add a try-except block to the top-level script to catch Ctrl-C out of a (presumably hung) test. The handler should print (and flush) a message, then attempt to run the cleanup module, then exit. That way, at least we are attempting to do basic cleanup, even when things go horribly wrong.

   * [SK:] We need a way of testing the test suite.  Each day (or each commit or something else reasonable) we should run the test suite against a known good software stack such as the osg-release repo.  This will help us catch bad tests early on.
