%META:TOPICINFO{author="DougOlson" date="1256327484" format="1.1" reprev="1.1" version="1.1"}%
%META:TOPICPARENT{name="SecurityTeamWorkingArea"}%
---+!! Root Cause Analysis of Certificates issued with bad EKU extension, Oct. 2009

%TOC%

---++ Synopsis
A change was made to the profile of DOEGrids End Entiry certificates adding the extendedKeyUsage (EKU) extension on Oct. 12, 2009.
For OU=Services certificates this extension was marked as critical and for OU=People this extension was marked as non-critical.
This was done as part of DOEGrids effort to become compliant with the Grid Certificate Profile (OGF document GFD 125).
According to GFD125 this extension should be non-critical for all End Entity certificates.
When a GUMS server is using one of these certificates authentication to the server fails and the GUMS server
becomes unusable. There are other use cases where these certificate cause authentication to fail.
The OSG trouble ticket for this event is 7637.
The changes to DOEGrids certificates were rolled back on Oct. 19, 2009 and affected parties notified in the following days.

---++ Timeline

|  *Date/time*  | *Event*  |
|  12 Oct.  11:11am PDT  | First certificate issued with bad EKU, serial# 37589 (0x92D5)  |
|  12 Oct.  5:13pm PDT  | Notice sent to DOEGrids PMA advising of change in certificate profile |
|  18 Oct.  8:03pm EDT  | Ticket 7637 opened at GOC on report from Steve Timm |
|  19 Oct.  6:15am PDT  | Notice to OSG security team regarding ticket 7637  |
| 19 Oct.  | Numerous communications between OSG and ESnet people  |
|  19 Oct.  2:30pm PDT  | Last certificate issued with bad EKU, serial# 38143 (0x94FF)  |
| 19 Oct.  4:25pm PDT  | Notice from Dhiva (ESnet) to several OSG parties that EKU was removed from certificates.  |
| 22 Oct.  | Notice sent by ESent to all recipients of affected OU=Services certificates regarding changes and advising to get new certificates if problems are encountered with the defective ones.  |

---++ Background
The CAOps working group in OGF has published the [[http://www.ogf.org/documents/GFD.125.pdf][Grid Certificate Profile (GFD 125, March 2008)]] which describes characteristics of X.509 certificates so they will work in the grid infrastructures around the world.  The [[http://www.igtf.net/][IGTF]] has adopted this document as a recommendation for CAs accredited by the IGTF.
ESnet has made changes to the profile of DOEGrids CA issued certificates to bring them into closer compliance with GFD125.
_Dhiva should adjust the  following text on ESnet procedures._
The normal ESnet test procedure is to make changes on a test CA, issue some test certificates, and check them with a [[https://www.eugridpma.org/cgi-bin/cvsweb.cgi/util/checkcerts/][tool]] from !EUGridPMA
that reports on compliance with GFD125.
After testing, the changes are applied to the production CA and a notice sent to the DOEGrids PMA.
These procedures were followed in this case, except on the production CA the OU=Services certificates had the EKU extension mistakenly marked as critical.

---+++ Testing
Certificates issued from the test CA instance were tested against the !EUGridPMA tool for compliance with GFD 125.

---+++ Not Tested
The certificate issued from the production CA were not tested against the !EUGridPMA tool.  Certificates from the production CA were not tested against the OSG software.

---++ Impact
One of the CMS production gatekeepers at FNAL (cmsosgce4) was offline for 1 hour while diagnosis was performed.

At UCSD a GUMS server used for CMS job submission which was out of service due to certificate expiration
failed in attempts to be put back in service due to the defective certificate.  After the certificates were fixed the GUMS server was put back into
service with a working certificate. During the outage period (starting with certificate expiration) the CMS job submission system used
a different GUMS server which was functional.

A few recipients of the OU=People certificates have been queried and no problems are reported.  This include access to VOMS/VOMRS and some grid authentications.

---++ Fix
Changes to the DOEGrids CA on Oct. 12 were rolled back on Oct. 19.  The affected parties that got new certificates reported that they worked fine.

---++ Recommended changes to procedures
Any future modification of the certificate profile from DOEGrids should be tested on the OSG infrastructure before being put into production.  The details of how this happens is TBD.


-- Main.DougOlson - 23 Oct 2009
