%META:TOPICINFO{author="MineAltunay" date="1217977665" format="1.1" reprev="1.2" version="1.2"}%
%META:TOPICPARENT{name="IncidentInformation2008"}%
%TOC%
---+ OSG-SEC-2008-08-05-2008

_Three recent incidents all related to ssh attacks and rootkit exploits have been detected. We have not confirmed whetherall three are linked or not. However, they seem to share the same attack vector._

First attack has affected the German Grid and been reported to EGEE. German Grid has some sites registered in EGEE and it is a national grid.Another very similar attack has been detected at U of Chicago and has been posted at http://hep.uchicago.edu/admin/report_072808.html

U Chicago confirmed that this is not an OSG site that has been attacked and therefore there is no OSG incident. The OSG resources at U Chicago are unaffected by the attack.

It seems that that the attacking malicious IPs are (to German Grid)

~ 208.42.23.94 - 2008-07-28 01:52:53 GMT+02

~ 216.186.49.132 - 2008-07-26 17:02:12 GMT+02

~ 75.60.89.233 - 2008-07-26 23:16:40 GMT+02

EGEE security team believes that the stolen ssh keys were transfered to:

~ 136.159.55.31 - 2008-07-28 02:16:14 GMT+02

Currently EGEE team is contacting the above IP addresses for verification.

The CERN security team also detected another attack with the same attack vector from one of the malicious IP addresses. They have reason to believe that user Karl Harrison's account at CERN has been compromised. EGEE/CERN Security officer has not confirmed whether this user's X509 certificate is also compromised.

In OSG, this user has the following access rights:

"/C=UK/O=eScience/OU=Cambridge/L=UCS/CN=karl harrison002" "/atlas" usatlas4

Atlas and USAtlas Security Officers have confirmed that the last activity submitted by this user is dated 2006-04-12 10:15:58. They think that there should not be any active jobs submitted by this user recently. Atlas security officers have removed this user from the Atlas VOMS as a precaution and will ask him to get a new certificate.

All site admins should synchronize their GUMS servers with the Atlas VOMS server to download the latest membership list.

Attack Vector:The attacks are caused by stolen ssh keys and used local kernel exploits to gain root access. Rootkits were installed and SSH keys have been systematically stolen and used to compromise further sites. Artifacts found on the compromised hosts:

~ .p2rc some sort of config file setting aliases for copying

~ stuff by ssh and with ssh-keys provided

~ .phalanx2 loader of the rootkit and probably backdoor

~ .sniff sniffer log

~ sshgrab.py python script for collecting ~/.ssh dirs and shell ~ histories of all users if readable

There has been a rootkit called phalanx for some time which can be found at packetstorm:

~ http://packetstormsecurity.nl/UNIX/penetration/rootkits/phalanx-b6.tar.bz2 We heard that there seems to be a newer version of that rootkit. It also uses /dev/mem to manipulate the kernel and modify the hooks for some system calls. /dev/shm is used for staging, storing some of the file. The same directory is used by the python script. Hints for finding the rootkit and a shell script :

#!/bin/bash

for PID in `seq 1 65535`;

    do

~        if kill -0 ${PID} 2>/dev/null

~        then

~                  if ls _/proc/_* _/task/_* _/cmdline | grep "task/_ ${PID}/cmdline"

                     > <cite>/dev/null</cite>

~          then

~                         true

~                   else

~                           CMD=`cat _/proc/_ ${PID}/cmdline`

~                           echo "PID ${PID} versteckt?! cmdline: '${CMD}'"

~                   fi

~       fi

done

---++ Status

   * *Status*: _OPEN_ 
   * *Lead*: MINE ALTUNAY at maltunay@fnal.gov at 630-840-6490 
   * *Responders*: _list of involved responders (for resource tracking)_ 
   * *References*: _CERNCERT20080805_ 

_Optionally include additional status information here._

---++ Analysis

   * *Severity*: _Medium (see IncidentResponseProcess):_ If the user's certificate is proven to be compromised and ssh attacks continue to target grid sites, the severity should be elevated to high. Currently, we have no reason to believe a grid epidemic is on its way. 
   * *Urgency*: _Medium (see IncidentResponseProcess): site admins can multi-task their responses with other tasks. Because suspicious certificate have been removed from Atlas VO, the site admins do not need to do take any additional action. The site GUMS or gridmap files should already be set to automatically synchronize with the Atlas VOMS._ 
 <em>The severity and urgency will be elevated to high if grid sites are continued to be attacked. We will ask site admins to watch for any suspicious connections from malicious IP addresses. <br /></em> 
---++ Mitigation Plan

We contacted USAtlas and Atlas security officers and received the following report from Dantong Yu:

_Please make announcement to the OSG site. I checked various system in BNL, and did not discover any suspicious activities from this particular user. I asked Jay to suspend this user from the ATLAS VOMS server. Alessandro agreed to remove this user from Atlas VOMS._

_Here is what we found: <br /><br />1) This user has a local account, but he has no activities in past few years. His logon shell is /bin/tcshnologin. Our system admin is pretty sure that BNL is not affected by this user. <br /><br />2) We checked that our OSG gatekeeper logs. We did not see any job submitted by this user. <br /><br />3) GUMS shows that this user was mapped to usatlas4 account. <br /><br />4) The ATLAS analysis framework shows that this user submitted a job on 2006-04-12 10:15:58. We removed this user from ATLAS database to prevent him from submitting jobs._
---+++ Actions to take

1) Our first action is to contact USAtlas and Atlas security officers and obtain a report (see above email from Dantong Yu)

2) Receive confirmation from EGEE to re-distribute the announcement (has already obtained as of 08-05 17:00 )

3) receive ET approval over OSG announcement

4) send announcement to OSG sites and ask them to watch malicious IP addresses and the above user certificate. Sites should be able to automatically update their GUMS server

they should report any suspicious activity in this user's account and from above IP addresses.

5) We can possibly check whether sites have updated from Atlas VOMS server. This is optional and not necessary.
---+++ How to monitor progress

We can use Gratia checks to see whether any jobs have been submitted with Karl Harrison's certificate.

We can also check if all sites have updated their GUMS server. We can send a notification. This is optional.
---+++ Acceptable response time estimate

Because site admins do not need to take any manual action except checking their log files and ensuring ssh keys are protected, we do not expect any response from them.

The GUMS updates should occur automatically by default every 7 hours.

---+++ List of affected parties

All OSG sites who accepted Atlas users are affected. We believe that previous incidents at U Chicago and German Grid did not affect the OSG. We are informed that no user certificates have been compromised in both incidents.

---+++ Definition of End Of Event

_When the user karl Harrison receives a new certificate and all OSG sites updates their GUMS servers._

---++ Incident Log

_Append descriptions of response activities here. Sign and date each log entry. Use the "signature to copy/paste" provided below the twiki edit box. Attach supporting materials to the twiki page._

Here's an example log entry. -- Main.JimBasney - 01 Jul 2008

---++ Summary

   * *Final Report*: [[https://osg-docdb.opensciencegrid.org:440/][OSG !DocDB Document ###]] 

_What was the resolution of the incident?_

_What is the long-term mitigation plan (including changes in our operations, middleware or anything else that enabled the event) and timeline?_

_Deposit the final incident report in !DocDB and fill in the !DocDB URL and document number above._

---++ Access Control

_Uncomment the appropriate access control policy for this incident page. Logout of the twiki and try to access the page to ensure it is not publicly accessible._

Incident information accessible by Security Team members and GOC only:
   * #Set ALLOWTOPICVIEW = Main.SecurityTeamGroup, Main.GocGroup 
   * #Set ALLOWTOPICCHANGE = Main.SecurityTeamGroup, Main.GocGroup 

Incident information accessible by all authenticated twiki users:
   * #Set ALLOWTOPICVIEW = Main.GridGroup 
   * #Set ALLOWTOPICCHANGE = Main.GridGroup 

-- Main.MineAltunay - 05 Aug 2008
