%META:TOPICINFO{author="JimBasney" date="1238508709" format="1.1" reprev="1.16" version="1.16"}%
%META:TOPICPARENT{name="IncidentInformation2008"}%
%TOC%
---+ OSG-SEC-2008-12-15

The [[http://vdt.cs.wisc.edu/components/glexec.html][glexec]] configuration distributed with VDT does not validate the proxy it was given.
This could potentially allow an attacker to change to any other UID (but not root) once on the worker node.
In our analysis, the vulnerability is exploitable only by locally authenticated users who can submit jobs to worker nodes.

---++ Status

<!--
Suggested status labels:
NEW: Initial report is received but incident is not confirmed.  This is a triage phase.
OPEN: The existence of a security incident requiring response has been confirmed. The response is underway.
RESOLVED: The incident has been resolved but the final report has not been submitted.
CLOSED: The final report has been submitted.
--> 

   * *Status*: OPEN 
   * *Lead*: Main.JimBasney
   * *Responders*: Main.JimBasney, Main.IgorSfiligoi, Main.AlainRoy, Main.GabrieleGarzoglio, Main.AashishSharma, Main.MineAltunay
   * *References*: [[https://tick.globalnoc.iu.edu/MRcgi/MRentrancePage.pl][Footprints]] ticket #6145, VDT ticket #[[http://crt.cs.wisc.edu/index.html?user=guest&pass=guest&q=4582][4582]]

---++ Analysis

   * *Severity*: Medium - immediate exploit is unlikely
   * *Urgency*: Medium - multitask response with other important tasks

---++ Mitigation Plan

---+++ Actions to take

   * %Y% Notify affected sites.
   * %Y% Issue a new VDT release with a fix: [[http://vdt.cs.wisc.edu/releases/1.10.1/release-r.html][VDT 1.10.1r Release Notes]]
   * Issue a new VDT release with a fix for !CentOS5/SL5.

---+++ How to monitor progress

To verify that the proxy is being validated, by forcing a failure:<br>
Remove the CA cert from the trusted certificates area and
perform the usual gLExec tests
(http://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/GlexecInstall#Testing_gLexec)
and glexec should fail.<br>
For example, if using DOEGrids certificates, the procedure is as follows:
<verbatim>
cd /etc/grid-security/certificates
mkdir a
mv 1c3* a/
(perform the glexec test -> must fail)
(finally move back the DOEGrids CA cert back in place (and optionally retest with success)) 
</verbatim>

Glexec logs can be monitored for suspicious activity. For details, see:
http://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/GlexecInstall#About_the_gLexec_log_files

---+++ Acceptable response time estimate

A VDT update is expected by Fri Dec 19. Update released Fri Dec 19.

---+++ List of affected parties

This issue only affects OSG deployments (the bug is specific to the OSG glexec deployment) and then only a subset of it.
FNAL and UCSD use glexec. BNL uses it too.

We estimate 10 USCMS sites are affected.
Response should be coordinated with Burt and Kent from USCMS.

For USATLAS sites, only BNL and SLAC have gLexec installed.
Notify Xin Zhao <xzhao@bnl.gov>.

---+++ Definition of End Of Event

End of event occurs when a fix is released by VDT.

---++ Incident Log

---+++ 15-Dec-2008: Initial Report
<verbatim>
Subject: glexec security problem
Date: Mon, 15 Dec 2008 16:27:25 -0600
From: Sfiligoi Igor <sfiligoi@fnal.gov>

Hi all.

We just found out that glexec configuration distributed with VDT is
wrong and does not validate the proxy it is given.
This could potentially lead to an attacker to change to any other UID
(but not root) once on the worker node.

The error is in the LCMAPS configuration file
/etc/glexec/lcmaps/lcmaps-suexec.db

The current one (in VDT is)
------------------------
path = MAGIC_VDT_LOCATION/MAGIC_VDT_PACKAGE/MAGIC_VDT_LIB/modules

good = "lcmaps_dummy_good.mod"
bad  = "lcmaps_dummy_bad.mod"

gums = "lcmaps_gums.mod -exec
MAGIC_VDT_LOCATION/MAGIC_VDT_PACKAGE/contrib/gums_interface/getmapping"

glexec_get_account:
gums -> good | bad
------------------------

instead, it should be
------------------------
path = MAGIC_VDT_LOCATION/MAGIC_VDT_PACKAGE/MAGIC_VDT_LIB/modules

good = "lcmaps_dummy_good.mod"
bad  = "lcmaps_dummy_bad.mod"

gums = "lcmaps_gums.mod -exec
MAGIC_VDT_LOCATION/MAGIC_VDT_PACKAGE/contrib/gums_interface/getmapping"

verifyproxy = "lcmaps_verify_proxy.mod"
           "--allow-limited-proxy"
           " -certdir /etc/grid-security/certificates"

glexec_get_account:
verifyproxy -> gums
------------------------
PS: This assumes the CA certificates are in /etc/grid-security/certificates.

Igor
</verbatim>

---+++ 16-Dec-2008: Phone Conference
Attending: Jim, Aashish, Gabriele, Igor, Alain<br>
Summary: glexec security flaw can be fixed by editing config file.
Affects VDT 1.8 and 1.10 -- same fix applies to both.<br>
How much effort to fix? Half a day to issue VDT update.<br>
glexec update planned for middle to end of February. new config. new binary.<br>
10 sites affected? 4-5 tier2 cms sites installed and configured. notify Burt and Kent (USCMS).<br>
goal: prevent deploying new version of glexec with this problem.
just as easy to fix as it is to disable.<br>
Igor and Gabriele around until end of week.<br>
Scott and Igor will work to release new glexec this week.<br>
Just update VDT 1.10. Provide manual instructions for 1.8.<br>

---+++ 18-Dec-2008: !CentOS5/SL5 Issue
<verbatim>
Subject: Re: glexec security problem
Date: Thu, 18 Dec 2008 11:37:53 -0600
From: Sfiligoi Igor <sfiligoi@fnal.gov>

Hi All.

Further tests on glexec show that the new configuration solves the
problem on SL4 (32 and 64bit), but does not work on CentOS5/SL5.
The verify_proxy plugin returns a strange error what neither myself nor
the glexec/lcas developers understand.

Unfortunately, it is unlikely that this will be solved before mid
January; most people involved are on vacation starting end of tomorrow.
Plus, sl5 is not really supported by EGEE so we were the only ones that
were supposed to be using it (and testing it).

At this point, I suggest we drop support for anything but rhel4/sl4 for
gLExec in VDT 1.10.1.
Burt confirmed CMS does not use it on anything else right now, and my
guess is that nobody else uses it on SL5 either.

Please let me know ASAP what do you think about this.

Igor
</verbatim>

---+++ 19-Dec-2008: VDT 1.10.1r released
<verbatim>
Subject: VDT 1.10.1r has been released (fixed URL)
Date: Fri, 19 Dec 2008 13:23:47 -0600
From: Alain Roy <roy@cs.wisc.edu>
To: vdt-discuss@OPENSCIENCEGRID.ORG

Hello,

The VDT team is pleased to announce that VDT 1.10.1r has been released.

This release contains:

1) A security fix for glexec.
2) A new version of the Generic Information Provider that fixes bugs.
3) A new version of Bestman that fixes bugs.
4) Improved configuration for LFC.

Details, including update instructions, are online at:
http://vdt.cs.wisc.edu/releases/1.10.1/release-r.html

Please contact us with any concerns or questions.

-alain

-----------------------------------------------------------------
Alain Roy
Open Science Grid Software Coordinator            roy@cs.wisc.edu
http://opensciencegrid.org                 http://vdt.cs.wisc.edu
</verbatim>

---+++ 5-Jan-2009: FermiGrid Update
<verbatim>
Subject: Re: glexec security problem
Date: Mon, 05 Jan 2009 15:01:27 -0600
From: Keith Chadwick <chadwick@fnal.gov>
To: Jim Basney <jbasney@NCSA.UIUC.EDU>, SECURITY-DISCUSS-L@OPENSCIENCEGRID.ORG

FermiGrid has not deployed the fix.  We do not expect to deploy the
fix until scheduled downtimes following availability of the SL5 fix.

On the other hand, the FermiGrid Site Authorization Service (SAZ) service,
which is deployed on the worker nodes that have gLExec installed, does
validate the proxy, and it is are belief that this would prevent this exploit.

-Keith.

At 2:28 PM -0600 1/5/09, Jim Basney wrote:
>Hi everyone,
>
>I wonder if we can consider the glexec security problem closed now. Do
>we have confirmation that the affected sites have all installed the fix?
>Are there other outstanding issues?
>
>I'm aware of the CentOS5/SL5 incompatibility, but I'm inclined to
>consider that separately from the security problem.
>
>Thanks,
>Jim
</verbatim>

---+++ 22-Jan-2009: Fix in VDT test cache

A new package 

glexec-osg-0.6.3

has been created in the VDT test cache.

The new glexec has been tested on 32-bit SL4 and SL5 and it does work on both, validating the proxy as expected.
(Both the functioning when the proxy can be validated, and the denial when it cannot be has been tested)

Igor Sfiligoi

---++ Summary

   * *Final Report*: [[https://osg-docdb.opensciencegrid.org:440/][OSG !DocDB Document ###]]

_What was the resolution of the incident?_

_What is the long-term mitigation plan (including changes in our operations, middleware or anything else that enabled the event) and timeline?_

_Deposit the final incident report in !DocDB and fill in the !DocDB URL and document number above._

---++ Access Control

_Uncomment the appropriate access control policy for this incident page. Logout of the twiki and try to access the page to ensure it is not publicly accessible. Do not attach files, as they will not be protected (see  [[http://twiki.org/cgi-bin/view/TWiki/TWikiAccessControl#Controlling_access_to_Attachment][http://twiki.org/cgi-bin/view/TWiki/TWikiAccessControl#Controlling_access_to_Attachment]])._

Incident information accessible by Security Team members, GOC, and other responders:
   * #Set ALLOWTOPICVIEW = Main.SecurityTeamGroup, Main.GocGroup, Main.GabrieleGarzoglio, Main.IgorSfiligoi, Main.AlainRoy
   * #Set ALLOWTOPICCHANGE = Main.SecurityTeamGroup, Main.GocGroup, Main.GabrieleGarzoglio, Main.IgorSfiligoi, Main.AlainRoy

Incident information accessible by all authenticated twiki users:
   * Set ALLOWTOPICVIEW = Main.GridGroup
   * Set ALLOWTOPICCHANGE = Main.GridGroup
