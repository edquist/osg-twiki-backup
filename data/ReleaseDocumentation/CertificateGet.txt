%META:TOPICINFO{author="JimBasney" date="1231448484" format="1.1" reprev="1.28" version="1.28"}%
---+ How do I get a DOEGrids PKI/X509 Personal Certificate?

%TOC%

%NOTE% For instructions for getting DOEGrids *service* and *host* certificates, *you're in the wrong place*. See [[ReleaseDocumentation/GetGridCertificates][Get Host Certificates]].

---++ Introduction

If you don't know what a X509 certificate is or what it is used for, see [[CertificateWhatIs][What is a certificate?]].

This document describes how to get and set up a *personal* certificate (also called a grid user certificate), from DOEGrids, a U.S. government certificate authority (CA). DOEGrids is recognized by all OSG resources. Other CAs may be used; if your virtual organization (VO) requires that you get a certificate from a different CA, [[http://www.opensciencegrid.org/?pid=1000187][contact your VO Support Center]] for instructions.
---++ Know Your Responsibilities

When you request a certificate your provide some public personal information about yourself; _name, email address, phone number_, and which Registration Authority ( _RA_) affiliation you have (usually OSG), and which _VO_ (virtual organization) you belong to. If any of this information changes after you have your certificate you should notify your RA (and probably VO) of the changes. For the OSG RA send email to osg-ra at opensciencegrid dot org.

Your *name* and *email* address are encoded into the signed certificate and *if either of those change* (usually email address) then you should *request a new certificate* with the correct information and *revoke the old certificate*.

The DOEGrids CA send out notices warning of certificate about to expire starting 30 days before expiration, using the email address provided when you requested the certificate. If you change your working email address then you will not receive the notices and your certificate will probably expire without your knowledge and you will have to request a new certificate instead of being able to use the self service replacement interface to get a new certificate immediately before the old one expires.

If the *information* in the certificate *becomes invalid*, like *email address change*, *name change*, or *private key lost*, then the *certificate should be revoked*. The CA and RA will make some attempt to contact the certificate owner before revoking the certificate but if the email address is bad then it is likely the certificate gets revoked without your knowledge.

---++ Preparation

%NOTE% If you're going to request a certificate via your web browser, skip this section and jump to the Web browser based instructions below.

Instructions below describe using the cert-scripts package in VDT to request, retrieve and renew a certificate. To check that these are available, execute the following commands
<verbatim>> *source $VDT_LOCATION/setup.sh*  # for sh shell variants 
> *source $VDT_LOCATION/setup.csh*  # for csh shell variants 
> *cert-request -V* checking script version, V2-4,  This one is OK.  Latest version is V2-5. 
  cert-scripts package version: V2-4   CertLib version: V2-4 </verbatim> If this succeeds then proceed with the script based instructions below. If you get an error, then you can either install the cert-scripts package or use the web browser instructions below.

---+++ Install cert-scripts package
 Follow the instructions for installing the cert-scripts package into a temporary location in the subsection shown at [[ReleaseDocumentation.GetGridCertificates#Certificate_scripts_package][Certificate scripts package]] and then return here to continue with requesting your personal user certificate.

---+++ Before you get your DOEGrids personal certificate
 Before starting, determine which affiliation to choose (this corresponds to a Registration Authority, RA). See the list of RAs on the right side of the [[http://www.doegrids.org/][DOEGrids home page]], or type =cert-request -list=.

You'll also need to list a sponsor, an individual known to the RA who has met you in person and can vouch for your identity. Your VO can help you identify the appropriate sponsor. If you have trouble identifying a known sponsor then use your supervisor as your sponsor and be sure to mention the name of your home institution in the =-reason= message of the =cert-request= script (or "Comments" field of the web form).

Think of a unique passphrase.

Note that a DOEGrids certificate is valid for one year. You will receive email notices from DOEGrids prior to certificate expiration so that you can renew it in time to avoid an interruption in service. These notices are sent to the email address you provide when you request the certificate. If your email address changes before the certificate expires you are required to revoke that certificate, and most probably you should request a new certificate with the new email address (before you revoke the old one ;) ).

---++ Script based instructions
 The instructions here are based on using the default assumptions which includes storing your personal certificate (usercert.pem) and private key (userkey.pem) files in ~/.globus. There are additional options and capabilities available described in the [[Security.CSReadMe][full man pages]].

---+++ Requirements
 See the Preparation section above.

---+++ Obtain a certificate via scripts

---++++ cert-request

<verbatim>$ *cert-request -ou p -agree -name "Firstname Lastname" -email your@email.address  -phone 123456789 
     -reason "to use OSG for my VO VVVV, my home institute is Wonderful University"             
     -affiliation osg -vo VVVV   -sponsor_name "My Sponsor" -sponsor_email my.sponsor@wonderful.edu 
     -sponsor_phone 987654321  -label req1* 
checking CertLib version, V2-5,  This is latest version, released 24 Aug 2007. 
Processing OU=People request. 
you will be  prompted for a passphrase to encyrpt the private key that is being generated. 
Generating a 2048 bit RSA private key 
....+++ ................................+++ 
writing new private key to '~/.globus/req1key.pem' 
Enter PEM pass phrase: 
Verifying - Enter PEM pass phrase: 
----- 
osg OSG OSG:OSG  
Your Certificate Request has been successfully submitted 
Your Certificate Request id: 99999          
You will receive a notification email from the CA when your certificate         
has been issued. Please disregard the instructions to download your         
certificate though a web browser and use the cert-retrieve script instead. </verbatim> This example shows all parameters and command line arguments. Notice that multi-word arguments are enclosed in double quotes(") , as is usual for unix commands. The script will prompt you for any required arguments which are omitted. The meaning of these arguments is

   * =-ou p= - *p* means a personal certificate, *s* means a [[ReleaseDocumentation/GetGridCertificates][host/service certificate]]. 
   * =-agree= - means you agree to the subscriber obligation in the [[http://www.doegrids.org/Docs/CP-CPS.pdf][DOEGrids CP/CPS]]. 
   * =-name= - your full name 
   * =-email= - your email address, preferably from your home institution 
   * =-phone= - your office phone number 
   * =-reason= - a short description of why you need the certificate, and include the name of your home institution 
   * =-affiliation osg= - *osg* is the name of the registration authority to handle this request. These scripts can be used for the other RAs working with DOEGrids. 
   * =-vo VVVV= - *VVVV* should be the name of your virtual organization as registered with OSG, like LIGO, CMS, USATLAS, STAR, etc.<br />If you are working with OSG but your VO is not yet registered with OSG then you can specify the VO as =OSG=. 
   * =-sponsor_name= - the name of your sponsor. 
   * =-sponsor_email= - the email address of your sponsor 
   * =-sponsor_phone= - the phone number of your sponsor 
   * =-label= - a label to use for this request, which is used to name some temporary files that must be available at the time you download the issued certificate with the =cert-retrieve= command. 

---++++ notification of issuance
 If your request is rejected you should receive some kind of email notice from the RA or an Agent explaining why. After your certificate request is processed and a certificate is issued you will receive an email like: <verbatim>Subject: DOEGrids CA Certificate Request 
Date: Fri, 30 Nov 2007 14:55:56 -0800 (PST) 
From: DOEGrids-CA-1@doegrids.org 
To: your@email.address  
Your Personal certificate request has been processed successfully. 
SubjectDN= CN=Firstname Lastname 999999,OU=People,DC=doegrids,DC=org 
notAfter= Nov 29, 2008 2:55:51 PM 
notBefore= Nov 30, 2007 2:55:51 PM 
Serial Number= 0xNNNN   
Complete details can be found here: 
https://pki1.doegrids.org:443/displayBySerial?op=displayBySerial&serialNumber=DDDDD  
Your certificate requested using the script interface, 
request id: 99999, has been approved and is available for download.  
To retrieve your certificate, execute the command below using the same 
working directory from which the request was made.  
# cert-retrieve -serialnum DDDDD  
If you requested the certificate with optional parameters specifying labelling 
or a non-standard directory for storing your certificate see the cert-retrieve 
and cert-request man pages for additional explanation. 
# cert-retrieve -help # cert-request -help </verbatim> In the example above =0xNNNN= and =DDDDD= is the certificate serial number in hexadecimal and decimal notation, respectively. =99999= is the same request ID that was shown for the result of =cert-request=.

---++++ cert-retrieve

<verbatim>$ *cert-retrieve -serialnum 0xNNNN -label req1 -p12 mycert.p12* 
checking CertLib version, V2-5,  This is latest version, released 24 Aug 2007.  
using CA doegrids Using URL 
https://pki1.doegrids.org/displayBySerial?op=displayBySerial&serialNumber=0xNNNN 
Checking that the usercert and ~/.globus/req1key.pem match 
Enter pass phrase for /home/olson/.globus/req1key.pem: 
writing RSA key 
~/.globus/usercert.pem and ~/.globus/userkey.pem now contain your Globus credential 
Enter pass phrase for ~/.globus/userkey.pem: 
Enter Export Password: 
Verifying - Enter Export Password: 
Your PKCS12 file mycert.p12 credential with your certificate and private key was generated.  
For information on how to import it into your favorite browser or email application   
Google  import certificate  
and you will get lots of examples. </verbatim> The arguments are:

   * =-serialnum 0xNNNN= - the certificate serial number, 0xNNNN is the hexadecimal form, one can use the decimal form, DDDDD. 
   * =-label= - this label matches that used for the =cert-request= command 
   * =-p12= - optional generation of a PKCS12 format file which can be used to import the certificate into web/email applications. Without the =-p12= flag you will have a single prompt for your *passphrase*, and it must match what you used with the =cert-request= command. If you use the =-p12= flag you a receive another prompt for this same *passphrase* because there is another execution of openssl to produce the PKCS12 file after the certificate is already downloaded. Then you receive a prompt and verification for the *Export Password* which encrypts the PKCS12 file ( =mycert.p12= ). This file is in the format that can be imported into your web browser and email client, and you will use the same *Export Password* so your browser/email can unencrypt it during the import process. 

---++ Web browser based instructions
---+++ Requirements
 <noautolink> 
   * Netscape, Mozilla, or Firefox requires JavaScript support. 
   * Internet Explorer requires ActiveX (at the least, in the Internet Options control panel, go to the Security Settings tab and the Advanced settings, and enable Prompt for Download signed ActiveX controls). There have been difficulties reported for using IE7 on Windows Vista. 
   * Macintosh users: The process does not work with Safari at this time. Use Firefox. <br />%BLUE%If you find it works with Safari please send a descriptive note about that to osg-ra@opensciencegrid.org, thanks.%ENDCOLOR% </noautolink> 

---+++ Obtain a certificate via web browser

Print out these instructions, or copy them somewhere so that you can access them without using a browser.

   1 Close all browser sessions. Then establish a new browser session using the same user account on the same machine and same browser (and browser version) as the one in which you plan to initially use your certificate. 
   1 Go to the DOEgrids Subscriber Enrollment page [[http://pki1.doegrids.org/]]. 
   1 Select the Enrollment tab. (We are intentionally steering you away from the front page of the DOEGrid site.) 
   1 Select New user on the left. This takes you to the DOEGrids Subscriber Enrollment page, which contains a form for you to fill out. Fill out the fields as follows: 
      * Subscriber's Identity: Enter your full name as you want it to appear in the certificate. Enter your commonly used email address. 
      * Contact Information: Enter the email address appropriate for the RA (affiliation) you choose. (For example, the FNAL approval process requires that this be a fnal.gov address.) Enter your office phone number at your home institution. Select your affiliation (also called "Registration Authority") from the drop-down menu. 
      * Sponsor Information: Enter the name of your sponsor (your sponsor must be able to vouch for you; he or she is not responsible for approving or denying your request; approval is handled by another process). Enter the sponsor's email address (again, some affiliations require a corresponding email address). Enter the sponsor's telephone number. 
      * Additional Comments: Enter as needed. ?Challenge Phrase Password (Optional): It should be required to enter a password! You will need one to export and import your certificate from/to applications, in addition to revocation. Enter and a password, and confirm it. 
      * Public/Private key information: No information to enter ?Microsoft Hotfix May be Required: No information to enter 
      * Cryptographic Provider: 
         * Linux or other Unix Mozilla/Firefox/Netscape users: Select 2048(High grade). 
         * Windows Mozilla/Firefox/Netscape users: Select Strong Cryptographic Provider. 
         * Windows Internet Explorer users: Select Microsoft Enhanced Cryptographic Provider. 
      * Click Submit. This generates your private key and stores it in the security database (password and certificate store) associated with your browser, user account, and system. 
   1 In the dialog box that tells you to only allow trusted sites to request a certificate for you and asks you if you want to proceed, click Yes. 
   1 Your browser should then point to a page that says "Request successfully submitted." and displays a request number. Make a note of the request number in case you need to follow up on anything. 

---+++ Get your certificate and import it into your browser

You will receive email notification from DOEGrids stating whether your request was approved or denied. The email text for an approved request will look similar to the text below. Read it carefully and follow the instructions:
<verbatim>
  Your Personal certificate request has been processed successfully. 
  SubjectDN= CN=Your Name xxxxxx,OU=People,DC=doegrids,DC=org 
  IssuerDN= CN=DOEGrids CA 1,OU=Certificate Authorities,DC=DOEGrids,DC=org 
  notAfter= Sep 30, 2007 11:45:39 AM ?  notBefore= Sep 30, 2006 11:45:39 AM 
  Serial Number= xxxxxx

To get your certificate, please follow this URL: 
https://pki1.doegrids.org:443/displayBySerial?op=displayBySerial&serialNumber=xxxx 
And then click the 'Import your certificate' button at the bottom of this page. 

Note: Some browsers import successfully without indicating this to you.
  
Attention:  You need to be running the same browser, on the same machine, logged in as the same user, 
as you were when you made the certificate  request.

After importing your certificate, export your certificate and the  private key for Grid use. 
Kindly follow the instructions on http://www.doegrids.org/pages/cert-request.html#Globus
Please contact your RA if there is any problem.
</verbatim> Notes:

   * If you are using Mozilla or Firefox and have set a Master Password on your Software Security Device (the password and certificate database), a dialog box requesting the Master Password may appear. If so, enter the password to permit the importation of the certificate. 
   * To import your certificate into another browser on the same or a different machine, you first need to export it from the initial browser into a file. For information on importing certificates into a variety of browsers, visit the [[http://lcg.web.cern.ch/LCG/users/registration/load-cert.html][LCG Users Registration page]] . 

---+++ Export (Back up) your certificate
 Follow the [[http://lcg.web.cern.ch/LCG/users/registration/load-cert.html][LCG instructions for importing your certificate]] , but *select "Export"* instead of "Import". (Firefox calls it "backup".) You will need to make up a password and enter it, in order to export your private key. Remember the password!

Refer to [[SecurityUserResponsibilities][What are users' responsibilities regarding security on OSG?]] for information on how to protect your certificate.

---+++ Convert your certificate to format for grid use
 For use on grid resources or submit machines, copy it to your =$HOME/.globus= directory on that machine. Then run the following commands. The first converts your certificate, the second extracts your private key. We use =my-cert.p12= as the filename in the examples; obviously you'll use your own.

<verbatim>> openssl pkcs12 -in my-cert.p12 -clcerts -nokeys -out $HOME/.globus/usercert.pem  
> openssl pkcs12 -in my-cert.p12 -nocerts -out $HOME/.globus/userkey.pem  </verbatim>

You must set the protections on your two new =.pem= files correctly, otherwise =grid-proxy-init= will not use them.
<verbatim>> chmod go-rw ~/.globus/userkey.pem 
> chmod go-r ~/.globus/usercert.pem  </verbatim>

---+++ Renew your DOEGrids personal certificate
If for any reason you are unable to renew your certificate (for example, because it has already expired), please 
request a new certificate according to the instructions above, and in the "Additional Comments" field, 
write "Please issue a certificate with the same DN as my previous certificate."

To renew a certificate, follow these steps:
   1 Go to the [[https://pki1.doegrids.org/][DOEgrids Subscriber Enrollment]] page . 
   1 Select "Replacement Certificate". 
   1 Read the page carefully. 
   1 Select the "High Grade" key length.<!-- appropriate Cryptographic Provider:
      * Linux or other Unix Mozilla/Firefox/Netscape users: Select 2048(High grade) 
      * Windows Mozilla/Firefox/Netscape users: Select Strong Cryptographic Provider. 
      * Windows Internet Explorer users: Select Microsoft Enhanced Cryptographic Provider. --> 
   1 When you submit the form, it will say "Your cert has been imported into the browser!" <!-- prompt you: "This website is requesting a new certificate on your behalf. You should allow only trusted websites to request a certificate for you. Do you want to request a certificate now?" *Click Yes*. 
   1 It will prompt you to "choose a certificate". Your old DOEGrids certificate should be displayed; *select it*.
   1 Then it will prompt: "This website is adding one or more certificates to your computer. Allowing an untrusted website to update your certificates is a security risk. The website could install certificates you do not trust which could allow programs you do not trust to run on this computer and gain access to your data. Do you want this program to add the certificates now? Click Yes if you trust this web site. Otherwise, click No." *Click Yes*.
   1 Then you will see a message that your certificate has been successfully imported. *Click OK*.
   1 It will display your certificate in base 64 encoded format.
   1 Check your email. You should have received a message from DOEGrids.
   1 Assuming you saw and responded to the set of prompts as listed above, your new certificate is already imported. The way you check for it depends on your browser. If it hasn't been imported, follow the link to the URL given in the email message and click the _Import_ button, as directed in the email message.
   1 If you are an OSG RA Agent or Grid Admin, you will need to send email signed by your new certificate to renew your Agent or Grid Admin role. See Security.OsgRaOperations for details.

---+++ Revoke your certificate if compromised
 If the security of your certificate or private key has been compromised, you have a responsibility to revoke the certificate. Using the web browser where your certificate and private key are installed, go to the [[http://www.doegrids.org/][DOEGrids site]], choose "Certificate Revocation", and follow the instructions. You can get a new one afterwards.

%COMPLETE2% %BR% 
%RESPONSIBLE% Main.Anne Heavey, Main.DougOlson %BR% 
%REVIEW% Main.AnneHeavey - 04 Dec 2007%BR% 
%REVCOM% reconcile w Security web
