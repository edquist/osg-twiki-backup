%META:TOPICINFO{author="X509_2fDC_3dorg_2fDC_3ddoegrids_2fOU_3dPeople_2fCN_3dRobert_20Engel_20392994" date="1295550627" format="1.1" reprev="1.41" version="1.41"}%
%META:TOPICPARENT{name="ComputeElementPostInstall"}%
%DOC_STATUS_TABLE%


---+ !!OSG Services and Firewalls
%TOC{}%


%STARTINCLUDE%

---+ About this Document

%ICON{hand}% This document is for System Administrators. A brief description of services provided by a %LINK_GLOSSARY_CE% and %LINK_GLOSSARY_SE% will be given, followed by recommendations how to adjust the firewall for their correct operation.


---+ Introduction

Network traffic may be blocked by a firewall for inbound and outbound traffic in dependence on host- and domain names, IP addresses, port numbers and protocols. In this document we distinguish between two types of firewalls:

   1 network firewalls administrated centrally and typically outside of your administrative domain
   1 host-based firewalls within your administrative domain

The protocol and port requirements for a %LINK_GLOSSARY_CE% and %LINK_GLOSSARY_SE% are listed below. Please provide them to the administrator of a _network firewall_ potentially blocking network traffic to your host. Next, follow the instructions to adjust the firewall settings on your host-based firewall.



---+ Requirements

   1 be familiar with your institute's network policy and firewall configuration
   1 _root_ access is required to configure a host-based firewall using =iptables=

---+ Compute Element Services and Firewall Requirements

| *Service Name*  | *Protocol* | *Port Number* | *Inbound* | *Outbound* | *Comment*  |
| %LINK_GLOSSARY_GRAM%  |  tcp  |  2119  |  %ICON{choice-yes}%  | | |
| %LINK_GLOSSARY_GRAM% callback  |  tcp  | =GLOBUS_TCP_PORT_RANGE= |  %ICON{choice-yes}%  | | continuous range of ports  |
| %LINK_GLOSSARY_GRAM% callback  |  tcp  | =GLOBUS_TCP_SOURCE_RANGE= | |  %ICON{choice-yes}%  | continuous range of ports  |
| %LINK_GLOSSARY_GRAM_WS%  |  tcp  |  9443  |  %ICON{choice-yes}%  |  %ICON{choice-yes}%  | |
| Monalisa  |  udp  |  9000  |  %ICON{choice-yes}%  | | for ABping, see =$VDT_LOCATION/MonaLisa/Service/VDTFarm/ml.properties=  |

%TWISTY{%TWISTY_OPTS_REVIEW%}%

Wrong place for content. This should be part of the Compute Element Installation Guide.
!---+++ Globus/GRAM Port Ranges

GRAM and Integration.GridFTP need to know the port range that you've opened up via environment variables.  You need to set the =GLOBUS_TCP_PORT_RANGE=beginport,endport= for inbound ports.  If you restrict outbound connections, you will also need to set =GLOBUS_TCP_SOURCE_RANGE=beginport,endport=. 

The size of these ranges is very dependent on the size of your cluster. As a rule of thumb, each job slot requires between 6 and 8 ports, so be sure to provide a large enough range for your cluster, otherwise jobs may start to hang randomly as your site fills up, and that may be very difficult to track down.

These ranges may be set in =$VDT_LOCATION/vdt/etc/vdt-local-setup.[c]sh=. You should NOT set the allowed port ranges by editing the xinetd configuration files &mdash; the examples below do imply such editing, but will not survive a vdt-control off and on cycle.  

The variables applied in the local setup as above will be used by GRAM, Integration.GridFTP, and any clients that require them.

The above ports and protocols <em>must be open</em> to and from all grid clients and server machines participating in the grid in order to provide minimal functionality.

In addition to the above, port 9443 must be open for both incoming and outgoing connections in order to test the web-services capabilities of the most recent versions of the VDT.
%ENDTWISTY%

---+ Storage Element Services and Firewall Requirements

| *Service Name*  | *Protocol* | *Port Number* | *Inbound* | *Outbound* | *Comment*  |
| %LINK_GLOSSARY_GRIDFTP%  |  tcp  |  2811  |  %ICON{choice-yes}%  | | |
| %LINK_GLOSSARY_SRM%  |  tcp  |  10443  |  %ICON{choice-yes}%  | |  |

---+ Other Optional Services and Firewall Requirements

You may need to open the following _required_ inbound ports for listed _optional_ services. 

| *Service Name*  | *Protocol* | *Port Number* | *Inbound* | *Outbound* | *Comment*  |
| MDS  |  tcp  |  2135  |  %ICON{choice-yes}%  | | obsolete |
| GIIS  |  tcp  |  2136  |  %ICON{choice-yes}%  | | obsolete |
| GSISSH  |  tcp  |  22 or 2222  |  %ICON{choice-yes}%  | | |
| !MyProxy  |  tcp  |  7512  |  %ICON{choice-yes}%  | | |
| GUMS  |  tcp  |  8443  |  %ICON{choice-yes}%  | | |
| VOMS  |  tcp  |  15001+  |  %ICON{choice-yes}%  | | range of ports, increment by 1 for each VO supported  |
| RLS  |  tcp  |  39281  |  %ICON{choice-yes}%  | | |
| Squid  |  tcp  |  3128  |  %ICON{choice-yes}%  | | |

%TWISTY{%TWISTY_OPTS_REVIEW%}%
Why is this here? :

Here is a sample of the a =/etc/hosts.allow= with the GLOBUS services opened:
<pre class="file">
  #
  # hosts.allow   This file describes the names of the hosts which are
  #               allowed to use the local INET services, as decided
  #               by the '/usr/sbin/tcpd' server.
  #
  sshd: 129.79.6.113 
  ALL : localhost
  vdt-run-gsiftp.sh : ALL
  vdt-run-globus-gatekeeper.sh : ALL</i>
</pre>
%ENDTWISTY%

---+ Host-based Firewall Configuration

The default firewall configuration for RedHat's iptables sets the system up with a stateful packet filter. This is different than some legacy RH7 systems as by default no ports that are not explicitly opened by the iptables script will be open. This includes high numbered ports that are often used by grid services. 

If your preference is to leave as much of the stateful packet filtering in place but enable just those grid services you want to deploy, then you can use the following instructions. 

Two changes need to be made to an OSG gateway with a host based iptables stateful firewall. 

First is the configuration of the firewall itself. On RHEL or similar systems this is done in =/etc/sysconfig/iptables=.

The Chain RH-Firewall-1-INPUT is a default chain for RHEL3. This chain is also sometimes called INPUT. Make sure the following rules use the chain that other rules in =/etc/sysconfig/iptables= do. 

%NOTE% For GSISSH this port is often already open for systems. You can use either this rule or the default rule setup at install time if you selected custom firewall and enabled ssh. 

%TWISTY{%TWISTY_OPTS_REVIEW%}%
   * the css class here is 'file' not programlisting
   * the sections that are relevant to a specifi service should be duplicated above in the sections for each service.
%ENDTWISTY%

<noautolink><pre class="file">
# Globus: Requires addition configuration in /etc/xinetd.d/globus-gatekeeper
# set: env = GLOBUS_TCP_PORT_RANGE=40000,50000
# This allows up to 10,000 ports and matches the globus config.
# How globus is configured to use these ports is subject to change in an upcoming
# release
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 40000:50000 -j ACCEPT
# Monalisa, grabs 3 ports from the following range
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 9000:9010 -j ACCEPT
-A RH-Firewall-1-INPUT  -m state --state NEW -p ucp -m ucp --dport 9000 -j ACCEPT
# GRAM
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 2119 -j ACCEPT
# Gridftp
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 2811 -j ACCEPT

# Optional Services
# RLS Server
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 39281 -j ACCEPT
# MyProxy
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 7512 -j ACCEPT
# GSISSH/SSH
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 22 -j ACCEPT
# MDS
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 2135 -j ACCEPT
# GIIS
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 2136 -j ACCEPT
# GUMS/VOMS
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 8443 -j ACCEPT
# WebServices
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 9443 -j ACCEPT
</pre></noautolink>

Second, we configure Globus to use the allowed inbound port range.  Do NOT do this by hand-editing the xinetd.d files in versions equal to or later than VDT 1.6.x (ITB 0.5.x), as these will not survive a vdt-control off and on cycle (the xinetd.d files are rewritten by such a cycle).   Instead, set them in the =vdt-local-setup.[c]sh= files.  

=$VDT_LOCATION/vdt/etc/vdt-local-setup.sh=
<noautolink><pre class="file">
GLOBUS_TCP_SOURCE_RANGE=49000,49150
GLOBUS_TCP_PORT_RANGE=49000,49150
export GLOBUS_TCP_SOURCE_RANGE
export GLOBUS_TCP_PORT_RANGE
</pre>
=$VDT_LOCATION/vdt/etc/vdt-local-setup.csh=
<noautolink><pre class="file">
setenv GLOBUS_TCP_SOURCE_RANGE 40000,49150
setenv GLOBUS_TCP_PORT_RANGE 49000,49150
</pre>
<!-- Old samples now commented out.  SCT
The following are shown for historical reference and for older versions that do not include vdt-control, although the local setup method will work in earlier versions also.

=/etc/xinetd.d/globus-gatekeeper=
<noautolink><pre class="file">
  service globus-gatekeeper
  {
         socket_type = stream
         protocol = tcp
         wait = no
         user = root
         instances = UNLIMITED
         cps = 400 10
         server = $VDT_LOCATION/vdt/services/vdt-run-globus-gatekeeper.sh
         env    = GLOBUS_TCP_PORT_RANGE=40000,50000
         disable = no
  }
</pre></noautolink>

%IMPORTANT% <b>If</b> you restrict outbound connections (to the same port range, for example), you should also modify the gsiftp config file.

=/etc/xinetd.d/globus-gsiftp=
<pre class="file">
service gsiftp
{
         socket_type = stream
         protocol = tcp
         wait = no
         user = root
         instances = UNLIMITED
         cps = 400 10
         server = $VDT_LOCATION/vdt/services/vdt-run-gsiftp.sh
         env += GLOBUS_TCP_SOURCE_RANGE=40000,50000
         disable = no
}
</pre>

Finally, add the port range(s) to =$VDT_LOCATION/globus/etc/globus-job-manager.conf= to ensure that it is picked up by other services by adding the following lines (omit the globus-tcp-source-range line if you do not restrict outbound connections):

<verbatim>
        -globus-tcp-port-range 40000,50000
</verbatim>

If you intend to use this installation also for grid client submissions, you should also set (=export= or =setenv=) =GLOBUS_TCP_PORT_RANGE=beginport,endport= and =GLOBUS_TCP_SOURCE_RANGE=beginport,endport= in =$VDT_LOCATION/globus/etc/globus-user-env.[c]sh=.

%NOTE% The pacman installer should set =$VDT_LOCATION=.
-->

If you limit the globus-related port range to certain values, it may be necessary to adjust the Linux ephemeral port range to avoid these values.  If this has not already been done, check the =/etc/sysctl.conf= for the following lines and insert if needed:

<pre class="file">
# Limit ephemeral ports to avoid globus tcp port range
# See OSG CE install guide
net.ipv4.ip_local_port_range = 10240 39999
</pre>

Save and exit if edited.  Then, if you changed it, apply the changes by doing: =sysctl -p=


After editing the above files run the following commands:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% <b>/etc/rc.d/init.d/iptables restart </b>
  Flushing firewall rules:                                   [  OK  ]
  Setting chains to policy ACCEPT: filter                    [  OK  ]
  Unloading iptables modules:                                [  OK  ]
  Applying iptables firewall rules:                          [  OK  ]
 %UCL_PROMPT_ROOT% <b>/etc/rc.d/init.d/xinetd reload </b>
  Reloading configuration:                                   [  OK  ] 
</pre>

---++ Stateful Firewalls

If you have a stateful firewall, you need to provide Globus with configuration in addition to GLOBUS_TCP_SOURCE_RANGE. (There is no need to do this if you do not have a stateful firewall. For instance, you do not need to do this for iptables.) You should also specify the GLOBUS_TCP_PORT_RANGE_STATE_FILE. This is also an environment variable, and it should be the name of a file where Globus can store information about what ports have been recently used. Wherever you set GLOBUS_TCP_SOURCE_RANGE, you should also set GLOBUS_TCP_PORT_RANGE_STATE_FILE, and it should be set to a consistent value so that different Globus services can share this information.

This file should not be on a shared filesystem (there is no need to share it, and Globus relies on reliable file locking to access the file). For example, one possibility is:

<pre>
GLOBUS_TCP_PORT_RANGE_STATE_FILE=/tmp/globus-port-range
</pre>

_Background:_ If you're curious about the need for this, sometimes a TCP connection is closed unexpectedly and a stateful firewall will not know that it has been closed. The operating system may allow programs to reuse the port number, but the firewall will not. This environment variable will point to a file where Globus keeps track of the most recently used port, and when Globus needs a new port, it will start searching sequentially from the last port. This will allow Globus components to avoid using the same ports too quickly, and hopefully avoid the situation where a stateful firewall will not allow a port to be reused. 

---++ Testing and Monitoring

You can check whether the ports you need are open to your CE or SE by trying to connect to the respective port from the outside with

<pre class="screen">
<code>%UCL_PROMPT% telnet your.host.edu port_to_check</code>
</pre>

If you get a response, then the port is open, but if the command hangs or you get an error like =no route to host=, then it is closed.

If you have your iptables configured to log events, you should be able to see blocked events in =/var/log/messages=.



---+ References

   1 [[http://www.globus.org/toolkit/security/firewalls/][Globus Firewall Settings]]
   1 [[http://www.cs.wisc.edu/condor/manual/v6.8.6/3_7Networking.html#SECTION00471000000000000000][Condor Firewall Settings]]


%STOPINCLUDE%

---+ *Comments*
%COMMENT{type="tableappend"}%

<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = HorstSeverini

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = ComputeElement

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = HowTo
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %YES%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY   = %NO%


 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


   DEAR DOCUMENT REVIEWER
   ======================

   Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = RobertEngel
  
   Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %NO%


   DEAR DOCUMENT TESTER
   ====================

   Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = IwonaSakrejda
  
   Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %IN_PROGRESS%


############################################################################################################
-->

%META:TOPICMOVED{by="RobGardner" date="1192750453" from="Integration/ITB_0_7.ComputeElementFireWalls" to="Integration/ITB_0_7.ComputeElementFirewalls"}%
