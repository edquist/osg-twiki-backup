%META:TOPICINFO{author="X509_2fDC_3dorg_2fDC_3ddoegrids_2fOU_3dPeople_2fCN_3dRobert_20Engel_20392994" date="1296244554" format="1.1" reprev="1.43" version="1.43"}%
%META:TOPICPARENT{name="ComputeElementPostInstall"}%
%DOC_STATUS_TABLE%


---+ !!OSG Services and Firewalls
%TOC{}%


%STARTINCLUDE%

---+ About this Document
<!-- some useful variable definistion
   * Local UCL_HOST = ce
-->

%ICON{hand}% This document is for System Administrators. A brief description of services provided by a %LINK_GLOSSARY_CE% and %LINK_GLOSSARY_SE% will be given, followed by recommendations how to adjust the firewall for their correct operation.


---+ Introduction

Network traffic may be blocked by a firewall for inbound and outbound traffic in dependence on host- and domain names, IP addresses, port numbers and protocols. In this document we distinguish between two types of firewalls:

   1 network firewalls administrated centrally and typically outside of your administrative domain
   1 host-based firewalls within your administrative domain

The protocol and port requirements for a %LINK_GLOSSARY_CE% and %LINK_GLOSSARY_SE% are listed below. Please provide them to the administrator of a _network firewall_ potentially blocking network traffic to your host. Next, follow the instructions to adjust the firewall settings on your host-based firewall.



---+ Requirements

   1 be familiar with your institute's network policy and firewall configuration
   1 _root_ access is required to configure a host-based firewall using =iptables=

---+ Compute Element Services and Firewall Requirements

| *Service Name*  | *Protocol* | *Port Number* | *Inbound* | *Outbound* | *Comment*  |
| %LINK_GLOSSARY_GRAM%  |  tcp  |  2119  |  %ICON{choice-yes}%  | | |
| %LINK_GLOSSARY_GRAM% callback  |  tcp  | =GLOBUS_TCP_PORT_RANGE= |  %ICON{choice-yes}%  | | contiguous range of ports  |
| %LINK_GLOSSARY_GRAM% callback  |  tcp  | =GLOBUS_TCP_SOURCE_RANGE= | |  %ICON{choice-yes}%  | contiguous range of ports  |
| %LINK_GLOSSARY_GRAM_WS%  |  tcp  |  9443  |  %ICON{choice-yes}%  |  %ICON{choice-yes}%  | |
| Monalisa  |  udp  |  9000  |  %ICON{choice-yes}%  | | for ABping, see =$VDT_LOCATION/MonaLisa/Service/VDTFarm/ml.properties=  |


---+ Storage Element Services and Firewall Requirements

| *Service Name*  | *Protocol* | *Port Number* | *Inbound* | *Outbound* | *Comment*  |
| %LINK_GLOSSARY_GRIDFTP%  |  tcp  |  2811  |  %ICON{choice-yes}%  | | |
| %LINK_GLOSSARY_GRAM% callback  |  tcp  | =GLOBUS_TCP_PORT_RANGE= |  %ICON{choice-yes}%  | | contiguous range of ports  |
| %LINK_GLOSSARY_GRAM% callback  |  tcp  | =GLOBUS_TCP_SOURCE_RANGE= | |  %ICON{choice-yes}%  | contiguous range of ports  |
| %LINK_GLOSSARY_SRM%  |  tcp  |  8080  |  %ICON{choice-yes}%  | |  |
| %LINK_GLOSSARY_SRM%  |  tcp  |  8443  |  %ICON{choice-yes}%  | |  |

---+ Other Optional Services and Firewall Requirements

You may need to open the following _required_ inbound ports for listed _optional_ services. 

| *Service Name*  | *Protocol* | *Port Number* | *Inbound* | *Outbound* | *Comment*  |
| MDS  |  tcp  |  2135  |  %ICON{choice-yes}%  | | obsolete |
| GIIS  |  tcp  |  2136  |  %ICON{choice-yes}%  | | obsolete |
| GSISSH  |  tcp  |  22 or 2222  |  %ICON{choice-yes}%  | | |
| !MyProxy  |  tcp  |  7512  |  %ICON{choice-yes}%  | | |
| GUMS  |  tcp  |  8443  |  %ICON{choice-yes}%  | | |
| VOMS  |  tcp  |  15001+  |  %ICON{choice-yes}%  | | range of ports, increment by 1 for each VO supported  |
| RLS  |  tcp  |  39281  |  %ICON{choice-yes}%  | | |
| Squid  |  tcp  |  3128  |  %ICON{choice-yes}%  | | |

%TWISTY{%TWISTY_OPTS_REVIEW%}%
Why is this here? :

Here is a sample of the a =/etc/hosts.allow= with the GLOBUS services opened:
<pre class="file">
  #
  # hosts.allow   This file describes the names of the hosts which are
  #               allowed to use the local INET services, as decided
  #               by the '/usr/sbin/tcpd' server.
  #
  sshd: 129.79.6.113 
  ALL : localhost
  vdt-run-gsiftp.sh : ALL
  vdt-run-globus-gatekeeper.sh : ALL</i>
</pre>
%ENDTWISTY%

---+ Host-based Firewall Configuration

The default firewall configuration for !RedHat's iptables defines a stateful packet filter; no ports that are not explicitly opened by =iptables= will be open. This includes high numbered ports that are often used by grid services. 

If your preference is to leave as much of the stateful packet filtering in place but enable just those grid services you want to deploy, then you can use the following instructions. On RHEL or similar systems the firewall is configured using the =/etc/sysconfig/iptables= file:

<pre class="file">
# GLOBUS_TCP_PORT_RANGE
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport %RED%&lt;begin port&gt;%ENDCOLOR%:%RED%&lt;end port&gt;%ENDCOLOR% -j ACCEPT
# Monalisa, grabs 3 ports from the following range
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 9000:9010 -j ACCEPT
-A RH-Firewall-1-INPUT  -m state --state NEW -p ucp -m ucp --dport 9000 -j ACCEPT
# GRAM
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 2119 -j ACCEPT
# Gridftp
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 2811 -j ACCEPT
# Optional Services
# RLS Server
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 39281 -j ACCEPT
# MyProxy
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 7512 -j ACCEPT
# GSISSH/SSH
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 22 -j ACCEPT
# MDS
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 2135 -j ACCEPT
# GIIS
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 2136 -j ACCEPT
# GUMS/VOMS
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 8443 -j ACCEPT
# WebServices
-A RH-Firewall-1-INPUT  -m state --state NEW -p tcp -m tcp --dport 9443 -j ACCEPT
</pre>

%NOTE% Please open the range of [[ReleaseDocumentation/ComputeElementInstall#Define_Globus_Port_Ranges][Globus Ports]] according to your Compute Element configuration.

Finally restart the firewall as the _root_ user for changes to take effect:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% /etc/rc.d/init.d/iptables restart
  Flushing firewall rules:                                   [  OK  ]
  Setting chains to policy ACCEPT: filter                    [  OK  ]
  Unloading iptables modules:                                [  OK  ]
  Applying iptables firewall rules:                          [  OK  ]

%UCL_PROMPT_ROOT% /etc/rc.d/init.d/xinetd reload
  Reloading configuration:                                   [  OK  ] 
</pre>

---++ Stateful Firewalls

%TWISTY{%TWISTY_OPTS_REVIEW%}%
check against https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/ComputeElementInstall#Define_Globus_Port_Ranges
%ENDTWISTY%

If you have a stateful firewall, you need to provide Globus with configuration in addition to GLOBUS_TCP_SOURCE_RANGE. (There is no need to do this if you do not have a stateful firewall. For instance, you do not need to do this for iptables.) You should also specify the GLOBUS_TCP_PORT_RANGE_STATE_FILE. This is also an environment variable, and it should be the name of a file where Globus can store information about what ports have been recently used. Wherever you set GLOBUS_TCP_SOURCE_RANGE, you should also set GLOBUS_TCP_PORT_RANGE_STATE_FILE, and it should be set to a consistent value so that different Globus services can share this information.

This file should not be on a shared filesystem (there is no need to share it, and Globus relies on reliable file locking to access the file). For example, one possibility is:

<pre>
GLOBUS_TCP_PORT_RANGE_STATE_FILE=/tmp/globus-port-range
</pre>

_Background:_ If you're curious about the need for this, sometimes a TCP connection is closed unexpectedly and a stateful firewall will not know that it has been closed. The operating system may allow programs to reuse the port number, but the firewall will not. This environment variable will point to a file where Globus keeps track of the most recently used port, and when Globus needs a new port, it will start searching sequentially from the last port. This will allow Globus components to avoid using the same ports too quickly, and hopefully avoid the situation where a stateful firewall will not allow a port to be reused. 

---++ Testing and Monitoring

You can check whether the ports you need are open to your CE or SE by trying to connect to the respective port from the outside with

<pre class="screen">
%UCL_PROMPT% telnet %UCL_HOST_FQDN% &lt;port_to_check&gt;
</pre>

If you get a response, then the port is open, but if the command hangs or you get an error like =no route to host=, then it is closed.

If you have your iptables configured to log events, you should be able to see blocked events in =/var/log/messages=.



---+ References

   1 [[http://www.globus.org/toolkit/security/firewalls/][Globus Firewall Settings]]
   1 [[http://www.cs.wisc.edu/condor/manual/v6.8.6/3_7Networking.html#SECTION00471000000000000000][Condor Firewall Settings]]


%STOPINCLUDE%

---+ *Comments*
%COMMENT{type="tableappend"}%

<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = HorstSeverini

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = ComputeElement

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = HowTo
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %YES%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY   = %NO%


 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


   DEAR DOCUMENT REVIEWER
   ======================

   Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = RobertEngel
  
   Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %NO%


   DEAR DOCUMENT TESTER
   ====================

   Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = IwonaSakrejda
  
   Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %IN_PROGRESS%


############################################################################################################
-->

%META:TOPICMOVED{by="RobGardner" date="1192750453" from="Integration/ITB_0_7.ComputeElementFireWalls" to="Integration/ITB_0_7.ComputeElementFirewalls"}%
