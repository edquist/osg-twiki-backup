%META:TOPICINFO{author="RobGardner" date="1195161719" format="1.1" reprev="1.50" version="1.50"}%
%META:TOPICPARENT{name="ComputeElementInstall"}%
---+!! *<nop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%

%STARTINCLUDE%
%BR%
---+ _%INCLUDEHEADING%  %SPACEOUT{ "%TOPIC%" }%_
%EDITTHIS%
%BR%

---++ Introduction

Background information for certificates can be found [[Documentation.CertificateWhatIs][here]].  You will need a host certificate and private key to identify your CE.  You will also need an http certificate for CEMon and anything else that runs under Apache/tomcat.  If you are need a personal certificate rather than a host or service certificate see UserCertificate.

%NOTE% For security reasons, please *DO NOT* use clones of your host certificate for additional certificates even though it's technically possible.  There is one exception to this.  If you enable Globus web services, the Globus container requires  the host certificate.  Since the Globus container runs as _non_root_, the VDT configuration software will clone your host certificate as =/etc/grid-security/containercert.pem(containerkey.pem)= and will be owned by the account you configured Globus to run under (normally _globus_ or _daemon_). This is the *ONLY* exception at this time.

%NOTE% If you find the http certificate files already installed, you might want to check their end date which indicates their validity. As root, run the =openssl= command on each of the =*cert.pem= files, e.g.,:
<pre class="screen">
# openssl x509 -in /etc/grid-security/hostcert.pem -enddate -noout
</pre>

---++ Temporarily install certificate scripts package

You need to have a set of scripts in order to request and manipulate host certificates.  These scripts are described in the [[CertScripts][Certificate Scripts Package Guide]].  It is recommended to get these certificates before installing the complete
CE.  
If you have a recent OSG or VDT installation for CE or Client then you can use the scripts from that installation to request (=cert-request=) and retrieve (=cert-retrieve=) the certificates you will need.  If you do NOT already have a recent installation 
then you should follow the procedure described below to install the [[Security.CertScriptsPackage][PPDG-Cert-Scripts]] package from VDT temporarily.
Both ways work.  It is also possible to request host certificates from one node from a different node on which the VDT is already installed.
  
Make the directory where you are going to install the package, and =cd= to it.  The name and location
of the directory is arbitrary, but is called =tmp-cert-scripts= below.  Note that this will be the =$VDT_LOCATION=
for this temporarily installation of the certificate scripts.
The installation can be done as
a regular user or as root.
Find the [[http://vdt.cs.wisc.edu/documentation.html][latest VDT cache]], and download =PPDG-Cert-Scripts= from it (shown for VDT %OSG_ITB_VDT_VERSION%), and answer the installation questions as shown below:


<!--Best fix would be to make PPDG-Cert-Scripts a dependency of VOMS, VOMRS, GUMS, etc. packages.
-->

<pre class="screen">
# <b>mkdir tmp-cert-scripts</b>
# <b> cd tmp-cert-scripts</b>
# <b>pacman -get http://vdt.cs.wisc.edu/%VDT_CACHE%:PPDG-Cert-Scripts</b>
Do you want to add [http://vdt.cs.wisc.edu/%VDT_CACHE%] to [trusted.caches]? (y or n): <b>y</b>
Do you agree to the licenses? [y/n] <b>y</b>
Where would you like to install CA files?
Choices:
        l (local) - install into $VDT_LOCATION/globus/share/certificates
        n (no)    - do not install
<b>n</b>
</pre>
Then, to set up your environment to use the scripts:
<pre class="screen">
# <b>source ./setup.sh</b> ### for csh/tcsh use setup.csh
</pre>

It is important to answer =<b>No</b>= to the question about CA files since they are not needed
to use the =cert-request= and =cert-retrieve= scripts and installing them here will likely
cause confusion since they should normally be installed with the CE package.

After you have completed installation of the CE or Client packages it is probably useful to
remove this temporary certificate scripts installation to avoid confusion with the
scripts included with the CE and Client packages.

---++ %RED% Deprecated %ENDCOLOR% - Setup and maintenance of Certificate Authority connection
%RED% The grid-cert-request setup described in this section is useful when dealing with a globus-only software installation
and dealing with an arbitrary CA but grid-cert-request is NOT the recommended method of generating certificate signing requests
in an OSG software environment. This configuration has no effect on the PPDG-Cert-Scripts package which uses the DOEGrids CA
as it's default configuration.%ENDCOLOR%

Configure the DOEGrids Certificate Authority (CA) to be used by default. To do so, run the utility below.  

If you are given the option of more than one different CA in the  menu below, choose the option which matches DOEGrids, 
then enter =q= at the prompts.  If only DOEGrids is shown, then you can just enter =q= as shown in the output below.

<pre class="screen">
# <b>$VDT_LOCATION/vdt/setup/setup-cert-request</b>
 Reading from /g3dev/globus/TRUSTED_CA
 Using hash: 1c3f2ca8
 Setting up grid-cert-request
 Running grid-security-config...

Before you use the Grid Security Infrastructure, you should first
define the DN (distinguished name) that should be used for your
organization's X509 certificates.  If you do not define a DN,
a default DN will be assigned to you.

For some questions, a default response is given in [].
Pressing RETURN in response to such a question will enable the default.
This script will overwrite the file --

     /usr/local/vdt-%OSG_VERSION%/globus/etc/grid-security.conf


========================================================================

(1) Base DN for user certificates
         [ OU=People,DC=doegrids,DC=org ]
(2) Base DN for host certificates
         [ OU=Services,DC=doegrids,DC=org ]

========================================================================
(q) save, configure the GSI and Quit
(c) Cancel (exit without saving or configuring)
(h) Help
========================================================================

<b>q</b>

Successfully created cert request configuration files in:
/etc/grid-security

</pre>

During the CE installation/setup, the [[http://www.cs.wisc.edu/vdt/releases/%OSG_ITB_VDT_VERSION%/certificate_authorities.html][VDT's list of CAs]] was added under =$VDT_LOCATION/globus/TRUSTED_CA= as the list of authorized CAs on your system.  Also, the variable X509_CERT_DIR was set to $VDT_LOCATION/globus/TRUSTED_CA. Please review the list of authorized CAs and modify the set in $X509_CERT_DIR as needed to match your local policy.

From OSG 0.5.0/VDT-1.3.11 and greater, the daemon _edg-crl-upgrade_ has been replaced with a root cron job called _fetch-crl_ which runs daily from cron. This will refresh the CRLs from these CAs.  Some of them expire in less than 1 day and you may find it necessary to increase the frequency of the fetch-crl to be more than daily by manually executing crontab -e to make the frequency of the crl-update be every six hours, for instance. 

%IMPORTANT%  *Change from past versions*: The OSG installation is pre-configured as of version 0.6.0 to place the CA certificates in the local =$VDT_LOCATION/globus/TRUSTED_CA= directory.  The <i>fetch-crl</i> cron job will be updating CRLs in this local directory only. If you want to maintain certificates in the (old) =/etc/grid-security/certificates= directory, you must link it to the local =TRUSTED_CA= location (symlink in either direction) and copy the CA files appropriately.  The host and http certificate files still go under =/etc/grid-security=.

The [[CertScripts][Certificate Scripts Package Guide]] which has been installed can assist you with choosing Certificate Authorities to trust and periodically checking that the CRLs (Certificate Revocation Lists) have not expired.


---++ Request a Host Certificate

Every resource or service running on the grid needs an X509 identity certificate from one of the trusted CAs. 
   * Currently the [[http://www.doegrids.org][DOEGrids CA]] is the most common CA in use for OSG participants. 
   * The [[http://www.opensciencegrid.org/ra][OSG Registration Authority]] with DOEGrids handles most certificate requests for OSG participants. 

 
Run the =cert-request= script  to generate your host's private key (<tt>hostkey.pem</tt>) and submit the certificate request.
$VDT_LOCATION must point to the package in which the scripts exist, e.g., the CE install directory or where you installed PPDG-Cert-Scripts,
or the temporary directory as described above.  The values for the =-label= and =-dir= options need to match the values used later with the =cert-retrieve= script.
<pre class="screen">
# <b>cd $VDT_LOCATION</b>
# <b>source  ./setup.sh</b>
# <b>cd vdt/setup/</b>   ### you could use some other directory, such as /etc/grid-security
#                 ### which is the typical location to install the certificates
# <b>cert-request -ou s -dir . -label <i>my-host</i></b>
checking CertLib version, V2-5,  This is latest version, released 24 Aug 2007.
Processing OU=Services request.
Give reason (1 line) you qualify for certificate, such as
  member of CMS experiment    or
  collaborating with Condor team,  etc.
 reason: <b>setting up my CE for site/vo</b>
input server administrator's name: <b>Joe Admin</b>
input full hostname: <b>myhost.some.domain</b>
Generating a 2048 bit RSA private key
.....................................+++
................................................+++
writing new private key to './my-hostkey.pem'
-----
input your email address: <b>certs@some.domain</b>
input your complete phone number: <b>123456789</b>
Choose a registration authority to which you are affiliated.
If nothing else applies, pick OSG.
_Enter__this____for this registration authority
        anl     ANL: Argonne National Lab
 <i>----abreviated output----</i>
        osg     OSG: Open Science Grid (choose this if nothing else applies)
        pnnl    PNNL: Pacific Northwest National Lab
(choose from left column): <b>osg</b>
osg
OSG
Choose a virtual organization under your OSG affiliation:
        bnl     BNL: Brookhaven lab researchers not in an OSG registered VO
 <i>----abreviated output----</i>
        star    Solenoidal Tracker at RHIC
        usatlas United States ATLAS Collaboration
(Choose from left column; pick osg if nothing else applies): <b>osg</b>
OSG:OSG
You must agree to abide by the DOEGrids policies,
at
and you assert that you are authorized to request and install this
certificate on the specified host.
Do you agree (y,N): <b>y</b>

Your Certificate Request has been successfully submitted
Your Certificate Request id: NNNN

        You will receive a notification email from the CA when your certificate
        has been issued. Please disregard the instructions to download your
        certificate though a web browser and use the cert-retrieve script instead.
</pre>
The certificate request will leave some files in the directory that will be needed when you retrieve your cert.

%NOTE% It is possible to continue with steps in the install procedure while you are waiting for your host certificate to be approved.

See [[Security.CSReadMe#cert_request][full man page]] on the cert-request command for additional useful options.

---++ Retrieve and Install the Host Certificate

After the certificate is approved you will receive an email which includes the serial number (shown as =0xYYYY= below) of the new certificate. Use that serial number to retrieve the certificate as shown below.  

From the installation directory (where you ran =cert-request=), run =cert-retrieve=.  Again, use the same values for =-label= and =-dir= used for the request.  
<pre class="screen">
# <b>cert-retrieve  -serial <i>0xYYYY</i> -label <i>my-host</i> -dir . -prefix <i>host</i></b>
checking CertLib version, V2-5,  This is latest version, released 24 Aug 2007.
 using CA doegrids
Checking that the usercert and ./my-hostkey.pem match
writing RSA key
./hostcert.pem and ./hostkey.pem now contain your Globus credential
</pre>
<i>Note that if you did not use the =-prefix= option to name the =.pem= files
they will have the default values of =usercert.pem= and =userkey.pem=.</i>

Now move the =hostcert.pem= and =hostkey.pem= files to =/etc/grid-security= and set permissions:
<pre class="screen">
# <b>mv ./hostcert.pem /etc/grid-security/</b>
# <b>mv ./hostkey.pem /etc/grid-security/</b>
# <b>chmod 444 /etc/grid-security/hostcert.pem</b>
# <b>chmod 400 /etc/grid-security/hostkey.pem</b>
</pre>


The following command will verify the certificate is readable.  The output shown will be similar, but specific to your request.

<pre class="screen">
# <b>openssl x509 -text -noout -in /etc/grid-security/hostcert.pem</b>
Certificate:
  Data:
      Version: 3 (0x2)
      Serial Number: 743 (0x2e7)
      Signature Algorithm: sha1WithRSAEncryption
      Issuer: DC=org, DC=DOEGrids, OU=Certificate Authorities, CN=DOEGrids CA 1
      Validity
          Not Before: Oct 17 22:03:24 2006 GMT
          Not After : Oct 17 22:03:24 2007 GMT
      Subject: DC=org, DC=doegrids, OU=Services, CN=my-host.some.domain
      .........
</pre>


---++ Get some other service certificate if you need it

Additional service certificate can be obtained using the same procedure as for the host certificate above by
simply including the =-service servicename= option with cert-request.  For =servicename= you might use =http=.  
The name of the service is rather arbitrary.
<pre class="screen">
> cert-request -ou s -service http -host my-computer.some.domain -label http-my-computer
</pre>


<!--  D.O. - lets drop this part
-->
<!--

Get an HTTP service certificate to activate CEMon

%BLUE%[D.O. - Seems to me that the CEMon install/configure documentation should describe what certificate
it needs rather than putting that here.%ENDCOLOR%

See the [[CEMonOnComputeElement][CEMon section]] for the details on activating this service.  You will need the http certificate available before you activate this service.  <i>CEMon</i> runs as a  <i>tomcat</i> service and therefore the HTTP certicate must be owned by the uid under which tomcat and apache run.   (If you installed as <i>root</i>, the default user  for tomcat/apache is <i>daemon</i>).

<pre class="screen">
&gt;  <b>source $VDT_LOCATION/setup.sh</b>
&gt;  <b>cert-request -ou s</b> 
                -dir . \
                -host <i>my-host.some.domain</i> \
                -service http \
                -label <i>my-host-http</i>
</pre>
And after receiving an email notice that the certificate was issued, retrieve it as

<pre class="screen">
> <b>source $VDT_LOCATION/setup.sh</b>
> <b>cert-retrieve -serial 0xNNNN -label <i>my-host-http</i> -prefix http -dir .</b>
</pre>

Follow the instructions, which are very similar to the host cert instructions, except that you are creating =httpkey.pem= and =httpcert.pem=.  This certificate should be should be located in the following directory with ownership and permissions as follows:

<pre class="screen">
$ <b>mkdir /etc/grid-security/http </b>
$ <b>mv ./httpcert.pem /etc/grid-security/http/httpcert.pem </b>
$ <b>mv ./httpkey.pem /etc/grid-security/http/httpkey.pem </b>
$ <b>chmod 444 /etc/grid-security/http/httpcert.pem </b>
$ <b>chmod 400 /etc/grid-security/http/httpkey.pem </b>
$ <b>chown -R daemon.daemon /etc/grid-security/http </b>
</pre>

-->

%STOPINCLUDE%
%BR%
%COMPLETE2% %BR%
%RESPONSIBLE% Main.RobQ - 31 Oct 2007 %BR%
%REVIEW%
%REVCOM% changed name Main.RobGardner

<!--
Main.Weigand 14 Nov 2007
-->

%META:TOPICMOVED{by="RobGardner" date="1195161607" from="ReleaseDocumentation.GetHostCertificates" to="ReleaseDocumentation.GetGridCertificates"}%
