%META:TOPICINFO{author="ElizabethChism" date="1371571258" format="1.1" version="1.12"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! Updating Software on OASIS

%TOC%


The applicable software versions for this document are 
%RED%
*osg-version 3.1.13* 
%ENDCOLOR%
(or higher)

---++ About this Document
This document is a step by step explanation of how a VO Software Adminstrator can enable the OASIS service and use it to publish and update software on OSG Worker Nodes.

---++ Requirements
To begin the process to distribute software on OASIS, you must:
   * have a personal certificate. The process for getting one is detailed [[https://www.opensciencegrid.org/bin/view/Documentation/Release3/CertificateUserGet][here]]
   * register that certificate in [[https://http://oim.grid.iu.edu/oim/home][OIM]]
   * be associated with a Virtual Organization that is registered in OIM. The list of registered VOs appears [[http://oim.grid.iu.edu/oim/vo][here]].
   * have your certificate registered in your VOMS (GSISSH requires a proxy to work)
   * be attempting to distribute software of an appropriate size. Take time to consider your cache size as it relates to the size of your software.

---++ Technical details
---+++ Enable OASIS
When you are ready to distribute your software with OASIS, submit a [[https://ticket.grid.iu.edu/goc/submit][ticket]] with a request to enable OASIS for your VO. In your request, please specify your VO and provide a list of people to manage your VO software. 

The GOC will enable OASIS for your VO in [[https://oim.grid.iu.edu/oim/home][OIM]] and add your OASIS managers. oasis-login will grant access to the people you have specified as OASIS managers.

---+++ Log in with GSISSH
The next step is to generate a proxy and log into =oasis-login.opensciencegrid.org= with =gsissh=.
<pre class="screen">
%UCL_PROMPT% voms-proxy-init -voms %RED%VO%ENDCOLOR%
%UCL_PROMPT% gsissh oasis-login.opensciencegrid.org
</pre>

---+++ Updating and installing software
Once you log in, content is added/modified/removed on a staging area at =/net/nas01/Public/ouser.$VO= where $VO is the name of the VO represented by the manager.

Files here are visible to both =oasis-login= and the Stratum 0 server (oasis.opensciencegrid.org)

The OASIS manager for the VO requests an oasis update with: 
<pre class="screen">
%UCL_PROMPT% osg-oasis-update
</pre>

It is required that the requester be logged into the account associated
with a supported VO. As of this writing, these are:
   * ouser.csiu
   * ouser.gm2
   * ouser.hcc
   * ouser.icecube
   * ouser.mis
   * ouser.nova
   * ouser.osg
   * ouser.sbgrid
   * ouser.uc3

Others may be added per request.
Any other account generates a message and the update request fails.

Only one instance of =osg-oasis-update= can run at a time (across all VOs); your request may be queued behind a different VO.  If you encounter severe delays (more than 4 hours), please file a GOC ticket.

---+++ Details of =osg-oasis-update= operation.

A test is performed to determine if an update is in progress (existence
of a lock file, discussed below). If an update is in progress a "Please
try again later" message is printed and the process exits.

If no lock file exists one (vo_update_requested) is written. 

A request to update the stratum 0 generated.

The stratum 0 update is run as root and started by a crontab entry running
once per minute. The cron job detects the lockfile (vo_update_requested) written by the request
process on oasis-login.
If another lock (oasis_update_in_progress)
exists, the process sleeps and loops until it does not. This
mechanism prevents more than one update to be in progress at any time.
If oasis_update_in_progress does not exist it is created and the update process continues.
The files previously placed on the shared filesystem are rsync'ed to the 
/cvmfs directory. Upon completion a cvmfs-sync and cvmfs_server publish
are executed. All lock files are removed upon completion.

Finally, the status of the service is updated. See
http://oasis.opensciencegrid.org/stamp
A publish_age of zero indicates success. 

These mechanisms insure that:

   1. Only the OASIS manager for a VO can write to a location serving as the source of updates
   1. After a request is made only the files associated with one VO are updated
   1. Only one update can be in progress at a time


---++ *Comments*
%COMMENT{type="tableappend"}%

<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = JamesWeichel

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = General

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = Installation
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %YES%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %YES%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %YES%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = RobertEngel
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %YES%


 DEAR DOCUMENT TESTER
 ====================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = IwonaSakrejda
 Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %YES%
############################################################################################################
-->
-- Main.JamesWeichel - 03 Feb 2010