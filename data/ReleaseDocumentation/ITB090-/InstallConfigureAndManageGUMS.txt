%META:TOPICINFO{author="JayPackard" date="1194287354" format="1.1" reprev="1.37" version="1.37"}%
---+ *<noop>%SPACEOUT{ "%TOPIC%" }%*

%TOC%

---++ Introduction

[[https://www.racf.bnl.gov/Facility/GUMS/][Grid User Management System (GUMS)]] is a Grid Identity Mapping Service. Identity mapping is necessary when a site's resources do not use grid credentials natively, but instead use a different mechanism to identify users, such as UNIX accounts or Kerberos principals. In these cases, the grid credential for each incoming job must be associated with an appropriate site credential. The GUMS server performs this mapping and communicates it to the gatekeepers. The gatekeepers are charged with enforcing the site mapping established by GUMS. The GUMS client (gatekeeper) portion consists of an admin tool for querying and/or changing the state of the server. Typically, the term "GUMS" refers to the server portion.

GUMS is particularly well suited to a heterogeneous environment with multiple gatekeepers; it allows the implemenation of a single site-wide usage policy, thereby providing better control and security for access to the site's grid resources. Using GUMS, individual resource administrators are able to assign different mapping policies to different groups of users and define groups of hosts on which the mappings will be used. GUMS was designed to integrate with the site's local information services (such as HR databases or LDAP).

GUMS is intended to be used with %CACHE%, but it (the server portion) does not get installed as part of compute element software; you must install it separately. For the OSG ITB you will need to use one of two scenarios, "Full Privilege" or the "Compatibility" site configurations. %RED%(for itb you can't use grid3, but you can for osg? Clarify!--grid3 is deprecated everywhere, OSG and ITB! )%ENDCOLOR%

More Information can be obtained from the following resources:

   * The full GUMS service description and a detailed manual is available at the GUMS site: https://www.racf.bnl.gov/Facility/GUMS/
   * The Privilege project <a href="http://computing.fnal.gov/docs/products/voprivilege/">homepage</a> contains links to everything.  
   * Transition plan: http://computing.fnal.gov/docs/products/voprivilege/documents/transition-to-privilege.html
   * vo-admins@opensciencegrid.org - you can add yourself to this mail list by sending mail to listserv@opensciencegrid.org with the body of the mail being: add vo-admins 

---++ Pre-requisites for a GUMS Installation

See SitePlanning.  In particular, install Pacman, get host and http certificates. If you have an OSG GUMS running and you're about to reinstall or if any of the following daemons are installed and running on your machine: 
      * Apache
      * Tomcat V5 or V5.5
      * !MySql
see the [[#Shutdown_Guide][Shutdown instructions]].

---++ Install GUMS Server
If you want to be able to start GUMS automatically, you need to do the install as root. First of all, make sure no old copy of GUMS exists in the directory where you are installing the GUMS server. To do so, run:

<pre class="screen">
> ls $VDT_LOCATION/gums-service   <i><b>(for installations prior to VDT 1.7.1 )</i></b>
        or
> ls $VDT_LOCATION/scripts  <i><b>(for VDT 1.7.1 or higher)</i></b>
</pre>

This should return "fail to find the file".  You should install GUMS from the [[http://www.cs.wisc.edu/vdt/whats_new.html][latest VDT version]]. 

If you have an existing GUMS installation and would like to migrate the existing mappings, gums.config, and admin user to the new GUMS installation, then set the OLD_VDT_LOCATION enviroment variable before installing the new version of GUMS:

<pre class="screen">
> export VDT_OLD_LOCATION=/path/to/prior/vdt_location
</pre>

Here we describe the pacman GUMS installation. You can choose to install GUMS manually, or [[https://www.racf.bnl.gov/Facility/GUMS/1.2/installation_manual.html][learn more about the installation]]. 

---++ Use pacman to install GUMS
If you have a $VDT_LOCATION, go to it. If you don't, then create one and cd to it.  From there, run the pacman install command:
<pre class="screen">
&gt; pacman -get %CACHE%:gums
</pre>

Output:

This installs both the GUMS server and the GUMS client. 

During the installation, you will be asked several questions about trusting the VDT caches and accepting the package licenses.

Under $VDT_LOCATION, these changes occur:
   * If mysql, tomcat v55 and/or apache aren't already installed, it/they will get installed
   * =apache/conf/httpd.conf= gets updated to include tomcat-55 installation of GUMS. 
   * There's a gums-service directory which is for tomcat-55 services provided by GUMS
   * There's a gums directory which contains the GUMS client and host scripts
   * A mysql GUMS database is created, (currently) named GUMS_1_1

If you have installed GUMS as root then you can start the services used by GUMS and configure them to start at boot time with the =vdt-control= script:

<pre class="screen">
&gt; source &lt;YOUR_VDT_LOCATION&gt;/setup.sh
&gt; vdt-control --on
</pre>

If you have installed GUMS as a non-root user then you will need to start the services used by GUMS manually, even after a reboot:

<pre class="screen">
&gt; source &lt;YOUR_VDT_LOCATION&gt;/setup.sh
&gt; $VDT_LOCATION/post-install/mysql start
&gt; $VDT_LOCATION/post-install/apache start 
&gt; $VDT_LOCATION/post-install/tomcat-55 start 
</pre>

Make sure that the user who starts gums has read access to the http certificate and key.

Verify that you have access to your GUMS services. Go to your GUMS web interface (in a certificate-enabled browser) at =<nop>https://your-gums-server:8443/gums=. You should get a screen up. You won't be able to do anything else until you configure a GUMS administrator.

---++ Configure GUMS Server

---+++ Create a GUMS administrator
Make sure you log into your GUMS host as root.  If you have a root mysql password, you'll need it for this step.  If you don't have one, it won't be required. 

Add yourself to the list of GUMS admins by running the following commands if you are using 1.8.0 or 1.8.1:
       
<pre class="screen">
&gt; <b>ssh -l root your.host </b> <em>#login as root however you like</em>
&gt; <b>source $VDT_LOCATION/setup.sh </b>
&gt; <b>$VDT_LOCATION/tomcat/v55/webapps/gums/WEB-INF/scripts/addMySQLAdmin/addMySqlAdmin "<replaceable>your DN</replaceable>"</b>   <em>#quotes needed due to spaces in DN string</em>
</pre>

or in 1.8.2 (where the script has been renamed and added to $PATH) run the following commands:

<pre class="screen">
&gt; <b>ssh -l root your.host </b> <em>#login as root however you like</em>
&gt; <b>source $VDT_LOCATION/setup.sh </b>
&gt; <b>gums-add-mysql-admin "<replaceable>your DN</replaceable>"</b>   <em>#quotes needed due to spaces in DN string</em>
</pre>

This will give you administrative access through your GUMS web interface.  This adds you (or the DN you provide) to the <b>admins</b> subGroup in the GUMS database.

Output of the <nop>gums-add-mysql-admin command:

<pre class="screen">
WARNING: You must have created the database before running this script!

Adding the following DN to the local database:
Certificate DN for administrator: "/DC=org/DC=doegrids/OU=People/CN=Anne Heavey 830711"

Is this correct? (Enter 'yes' to proceed)
yes

Adding the admin:
Enter the root mysql password
</pre>

If there's no password set, it will finish by itself.  Ignore the warning; the database got created during the installation.

Verify you have  administrative capabilities in GUMS by going to the web interface and clicking "Persistence Factories" as a test.  You should see a persistence factory entry.

If you get the following, you have not added yourself correctly to the <b>admins</b> group or you are using the wrong certificate in your browser:
<pre class="screen">
  Error generating grid-mapfile: You are not authorized to perform this function. Contact your gums administrator if access is needed.
</pre>   

---+++ Replace default configuration with OSG configuration
A default barebones gums.config file is installed in =<nop>$VDT_LOCATION/tomcat/v55/webapps/gums/WEB-INF/config/gums.config=.  

Use the following script to replace this default gums.config with the OSG gums.config template by typing:

<pre class="screen">
gums-create-config --template gums.config.osg_template
</pre>

The database information will be taken from the default gums.config and inserted into the OSG gums.config.  If the "gums-create-config" command is not found, you don't have a late enough version of the VDT, in which case you can download the script from https://www.racf.bnl.gov/Facility/GUMS/1.2/gums-create-config, which you should place in the folder =<nop>$VDT_LOCATION/tomcat/v55/webapps/gums/WEB-INF/scripts= and then run as above but making sure to specify the entire path.

---+++ Test the configuration

On your GUMS web interface at =<nop>https://your-gums-server:8443/gums=, 
    <ul><li>Click "Update VO Members" in the left pane.
             <li>Click the "Update VO Members Database" button.
   </ul>
This retrieves the members of the VOs and inserts them into the !MySql GUMS database.

Still on your GUMS web interface, 
      <ul><li>Click on "Generate Grid Mapfile".
       <li>Enter the DN of the hostname that you want to generate the grid mapfile for (e.g. <i>/DC=org/DC=doegrids/OU=Services/CN=gateway.bnl.gov</i>).</li>
    <li>Click "generate grid-mapfile."  <br>
        You should get the text of a grid-mapfile formatted output (as of this writing):
<pre class="programlisting">
#---- members of vo: osg ----#
"/DC=org/DC=doegrids/OU=People/CN=Alexis Rodriguez 233072" osg
"/DC=org/DC=doegrids/OU=People/CN=Andrew Zahn 730598" osg
"/DC=org/DC=doegrids/OU=People/CN=Craig Phillip Prescott 50911" osg
</pre></li> 
</ul>

If you get errors and need to look in log files, they're kept under <tt>$VDT_LOCATION/tomcat/v55/logs</tt>.  The first one to check is the <tt>gums-service-admin.log</tt>, and second the <tt>gums-service-developer.log</tt>.

A few notes about maintenance:
   * The gums.config needs to be maintained such that it includes mappings for all active VOs in OSG. %RED%How to do this still needs to be addressed (Dane has some ideas) AH 5/27/05%ENDCOLOR%
   * You'll need to be notified of changes to the list of VOs in order to maintain this.

---++Understanding GUMS configuration
These links below contain the official documentation for GUMS:
|GUMS configuration guide|https://www.racf.bnl.gov/Facility/GUMS/1.2/use_configuration.html|
|GUMS manual user management guide|https://www.racf.bnl.gov/Facility/GUMS/1.2/use_configuration.html|

gums.config examples can be found here
---+++[[GumsConfigExamples][gums.config examples]]

---+++Setting up email notification for GUMS errors
GUMS has the capability to notify an administrator via email of any errors that may occur. The =$VDT_LOCATION/tomcat/v55/webapps/gums/WEB-INF/classes/log4j.properties= contains these entries but are commented out.  Look for these lines:

<pre class="programlisting">
  #log4j.appender.mail=org.apache.log4j.net.SMTPAppender
  #log4j.appender.mail.from=gums@site.com
  #log4j.appender.mail.subject=gums e-mail alert
  #log4j.appender.mail.SMTPHost=smtp.site.com
  #log4j.appender.mail.to=admin@site.com
  #log4j.appender.mail.layout=org.apache.log4j.PatternLayout
  #log4j.appender.mail.layout.ConversionPattern=%d{DATE} [%-5p]: %m%n
</pre>

Uncomment them and set the "from", "SMTPHost", and "to" lines to the right values for your site.  "From" should be the username under which GUMS runs.  

Here is a sample:
<pre class="programlisting">
  log4j.appender.mail=org.apache.log4j.net.SMTPAppender
  log4j.appender.mail.from=daemon@cd-94372.dhcp.fnal.gov
  log4j.appender.mail.subject=gums e-mail alert
  log4j.appender.mail.SMTPHost=smtp.fnal.gov
  log4j.appender.mail.to=aheavey@fnal.gov
  log4j.appender.mail.layout=org.apache.log4j.PatternLayout
  log4j.appender.mail.layout.ConversionPattern=%d{DATE} [%-5p]: %m%n
</pre>

Towards the top of the same file (line 22) under the heading "Log for GUMS administrator", you'll see:
<pre class="programlisting">
  log4j.logger.gums.resourceAdmin=DEBUG, adminFile
  #log4j.logger.gums.resourceAdmin=DEBUG, mail, adminFile
</pre>

Comment out the first line and uncomment the second so that the resource info that you need to get comes to you via email in addition to going to a file.
   
After you change these files, stop and restart tomcat-55.

To test for notification, force an error.  E.g., in gums.config, give an incorrect sslCACertificates path:  
<verbatim>
                <vomsServer
                        name='osg'
                        ...
                        sslCAFiles='/dev/null/*.0'/>
</verbatim>

Now go to the GUMS-Admin UI <tt>https://your.gums.host:8443/gums</tt>, click Update Members. You should get an error which (among other text) should contain "Error Message: GUMS is misconfigured: please check the resource admin log for errors, and the gums.config file."

You should receive one or more email notifications as well. (The error shown above generated two messages.)  One of them contains the solution: 

<pre class="programlisting">
15 Aug 2007 11:44:35,198 [WARN ]: VOMSGroup: remainderUrl='' - voGroup='/osg' - role='' wasn't updated successfully:  [Couldn't retrieve users from VOMS server: ; nested exception is: 
	java.lang.Exception: The trusted certificate authority certificates reading failed:  java.io.IOException: No CA files found matching "/dev/null/*.0]
15 Aug 2007 11:44:35,201 [ERROR]: GridID[/DC=org/DC=doegrids/OU=People/CN=Michael Thomas 725374] - Failed to update all groups - Some groups weren't updated correctly: consult the logs for more details. Check GUMS configuration or the status of the VO servers.
</pre>

Don't forget to fix your error now! .... and restart tomcat!!!

---+++Setting the Frequency to Refresh GUMS from VOMS
GUMS will query the various VOMS VOs defined in the <b>gums.config</b> file on a periodic basis based on a parameter defined in =$VDT_LOCATION/gums-service/var/war/WEB-INF/web.xml=.

The third line from the bottom contains the interval in minutes. Default is every 12 hours.
<verbatim>
 <env-entry-value>720</env-entry-value>
</verbatim>

You may want to adjust the value.  You will need to restart tomcat to effect the change.

---+++Installation and Basic Configuration Postmortem
If you've made to this point, you should have a functioning GUMS server.  Congratulations! Savor the moment! You just completed the easy part.  The true challenge is ahead.

Now you will need configure GUMS for the VOs  your site will  support and the authorization policy you wish to deploy for assigning  accounts.  This is not a trivial task.  The following sections will provide some insight into the "instant gratification" configuration of the gums.config you just performed.. 


---++Connecting your GUMS to other VOMS installations
As you will see in the next section, as well as in the small configuration you just completed, that the various VOMS servers you will support are identified in the ==gums.config==  file's  ==userGroup url== attribute.

Your GUMS server needs to access the VOMS servers for the VOs you will be supporting. These VOMS servers can be configured to allow access in one of 2 ways:
   * allow anyone with a valid certificate read-only access
   * allow only specific hosts read access 

In either case, the http certificate you established for GUMS is this identification.  If, when you configure GUMS and you get an "Access Denied" message when performing the "Update Members" web UI function, you will need to contact that VOMS VO adminstrator and request access.

---++Set up CE Authorization To Use GUMS
Now that you have GUMS configured to perform the account authorizations, you need to effect it on the CE/gatekeeper node(s). There are 2 important aspects of this:
   * Using GUMS for authorization mappings toUNIX UID
   * Using GUMS to generate the !MonALISA monitoring VO-to-User map file.

Each of these is described in the [[OsgCEAuthorization050][OSG CE Authorization]]  page.

---+++OSG CE Authorizations
There are 2 authorization configurations involving GUMS described on the [[OsgCEAuthorization050][OSG CE Authorization]] page:
   * Compatibility configuration - where you are still using the grid-mapfile 
   * Full Privilege configuration - where the grid-mapfile is no longer used and is replaced by the globus gatekeeper callout of PRIMA which makes a web services authorization request oof GUMS.

---+++<nop>MonALISA Monitoring VO-to-User Map file
Under both configurations,now that you are using GUMS to establish your account assigments,  you will need to use the GUMS's *generateGrid3UserVoMap* to generate the *VDT_LOCATION/monitoring/grid3-user-vo-map.txt* file which is critical to the !MonALISA  [[VOModulesDescription][VO Modules]] accounting of the jobs and ftp IO activity on the CE/gatekeeper host.



---++Miscellaneous
---+++Managing the GUMS log files
GUMS logging is managed using the [[http://logging.apache.org/log4j/docs][Apache log4j logging services]].  

The GUMS web server processes log files, covering the web user  interface and the authorization services, are managed  in =VDT_LOCATION/gums-service./var/war/WEB-INF/classes/log4j.properties=.

The GUMS client and host log configuration file, which  may be on host different from the GUMS web server, is located in
=VDT_LOCATION/gums/etc/log4j.properties=.

More detailed description on GUMS logging can be found at the primary GUMS web portal  ([[http://grid.racf.bnl.gov/GUMS/guide_logging.html][general]] and [[http://grid.racf.bnl.gov/GUMS/guide_logging_details.html][detailed]] information).

---+++ Publishing your authorization service status (optional)
This is optional capability that allows each of the CE nodes that use your GUMS authorization service to publish, via classads, the availability/status of your authorization service.  It is only available if your CEs are operating in Full Privilege authorization mode.  This is a =GIP/CEmon= service detailed in the [[CEInstallGuide#gumsprobe][CE Installation Guide section on CEMon]]

In addition to the configuration on each of the CE nodes, the following needs to be performed on the GUMS node.  You do not need to take your service down to do this.

1. Add these entries to your =$VDT_LOCATION/vdt-app-data/gums/gums.config= file:
<verbatim>
<groupMappings>
  <groupMapping name='gums-test'>
    <userGroup className='gov.bnl.gums.ManualUserGroup'
               persistenceFactory='mysql'
               name='gums-test'/>
    <accountMapping className='gov.bnl.gums.GroupAccountMapper'
                    groupName='GumsTestUserMappingSuccessful' />
  </groupMapping>
</groupMappings>

<hostGroups>
  <hostGroup className='gov.bnl.gums.CertificateHostGroup'
             cn='ldap/*.my.site'         
             groups='gums-test' />
</hostGroups>
</verbatim>
%IMPORTANT%You will need to change the <b>cn='ldap/*.my.site'</b> to reflect your sites domain name.

2. You will need to add the =subject= values from each CE node LDAP certificate as members of the =gums-test= =userGroup=.  Execute the following command using the administrative user credentials. Make sure you substitute the identity of the probe as the last parameter i.e. the subject of the LDAP service certificate on the CE running the generic information provider.
<pre class="screen">
> gums manualGroup-add mysql gums-test <subject>
Example:
> gums manualGroup-add mysql gums-test "/DC=org/DC=doegrids/OU=Services/CN=ldap/mymachine.fnal.gov"
</pre>


%INCLUDE{"GumsClientInstall"}%

---++Shutdown Guide
The GUMS installation starts up several processes.  If you try to re-install/upgrade the GUMS without shutting them down it will fail.  Run the following commands to turn off the GUMS services in VDT 1.6.0 and earlier releases before upgrading:

   * =/etc/init.d/apache stop=
   * =/etc/init.d/tomcat-5 stop=
   * =/etc/init.d/gums stop=
   * =/etc/init.d/mysql stop=

In VDT 1.6.1 and later, you need to use the =vdt-control= script to shut off the services:

   * =vdt-control --off apache=
   * =vdt-control --off tomcat-5=
   * =vdt-control --off mysql=
or turn all VDT services off in VDT 1.6.1 and later with
   * =vdt-control --off=

---++Troubleshooting

PRIMA 0.2 can not interface to a GUMS server that runs with a service (rather than host) certificate.  If you will be using PRIMA you need to switch the certificate used by gums:

<pre class="screen">
> <b>cd /etc/grid-security/http</b>
> <b>mv httpkey.pem httpkey.pem.sav</b>
> <b>mv httpcert.pem httpcert.pem.sav</b>
> <b>cd ..</b>
> <b>cp hostkey.pem http/httpkey.pem</b>
> <b>cp hostcert.pem http/httpcert.pem</b>
> <b>chown -R daemon:daemon http </b>
</pre>

---++Appendix A: %CACHE% gum.config groupmappings

[[http://software.grid.iu.edu/pacman/tarballs/vo-version/gums.template][The current gums.template]] contains an example of pool accounts in all the uscms entries.


---++Appendix B: %CACHE% GUMS Stress Test
See  [[GumsStressTest][GUMS stress test results]]

%BR%
%COMPLETE2% %BR%
%RESPONSIBLE% Main.JayPackard - 17 Oct 2007 %BR%
%REVIEW% Main.JohnWeigand 

%META:TOPICMOVED{by="AnneHeavey" date="1192808022" from="Integration/ITB_0_7.GumsAdmins" to="Integration/ITB_0_7.InstallConfigureAndManageGUMS"}%
