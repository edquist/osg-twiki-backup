%META:TOPICINFO{author="RobertEngel" date="1270760535" format="1.1" reprev="1.58" version="1.58"}%
%META:TOPICPARENT{name="ComputeElementInstall"}%
<!-- CONTENT MANAGEMENT PROJECT

   DEAR DOCUMENT OWNER
   ===================

   Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER          = JamesBarlow

   Please define the document area, choose one of the defined areas from the next line
   DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = ComputeElement

   define the primary role the document serves, choose one of the defined roles from the next line
   DOC_ROLE = (Scientist|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

   Please define the document type, choose one of the defined types from the next line
   DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = HowTo
   
   Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

   Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

   change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %NO%

   change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %NO%

   change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


   DEAR DOCUMENT REVIEWER
   ======================

   Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = RobertEngel
  
   Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %IN_PROGRESS%


   DEAR DOCUMENT TESTER
   ====================

   Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = RobertEngel
  
   Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %IN_PROGRESS%
 
-->

%SHOW_DOC_STATUS_TABLE%
---+!! *<nop>%SPACEOUT{ "%TOPIC%" }%*

%TOC%

%STARTINCLUDE%
%BR%
---+ _%INCLUDEHEADING%  %SPACEOUT{ "%TOPIC%" }%_
%EDITTHIS%

---+ About this Document

%ICON{hand}% This document is for system administrators. After reading this document you should be able to apply for and install a grid certificate on a grid resource. This document does not explain how to apply for a grid user certificate. To apply for a grid user certificate click [[UserCertificate][here]] instead!

---+ Requirements 

We recommend to read background information on grid certificates which can be found [[Documentation.CertificateWhatIs][here]]. In order to proceed you will also need:

   * a [[PacmanInstall][Pacman]] installation
   * the *fully qualified domain* name of the host you need a grid certificate for
   * the *purpose* of the certificate that explains your request to the Certificate Authority
   * the full *name of the administrator* responsible for the host
   * the *e-mail address of the administrator*
   * the *telephone number of the administrator*
   * the name of the *Certificate Authority* your project is affiliated with
   * the name of the *Virtual Organization* affiliated with the Certificate Authority


%TWISTY{%TWISTY_OPTS_REVIEW%}%

%GRAY%This all doesn't belong into an introduction%ENDCOLOR%

%NOTE% For security reasons, please *do not* use clones of your host certificate for additional certificates even though it's technically possible.  There is one exception to this.  If you enable Globus web services, the Globus container requires  the host certificate.  Since the Globus container runs as _non_root_, the VDT configuration software will clone your host certificate as =/etc/grid-security/containercert.pem(containerkey.pem)= and will be owned by the account you configured Globus to run under (normally _globus_ or _daemon_). This is the *ONLY* exception at this time.

%NOTE% If you find the http certificate files already installed, you might want to check their end date which indicates their validity. As root, run the =openssl= command on each of the =*cert.pem= files, e.g.,:
<pre class="screen">
    # openssl x509 -in /etc/grid-security/hostcert.pem -enddate -noout
</pre>

%ENDTWISTY%

---+ Install the Certificate Scripts Package

To ease the process of applying for a grid host certificate the OSG provides a *Certificates Script Package*. [[PacmanInstall][Pacman]] is required for the installation. Please install Pacman before you proceed.

First create a new directory where the certificates will be installed and change to it:

<pre class="screen">
[root@osg-se]# mkdir /opt/csp
[root@osg-se]# cd /opt/csp
</pre>

Next use Pacman to install the Certificates Script Package:

<pre class="screen">
[root@osg-se csp]# pacman -get %VDT_CACHE_URL%:PPDG-Cert-Scripts
</pre>

%TWISTY{%TWISTY_OPTS_OUTPUT%}%
<pre class="screen">
[root@osg-se csp]# pacman -get %VDT_CACHE_URL%:PPDG-Cert-Scripts

Do you want to add [%VDT_CACHE_URL%] to [trusted.caches]? (y/n/yall): yall
Beginning VDT prerequisite checking script vdt-common/vdt-prereq-check... 

The VDT installs a variety of software, each with its own license.
In order to continue, you must agree to the licenses.
You can view the licenses online at:

    http://vdt.cs.wisc.edu/licenses/

After the installation has completed, you will also be able to
view the licenses in the "licenses" directory.

Do you agree to the licenses? [y/n]
y
All prerequisite checks are satisfied.
                                                        
========== IMPORTANT ==========
Most of the software installed by the VDT *will not work* until you install
certificates.  To complete your CA certificate installation, see the notes
in the post-install/README file.

</pre>
%ENDTWISTY%

If you agreed to add =%VDT_CACHE_URL%= to the list of trusted caches and to the license, you should see the directory populated. 

%TWISTY{%TWISTY_OPTS_REVIEW%}%

%GRAY%The old stuff ...%ENDCOLOR%

The [[CertScripts][Certificate Scripts Package]] provides scripts to request and retrieve certificates (see also [[Security.CertScriptsPackage][PPDG-Cert-Scripts]]).  Any recent OSG or VDT installation has them.  You can install the package stand-alone if that is convenient, using [[PacmanInstall][Pacman]].

   * Note: It possible to request host certificates for any host using a VDT/OSG install on any other computer.
  
*Installation of the cert-scripts package:* Make the directory where you are going to install the package, and =cd= to it.  Note that this will be the =$VDT_LOCATION=
for this temporarily installation of the certificate scripts.  The installation can be done as a regular user or as root. Find the [[http://vdt.cs.wisc.edu/documentation.html][latest VDT cache]], and download =PPDG-Cert-Scripts= from it (shown for VDT %OSG_ITB_VDT_VERSION%), and answer the installation questions as shown below:

<pre class="screen">
# <b>mkdir tmp-cert-scripts</b>
# <b> cd tmp-cert-scripts</b>
# <b>pacman -get http://vdt.cs.wisc.edu/%VDT_CACHE%:PPDG-Cert-Scripts</b>
Do you want to add [http://vdt.cs.wisc.edu/%VDT_CACHE%] to [trusted.caches]? (y or n): <b>y</b>
Do you agree to the licenses? [y/n] <b>y</b>
</pre>

%ENDTWISTY%

---+ Update your Environment

In order to use the Certificates Script Package you will need to update your environment:

<pre class="screen">
[root@osg-se csp]# source setup.sh
</pre>

For *c/tc shell* change setup.sh to %RED%setup.csh%ENDCOLOR%. 

---+ Setup Initial Certificate Authority (CA) Package

Next we will use *vdt-ca-manage* to install the initial set of certificate authorities:

<pre class="screen">
[root@osg-se csp]# vdt-ca-manage setupCA --location local --url osg

Setting CA Certificates for VDT installation at '/opt/csp'
Setup completed successfully.
</pre>

This command is used for the initial setup of the CA package. The option =--location local= is used to define a location below your current directory (/opt/csp/globus/share/certificates). Alternatively you can use =--location root= to install the certificates into their standard location (/etc/grid-security/certificates).

%TWISTY{%TWISTY_OPTS_REVIEW%}%
%GRAY%Not sure if that is needed%ENDCOLOR%
After you have completed installation of the CE or Client packages it is probably useful to
remove this temporary certificate scripts installation to avoid confusion with the
scripts included with the CE and Client packages.
%ENDTWISTY%

---+ Request a Host Certificate

Every resource or service contributing to the grid needs a certificate issued by one of the trusted *Certificate Authorities*. To proceed you will need following information at hand:

   * the *fully qualified domain* name of the host you need a grid certificate for
   * the *purpose* of the certificate that explains your request to the Certificate Authority
   * the full *name of the administrator* responsible for the host
   * the *e-mail address of the administrator*
   * the *telephone number of the administrator*
   * the name of the *Certificate Authority* your project is affiliated with
   * the name of the *Virtual Organization* affiliated with the Certificate Authority

Next we will use *cert-request* to generate a request which will be sent to the Certificate Authority you specified:

<pre class="screen">
[root@osg-se csp]# cert-request -ou s -dir . -label osg-se.ligo.caltech.edu
</pre>

%TWISTY{%TWISTY_OPTS_OUTPUT%}%
<pre class="screen">
[root@osg-se csp]# cert-request -ou s -dir . -label %RED%osg-se.ligo.caltech.edu%ENDCOLOR%

checking CertLib version, V2-7,  This is the latest version, released 18 May 2009.
Processing OU=Services request.
Give reason (1 line) you qualify for certificate, such as
  member of CMS experiment    or
  collaborating with Condor team,  etc.
 reason: %RED%Setup a new ITB Storage Element at Caltech.%ENDCOLOR%
input server administrator's name: %RED%Robert Engel%ENDCOLOR%
input full hostname: %RED%osg-se.ligo.caltech.edu%ENDCOLOR%
Generating a 2048 bit RSA private key
..............+++
.........................................................................................................................................................................................................................+++
writing new private key to './osg-se.ligo.caltech.edukey.pem'
-----
input your email address: %RED%admin e-mail here%ENDCOLOR%
input your complete phone number: %RED%admin phone here%ENDCOLOR%
Choose a registration authority to which you are affiliated.
If nothing else applies, pick OSG.
_Enter__this____for this registration authority
	ANL	 Argonne National Lab
	ESG	 Earth System Grid
	ESnet	 DOE Science network
	FNAL	 Fermilab host and service certificates
	FusionGRID	 National Fusion Collaboratory Project
	LBNL	 Berkeley Lab
	LCG	 LHC Computing Grid Catchall
	NERSC	 computer center
	ORNL	 Oak Ridge National Lab
	OSG	 Open Science Grid (choose this if nothing else applies)
	PNNL	 Pacific Northwest National Lab
(choose from left column): %RED%OSG%ENDCOLOR%
osg
OSG
Choose a virtual organization under your OSG affiliation:
  ALICE:	ALICE collaboration
  ATLAS:	United States ATLAS Collaboration
  BNL:	Brookhaven lab researchers
  CDF:	Collider Detector at Fermilab
  CIGI:	CyberInfrastructure and Geospatial Information Laboratory
  CMS:	Compact Muon Solenoid
  CompBioGrid:	CompBioGrid
  DayaBay:	Daya Bay Reactor Neutrino Experiment
  DES:	Dark Energy Survey
  DOSAR:	Distributed Organization for Scientific and Academic Research
  DZero:	D0 Experiment at Fermilab
  Engage:	Engagement
  Fermilab:	Fermi National Accelerator Laboratory
  FermilabAccelerator:	Fermilab/Accelerator
  FermilabArgoneut:	Fermi T-962 Liquid Argon Time Projection chamber
  FermilabAstro:	Fermilab/Astro
  FermilabCdms:	Fermilab/Cdms
  FermilabGrid:	fermilab VO grid group
  FermilabHypercp:	Fermilab/Hypercp
  FermilabKTeV:	Fermilab/KTeV
  FermilabLbne:	Fermilab/Lbne
  FermilabMinerva:	Fermilab/Minerva
  FermilabMiniboone:	Fermilab/Miniboone
  FermilabMinos:	Fermilab/Minos
  FermilabMipp:	Fermilab/Mipp
  FermilabMu2e:	Fermilab/Mu2e
  FermilabNova:	Fermilab/Nova
  FermilabNumi:	Fermilab/Numi
  FermilabPatriot:	Fermilab/Patriot
  FermilabTest:	Fermilab/Fgtest
  FermilabTheory:	Fermilab/Theory
  Geant4:	Geant4 Software Toolkit
  GLOW:	Grid Laboratory of Wisconsin
  Gluex:	Gluex experiment at Jefferson Lab
  GPN:	Great Plains Network
  GRASE:	Group Researching Advances in Software Engineering at University of New York at Buffalo
  GridUNESP:	S?o Paulo State University Grid
  GROW:	Grid Research and Education Group at Iowa
  I2u2:	Interactions in Understanding the Universe Initiative
  IceCube:	IceCube Neutrino Telescope
  ILC:	International Linear Collider
  JDEM:	Joint Dark Energy Mission
  JLab:	Jefferson Lab researchers
  LIGO:	Laser Interferometer Gravitational-Wave Observatory
  Mariachi:	Mixed Apparatus for Radar Investigation of Cosmic-rays of  High Ionization Experiment
  MIS:	OSG Monitoring Information System
  NanoHUB:	nanoHUB Network for Computational Nanotechnology (NCN)
  NEBioGrid:	New England Biomedical Grid
  NWICG:	Northwest Indiana Computational Grid
  NYSGRID:	NYSGRID
  Ops:	WLCG Operations Group
  OSG:	Open Science Grid
  OSGEDU:	OSG Education Activity
  SBGrid:	Structural Biology Grid
  SLAC:	SLAC National Accelerator Laboratory researchers
  STAR:	Solenoidal Tracker at RHIC
(Choose from left column; pick osg if nothing else applies): %RED%LIGO%ENDCOLOR%
OSG:LIGO
You must agree to abide by the DOEGrids policies,
at http://www.doegrids.org/Docs/CP-CPS.pdf
and you assert that you are authorized to request and install this
certificate on the specified host.
Do you agree (y,N): y

Your Certificate Request has been successfully submitted
Your Certificate Request id: %RED%my id here%ENDCOLOR%

        You will receive a notification email from the CA when your certificate
        has been issued. Please disregard the instructions to download your
        certificate though a web browser and use the cert-retrieve script instead.
</pre>
%ENDTWISTY%

At this point *cert-request* has created some files in the directory you specified and an e-mail has been sent to the Certificate Authority containing your request. The files will be needed again once you receive a reply from the Certificate Authority asking you to retrieve the certificate.

%TWISTY{%TWISTY_OPTS_REVIEW%}%

Every resource or service running on the grid needs an X509 identity certificate from one of the trusted CAs. 
   * Currently the [[http://www.doegrids.org][DOEGrids CA]] is the most common CA in use for OSG participants. 
   * The [[http://www.opensciencegrid.org/ra][OSG Registration Authority]] with DOEGrids handles most certificate requests for OSG participants. 
 
%NOTE% Do not use a host's DNS alias when requesting a host certificate. Use the authoritative DNS name. Failing to do so can cause GSS authentication failures similar to the following when a user tries to authenticate to the host after your certificate is installed:

<pre>
GSS authentication failure 
GSS Major Status: General failure 
GSS Minor Status Error Chain: 
accept_sec_context.c:gss_accept_sec_context:403: 
Error during delegation: Delegation protocol violation 
Failure: GSS failed Major:000d0000 Minor:00000001 Token:00000000 
</pre>

Run the =cert-request= script  to generate your host's private key (<tt>hostkey.pem</tt>) and submit the certificate request.
$VDT_LOCATION must point to the package in which the scripts exist, e.g., the CE install directory or where you installed PPDG-Cert-Scripts,
or the temporary directory as described above.  The values for the =-label= and =-dir= options need to match the values used later with the =cert-retrieve= script.

<pre class="screen">
# <b>cd $VDT_LOCATION</b>
# <b>source  ./setup.sh</b>
# <b>cd vdt/setup/</b>   ### you could use some other directory, such as /etc/grid-security
#                 ### which is the typical location to install the certificates
# <b>cert-request -ou s -dir . -label <i>my-host</i></b>
checking CertLib version, V2-5,  This is latest version, released 24 Aug 2007.
Processing OU=Services request.
Give reason (1 line) you qualify for certificate, such as
  member of CMS experiment    or
  collaborating with Condor team,  etc.
 reason: <b>setting up my CE for site/vo</b>
input server administrator's name: <b>Joe Admin</b>
input full hostname: <b>myhost.some.domain</b>  ### Enter the actual DNS record. Do not use an alias. See note above.
Generating a 2048 bit RSA private key
.....................................+++
................................................+++
writing new private key to './my-hostkey.pem'
-----
input your email address: <b>certs@some.domain</b>
input your complete phone number: <b>123456789</b>
Choose a registration authority to which you are affiliated.
If nothing else applies, pick OSG.
_Enter__this____for this registration authority
        anl     ANL: Argonne National Lab
 <i>----abreviated output----</i>
        osg     OSG: Open Science Grid (choose this if nothing else applies)
        pnnl    PNNL: Pacific Northwest National Lab
(choose from left column): <b>osg</b>
osg
OSG
Choose a virtual organization under your OSG affiliation:
        bnl     BNL: Brookhaven lab researchers not in an OSG registered VO
 <i>----abreviated output----</i>
        star    Solenoidal Tracker at RHIC
        usatlas United States ATLAS Collaboration
(Choose from left column; pick osg if nothing else applies): <b>osg</b>
OSG:OSG
You must agree to abide by the DOEGrids policies,
at
and you assert that you are authorized to request and install this
certificate on the specified host.
Do you agree (y,N): <b>y</b>

Your Certificate Request has been successfully submitted
Your Certificate Request id: NNNN

        You will receive a notification email from the CA when your certificate
        has been issued. Please disregard the instructions to download your
        certificate though a web browser and use the cert-retrieve script instead.
</pre>

The certificate request will leave some files in the directory that will be needed when you retrieve your cert.

%NOTE% It is possible to continue with steps in the install procedure while you are waiting for your host certificate to be approved.

See [[Security.CSReadMe#cert_request][full man page]] on the cert-request command for additional useful options.
%ENDTWISTY%

---+ Retrieve and Install the Host Certificate

Once the certificate has been approved by the Certificate Authority you will receive an e-mail which includes the *serial number* in the format *0xYYYY* for the new certificate. The serial number will be needed to retrieve the certificate. 

Change to the installation directory of the Certificate Scripts Package and update your environment:

<pre class="screen">
[root@osg-se csp]# cd /opt/csp
[root@osg-se csp]# source setup.sh 
</pre>

For *c/tc shell* change setup.sh to %RED%setup.csh%ENDCOLOR%. Next we will use the %RED%serial number%ENDCOLOR% of the certificate and the previous values for =--label= and =--dir= to retrieve the certificate executing *cert-retrieve*:

<pre class="screen">
[root@osg-se csp]# cert-retrieve  -serial %RED%0xYYYY%ENDCOLOR% -label %RED%osg-se.ligo.caltech.edu%ENDCOLOR% -dir %RED%.%ENDCOLOR% -prefix host
checking CertLib version, V2-5,  This is latest version, released 24 Aug 2007.
 using CA OSG
Checking that the usercert and ./osg-se.ligo.caltech.edukey.pem match
writing RSA key
./hostcert.pem and ./hostkey.pem now contain your Globus credential
</pre>

<i>Note that if you did not use the =-prefix= option to name the =.pem= files
they will have the default values of =usercert.pem= and =userkey.pem=.</i>

Now move the =hostcert.pem= and =hostkey.pem= files to =/etc/grid-security= and set permissions:
<pre class="screen">
# <b>mv ./hostcert.pem /etc/grid-security/</b>
# <b>mv ./hostkey.pem /etc/grid-security/</b>
# <b>chmod 444 /etc/grid-security/hostcert.pem</b>
# <b>chmod 400 /etc/grid-security/hostkey.pem</b>
</pre>


The following command will verify the certificate is readable.  The output shown will be similar, but specific to your request.

<pre class="screen">
# <b>openssl x509 -text -noout -in /etc/grid-security/hostcert.pem</b>
Certificate:
  Data:
      Version: 3 (0x2)
      Serial Number: 743 (0x2e7)
      Signature Algorithm: sha1WithRSAEncryption
      Issuer: DC=org, DC=DOEGrids, OU=Certificate Authorities, CN=DOEGrids CA 1
      Validity
          Not Before: Oct 17 22:03:24 2006 GMT
          Not After : Oct 17 22:03:24 2007 GMT
      Subject: DC=org, DC=doegrids, OU=Services, CN=my-host.some.domain
      .........
</pre>


---++ Other service certificates 

Additional service certificate can be obtained using the same procedure as for the host certificate above by
simply including the =-service servicename= option with cert-request.  For =servicename= you might use =http=.  
The name of the service is rather arbitrary.
<pre class="screen">
> cert-request -ou s -service http -host my-computer.some.domain -label http-my-computer
</pre>

<!--  D.O. - lets drop this part
-->
<!--

Get an HTTP service certificate to activate CEMon

%BLUE%[D.O. - Seems to me that the CEMon install/configure documentation should describe what certificate
it needs rather than putting that here.%ENDCOLOR%

See the CEMon section for the details on activating this service.  You will need the http certificate available before you activate this service.  <i>CEMon</i> runs as a  <i>tomcat</i> service and therefore the HTTP certicate must be owned by the uid under which tomcat and apache run.   (If you installed as <i>root</i>, the default user  for tomcat/apache is <i>daemon</i>).

<pre class="screen">
&gt;  <b>source $VDT_LOCATION/setup.sh</b>
&gt;  <b>cert-request -ou s</b> 
                -dir . \
                -host <i>my-host.some.domain</i> \
                -service http \
                -label <i>my-host-http</i>
</pre>
And after receiving an email notice that the certificate was issued, retrieve it as

<pre class="screen">
> <b>source $VDT_LOCATION/setup.sh</b>
> <b>cert-retrieve -serial 0xNNNN -label <i>my-host-http</i> -prefix http -dir .</b>
</pre>

Follow the instructions, which are very similar to the host cert instructions, except that you are creating =httpkey.pem= and =httpcert.pem=.  This certificate should be should be located in the following directory with ownership and permissions as follows:

<pre class="screen">
$ <b>mkdir /etc/grid-security/http </b>
$ <b>mv ./httpcert.pem /etc/grid-security/http/httpcert.pem </b>
$ <b>mv ./httpkey.pem /etc/grid-security/http/httpkey.pem </b>
$ <b>chmod 444 /etc/grid-security/http/httpcert.pem </b>
$ <b>chmod 400 /etc/grid-security/http/httpkey.pem </b>
$ <b>chown -R daemon.daemon /etc/grid-security/http </b>
</pre>

-->

---++ Prior releases
In prior OSG releases (pre OSG 0.6), certificates where handled [[CertificatesOldWay][this way]], included here as reference.



%STOPINCLUDE%
%BR%
%COMPLETE2% %BR%
%RESPONSIBLE% Main.RobQ - 31 Oct 2007 %BR%
%REVIEW% Main.RobGardner - 27 Nov 2007 %BR%
%REVCOM% Attempted to clean up

<!--
Main.Weigand 14 Nov 2007
-->

%META:TOPICMOVED{by="RobGardner" date="1195161607" from="ReleaseDocumentation.GetHostCertificates" to="ReleaseDocumentation.GetGridCertificates"}%
