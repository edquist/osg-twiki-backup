%META:TOPICINFO{author="ForrestChristian" date="1167862338" format="1.1" version="1.8"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! OSG Accounting Services - Gratia

The Gratia accounting services consists of three services: 
   * the [[Accounting.ProbeInstallation][probe]], installed using rpms
   * gratia reporting (installed via [[http://gratia.fnal.gov/Files/gratia_reporting_v0.12.1.tar][gratia_reporting_v0.12.1.tar]]), which contains the server side report application and requires Birt ([[http://gratia.fnal.gov/Files/Birt.war][Birt.war]])
   * gratia services (installed via [[http://gratia.fnal.gov/Files/gratia_services_v0.12.1.tar][gratia_services_v0.12.1.tar]]), which contains the gratia services that collects information from the probes and writes the database, need to be distributed with gratia_reporting
   * See also the [[http://gratia.fnal.gov/Files/][Full listing of files]]

d16 4
---++ Requirements
   * !MySQL >= 5.0 (not tested with !MySQL >= 5.1.0);
   * JRE >= 5 (1.5) (not tested with JRE > 5);
   * Tomcat >= 5.5 (not tested with Tomcat >=6.0);
   * Port 8880 under Tomcat 5.5 must be defined as a non-ssl port. To implement this, modify =$VDT_LOCATION/tomcat/v55/conf/server.xml=:
   * !MySQL 5.x. Versions older than 0.11 are compatible with !MySQL 4.x.
   * JDK 1.5 is installed under VDT, and Tomcat 5.5 uses this version.
   * Tomcat 5.5 is installed under =$VDT_LOCATION/tomcat/v55=. 
   * =birt.war= (the runtime war file for the BIRT reporting tools) is deployed under =$VDT_LOCATION/tomcat/v55/webapps=
   *Port 8880 under Tomcat 5.5 must be defined as a non-ssl port. To implement this, modify =$VDT_LOCATION/tomcat/v55/conf/server.xml=:
<verbatim>
  <!--  Define a non-SSL HTTP/1.1 Connector on port 8880 -->
   <Connector port="8880" maxHttpHeaderSize="8892"
              maxThreads="150" minSpareThreads="25" maxSpareThreads="75"
              enableLookups="false" redirectPort="8443" acceptCount="100"
              connectionTimeout="20000" disableUploadTimeout="true" />
</verbatim>

   $ *%RED% NOTE %ENDCOLOR%*: To get both Tomcat 5.5 and JDK 1.5, run: =pacman -get !http://vdt.cs.wisc.edu/vdt_1311_cache:Tomcat-5.5=

The Apache configuration under the same VDT installation must include the following !JkMounts:

<verbatim>
     JkMount /gratia-servlets/* tomcat55
     <Location /gratia-servlets>
        SSLVerifyClient optional
     </Location>

     JkMount /gratia-security/* tomcat55
     <Location /gratia-security>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-soap/* tomcat55
     <Location /gratia-soap>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-services/* tomcat55
     <Location /gratia-services>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-administration/* tomcat55
     <Location /gratia-administration>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-report-configuration/* tomcat55
     <Location /gratia-report-configuration>
         SSLVerifyClient optional
     </Location>
     JkMount /gratia-reporting/* tomcat55
     <Location /gratia-reporting>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-reports/* tomcat55
     <Location /gratia-reports>
         SSLVerifyClient optional
     </Location>
</verbatim>

---++ Installing the Services
To begin installation of the services, unntar all tarballs and copy all *.war files from =./gratia/gratia_reporting= and =./gratia/gratia_services= under =./tomcat/v55/webapps=
   * gratia-administration.war
   * gratia-report-configuration.war
   * gratia-reporting.war
   * gratia-reports.war
   * gratia-security.war
   * gratia-services.war
   * gratia-servlets.war
   * gratia-soap.war

_If you are going to manually deploy the services under Tomcat,_ you must deploy =gratia-report-configuration.war= first, followed by =gratia_services.war=. After deploying both, you may deploy the other war files in any order. 

   $ %H% *%RED% NOTE %ENDCOLOR%*: If you have configured Tomcat to autodeploy the war files (not the default under VDT), it will deploy the services in the correct order.

Follow the instructions below for the customization of each package:

---+++ gratia_services_v0.11.tar
This requires !MySQL 5.0, Tomcat v55 and JDK 1.5.
<ol>
  <li> Untar the file under =$VDT_LOCATION= to populate =./tomcat/v55/gratia=: %BR% =tar xf gratia_services_v0.11.tar=</li>
  <li> Create the empty database schema ( =CREATE DATABASE `gratia`;= ) as well as two users: one that has full control and one that has only read access.</li>
  <li> Modify =./tomcat/v55/gratia/service-configuration.properties= to contain the correct database and user information you defined in the previous step, as well as the correct name for the Birt services:
  <verbatim>  service.mysql.driver=com.mysql.jdbc.Driver
  service.mysql.url=jdbc:mysql://DBHOSTNAME:DBPORT/gratia
  service.mysql.user=DBUSER
  service.mysql.password=DBPASSWORD

  service.birt.user=reader
  service.birt.password=reader

  service.birt.engine.home=BIRT-HOME</verbatim>
  </li>
  <li> Set permissions for =./gratia/var= and all subdirectories to allow everyone read, write and execute access.</li>
  <li> Deploy =./gratia/gratia_services/!GratiaService.war= under Tomcat. It uses the non-ssl port 8880.</li>
</ol>

---++++ Example =service-configuration.properties= file
<verbatim>
        service.mysql.url=jdbc:mysql://fermigrid1.fnal.gov:49154/gratia
        service.mysql.user=admin-user-name
        service.mysql.password=admin-user-password

        service.birt.user=reader-user-name
        service.birt.password=reader-user-password

        service.birt.engine.home=birt-viewer\
</verbatim>

---++++ Starting and Stopping Gratia Services
   
For this version of gratia-services, you must start and stop the service by starting tomcat
   * Start the service using Tomcat: %BR% =service tomcat-55 start= 
   * Wait for the gratia-service to start
   * Stop Tomcat:  %BR%   =service tomcat-55 stop=
   * Modify and execute =$VDT_LOCATION/tomcat/v55/gratia/gratia-db-post-install.sh= so that the summary tables and stored procedures are created. (Subsequent versions of the software should not require this step.) 

<verbatim>
  mysql -v --force -unbuffered --user=root --password=ROOTPASS  --host=localhost --port=PORT gratia < MAGIC_VDT_LOCATION/tomcat/v55/gratia/build-summary-tables.sql
  mysql -v --force -unbuffered --user=root --password=ROOTPASS  --host=localhost --port=PORT gratia < MAGIC_VDT_LOCATION/tomcat/v55/gratia/build-stored-procedures.sql
</verbatim>

---+++ gratia_reporting_v0.11.tar
   1. Deploy =birt.war= under Tomcat (required).
   1. Modify =<nop>$VDT_LOCATION/tomcat/v55/webapps/gratia-report-configuration/ReportingConfig.xml= :
      * Point the database to the correct one (see gratia_services installation),
      * Set =user= and =password= for the user with only only read access.
      * Set =MAGIC_VDT_LOCATION= to the full path of the VDT.

        The following are the lines that need to be modified:
<verbatim>
  <ReportingConfig>
  <DataSourceConfig
    url="jdbc:mysql://DBHOSTNAME:DBPORT/gratia"
    user="reader"
    password="reader"
   />
</verbatim>      

---++++ Example <nop>ReportingConfig.xml 
<verbatim>
  <PathConfig
    reportsFolder="MAGIC_VDT_LOCATION/tomcat/v55/webapps/gratia-reporting/"
    engineHome="MAGIC_VDT_LOCATION/tomcat/v55/webapps/Birt/"
    webappHome="MAGIC_VDT_LOCATION/tomcat/v55/webapps/gratia-reporting/"
  />
  </ReportingConfig>
</verbatim>
   $ *%RED% NOTE %ENDCOLOR%*: Ensure that <nop>engineHome points to the Birt top level directory, if different from above 

d165 1
%INCLUDE{ "Documentation.ToolsBottomMatter" }%
-- Main.ChrisGreen - 11 Oct 2006 %BR%
-- Main.ForrestChristian - 03 Jan 2007 (edits only for linking from ITB) %BR%

%META:TOPICMOVED{by="ChrisGreen" date="1175886836" from="Accounting.InstallationGuide" to="Accounting.InstallationGuideVDT"}%
