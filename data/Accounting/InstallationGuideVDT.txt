%META:TOPICINFO{author="ChrisGreen" date="1181855881" format="1.1" version="1.10"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! OSG Accounting Services - Gratia

<!-- Set release version in one place for use in the rest of the page.
   * Set ReleaseVersion = 0.24
-->

The Gratia accounting services consists of three services: 
   * The [[Accounting.ProbeInstallation][probes]];
   * Gratia reporting (installed via [[http://gratia.fnal.gov/Files/gratia_reporting_v%ReleaseVersion%.tar][gratia_reporting_v%ReleaseVersion%.tar]]), which contains the server side report application;
   * Gratia services (installed via [[http://gratia.fnal.gov/Files/gratia_services_v%ReleaseVersion%.tar][gratia_services_v0.%ReleaseVersion%.tar]]), which contains the gratia services that collect information from the probes and write to the database;
   * See also the [[http://gratia.fnal.gov/Files/][Full listing of files]]

---++ Requirements
   * !MySQL >= 5.0 (not tested with !MySQL >= 5.1.0);
   * JRE >= 5 (1.5) (not tested with JRE > 5);
   * Tomcat >= 5.5 (not tested with Tomcat >=6.0);
   * Port 8880 under Tomcat 5.5 must be defined as a non-ssl port. To implement this, modify =$VDT_LOCATION/tomcat/v55/conf/server.xml=:
<verbatim>
  <!--  Define a non-SSL HTTP/1.1 Connector on port 8880 -->
   <Connector port="8880" maxHttpHeaderSize="8892"
              maxThreads="150" minSpareThreads="25" maxSpareThreads="75"
              enableLookups="false" redirectPort="8443" acceptCount="100"
              connectionTimeout="20000" disableUploadTimeout="true" />
</verbatim>

The Apache configuration under the same VDT installation must include the following !JkMounts:

<verbatim>
     JkMount /gratia-servlets/* tomcat55
     <Location /gratia-servlets>
        SSLVerifyClient optional
     </Location>

     JkMount /gratia-security/* tomcat55
     <Location /gratia-security>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-soap/* tomcat55
     <Location /gratia-soap>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-services/* tomcat55
     <Location /gratia-services>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-administration/* tomcat55
     <Location /gratia-administration>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-report-configuration/* tomcat55
     <Location /gratia-report-configuration>
         SSLVerifyClient optional
     </Location>
     JkMount /gratia-reporting/* tomcat55
     <Location /gratia-reporting>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-reports/* tomcat55
     <Location /gratia-reports>
         SSLVerifyClient optional
     </Location>
</verbatim>

---++ Installing the Services
To begin installation of the services, unntar all tarballs and copy all *.war files from =./gratia/gratia_reporting= and =./gratia/gratia_services= under =./tomcat/v55/webapps=
   * gratia-administration.war
   * gratia-reporting.war
   * gratia-reports.war
   * gratia-security.war
   * gratia-services.war
   * gratia-servlets.war
   * gratia-soap.war
   * gratia-util.war

_If you are going to manually deploy the services under Tomcat,_ you must deploy =gratia_services.war=; then you may deploy the other war files in any order. 

   $ %H% *%RED% NOTE %ENDCOLOR%*: If you have configured Tomcat to auto-deploy the war files (not the default under VDT), it will deploy the services in the correct order.

Follow the instructions below for the customization of each package:

---+++ gratia_services_v%ReleaseVersion%.tar
This requires !MySQL 5.0, Tomcat v55 and JDK 1.5.
<ol>
  <li> Untar the file under =$VDT_LOCATION= to populate =./tomcat/v55/gratia=: %BR% =tar xf gratia_services_v0.11.tar= </li>
  <li> %RED% *If and only if* %ENDCOLOR% it does not already exist, create the empty database schema ( =CREATE DATABASE `gratia`;= ) as well as two users: one that has full control and one that has only read access.</li>
  <li> Modify =./tomcat/v55/gratia/service-configuration.properties= to contain the correct database and user information you defined in the previous step, as well as the correct name for the Birt services:
  <verbatim>  service.mysql.driver=com.mysql.jdbc.Driver
  service.mysql.url=jdbc:mysql://DBHOSTNAME:DBPORT/gratia
  service.mysql.user=DBUSER
  service.mysql.password=DBPASSWORD

  service.reporting.user=reader
  service.reporting.password=reader

  service.birt.engine.home=BIRT-HOME</verbatim>
  </li>
  <li> Set permissions for =./gratia/var= and all subdirectories to allow everyone read, write and execute access.</li>
  <li> Deploy =./gratia/gratia_services/!GratiaService.war= under Tomcat. It uses the non-ssl port 8880.</li>
</ol>

---++++ Example =service-configuration.properties= file
<verbatim>
        service.mysql.url=jdbc:mysql://fermigrid1.fnal.gov:49154/gratia
        service.mysql.user=admin-user-name
        service.mysql.password=admin-user-password

        service.birt.user=reader-user-name
        service.birt.password=reader-user-password

</verbatim>

---++++ Starting and Stopping Gratia Services
   
For this version of gratia-services, you must start and stop the service by starting tomcat
   * Start the service using Tomcat: %BR% =service tomcat-55 start= 
   * Wait for the gratia-service to start
   * Stop Tomcat:  %BR%   =service tomcat-55 stop=
   * Modify and execute =$VDT_LOCATION/tomcat/v55/gratia/gratia-db-post-install.sh= so that the summary tables and stored procedures are created.

<verbatim>
  mysql -v --force -unbuffered --user=root --password=ROOTPASS  --host=localhost --port=PORT gratia < MAGIC_VDT_LOCATION/tomcat/v55/gratia/build-summary-tables.sql
  mysql -v --force -unbuffered --user=root --password=ROOTPASS  --host=localhost --port=PORT gratia < MAGIC_VDT_LOCATION/tomcat/v55/gratia/build-stored-procedures.sql
</verbatim>

---+++ gratia_reporting_v0.11.tar
   1. Deploy =birt.war= under Tomcat (required).
   1. Modify =<nop>$VDT_LOCATION/tomcat/v55/webapps/gratia-report-configuration/ReportingConfig.xml= :
      * Point the database to the correct one (see gratia_services installation),
      * Set =user= and =password= for the user with only only read access.
      * Set =MAGIC_VDT_LOCATION= to the full path of the VDT.

        The following are the lines that need to be modified:
<verbatim>
  <ReportingConfig>
  <DataSourceConfig
    url="jdbc:mysql://DBHOSTNAME:DBPORT/gratia"
    user="reader"
    password="reader"
   />
</verbatim>      

---++++ Example <nop>ReportingConfig.xml 
<verbatim>
  <PathConfig
    reportsFolder="MAGIC_VDT_LOCATION/tomcat/v55/webapps/gratia-reporting/"
    engineHome="MAGIC_VDT_LOCATION/tomcat/v55/webapps/Birt/"
    webappHome="MAGIC_VDT_LOCATION/tomcat/v55/webapps/gratia-reporting/"
  />
  </ReportingConfig>
</verbatim>
   $ *%RED% NOTE %ENDCOLOR%*: Ensure that <nop>engineHome points to the Birt top level directory, if different from above 

%INCLUDE{ "Documentation.ToolsBottomMatter" }%

-- Main.PenelopeConstanta - 30 Aug 2006 %BR%
-- Main.ChrisGreen - 11 Oct 2006 %BR%
-- Main.ForrestChristian - 03 Jan 2007 (edits only for linking from ITB) %BR%

%META:TOPICMOVED{by="ChrisGreen" date="1175886836" from="Accounting.InstallationGuide" to="Accounting.InstallationGuideVDT"}%
