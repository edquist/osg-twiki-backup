%META:TOPICINFO{author="ChrisGreen" date="1160603629" format="1.1" version="1.3"}%
%META:TOPICPARENT{name="WebHome"}%
---++OSG Accounting Services - Gratia

There are three tarballs that are distributed for gratia. You can find them under the url
[[http://gratia.fnal.gov/Files][http://gratia.fnal.gov/Files]]

   * [[http://gratia.fnal.gov/Files/gratia_probe_v0.9.tar][gratia_probe_v0.9.tar]] - contains the condor probe, may be distributed alone
   * [[http://gratia.fnal.gov/Files/gratia_services_v0.9.tar][gratia_services_v0.9.tar]]  - contains the gratia services that collects information from the probes and writes the database, need to be distributed with gratia_reporting
   * [[http://gratia.fnal.gov/Files/gratia_reporting_v0.9.tar][gratia_reporting_v0.9.tar]] - contains the server side report application - requires Birt (a war file is available at the same area)
   * For your convinence you may download [[http://gratia.fnal.gov/Files/Birt.war][Birt.war]]
d16 4

If the gratia_services and gratia_reporting are to be installed on a site, we are assuming the following:

   *  jdk v1.5 is installed under VDT and Tomcat v55 uses this version of jdk

   *  Tomcat v55 is installed under $VDT_LOCATION/tomcat/v55 <br> (use: <verbatim>pacman -get http://vdt.cs.wisc.edu/vdt_1311_cache:Tomcat-5.5</verbatim>  to get both tomcat 5.5 and jdk 1.5)

   *  birt.war (the runtime war file for the BIRT reporting tools) is deployed under
       $VDT_LOCATION/tomcat/v55/webapps

   * Need  tomcat v55 port 8880 to be defined as a non-ssl port.
        Modify $VDT_LOCATION/tomcat/v55/conf/server.xml:
   * JDK 1.5 is installed under VDT, and Tomcat 5.5 uses this version.
   * Tomcat 5.5 is installed under =$VDT_LOCATION/tomcat/v55=. 
   * =birt.war= (the runtime war file for the BIRT reporting tools) is deployed under =$VDT_LOCATION/tomcat/v55/webapps=
   *Port 8880 under Tomcat 5.5 must be defined as a non-ssl port. To implement this, modify =$VDT_LOCATION/tomcat/v55/conf/server.xml=:
<verbatim>
  <!--  Define a non-SSL HTTP/1.1 Connector on port 8880 -->
   <Connector port="8880" maxHttpHeaderSize="8892"
              maxThreads="150" minSpareThreads="25" maxSpareThreads="75"
   * the Apache configuration under the same VDT installation needs to include the following !JkMounts:
              connectionTimeout="20000" disableUploadTimeout="true" />
   $ *%RED% NOTE %ENDCOLOR%*: To get both Tomcat 5.5 and JDK 1.5, run: =pacman -get !http://vdt.cs.wisc.edu/vdt_1311_cache:Tomcat-5.5=

The Apache configuration under the same VDT installation must include the following !JkMounts:

<verbatim>
     JkMount /gratia-servlets/* tomcat55
     <Location /gratia-servlets>
        SSLVerifyClient optional
     </Location>

     JkMount /gratia-security/* tomcat55
     <Location /gratia-security>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-soap/* tomcat55
     <Location /gratia-soap>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-services/* tomcat55
     <Location /gratia-services>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-administration/* tomcat55
     <Location /gratia-administration>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-report-configuration/* tomcat55
     <Location /gratia-report-configuration>
         SSLVerifyClient optional
     </Location>
     JkMount /gratia-reporting/* tomcat55
     <Location /gratia-reporting>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-reports/* tomcat55
     <Location /gratia-reports>
*Installation of the services:*
   * gratia-security.war
   * untar all tarballs.
   * gratia-servlets.war
   * copy all *.war files from the directories<br>
      ./gratia/gratia_reporting<br>
             and<br>
      ./gratia/gratia_services<br>
      under<br>
      ./tomcat/v55/webapps<br>
      The following are all the war files in gratia:<br>
         gratia-administration.war<br>
         gratia-report-configuration.war<br>
         gratia-reporting.war<br>
         gratia-security.war<br>
         gratia-reports.war<br>
         gratia-services.war<br>
         gratia-servlets.war<br>
         gratia-soap.war<br>

   * If you are going to manually deploy the services under Tomcat v55, then the gratia-report-configuration.war needs to be deployed first under tomcat and then gratia_services.war before the rest of the war files are deployed (there is no order for the rest). If tomcat is configured to autodeploy war files (not the default configuration under VDT), then the services are deployed correctely.
   * Follow the instructions below for the customization of each package:

   1. *gratia_probe_v0.9.tar* 
     <br>
      untar the file (tar xf gratia_probe_v0.9.tar) under $VDT_LOCATION.<br>
       The following file (./gratia/gratia_probes/ProbeConfigTemplate) needs: 
      a. ./gratia/gratia_probes/ProbeConfigTemplate --> copy to ./gratia/gratia_probes/ProbeConfig<br>
           and change the word "generic" in the line<br>
                         !MeterName="generic"<br>
             to contain the probe "type" and system name,<br>
             for example: condor:cd-psg3.fnal.gov<br>
          (Note: The quotes need to be maintain)<br>
           Also change the word "Generic Site" in the line<br>
                         !SiteName="Generic Site"<br>
          to contain the human readable description/name of the<br>
         cluster being accounted for.<br>
          (Note: The quotes need to be maintain)<br> 
      a. In the same copied file replace MAGIC_VDT_LOCATION with the full path of  the vdt location
      a. All the directories under and including var ./gratia/var need to allow read, write, execute access to every one.<br>
           <br>
        *Documentation note*.  If there is one more file named !ProbeConfig.something
         AND the proper code has been merged in the condor_probe.pl,
         the same record can be send to a second (or more) collectors. [Per Miron's request]
                   <br>
        *Note to the user:* The 'condor' specific portion of the probe is likely to have been superseded by their own work (aka the perl and
         shell scripts inside the probe) but they still should use the new Gratia.py. <br>
         For more information about the probe configuration please refer to the ProbeInstallation.
   1. *gratia_services_v0.9.tar*
      a. Requires tomcat v55 and jdk 1.5
      a. untar the file (tar xf gratia_services_v0.9.tar) under $VDT_LOCATION. 
      a. this will populate the directory<br>
            ./tomcat/v55/gratia
      a. The mysql empty database schema needs to be created (CREATE DATABASE `gratia`;)
        as well as two users: one that has full control and one that has only read access.
      a. the file
            ./tomcat/v55/gratia/service-configuration.properties
        needs to be modified to contain the correct database and user information as defined in the previous step:      
          <verbatim>
        service.mysql.driver=com.mysql.jdbc.Driver
        service.mysql.url=jdbc:mysql://DBHOSTNAME:DBPORT/gratia
        service.mysql.user=DBUSER
        service.mysql.password=DBPASSWORD
  <verbatim>  service.mysql.driver=com.mysql.jdbc.Driver
        service.birt.user=reader
        service.birt.password=reader
           </verbatim>
          for example:
          <verbatim>
</ol>

---++++ Example =service-configuration.properties= file
<verbatim>
        service.mysql.url=jdbc:mysql://fermigrid1.fnal.gov:49154/gratia
        service.mysql.user=admin-user-name
          </verbatim>
      a.  All the directories under and including var ./gratia/var need to allow read, write, execute access to every one.
      a.  Deploy the ./gratia/gratia_services/!GratiaService.war under tomcat v55.
         It uses the non-ssl port 8880 <br>
   3. *gratia_reporting_v0.9.tar*
       This package requires birt.war to be deployed under tomcat v55
       a. Once the package is deployed the following file needs to be modified:<br>
           $VDT_LOCATION/tomcat/v55/webapps/gratia-report-configuration/!ReportingConfig.xml<br>
          <br>
         The database needs to point to the correct one (see gratia_services installation),
         the user name and password of the one that has only read access
         and the MAGIC_VDT_LOCATION needs the full path of the vdt location.
            <br>
      * Point the database to the correct one (see gratia_services installation),
      <verbatim>
       <ReportingConfig>
       <DataSourceConfig
       url="jdbc:mysql://DBHOSTNAME:DBPORT/gratia"
       user="reader"
       password="reader"
      />
      <PathConfig
        reportsFolder="MAGIC_VDT_LOCATION/tomcat/v55/webapps/gratia-reporting/"
        engineHome="MAGIC_VDT_LOCATION/tomcat/v55/webapps/Birt/"
        webappHome="MAGIC_VDT_LOCATION/tomcat/v55/webapps/gratia-reporting/"
      />
      </ReportingConfig>
       </verbatim>
         *NOTE:* make sure that !engineHome point to the Birt top level directory, if different from above 
    user="reader"
-- Main.PenelopeConstanta - 30 Aug 2006
  />
-- Main.ChrisGreen - 11 Oct 2006
-- Main.ChrisGreen - 11 Oct 2006 %BR%
-- Main.ForrestChristian - 03 Jan 2007 (edits only for linking from ITB) %BR%

%META:TOPICMOVED{by="ChrisGreen" date="1175886836" from="Accounting.InstallationGuide" to="Accounting.InstallationGuideVDT"}%
