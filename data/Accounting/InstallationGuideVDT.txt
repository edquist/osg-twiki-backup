%META:TOPICINFO{author="ChrisGreen" date="1182268177" format="1.1" reprev="1.12" version="1.12"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! OSG Accounting Services - Gratia

<!-- Set release version in one place for use in the rest of the page.
   * Set ReleaseVersion = 0.24.2
-->

The Gratia accounting services consists of three services: 
   * The [[Accounting.ProbeInstallation][probes]]; please read the general preliminary notes in addition to those specific to each probe as some things have changed. In particular, note item 3 of the preliminary notes. The RPMs now use =/etc/cron.d= instead of root's crontab: The VDT packages may benefit from the same change; 
   * Gratia reporting (installed via [[http://gratia.fnal.gov/Files/gratia_reporting_v%ReleaseVersion%.tar][gratia_reporting_v%ReleaseVersion%.tar]]), which contains the server side report application;
   * Gratia services (installed via [[http://gratia.fnal.gov/Files/gratia_services_v%ReleaseVersion%.tar][gratia_services_v%ReleaseVersion%.tar]]), which contains the gratia services that collect information from the probes and write to the database;
   * See also the [[http://gratia.fnal.gov/Files/][Full listing of files]].

---++ Requirements
   * !MySQL >= 5.0 (not tested with !MySQL >= 5.1.0);
   * JRE >= 5 (1.5) (not tested with JRE > 5);
   * Tomcat >= 5.5 (not tested with Tomcat >=6.0);
   * Port 8880 under Tomcat 5.5 must be defined as a non-ssl port. To implement this, modify =$VDT_LOCATION/tomcat/v55/conf/server.xml=:
<verbatim>
  <!--  Define a non-SSL HTTP/1.1 Connector on port 8880 -->
   <Connector port="8880" maxHttpHeaderSize="8892"
              maxThreads="150" minSpareThreads="25" maxSpareThreads="75"
              enableLookups="false" redirectPort="8443" acceptCount="100"
              connectionTimeout="20000" disableUploadTimeout="true" />
</verbatim>

The Apache configuration under the same VDT installation must include the following !JkMounts:

<verbatim>
     JkMount /gratia-servlets/* tomcat55
     <Location /gratia-servlets>
        SSLVerifyClient optional
     </Location>

     JkMount /gratia-security/* tomcat55
     <Location /gratia-security>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-soap/* tomcat55
     <Location /gratia-soap>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-services/* tomcat55
     <Location /gratia-services>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-administration/* tomcat55
     <Location /gratia-administration>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-report-configuration/* tomcat55
     <Location /gratia-report-configuration>
         SSLVerifyClient optional
     </Location>
     JkMount /gratia-reporting/* tomcat55
     <Location /gratia-reporting>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-reports/* tomcat55
     <Location /gratia-reports>
         SSLVerifyClient optional
     </Location>
</verbatim>

---++ Installing the Services
To begin installation of the services, untar all tarballs and copy all *.war files from =./gratia/gratia_reporting= and =./gratia/gratia_services= under =./tomcat/v55/webapps=:
   * gratia-administration.war
   * gratia-reporting.war
   * gratia-reports.war
   * gratia-security.war
   * gratia-services.war
   * gratia-servlets.war
   * gratia-soap.war
   * gratia-util.war

_If you are going to manually deploy the services under Tomcat,_ you must deploy =gratia_services.war= firt; then you may deploy the other war files in any order. 

   $ %H% *%RED% NOTE %ENDCOLOR%*: If you have configured Tomcat to auto-deploy the war files (not the default under VDT), it will deploy the services in the correct order.

Follow the instructions below for the customization of each package:

---+++ gratia_services_v%ReleaseVersion%.tar
This requires !MySQL 5.0, Tomcat v55 and JDK 1.5.
<ol>
  <li> Untar the file under =$VDT_LOCATION= to populate =./tomcat/v55/gratia=: %BR% =tar xf gratia_services_v%ReleaseVersion%.tar= </li>
  <li> %RED% *If and only if* %ENDCOLOR% it does not already exist, create the empty database schema ( =CREATE DATABASE `gratia`;= ) as well as two users: one that has full control over the gratia schema from =localhost= and one that has only SELECT and EXECUTE privilege.</li>
  <li> Modify =./tomcat/v55/gratia/service-configuration.properties= to contain the correct database and user information you defined in the previous step, as well as the correct name for the Birt services:
  <verbatim>  service.mysql.driver=com.mysql.jdbc.Driver
  service.mysql.url=jdbc:mysql://DBHOSTNAME:DBPORT/gratia
  service.mysql.user=DBUSER
  service.mysql.password=DBPASSWORD

  service.reporting.user=reader
  service.reporting.password=reader

  service.birt.engine.home=BIRT-HOME</verbatim>
  </li>
  <li> Set permissions for =./gratia/var= and all subdirectories to allow everyone read, write and execute access.</li>
  <li> Deploy =./gratia/gratia_services/!GratiaService.war= under Tomcat. It uses the non-ssl port 8880.</li>
  <li> Modify the =$VDT_LOCATION/tomcat/v55/gratia/post-install.sh= making sure that it is mode =0700= and owned by the tomcat-executing user: the line requiring configuration reads:
<verbatim>
mysql -B --force -unbuffered --user=root --password=ROOTPASS  --host=localhost --port=PORT gratia < MAGIC_VDT_LOCATION/tomcat/v55/gratia/${proc}
</verbatim>
=ROOTPASS=, =PORT= and =MAGIC_VDT_LOCATION= must all be substituted correctly for the command to work.
</li>
</ol>

---++++ Example =service-configuration.properties= file
<verbatim>
        service.mysql.url=jdbc:mysql://fermigrid1.fnal.gov:49154/gratia
        service.mysql.user=admin-user-name
        service.mysql.password=admin-user-password

        service.birt.user=reader-user-name
        service.birt.password=reader-user-password

</verbatim>

---++++ Starting and Stopping Gratia Services
   
For this version of gratia-services, you must start and stop the service by starting tomcat
   * Start the service using Tomcat: %BR% =service tomcat-55 start= 
   * In contrast to previous versions, all schema updates are handled from within tomcat in the right order. However, =post-install.sh= *must* be configured properly to enable execution of those SQL fragments that require SUPER privilege (see above). 

*NOTE* Database updates may take place during the initial deployment of the collector which may take some time, especially if the schema contains a large amount of data.

---+++ gratia_reporting_v%ReleaseVersion%.tar
   1. Deploy all =.war= files under Tomcat.

%INCLUDE{ "Documentation.ToolsBottomMatter" }%

-- Main.PenelopeConstanta - 30 Aug 2006

-- Main.ChrisGreen - 11 Oct 2006

-- Main.ForrestChristian - 03 Jan 2007 (edits only for linking from ITB)

-- Main.ChrisGreen - 14 Jun 2007 - Update for major release 0.24

%META:TOPICMOVED{by="ChrisGreen" date="1175886836" from="Accounting.InstallationGuide" to="Accounting.InstallationGuideVDT"}%
