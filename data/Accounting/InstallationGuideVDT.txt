%META:TOPICINFO{author="JohnWeigand" date="1221773626" format="1.1" version="1.38"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! OSG Accounting Services - Gratia

<!-- Set release version in one place for use in the rest of the page.
   * Set ReleaseVersion = 0.38.3
   * Set VdtCache = http://vdt.cs.wisc.edu/vdt_1101_cache
-->

The Gratia accounting services consists of three services: 
   * The [[Accounting.ProbeInstallation][probes]]; please read the general preliminary notes in addition to those specific to each probe as some things have changed. In particular, note item 3 of the preliminary notes. The RPMs now use =/etc/cron.d= instead of root's crontab: The VDT packages may benefit from the same change; 
   * Gratia reporting (installed via [[http://gratia.fnal.gov/Files/gratia_reporting_v%ReleaseVersion%.tar][gratia_reporting_v%ReleaseVersion%.tar]]), which contains the server side report application;
   * Gratia services (installed via [[http://gratia.fnal.gov/Files/gratia_services_v%ReleaseVersion%.tar][gratia_services_v%ReleaseVersion%.tar]]), which contains the gratia services that collect information from the probes and write to the database;
   * See also the [[http://gratia.fnal.gov/Files/][Full listing of files]]. You might want to right-click these links and use a utility like wget to download the files on your Linux node where you'll be performing this installation.

---++ Requirements
   * !MySQL >= 5.0 (not tested with !MySQL >= 5.1.0; does *not* work with !MySQL 4.x);
   * JRE >= 5 (1.5) (not tested with JRE > 5);
   * Tomcat >= 5.5 (not tested with Tomcat >=6.0; does *not* work with Tomcat 5.0); to get it, (eg) <tt>pacman -get %VdtCache%:Tomcat-5.5</tt>
   * Port 8080 under Tomcat 5.5 must be defined as a non-ssl port. To implement this, modify =$VDT_LOCATION/tomcat/v55/conf/server.xml=:
<verbatim>
  <!--  Define a non-SSL HTTP/1.1 Connector on port 8880 -->
   <Connector port="8880" maxHttpHeaderSize="8892"
              maxThreads="150" minSpareThreads="25" maxSpareThreads="75"
              enableLookups="false" redirectPort="8443" acceptCount="100"
              connectionTimeout="20000" disableUploadTimeout="true" />
</verbatim>

The Apache configuration under the same VDT installation must include the following !JkMounts:

%RED% Paste the following in to VDT_LOCATION/apache/conf/httpd.conf %ENDCOLOR%

<verbatim>
     JkMount /gratia-servlets/* tomcat55
     <Location /gratia-servlets>
        SSLVerifyClient optional
     </Location>

     JkMount /gratia-soap/* tomcat55
     <Location /gratia-soap>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-services/* tomcat55
     <Location /gratia-services>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-administration/* tomcat55
     <Location /gratia-administration>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-reporting/* tomcat55
     <Location /gratia-reporting>
         SSLVerifyClient optional
     </Location>

     JkMount /gratia-reports/* tomcat55
     <Location /gratia-reports>
         SSLVerifyClient optional
     </Location>
</verbatim>

%BLUE%Deprecated services:
   * gratia-security with release v0.34
%ENDCOLOR%

---++ Installing the Services
To begin installation of the services, untar the two tarballs containing the gratia services and gratia reporting packages and copy all *.war files from =./gratia/gratia_reporting= and =./gratia/gratia_services= to =./tomcat/v55/webapps=:
   * gratia-administration.war
   * gratia-reporting.war
   * gratia-reports.war
   * gratia-services.war
   * gratia-servlets.war
   * gratia-soap.war
   * gratia-util.war

%BLUE%Deprecated services:
   * gratia-security with release v0.34
%ENDCOLOR%

_If you are going to manually deploy the services under Tomcat,_ you must deploy =gratia_services.war= first; then you may deploy the other war files in any order. 

   $ %H% *%RED% NOTE %ENDCOLOR%*: If you have configured Tomcat to auto-deploy the war files (not the default under VDT), it will deploy the services in the correct order.

Follow the instructions below for the customization of each package:

---+++ gratia_services_v%ReleaseVersion%.tar

This requires !MySQL 5.0, Tomcat v55 and JDK 1.5.

*%RED%NOTE%ENDCOLOR%*: With release v0.38, we rely on files being placed in tomcat/v55/common/lib, tomcat/v55/server/lib and tomcat/v55/common/classes. In addition, =log4j.properties= should be copied from tomcat/v55/gratia to tomcat/v55/common/classes (or merged if one already exists). Our recommendation has always been that Gratia services be the only thing installed in a given VDT area so contention for libraries between different services in the same tomcat container should not be an issue.

---++++ !MySql Notes
Effective with v0.32.1, Gratia is using the <op>MySql <nop>InnoDB transactional engine.  This requires some additional attributes in the <i>my.cnf</i>.  The list below shows the recommended _my.cnf_ attributes in  addition to the <nop>InnoDB attributes.  Of all the  <nop>InnoDB attributes, the most critical is the *innodb_file_per_table* attribute which allocates 1 tablespace per table and they are stored in the _database_ directory.  Without that attribute <nop>MySql stores ALL the <nop>InnoDB tables for ALL the databases in a single tablespace at the _var_ directory level.  This makes disk/space management impossible.  Once set up with a single tablespace, it is a very time consuming task to convert, especially for a large database.
<pre>
[mysqld]
datadir=VDT_LOCATION/vdt-app-data/mysql5/var
user=mysql
port=NNNNN
socket=VDT_LOCATION/vdt-app-data/mysql5/var/mysql.sock

key_buffer = 16M
max_allowed_packet = 1M
table_cache = 64
sort_buffer_size=512
net_buffer_length=8
read_buffer_size=256
read_rnd_buffer_size=512
myisam_sort_buffer_size = 8M

# Required for InnoDB
log-bin=mysql-bin
log_bin_trust_function_creators=1
innodb_buffer_pool_size = 16M
innodb_additional_mem_pool_size = 2M
# Set .._log_file_size to 25 % of buffer pool size
innodb_log_file_size = 5M
innodb_log_files_in_group = 2
innodb_log_buffer_size = 8M
<b><font color="blue">innodb_file_per_table</font></b>
innodb_flush_log_at_trx_commit = 1
innodb_lock_wait_timeout = 50
expire_logs_days = 7

[client]
port=49152
socket=VDT_LCOATION/vdt-app-data/mysql5/var/mysql.sock
</pre>

*Location of my.cnf file* %BR%
Another consideration that should be taken into account is the location of the _my.cnf_ file.  It has been stored in the 
_VDT_LOCATION/mysql5/var directory_ .  The _VDT_LOCATION/vdt-app-data/mysql5/var_ directory may be a more suitable location as any changes to the _my.cnf_ for a local environment, may want to be carried forward when upgrades are performed.

---++++ Installation Notes
<ol>
  <li> Untar the file under =$VDT_LOCATION= to populate =./tomcat/v55/gratia=: %BR% =tar xf gratia_services_v%ReleaseVersion%.tar= </li>
  <li> %RED% *If and only if* %ENDCOLOR% it does not already exist, create and configure the DB schema:
  <ol>
    <li>Create the empty database schema ( =CREATE DATABASE `gratia`;= )</li>
    <li>Create two users: one that has full control over the gratia schema from =localhost= and one that has only SELECT and EXECUTE privilege. We suggest using "gratia" and "reader" for the full-control and restricted users, respectively. We suggest using the =mysql-administrator= utility from the !MySQL-GUI-tools package available from the =mysql.com= website. You'll probably need to run it from the !MySQL server and connect to =localhost= as the DB user =root= to have the necessary privileges. First create the user, then add hosts. We recommend specifying IPs only (not DNS names). Use the tabs to find the schema privileges and use the selection mechanism to initiate the desired privileges for each user *for each host*. We recommend against having wild cards, especially for the root user. For the coomand-line =mysql= client, this would be something like:
<verbatim>
grant all on gratia.* to admin@localhost identified by 'pwd';
grant select,execute on gratia.* to reader@localhost identified by 'pwd';
</verbatim>
</li>
  </ol>
  </li>
  <li> Modify =./tomcat/v55/gratia/service-configuration.properties= to contain the correct database and user information you defined in the previous step, as well as the correct name for the Birt services:
 <verbatim>  service.rmi.rmibind=//HOSTNAME:17000
  service.rmi.rmilookup=rmi://HOSTNAME:17000
  service.mysql.driver=com.mysql.jdbc.Driver
  service.open.connection=http://HOSTNAME:8880
  service.secure.connection=https://HOSTNAME:8443
  service.mysql.url=jdbc:mysql://DBHOSTNAME:DBPORT/gratia
  service.mysql.user=DBUSER
  service.mysql.password=DBPASSWORD

  service.reporting.user=reader
  service.reporting.password=reader

  service.reporting.engine.home=BIRT-HOME</verbatim>

  For the current release, =BIRT-HOME= should be =birt-v20=.
  </li>
  <li> Modify the =$VDT_LOCATION/tomcat/v55/gratia/post-install.sh= making sure that it is mode =0700= and owned by the tomcat-executing user: the line requiring configuration reads:
<verbatim>
cat MAGIC_VDT_LOCATION/tomcat/v55/gratia/${proc} | mysql -B --force --unbuffered --user=root --password=ROOTPASS --host=localhost --port=PORT gratia
</verbatim>
=ROOTPASS=, =PORT= and =MAGIC_VDT_LOCATION= must all be substituted correctly for the command to work.
</li>
</ol>

---++++ Starting and Stopping Gratia Services
   
For this version of gratia-services, you must start and stop the service by starting tomcat
   * Start the service using Tomcat: %BR% =service tomcat-55 start= 
   * In contrast to previous versions, all schema updates are handled from within tomcat in the right order. However, =post-install.sh= *must* be configured properly to enable execution of those SQL fragments that require SUPER privilege (see above). 

*NOTE* Database updates may take place during the initial deployment of the collector which may take some time, especially if the schema contains a large amount of data.

---+++ gratia_reporting_v%ReleaseVersion%.tar
   1. Deploy all =.war= files under Tomcat.

%INCLUDE{ "Documentation.ToolsBottomMatter" }%
-- Main.JohnWeigand - 10 May 2008 - For v0.34 removed references to gratia-security web service.  Added InnoDB attributes for <nop>MySql

-- Main.ChrisGreen - 12 Sep 2007 - Update to 0.27.5 for VDT to fix calendar image problems and one report.

-- Main.ChrisGreen - 11 Sep 2007 - Update for major release 0.27.3 to VDT.

-- Main.ChrisGreen - 14 Jun 2007 - Update for major release 0.24

-- Main.ForrestChristian - 03 Jan 2007 (edits only for linking from ITB)

-- Main.ChrisGreen - 11 Oct 2006

-- Main.PenelopeConstanta - 30 Aug 2006

%META:TOPICMOVED{by="ChrisGreen" date="1175886836" from="Accounting.InstallationGuide" to="Accounting.InstallationGuideVDT"}%
