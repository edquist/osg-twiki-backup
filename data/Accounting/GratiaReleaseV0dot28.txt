%META:TOPICINFO{author="JohnWeigand" date="1193496548" format="1.1" reprev="1.15" version="1.15"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! Gratia Services V0.28 - 2007/10/27

%TOC%

%STARTINCLUDE%

---+ Release Notes
This release (v0.28) incorporates the following changes and updates ...
<dl>
<dt style="font-weight: bold; font-size: larger">Since VDT 1.8.1b release (v0.27.5)</dt>
<dd>
<ul>
  <li>Collector
  <ul>
    <li>Improvements for !MetricRecords.</li>
    <li>Upgrade hibernate to v3.2.5.</li>
  </ul></li>
  <li>Reporting
  <ul>
    <li>Upgrade to a new version of the report viewer: BIRT v2.0 -> v2.2.1
    <ul>
      <li>Link to allow reports to be bookmarked.</li>
      <li>PDF generation available.</li>
      <li>VO multi-select now available in one report ("Usage Metrics - For VO(s)").</li>
    </ul></li>
    <li>All drill through reports and should work now; and download =.csv= should be fixed everywhere.</li>
  </ul></li>
</ul>
</dd>
<dt style="font-weight: bold; font-size: larger">Between VDT 1.8.1b and the last version running on the production servers (v0.26.6)</dt>
<dd>
<ul>
  <li>Administration
  <ul>
    <li>Detailed view available for main status page.</li>
  </ul></li>
  <li>Collector
  <ul>
    <li>Support for probe handshaking.</li>
  </ul></li>
  <li>Reporting
  <ul>
    <li>Fix calendar pop-up.</li>
    <li>Fix "See Table" functionality for some reports.</li>
  </ul></li>
</ul>
</dd>
<dt style="font-weight: bold; font-size: larger">Between v0.26.6 and VDT 1.6.1 (v0.25)</dt>
<dd>
<ul>
  <li>Administration
  <ul>
    <li>Minor improvements to the: probe status; VO; and replication control pages.</li>
  </ul></li>
  <li>Collector
  <ul>
    <li>Fix history clean-up.</li>
    <li>Replication now more versatile.</li>
    <li>Update hibernate to v3.2.4sp1.</li>
    <li>VOName correction improved.</li>
  </ul></li>
  <li>Reporting
  <ul>
    <li>Introduce ranked reports.</li>
    <li>Generalized usage reports to enable selection of metric.</li>
    <li>Fix some drill-throughs.</li>
  </ul></li>
</ul>
</dd>
</dl>

Prior to starting the conversion, we need to verify that <nop>MySql is configured correctly for the 6Gb of available memory on the _gratia06_. <b>Note: This is not going to be done at this time.  See Post-Mortem notes.</b>

---+ Anticipated downtime
It is expected that this release will require the Gratia services and reporting to be unavailable during the periods specified below:
   * Start: 10/27/2007 (Saturday) 17:00 CDT.%BR%
   * Projected Availability: 10/28/2007 (Sunday) 10:00 CDT.

The changes affecting downtime  for this release are:
   1 Addition of a column in the <nop>JobUsageRecord_Meta table.
   1 The necessity of recreating all the summary tables due to the addition of the new table.

As a side note, it is anticipated that downtime for future releases will be minimal as a new procedure will be used when lengthy database conversion are necessary.  It cannot be down for this release as the necessary hardware is not yet in place.

---+ Collectors and Databases Affected

The following Gratia collectors and databases will be converted with this release:
%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}%
%EDITTABLE{  header="|*Schema*|*URL*|*Description*|" format="| text, 20 | text, 20 | text, 35 | text, 15 | text, 5 | text, 15 |"  changerows="on" quietsave="on" editbutton="Edit table" }%
|*Schema*|*<nop>MySql port*|*Collector URL*|*Collector host*|*Size (bytes)*|*Size (rows)*|
| fermi_itb | gratia06.fnal.gov:3320 | gratia-fermi.fnal.gov:8881 | gratia08.fnal.gov: |  724K |                  1 |
| fermi_osg | gratia06.fnal.gov:3320 | gratia-fermi.fnal.gov:8880 | gratia08.fnal.gov: |  4.3G |   2,237,912 |
| gratia | gratia06.fnal.gov:3320 | gratia.opensciencegrid.org:8880 | gratia09.fnal.gov |  81G | 26,476,198 |
| gratia_itb | gratia06.fnal.gov:3320 | gratia.opensciencegrid.org:8881 | gratia09.fnal.gov |  15G |   2,688,424 |
| gratia_osg_integration | gratia06.fnal.gov:3320 | gratia.opensciencegrid.org:8885 | gratia09.fnal.gov |  3.1G |       815,371 |
| gratia_qcd  | gratia06.fnal.gov:3320 | gratia-fermi.fnal.gov:8883 | gratia08.fnal.gov: |  2.2G |       804,418 |


The following Gratia collectors and databases will __NOT__  be converted with this release.  These repositories contained specialized reports that have not as yet been upgraded to the new Birt V2..2.1 software. __However__, they will be taken out-of-service while the other databases are being updated.
%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}%
%EDITTABLE{  header="|*Schema*|*URL*|*Description*|" format="| text, 20 | text, 20 | text, 35 | text, 15 | text, 5 |  text, 15 |"  changerows="on" quietsave="on" editbutton="Edit table" }%
|*Schema*|*<nop>MySql port*|*Collector URL*|*Collector host*|*Size (bytes)*|*Size (rows)*|
| gratia_psacct | gratia06.fnal.gov:3320 | gratia08.fnal.gov:8882 | gratia08.fnal.gov: |  6G |   3,790,511 |
| gratia_osg_daily | gratia06.fnal.gov:3320 | gratia.opensciencegrid.org:8884 | gratia09.fnal.gov |  60M |         53,929      |


---+ Conversion steps
This release involves a database schema change on the <nop>JobUsageRecord_Meta table, it is expected to take a significant amount of time on the production _gratia_ data base.  
In order to minimize the overload that is certain to occur if we were to stop the Gratia collectors from accepting data from the probes, the Gratia collectors will only be taken down for a short period while the database is being backed up.


<!-- ----------------- SHUTDOWN AND DATABASE BACUP ------------- -->
---++ Shutdown and database backup.
  <ol type="1">
    <li>On _gratia06_ , __comment__ out the _gratia_ user cron jobs.%BR%
            __Status - Done 10/27/2007 08:00__
   </li>

     <li>On _gratia06_, __comment__ out the _mysqlhotcopy_cron_ entry.
<pre class="screen">
43 2 * * * /usr/local/bin/mysqlhotcopy_cron.sh &gt; /var/log/mysqlhotcopy.out 2&gt; &1
</pre>%BR%
            __Status - Done 10/27/2007 08:00__ <p>
            __Note:__ _<nop>JobUsageRecord_XML_ table size is 53Gb.  On _gratia07_ , started an "_optimize table <nop>JobUsageRecord_Xml_" to determine how long it would take on _gratia06_.  %BR%
            Started -  08:17  Ended -

    </li>

     <li> For __ALL__ of the databases (__including those not be upgraded__) , __stop__ the Gratia update services.%BR%
            - In your browser,  connect to the Gratia administrative services url for each of the databases.%BR%
            - Select the _System / Administration_ menu option in the left menu%BR%
            - Then scroll down to the _Starting/Stopping Database Update Services_ section and select the _Stop Update Services_ link.
      </li>

     <li> On __each__ collector/tomcat host, __stop__ the tomcat service for __ALL__ Gratia collectors.<pre class="screen">On gratia09:
  service tomcat-gratia  stop
  service tomcat-itb  stop
  service tomcat-osg_daily  stop
  service tomcat-osg_integration stop

On gratia08:
  service tomcat-fermi_itb  stop
  service tomcat-fermi_osg stop
  service tomcat-fermi_ps  stop
  service tomcat-fermi_qcd stop</pre></li>
    <li>Compact the gratia schema Xml table.<pre>optimize table gratia.JobUsageRecord_Xml ;</pre>
    </li>
    <li>Back up the database instance on _gratia06_ (this will include all schemata) using the _msqlhotcopy_cron_ script.
           With the collector update services stopped on all database schemata, this will in affect be a complete backup.  
            This script copies the backup files that are backed up to <nop>_TiBS_ .
      <pre class="screen">&gt; /usr/local/bin/mysqlhotcopy_cron.sh > /var/log/mysqlhotcopy.out 2>&1</pre>
     </li>
    <li>As an added measure, take a standard tree copy of the _/data/mysqldb_ tree on _gratia06_  using the following script:    <pre class="screen">
&gt; <b>To be provided by Steve Timm</b></pre>
     </li>
    <li>Take a  backup of the _/data/tomcat-*/gratia/data_ directory as a _tar file_.<pre class="screen">&gt; <b>To be provided by John Weigand (if needed)</b></pre></li>
   </ol>


<!-- ----------------- UPGRADE AND IMPLEMENTATION ------------- -->
---++ Upgrade and implementation
The __upgrades should be single-threaded__ , that is, performed for each database schema on at a time.  
The reason for this is that they are sharing the same <nop>MySql instance and the schema upgrades will be resource intense.

We will perform these upgrades based on the size of the individual database schema, in ascending order.

<ol>
  <li>Build the software release%BR%
         __Status -  Completed on 10/26/07 at 19:22__ %BR%
         Directory - /home/weigand/cdcvs/gratia/target%BR%
         All files (war and tar), including the VDT tar files are in _/home/weigand/cdcvs/v0.28_ .
</li>

  <li>Install the new software on a Gratia tomcat instance using<pre class="screen"><b>/home/gratia/gratia/common/configuration/update-gratia-local -d xxx -S /home/gratia/gratia gratia</b>
</pre>
</li>

<li>Start the gratia tomcat services:<pre class="screen">&gt; service &lt;tomcat service&gt; start</pre>

When the tomcat service initializes, it will detect that schema changes have been effected and a conversion process will begin.
</li>

<li>When complete (=catalina.out= contains the message, "INFO: Server startup in _xxx_ms") __start__ the Gratia update services for the database schema just upgraded.%BR%
            - In your browser, connect to the Gratia administrative services url for each of the databases.%BR%
            - Select the _System / Administration_ menu option in the left menu%BR%
            - Then scroll down to the _Starting/Stopping Database Update Services_ section and select the _Start Update Services_ link.

   <ul>
     <li> As __each__ collector/tomcat host update service is started, monitor the tomcat logs files for any errors.</li>
     <li> Bring up the gratia administrative web interface and verify that the collectors are processing the data.</li>
    </ul>

<li>If satisifed, __stop__ the tomcat service for that tomcat database schema so you can proceed to the next one.<pre class="screen">&gt; service &lt;tomcat service&gt; stop</pre></li>
</ol>

<!-- ----------------- ACTIVATING THE NEW RELEASE ------------- -->
---+ Activating the new release
  <ol type="1">
     <li>On _gratia06_ , __uncomment__ out the _mysqlhotcopy_cron_ entry<pre class="screen">43 2 * * * /usr/local/bin/mysqlhotcopy_cron.sh > /var/log/mysqlhotcopy.out 2>&1</pre></li>
     <li> For __ALL__ of the databases ( __including those not be upgraded__ ), __verify__ the Gratia update services are active.%BR%
            - In your browser,  connect to the Gratia administrative services url for each of the databases.%BR%
            - Select the _System / Administration_ menu option in the left menu%BR%
            - Then scroll down to the _Starting/Stopping Database Update Services_ section and and view the status.
      </li>
     <li> On __each__ collector/tomcat host, __start__ the tomcat service for the Gratia collectors.<pre class="screen">On gratia09:
  service tomcat-gratia start
  service tomcat-itb start
  service tomcat-osg_daily start
  service tomcat-osg_integration start

On gratia08:
  service tomcat-fermi_itb  start
  service tomcat-fermi_osg start
  service tomcat-fermi_ps start
  service tomcat-fermi_qcd start</pre></li>

   <li> As __each__ collector/tomcat host service is started, monitor the tomcat logs files for any errors.</li>

   <li> Bring up the gratia administrative web interface and verify that the collectors are processing the data.</li>

    <li>On _gratia06_, __comment__ out the _gratia_ user cron jobs.</li>
</ol>

---+ Post-mortem
At this time, this will appear to be random notes.  After the conversion, they may be organized.

<ol>
<li>Configuring <nop>MySql to optimally use the 6Gb of memory on _gratia06_.
   <ul><li>Both _gratia06_ and _gratia07_ should be configured the same.</li>
            <li>Both nodes are using a UPS version of MySql which should probably be changed.%BR%
                    The _my.cnf_ on _gratia06_ is actually a symbolic link to the ups area.  </li>
             <li>The init.d services on both hosts should be explicitly setting the _my.cnf_ used so there is no confusion</li>
     </ul>       
</li>


<li>The administrative capability to start/stop the collector update services.%BR%
        One problem with trying to perform a smooth conversion (and also adds an element of risk) is the "feature" that activates the _update services_ on the restart  of _tomcat_ .   This activation occurs after _tomcat_ is started and any database conversions are performed.  It would be nicer is the service remembered it's previous state.  Then after a database conversion, you would be able to validate the database prior to any updates being applied.

</li>

</ol>

%STOPINCLUDE%

<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
---++!! Major updates
<!--Future editors should add their signatures beneath yours!-->
-- Main.JohnWeigand - 25 Oct 2007

%META:TOPICMOVED{by="JohnWeigand" date="1193405880" from="Accounting.GratiaRelease20071026" to="Accounting.GratiaReleaseV0dot28"}%
