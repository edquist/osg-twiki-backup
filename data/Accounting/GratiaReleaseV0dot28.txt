%META:TOPICINFO{author="JohnWeigand" date="1193353274" format="1.1" reprev="1.4" version="1.4"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! Gratia Services Release 2007/10/26

%TOC%

%STARTINCLUDE%

---+ Release Notes
This release (v0-28) incorporates the following changes and updates ...
<dl>
<dt>Since the last VDT release ()</dt>
<dd></dd>
<dt>Since the last version running on the production servers ()</dt>
<dd>
   1 Upgrade to a new version of the report viewer.
      * Upgrade from Birt V2.0 to V2.2.1
   1 Support for handshaking
</dd>
<dt>Since VDT 1.6.1 ()</dt>
<dd></dd>
</dl>

Prior to starting the conversion, we need to verify that <nop>MySql is configured correctly for the 6Gb of available memory on the _gratia-db01_.

---+ Anticipated downtime
It is expected that this release will require the Gratia services and reporting to be unavailable for approximately 10 hours.  

The upgrade will begin at 16:00 CDT on 10/26/2007 (Friday).

The changes affecting downtime  for this release are:
   1 Addition of a column in the <nop>JobUsageRecord_Meta table.
   1 The necessity of recreating all the summary tables due to the addition of the new table.

As a side note, it is anticipated that downtime for future releases will be minimal as a new procedure will be used when lengthy database conversion are necessary.  It cannot be down for this release as the necessary hardware is not yet in place.

---+ Collectors and Databases Affected

The following Gratia collectors and databases will be converted with this release:
%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}%
%EDITTABLE{  header="|*Schema*|*URL*|*Description*|" format="| text, 20 | text, 20 | text, 35 | text, 15 | textarea, 3x25 |"  changerows="on" quietsave="on" editbutton="Edit table" }%
|*Schema*|*<nop>MySql port*|*Collector URL*|*Collector host*|*Description*|
| fermi_itb | gratia-db01.fnal.gov:3320 | gratia08.fnal.gov: | gratia08.fnal.gov: |  |
| fermi_osg | gratia-db01.fnal.gov:3320 | gratia08.fnal.gov: | gratia08.fnal.gov: |  |
| gratia | gratia-db01.fnal.gov:3320 | gratia.opensciencegrid.org:8880 | gratia09.fnal.gov |  |
| gratia_itb | gratia-db01.fnal.gov:3320 | gratia.opensciencegrid.org:8881 | gratia09.fnal.gov |  |
| gratia_osg_integration | gratia-db01.fnal.gov:3320 | gratia.opensciencegrid.org:8885 | gratia09.fnal.gov |  |
| gratia_qcd  | gratia-db01.fnal.gov:3320 | gratia08.fnal.gov: | gratia08.fnal.gov: |  |


The following Gratia collectors and databases will __NOT__  be converted with this release.  These repositories contained specialized reports that have not as yet been upgraded to the new Birt V2..2.1 software. __However__ , they will be taken out-of-service while the other databases are being updated.
%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}%
%EDITTABLE{  header="|*Schema*|*URL*|*Description*|" format="| text, 20 | text, 20 | text, 35 | text, 15 | textarea, 3x25 |"  changerows="on" quietsave="on" editbutton="Edit table" }%
|*Schema*|*<nop>MySql port*|*Collector URL*|*Collector host*|*Description*|
| gratia_psacct | gratia-db01.fnal.gov:3320 | gratia08.fnal.gov: | gratia08.fnal.gov: |  |
| gratia_osg_daily | gratia-db01.fnal.gov:3320 | gratia.opensciencegrid.org:8884 | gratia09.fnal.gov |  |



---+ Conversion steps
This release involves a database schema change on the <nop>JobUsageRecord_Meta table, it is expected to take a significant amount of time on the production _gratia_ data base.  
In order to minimize the overload that is certain to occur if we were to stop the Gratia collectors from accepting data from the probes, the Gratia collectors will only be taken down for a short period while the database is being backed up.


---++ Shutdown and database backup.
  <ol type="1">
     <li>On _gratia-db01_ , __comment__ out the _mysqlhotcopy_cron_ entry
      <pre class="screen">
43 2 * * * /usr/local/bin/mysqlhotcopy_cron.sh > /var/log/mysqlhotcopy.out 2>&1 
      </pre>
     </li>

     <li> For __ALL__ of the databases ( __including those not be upgraded__ ) , __stop__ the Gratia update services.%BR%
            - In your browser,  connect to the Gratia administrative services url for each of the databases.%BR%
            - Select the _System / Administration_ menu option in the left menu%BR%
            - Then scroll down to the _Starting/Stopping Database Update Services_ section and select the _Stop Update Services_ link.
      </li>

     <li> On __each__ collector/tomcat host, __stop__ the tomcat service for __ALL__ Gratia collectors.
      <pre class="screen">
On gratia09:
  service tomcat-gratia  stop
  service tomcat-itb  stop
  service tomcat-osg_daily  stop
  service tomcat-osg_integration stop

On gratia08:
  service tomcat-fermi_itb  stop
  service tomcat-fermi_osg stop
  service tomcat-fermi_ps  stop
  service tomcat-fermi_qcd stop
      </pre>
      </li>

   
    <li>Back up the database instance on _gratia-db0_ (this will include all schemas) using the _msqlhotcopy_cron_ script.
           With the collector update services stopped on all database schemas, this will in affect be a complete backup.  
            This script copies the backup files that are backed up to <nop>_TiBS_ .
      <pre class="screen">
&gt; /usr/local/bin/mysqlhotcopy_cron.sh > /var/log/mysqlhotcopy.out 2>&1 
      </pre>
     </li>


    <li>As an added measure, take a standard tree copy of the _/data/mysqldb_ tree on _gratia-db01_  using the following script:    <pre class="screen">
&gt; <b>To be provided by Steve Timm</b>
</pre>
     </li>

    <li>Take a  backup of the _/data/tomcat-*/gratia/data_ directory as a _tar file_.
<pre class="screen">
&gt; <b>To be provided by John Weigand (if needed)</b>
</pre>
     </li>

   </ol>

---++ Upgrade and implementation
The __upgrades should be single-threaded__ , that is, performed for each database schema on at a time.  
The reason for this is that they are sharing the same <nop>MySql instance and the schema upgrades will be resource intense.

We will perform these upgrades based on the size of the individual database schema, in ascending order.

<OL>
  <LI>Install the new software on a Gratia tomcat instance using
<pre class="screen">
  <b>Steps to be defined</b>
</pre>
</LI>

<LI>Start the gratia tomcat services:
     <pre class="screen">
 &gt; service <tomcat service> start
     </pre>

When the tomcat service initializes, it will detect that schema changes have been effected and a conversion process will begin.
</LI>

<LI>When this completes <b>(HOW DO WE KNOW THIS</B>... from log files?%BR%
We need to then update the summary tables <b>WHICH I ALSO DO NOT KNOW HOW TO DO YET</b>



<LI>When complete __start__ the Gratia update services.%BR%
            - In your browser,  connect to the Gratia administrative services url for each of the databases.%BR%
            - Select the _System / Administration_ menu option in the left menu%BR%
            - Then scroll down to the _Starting/Stopping Database Update Services_ section and select the _Start Update Services_ link.

   <UL>
     <li> As __each__ collector/tomcat host update service is started, monitor the tomcat logs files for any errors.</li>
     <li> Bring up the gratia administrative web interface and verify that the collectors are processing the data.</li>
    </UL>
</LI>

</OL>




---+ Activating the new release
  <ol type="1">
     <li>On _gratia-db01_ , __uncomment__ out the _mysqlhotcopy_cron_ entry
      <pre class="screen">
43 2 * * * /usr/local/bin/mysqlhotcopy_cron.sh > /var/log/mysqlhotcopy.out 2>&1 
      </pre>
     </li>


     <li> For __ALL__ of the databases ( __including those not be upgraded__ ), __verify__ the Gratia update services are active.%BR%
            - In your browser,  connect to the Gratia administrative services url for each of the databases.%BR%
            - Select the _System / Administration_ menu option in the left menu%BR%
            - Then scroll down to the _Starting/Stopping Database Update Services_ section and and view the status.
      </li>


     <li> On __each__ collector/tomcat host, __start__ the tomcat service for __ALL__ Gratia collectors.
      <pre class="screen">
On gratia09:
  service tomcat-gratia start
  service tomcat-itb start
  service tomcat-osg_daily start
  service tomcat-osg_integration start

On gratia08:
  service tomcat-fermi_itb  start
  service tomcat-fermi_osg start
  service tomcat-fermi_ps start
  service tomcat-fermi_qcd start
      </pre>
      </li>

   <UL>
     <li> As __each__ collector/tomcat host service is started, monitor the tomcat logs files for any errors.</li>
     <li> Bring up the gratia administrative web interface and verify that the collectors are processing the data.</li>
    </UL>
</ol>

---+ Post-mortem

%STOPINCLUDE%

<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
---++!! Major updates
<!--Future editors should add their signatures beneath yours!-->
-- Main.JohnWeigand - 25 Oct 2007
