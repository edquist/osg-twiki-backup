%META:TOPICINFO{author="JohnWeigand" date="1221656959" format="1.1" reprev="1.11" version="1.11"}%
%META:TOPICPARENT{name="WebHome"}%
<!--
These are general in nature and should be changed in the this template if the location changes:
   * Set CURRENT_TOMCAT = ==gratia09==
   * Set CURRENT_MYSQL = __gratia06__
   * Set NEW_TOMCAT = ==gratia07==
   * Set NEW_MYSQL = __ gratia07__
   * Set TOMCAT_ALIAS = ==gratia.opensciencegrid.org==
   * Set MYSQL_ALIAS = ==gratia-db01.fnal.gov==
   * Set RELEASE_TAR_REPOSITORY = /afs/fnal.gov/files/expwww/gratia/html/Files

These are specific to a release and require changing:
   * Set RELEASE_DATE = 9/16/08
   * Set CURRENT_RELEASE = v0.38.1
   * Set RELEASE_TAG = v0-38-1
   * Set NEXT_DEVEL_VERSION = v0.39
   * Set BUILD_DIRECTORY = /home/weigand/cdcvs/gratia-%CURRENT_RELEASE%



-->
---+!! Gratia Release %CURRENT_RELEASE% (%RELEASE_DATE%)%BR% 


%TOC%

%STARTINCLUDE%
---+ Overview
The main purpose of this release (%CURRENT_RELEASE%) is a maintenance release.

---++ Main New Features:
   * Fully automated install and updates; major simplification of the procedures.
   * Support for Firefox 3.
   * Summary table for Transfer record.

---++ Reports
   * Provide report for VO's that use many sites on the distribution of usage across the sites

   * Clean ups of psacct reports.
   * Monthly report for emailing summarizing usage by Site for OSG VO users by DN (ready to be sent, waiting for email to sen to)
   * Weekly report of usage by user on each site.
   * Update the ownership and reporting grade reports to use the information from OIM; including properly detecting 'hidden site'.

   * [Out of scope but will ping Keith about it]: Monthly report summarizing the number of time each DN has done a voms-proxy-init (perhaps Keith C. can provide) (RR14)
  
   * Outstanding issues
      * Fix problem with timezone setting depending on the services load ordering which was leading to report date being off (and drill through report to be useless)
      * Updated reports to support birt 2.3.1 required by Firefox 3.

---++ Collector Improvement
   * Outstanding issues
      * Improve Condor probe to better handle log rotation of Condor history file 
 
   * Code Cleanups
      * Major simplification and rationalization of the log file output (use exclusively log4j)
            1. 30 logs of each type kept.
            1. Initialization of logger is now easy -- properties are read from Logging.java.
            1. straighten out the time-zone of the printed time
            1.  Change relative positions of custom (CONFIG, FINE, FINER, FINEST, etc) log levels with respect to standard log4j levels (INFO, DEBUG TRACE) to remove confusion.
      * Simplification and rationalization of Admin pages.
         * Replication Pages:
            1. Shows entries read-only, except the one you want to edit.
            1. Uses hibernate (also in Replication Data Pump)
            1. Sorts entries, "sensibly."
            1. Allows one to specify the bundle size.
      * Fix insert point focus issue in the Admin pages.
      * Fix updates of the Probe information in case the probe is sending only an handshake. This was leading to report as broken site with no job but properly configured
      * !HouseKeeping
         * Reduce size of bunche size to avoid out of memory errors.
         * Improve responsiveness to interrupt.
         * Improve performance of !RawXML deletion.
         * Delete record without !EndTime (based on the !ServerDate instead)
         * Fix cleanup of trace table (use for reporting)
      * Fix recording of !ApplicationExitCode in the summary table.
      * FIx handling of Condor job that terminated by a signal.
      * Fix replication for !MetricRecord
      * Fix duplicate record detection of !MetricRecord when replicated.
      * Fix recording of information about !MetricRecord duplicate
      * Enhance error handling in receiving replicated record with bad xml
      * Enhance error handling when loading configuration settings and at startup.
      * Fix problem in duplicate record detection for !ProbeDetails (handshake)

---++ Additional Features:
 .
<!--   -------------------------------------------- -->
---+ Anticipated downtime
It is expected that this release will require the Gratia services and reporting to be unavailable beginning at:
   * Start: %RELEASE_DATE%  hh:mm CST
   * Available: %RELEASE_DATE% hh:mm CST
The changes affecting downtime  for this release are:
   1 Length of time to make a backup of the database to the backup area using =mysqlhotcopy=
   1 Installation and validation on the 6 Gratia schemas




<!--   -------------------------------------------- -->
---+ Collectors and Databases Affected

The following Gratia collectors and databases will be converted with this release:
   1 gratia08
      * tomcat-fermi_transfer
      * tomcat-fermi_osg
      * tomcat-fermi_itb
      * tomcat-qcd
      * tomcat-ps
   1 gratia09
      * tomcat-osg_transfer
      * tomcat-osg_daily
      * tomcat-osg_integration
      * tomcat-itb
      * tomcat-gratia

<!-- BUILD DISTRIBUTION -------------------- -->
---+ Build the %CURRENT_RELEASE% for distribution
<ol>
<li>Make sure your build area contains all _committed_ changes.
<ul><li>cvs update</li></ul>
%GREEN%Done -v0.38 -  9/15/2008 12:15%ENDCOLOR% %BR%
%GREEN%Done - v0.38.1 - 9/15/2008 14:18%ENDCOLOR% %BR%
</li>

<li>After the initial release of v0.38, the following changes were made due to initial upgrade of the fermi_itb collector:
<pre>
gratia/common/configuration/create_build-stored-procedures-sql
Missed commit removing JobName from query

gratia/reporting/gratia-reports/WebContent/MenuConfig/UserConfig_osg.xml
inexplicably missed commit adding Site Usage by VO report

gratia/collector/gratia-services/net/sf/gratia/services/CollectorService.java

gratia/collector/gratia-services/net/sf/gratia/storage/DatabaseMaintenance.java
Put missing indexes on MetricRecord, MetricRecord_Meta and ProbeDetails_Meta.
</pre>
</li>

<li>In _gratia/build-scripts/Makefile_ , change the _version_default_ to:
<ul><li>version_default = %NEXT_DEVEL_VERSION%</li>
       <li>commit the change</li>
</ul>
%GREEN%Done - v0.38 - 9/15/2008 12:20%ENDCOLOR% %BR%
</li>

<li>Tag the release (for all committed changes). *Suggest waiting 5 minutes for this to get distributed across all nodes at source forge.*
<ul><li>cvs rtag -R %RELEASE_TAG% gratia</li></ul>
%GREEN%Done -v0.38 -  9/15/2008 12:25%ENDCOLOR% %BR%
%GREEN%Done - v0.38.1 - 9/15/2008 14:27 %ENDCOLOR% %BR%
</li>

<li> As *gratia* user, in */home/gratia/gratia-releases* , export the tagged release:
<ul>
   <li>cd /home/gratia/gratia-releases</li>
  <li>cvs export -d gratia-%CURRENT_RELEASE% -r %RELEASE_TAG% gratia </li>
</ul>
%GREEN%Done -v0.38 -  9/15/2008 12:35%ENDCOLOR% %BR%
%GREEN%Done - v0.38.1 - 9/15/2008 14:43%ENDCOLOR% %BR%
</li>

<li> As *gratia* user, build it for this release (this insures that tar files are produced for VDT):
<ul><li>cd gratia-%CURRENT_RELEASE%/build-scripts</li>
<li>source setup-jdk15.sh</li>
<li>make release</li></ul>
%GREEN%Done -v0.38 -  9/15/2008 12:38%ENDCOLOR% %BR%
%GREEN%Done - v0.38.1 - 9/15/2008 14:52%ENDCOLOR% %BR%
</li>

<li>As  *yourself* (assuming you have permissions), copy the built tar files to the release area:
<ul>
  <li>cd /home/gratia/gratia-releases/gratia-%CURRENT_RELEASE%/target </li>
  <li>scp gratia_reporting_%CURRENT_RELEASE%.tar flxi07.fnal.gov:%RELEASE_TAR_REPOSITORY% </li>
  <li>scp gratia_services_%CURRENT_RELEASE%.tar flxi07.fnal.gov:%RELEASE_TAR_REPOSITORY%</li>
</ul> 
%GREEN%Done - v0.38.1 - 9/17/2008 07:55%ENDCOLOR% %BR%
</li>

<li>Update the version number on the [[InstallationGuideVDT][services release TWiki page]]:</li>
<ul><li>Edit and update the TWiki variable _<nop>ReleaseVersion_.</li>
</ul>
%GREEN%Done - v0.38.1 - 9/17/2008 07:55%ENDCOLOR% %BR%
</li>

<li>As *yourself* , create a VDT support ticket via email so it gets prioritized with the VDT team. *Example* : 

<table width="451" height="77" border="0"> <tbody>
<tr><td>To: </td><td>vdt-support@opensciencegrid.org <br /> </td></tr>
<tr><td> Reply-to:</td><td>gratia-operation@fnal.gov</td></tr>
<tr><td> Subject</td><td>Gratia %CURRENT_RELEASE% available for inclusion in next VDT release</td></tr>
<tr><td valign="top"> Content:</td>
<td>
The Gratia %CURRENT_RELEASE% is available for inclusion in the next VDT release<br>
and can be obtained here:<br>
  - https://twiki.grid.iu.edu/bin/view/Accounting/InstallationGuideVDT
</td>
</tr>
</tbody> </table>
%GREEN%Done - v0.38.1 - ???????%ENDCOLOR% %BR%
</li>

</ol>
 

<!-- ----------------- DATABASE BACKUP ------------- -->
---+ Database backups and cron/init.d services
 *The upgrade should not performed until all database backups have been completed.*

If it is expected that the upgrade will take a long time, then
   1 on the tomcat/collector nodes (gratia08/gratia09) 
      * the static report crons should be commented 
      * disable the _init.d_ services 
   1 on the database node (gratia06) 
      * the backup crons should be commented out. 
      * daily reports cron should be commented out 
      * the Gratia-APEL interface crons should be commented out 

---++ On the tomcat/collector nodes (gratia08/gratia09)
   1 __comment__ out the __root__ user cron entry for the static reports. Example: 
 <pre>42 0 * * * '/data/tomcat-fermi_itb/gratia/staticReports.py' '/data/tomcat-fermi_itb' 'http://gratia-fermi.fnal.gov:8881/gratia-reporting/'  </pre> 
   1 Disable _init.d_ services as __root__ user: 
      * chkconfig tomcat-[GRATIA_INSTANCE] off 

---++ On the !MySql server node ( %CURRENT_MYSQL% )
   1 __comment__ out the cron entries for: <p> __gratia__ user cron jobs. </p>
 <pre>0 0 1-15 * * dir=/home/gratia/interfaces/apel-lcg; cd $dir; ./lcg.sh --config=lcg.conf --date=previous --update  30 01 * * * dir=/home/gratia/interfaces/apel-lcg; cd $dir; ./lcg.sh --config=lcg.conf --date=current --update  </pre> 
   1 __root__ user cron entry. 
 <pre>43 2 * * * names supplied when required </pre>

<!-- ----------------- UPGRADE AND IMPLEMENTATION ------------- -->
---+ Upgrade and implementation
 The __upgrades should be single-threaded__ , that is, performed for each database schema one at a time.

We will perform these upgrades based on the size of the individual database schema, in ascending order.

Tomcat/collector nodes and instances:
   1 gratia08
      * tomcat-fermi_transfer
      * tomcat-fermi_osg
      * tomcat-fermi_itb
      * tomcat-qcd
      * tomcat-ps
   1 gratia09
      * tomcat-osg_transfer
      * tomcat-osg_daily
      * tomcat-osg_integration
      * tomcat-itb
      * tomcat-gratia


---++ On the tomcat/collector nodes
To install the new software on a Gratia tomcat instance, run the following script: 
   * /home/gratia/gratia-releases/gratia-%CURRENT_RELEASE%/build-scripts/gratia-upgrade.sh 

This script will perform the following:
   * Shuts down the tomcat instance 
   * runs the update-gratia-local script to update the software 
   * backs up the tomcat/gratia logs and places in the /data directory as tarballs 
   * deletes all logs from the /data/tomcat-[GRATIA_INSTANCE]/logs directory so you have a fresh view when the re-start the service 
   * optionally allows you to start the Gratia/tomcat instance. 

When you have restarted the service, go to the /data/tomcat-[GRATIA_INSTANCE]/logs directory and tail the logs looking for any bizarre errors. Definition of bizarre will be supplied later.

Run the static reports cron as _root_ and verify these reports are generated. At the end of the gratia-update.sh execution, the root cron for the static reports for that instance will be displayed. Run them as root. Then in the UI, view the reports to verify they look correct.



<!-- ----------------- POST MORTEM  ------------- -->
---+ Post-mortem
At this time, this will appear to be random notes.  After the conversion, they may be organized.

<ol>

</ol>


%STOPINCLUDE%

<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
---++!! Major updates
<!--Future editors should add their signatures beneath yours!-->
