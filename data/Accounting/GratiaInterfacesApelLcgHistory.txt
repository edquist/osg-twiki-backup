%META:TOPICINFO{author="JamesWeichel" date="1326840093" format="1.1" version="1.3"}%
%META:TOPICPARENT{name="GratiaInterfacesApelLcg"}%
---+!! Gratia Interfaces - APEL/WLCG - History


%TOC%

%STARTINCLUDE%

---+ Description
This page provides a history of the changes made to the Gratia-APEL interface.

---+ History of changes
<blockquote><pre>
 6/19/07 (John Weigand)
#   Instead of using 1 normalization factor for all sites, the
#   lcg-reportableSites now contains a normalization factor for
#   those sites that have reported on the OSG survey.  Based on that
#   survey, using a Specint2000 specification, individual normalization
#   factors have been assigned to reflect the type of hardware those
#   site's WN clusters are using.  This factor is the 2nd token in that
#   lcg-reportableSites file.  If no token is present, the normalization
#   factor used is derived from the probe specified in the lcg.conf file.
#   This changed required that individual queries of the gratia database
#   be performed on a site basis since the application of the normalization
#   factor is applied there.  The query sent to the log file represents the
#   first one used in order to reduce the verbage there.  The site and
#   normalization factor used is displayed there.
#   - Another item to note is that coincident with this change the
#     BNL_ATLAS_1 and BNL_ATLAS_2 sites are now being reported as BNL_OSG
#     at that administrators request.  This was a database change to the
#     relation of the Site and Probe tables via siteid.
#
# 9/12/07 (John Weigand)
#   Fixed a problem when an empty set is returned from the query.
#
# 2/19/08 (John Weigand)
#   Due to the length of time it was taking to collect data on the
#   'Unknown' VOs, added an extra set of methods to determine the
#   'Unknown' VOs for all sites and only process those.  This reduces
#   the duration significantly.
#
# 4/15/08 (John Weigand)
#   Added methods for creating an xml and html file from the APEL database.
#   And reorganized some of the main section.
#
# 6/3/08 (John Weigand)
#   In the past when a site had no data, no update was made to the APEL
#   table.  Now we will create an update record showing it was processed.
#   We will create the update records for each VO.
#
# 6/25/08 (John Weigand)
#   Removed the calculation (just commented in case it has to be
#   re-instated) of a default normalization factor using the
#   NormalizationProbe attribute.  The NormalizationDefault attribute
#   is used soley for sites not having a normalization factor which
#   as of now, there are none and hopefully in the future this will
#   remain true.
#
# 9/25/08 (John Weigand)
#   1. Added methods to copy the xml/html files that are extracted from
#   the APEL database tables to the Gratia collector for this
#   database.  The lcg.conf file has a new attribute called
#   GratiaCollector defining (in scp format) the directory to copy
#   this files to.
#   2. Also added method(s) to trap 'warning' type messages that do
#   not affect the actual update of the APEL data, but may represent
#   conditions that should be investigated.  This was put in to trap
#   any errors that may occur on the copy to the Gratia collector,
#   but can be used to detect site not reporting for a period or
#   other conditions.
#
# 11/11/08 (John Weigand)
#   Added an additional filter on the selection criterea. Only
#   selecting ResourceType='Batch'.  Changes to the condor probes
#   (v1.00.3) will result in distinguishing between the actual
#   grid jobs (Batch) and the grid monitoring job (Documentation/Release3.GridMonitor) when
#   jobs are submitted using condor_submit. Any 'local' job used to
#   submit a job on the CE node will be filtered, but should they
#   at some point be passed to Gratia, these will be identified as
#   Local.
#
# 03/11/2009 (John Weigand)
#   1. Added a setting of the umask to 002 for all files being written.
#   This was to, hopefully, insure the setting of the right permissions
#   on the files sent to the tomcat ./webapps/gratia-data/interfaces/apel-lcg
#   directory for viewing data in the Gratia reporting service.
#   2. Also commented out (so it can be re-activated easily) the checking
#   for 'unknown' VOs with atlas or cms-like unix accounts.  This slow down
#   the interface considerably and that problem appears to have gone away.
#
#
# 3/12/2009 (John Weigand)
#   Added a method (DetermineReportableSitesFileToUse) that will retain
#   the lcg-reportableSites file in a 'history' directory and use that
#   during the process.  It copies the main configuration file to this
#   directory on when running in the 'current' month thereby preserving
#   prior months configuration in the event we have make updates there.
#   Refer to the comments in that method for more details.
#   This required an additional attribute in the lcg.conf file
#   (SiteFilterHistory) to define the directory these are retained in.
#   This allows us to change the SiteFilterFile at anytime during the
#   current month without fear of mis-stating the previous months updates
#   which currently are performed for the 1st 15 days of the current month.
#   This is not perfect since, in order to really retain this data, the
#   previous month should be added/updated in SVN/CVS.  A warning notification
#   will be sent the first time a new history file as a reminder.
#
# 5/19/2009 (John Weigand)
#   Added functionality to retrieve summary data by CommonName and populate
#   a new APEL table called OSG_CN_DATA.  The WLCG requirement is to use full
#   DN but Gratia currently only summarizes by the CN portion of the user proxy.
#   This is an interim solution until Gratia is modified to summarize by DN.
#   The changes for this new functionality are:
#   - lcg-db.conf: added an LcgUserTable attribute to identify the new table
#   - method GetQuery: Changed to optionally add in CommonName to the query.
#     I chose to make it a python variable in this query so as not to replicate
#     the rest of the query and take a chance on having it in 2 places to modify.
#     This is a bit of a gimmick but one I think is best.  The DBflag argument,
#     if True will allow CommonName to be included in the query and summary.
#   - added methods GetVoQuery and GetUserQuery
#     These were added to allow for more intuitive reading of the main
#     section of the program.  Both call GetQuery, one using the original
#     Site/VO grouping and the other using Site/User/VO grouping.
#   - method RetrieveVoData
#     Changed to call GetVoQuery instead of GetQuery
#   - added method RetrieveUserData
#     This is clone of RetrieveVoData except it calls GetUserQuery and does not
#     check for empty results at this time.
#   - added methods ProcessVoData and ProcessUserData
#     This pulled a section of code from the main section in order to keep the
#     main section more readable.
#   - added methods CreateLCGsqlVoUpdates and CreateLCGsqlUserUpdates
#     Both call CreateLCGsqlUpdates abstracting the table name to that level.
#   - method CreateLCGsqlUpdates
#   Added tableName as an argument.
#   - method RunLCGUpdate
#     Used for both VO and User summaries.  Added logging to identify the
#     file being used and the number of insert DML statements being processed.
#   IMPORTANT NOTE: Changes were NOT made to look for 'unknown' VOs at the User
#   level.  The 'unknown' VO check was left in (allowing it to be activated via
#   a command line argument) back on 3/11 in the event it needed to be
#   re-activated.  Since it uncertain if this will be needed again and the code
#   changes much more complex and maybe no longer needed, I chose NOT to make
#   changes to the code for this at this time.
#
# 6/1/2009 (John Weigand)
#    In the CreateXmlHtmlFiles method, changed the Path selection criteria
#    for the org_Tier2 table:
#     - USA Path changed from 1.31 to 1.32
#     - for SPRACE (which was inadvertantly omitted since April 2008), they
#       are not included under USA, but under Brazil which is 1.4.
#
# 6/26/2009 (John Weigand)
#    Added method (CheckForUnreportedDays) to check to see if a site
#    has more than 2 days unreported during the month and send a warning
#    email so it can be investigated.  This provides a little better handle
#    on sites that are having problems.  Not perfect, but better.
#    Added new parameter to lcg.conf (MissingDataDays) to set the threshold.
#
#    Also added a method (SetDatesWhereClause) to insure consistency in
#    the where clause for the time period across all the queries.
#
# 7/7/2009 (John Weigand)
#    Added new method (CheckForShutdownDays) called by CheckForUnreportedDays
#    that will use a new class (Downtimes) to check MyOSG for days in
#    which there are planned shutdowns for a site.  This will eliminate
#    sending a warning email for sites that have unreported days for this
#    reason.  It should be noted that if the url/criteria used in the
#    Downtime class to query MyOSG changes, this class will not be able
#    to detect it as different xml and may not detect planned shutdowns
#    accurately.
#
# 7/29/2009 (John Weigand)
#    Added method FindTierPath to find the correct org_Tier1/2 entries for
#    the OSG data.  It was using a query based on Path but this has been
#    changing to much.  Now using the Name which appears pretty stable.
#
# 8/28/2009 (John Weigand)
#    Changed the syntax on the lcg.conf attributes for the email
#    notifications so that multiple 'To' addresses can be specified.
#
# 11/04/09 (Chris Green).
#   Inclusion of CommonName from summary table was changed to:
#     IF(DistinguishedName NOT IN ("", "Unknown"),DistinguishedName,CommonName)
#   to take advantage of new information. November 2009 is the first month for
#   which any item with a CommonName also has a DistinguishedName (except in
#   the case where CommonName is "Generic XXX user", in which case
#   DistinguishedName is blank).
#
# 12/14/09 (John Weigand)
#   Added use of a new class (InactiveResources) to query MyOsg for Resource
#   that have been marked inactive.  This is used in conjunction with the
#   Downtimes class when checking why a site/resource has no data for a
#   day.  Unfortunately, there is no MyOSG query that will give downtimes and
#   active/inactive status.
#
#  2/1/10 (John Weigand)
#   Uncommented a logging of the INSERT dml to the log file.
#   The commenting of this entry (done in revision 3654 on 11/2/2009)
#   inadvertantly #  affected the checking for late updates performed by the
#   find-late--updates.sh script.
#   I had forgotten that script was parsing the log file to make this
#   determination.  I added a comment to that affect when I uncommented the line
#   so I don't do this again.  I am not sure if it is worth creating another
#   method of detecting this type of condition at this time.
#
#  3/3/10 (John Weigand)
#   In the etQueryForDaysReported method, which checks to see if a resource
#   has missed any days of reporting,  I removed the check for just cms and
#   atlas VOs.  Some sites are only used as a backup or for overflow from the
#   main site.  This eliminates falsely reoprting problems.
#
#  4/8/10 (John Weigand)
#   Modified the  CreateXmlHtmlFiles method to output an extract of the
#   OSG_DATA table with 3 additional calculated columns in order to
#   see what the HepSpec2006 value, that is now used in WLCG reporting,
#   would be:
#      HS06_CPU    HS06_WCT    HS06Factor
#   Since HepSpec2006 is not available across all sites, WLCG does a simple
#   multiplication by 4 on the SI2K normalization factor we use. At some
#   my guess is we will start using the HS06 value but,until then, this
#   is the only means of being able to compare easily.
#
#  8/5/11 (John Weigand)
#  ---------------------
#  This represents a major change to the interface.  All OSG reporting to
#  WLCG has been in reference to MyOsg resource group.  However, the MyOsg
#  InteropAccounting flag for WLCG Information is at the resource,
#  not resource group, level.  The changes made in this revision will now
#   1. treat the lcg-reportableSites config file entries as resource groups
#      This also means the Normalization Factors should be calculated
#      at the resource group level.
#   2. determine which resources within that resource group should have
#      their gratia data reported to APEL/WLCG.
#   3. summarize (using sql) the accounting data for the month for all
#      interfaced resources for the resource group.
#  A new class, InteropAccounting(.py), provides the access to MyOsg.
#
#  Due to a disconnect between Gratia site and MyOsg resource group/resource
#  that has existed from the beginning of time, some previously identifiable
#  "non-reporting" conditions may not get detected.  If all "resources"
#  reported to Gratia with the resource name, this would resolve that
#  problem.  However, many resources report to Gratia with the
#  resource group name.  Due to this, any "non-reporting" conditions
#  are ignored unless the entire "resource group" shows as not reporting.
#
#  Added a couple more validations for the WARNING email:
#   1. site we are reporting that do not have the MyOsg InteropAccounting set
#   2. sites we are not reporting that do have the MyOsg InteropAccounting set
#   3. Resource groups we are reporting that are not defined in Rebus
#   4. Resource groups that have and Accounting Name different from Rebus
#
#  Another word of warning.  Since this is now assuming Gratia sites
#  are equivalent to MyOsg resource groups and not resources, any updates
#  needed to re-populate will be a problem since MyOsg is not time
#  sensitive.  Resource may be added or dropped from MyOsg at any point
#  in time.  It only reflects the current state.  So re-populating may
#  result in the wrong data being used.
#
#  Additional cleanup to simplify the change to SSM/ActiveMQ for the interface
#   1. Eliminated all code associated with updating the OSG_DATA table.
#      The OSG_CN_TABLE is the one soley used by APEL.
#   2. Eliminated all code associated with find "unknown" VOs for Atlas
#      which was a problem with Atlas rerorting that has since been resolved.
#   3. Eliminated all code assoicated with using a default Normalization
#      Factor.  All resource groups/sites must have one

</pre></blockquote>

---+ Original interface (up until Aug 2011)
The original interface to APEL was an update to the an OSG_DATA table defined below.  This was a summary by site and vo.   In May 2009, APEL requested that a new table OSG_CN_DATA should be populated.   This table required the summary to be by site,vo and user DN.  Unbeknown to us sometime between then and Aug 2011, the OSG_DATA was no longer used to populated the EGI portal and the OSG_CN_DATA table was being used exclusively.   This is intended to retain the data about the interface and summary query used of the OSG_DATA table.

The table below shows the mapping of Gratia data to the APEL database's _OSG_DATA_ table and to the EGI OSG view.  It's purpose is to aid in understanding the data where different names are used for the data shown.
 
%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}%
|  *EGI Accounting Portal%BR%OSG view*  |  *APEL%BR%OSG_DATA*  |  *Gratia data (all data is from the <nop>VOProbeSummary table unless otherwise noted)*  |
| resource group%BR%(Gratia site) | <nop>ExecutingSite | <nop>Site.SiteName |
| VO | <nop>LCGUserVO | <nop>VOName |
| Number of jobs |<nop>Njobs | Sum of <nop>NJobs |
| Sum CPU | <nop>SumCPU | Sum of (<nop>CpuUserDuration + <nop>CpuSystemDuration) / 3600 |
| Norm Sum CPU | <nop>NormSumCPU | (Sum of (<nop>CpuUserDuration + <nop>CpuSystemDuration) / 3600) * Normalization Factor |
| Sum Elapsed | <nop>SumWCT | Sum of <nop>WallDuration / 3600  |
| Norm Sum Elapsed | <nop>NormSumWCT | (Sum of <nop>WallDuration / 3600) * Normalization Factor |
| | <nop>Month | The month the data is collected for |
| | <nop>Year | The year the data is collected for |
| | <nop>RecordStart | Earliest date reported for the month |
| | <nop>RecordEnd | Latest data reported for the month |
| | <nop>NormFactor | Normalization Factor used |
| | <nop>MeasurementDate | Date of update into APEL |

The SQL query below on the Gratia database is an example using the following criteria:
   * <nop>SiteName: UTA_SWT2
   * Normalization Factor: 1.543
   * Month: November 2008
<blockquote><pre>
SELECT Site.SiteName AS ExecutingSite,
    VOName as LCGUserVO,
   Sum(NJobs),
   Round(Sum(CpuUserDuration+CpuSystemDuration)/3600) as SumCPU,
   Round((Sum(CpuUserDuration+CpuSystemDuration)/3600)*1.543) as NormSumCPU,
   Round(Sum(WallDuration)/3600) as SumWCT,
   Round((Sum(WallDuration)/3600)*1.543) as NormSumWCT,
   date_format(min(EndTime),"%m")       as Month,
   date_format(min(EndTime),"%Y")       as Year,
   date_format(min(EndTime),"%Y-%m-%d") as RecordStart,
   date_format(max(EndTime),"%Y-%m-%d") as RecordEnd,
   "1.543",
   NOW()
from
     Site,
     Probe,
     VOProbeSummary Main
where
      Site.SiteName = "UTA_SWT2"
  and Site.siteid = Probe.siteid
  and Probe.ProbeName  = Main.ProbeName
  and Main.ResourceType = 'Batch'
  and Main.VOName in ( "usatlas","atlas","uscms","cms" )
  and Main.EndTime &gt;= "2008-11-01 00:00:00"
  and Main.EndTime &lt; "2008-12-01 00:00:00"
group by ExecutingSite,
         LCGUserVO
</pre></blockquote>


-- Main.JohnWeigand - 08 Aug 2011