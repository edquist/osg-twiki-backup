%META:TOPICINFO{author="JohnWeigand" date="1218729737" format="1.1" reprev="1.17" version="1.17"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! Gratia Development and Test Environment

<!--
   * Set VIEWTHISTOPIC = <div class="twikiSmall"><a href="%TOPIC%">View this section</a></div>
--> 
%TOC% 
%STARTINCLUDE%

---++ Description

The document attempts to describe the development and test environment for the Gratia accounting services.

---++ Software

In order to insure consistency in the development environment across multiple real/xen nodes, the software packages that are required by Gratia have been stored in the __gratia__ user's $HOME directory which is shared file file system.

*/home/gratia:*
   * mysql-rpms - !MySql client rpm only 
   * tomcat-tarballs - Tomcat tarballs 
   * jre-rpms - run time only These should be used for all new development and test installations. 
---++ Daily Builds

On a daily basis ( __gratia02__ cron), a script is run to bring down the HEAD node of the Gratia cvs source forge repository and perform a __'__ _make release_ __'__.

This allows developers to always have the latest Gratia build available for installation on their test instance.

Additionally, these daily builds will be used to perform daily upgrades of the Gratia instances described in the [[#Daily_installs_and_upgrades][Daily installs and upgrades]] section of this document.

In cvs, the script resides in __./gratia/build-scripts/nightly-build.sh__ .

*Cron entry:*
<verbatim>
   05 0 * * * /home/gratia/cron-scripts/nightly-build.sh 
                --mail gratia-operation@fnal.gov
</verbatim>

*Usage: nightly-build.sh [--dir directory] [--mail addresses] [--files n] [--help]* 
<verbatim>
This script will perform an export of the HEAD of the Gratia CVS repository
and then perform a 'make release' on the software.  

NOTE: Since it is an export, you will not be able to effect any 
      commits in this area.

It will create a directory called gratia-builds in your $HOME 
area unless overridden using the --dir argument. If the directory does not
exist, it will create it. 

Parent source directory.. /home/gratia/gratia-builds/gratia-2008-08-14
Log file................. /home/gratia/gratia-builds/gratia-2008-08-14.log

CVS: cvs -z3 -d:pserver:anonymous@gratia.cvs.sourceforge.net:/cvsroot/gratia.

Arguments:
   --dir   - the parent directory for the gratia-builds directory
   --mail  - email address(es) to be used on completion of the build.
   --files - number of build directories to retain in /home/gratia/gratia-builds
             Since the source directory and log files are timestamped by day,
             this argument allows you to specify the number (not days) of 
             builds to retain.  This is a housekeeping thing. 
             It is not perfect either.  If you have too many successive days
             with failures, the symlink to the last good build will be
             invalid.
             Default: 7

Cron entry note: do not redirect stdout/stderr to /dev/null or you may be 
                 oblivious to any uncaught errors.

If you run this more than once per day, the parent source directory will be
overwritten each time.  However the log file will be appended to.

On success, it will create a symbolic link to the newly built gratia source 
directory called:
  /home/gratia/gratia-builds/gratia-latest

An email notification upon completion will be sent to: 
  gratia-operation@fnal.gov
</verbatim>


---++ Daily installs and upgrades
The 3 ITB instances are being upgraded daily via a *root* cron entry from the [[#Daily_Builds][daily builds]] described in the previous section.

This allows developers to test committed changes on a regular basis.

The ITB environment is described here: [[GratiaItbTestEnvironment][Gratia ITB Test Environment]].

The daily upgrade is performed using the *gratia-upgrade.sh* via *root* cron entries on the ITB node as shown below.

Refer to the [[GratiaUpgradeScript][Gratia upgrade script (gratia-upgrade.sh)]] documentation for details on location of log files.  An email notification is sent upon completion (successful or failed).
<verbatim>
###################################################################
#----------------------------------
# Daily upgrade of ITB: tomcat-itb_gratia_itb   port:8880
#
05 4 * * * instance=tomcat-itb_gratia_itb;
   /home/gratia/gratia-builds/gratia-latest/build-scripts/gratia-upgrade.sh 
    --instance $instance 
    --source /home/gratia/gratia-builds/gratia-latest 
    --pswd xx 
    --daily gratia-operation@fnal.gov 
    --mysql /home/gratia/.itb-mysql-gratia02 
    --force-log4j
#
#----------------------------------
# Daily upgrade of ITB: tomcat-itb_gratia_psacct   port:8881
#
15 4 * * * instance=tomcat-itb_gratia_psacct; 
   /home/gratia/gratia-builds/gratia-latest/build-scripts/gratia-upgrade.sh
   (same arguments as previous entry)
#
#---------------------------------
# Daily upgrade of ITB: tomcat-itb_gratia_osg_daily  port:8882
#
25 4 * * * instance=tomcat-itb_gratia_osg_daily; 
   /home/gratia/gratia-builds/gratia-latest/build-scripts/gratia-upgrade.sh
    (same arguments as previous entry)
###################################################################

</verbatim>



%INCLUDE{GratiaUpgradeScript}%


---++ General Development
%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}% 
%EDITTABLE{  header="|*Real Node*|*Xen Node*|*Type*|*Version*|*Purpose*|" format="| text, 15 | text, 15 | textarea, 3x50 | textarea, 4x100 |"  changerows="on" quietsave="on" editbutton="Edit table" }% 
| *Real Node* | *Xen Node* | *Type / Version* | *Other* |
| gratia01 | gratiax11 | | |
| | gratiax12 | | Main.JohnUrish |
| | gratiax13 | This is ready to go at any time but is not normally on. contact fermigrid grp. if necessary. | |
| | gratiax14 | This is ready to go at any time but is not normally on. contact fermigrid grp. if necessary. | |
| | gratiax15 | This is ready to go at any time but is not normally on. contact fermigrid grp. if necessary. | |

---++ Reports and Services (Collectors)
%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}% 
%EDITTABLE{  header="|*Real Node*|*Xen Node*|*Type*|*Version*|*Purpose*|" format="| text, 15 | text, 15 | textarea, 3x50 | textarea, 4x100 |"  changerows="on" quietsave="on" editbutton="Edit table" }% 
| *Real Node* | *Xen Node* | *Type / Version* | *Other* |
| gratia02 | gratiax21 | Test node for Penelope. | Main.PenelopeConstanta |
| | gratiax22 | OSG CE node - see [[GratiaDevAndTestEnviron#Test_Site_Grid][Test Site Grid section]] | Main.JohnWeigand |
| | gratiax23 | Gratia Collector - see [[GratiaDevAndTestEnviron#Test_Site_Grid][Test Site Grid section]] | Main.JohnWeigand |
| | gratiax24 | Not implemented yet | |
| | gratiax25 | Not implemented yet | |

---++ Test Site Grid
 In order to provide a predictable and controlled test environment, a =test= grid site has been established. It will contain all the necessary components of an OSG grid site: 
   * The VOMS service ( =gratiax34=) has been populated with several VOs identified here: https://gratiax34.fnal.gov:8443/vomses %BR%If you are a member of the Gratia development team, you should have administrative privileges to view any data. 

   * The GUMS service ( =gratiax35=) uses the OSG =gums.config= template at this time. So it contains all OSG VOs and memberships as defined by the OSG GOC. At some point, it will be changed to use a =gums.config= file using the =gratiax34= VOMS service. 

   * several Compute Elements (CE) nodes running the various job batch queue managers (condor and pbs at this time). The authorization modes for these CE's can be established to use all three of the OSG modes: grid3, compatibility and full privilege. All will derive their membership lists for authorizations from the Gratia VOMS and GUMS servers mentioned above. For a more complete description of the OSG authorization modes, refer to the [[ReleaseDocumentation.ComputeElementAuthorization][OSG CE Authorization document]]. 

   * at least one Worker Node (WN) with glExec. 

%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}% 
%EDITTABLE{  header="|*Real Node*|*Xen Node*|*Type*|*Version*|*Purpose*|" format="| text, 15 | text, 15 | textarea, 3x50 | textarea, 4x100 |"  changerows="on" quietsave="on" editbutton="Edit table" }%
| *Real Node* | *Xen Node* | *Type / Version* | *Other* |
| gratia03 | gratiax31 | CE OSG 0.8.0 - VDT 1.8.1k %BR%- Condor/Condor-G 6.8.8%BR%- Gratia Condor Probe 0.27.5c-1%BR%- Gratia Metric Probe 0.27.5c-1%BR% | Condor probe reporting to gratiax33%BR% Authorization mode: PRIMA using GUMS services on gratiax35 |
| | gratiax32 | CE OSG 0.6.0 - VDT 1.6.1m %BR%- Condor/Condor-G 6.8.3%BR%- Gratia Condor Probe 0.25 | Condor probe reporting to gratiax33 %BR% Authorization mode: PRIMA using GUMS services on gratiax35 %BR% Intent is for this to use a PBS probe. |
| | gratiax33 | VDT 1.10.1d%BR% - Gratia Reporting 0.34.6%BR% - Gratia Services 0.34.6%BR% Upgraded to v0.37 (nightly)%BR% Replicating to gratiax23:8880 | Access: %BR% * http://gratiax33.fnal.gov:8880/gratia-administration%BR% * http://gratiax33.fnal.gov:8880/gratia-reporting %BR% %BR% This is updated nightly (4 am) from the daily build in:%BR% * /home/gratia/gratia-builds/gratia-latest |
| | gratiax34 | VOMS / OSG 0.8.0 - VDT 1.8.1j <br />VOMS 1.7.20.1 <br />VOMS Admin 1.2.19-3-0%BR% - client 1.2.16-1%BR% - interface 1.0.5-1%BR% - server 1.2.19-3 | VOs: https://gratiax34.fnal.gov:8443/vomses |
| | gratiax35 | GUMS / OSG-0.8.0 - VDT 1.8.1h %BR% GUMS 1.2.15 | Access: https://gratiax35.fnal.gov:8443/gums %BR% Currently populated with the full OSG =gums.config= template. |
| gratia02 | gratiax22 | CE OSG 1.0 / VDT 1.10.1e%BR% - reporting to gratiax33 collector %BR% - Condor/Condor-G 7.0.2%BR% - Gratia Condor Probe 0.34.9-1%BR% - Gratia Metric Probe 0.34.9-1 | Condor probe reporting to gratiax33 %BR% Authorization mode: PRIMA using GUMS services on gratiax35 |
| | gratiax23 | VDT 1.10.99d%BR% - Gratia Reporting 0.34.9%BR% - Gratia Services 0.34.9%BR% Upgraded to v0.36 | Access: %BR% * http://gratiax23.fnal.gov:8880/gratia-administration%BR% * http://gratiax23.fnal.gov:8880/gratia-reporting |

%P% 
%INCLUDE{GratiaVomsTestdata}%

%INCLUDE{GratiaItbTestEnvironment}%

---++ Databases
%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}% 
%EDITTABLE{  header="|*Real Node*|*Xen Node*|*Type*|*Version*|*Purpose*|" format="| text, 15 | text, 15 | textarea, 3x50 | textarea, 4x100 |"  changerows="on" quietsave="on" editbutton="Edit table" }% 
| *Real Node* | *Xen Node* | *Type / Version* | *Other* |
| gratia05 | gratiax51 / gratia-vm02 | Has big disk for mysql testing | |
| | gratiax52 | has big disk for mysql testing | |
| | gratiax53 | Won't be implemented,<br />not enough disk space on gratia05 | |
| | gratiax54 | Won't be implemented,<br />not enough disk space on<br />gratia05 | |
| | gratiax55 | Won't be implemented<br />not enough disk space on gratia05 | |

%STOPINCLUDE% <!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !--> *Major updates*:%BR% <!--Future editors should add their signatures beneath yours!--> -- Main.JohnWeigand - 29 Jun 2007%BR%

%META:TOPICMOVED{by="JohnWeigand" date="1183128317" from="Accounting.DevAndTestEnviron" to="Accounting.GratiaDevAndTestEnviron"}%
