%META:TOPICINFO{author="JohnWeigand" date="1219242315" format="1.1" reprev="1.22" version="1.22"}%
%META:TOPICPARENT{name="WebHome"}%
<!--
   * Set VIEWTHISTOPIC = <div class="twikiSmall"><a href="%TOPIC%">View this section</a></div>
--> 

---+ FNAL-specific Gratia collector installation guide

%TOC%

---++ Obtain and install the Java Runtime v1.5 (=5.0)

Install the Java Runtime 5.0 from [[http://java.sun.com/javase/downloads/index_jdk5.jsp][Sun's site]] (scroll down past the SDK links) if it does not already exist on the machines in question; it will usually be in =/data=, or the top level of wherever tomcat instances may exist.
---++ Obtain and install the !MySql client v5.0.n

If not already available on the node, install the !MySql client v5.0.n. The !MySql client rpm can be found in */home/gratia/mysql-rpms*.

The !MySql client has a dependency on Perl-DBI which if not installed already, can be installed using:
   * yum install Perl-DBI 

---++ Install Tomcat
 You will need to install tomcat in your collectors HOME area, e.g. /data/tomcat-psacct_itb, where 'psacct_db' is your !MySql database name. 
   * The latest version of tomcat can be found in */home/gratia/tomcat-tarballs*. 
   * If a newer verson of tomcat is desired, you can obtain latest version from [[http://tomcat.apache.org/download-55.cgi][Tomcat in the 5.5 stream]] (core package only: =apache-tomcat-[VERSION].tar.gz=). 

Expand into the desired area:
   * cd [TOP_LEVEL_DIR] 
   * mkdir tomcat-[YOUR_DB_NAME] 
   * tar zxvf /home/gratia/tomcat-tarballs/apache-tomcat-<VERSION].tar.gz -C tomcat-[YOUR_DB_NAME] --strip-path 1 

*Do not* configure tomcat at this time: there is a script to do this automatically -- see below.

---++ Installing CA certificates for administrative login
 If the host you are installing your collector on does *not* have a host/http certificate and the VDT CA Certificates package installed, you will have do so before you proceed.

---+++ Host/http Certificates
 To obtain a host/http certificate, contact your UNIX administrator.

The host certificates should be installed in */etc/grid-security* as:
<verbatim>
-rw-r--r--  1 root root 1477 May 19 10:08 hostcert.pem
-rw-------  1 root root 1675 May 19 10:09 hostkey.pem
</verbatim>

The http certificate should be installed in */etc/grid-security* as:
<verbatim>
drwxr-xr-x  2 root root 4096 May 19 09:34 http
   -rw-r--r--  1 root root 1485 May 19 09:34 httpcert.pem
   -rw-------  1 root root 1675 May 19 09:34 httpkey.pem
</verbatim>

---+++ VDT CA Certificates package
 If you do not have *pacman* installed, you can install it in */usr/local*: 
   * cd /usr/local 
   * mkdir pacman 
   * cd pacman 
   * wget http://physics.bu.edu/pacman/sample_cache/tarballs/pacman-latest.tar.gz 
   * tar zxf pacman-latest.tar.gz 

To install the VDT CA Certificates package, you will need to go to the VDT site.
   * For information on how VDT installations work with pacman, refer to http://vdt.cs.wisc.edu/download.html 
   * The latest VDT packages can be found here: http://vdt.cs.wisc.edu/documentation.html 
   * The CA Certificates package for the 1.10.1 release is: http://vdt.cs.wisc.edu/vdt_1101_cache/CA-Certificates.pacman 

To install the CA-Certificates package:
   * cd /usr/local/pacman/pacman-[VERSION} 
   * source setup.sh 
   * cd /usr/local 
   * mkdir vdt-certificates-{VERSION] 
   * cd vdt-certificates-{VERSION] 
   * pacman -get http://vdt.cs.wisc.edu/vdt_1101_cache:CA-Certificates . 

Answer "y" to all the questions.

When asked where to install the certificates, it is your choice. Most common place is /etc/grid-security. If you choose another location, you will need to update the specified locations of the host and HTTP certificates and keys; and of the CA certificates and CRLs in the collector configuration (.dat) file.

After all of the above has been done, you will need to turn on the VDT installed services (crons) necessary to maintain the certificates.
   * cd /usr/local/vdt-certificates-{VERSION] 
   * source setup.sh 
   * vdt-control --on 

---++ Ensure the existence of a suitable DB schema.

Create a new empty DB if necessary with appropriate access permissions for gratia (all) and reader (SELECT and EXECUTE).

These are the !MySql commands (as !MySql root user) using _gratia_mydb_ with tomcat on _gratia-vm02.fnal.gov_ as the example:
   * CREATE DATABASE [MY_DATABASE]; 
   * GRANT ALL PRIVILEGES ON [MY_DATABASE].* TO 'gratia'@'%.fnal.gov' IDENTIFIED BY 'update_password'; 
   * GRANT SELECT,EXECUTE ON [MY_DATABASE].* TO 'reader'@'%' IDENTIFIED BY 'reader_password'; 

You will also need to allow root access from the collector node (this is for the post-install.sh script executed by the collector):
   * GRANT ALL PRIVILEGES ON *<nop>**.* TO 'root'@'[COLLECTOR_NODE]' IDENTIFIED BY 'root_password';
   * GRANT GRANT OPTION ON *<nop>**.* TO 'root'@'[COLLECTOR_NODE]' IDENTIFIED BY 'root_password';
   * FLUSH PRIVILEGES;

---++ Obtain and configure a cut of the Gratia collector packages.
 Ask a developer for a sanctioned release number or a pointer to a sanctioned release area containing =.war= files and the =gratia.tar= file.

If all you have is the release number or the developer wishes you to use the HEAD of the repository:

Check out the sanctioned release:
   1 Initialize if necessary: 
      * cvs -d:pserver:anonymous@gratia.cvs.sourceforge.net:/cvsroot/gratia login 
   1 Get the sanctioned version: 
      * cvs -z3 -d:pserver:anonymous@gratia.cvs.sourceforge.net:/cvsroot/gratia export -d gratia- -r <em>&lt;release-no&gt;</em> gratia
   1 or the latest version: 
      * cvs -z3 -d:pserver:anonymous@gratia.cvs.sourceforge.net:/cvsroot/gratia export -d gratia-HEAD gratia 

Build the release:
   1 Ensure you have and are using ( =JAVA_HOME=, =PATH=) JDK1.5 (see above). 
   1 cd gratia-[RELEASE]/build-scripts 
   1 make 

---++ Configure your collector.
 The [PATH-TO-GRATIA-RELEASE]/common/configuration/configure-collector script is used to install/upgrade and configure necessary software and configuration files for the Gratia collectors at FNAL.

There are 3 data files in [PATH-TO-GRATIA-RELEASE]/common/configuration/ that are used by the =configure-collector= script:
   * *collector-pro.dat* - for configuring the *production* gratia collectors at FNAL 
   * *collector-itb.dat* - for configuring the *itb* gratia collectors at FNAL 
   * *collector-dev.dat* - for configuring *development* gratia collectors at FNAL 

Edit the appropriate data file if it does not already contain the correct information for the collector you wish to install. Refer to =%default_attributes= and existing or commented attributes in [PATH-TO-GRATIA-RELEASE]/common/configuration/service-configuration.properties for possible attributes. Be especially careful not to use ports already in use.

The =.dat= file is 'eval'ed by perl and should constitute a properly constructed perl associative array ('hash'). Note that in order to preserve local changes to the configuration you must take a copy of =collector-pro.dat=, modify and save it off somewhere, then *either*

   1. merge your local data file into the version in [PATH-TO-GRATIA-RELEASE]/common/configuration/ before executing =update-gratia-local= as detailed below; *or*
   1. merge new attributes from [PATH-TO-GRATIA-RELEASE]/common/configuration/ to your local copy and then execute =update-gratia-local= mostly as detailed below but adding, '-i <path-local-dat-file>' to the arguments.

Example configuration:
<verbatim>  
 itb_gratia_psacct =>
 { http_port => 8881,
   ssl_port => 8846,
   rmi_port => 18000,
   jmx_port => 8014,
   server_port => 8114,
   db_schema => "itb_gratia_psacct",
   db_host => "gratia07.fnal.gov",
   db_port => "3322",
   remote_host => "gratia02.fnal.gov",
   collector_host => "gratia02.fnal.gov",
   UserConfig => "UserConfig_pacct.xml",
   "properties.attributes" =>
   {
    "gratia.database.useJobUsageSiteName" => 1,
    "gratia.database.wantNodeSummary" => 1,
    "monitor.to.address.0" => 'gratia-operation@fnal.gov',
    "service.admin.DN.0" => 'ALLOW ALL'
   }
 },
</verbatim>

%INCLUDE{GratiaUpgradeScript}%

---++ Optionally scrub or save the collector logs

   1 cd /data/tomcat-itb_gratia_psacct/logs 
   1 rm -f *.log *.lck; _OR_ 
   1 logdir="../logs.`date +%Y<nop>%m%d`"; mkdir -p "$logdir" && mv -f * "$logdir" 

---++ Start the collector
 /etc/rc.d/init.d/tomcat-itb_gratia_psacct start

---++ OPTIONAL: install redirex

Redirex is an optional part of the installation procedure to allow for simple redirection of queries to port 80 on the collector machine to the accounting !TWiki if Apache is not running.

To install it on a machine, copy [PATH-TO-GRATIA-RELEASE]/redirex to (eg) =/data/redirex= and install =redirex.init= as =/etc/init.d/redirex=, altering =REDIREX_DIR= as appropriate. Run your usual command (eg =chkconfig=) to set the script up to run in the various runlevels and optionally start the service manually. 

-- Main.ChrisGreen - 20 Jun 2007
