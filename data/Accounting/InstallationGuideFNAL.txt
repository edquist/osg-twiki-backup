%META:TOPICINFO{author="ChrisGreen" date="1193320743" format="1.1" reprev="1.9" version="1.9"}%
%META:TOPICPARENT{name="WebHome"}%
---+ FNAL-specific Gratia collector installation guide

%TOC%

---++ Obtain and install the Java Runtime v1.5 (=5.0)

Install the Java Runtime 5.0 from [[http://java.sun.com/javase/downloads/index_jdk5.jsp][Sun's site]] (scroll down past the SDK links) if it does not already exist on the machines in question; it will usually be in =/data=, or the top level of wherever tomcat instances may exist.

---++ Obtain and install Tomcat
<ol>
  <li>Obtain the latest version of [[http://tomcat.apache.org/download-55.cgi][Tomcat in the 5.5 stream]] (core package only: =apache-tomcat-&lt;version&gt;.tar.gz=).</li>
  <li>Expand into the desired area:
    <pre class="code">cd &lt;dest-path&gt;
mkdir tomcat-&lt;collector-designator&gt;
tar zxvf  &lt;path&gt;/apache-tomcat-&lt;version&gt;.tar.gz -C tomcat-&lt;collector-designator&gt; --strip-path 1</pre>
  </li>
  <li>Do not configure tomcat at this time: there is a script to do this automatically -- see below.</li>
</ol>

---++ Ensure the existence of a suitable DB schema.
<ol>
  <li>Create a new empty DB if necessary with appropriate access permissions for gratia (all) and reader (SELECT and EXECUTE)</li>
</ol>

---++ Obtain and configure a cut of the Gratia collector packages.
<ol>
  <li>Ask a developer for a sanctioned release number or a pointer to a sanctioned release area containing =.war= files and the =gratia.tar= file.<br />
      If all you have is the release number or the developer wishes you to use the HEAD of the repository:
  <ol>
    <li>Check out the sanctioned release:
    <ol>
      <li>Initialize if necessary: <pre>cvs -d:pserver:anonymous@gratia.cvs.sourceforge.net:/cvsroot/gratia login</pre></li>
      <li>Get:
        <ol style="list-style-type: lower-latin">
        <li> the sanctioned version: <pre>cvs -z3 -d:pserver:anonymous@gratia.cvs.sourceforge.net:/cvsroot/gratia export -d gratia-&lt;release&gt; -r &lt;release&gt; gratia</pre></li>
        <li> the latest version: <pre>cvs -z3 -d:pserver:anonymous@gratia.cvs.sourceforge.net:/cvsroot/gratia export -d gratia-HEAD gratia</pre></li>
        </ol>
    </ol>
    </li>
    <li>Build the release:
    <ol>
      <li>Ensure you have and are using (=JAVA_HOME=, =PATH=) JDK1.5 (see above).</li>
      <li> =cd gratia-&lt;release&gt;/build-scripts= </li>
      <li> =make= </li>   
    </ol>
    </li>
  </ol>
  <li>Copy and/or edit =&lt;path-to-gratia-release&gt;/common/configuration/configure-collector= to have a clause for your tomcat instance in =%collector_configs= if it does not already contain the correct information for the collector you wish to install; see =%default_attributes= for possible attributes.</li>
  <li>Run the following command (see =-h= for usage):
<pre>&lt;path-to-gratia-release&gt;/update-gratia-local -c &lt;configure-script-location&gt; \
-S &lt;path-to-gratia-release&gt; -p &lt;dest-path&gt; -j &lt;JRE_HOME&gt; \
-d &lt;DB-root-pw&gt; &lt;collector-designator&gt</pre>
  </li>
</ol>

---++ Optionally scrub or save the collector logs

<ul>
  <li><tt>cd &lt;collector-top-dir&gt;/logs</tt>; then:
  <ul>
    <li><tt>rm -f *.log *.lck</tt>; <em>OR</em></li>
    <li><tt>logdir="../logs.`date +<nop>%Y<nop>%m<nop>%d`"; mkdir -p "$logdir" &amp;&amp; mv -f * "$logdir"</tt></li>
  </ul></li>
</ul>

---++ Start the collector
<ul>
<li><pre>/etc/rc.d/init.d/tomcat-&lt;collector-designator&gt; start</pre></li>
</ul>

-- Main.ChrisGreen - 20 Jun 2007
