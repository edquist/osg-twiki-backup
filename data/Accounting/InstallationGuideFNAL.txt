%META:TOPICINFO{author="JohnWeigand" date="1212758219" format="1.1" reprev="1.11" version="1.11"}%
%META:TOPICPARENT{name="WebHome"}%
---+ FNAL-specific Gratia collector installation guide

%TOC%

---++ Obtain and install the Java Runtime v1.5 (=5.0)

Install the Java Runtime 5.0 from [[http://java.sun.com/javase/downloads/index_jdk5.jsp][Sun's site]] (scroll down past the SDK links) if it does not already exist on the machines in question; it will usually be in =/data=, or the top level of wherever tomcat instances may exist.

---++ Obtain and install Tomcat
<ol>
  <li>Obtain the latest version of [[http://tomcat.apache.org/download-55.cgi][Tomcat in the 5.5 stream]] (core package only: =apache-tomcat-&lt;version&gt;.tar.gz=).</li>
  <li>Expand into the desired area:
    <pre class="code">cd &lt;dest-path&gt;
mkdir tomcat-&lt;collector-designator&gt;
tar zxvf  &lt;path&gt;/apache-tomcat-&lt;version&gt;.tar.gz -C tomcat-&lt;collector-designator&gt; --strip-path 1</pre>
  </li>
  <li>Do not configure tomcat at this time: there is a script to do this automatically -- see below.</li>
</ol>

---++ Ensure the existence of a suitable DB schema.
<ol>
  <li>Create a new empty DB if necessary with appropriate access permissions for gratia (all) and reader (SELECT and EXECUTE)
       <br />MySql commands (as <nop>MySql root user) using <i>gratia_mydb</i> with tomcat on <i>gratia-vm02.fnal.gov</i> as the example:
<pre>
CREATE DATABASE gratia_mydb;
GRANT ALL PRIVILEGES ON gratia_mydb.* TO 'gratia'@'localhost' IDENTIFIED BY 'update_password';
GRANT ALL PRIVILEGES ON gratia_mydb.* TO 'gratia'@'gratia-vm02.fnal.gov' IDENTIFIED BY 'update_password';
GRANT SELECT,EXECUTE ON gratia_mydb.* TO 'reader'@'localhost' IDENTIFIED BY 'reader_password';
GRANT SELECT,EXECUTE ON gratia_mydb.* TO 'reader'@'gratia-vm02.fnal.gov' IDENTIFIED BY 'reader_password';
</pre>
</li>


</ol>

---++ Obtain and configure a cut of the Gratia collector packages.
Ask a developer for a sanctioned release number or a pointer to a sanctioned release area containing =.war= files and the =gratia.tar= file.<p />
If all you have is the release number or the developer wishes you to use the HEAD of the repository:
  <ol>
    <li>Check out the sanctioned release:
    <ol type="a">
      <li>Initialize if necessary: <pre>cvs -d:pserver:anonymous@gratia.cvs.sourceforge.net:/cvsroot/gratia login</pre></li>
      <li>Get:
        <ul>
        <li> the sanctioned version: <pre>cvs -z3 -d:pserver:anonymous@gratia.cvs.sourceforge.net:/cvsroot/gratia export -d gratia-&lt;release&gt; -r &lt;release&gt; gratia</pre></li>
        <li> the latest version: <pre>cvs -z3 -d:pserver:anonymous@gratia.cvs.sourceforge.net:/cvsroot/gratia export -d gratia-HEAD gratia</pre></li>
        </ul>
    </ol>
    </li>
    <li>Build the release:
    <ol type="a">
      <li>Ensure you have and are using (=JAVA_HOME=, =PATH=) JDK1.5 (see above).</li>
      <li> =cd gratia-&lt;release&gt;/build-scripts= </li>
      <li> =make= </li>   
    </ol>
    </li>
  </ol>


---++ Configure your collector.
The  =&lt;path-to-gratia-release&gt;/common/configuration/configure-collector= script is used to install/upgrade and configure necessary software and configuration files for the Gratia collectors at FNAL.

There are 2 data files in =&lt;path-to-gratia-release&gt;/common/configuration/= that are used by the =configure-collector= script:
   * *collector-pro.dat* - for configuring the *production* gratia collectors at FNAL
   * *collector-dev.dat* - for configuring *development* gratia collectors at FNAL

Edit the approprate data file if it does not already contain the correct information for the collector you wish to install; see =%default_attributes= for possible attributes.  Be especially careful not to use ports already in use.

To install/upgrade your collector, run the following command (see =-h= for usage):
<pre>&lt;path-to-gratia-release&gt;/common/configuration/update-gratia-local -c &lt;configure-script-location&gt; \
-S &lt;path-to-gratia-release&gt; -p &lt;dest-path&gt; -j &lt;JRE_HOME&gt; \
-d &lt;DB-root-pw&gt; &lt;collector-designator&gt
</pre>

For example on gratia-vm02:
<pre>cd &lt;path-to-gratia-release&gt;
common/configuration/update-gratia-local -S ${PWD} -p /data -d  &lt;DB-root-pw&gt; pcanal
</pre>


---++ Optionally scrub or save the collector logs

<ol>
  <li><tt>cd &lt;collector-top-dir&gt;/logs</tt>; then:
  <ul>
    <li><tt>rm -f *.log *.lck</tt>; <em>OR</em></li>
    <li><tt>logdir="../logs.`date +<nop>%Y<nop>%m<nop>%d`"; mkdir -p "$logdir" &amp;&amp; mv -f * "$logdir"</tt></li>
  </ul></li>
</ol>

---++ Start the collector
<pre>
/etc/rc.d/init.d/tomcat-&lt;collector-designator&gt; start
</pre>

-- Main.ChrisGreen - 20 Jun 2007
