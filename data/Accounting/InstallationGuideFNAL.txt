%META:TOPICINFO{author="JohnWeigand" date="1215708127" format="1.1" reprev="1.15" version="1.15"}%
%META:TOPICPARENT{name="WebHome"}%
---+ FNAL-specific Gratia collector installation guide

%TOC%

---++ Obtain and install the Java Runtime v1.5 (=5.0)

Install the Java Runtime 5.0 from [[http://java.sun.com/javase/downloads/index_jdk5.jsp][Sun's site]] (scroll down past the SDK links) if it does not already exist on the machines in question; it will usually be in =/data=, or the top level of wherever tomcat instances may exist.

---++ Install Tomcat
 You will need to install tomcat in your collectors HOME area, e.g. /data/tomcat-psacct_itb, where 'psacct_db' is your !MySql database name. 
   * The latest version of tomcat can be found in /home/gratia/tomcat-tarballs. 
   * If a newer verson of tomcat is desired, you can obtain latest version from [[http://tomcat.apache.org/download-55.cgi][Tomcat in the 5.5 stream]] (core package only: =apache-tomcat-[VERSION].tar.gz=). 

Expand into the desired area:
   * cd [TOP_LEVEL_DIR] 
   * mkdir tomcat-[YOUR_DB_NAME] 
   * tar zxvf /home/gratia/tomcat-tarballs/apache-tomcat-<VERSION].tar.gz -C tomcat-[YOUR_DB_NAME] --strip-path 1 

*Do not* configure tomcat at this time: there is a script to do this automatically -- see below.

---++ Ensure the existence of a suitable DB schema.

Create a new empty DB if necessary with appropriate access permissions for gratia (all) and reader (SELECT and EXECUTE).

These are the !MySql commands (as !MySql root user) using _gratia_mydb_ with tomcat on _gratia-vm02.fnal.gov_ as the example:
   * CREATE DATABASE gratia_mydb; <br /></pre> 
   * GRANT ALL PRIVILEGES ON gratia_mydb.* TO 'gratia'@'%.fnal.gov' IDENTIFIED BY 'update_password'; 
   * GRANT SELECT,EXECUTE ON gratia_mydb.* TO 'reader'@'%' IDENTIFIED BY 'reader_password'; 

---++ Obtain and configure a cut of the Gratia collector packages.
 Ask a developer for a sanctioned release number or a pointer to a sanctioned release area containing =.war= files and the =gratia.tar= file.

If all you have is the release number or the developer wishes you to use the HEAD of the repository:

Check out the sanctioned release:
   1 Initialize if necessary: 
      * cvs -d:pserver:anonymous@gratia.cvs.sourceforge.net:/cvsroot/gratia login 
   1 Get the sanctioned version: 
      * cvs -z3 -d:pserver:anonymous@gratia.cvs.sourceforge.net:/cvsroot/gratia export -d gratia- -r gratia 
   1 or the latest version: 
      * cvs -z3 -d:pserver:anonymous@gratia.cvs.sourceforge.net:/cvsroot/gratia export -d gratia-HEAD gratia 

Build the release:
   1 Ensure you have and are using ( =JAVA_HOME=, =PATH=) JDK1.5 (see above). 
   1 cd gratia-[RELEASE]/build-scripts 
   1 make 

---++ Configure your collector.
 The [PATH-TO-GRATIA-RELEASE]/common/configuration/configure-collector script is used to install/upgrade and configure necessary software and configuration files for the Gratia collectors at FNAL.

There are 2 data files in [PATH-TO-GRATIA-RELEASE]/common/configuration/ that are used by the =configure-collector= script:
   * *collector-pro.dat* - for configuring the *production* gratia collectors at FNAL 
   * *collector-dev.dat* - for configuring *development* gratia collectors at FNAL 

Edit the appropriate data file if it does not already contain the correct information for the collector you wish to install. Refer to =%default_attributes= for possible attributes. Be especially careful not to use ports already in use.

Example configuration:
<verbatim>  
weigand => { http_port => 8887,
               ssl_port => 8867,
               rmi_port => 24000,
               jmx_port => 8074,
               server_port => 8174,
               db_host => "gratia-vm02.fnal.gov",
               db_schema => "gratia_weigand",
                "properties.attributes" =>  
               {
                 "maintain.history.log" => 2,
                 "monitor.listener.wait" => 240,
                 "monitor.to.address0" => 'weigand@fnal.gov',
                 "service.admin.DN.0" => 'ALLOW ALL' 
               }
            }, 
</verbatim>

To install/upgrade your collector, run the following command (see =-h= for usage):
<verbatim>
[PATH-TO-GRATIA-RELEASE]/common/configuration/update-gratia-local \
    -c [PATH-TO-GRATIA-RELEASE]/common/configuration \
    -S [PATH-TO-GRATIA-RELEASE] \
    -p {DEST-PATH]  \
     -j [JRE_HOME]  \
    -d [DB_ROOT_PASSWORD]  \
    [COLLECTOR_DESIGNATOR]
</verbatim>

For example on gratia-vm02:
<verbatim>
cd [PATH-TO-GRATIA-RELEASE]
common/configuration/update-gratia-local -S ${PWD} -p /data -d  [DB_ROOT_PASSWORD] pcanal 
</verbatim>

---++ Optionally scrub or save the collector logs

   1 cd [collector-top-dir]/logs
   1 rm -f *.log *.lck; _OR_ 
   1 logdir="../logs.`date +%Y%m%d`"; mkdir -p "$logdir" && mv -f * "$logdir" 

---++ Start the collector
/etc/rc.d/init.d/tomcat-[collector-designator] start

-- Main.ChrisGreen - 20 Jun 2007
