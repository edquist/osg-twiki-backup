%META:TOPICINFO{author="ChrisGreen" date="1216067867" format="1.1" version="1.18"}%
%META:TOPICPARENT{name="WebHome"}%
---+ FNAL-specific Gratia collector installation guide

%TOC%

---++ Obtain and install the Java Runtime v1.5 (=5.0)

Install the Java Runtime 5.0 from [[http://java.sun.com/javase/downloads/index_jdk5.jsp][Sun's site]] (scroll down past the SDK links) if it does not already exist on the machines in question; it will usually be in =/data=, or the top level of wherever tomcat instances may exist.
---++ Obtain and install the !MySql client v5.0.n

If not already available on the node, install the !MySql client v5.0.n. The !MySql client rpm can be found in */home/gratia/mysql-rpms*.

The !MySql client has a dependency on Perl-DBI which if not installed already, can be installed using:
   * yum install Perl-DBI 

---++ Install Tomcat
 You will need to install tomcat in your collectors HOME area, e.g. /data/tomcat-psacct_itb, where 'psacct_db' is your !MySql database name. 
   * The latest version of tomcat can be found in */home/gratia/tomcat-tarballs*. 
   * If a newer verson of tomcat is desired, you can obtain latest version from [[http://tomcat.apache.org/download-55.cgi][Tomcat in the 5.5 stream]] (core package only: =apache-tomcat-[VERSION].tar.gz=). 

Expand into the desired area:
   * cd [TOP_LEVEL_DIR] 
   * mkdir tomcat-[YOUR_DB_NAME] 
   * tar zxvf /home/gratia/tomcat-tarballs/apache-tomcat-<VERSION].tar.gz -C tomcat-[YOUR_DB_NAME] --strip-path 1 

*Do not* configure tomcat at this time: there is a script to do this automatically -- see below.

---++ Installing CA certificates for administrative login
 If the host you are installing your collector on does *not* have a host/http certificate and the VDT CA Certificates package installed, you will have do so before you proceed.

---+++ Host/http Certificates
 To obtain a host/http certificate, contact your UNIX administrator.

The host certificates should be installed in */etc/grid-security* as:
<verbatim>
-rw-r--r--  1 root root 1477 May 19 10:08 hostcert.pem
-rw-------  1 root root 1675 May 19 10:09 hostkey.pem
</verbatim>

The http certificate should be installed in */etc/grid-security* as:
<verbatim>
drwxr-xr-x  2 root root 4096 May 19 09:34 http
   -rw-r--r--  1 root root 1485 May 19 09:34 httpcert.pem
   -rw-------  1 root root 1675 May 19 09:34 httpkey.pem
</verbatim>

---+++ VDT CA Certificates package
 If you do not have *pacman* installed, you can install it in */usr/local*: 
   * cd /usr/local 
   * mkdir pacman 
   * cd pacman 
   * wget http://physics.bu.edu/pacman/sample_cache/tarballs/pacman-latest.tar.gz 
   * tar zxf pacman-latest.tar.gz 

To install the VDT CA Certificates package, you will need to go to the VDT site.
   * For information on how VDT installations work with pacman, refer to http://vdt.cs.wisc.edu/download.html 
   * The latest VDT packages can be found here: http://vdt.cs.wisc.edu/documentation.html 
   * The CA Certificates package for the 1.10.1 release is: http://vdt.cs.wisc.edu/vdt_1101_cache/CA-Certificates.pacman 

To install the CA-Certificates package:
   * cd /usr/local/pacman/pacman-[VERSION} 
   * source setup.sh 
   * cd /usr/local 
   * mkdir vdt-certificates-{VERSION] 
   * cd vdt-certificates-{VERSION] 
   * pacman -get http://vdt.cs.wisc.edu/vdt_1101_cache:CA-Certificates . 

Answer "y" to all the questions.

When asked where to install the certificates, it is your choice. Most common place is /etc/grid-security.

After all of the above has been done, you will need to turn on the VDT installed services (crons) necessary to maintain the certificates.
   * cd /usr/local/vdt-certificates-{VERSION] 
   * source setup.sh 
   * vdt-control --on 

---++ Ensure the existence of a suitable DB schema.

Create a new empty DB if necessary with appropriate access permissions for gratia (all) and reader (SELECT and EXECUTE).

These are the !MySql commands (as !MySql root user) using _gratia_mydb_ with tomcat on _gratia-vm02.fnal.gov_ as the example:
   * CREATE DATABASE [MY_DATABASE]; 
   * GRANT ALL PRIVILEGES ON [MY_DATABASE].* TO 'gratia'@'%.fnal.gov' IDENTIFIED BY 'update_password'; 
   * GRANT SELECT,EXECUTE ON [MY_DATABASE].* TO 'reader'@'%' IDENTIFIED BY 'reader_password'; 

You will also need to allow root access from the collector node (this is for the post-install.sh script executed by the collector):
   * GRANT ALL PRIVILEGES ON *<nop>**.* TO 'root'@'[COLLECTOR_NODE]' IDENTIFIED BY 'root_password';
   * GRANT GRANT OPTION ON *<nop>**.* TO 'root'@'[COLLECTOR_NODE]' IDENTIFIED BY 'root_password';
   * FLUSH PRIVILEGES;

---++ Obtain and configure a cut of the Gratia collector packages.
 Ask a developer for a sanctioned release number or a pointer to a sanctioned release area containing =.war= files and the =gratia.tar= file.

If all you have is the release number or the developer wishes you to use the HEAD of the repository:

Check out the sanctioned release:
   1 Initialize if necessary: 
      * cvs -d:pserver:anonymous@gratia.cvs.sourceforge.net:/cvsroot/gratia login 
   1 Get the sanctioned version: 
      * cvs -z3 -d:pserver:anonymous@gratia.cvs.sourceforge.net:/cvsroot/gratia export -d gratia- -r <em>&lt;release-no&gt;</em> gratia
   1 or the latest version: 
      * cvs -z3 -d:pserver:anonymous@gratia.cvs.sourceforge.net:/cvsroot/gratia export -d gratia-HEAD gratia 

Build the release:
   1 Ensure you have and are using ( =JAVA_HOME=, =PATH=) JDK1.5 (see above). 
   1 cd gratia-[RELEASE]/build-scripts 
   1 make 

---++ Configure your collector.
 The [PATH-TO-GRATIA-RELEASE]/common/configuration/configure-collector script is used to install/upgrade and configure necessary software and configuration files for the Gratia collectors at FNAL.

There are 2 data files in [PATH-TO-GRATIA-RELEASE]/common/configuration/ that are used by the =configure-collector= script:
   * *collector-pro.dat* - for configuring the *production* gratia collectors at FNAL 
   * *collector-itb.dat* - for configuring the *itb* gratia collectors at FNAL 
   * *collector-dev.dat* - for configuring *development* gratia collectors at FNAL 

Edit the appropriate data file if it does not already contain the correct information for the collector you wish to install. Refer to =%default_attributes= for possible attributes. Be especially careful not to use ports already in use.

Example configuration:
<verbatim>  
itb_gratia_psacct => { http_port => 8880,
               ssl_port => 8847,
               rmi_port => 17000,
               jmx_port => 8074,
               server_port => 8174,
               db_schema => "itb_gratia_psacct",
               db_host => "gratia07.fnal.gov",
               db_port => "3322",
               remote_host => "gratia02.fnal.gov",
               collector_host => "gratia02.fnal.gov",
                "properties.attributes" =>  
               {
                 "maintain.history.log" => 2,
                 "monitor.listener.wait" => 240,
                 "monitor.to.address0" => 'gratia-operation@fnal.gov',
                 "service.admin.DN.0" => 'ALLOW ALL' 
               }
            }, 
</verbatim>

To install/upgrade your collector, run the following command (see =-h= for usage):
<verbatim>
[PATH-TO-GRATIA-RELEASE]/common/configuration/update-gratia-local     
 -c [PATH-TO-GRATIA-RELEASE]/common/configuration/configure-collector     
 -S [PATH-TO-GRATIA-RELEASE] 
 -p {DEST-PATH]
 -j [JRE_HOME]
 -d [DB_ROOT_PASSWORD]
 -s
       [COLLECTOR_DESIGNATOR]
</verbatim>

For example if you are installing from the nightly gratia builds in /home/gratia on the collector node gratia02:
<verbatim>
/home/gratia/gratia-builds/gratia-latest/common/configuration/update-gratia-local
 -S /home/gratia/gratia-builds/gratia-latest/common/configuration/configure-collector
 -p /data
 -j /data/jre
 -d  [DB_ROOT_PASSWORD] 
 -s
 itb_gratia_psacct 
</verbatim>

---++ Optionally scrub or save the collector logs

   1 cd /data/tomcat-itb_gratia_psacct/logs 
   1 rm -f *.log *.lck; _OR_ 
   1 logdir="../logs.`date +%Y<nop>%m%d`"; mkdir -p "$logdir" && mv -f * "$logdir" 

---++ Start the collector
 /etc/rc.d/init.d/tomcat-itb_gratia_psacct start

-- Main.ChrisGreen - 20 Jun 2007