%META:TOPICINFO{author="ChrisGreen" date="1280513430" format="1.1" version="1.27"}%
%META:TOPICPARENT{name="WebHome"}%
<!--
   * Set VIEWTHISTOPIC = <div class="twikiSmall"><a href="%TOPIC%">View this section</a></div>
--> 

---+ FNAL-specific Gratia collector installation guide

%TOC%

---++ Install and configure a standard VDT CA certificates installation

---++ Obtain and install the Java Runtime 

Install the appropriate =java-sun-compat= from the FSL distribution's yum repository.
 
---++ Obtain and install the !MySql client

If not already available on the node, install the !MySql client from the FSL distribution's yum repository.

---++ Ensure the existence of a suitable DB schema.

Create a new empty DB if necessary with appropriate access permissions for gratia (all) and reader (SELECT and EXECUTE).

These are the !MySql commands (as !MySql root user) using _gratia_mydb_ with tomcat on _gratia-vm02.fnal.gov_ as the example:
   * CREATE DATABASE [MY_DATABASE]; 
   * GRANT ALL PRIVILEGES ON [MY_DATABASE].* TO 'gratia'@'%.fnal.gov' IDENTIFIED BY 'update_password'; 
   * GRANT SELECT,EXECUTE ON [MY_DATABASE].* TO 'reader'@'%' IDENTIFIED BY 'reader_password'; 

Additionally. you may need to add this entry is it does not exist in the _mysql.db_ database:
   * GRANT SELECT ON information_schema.* TO 'gratia'@'%.fnal.gov' IDENTIFIED BY 'update_password'; 

You will also need to allow root access from the collector node (this is for the post-install.sh script executed by the collector):
   * GRANT ALL PRIVILEGES ON *<nop>**.* TO 'root'@'[COLLECTOR_NODE]' IDENTIFIED BY 'root_password';
   * GRANT GRANT OPTION ON *<nop>**.* TO 'root'@'[COLLECTOR_NODE]' IDENTIFIED BY 'root_password';
   * FLUSH PRIVILEGES;

---++ Configure your collector.
 The [PATH-TO-GRATIA-RELEASE]/common/configuration/configure-collector script is used to install/upgrade and configure necessary software and configuration files for the Gratia collectors at FNAL.

There are 3 data files in [PATH-TO-GRATIA-RELEASE]/common/configuration/ that are used by the =configure-collector= script:
   * *collector-pro.dat* - for configuring the *production* gratia collectors at FNAL 
   * *collector-itb.dat* - for configuring the *itb* gratia collectors at FNAL 
   * *collector-dev.dat* - for configuring *development* gratia collectors at FNAL 

Edit the appropriate data file if it does not already contain the correct information for the collector you wish to install. Refer to =%default_attributes= and existing or commented attributes in [PATH-TO-GRATIA-RELEASE]/common/configuration/service-configuration.properties for possible attributes. Be especially careful not to use ports already in use.

The =.dat= file is 'eval'ed by perl and should constitute a properly constructed perl associative array ('hash'). Note that in order to preserve local changes to the configuration you must take a copy of =collector-pro.dat=, modify and save it off somewhere, then *either*

   1. merge your local data file into the version in [PATH-TO-GRATIA-RELEASE]/common/configuration/ before executing =update-gratia-local= as detailed below; *or*
   1. merge new attributes from [PATH-TO-GRATIA-RELEASE]/common/configuration/ to your local copy and then execute =update-gratia-local= mostly as detailed below but adding, '-i <path-local-dat-file>' to the arguments.

Example configuration:
<verbatim>  
 itb_gratia_psacct =>
 { http_port => 8881,
   ssl_port => 8846,
   rmi_port => 18000,
   jmx_port => 8014,
   server_port => 8114,
   db_schema => "itb_gratia_psacct",
   db_host => "gratia07.fnal.gov",
   db_port => "3322",
   remote_host => "gratia02.fnal.gov",
   collector_host => "gratia02.fnal.gov",
   UserConfig => "UserConfig_pacct.xml",
   "properties.attributes" =>
   {
    "gratia.database.useJobUsageSiteName" => 1,
    "gratia.database.wantNodeSummary" => 1,
    "monitor.to.address.0" => 'gratia-operation@fnal.gov',
    "service.admin.DN.0" => 'ALLOW ALL'
   }
 },
</verbatim>

%INCLUDE{GratiaUpgradeScript}%

---++ Optionally scrub or save the collector logs

   1 cd /data/tomcat-itb_gratia_psacct/logs 
   1 rm -f *.log *.lck; _OR_ 
   1 logdir="../logs.`date +%Y<nop>%m%d`"; mkdir -p "$logdir" && mv -f * "$logdir" 

---++ Start the collector
 /etc/rc.d/init.d/tomcat-itb_gratia_psacct start

---++ OPTIONAL: install redirex

Redirex is an optional part of the installation procedure to allow for simple redirection of queries to port 80 on the collector machine to the accounting !TWiki if Apache is not running.

To install it on a machine, copy [PATH-TO-GRATIA-RELEASE]/redirex to (eg) =/data/redirex= and install =redirex.init= as =/etc/init.d/redirex=, altering =REDIREX_DIR= as appropriate. Run your usual command (eg =chkconfig=) to set the script up to run in the various runlevels and optionally start the service manually. 

-- Main.ChrisGreen - 20 Jun 2007