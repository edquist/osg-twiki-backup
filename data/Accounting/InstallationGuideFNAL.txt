%META:TOPICINFO{author="JohnWeigand" date="1215551564" format="1.1" reprev="1.14" version="1.14"}%
%META:TOPICPARENT{name="WebHome"}%
---+ FNAL-specific Gratia collector installation guide

%TOC%

---++ Obtain and install the Java Runtime v1.5 (=5.0)

Install the Java Runtime 5.0 from [[http://java.sun.com/javase/downloads/index_jdk5.jsp][Sun's site]] (scroll down past the SDK links) if it does not already exist on the machines in question; it will usually be in =/data=, or the top level of wherever tomcat instances may exist.

---++ Obtain and install Tomcat
   1 Obtain the latest version of [[http://tomcat.apache.org/download-55.cgi][Tomcat in the 5.5 stream]] (core package only: =apache-tomcat-<version>.tar.gz=). 
   1 Expand into the desired area: 
<pre class="code">
cd 
mkdir tomcat- tar zxvf /apache-tomcat-.tar.gz -C tomcat- --strip-path 1
</pre> 
   1 Do not configure tomcat at this time: there is a script to do this automatically -- see below. 

---++ Ensure the existence of a suitable DB schema.
   1 Create a new empty DB if necessary with appropriate access permissions for gratia (all) and reader (SELECT and EXECUTE) 

MySql commands (as MySql root user) using _gratia_mydb_ with tomcat on _gratia-vm02.fnal.gov_ as the example:
<pre>CREATE DATABASE gratia_mydb;  GRANT ALL PRIVILEGES ON gratia_mydb.* TO 'gratia'@'localhost' IDENTIFIED BY 'update_password';  GRANT ALL PRIVILEGES ON gratia_mydb.* TO 'gratia'@'gratia-vm02.fnal.gov' IDENTIFIED BY 'update_password';  GRANT SELECT,EXECUTE ON gratia_mydb.* TO 'reader'@'%' IDENTIFIED BY 'reader_password';  GRANT SELECT,EXECUTE ON gratia_mydb.* TO 'reader'@'gratia-vm02.fnal.gov' IDENTIFIED BY 'reader_password';  </pre>

---++ Obtain and configure a cut of the Gratia collector packages.
 Ask a developer for a sanctioned release number or a pointer to a sanctioned release area containing =.war= files and the =gratia.tar= file.

If all you have is the release number or the developer wishes you to use the HEAD of the repository:
   1 Check out the sanctioned release: 
      1 Initialize if necessary: <pre>cvs -d:pserver:anonymous@gratia.cvs.sourceforge.net:/cvsroot/gratia login</pre> 
      1 Get: 
         * the sanctioned version: <pre>cvs -z3 -d:pserver:anonymous@gratia.cvs.sourceforge.net:/cvsroot/gratia export -d gratia- -r gratia</pre> 
         * the latest version: <pre>cvs -z3 -d:pserver:anonymous@gratia.cvs.sourceforge.net:/cvsroot/gratia export -d gratia-HEAD gratia</pre> 
 

   1 Build the release: 
      1 Ensure you have and are using ( =JAVA_HOME=, =PATH=) JDK1.5 (see above). 
      1 =cd gratia-<release>/build-scripts= 
      1 =make= 

---++ Configure your collector.
 The /common/configuration/configure-collector script is used to install/upgrade and configure necessary software and configuration files for the Gratia collectors at FNAL.

There are 2 data files in /common/configuration/ that are used by the =configure-collector= script:
   * *collector-pro.dat* - for configuring the *production* gratia collectors at FNAL 
   * *collector-dev.dat* - for configuring *development* gratia collectors at FNAL 

Edit the approprate data file if it does not already contain the correct information for the collector you wish to install. Refer to =%default_attributes= for possible attributes. Be especially careful not to use ports already in use.

Example configuration:
<pre> weigand => { http_port => 8887,                ssl_port => 8867,                rmi_port => 24000,                jmx_port => 8074,                server_port => 8174,                db_host => "gratia-vm02.fnal.gov",                db_schema => "gratia_weigand",                "properties.attributes" =>                {                 "maintain.history.log" => 2,                 "monitor.listener.wait" => 240,                 "monitor.to.address0" => 'weigand@fnal.gov',                 "service.admin.DN.0" => 'ALLOW ALL'                }              }, </pre>

To install/upgrade your collector, run the following command (see =-h= for usage):
<pre>/common/configuration/update-gratia-local -c   -S  -p  -j   -d   </pre>

For example on gratia-vm02:
<pre>cd  common/configuration/update-gratia-local -S ${PWD} -p /data -d   pcanal </pre>

---++ Optionally scrub or save the collector logs

   1 cd /logs; then: 
      * rm -f *.log *.lck; _OR_ 
      * logdir="../logs.`date +%Y%m%d`"; mkdir -p "$logdir" && mv -f * "$logdir" 

---++ Start the collector
 <pre>/etc/rc.d/init.d/tomcat- start </pre>

-- Main.ChrisGreen - 20 Jun 2007
