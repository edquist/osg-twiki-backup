%META:TOPICINFO{author="PhilippeCanal" date="1312487172" format="1.1" reprev="1.6" version="1.6"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! Probe build and release-cutting procedure

---++ Prepare for the build

For new probes only:
<ul>
<li>Add the subdirectory name to the invocation of =build/package-probe= in =gratia/build/build_all=.</li>
</ul>

Update the =gratia/probe/build/gratia-probe.spec= file:

<ol>
<li>Update the =Version= and =Release= attributes as appropriate.</li>
<li>Update =%files= clause as appropriate for updated probes.</li>
<li>Check the =%post= clause for updated probes, including the !ProbeConfig changes if appropriate.</li>
<li>Update =%changelog=.</li>
<li>For new probes:
<ul>
<li>Add required =Source= lines as appropriate.</li>
<li>Add required =%setup= line to =%prep= section.</li>
<li>In the install section, update the correct side of the =%ifarch noarch= clause for the !ProbeConfig copy and any required init script for daemon-type probes.</li>
<li>Put correct =%package=, =%description=, =%files=, =%post= and =%preun= sections: use glexec (noarch non-daemon), xrootd-transfer (noarch daemon), pbs-lsf (arch non-daemon) or dCache-transfer (arch daemon) probes as templates.</li>
</ul></li>
</ol>

[This needs to be done only once] Setup for the rpm build to succeed by creating the directory $HOME/rpmbuild/SOURCES
and setting up the rpm macro:
<verbatim>echo %_topdir $HOME/rpmbuild >> $HOME/.rpmmacros
mkdir -p $HOME/rpmbuild/SOURCES $HOME/rpmbuild/BUILD $HOME/rpmbuild/SRPMS $HOME/rpmbuild/RPMS $HOME/rpmbuild/SPECS</verbatim>

Note: the build is expected to be done as a regular user.

---++ Build

<verbatim>
cd gratia/probe
build/build_all
</verbatim>

The resulting rpm files will be located in $HOME/rpmbuild/RPMS and $HOME/rpmbuild/SRPMS.

---++ Test

   * Test as appropriate on any one of the CEs mentioned on the [[http://fermigrid.fnal.gov/gratia-development-organization.html][development machine allocation]] page.
   * Some probes can be be tested to a large extent on pre-packaged log data. Examples of this are the pbs-lsf, SGE and glexec probes.

%INCLUDE{"CollectorBuildRelease" section="CommitAndPort"}%

---++ Cut a tag

For example, if cutting from the trunk.
<verbatim>
RELEASE=v1.06.18b-1
svn copy https://gratia.svn.sourceforge.net/svnroot/gratia/{trunk,tags/${RELEASE//./-}}
</verbatim>
or if cutting from the patch branch:
<verbatim>
RELEASE=v1.06.18b-1
svn copy https://gratia.svn.sourceforge.net/svnroot/gratia/{branches/v1-06,tags/${RELEASE//./-}}
</verbatim>

Note that the entire repository is tagged, not just the =probe= tree.

---++ Export for a final tagged build

<verbatim>
RELEASE=v1.06.18b-1
svn export http://gratia.svn.sourceforge.net/svnroot/gratia/tags/${RELEASE//./-}/probe gratia-probe-${RELEASE}
</verbatim>

---++ Build and ship RPMs

<verbatim>
cd gratia-probe-${RELEASE}
build/build_all -PY
</verbatim>

The =-P= option ships the RPMs to FNALU. See the [[CollectorBuildRelease#Release_to_VDT][release transfer]] section of the collector build and release instructions for required permissions. The =-Y= option will update the repository headers for yum installs.

The RPMs are sent to =/afs/fnal.gov/files/expwww/gratia/html/Files/probe/{S,}RPMS=.

---++ Update the Probe release page.

Bring the [[ProbeInstallation][probe installation]] page up to date, including but not necessarily limited to the !TWiki variable =ProbeVersion=.

%INCLUDE{"CollectorBuildRelease" section="ReleaseNotes"}%

%INCLUDE{"CollectorBuildRelease" section="VDTRelease"}%


-- Main.ChrisGreen - 28 Jul 2010
