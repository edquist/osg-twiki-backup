%META:TOPICINFO{author="MarcoMambelli" date="1391112855" format="1.1" reprev="1.23" version="1.23"}%
%META:TOPICPARENT{name="ProbeInstallation"}%
---+!! !HTCondor/GlideinWMS Probe Configuration
<!--
   * Local SUPPORTED_OS = Red Hat Enterprise Linux 5, 32 and 64 bit and variants (Scientific Linux 5 and !CentOS) 
-->
%TOC%

---++ Overview
This probe reports the usage in a HTCondor system

To know which Resource the job is running on this probe will read the GLIDEIN_ResourceType startd attribute.  This attribute needs to be set by the !GlideinWMS Factory (The OSG factories already have this set).  If this attribute does not exist, it will fall back to GLIDEIN_Site, and finally the !FileSystemDomain of the host.

The usage will be forwarded to the production Gratia collector (gratia-osg-prod.opensciencegrid.org) by default.

This document refers to a probe installed to a Submit host submitting directly or indirectly (flocking) to a [[Documentation/Release3.NavTechGlideinWMS][GWMS System]] (GWMS Frontend, Submit host, ...). 
If you are installing/configuring a Compute Element check the [[Documentation/Release3/InstallComputeElement#7_2_Configuring_your_CE_to_use_C][CE install guide]] instead.
The underlying probe is the same but the configuration differs.

---++ Requirements and Preparation

The Probe assumes that condor binaries (=condor_history= for example) are in the default path (=/usr/bin=).  If they are not, please see section [[#NonStandardCondor][Non-Standard Condor]]

Host requirements (bare-bone installation):
   * Probe must be installed on the VO's schedd.
   * Currently most of our testing has been done on Scientific Linux 5.
   * Root access
   * Allow outbound network connection, on port 80, to the Gratia collector (default is http://gratia-osg-prod.opensciencegrid.org).  Gratia does not support HTTP proxies.

To be part of OSG your CE must be registered in OIM. To register your resource:
   * Use your user certificate.  [[Documentation.Release3.CertificateUserGet][Here]] are instructions to request a user certificate.
   * Register in OIM as described in Operations.OIMRegistrationInstructions

%INCLUDE{"Documentation.Release3.YumRepositories" section="OSGRepoBrief" TOC_SHIFT="+"}%

---++ Installation
   1. Install the Gratia Common and Gratia Condor RPM on the host that runs the =condor_schedd=.  Assuming you previously installed the OSG repo and have the release repository enabled:
   <pre class="screen">
yum install gratia-probe-condor </pre>
   1. Edit the ProbeConfig located in =/etc/gratia/condor/ProbeConfig=.  First, edit the =SiteName= and =ProbeName= to be a unique identifier for your !GlideinWMS Submit host.  There can be multiple probes (with different names) per site.   If you haven't already, you should register your !GlideinWMS submit host in [[https://oim.grid.iu.edu/oim/home][OIM]].  Then you can use the name you used to register the resource.
   <pre class="file">
ProbeName="condor:&lt;hostname>"
SiteName="HCC-GlideinWMW-Frontend"   </pre>
   Next, turn the probe on by editing the =EnableProbe=:
   <pre class="file">
EnableProbe="1"   </pre>
   1. Add the following to the condor configuration (recommended to =condor_config.local= or a new file in =/etc/condor/config.d= directory):
   <pre class="file">
# GlideinWMS Gratia commands
PER_JOB_HISTORY_DIR = /var/lib/gratia/data
JOBGLIDEIN_ResourceName="$$([IfThenElse(IsUndefined(TARGET.GLIDEIN_ResourceName), IfThenElse(IsUndefined(TARGET.GLIDEIN_Site), IfThenElse(IsUndefined(TARGET.FileSystemDomain), \"Local Job\", TARGET.FileSystemDomain), TARGET.GLIDEIN_Site), TARGET.GLIDEIN_ResourceName)])"
SUBMIT_EXPRS = $(SUBMIT_EXPRS) JOBGLIDEIN_ResourceName   </pre>
   1. Start the services, and add them to be started automatically when the system reboots: <pre class="screen">
$ service gratia-probes-cron start
$ chkconfig --level 345 gratia-probes-cron on </pre>


---++ Usage Graphs
Usage graphs can be found under the heading Glidein Bar Graphs at 
http://gratiaweb.grid.iu.edu/gratia/xml

Specifically, [[http://gratiaweb.grid.iu.edu/gratia/xml/glidein_hours_bar_smry][this page]] may be useful.  Replace the variable =probe= with the name of your probe that you configured above.

*NOTE:* Usage could be delayed up to a few hours after the job has completed.

---++ Unusual Use Cases
---+++ Users without Certificates
If you have users that submit jobs without a certificate explicitly declared in the submit file, you will need to add =MapUnknownToGroup= to the ProbeConfig.  In the file =/etc/gratia/condor/ProbeConfig=, add the value after the =EnableProbe=.

<pre class="file">
    ...
    SuppressGridLocalRecords="0"
    EnableProbe="1"
    %RED%MapUnknownToGroup="1"%ENDCOLOR%

    Title3="Tuning parameter"
    ...
</pre>

Further, if you want to record all usage as coming from a single VO, you can configure the probe to override the 'guessed' VO.  In the below example, replace the %RED%Engage%ENDCOLOR% with a registered VO that you would like to report as.  If you don't have a VO that you are affiliated with, you may use Engage.

<pre class="file">
...
    MapUnknownToGroup="1"
    %RED%MapGroupToRole="1"%ENDCOLOR%
    %RED%VOOverride="Engage"%ENDCOLOR%
...
</pre>

#NonStandardCondor
---+++ Non-Standard Condor Install
If Condor is installed in a non-standard location (ie not RPMs, or relocated RPM outside =/usr/bin=), then you need to tell the probe where to find the Condor binaries.  This can be done with a script with a special attribute in =/etc/gratia/condor/ProbeConfig=, =CondorLocation=.  Point it to the location of the Condor install, such that =CondorLocation/bin/condor_version= exists.  


---++++ No RPM install of Condor
By default, the gratia probe will also install Condor, if it hasn't already been installed by RPM (or YUM).   To disable this, you need to install =empty-condor= in order to trick yum into believing you already have condor.
<pre class="screen">
yum install empty-condor gratia-probe-condor </pre>

---++++ New Data Directory
In =/etc/gratia/condor/ProbeConfig=, the value of =DataFolder= (near the bottom) needs to be the same as the Condor configuration variable =PER_JOB_HISTORY_DIR=.  You can get the value of =PER_JOB_HISTORY_DIR= with the command:
<pre class="screen">
condor_config_val PER_JOB_HISTORY_DIR </pre>.
