%META:TOPICINFO{author="ChrisGreen" date="1279057915" format="1.1" reprev="1.14" version="1.14"}%
%META:TOPICPARENT{name="WebHome"}%
<!--
These are general in nature and should be changed in the this template if the location changes:

These are specific to a release and require changing:
   * Set RELEASE_DATE = 2010/07/14
   * Set CURRENT_RELEASE = v1.06.17
   * Set RELEASE_TAG = v1-06-17
   * Set NEXT_DEVEL_VERSION = v1.07

-->

---+!! Gratia Release %CURRENT_RELEASE% (%RELEASE_DATE%)%BR% 


%TOC%

%STARTINCLUDE%
---+ Overview

---++Main Features:
   * Maintenance release.
   * See previous patch release [[GratiaReleaseV1dot06dot14][v1.06.14]] for changes since v1.04.

   * Implement cutoff date.
   * Speed up housekeeping deletion (and remove use of temporary table).
   * Additional housekeeping logging.
   * Fix occasional problem with inter-service communication caused by premature garbage collection.

---++ Probe Improvements:

   * Add summarization capability to the dCache probe.
   * Separate the !JobUsageRecord support from the main library which is now !GratiaCore.py

---+++ Details

   * Tweak !ProbeConfig extra items for dCache-transfer probe.
   * Reorganize !GridFtpLogDir config item insertion.
   * Sleep and configurable DB name for dCache-transfer probe.
   * Core updates for HTTP timeout waiting for acknowledgement from collector.
   * Improve connection timeout mesage to avoid confusion.
   * Improvements to xrootd probe.
   * Fix for =staticmethod= (make it work in 2.3).
   * Fix mechanism intended to avoid corruption caused by reading in-progress log.
   * Robustness fix to !GetNodeData function in Gratia.py.
   * Fix for exception in debug statements in Gratia.py.
   * Increase default !BundleSize to 100 in !ProbeConfigTemplate and Gratia.py.
   * Remove unecessary dependencies from dCache-storage probe.
   * !EGEE-provided probe is now version-controlled instead of unpackaged and patched from source.
   * Unused !GridftpTransfer.sh script removed prior to final packaging.
   * Condor probe security fixes from Wisconsin.
   * Add gratia-probe-services as a dependency to the xrootd-storage probe
   * Fix to cron scripts for !WorkingFolder discovery in dCache-storage and gridftp-transfer cron scripts.
   * Remove erroneous ITB tag for services API package.
   * Better use of lock files in *_cron.sh.
   * Fixes and updates to dCache-storage probe, including addition of !README file to package.
   * Added redesigned xrootd-transfer probe
   * Minor updates for the xrootd-storage probe found in testing.
   * Fix to condor probe for standalone (non-VDT) operation.


---++ Collector Improvements:

   * Add a publicly available summary of the replication 

   * In addition to the expiration date, when there is a limited retention of the records,
we also reject the records that are in the future.  For now, the rejection is set to
the same duration as the expiration.  For example if the service.lifetime.JobUsageRecord is
set to 3 months, we reject all !JobUsageRecord that are either set more than 3 months in
the past or more than 3 months in the future.

   * Increase the default batch size for row deletion from 200 to 1000.
   * Change the default fault batch size for _Xml row deletion to 100000.

   * Introduce the 2 customizable parameters:

      * service.lifetimeManagement.BatchSize and service.lifetimeManagement.XmlBatchSize

   * Add an index to quickly find empty !ExtraXml

   * Rework the row deletion from !RecordType_Xml.

      a. We no longer keep the row when the !EndTime is greater than the !ServerDate (and !EndTime was greater than the cutoff date).
      a. We no longer use a temporary table.
      a. Improve the 'limited' delete query by using a dbid range to restrict the searches.
         1. We find the maximum plausible dbid by searching in !RecordType_Meta for the dbid clause to or equal to the limit date
         1. We find the minimum plausible dbid by searching in !RecordType_Xml for the first dbid with !ExtraXml==""
         1.  the delete query where clause is:
   !ExtraXml = "" and !ServerDate < :dateLimit and :mindbid <= X.dbid and X.dbid < :maxdbid

   * On gr8x0 the current (typical rate) are (for a Transfer record database):
      * !JobUsageRecord_Xml 10000 rows per second (so for a typical transaction time of 10s).
      * !JobUsageRecord_Meta  120 rows per second (so for a typical transaction time of  9s).
      * The other deletion are more than 1000 rows per seconds such that the total time is completely dominated by _Meta.

   * Add index !ComputeElement(!UniqueID, !Timestamp)

   * Fix lifetime of RMI proxy object used for inter-service communication.

---+++ Pending explicit request from Stakeholders.
   * Improve response time of Status page.
   * Automatic table optimization (schedulable, abortable, triggerable) [Insert will be disabled during optimization]
   * Automatic sync of !VONameCorrection table and info OIM.

---+++ Notices

   * Web Services *must* be improved to pass the cert info along to the Gratia Accounting Probes.

---+ Anticipated downtime
It is expected that this release will require the Gratia services and reporting to be unavailable beginning at:
   * Start: %RELEASE_DATE%  09:00 CDT (14:00 UTC)
   * Available: %RELEASE_DATE% TBA

The changes affecting downtime for this release are:
   1. Installation and validation on each collector / reporter.
   1. Upgrade of each schema to add an index to !JobUsageRecord_Xml.

During this upgrade, the legacy redirectors dealing with probes sending to old addresses / ports will be decommissioned.

---+ Upgrade procedure

   1. Pre-load kernels on all VMs and dom0s.
   1. Deactivate, disable, shut down and remove configs from /etc/xen/auto gr12x2 and gr13x2, the HA legacy redirector VMs.
   1. Fail the reporting-DB IP over to the collector DB.
   1. Stop slave on reporting DB. Check no open temporary tables. Stop reporting DB.
   1. Institute IPtables rules on collector IPs to ignore SYNs on port 80/443.
   1. Wait 15 minutes or until there are no remaining connections to 80/443.
   1. Fail the reporting services over to the collector VMs (collector services will restart, reporting services will stop).
   1. Temporarily remove SYN-blocking.
   1. Reboot reporting dom0, ensuring heartbeat does not cause trouble as it comes back.
   1. Fail reporting-DB IP back to reporting DB.
   1. Stop slave on reporting DB. This will remain off until collector service is restored.
   1. Re-institute SYN-blocking on collector IPs 80/443.
   1. Upgrade reporting services *without* restarting.
   1. Wait 15 minutes or until there are no remaining connections to 80/443.
   1. Fail reporting services back to the reporting VMs, ensuring new reporting services start correctly.
   1. Shut down collectors on collector VMs and upgrade *without* restarting.
   1. Remove SYN-blocking.
   1. Deactivate auto-start of collectors (chkconfig tomcat-gratia off).
   1. Reboot collector dom0, ensuring heartbeat does not cause problems.
   1. Ensure collectors are configured to come back in collector-only mode.
   1. Start collectors.
   1. When all collectors are responding to incoming data, fail reporting-DB IP over to collector DB.
   1. Restart DB slave.
   1. When seconds_behind_master -> 0 fail reporting-DB IP back to reporting DB. 

%STOPINCLUDE%

<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
---++!! Major updates
<!--Future editors should add their signatures beneath yours!-->

%META:TOPICMOVED{by="ChrisGreen" date="1279056653" from="Accounting.GratiaReleaseV1dot06dot16" to="Accounting.GratiaReleaseV1dot06"}%
