%META:TOPICINFO{author="JohnWeigand" date="1207151115" format="1.1" reprev="1.4" version="1.4"}%
<!--
These are general in nature and should be changed in the this template if the location changes:
   * Set CURRENT_TOMCAT = ==gratia09==
   * Set CURRENT_MYSQL = __gratia06__
   * Set NEW_TOMCAT = ==gratia07==
   * Set NEW_MYSQL = __ gratia07__
   * Set TOMCAT_ALIAS = ==gratia.opensciencegrid.org==
   * Set MYSQL_ALIAS = ==gratia-db01.fnal.gov==
   * Set RELEASE_TAR_REPOSITORY = /afs/fnal.gov/files/expwww/gratia/html/Files

These are specific to a release and require changing:
   * Set RELEASE_DATE = 3/31/2008
   * Set CURRENT_RELEASE = v0.32.1c
   * Set RELEASE_TAG = v0-32-1c
   * Set NEXT_DEVEL_VERSION = v0.33
   * Set BUILD_DIRECTORY = /home/weigand/cdcvs/gratia-%CURRENT_RELEASE%
-->


---+!! Gratia Release %CURRENT_RELEASE% (%RELEASE_DATE% - 4/1/2008)%BR% 


%TOC%

%STARTINCLUDE%
---+ Overview
This release (%CURRENT_RELEASE%) is a maintenance release.

---++ Main New Features:
NONE. 
   
---++ Additional Features:
NONE.

---++ Technical changes affecting some of the listed features
   * 

<!--   -------------------------------------------- -->
---+ Anticipated downtime
It is expected that this release will require the Gratia services and reporting to be unavailable for a very brief (10 minute) period at the most.
   * Start: %RELEASE_DATE%  
   * Available: %RELEASE_DATE% 
   * %GREEN%<b>Actual: Start -  End -   </b>%ENDCOLOR%

The changes affecting downtime  for this release are:
   1 Length of time it takes to install the new software



<!--   -------------------------------------------- -->
---+ Collectors and Databases Affected

The following Gratia collectors and databases will be converted with this release:
%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}%
%EDITTABLE{  header="|*Schema*|*URL*|*Description*|" format="| text, 20 | text, 20 | text, 35 | text, 15 | text, 7 | text, 12 |"  changerows="on" quietsave="on" editbutton="Edit table" }%
|*Schema*|*<nop>MySql port*|*Collector URL*|*Collector host*|*Size (bytes)*|*Size (rows)*|
| fermi_itb | __gratia06__.fnal.gov:3320 | gratia-fermi.fnal.gov:8881 | gratia08.fnal.gov: |  208M |       29,295 |
| fermi_osg | __gratia06__.fnal.gov:3320 | gratia-fermi.fnal.gov:8880 | gratia08.fnal.gov |  19G |     7,904,799 |
| gratia_itb | __gratia06__.fnal.gov:3320 | gratia.opensciencegrid.org:8881 | gratia09.fnal.gov |  18G |    7,789,474 |
| gratia_osg_integration | __gratia06__.fnal.gov:3320 | gratia.opensciencegrid.org:8885 | gratia09.fnal.gov |  6.8G |    1,367,063 |
| gratia_qcd  | __gratia06__.fnal.gov:3320 | gratia-fermi.fnal.gov:8883 | gratia08.fnal.gov |  3.7G |      1,037,382 |

%BR%

The following Gratia collectors and databases will <b>NOT</b> be converted with this release.  The _gratia_ collector will be upgraded to the new software as part of the conversion to <nop>InnoDB. %BR%
%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}%
%EDITTABLE{  header="|*Schema*|*URL*|*Description*|" format="| text, 20 | text, 20 | text, 35 | text, 15 | text, 7 | text, 12 |"  changerows="on" quietsave="on" editbutton="Edit table" }%
|*Schema*|*<nop>MySql port*|*Collector URL*|*Collector host*|*Size (bytes)*|*Size (rows)*|
| gratia | __gratia06__.fnal.gov:3320 | gratia.opensciencegrid.org:8880 | gratia09.fnal.gov |     73G  |   58,252,407 |


%BR%
The following Gratia collectors and databases will __NOT__  be converted with this release.  These repositories contained specialized reports that have not as yet been upgraded to the new Birt V2.2 software. They will not be affected by this upgrade.%BR%

%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}%
%EDITTABLE{  header="|*Schema*|*URL*|*Description*|" format="| text, 20 | text, 20 | text, 35 | text, 15 | text, 7 |  text, 12 |"  changerows="on" quietsave="on" editbutton="Edit table" }%
|*Schema*|*<nop>MySql port*|*Collector URL*|*Collector host*|*Size (bytes)*|*Size (rows)*|
| gratia_psacct | __gratia06__.fnal.gov:3320 | gratia-fermi.fnal.gov:8882 | gratia08.fnal.gov: |  11G |    6,356,555 |
| gratia_osg_daily | __gratia06__.fnal.gov:3320 | gratia.opensciencegrid.org:8884 | gratia09.fnal.gov |   .8G |       83,383      |



<!-- BUILD DISTRIBUTION -------------------- -->
---+ Build the %CURRENT_RELEASE% for distribution
<ol>
<li>Make sure your build area contains all _committed_ changes.
<ul><li>cvs update</li></ul>
</li>

<li>In _gratia/build-scripts/Makefile_ , change the _version_default_ to:
<ul><li>version_default = %NEXT_DEVEL_VERSION%</li>
       <li>commit the change</li>
</ul>

The reason for using a version number 1 more than the current release is so that all development that occurs after this release will have the odd numbered development release (%NEXT_DEVEL_VERSION%).

The current release (%CURRENT_RELEASE%) __will__ get assigned  properly when the _cvs export_ is performed after the tagging occurs.
</li>

<li>Tag the release:
<ul><li>cvs tag -R %RELEASE_TAG% gratia</li></ul>
       This tags everything that is in your build directory and presumably tested.
</li>

<li> _Into a *new* area_, export the tagged release:
<ul><li>cvs export -d gratia-%CURRENT_RELEASE% -r %RELEASE_TAG% gratia</li></ul>
</li>

<li>Build it for the release (this insures that tar files are produced for VDT):
<ul><li>cd gratia-%CURRENT_RELEASE%/build-scripts</li>
<li>source setup-jdk15.sh</li>
<li>make release</li></ul>
</li>

<li>Copy the built tar files to the release area:
<ul><li>scp ../target/*_%CURRENT_RELEASE%.tar   flxi07.fnal.gov:%RELEASE_TAR_REPOSITORY%/</li></ul> 
%RED%<b>This step is NOT being done for this point release</b>%ENDCOLOR%
</li>

<li>Update the version number on the [[InstallationGuideVDT][services release TWiki page]]:</li>
<ul><li>Edit and update the TWiki variable _<nop>ReleaseVersion_.</li></ul>
%RED%<b>This step is NOT being done for this point release</b>%ENDCOLOR%
</ol>

%GREEN%<b>Done: 3/31/08 11:45 CDT </b>%ENDCOLOR%


<!-- ----------------- UPGRADE AND IMPLEMENTATION ------------- -->
---+ Upgrade and implementation
The __upgrades should be single-threaded__ , that is, performed for each database schema one at a time.  

We will perform these upgrades based on the size of the individual database schema, in ascending order.

<!-- 
   * Set TC_NODE1      = <b>gratia08</b>
   * Set TC_INSTANCE1 = <b>fermi_itb</b>
-->
---++ For %TC_INSTANCE1% on %TC_NODE1%:
  <ol type="a">
   <li> Stop the tomcat init.d service for the Gratia collector:
   * service tomcat-%TC_INSTANCE1%  stop
  </li>

  <li>Save off the logs under each tomcat instance and empty the _log_ directory.  
   * date=`date '+<nop>%Y<nop>%m<nop>%d'`
   * cd        /data/tomcat-%TC_INSTANCE1%/logs/
   * tar zcf /data/gratia_tomcat_logs_backups/tomcat-%TC_INSTANCE1%.$date.tgz   *
   * rm -f *

  <li>Install the new software on the Gratia tomcat instance:
%BR% pswd=xxx
%BR% source=%BUILD_DIRECTORY%
%BR% pgm=%BUILD_DIRECTORY%/common/configuration/update-gratia-local 
%BR% $pgm  -d $pswd -S $source  %TC_INSTANCE1%
  </li>

   <li> Start  the tomcat init.d service for the Gratia collector:
   * service tomcat-%TC_INSTANCE1%  start
   * When the tomcat service initializes, it will detect any schema changes have been effected and a conversion process will begin. 
   * _tail_ the  _catalina.out_ log. When the conversion process completes the log will show the following message:%BR%
       "INFO: Server startup in _xxx_ms"
  </ol>
  %GREEN%<b>Start: 3/31/08 16:09  End: 3/31/08 16:12  </b>%ENDCOLOR%
</li>



<!-- 
   * Set TC_NODE2       = <b>gratia08</b>
   * Set TC_INSTANCE2 = <b>fermi_osg</b>
-->
---++ For %TC_INSTANCE2% on %TC_NODE2%:
  <ol type="a">
   <li> Stop the tomcat init.d service for the Gratia collector:
   * service tomcat-%TC_INSTANCE2%  stop
  </li>

  <li>Save off the logs under each tomcat instance and empty the _log_ directory.  
   * date=`date '+<nop>%Y<nop>%m<nop>%d'`
   * cd        /data/tomcat-%TC_INSTANCE2%/logs/
   * tar zcf /data/gratia_tomcat_logs_backups/tomcat-%TC_INSTANCE2%.$date.tgz   *
   * rm -f *

  <li>Install the new software on the Gratia tomcat instance:
%BR% pswd=xxx
%BR% source=%BUILD_DIRECTORY%
%BR% pgm=%BUILD_DIRECTORY%/common/configuration/update-gratia-local 
%BR% $pgm  -d $pswd -S $source  %TC_INSTANCE2%
  </li>

   <li> Start  the tomcat init.d service for the Gratia collector:
   * service tomcat-%TC_INSTANCE2%  start
   * When the tomcat service initializes, it will detect any schema changes have been effected and a conversion process will begin. 
   * _tail_ the  _catalina.out_ log. When the conversion process completes the log will show the following message:%BR%
       "INFO: Server startup in _xxx_ms"
  </ol>
  %GREEN%<b>Start: 3/31/08 16:16     End: 3/31/08 16:18   </b>%ENDCOLOR%
</li>



<!-- 
   * Set TC_NODE3      = <b>gratia08</b>
   * Set TC_INSTANCE3 = <b>qcd</b>
-->
---++ For %TC_INSTANCE3% on %TC_NODE3%:
  <ol type="a">
   <li> Stop the tomcat init.d service for the Gratia collector:
   * service tomcat-%TC_INSTANCE3%  stop
  </li>

  <li>Save off the logs under each tomcat instance and empty the _log_ directory.  
   * date=`date '+<nop>%Y<nop>%m<nop>%d'`
   * cd        /data/tomcat-%TC_INSTANCE3%/logs/
   * tar zcf /data/gratia_tomcat_logs_backups/tomcat-%TC_INSTANCE3%.$date.tgz   *
   * rm -f *

  <li>Install the new software on the Gratia tomcat instance:
%BR% pswd=xxx
%BR% source=%BUILD_DIRECTORY%
%BR% pgm=%BUILD_DIRECTORY%/common/configuration/update-gratia-local 
%BR% $pgm  -d $pswd -S $source  %TC_INSTANCE3%
  </li>

   <li> Start  the tomcat init.d service for the Gratia collector:
   * service tomcat-%TC_INSTANCE3%  start
   * When the tomcat service initializes, it will detect any schema changes have been effected and a conversion process will begin. 
   * _tail_ the  _catalina.out_ log. When the conversion process completes the log will show the following message:%BR%
       "INFO: Server startup in _xxx_ms"
  </ol>
  %GREEN%<b>Start: 4/1/08 07:38      End: 4/1/08 07:40   </b>%ENDCOLOR%
</li>




<!-- 
   * Set TC_NODE4       = <b>gratia09</b>
   * Set TC_INSTANCE4 = <b>itb</b>
-->
---++ For %TC_INSTANCE4% on %TC_NODE4%:
  <ol type="a">
   <li> Stop the tomcat init.d service for the Gratia collector:
   * service tomcat-%TC_INSTANCE4%  stop
  </li>

  <li>Save off the logs under each tomcat instance and empty the _log_ directory.  
   * date=`date '+<nop>%Y<nop>%m<nop>%d'`
   * cd        /data/tomcat-%TC_INSTANCE4%/logs/
   * tar zcf /data/gratia_tomcat_logs_backups/tomcat-%TC_INSTANCE4%.$date.tgz   *
   * rm -f *

  <li>Install the new software on the Gratia tomcat instance:
%BR% pswd=xxx
%BR% source=%BUILD_DIRECTORY%
%BR% pgm=%BUILD_DIRECTORY%/common/configuration/update-gratia-local 
%BR% $pgm  -d $pswd -S $source  %TC_INSTANCE4%
  </li>

   <li> Start  the tomcat init.d service for the Gratia collector:
   * service tomcat-%TC_INSTANCE4%  start
   * When the tomcat service initializes, it will detect any schema changes have been effected and a conversion process will begin. 
   * _tail_ the  _catalina.out_ log. When the conversion process completes the log will show the following message:%BR%
       "INFO: Server startup in _xxx_ms"
  </ol>
  %GREEN%<b>Start: 4/1/08 07:42     End: 4/1/08 07:44   </b>%ENDCOLOR%
</li>




<!-- 
   * Set TC_NODE5       = <b>gratia09</b>
   * Set TC_INSTANCE5 = <b>osg_integration</b>
-->
---++ For %TC_INSTANCE5% on %TC_NODE5%:
  <ol type="a">
   <li> Stop the tomcat init.d service for the Gratia collector:
   * service tomcat-%TC_INSTANCE5%  stop
  </li>

  <li>Save off the logs under each tomcat instance and empty the _log_ directory.  
   * date=`date '+<nop>%Y<nop>%m<nop>%d'`
   * cd        /data/tomcat-%TC_INSTANCE5%/logs/
   * tar zcf /data/gratia_tomcat_logs_backups/tomcat-%TC_INSTANCE5%.$date.tgz   *
   * rm -f *

  <li>Install the new software on the Gratia tomcat instance:
%BR% pswd=xxx
%BR% source=%BUILD_DIRECTORY%
%BR% pgm=%BUILD_DIRECTORY%/common/configuration/update-gratia-local 
%BR% $pgm  -d $pswd -S $source  %TC_INSTANCE5%
  </li>

   <li> Start  the tomcat init.d service for the Gratia collector:
   * service tomcat-%TC_INSTANCE5%  start
   * When the tomcat service initializes, it will detect any schema changes have been effected and a conversion process will begin. 
   * _tail_ the  _catalina.out_ log. When the conversion process completes the log will show the following message:%BR%
       "INFO: Server startup in _xxx_ms"
  </ol>
  %GREEN%<b>Start: 4/1/08 07:47     End: 4/1/08 07:49   </b>%ENDCOLOR%


<!-- ----------------- POST MORTEM  ------------- -->
---+ Post-mortem
At this time, this will appear to be random notes.  After the conversion, they may be organized.

<ol>
<li>osg_integration instance problems with replicated data.

The osg_integration instance (http://gratia.opensciencegrid.org:8885/gratia-reporting/) is experiencing problems with the v0.32.1c conversion.  All the other databases appear ok.

We had turned back on, late last week, the replication of specific gratia_itb probes to osg_integration and all was doing well.  Now it appears that this instance is getting into strange state when processing the replicated data.

Symptoms:
   * the http://gratia.opensciencegrid.org:8885/gratia-administration page would never render... it would just spin
   * the hibernate log shows many many  many of these errors which can be viewed in /data/gratia_tomcat_logs_backups/osg_integration, which are the logs I saved this morning
<pre>
2008-04-02 01:13:41,003 org.hibernate.util.JDBCExceptionReporter [WARN]: SQL Error: 1062, SQLState: 23000
2008-04-02 01:13:41,003 org.hibernate.util.JDBCExceptionReporter [ERROR]: Duplicate entry 'F8F4C00A065268D4C189E6F440A33B54' for key 2
</pre>
I turned off ALL replication from gratia_itb to osg_integration this morning around 4/2 09:35. 

I am not certain this is related to the 0.32.1c version or is specific with replication or maybe a combination.
</li>

</ol>

%STOPINCLUDE%

<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
---++!! Major updates
<!--Future editors should add their signatures beneath yours!-->
-- Main.JohnWeigand - 31 Mar 2008%BR%
