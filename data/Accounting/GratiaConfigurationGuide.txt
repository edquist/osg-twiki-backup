%META:TOPICINFO{author="KyleGross" date="1225985921" format="1.1" version="1.7"}%
---+!! *<nop>%SPACEOUT{ "%TOPIC%" }%*

<!--
   * Set EDITTHISTEXT = <div class="twikiSmall"><a href="%TOPIC%">edit this section</a></div>
-->

%TOC%

%STARTINCLUDE%

%BR%
---+ _%SPACEOUT{ "%TOPIC%" }%_
%EDITTHISTEXT%
%BR%
There are several attributes you may wish to configure before accepting accounting data from the Gratia probes.  This are in the
The =$VDT_LOCATION/tomcat/v55/gratia/service-configuration.properties= file.  This topic will not cover all of them as the file contains a reasonable explanation of each attribute.  It will just cover a couple you may want to look at initially.
   * Connections
   * Monitoring

Additionally, if you are installing remote installation for the purpose of capturing your local accounting data and then forwarding selected accounting data to the OSG or ITB instances of Gratia, you will be need to do 2 additional steps:
   * Change your Gratia probes to report to your instance of a remote/local  Gratia collector
   * Set up Gratia replication to forward selective probes to the OSG or ITB Gratia collectors.

---++ Connections
You have two ports by which you can access the Gratia reporting and administration services that are     defined by these attributes in the file:
   * service.open.connection (defaults to 8880);
   * service.secure.connection (defaults to 8443).

These are pre-set during installation by the =$VDT_location/vdt/setup/configure_gratia= script.

---++ Monitoring
The attributes control whether or not to have Gratia post an email if it hasn't received
a job usage record from a probe within a specified amount of time.

These attributes are not set in the =configure_gratia= script and should be changed.  They are:
   * monitor.smtp.server=YOUR-SMTP-SERVER
   * monitor.smtp.authentication.required=false
   * monitor.smtp.user=EMAIL-USER-NAME
   * monitor.smtp.password=EMAIL-PASSWORD
   * monitor.from.address=FROM-EMAIL-ADDRESS
   * monitor.to.address.0=TO-EMAIL-ADDRESS
   * monitor.subject=EMAIL-SUBJECT

---++ Changing your Gratia probes
To start reporting the accounting data to your local/remote Gratia collector, you will need to change the configuration file for your Gratia probes.  All references to VDT_LOCATION in this section of the document refer to the installation on your CE node or worker node if you have glexec probes configured.

*VERY VERY IMPORTANT: Before you do this, you need to insure that all accounting data for each probe as been reported to the current collector.*  

On each host that you will be changing to report to your local Gratia collector, you will do the following to insure that all data has been transferred:

1. Verify that there are no probe records in the gratia queue (this would only occur if the current collector has been unavailable).
       There should be no files in =$VDT_LOCATION/gratia/var/tmp/gratiafiles= . If there are files here, you will want to wait until these have been process by your Gratia probe cron service entry.  When there are no files in the queue, you can proceed.

2. Comment or remove the Gratia probe cron process for your scheduler, named gratia-&lt;scheduler&gt;.%BR%
       For example, the command to disable a condor probe is =vdt-control --off gratia-condor=
   
3. You can now make the changes to =ProbeConfig= file necessary to report to your local/remote collector.
The configuration file for the various probes are shown here:
| %BLUE%<b>Probe</b>%ENDCOLOR% | %BLUE%<b>$VDT_LOCATION/gratia/probe</b>%ENDCOLOR% |
| Condor | ./condor/<nop>ProbeConfig|
| PBS | ./pbs/<nop>ProbeConfig |
| LSF | ./lsf/<nop>ProbeConfig |
| SGE | ./sge/<nop>ProbeConfig |
| gLexec| ./glexec/<nop>ProbeConfig |
| metric| ./metric/<nop>ProbeConfig | 
%RED%<strong>Note</strong>%ENDCOLOR% that the metric probe reports to the official OSG RSV collector at GOC, Indiana. It's highly unlikely that you would want to collect this information locally since there are no graphical reports for this data type.

There are 3 attributes that need to be changed to report to your local/remote collector based on the attributes specified in the =service-configuration.properties= file:
| %BLUE%<b><nop>ProbeConfig%BR% attribute</b>%ENDCOLOR% | %BLUE%<b>service-configuration.properties%BR% attribute</b>%ENDCOLOR% |
| <nop>SSLHost | service.secure.connection |
| <nop>SSLRegistrationHost |service.open.connection |
| <nop>SOAPHost | service.open.connection |

4. Uncomment your Gratia probe cron service or run vdt-control --on for the relevant probe.

You will now be reporting to your local collector for each of these hosts. You can verify this by going the Gratia administration web service for the collector.  You may have to wait for the cron job, which runs every ten minutes.

If you will be forwarding this accounting data to the OSG or ITB Fermilab Gratia Collectors, you will need to set up replication as described in the next section.




---++ Setting up Gratia replication
Gratia has the ability to replicate it&#8217;s database contents (actually, the <nop>JobUsageRecords) to another instance of Gratia running &#8220;out there somewhere&#8221;. This replication service can be found on the gratia-administration web service menu. 

Assuming your database is the source, and the OSG/ITB Gratia collector at Fermilab is the target:

1. Under the =Replication= menu, select =Job Usage Replication= or =Metric Replication= depending on the accounting data you wish to forward.

2. On the =Replication= screen, under =Remote Host=, you will add an entry and then click on the =Update= button.

If you are forwarding to the central Gratia OSG services, these are the URLs for the respective collectors:
      %TABLE%
      | Grid | !JobUsageRecord | !MetricRecord |
      | ITB | http://gratia.opensciencegrid.org:8881 | rsv-itb.grid.iu.edu:8880 |
      | OSG | http://gratia.opensciencegrid.org:8880 | rsv.grid.iu.edu:8880 |

3.Then, for your entry, select =Test= under the =Options= column on the far right.

Your server will send a dummy transaction to the remote host and let you know whether or not the connection was made.

It should indicate either success or failure.  A failure means either your entry was incorrect or the =Remote Host= is not available.  If it is not your entry, contact the Gratia administrator of the remote host or try to access it via your web browser.

4. Now you will select the probes that you want to forward. 

Under the =Probe Name= column, you can specify selective probes, probes for specific VOs or All.  Press the =Update= button to add the entry to the database.

<b>NOTE:</b> If do not specify =All=, you will need to create a replication entry for each probe or VirtualOrganizations/VOInfo you desire to forward.  This means repeating steps 2 through 5.

5. Finally, start the replication process by using the =Start= button under the =Options= column. Replication should start within a minute or so. You can stop the process with the =Stop= link (which will also take a minute or so).

From our testing gratia can replicate roughly 2000 records per minute for each active replication entry.

You can view the status of your Replication entries by viewing:
   * =Running= column which indicates naturally if it is running or not
   * =DBID= column indicating the last =dbid= (key of the <nop>JobUsageRecord table) sent
   * =Row Count= column indicating the number of replication entries sent










%STOPINCLUDE%

-- Main.JohnWeigand - 24 Apr 2008
