%META:TOPICINFO{author="KarthikArun" date="1300294588" format="1.1" reprev="1.3" version="1.3"}%
---+!! Accounting data workflow from OSG to WLCG

%TOC%

%STARTINCLUDE%

---++ Introduction
There is some confusion about how the OSG accounting data is being collected, processed and sent over to WLCG accounting portal. This documentation is an effort to try to explain that process. Please also look at the <a href=https://twiki.grid.iu.edu/bin/view/Accounting/GratiaInterfacesApelLcg>APEL/WLCG document</a>, which explains the bulk of the process that is done in order to send data from OSG to the WLCG. Other useful references are also provided at the bottom of this page. 

---++ Accounting data workflow from OSG to WLCG

<ol>
<li> Every OSG site publishes its sub cluster information (CPU model, # of
cores etc.) in the "Subclusters" section of the OSG config.ini file.
This information is sent to the GIP.
          
<li> A normalization factor (NFgip) is arrived at based on the SI2K value
calculated for the different sub clusters. For example for WT2 NFgip is
3.197. This NF value is used to convert the raw CPU time and wall time
into a Normalized value representing a fair means of comparing data
across a wide variety of grid clusters.

<li> Simultaneously the gratia probes at the site collect job data (Number
of jobs, CPU time, Wall time, VO, time etc.) and send it over to the
central gratia collector.

 <li> The WLCG script that runs at FNAL extracts the gratia data, adjusts
(multiples to be exact) it using the normalization factor (not sure why
3.424 is used for WT2 instead of 3.197) and sends it over to WLCG. This
is done once a day. The data sent is cumulative for that month. For    
example here is the data that would be sent over to WLCG for WT2 if the
script executes now.

<table bgcolor=black cellspacing=1 cellpadding=3>
<tr bgcolor=white><td>
ExecutingSite   </td><td> WT2
</td></tr><tr bgcolor=white><td>
LCGUserVO       </td><td> usatlas
</td></tr><tr bgcolor=white><td>
Sum(NJobs)      </td><td> 81925
</td></tr><tr bgcolor=white><td>
SumCPU          </td><td> 91181
</td></tr><tr bgcolor=white><td>
NormSumCPU      </td><td> 311838
</td></tr><tr bgcolor=white><td>
SumWCT          </td><td> 102069
</td></tr><tr bgcolor=white><td>
NormSumWCT      </td><td> 349074
</td></tr><tr bgcolor=white><td>
Month           </td><td> 03
</td></tr><tr bgcolor=white><td>
Year            </td><td> 2011
</td></tr><tr bgcolor=white><td>
RecordStart     </td><td> 2011-03-01
</td></tr><tr bgcolor=white><td>
RecordEnd       </td><td> 2011-03-05
</td></tr><tr bgcolor=white><td>
Normalization   </td><td> 3.42
</td></tr><tr bgcolor=white><td>
NOW()           </td><td> 2011-03-05
</td></tr></table>
   
<li> More insight needs to be gained into the workflow on the WLCG side like   
how the data is being used to generate the reports etc. If the 
understanding is right, WLCG multiples the NF calculated using SI2K by
4 (13.696 for WT2) and uses it as the HS06 NF equivalent.
</ol>

---++The source of inaccuracy  (update as of Tue, 15th Mar 2011)

This is based on the comparison of WT2's data from 1/3/11 to 5/3/11 using two different sources. One source is the local site collection done by Wei Yang and the other is the data collected by gratia/OSG and sent over to WLCG. The data (Njobs, Raw CPU hours) more or less match. But the issue seems to be the following:

The weighted average HS06 normalization factor for WT2 (as calculated by Wei) is 9.5 for WT2. This is calculated as shown below:

<table bgcolor=black cellspacing=1>
<tr bgcolor=white><td>
Subcluster</td><td>Cores</td><td>   HS06</td><td>    Raw CPU hours
</td></tr><tr bgcolor=white><td>
hequ           </td><td> 1472 </td><td>   15.01</td><td>   38645
</td></tr><tr bgcolor=white><td>
fell        </td><td>    2280  </td><td>  7.45  </td><td>  49061
</td></tr><tr bgcolor=white><td>
boer      </td><td>      540  </td><td>   7.92 </td><td>   2487
</td></tr><tr bgcolor=white><td>
bali         </td><td>   288  </td><td>   7.92  </td><td>  1200
</td></tr><tr bgcolor=white><td>
yili     </td><td>       624 </td><td>    6.08 </td><td>   1035
</td></tr>
</table>

Total cores     5204<br>
Weighted average HS06 = (1472*15.01 + 2280*7.45 + 540*7.92 + 288*7.92 + 624*6.08)/5204 = 9.50

But currently the SI2K based normalization factor reported to WLCG is
3.42, which when multiplied by 4 yields 13.68. This is a hefty scaling up of 44%.

(13.68 - 9.5)*100/9.5 = 44%

I could see a 42% difference between the data (the 2% could be explained by the above inaccuracy due to the time at which the snapshot was taken).

HS06 * raw cpu hours
------------------------------
<b>Reported by WLCG</b> = 91181 * 13.68 = 1247352 Measured at WT2  = 92428* 9.5    = 877967<br>
<b>Difference</b> = (1247352 - 877967)*100/877967 = 42%<br>

So the inaccuracy is introduced by the *inability* to accurately represent the HS06 normalization factor in terms of the measured KSI2K normalization factor. The
multiplication factor of 4 all across the board seems to be more of a convenience factor than a customized one. The solution to this could emerge if we measure and
report everything directly using HS06 and get rid of KSI2K to HS06 conversions. Otherwise we would be comparing apples to oranges.

---++Steps to the solution:
<ul>
<li>All sites report subcluster information to GIP as they currently do now
<li>GIP should directly calculate the HS06 normalization factor based on this data
<li>The Gratia APEL/WLCG interface should report this HS06 normalization factor instead of the inaccurate 4*KSI2K factor.
</ul>

Once this is done, at least we will have a way to compare apples to apples and see if the data reported from WLCG is what it is supposed to be. If not, we could dig
into the other components of the workflow.

---++Questions
<ul>
<li> Workflow on the WLCG side after receiving data from OSG and how this data is used to create the WLCG report
<li> Details about how gratia accounts for hyperthreaded or multicore jobs
<li> How exactly does GIP calculate the Normalization factor for a site?
<li> Why is WT2 using 3.424 instead of 3.197 as its normalization factor?
<li> Why is the normalization fator still calculated based on KSI2K and not HS06?
</ul>

---++ References
<a href=https://twiki.grid.iu.edu/bin/view/Accounting/GratiaInterfacesApelLcg>Gratia Interfaces APEL/LCG</a><br>
<a href=http://t2.unl.edu/gratia/wlcg_reporting>WLCG reporting page at Nebraska</a><br>
<a href=http://www3.egee.cesga.es/gridsite/accounting/CESGA/tier1_view.html>EGEE tier1</a><br>
<a href=http://www3.egee.cesga.es/gridsite/accounting/CESGA/tier2_view.html>EGEE tier2</a><br>
<a href=http://t2.unl.edu/gratia/site_normalization>GIP site normalization</a><br>


-- Main.KarthikArun - 05 Mar 2011

   * Accounting data workflow from OSG to WLCG: <br />
     <img src="%ATTACHURLPATH%/OSGToWLCGWorkFlow.gif" alt="OSGToWLCGWorkFlow.gif" width='576' height='480' />    

%META:FILEATTACHMENT{name="OSGToWLCGWorkFlow.gif" attachment="OSGToWLCGWorkFlow.gif" attr="" comment="Accounting data workflow from OSG to WLCG" date="1299361423" path="OSGToWLCGWorkFlow.gif" size="8604" stream="OSGToWLCGWorkFlow.gif" tmpFilename="/usr/tmp/CGItemp53106" user="KarthikArun" version="1"}%
