%META:TOPICINFO{author="JohnWeigand" date="1195491260" format="1.1" reprev="1.15" version="1.15"}%
%META:TOPICPARENT{name="WebHome"}%

---+!! Gratia Release %CURRENT_RELEASE% (for <nop>InnoDB)%BR% 
%RED%UNDER CONSTRUCTION AND REVIEW%ENDCOLOR%

%TOC%

%STARTINCLUDE%
---+ Overview
The main purpose of this release is to put in service the static reports and to fix several issues with the existing reports, including the annoying extra slides bars.

---++ Main New Features:
   * <strike>Convertion to !InnoDB</strike>
   * Version Number visible in interface (Penelope)
   * Fixed displays (Penelope)
   * Consistent display of multi graphs report (Jeff)

---++ Additional Features:
   * Fix slides bar issues 
   * Add title for featured reports (End of Report Request #7) 
   * packaging of !DCache probe(s)
   * 'live' compression of history and backup directories
   * Several bugs fixes and visual improvement to the reports.

<!--   -------------------------------------------- -->
---+ Anticipated downtime
It is expected that this release will require the Gratia services and reporting to be unavailable beginning at:
   * Start: 11/20/2007 (Tuesday) 17:00 CST.
   * Available: 11/20/2007 (Tuesday) 23:00 CST.

The changes affecting downtime  for this release are:
   1 Length of time to make a backup of the database to the backup area using =mysqlhotcopy=
   1 Installation and validation on the 6 Gratia schemas




<!--   -------------------------------------------- -->
---+ Collectors and Databases Affected

The following Gratia collectors and databases will be converted with this release:
%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}%
%EDITTABLE{  header="|*Schema*|*URL*|*Description*|" format="| text, 20 | text, 20 | text, 35 | text, 15 | text, 5 | text, 15 |"  changerows="on" quietsave="on" editbutton="Edit table" }%
|*Schema*|*<nop>MySql port*|*Collector URL*|*Collector host*|*Size (bytes)*|*Size (rows)*|
| fermi_itb | gratia06.fnal.gov:3320 | gratia-fermi.fnal.gov:8881 | gratia08.fnal.gov: |  868K |               1 |
| fermi_osg | gratia06.fnal.gov:3320 | gratia-fermi.fnal.gov:8880 | gratia08.fnal.gov: |  5.0G |   2,554,484 |
| gratia | gratia06.fnal.gov:3320 | gratia.opensciencegrid.org:8880 | gratia09.fnal.gov |  60.0G |  30,226,750 |
| gratia_itb | gratia06.fnal.gov:3320 | gratia.opensciencegrid.org:8881 | gratia09.fnal.gov 3.5 |  9.2G |   2,796,812 |
| gratia_osg_integration | gratia06.fnal.gov:3320 | gratia.opensciencegrid.org:8885 | gratia09.fnal.gov |  3.5G |      905,703 |
| gratia_qcd  | gratia06.fnal.gov:3320 | gratia-fermi.fnal.gov:8883 | gratia08.fnal.gov: |  2.2G |      817,080 |

%BR%
The following Gratia collectors and databases will __NOT__  be converted with this release.  These repositories contained specialized reports that have not as yet been upgraded to the new Birt V2..2 software. __However__, they will be taken out-of-service while the other databases are being updated.%BR%

%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}%
%EDITTABLE{  header="|*Schema*|*URL*|*Description*|" format="| text, 20 | text, 20 | text, 35 | text, 15 | text, 5 |  text, 15 |"  changerows="on" quietsave="on" editbutton="Edit table" }%
|*Schema*|*<nop>MySql port*|*Collector URL*|*Collector host*|*Size (bytes)*|*Size (rows)*|
| gratia_psacct | gratia06.fnal.gov:3320 | gratia08.fnal.gov:8882 | gratia08.fnal.gov: |  6.6G |     4,144,690 |
| gratia_osg_daily | gratia06.fnal.gov:3320 | gratia.opensciencegrid.org:8884 | gratia09.fnal.gov |  65.0M |    56,300     |

<!--   PRE-CONVERSION STEPS -------------------- -->
---+ Pre-Conversion steps
<ol>
<li>Build the %CURRECT_RELEASE% Release
</li>
</ol>


<!--   CONVERSION STEPS -------------------- -->
---+ Conversion steps
This release only involves the installation of new software as described in the feature list above.


<!-- ----------------- SHUTDOWN AND DATABASE BACKUP ------------- -->
---++ Shutdown and database backup.
  <ol type="1">
    <li>On _gratia06_ , __comment__ out the __gratia__ user cron jobs.
<pre class="screen">
0 0 1-15 * *   dir=/home/gratia/interfaces/apel-lcg; cd $dir; ./lcg.sh --config=lcg.conf --date=previous --update
30 01 * * *   dir=/home/gratia/interfaces/apel-lcg; cd $dir; ./lcg.sh --config=lcg.conf --date=current --update
</pre>
</li>
    <li>On _gratia06_ , __comment__ out the _mysqlhotcopy__cron_  __root__ user cron entry.
<pre class="screen">
43 2 * * * /usr/local/bin/mysqlhotcopy_cron.sh &gt; /var/log/mysqlhotcopy.out 2&gt; &1
</pre>
</li>

     <li> For __ALL__ of the databases (  __including those not being upgraded__  ) ,  __stop__ the Gratia update services.%BR%
            - In your browser,  connect to the Gratia administrative services url for each of the databases.%BR%
            - Select the _System / Administration_ menu option in the left menu%BR%
            - Then scroll down to the _Starting/Stopping Database Update Services_ section and select the _Stop Update Services_ link.%BR%
 
      </li>

     <li> On *each* collector/tomcat host, *stop* the tomcat service for *ALL* Gratia collectors.
<pre class="screen">
On gratia09:
  service tomcat-gratia  stop
  service tomcat-itb  stop
  service tomcat-osg_daily  stop
  service tomcat-osg_integration stop

On gratia08:
  service tomcat-fermi_itb  stop
  service tomcat-fermi_osg stop
  service tomcat-ps  stop
  service tomcat-qcd stop
</pre>

</li>


   <li>Take a back up the database instance on _gratia06_ (this will include all schema) using part of the _msqlhotcopy_cron_ script from the command line as _root_ user.
            Backup will only being done to  _/backup/mysqldb_ on _gratia06_  in order to reduce the downtime.
      <pre class="screen">
mysqlhotcopy -p lisp01 --addtodest fermi_itb /backup/mysqldb       
mysqlhotcopy -p lisp01 --addtodest gratia_osg_daily /backup/mysqldb    
mysqlhotcopy -p lisp01 --addtodest gratia_qcd /backup/mysqldb     
mysqlhotcopy -p lisp01 --addtodest gratia_osg_integration /backup/mysqldb  
mysqlhotcopy -p lisp01 --addtodest fermi_osg /backup/mysqldb   
mysqlhotcopy -p lisp01 --addtodest gratia_psacct /backup/mysqldb   
mysqlhotcopy -p lisp01 --addtodest gratia_itb /backup/mysqldb   
mysqlhotcopy -p lisp01 --addtodest gratia /backup/mysqldb      
</pre>


Backup times:
%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}%
%EDITTABLE{  header="|*Schema*|*Expected Duration*|*Actual Duration*|" format="| text, 20 | text, 20 | text, 20 |"  changerows="on" quietsave="on" editbutton="Edit table" }%
|*Schema*|*Expected Duration*|*Actual Duration*|
| fermi_itb | 1 sec |  |
| gratia_osg_daily | 6 secs  |        |
| gratia_qcd  | 64 secs |    |
| gratia_osg_integration | 99 secs  |       |
| fermi_osg | 132 secs |  |
| gratia_psacct | 179 secs  |      |
| gratia_itb | 461 secs (8 min)  |    |
| gratia | 2900 secs (48+ min)   |  |

     </li>
</ol>

---++ Prerequisites steps
<ol>
<li> Determine the disk space requirements for the database on %NEW_MYSQL%.  Notify the administrator Steve Timm.</li>
<li>
</ol>

---++ Conversion steps
The procedure below has specific references to the conversion of the current Gratia database schema's from !MyISAM to !InnoDB and also contains software upgrades to Gratia.


---+++ !MySql database and Gratia Collector/Reporting Services Testing
<ol>
<li>For the new !MySql DBMS:%BR%
%BLUE% *Production downtime*: Steps 1b through  1e.%ENDCOLOR%
<ol type="a">
<li>Configure a new !MySQL instance on %NEW_MYSQL% with the desired !InnoDB and default engine parameters.
%BLUE%<li>Shutdown *ALL* collectors on %CURRENT_TOMCAT% and allow all threads to complete any database updates including the replication services.</li>
<li>Determine the last _dbid_ set in the  _JobUsageRecord_ and _MetricRecord_ tables.  These values will be used to start the Gratia replication process for Job Usage and Metrics in order to bring the new converted database back to a current state.  This can be performed by running the following sql commands on the %CURRENT_MYSQL% !MySql instance:</li>
<pre>
select max(dbid) from JobUsageRecord;
select max(dbid) from MetricRecord;
</pre>
<li>Take a standard tree copy of the mysqldb tree on %CURRENT_MYSQL% and copy it to %NEW_MYSQL% </li>
<li>Startup *ALL* collectors on %CURRENT_TOMCAT%.%ENDCOLOR%</li>
<li>On %NEW_MYSQL%, convert all tables to !InnoDB, timing the exercise.</li>
<li>Test to see if the new !InnoDB database can successfully be backed up via !TiBS and recovered</li>
</ol>

<li>For the new Gratia Collector/Reporting Tomcat services:</li>
<ol type="a">
<li>Install a new Gratia collector on %NEW_TOMCAT%.</li>
<li>Connect the  new collector/reporter (%NEW_TOMCAT%) to the converted !MySql DB (%NEW_MYSQL%).</li>
</ol>

<li> Test the collector and reporting services on the new instances (%NEW_TOMCAT%, %NEW_MYSQL%) based on the details in the [[#Testing_the_conversion][Testing the conversion section of this document]].</li>

</ol>

---+++ Gratia Collector/Reporting Conversion
<ol>
<li>Announce a downtime for the production collector long enough to allow the completion of steps [[#StepNum05][5]] through [[#StepNum09][9]].</li>

<li>Set up a replication process from the production collector to the temporary collector, with DBID carefully set to only replicate records
received since DB copy (manual DB interaction).</li>

<li>Stop updates to the production DB and shut down the production collector after allowing replication to the temporary collector to complete.</li>

<li>Remove the replication (manual DB interaction).</li>

<li>Shut down the temporary collector after it has received the last replicated records from the production collector and take a note of the latest DBID (manual DB interaction) in the usage records on the temporary DB.</li>

<li>Upgrade the production collector.</li>

<li>Connect the production collector to the converted DB and bring it back up to receive data.</li>
</ol>



---+ Testing the conversion
---++ Reporting
Testing of the Gratia reporting and administration services is  a manual process exercising the various reports/drill downs on all screens. This should be done in 2 stages:
<ol>
<li>Testing the basic functionality</li>
<ul>
<li>This should be done before the testing of the [[#Collector_Probes][Collector/Probes testing]].  </li>
<li>   </li>
</ul>
</ol>

---++ Collector/Probes
Testing of the Gratia collectors can be performed by activating the Job Usage and Metric Replication services on the production server (%CURRENT_TOMCAT%) for all database schema.

%STOPINCLUDE%

<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
---++!! Major updates
<!--Future editors should add their signatures beneath yours!-->
-- Main.JohnWeigand - 19 Nov 2007%BR%

%META:TOPICMOVED{by="JohnWeigand" date="1194902445" from="Accounting.GratiaReleaseInnodb" to="Accounting.GratiaReleaseV0dot30"}%
%META:PREFERENCE{name="CURRENT_TOMCAT" title="CURRENT_TOMCAT" type="Set" value="==gratia09=="}%
%META:PREFERENCE{name="CURRENT_MYSQL" title="CURRENT_MYSQL" type="Set" value="==gratia06=="}%
%META:PREFERENCE{name="NEW_TOMCAT" title="NEW_TOMCAT" type="Set" value="==gratia07=="}%
%META:PREFERENCE{name="NEW_MYSQL" title="NEW_MYSQL" type="Set" value="==gratia07=="}%
%META:PREFERENCE{name="TOMCAT_ALIAS" title="TOMCAT_ALIAS" type="Set" value="==gratia.opensciencegrid.org=="}%
%META:PREFERENCE{name="MYSQL_ALIAS" title="MYSQL_ALIAS" type="Set" value="==gratia-db01.fnal.gov=="}%
