%META:TOPICINFO{author="KyleGross" date="1225985921" format="1.1" version="1.10"}%
<!--
   * Set check =  <img src="/pub/TWiki/TWikiDocGraphics/choice-yes.gif" alt="DONE" title="DONE" width="16" height="16" border="0" /> 
-->
---+!! Gratia Access/Login Specification 

%TOC%

%STARTINCLUDE%
---+ Overview
This document is intended to serve as both a requirements and design specification for limiting access and visibility into the two web service user interfaces of Gratia: 
   * administration services
   * reporting services


---+ gratia-administration
The Gratia administration is accessible as http(s)://&lt;node.domain&gt;:&lt;port&gt;/gratia-administration.  It allows for viewing the status of the collector and for maintenance of several data tables.

---++ administration access requirements
The Gratia administration web user interface login will allow access to all update service menu options, otherwise only the read-only menu options will be available. 

%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}%
%EDITTABLE{  header="|*Menu option*|*No login required*|*Login required*|" format="| textarea, 5x30 | textarea, 5x50 | textarea, 5x50 |"  changerows="on" quietsave="on" editbutton="Edit table" }%
|*Menu option*|*No login required*|*Login required*|
| Maintenance<br />   * Site Table<br />   * VirtualOrganizations/VOInfo Management<br />   * VirtualOrganizations/VOInfoName correction |  |  <img src="/pub/TWiki/TWikiDocGraphics/choice-yes.gif" alt="DONE" title="DONE" width="16" height="16" border="0" />   |
| Probes<br />   * active, inactive or all<br />   * CPU Info<br />   * Roles |  |  <img src="/pub/TWiki/TWikiDocGraphics/choice-yes.gif" alt="DONE" title="DONE" width="16" height="16" border="0" />   |
| Authentication<br />   * Certificates |  |  <img src="/pub/TWiki/TWikiDocGraphics/choice-yes.gif" alt="DONE" title="DONE" width="16" height="16" border="0" />   |
| Replication<br />   * Job Usage Replication<br />   * Metric Replicatino |  |  <img src="/pub/TWiki/TWikiDocGraphics/choice-yes.gif" alt="DONE" title="DONE" width="16" height="16" border="0" />   |
| System<br />   * System status: normal or detailed |  <img src="/pub/TWiki/TWikiDocGraphics/choice-yes.gif" alt="DONE" title="DONE" width="16" height="16" border="0" />   |  |
| System<br />   * Administration |  |  <img src="/pub/TWiki/TWikiDocGraphics/choice-yes.gif" alt="DONE" title="DONE" width="16" height="16" border="0" />   |
| Documentation<br />   * Installation<br />   * Security<br />   * Replication<br />   * Gratia Service Settings |  <img src="/pub/TWiki/TWikiDocGraphics/choice-yes.gif" alt="DONE" title="DONE" width="16" height="16" border="0" />   |  |

<p>


 List of requirements.
   1 For an instance of a Gratia collector, at least one Gratia administrator must be defined.
   1 The Gratia administrators are identified and managed by the VO
   1 A user grid certificate will be used to identify the administrator

---++ administration access design
The identity of a Gratia administrator will be defined in the _TOMCAT_HOME/gratia/service-configuration.properties_ file.  
   * For Gratia instances servicing multiple VirtualOrganizations/VOInfo's, multiple entries are allowed
   * The identity of the Gratia administrator(s) will be defined by specifying the FQAN (Fully Qualified Attribute Name) as defined by the VO.  Note that "Capability=" is normally a part of the FQAN, but this attribute has been deprecated and thus will not be used. The top level group in the FQAN or the FQAN is, by convention within OSG, defined as the VirtualOrganizations/VOInfo name of the VirtualOrganizations/VOInfoMS server.
   * In order to insure that the most current list of administrative identities is always used this file should be read each time the login service is invoked (explicitly or implicitly).  An alternative method of insuring currency is to read the timestamp on the file and read it only when it has changed.
<pre>
  service-configuration.properties file entries:
  service.admin.FQAN.0=/cms/uscms/Role=gratiaadmin
  service.admin.FQAN.1=/cms/uscms/gratiaadmin/Role=NULL
  service.admin.FQAN.atlas=/atlas/usatlas/Role=gratiaadmin
  service.admin.DN.john=/DC=org/DC=doegrids/OU=People/CN=John Weigand 458491

  service.voms.connections=voms-servers

Note: the above entries show various examples of how the 
identity of the Gratia administrators can be defined within a VO:
    service.admin.FQAN.x = valid FQANs that give administrative access, 
                                       where x are unique numbers and/or letters

  service.voms.connections = file located in tomcat/gratia containing 
                                          the voms URL(s) for each VO specified

or simply using a DN:
  service.admin.DN.x = valid DNs that give administrative access, 
                                 where x are unique numbers and/or lettters
                                 the value 'ALLOW ALL' will give access to all who have a valid certificate
</pre>

The Gratia login process will need the identity of the OSG VirtualOrganizations/VOInfo VOMS servers in order to authenticate the identity of the user.          
   1 This will be in the form of an OS file located at _TOMCAT_HOME/gratia/_ 
   1 File name is defined by the key _service.voms.connections=voms-servers_ in the _service-configuration.properties_ file
   1 File permissions of 644
   1 The file will contain 2 tokens with whitespace as the delimiter. Contiguous whitespace is treated as a single delimiter.  
      * The 1st token is the VirtualOrganizations/VOInfo name which will be top level group of the FQAN defined by the _service.admin.FQAN.n_ key in the _service-configuration.properties_ file.
      * The 2nd token is the url of the VirtualOrganizations/VOInfo's VirtualOrganizations/VOInfoMS server.
   1 Initially, this file will be manually maintained.  In the long term, this file should be distributed by the OSG GOC.
   1 In order to insure that the most current list of VirtualOrganizations/VOInfoMS servers is always used this file should be read each time the login service is invoked (explicitly or implicitly).  An alternative method of insuring currency is to read the timestamp on the file and read it only when it has changed.
<pre>
<b>./gratia/voms-servers file:</b>
  # comment line
  atlas  https://voms.cern.ch:8443/voms/atlas
  cms    https://voms.cern.ch:8443/voms/cms
  geant4 https://voms.cern.ch:8443/voms/geant4
</pre>

The user identity requesting login access will be retrieved from a grid certificate imported in their browser. The DN (subject) of the certificate and CA (issuer) of the certificate, in the following form, will be used:
<pre>
DN: /DC=org/DC=doegrids/OU=People/CN=John Weigand 458491
CA: /DC=org/DC=DOEGrids/OU=Certificate Authorities/CN=DOEGrids CA 1
</pre>

The procedure for logging in for the "happy-day" scenario is:
   1 When the administration page is initially accessed, the _Status: normal_ page will be presented and at the left frame menu a list of  menu options.  The options displayed in gray color are those requiring login. The _logout_ option is also displayed in gray color as it has no effect before login.
   1 If the user desires administrative update options, the user will select the appropriate menu option.
   1 The login process will read the imported user certificate from the browser to access the identity (DN/CA,subject/issuer) of the user.
   1 Depending on the specified values in the _service-configuration.properties_ file the following are the authorization steps:
      * if there are defined _service.admin.DN.x_ keys, then these keys are checked against the presented DN. If there is a match or if a key has the value  _ALLOW ALL_ the user is given _admin_ access and no other action is required.
      * if there are defined _service.admin.DN.x_ keys and there is no match with the presented DN (and there is no key with the value  _ALLOW ALL_) then 
         * A _pull-down/popup_ menu will be displayed showing the list of possible VOs containing users who are authorized  for  _admin_ access to this Gratia instance.
         * This list will be based on the set defined in the _service.admin.FQAN.n_ parameters of the _service-configurataion.properties_ file.
         * Using the _voms-server_ file (defined by the _service.voms.connections_ key), the login process will access the VirtualOrganizations/VOInfo's VirtualOrganizations/VOInfoMS server selected by the user and provide another _pull-down/popup_ menu displaying the set of FQANs for that user in the VirtualOrganizations/VOInfo selected. The _<nop>VOMSAdmin_ method below can be used to retrieve that set:
         * <nop>listUsersWithRole (java.lang.String groupname, java.lang.String rolename)
         * The user will then select the FQAN from the list.
         * The login process will check the selected FQAN against the set of _service.admin.FQAN.n_ values in the _service-configuration.properties_ file.
   1 If the user is _not_ authorized, 
      * the left frame menu will remain unchanged.
   1 If the user is authorized, 
      * the left frame menu will display all the menu options available in the normal link color including the _logout_ option.

Additional login processing considerations:
   1 There is no need to query all the VirtualOrganizations/VOInfoMS servers designated by the _service.admin.FQAN.n_ list if the user is determined to be a Gratia administrator.  Once is enough.
   1 In order to take into account the scenario where a user's Gratia administrative privileges have been revoked (similar to a CRL situation), a _refresh_ parameter will be added to the _system-configuration.properties_ file.  The login process will _implicitly_ re-authorize the user as though the user had selected the _login_ menu option.  This will be done  "behind-the-scenes" when the user performs any action including a refresh of a page.  This interval is the time between _login_ authorization checks.
   1 In order to take into account a user being logged in with  Gratia administrator privileges and leaving his browser unattended for an extended period, a _timeout_ parameter will be added to the _system-configuration.properties_ file. If a user has been inactive for the period specified, the login process will  return the user to the "read-only" state and menu options (replacing the _logout_ option with the _login_ option).  The user will have to _explicitly_ login again.

<pre>
<b>service-configuration.properties file:</b>
# service.admin.refresh -&gt; (expressed in minutes). 
#     This is time interval at which a user' admin authorization is re-checked.
 service.admin.timeout-&gt; (expressed in minutes). 
#     This is time interval at which a user' admin authorization is reset and requires
#     an explicit login.  This is only done if the user is inactive for this period of time.
service.admin.refresh=30
service.admin.timeout=30
</pre>

Some special error handling conditions: 
(<b>Note: These are suggestions and subject to change based on feedback from the developer.)</b>
   1 All error conditions should be caught and a "friendly" message displayed providing sufficient information to understand/resolve the problem.  There should be no java stacktraces displayed to the screen.%BR%%BR%
   1 If there is not at least one _service.admin.FQAN.n_ entry (or the entry is corrupted) in the _service-configuration.properties_ file, display a message similar to:%BR%
      <i>Access denied: There are no valid service.admin.FQAN parameters in the service-configuration.properties file.  Refer to your Gratia documentation to configure this parameter.</i>%BR%%BR%
   1 If there is no _voms-servers_ file (or no matching entries for the _service.admin.FQAN.n_ entries, diisplay a message similar to:%BR%
      <i>Access denied: The following VOs for your service.admin.FQAN parameters in the service-configuration.properties file could not be found in the _voms-server_ file.  Check your configuration.</i>%BR%%BR%
   1 There can be _1 to n_ VOs to search.  If the user is denied (FQAN not found for the user)  in the VirtualOrganizations/VOInfo's specified, the process should generate a message similar to:%BR%
      <i>Access denied: You are not defined as a Gratia administrator in any of the following VOs: &lt;list the VirtualOrganizations/VOInfo names of the VirtualOrganizations/VOInfoMS servers queried&gt;</i>%BR%%BR%
   1 Since there are multiple VirtualOrganizations/VOInfo VOMS servers to interrogate, one or more of them may not be accessible at that point in time.  
      * If this condition exists and the accessible VirtualOrganizations/VOInfo VOMS servers do not allow access, then display a message similar to:%BR%
         <i>Access denied: The following VirtualOrganizations/VOInfo VOMS server were not accessible: &lt;list the VirtualOrganizations/VOInfo names of the VirtualOrganizations/VOInfoMS servers that were inaccessible&gt;</i>
      * If the user is authorized in one of the accessible VirtualOrganizations/VOInfoMS servers, don't display any message.  Just allow access to all menu options.%BR%%BR%



---++ administration access open issues
<ol>
<li>Command line shutdown of update services using _wget_ .<p>
Currently the _initd_ tomcat service, does a _wget_ to stop the _update services_ prior to stopping _tomcat_.
<pre>
  wget -O - -q 'http://gratia.opensciencegrid.org:8881/gratia-administration/systemadministration.html?action=stopDatabaseUpdateThreads'
</pre>
This will not be allowed when the login access is implemented.  An alternative is required. 

<b>Possible resolution:</b> This needs to be investigated.  Can we use the _--certificate=file_ option (and maybe others are needed) of the _wget_ command to pass either the _http_ or _host_ certificate that is needed by the collector to access the VirtualOrganizations/VOInfoMS servers.  We would have  some special processing in the login process to recognize this.

<b>Current implementation</b> allows stopping/starting the database updating threads by using a special URL, different than the one mentioned above. This needs to be investigated further and take into account the implemented authorization mechanisms.

</li>
<p>
</ol>
<p>


---+ gratia-reporting
The Gratia reporting is accessible as http(s)://&lt;node.domain&gt;:&lt;port&gt;/gratia-reporting.  It allows for viewing the accounting data only.  There is no maintenance/update capability.  The general intent in this area is to to allow various levels of visibility to the data:
   * public-like data viewable by anyone
   * VirtualOrganizations/VOInfo level data viewable by members of a VO
   * Individual user data (DN level) for members of a VO

The detailed requirements for this capability have not been fully defined yet.

---++ reporting view requirements
This section has not been defined yet.

---++ reporting view design

---++ reporting view open issues



%STOPINCLUDE%



<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
---++!! Major updates
<!--Future editors should add their signatures beneath yours!-->
-- Main.JohnWeigand - 25 Feb 2008%BR%

%META:TOPICMOVED{by="JohnWeigand" date="1203954709" from="Accounting.GratiaLoginRequirements" to="Accounting.GratiaAccessLoginSpecification"}%
