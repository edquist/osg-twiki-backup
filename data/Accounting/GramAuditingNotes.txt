%META:TOPICINFO{author="JohnWeigand" date="1200937617" format="1.1" reprev="1.6" version="1.6"}%
<!--
   * Set EDITTHISTEXT = <div class="twikiSmall"><a href="%TOPIC%">edit this section</a></div>
-->

---+!! GRAM Auditing Notes

<!--
   * Set BUG5712 = [[http://bugzilla.globus.org/globus/show_bug.cgi?id=5712][Bug 5712]] - Local_job_id format variations
   * Set BUG5713 = [[http://bugzilla.globus.org/globus/show_bug.cgi?id=5713][Bug 5713]] - Failed database connection loses audit records
   * Set BUG5714 = [[http://bugzilla.globus.org/globus/show_bug.cgi?id=5714][Bug 5714]] - Additional data (FQAN) in audit records
   * Set BUG5725 = [[http://bugzilla.globus.org/globus/show_bug.cgi?id=5725][Bug 5725]] - housekeeping for the _auditRecord_ database
   * Set BUG5776 = [[http://bugzilla.globus.org/globus/show_bug.cgi?id=5776][Bug 5776]] - Need for one INFO log message. Currently none.
   * Set BUG5777 = [[http://bugzilla.globus.org/globus/show_bug.cgi?id=5777][Bug 5777]] - Database connection times out
   * Set BUG5778 = [[http://bugzilla.globus.org/globus/show_bug.cgi?id=5778][Bug 5778]] - No error message on db update failure



-->

%TOC%

%STARTINCLUDE%

---++ Description
Gratia has a requirement to be able to report grid usage data for:
   * VOs 
   * VO subgroups
   * Individual grid users (DN)
   * Roles

All of the above information is contained within the proxy certificate when the job request is received on the CE node for a VOMS proxy.  For a VOMS proxy, the VO/Subgroup/Role information is commonly referred to as the FQAN (Fully Qualified Attribute Name).

If a user uses a grid proxy (does not have the extended attributes), only the DN is available. 

Currently (1/17/2008) the only reliable data available, in the GRAM audit log entry and batch queue systems, to Gratia is the DN of the grid user.   Gratia is currently able to determine the user's VO using the _$VDT_LOCATION/monitoring/osg-user-vo-map.txt_ file which provides a mapping of UNIX account to VO, but this file has been prone to data integrity problems at many sites.  The only reliable means of capturing this information is at the time the proxy is read during the authorization process.  This would require changes to the GRAM auditing data that is maintained.  The GRAM audit records also provide a link to the job id used in each of the batch queue systems which Gratia relies on for the accounting data.

This topic addresses:
   * The changes necessary to make the FQAN data available in the GRAM audit records.
   * Configuring a Compute Element (CE) for GRAM auditing.




---++ GRAM proposal (1/11/2008)
For general information on GRAM Auditing, refer to these Globus GRAM documents:
   * GRAM2 (pre-web services): %BR%[[http://www-unix.globus.org/toolkit/docs/4.0/execution/prewsgram/Pre_WS_GRAM_Audit_Logging.html][http://www-unix.globus.org/toolkit/docs/4.0/execution/prewsgram/Pre_WS_GRAM_Audit_Logging.html]]
   * GRAM4 (web services): %BR%[[http://www.globus.org/toolkit/docs/4.0/execution/wsgram/WS_GRAM_Audit_Logging.html][http://www.globus.org/toolkit/docs/4.0/execution/wsgram/WS_GRAM_Audit_Logging.html]]


A conference call was held on Friday 1/11/2008 to discuss the changes necessary to make the additional data (FQAN) available in the GRAM audit record. Attendees:
   * Rachana Ananthakrishnan (ranantha@mcs.anl.gov)
   * Stuart Martin (smartin@mcs.anl.gov)
   * John Weigand  (weigand@fnal.gov)

The Globus proposal for collecting the additional data (basically FQAN) is to create a 2nd audit table which would be joined to the current one (_gram_audit_table_). The _job_grid_id_ would be the joining column and essentially make this 2nd table similar in  nature to the <nop> _JobUsageRecord_Meta_ in Gratia where it is an  just an extension of  the <nop> _JobUsageRecord_ .

It should be noted that the context of the proposal (and discussion on 1/11) basically assumed the following:
   * all sites are using Full Privilege authorization mode (PRIMA callout)
   * all users are using VOMS proxies containing the FQAN information
   * from a Globus perspective it is assumed that at some point in time GRAM2 will no longer be supported.  However, we did look into a solution for GRAM2.

With that in mind, the bottom line for both versions of GRAM is:
   * For sites using Full Privilege authorization (PRIMA callout), parsing/collecting of the attribute data will be done in the callout.
   * The callout will be responsible for populating the 2nd audit table containing the FQAN data.

---+++ Changes for GRAM4 (web services)
For GRAM4, Rachana suggested viewing the VOMS PIP (security handler) developed for the <nop>GridShib project at [[http://dev.globus.org/wiki/VOMS][http://dev.globus.org/wiki/VOMS]].  This does not write to any database and  there is a known limitation. From the developer: 'People recently had trouble with it handling multiple sources of VOMS attributes in one cert which is probably going to be an issue.'


---+++ Changes for GRAM2 (pre-web services)
For GRAM2, Stuart is going to investigate further. Joe Bester is the GRAM2 guru.


---+++ Open Issues / Questions
There are several items still open after the initial discussion.
<ol>
<li>If the parsing of the proxy is done in the callout, how do we handle those sites using a _grid-mapfile_ ?<br>
      A user may submit a job using a VOMS proxy.  If the callout isn't made, we can't collect the data.

<li>Schema definition for the 2nd table containing the attribute information (FQAN).<br>

     The only definite column is the _job_grid_id_ :
      <ul>
        <li>For GRAM4, this would be the resource manager for Managed Executable Job Service.<br>
              This open question here is whether or not it is available to the callout.
        <li>For GRAM2, it is not certain what the value would be. It is less certain as to what is available in the callout. Currently, the only data element that may be available is the job id of the gatekeeper process as seen in the _globus_gatekeeper_ log files.
      </ul>
      
      It has to be investigated as to whether or not this will be fixed column in nature or an open format with maybe a tag/value column pairing.

<li>From a Gratia perspective, is it a requirement to support _grid-mapfile_ authorization modes?

     If so, having the callout collect the data will not be acceptable.

</ol>


   



---++ Implementation Time Frame
The use of GRAM audit records in the Gratia probes is needed for OSG 1.0 and, therefore needs to be made available for integration testing in OSG 0.9 which may be in the March 2008 timeframe.

The current VDT distribution for OSG 0.8.0 is Globus v4.0.5.

Globus v4.0.6 was released on 1/14/2008.%BR%
Globus v4.0.7 is scheduled for March 2008.


---++ GRAM Auditing Log Bugzilla Items
These are the current items entered in the Globus bugzilla system for GRAM auditing that are relevant to the Gratia requirements:
   * %BUG5712%
   * %BUG5713%
   * %BUG5714%
   * %BUG5725%
   * %BUG5776%
   * %BUG5777%
   * %BUG5778%

All of the above are deemed critical for GRAM auditing to be used by Gratia.  

The only one that Globus does not feel they can address is %BUG5725%.  It is felt this is similar in nature to housekeeping on file system type log files which are handled in a variety of different ways at sites and therefore impossible to address with a general solution.  The housekeeping would also be dependent on how non-Globus processes use the data.  Some may need to clean once they process the audit record.  Others may need to retain the data for a period.  The use of the data will dictate the housekeeping rules.

All others they agreed to address.


%INCLUDE{ConfigureGramAuditing}%



%STOPINCLUDE%




<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
---++!! Major updates
<!--Future editors should add their signatures beneath yours!-->
-- Main.JohnWeigand - 17 Jan 2008%BR%
