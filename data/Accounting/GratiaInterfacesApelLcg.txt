%META:TOPICINFO{author="JohnWeigand" date="1226425883" format="1.1" reprev="1.32" version="1.32"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! Gratia Interfaces - APEL/WLCG

<!--
   * Set VORS_SITES = [[http://vors.grid.iu.edu/cgi-bin/tindex.cgi?region=0&VirtualOrganizations/VOInfo=0&res=0&grid=1)][VORS (Virtual Organizations Registration System)]]

   * Set EGEE_PORTAL_OSG_VIEW = [[http://www3.egee.cesga.es/gridsite/accounting/CESGA/osg_view.html][EGEE Accounting Portal - OSG view]]
   * Set EGEE_PORTAL_TIER1_VIEW = [[http://www3.egee.cesga.es/gridsite/accounting/CESGA/tier1_view.html][EGEE Accounting Portal - Tier 1 view]]
   * Set EGEE_PORTAL_TIER2_VIEW = [[http://www3.egee.cesga.es/gridsite/accounting/CESGA/tier2_view.html][EGEE Accounting Portal - Tier 2 view]]

   * Set EGEE_PORTAL_ACCOUNTING_ISSUES=[[http://goc.grid.sinica.edu.tw/gocwiki/Outstanding_Accounting_Issues][UK Grid Operations Outstanding Accounting Issues]]
   * Set EGEE_PORTAL_VO_MAPPINGS=[[http://goc.grid.sinica.edu.tw/gocwiki/Outstanding_Accounting_Issues#head-f60e4af38c1f855b02e7ad065bc0871f39f8a4f5][EGEE Accounting Portal - Treatment of Virtual Organizations / VO Info Accounting section]]
   * Set EGEE_PORTAL_ASSOCIATION_TABLE=[[http://goc.grid.sinica.edu.tw/gocwiki/Outstanding_Accounting_Issues#head-c1c04b4c3ed06c5a7dc95efe037fc55cd6085623][EGEE Accounting Portal - Unregistered Site Association Table]]


-->

%TOC%

%STARTINCLUDE%

---++ Description
Accounting records collected by Gratia are forwarded to the EGEE accounting system, APEL. This is important for US-LHC Tier1 and Tier2 facilities which have to demonstrate to the LHC project delivered computing resources on behalf of ATLAS and CMS collaborations, in accordance with signed Memorandum of Understanding agreements. A service outside the OSG software infrastructure (VDT) runs at Fermilab, parses and analyzes accounting records for a resource, scales wall time figures into <nop>SpecInt2000  for the processor type, and then forwards to an APEL server at the EGEE GOC

The APEL Accounting Portal at RAL has been storing CPU accounting results for WLCG.  On behalf on the ATLAS and CMS tier 1 and tier 2 that are part of OSG, OSG uploads usage information from Gratia into the APEL database.  This OSG data can be viewed in the 
%EGEE_PORTAL_OSG_VIEW%.  APEL has decided to use %VORS_SITES% for its list of official OSG sites. 

---++ Contact Information
For support issues on this interface, the contacts are:
   * Gratia Operations gratia-operations@opensciencegrid.org
   * APEL-WLCG Operations: apel-support@jiscmail.ac.uk


---++ Frequency
The update is performed daily, aggregating usage information for the current month on a per site and VirtualOrganizations/VOInfo basis.  Each update is a complete refresh of the current month's usage.  In order to insure completeness of the previous month's usage, a special update is performed for the previous month for the 1st 15 days of the current month.  This special update allows for any late reporting to Gratia that may occur.  

These are cron jobs running between 00:00 and 02:00 Central Time daily. The update is performed by deleting the entire months data and then re-inserting (all using sql dml statements) the new summaries.  

The EGEE aggregator runs at 20 minutes past the hour, every two hours. As this process involves a lot of aggregation over a large database the actual time when the script looks in the OSG_TABLE table and adds this to the summary can vary. As a rule of thumb though, it should be every two hours.  The last update time can be viewed at the  bottom of the %EGEE_PORTAL_OSG_VIEW% page.



---++ Gratia Usage information as it maps to APEL
The table below shows mapping of Gratia data to the APEL database's _OSG_DATA_ table and to the %EGEE_PORTAL_OSG_VIEW%.  It's purpose is to aid in understanding the data where different names are used for the data shown.
 
%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}%
|  *EGEE Accounting Portal%BR%OSG view*  |  *APEL%BR%OSG_DATA*  |  *Gratia data (all data is from the <nop>VirtualOrganizations/VOInfoProbeSummary table unless otherwise noted)*  |
| Sites | <nop>ExecutingSite | <nop>Site.SiteName |
| VO | <nop>LCGUserVO | <nop>VirtualOrganizations/VOInfoName |
| Number of jobs |<nop>Njobs | Sum of <nop>NJobs |
| Sum CPU | <nop>SumCPU | Sum of (<nop>CpuUserDuration + <nop>CpuSystemDuration) / 3600 |
| Norm Sum CPU | <nop>NormSumCPU | (Sum of (<nop>CpuUserDuration + <nop>CpuSystemDuration) / 3600) * Normalization Factor |
| Sum Elapsed | <nop>SumWCT | Sum of <nop>WallDuration / 3600  |
| Norm Sum Elapsed | <nop>NormSumWCT | (Sum of <nop>WallDuration / 3600) * Normalization Factor |
| | <nop>Month | The month the data is collected for |
| | <nop>Year | The year the data is collected for |
| | <nop>RecordStart | Earliest date reported for the month |
| | <nop>RecordEnd | Latest data reported for the month |
| | <nop>NormFactor | Normalization Factor used |
| | <nop>MeasurementDate | Date of update into APEL |

The SQL query below on the Gratia database is an example using the following criteria:
   * <nop>SiteName: UTA_SWT2
   * Normalization Factor: 1.543
   * Month: November 2008
<pre>
SELECT Site.SiteName AS ExecutingSite,
    VOName as LCGUserVO,
   Sum(NJobs),
   Round(Sum(CpuUserDuration+CpuSystemDuration)/3600) as SumCPU,
   Round((Sum(CpuUserDuration+CpuSystemDuration)/3600)*1.543) as NormSumCPU,
   Round(Sum(WallDuration)/3600) as SumWCT,
   Round((Sum(WallDuration)/3600)*1.543) as NormSumWCT,
   date_format(min(EndTime),"%m")       as Month,
   date_format(min(EndTime),"%Y")       as Year,
   date_format(min(EndTime),"%Y-%m-%d") as RecordStart,
   date_format(max(EndTime),"%Y-%m-%d") as RecordEnd,
   "1.543",
   NOW()
from
     Site,
     Probe,
     VOProbeSummary Main
where
      Site.SiteName = "UTA_SWT2"
  and Site.siteid = Probe.siteid
  and Probe.ProbeName  = Main.ProbeName
  and Main.ResourceType = 'Batch'
  and Main.VOName in ( "usatlas","atlas","uscms","cms" )
  and Main.EndTime &gt;= "2008-11-01 00:00:00"
  and Main.EndTime &lt; "2008-12-01 00:00:00"
group by ExecutingSite,
         LCGUserVO
</pre>


---++ APEL/EGEE Treatment of Virtual Organizations / VO Info and Site Names
In general, there are several outstanding accounting issues that are being addressed and can be viewed on the %EGEE_PORTAL_ACCOUNTING_ISSUES% page.

---+++ EGEE Portal Virtual Organizations / VO Info Mappings
The APEL/EGEE portal does some internal mapping of reported <nop> _LCGUserVO_  name to the VirtualOrganizations/VOInfo name you view on the EGEE portal.  This mapping can be viewed at %EGEE_PORTAL_VO_MAPPINGS%


---+++ EGEE Portal OSG View - Site Names
For site name (<nop> _ExecutingSite_ in the APEL database), the %EGEE_PORTAL_OSG_VIEW% requires that a site be registered with %VORS_SITES%.

If the site is __not__ registered in VirtualOrganizations/VOInfoRS, it will __not__ be aggregated and sent to the EGEE portal OSG view.




---+++ EGEE Portal Tier1 View - Names and Sites
For  the %EGEE_PORTAL_TIER1_VIEW%, there is a table (_org_Tier1_) that defines the hierarchy or tree structure for the relationship between the Tier1 names and the Tier1 sites.  For the 2 VirtualOrganizations/VOInfo's (cms and atlas) this interface is concerned with, these are the _org_Tier1_ table entries:

%TABLE{ tableborder="0" cellpadding="0" cellspacing="1",databg="none,none"}%
    | US-FNAL-CMS                 |1.3 |
    | USCMS-FNAL-WC1-CE |1.3.1 |
    | US-T1-BNL                       |1.4 |
    | BNL_ATLAS_1                |1.4.1 |
    | BNL                                   |1.4.2 |

US-FNAL-CMS and US-T1-BNL are the Tier1 names.

USCMS-FNAL-WC1-CE and BNL_ATLAS_1 are the respective Gratia reported sites (_ExecutingSite_ in the _OSG_DATA_ table) that comprise that name.

The BNL site is a special case.  It actually represents BNL_LCG2 data.  The data for BNL_LCG2 predates Gratia. Prior to having the BNL sites reporting  to Gratia, BNL had a special interface they developed to populate the APEL database in a table called OSG_DATA_BNL.  This table contains data from October 2005 through April 2007.  There was a transitional period (March/April 2007) where BNL migrated reporting  their nodes to Gratia.  Data for the BNL nodes for that period is contained in both the OSG_DATA_BNL and OSG_DATA tables.  We do not have visibility/access to the OSG_DATA_BNL table.  Since BNL_LCG2 predates Gratia, it was never registered in the GOC/VirtualOrganizations/VOInfoRS database.  So an  %EGEE_PORTAL_ASSOCIATION_TABLE%. is maintained that allows mapping of unregistered to registered sites.  There should exist an entry showing BNL_LCG2 mapped to BNL in that table.



---++ Normalization Factor and <nop>SpecInt 
As you've seen in the usage data sent to the APEL/WLCG data base, there is both a raw and normalized value.  The WLCG requires a normalization factor to be applied.  It is felt that this is the only fair means of comparing data across a wide variety of grid clusters. 

The normalization factor is basically a weighted average of a site's sub-cluster configuration as reported via GIP/BDII using <nop>SpecInt2000 benchmarks.
%TABLE%
| *Processor* | *Cores* | *SpecInt* | |
| Intel(R) Pentium(R) 4 CPU 2.60GHz | 120| 978 | 117,360|
| Dual Core AMD Opteron(tm) Processor 270 | 102| 1,452 | 148,104|
| Summary:  (2 Subclusters) - Totals| 222|| 265,464|
| Normalization Factor ||| 1,196|

The following information related to the calculation of the normalization factor for each site can be at this Nebraska site: 
   * http://t2.unl.edu/gratia/wlcg_reporting
and contains the following information:
   * GIP Sub-cluster Data (including the <nop>SpecInt for the processor)
   * Site Normalization Factors (as calculated using the GIP data and as used in the reporting to APEL/WLCG)

The <nop>SpecInt2000 values for various processors can be viewed here:
   * https://t2.unl.edu/gratia/xml/si2k_score

It should be noted that the validity of using <nop>SpecInt2000 as the basis of processor comparisons is something that is not addressed in this document.  

---++ VOs, Sites and Normalization Factors Used.
The list of sites, VOs, CPU/Wall Hours and normalization factors being reported can be viewed here under the ."Per-site WLCG Accounting Summary" table of contents entry:
   * http://t2.unl.edu/gratia/wlcg_reporting


---++ Multiple names for the same physical site
BNL_ATLAS_1 and BNL_ATLAS_2 are actually the same physical site with 2 head nodes which are both advertised in %VORS_SITES%. However, the site owner prefers to gather their accounting info  under a single umbrella (BNL_OSG) rather seeing it as 2 independent entities.  We currently have the mechanism to 'aggregate' more than one gatekeeper under one name. This is used by BNL to aggregate BNL_ATLAS_1 and BNL_ATLAS_2 under the name BNL_OSG. 

This same mechanism is used to easily renamed a site (for presentation purpose and upload to WLCG).    However this mechanism also means that for Gratia the 'sub' site are never reported about independently (So currently if you want information about  BNL_ATLAS_1 you need to go the 'Probe' reports and select the probe name (usually close to the hostname of the gatekeeper).


---++ Open issues / To-do's

---+++ Normalization factor issues
<OL>
<LI>As far as Gratia/Accounting is concerned, we would like to get to a point where each job usage record contain the type of cpu  that the job ran on.  This would give Gratia the most flexibility to normalized the result (normalization is required by WLCG and is the only to fairly compare the result). 

However, at this point the batch system does not gives us enough information (Condor 6.9 might be able to make the information available).   So for now we will rely for  normalization on a rougher estimate.  Currently the estimate comes from the average on one existing farm for which I know the actual hardware.  When the GLUE schema is properly filled, we will use the average for  the Site the job ran on.
</LI>

<LI>
The normalization factor is currently reflecting the latest cluster configuration.  As these clusters are upgraded over time, these factors will change.  In order to be able to re-create the normalized view of past periods, these configurations/factors will need to be keyed by time period somehow.
</LI>
</OL>



---++ Known issues
   * The issue of using SPEC_int2000 as a performance benchmark is becoming increasingly problematic as the benchmark has been deprecated, replaced by SPEC_int2006.  There are additional complications arising from differences in server/motherboard manufacturer, compiler option settings, etc.   There has been discussion of forming an agreed set of metrics for OSG using information collected through !HEPiX, evaluations within labs participating in OSG, etc.  At present, the following table has been prepared: see [[http://www.usatlas.bnl.gov/twiki/bin/view/Admins/AccountingP2.html#Scaling_factors][this table for Fall 2007]] for *Fall 2007* figures.
   * The file =osg-user-vo-map.txt= *must* be kept up to date to correctly associate resource usage by specific Unix accounts in the accounting records to the corresponding VO.

---++ More information
   *  %EGEE_PORTAL_OSG_VIEW%
   *  %EGEE_PORTAL_TIER1_VIEW%
   *  %EGEE_PORTAL_TIER2_VIEW%


%STOPINCLUDE%




<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
---++!! Major updates
<!--Future editors should add their signatures beneath yours!-->
-- Main.JohnWeigand - 26 Sep 2007%BR%


%META:FILEATTACHMENT{name="Normalization-factors.xls" attr="" autoattached="1" comment="Normalization factor calculations" date="1206131451" path="Normalization-factors.xls" size="38912" user="Main.JohnWeigand" version="2"}%
%META:FILEATTACHMENT{name="lcg-reportableSites" attr="" autoattached="1" comment="APEL/WLCG site table" date="1206131342" path="lcg-reportableSites" size="6951" user="Main.JohnWeigand" version="13"}%
