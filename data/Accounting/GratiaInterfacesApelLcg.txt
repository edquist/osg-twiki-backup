%META:TOPICINFO{author="JohnWeigand" date="1260902465" format="1.1" reprev="1.43" version="1.43"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! Gratia Interfaces - APEL/WLCG

<!--
   * Set OIM_HOME= [[http://oim.grid.iu.edu/][OIM (OSG Information Management System)]]

   * Set MYOSG_HOME= [[http://myosg.grid.iu.edu/about][MyOSG]]
   * Set MYOSG_SITES= [[http://myosg.grid.iu.edu/wizardsummary/xml?datasource=summary&gip_status_attrs_showtestresults=on&gip_status_attrs_showfqdn=on&account_type=cumulative_hours&ce_account_type=gip_vo&se_account_type=vo_transfer_volume&start_type=7daysago&start_date=03%2F20%2F2009&end_type=now&end_date=03%2F27%2F2009&all_resources=on&gridtype=on&gridtype_1=on][MyOSG resources]]

   * Set EGEE_PORTAL_OSG_VIEW = [[http://www3.egee.cesga.es/gridsite/accounting/CESGA/osg_view.html][EGEE Accounting Portal - OSG view]]
   * Set EGEE_PORTAL_TIER1_VIEW = [[http://www3.egee.cesga.es/gridsite/accounting/CESGA/tier1_view.html][EGEE Accounting Portal - Tier 1 view]]
   * Set EGEE_PORTAL_TIER2_VIEW = [[http://www3.egee.cesga.es/gridsite/accounting/CESGA/tier2_view.html][EGEE Accounting Portal - Tier 2 view]]
   * Set EGEE_PORTAL_USER_VIEW = [[http://www3.egee.cesga.es/gridsite/accounting/CESGA/user/user_view.html][EGEE Accounting Portal - User view]]

   * Set EGEE_PORTAL_ACCOUNTING_ISSUES=[[http://goc.grid.sinica.edu.tw/gocwiki/Outstanding_Accounting_Issues][UK Grid Operations Outstanding Accounting Issues]]
   * Set EGEE_PORTAL_VO_MAPPINGS=[[http://goc.grid.sinica.edu.tw/gocwiki/Outstanding_Accounting_Issues#head-f60e4af38c1f855b02e7ad065bc0871f39f8a4f5][EGEE Accounting Portal - Treatment of Virtual Organizations / VO Info Accounting section]]
   * Set EGEE_PORTAL_ASSOCIATION_TABLE=[[http://goc.grid.sinica.edu.tw/gocwiki/Outstanding_Accounting_Issues#head-c1c04b4c3ed06c5a7dc95efe037fc55cd6085623][EGEE Accounting Portal - Unregistered Site Association Table]]


-->

%TOC%

%STARTINCLUDE%

---++ Description
Accounting records collected by Gratia are forwarded to the EGEE accounting system, APEL. This is important for US-LHC Tier1 and Tier2 facilities which have to demonstrate to the LHC project delivered computing resources on behalf of ATLAS and CMS collaborations, in accordance with signed Memorandum of Understanding agreements. A service outside the OSG software infrastructure (VDT) runs at Fermilab, parses and analyzes accounting records for a resource, scales wall time figures into <nop>SpecInt2000  for the processor type, and then forwards this data to an APEL server at the EGEE GOC

The APEL Accounting Portal at RAL has been storing CPU accounting results for WLCG.  On behalf on the ATLAS and CMS Tier 1 and Tier 2 that are part of OSG, OSG uploads usage information from Gratia into the APEL database.  This OSG data can be viewed in the 
%EGEE_PORTAL_OSG_VIEW%.  APEL is using sites registered in %OIM_HOME% and viewable in %MYOSG_HOME%

---++ Contact Information
For support issues on this interface, the contacts are:
   * Gratia Operations gratia-operations@opensciencegrid.org
   * APEL-WLCG Operations: apel-support@jiscmail.ac.uk

For non-support general type issues on this interface, the contacts are:
   * osg-wlcg-reports@opensciencegrid.org


---++ Frequency
The update is performed daily, aggregating usage information for the current month on a per site and VO basis (and effective 11/1/2009 by User Distinguished Name).  Each update is a complete refresh of the current month's usage.  In order to insure completeness of the previous month's usage, a special update is performed for the previous month for the 1st 15 days of the current month.  This special update allows for any late reporting to Gratia that may occur.  

These are cron jobs running between 00:00 and 02:00 Central Time daily. The update is performed by deleting the entire months data and then re-inserting (all using sql dml statements) the new summaries.  

The EGEE aggregator runs at 20 minutes past the hour, every two hours. As this process involves a lot of aggregation over a large database the actual time when the script looks in the OSG_TABLE table and adds this to the summary can vary. As a rule of thumb though, it should be every two hours.  The last update time can be viewed at the bottom of the %EGEE_PORTAL_OSG_VIEW% page.



---++ Gratia Usage information as it maps to APEL
Effective 5/20/09, two tables are being updated in the APEL database: 
   1 OSG_DATA - data is summarized by Site and VO.
   2 OSG_CN_DATA - data is summarized by Site, VO and User DN (Distinghuished Name).  
      * Prior to 11/1/2009 Gratia did not have the full User DN. It has only the CN portion of the proxy issuer (DN).  This is the <nop>CommonName field of the Gratia <nop>VOProbeSummary table.
      * Effective 11/1/2009, the full DN was made available in the <nop>DistinguishedName column of the <nop>VOProbeSummary table.

---+++ OSG_DATA table
In the _OSG_DATA_ table, Gratia data is summarized by Site and VO.

The table below shows the mapping of Gratia data to the APEL database's _OSG_DATA_ table and to the %EGEE_PORTAL_OSG_VIEW%.  It's purpose is to aid in understanding the data where different names are used for the data shown.
 
%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}%
|  *EGEE Accounting Portal%BR%OSG view*  |  *APEL%BR%OSG_DATA*  |  *Gratia data (all data is from the <nop>VOProbeSummary table unless otherwise noted)*  |
| Sites | <nop>ExecutingSite | <nop>Site.SiteName |
| VO | <nop>LCGUserVO | <nop>VOName |
| Number of jobs |<nop>Njobs | Sum of <nop>NJobs |
| Sum CPU | <nop>SumCPU | Sum of (<nop>CpuUserDuration + <nop>CpuSystemDuration) / 3600 |
| Norm Sum CPU | <nop>NormSumCPU | (Sum of (<nop>CpuUserDuration + <nop>CpuSystemDuration) / 3600) * Normalization Factor |
| Sum Elapsed | <nop>SumWCT | Sum of <nop>WallDuration / 3600  |
| Norm Sum Elapsed | <nop>NormSumWCT | (Sum of <nop>WallDuration / 3600) * Normalization Factor |
| | <nop>Month | The month the data is collected for |
| | <nop>Year | The year the data is collected for |
| | <nop>RecordStart | Earliest date reported for the month |
| | <nop>RecordEnd | Latest data reported for the month |
| | <nop>NormFactor | Normalization Factor used |
| | <nop>MeasurementDate | Date of update into APEL |

The SQL query below on the Gratia database is an example using the following criteria:
   * <nop>SiteName: UTA_SWT2
   * Normalization Factor: 1.543
   * Month: November 2008
<pre>
SELECT Site.SiteName AS ExecutingSite,
    VOName as LCGUserVO,
   Sum(NJobs),
   Round(Sum(CpuUserDuration+CpuSystemDuration)/3600) as SumCPU,
   Round((Sum(CpuUserDuration+CpuSystemDuration)/3600)*1.543) as NormSumCPU,
   Round(Sum(WallDuration)/3600) as SumWCT,
   Round((Sum(WallDuration)/3600)*1.543) as NormSumWCT,
   date_format(min(EndTime),"%m")       as Month,
   date_format(min(EndTime),"%Y")       as Year,
   date_format(min(EndTime),"%Y-%m-%d") as RecordStart,
   date_format(max(EndTime),"%Y-%m-%d") as RecordEnd,
   "1.543",
   NOW()
from
     Site,
     Probe,
     VOProbeSummary Main
where
      Site.SiteName = "UTA_SWT2"
  and Site.siteid = Probe.siteid
  and Probe.ProbeName  = Main.ProbeName
  and Main.ResourceType = 'Batch'
  and Main.VOName in ( "usatlas","atlas","uscms","cms" )
  and Main.EndTime &gt;= "2008-11-01 00:00:00"
  and Main.EndTime &lt; "2008-12-01 00:00:00"
group by ExecutingSite,
         LCGUserVO
</pre>


---+++ OSG_CN_DATA table
In the _OSG_CN_DATA_ table, Gratia data is summarized by Site, VO and User DN.  
   * Prior to 11/1/2009 Gratia did not have the full User DN. It has only the CN portion of the proxy issuer (DN).  This is the <nop>CommonName field of the Gratia <nop>VOProbeSummary table.
   * Effective 11/1/2009, the full DN was made available in the <nop>DistinguishedName column of the <nop>VOProbeSummary table.

The table below shows mapping of Gratia data to the APEL database's _OSG_CN_DATA_ table and to the %EGEE_PORTAL_OSG_VIEW%.  It's purpose is to aid in understanding the data where different names are used for the data shown.  The <nop>UserDN is not available in that view (called the Global view).  It is viewable in %EGEE_PORTAL_USER_VIEW% but only for the user certificate in the browser used to query the portal.
 
%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}%
|  *EGEE Accounting Portal%BR%OSG view*  |  *APEL%BR%OSG_CN_DATA*  |  *Gratia data (all data is from the <nop>VOProbeSummary table unless otherwise noted)*  |
| Sites | <nop>ExecutingSite | <nop>Site.SiteName |
| VO | <nop>LCGUserVO | <nop>VOName |
| User<BR>(viewable in %EGEE_PORTAL_USER_VIEW%)  | <nop>UserDN | Prior to 11/1/2009: <nop>CommonName<BR> Effective 11/1/2009: <nop>DistinguishedName |
| Number of jobs |<nop>Njobs | Sum of <nop>NJobs |
| Sum CPU | <nop>SumCPU | Sum of (<nop>CpuUserDuration + <nop>CpuSystemDuration) / 3600 |
| Norm Sum CPU | <nop>NormSumCPU | (Sum of (<nop>CpuUserDuration + <nop>CpuSystemDuration) / 3600) * Normalization Factor |
| Sum Elapsed | <nop>SumWCT | Sum of <nop>WallDuration / 3600  |
| Norm Sum Elapsed | <nop>NormSumWCT | (Sum of <nop>WallDuration / 3600) * Normalization Factor |
| | <nop>Month | The month the data is collected for |
| | <nop>Year | The year the data is collected for |
| | <nop>RecordStart | Earliest date reported for the month |
| | <nop>RecordEnd | Latest data reported for the month |
| | <nop>NormFactor | Normalization Factor used |
| | <nop>MeasurementDate | Date of update into APEL |

The SQL query below on the Gratia database is an example using the following criteria:
   * <nop>SiteName: UTA_SWT2
   * Normalization Factor: 1.543
   * Month: November 2008
<pre>
SELECT Site.SiteName AS ExecutingSite,
   VOName as LCGUserVO,
   <b> IF(DistinguishedName NOT IN ("", "Unknown"),IF(INSTR(DistinguishedName,":/")>0,
         LEFT(DistinguishedName,INSTR(DistinguishedName,":/")-1), 
         DistinguishedName),CommonName) as UserDN,</b>
   Sum(NJobs),
   Round(Sum(CpuUserDuration+CpuSystemDuration)/3600) as SumCPU,
   Round((Sum(CpuUserDuration+CpuSystemDuration)/3600)*1.543) as NormSumCPU,
   Round(Sum(WallDuration)/3600) as SumWCT,
   Round((Sum(WallDuration)/3600)*1.543) as NormSumWCT,
   date_format(min(EndTime),"%m")       as Month,
   date_format(min(EndTime),"%Y")       as Year,
   date_format(min(EndTime),"%Y-%m-%d") as RecordStart,
   date_format(max(EndTime),"%Y-%m-%d") as RecordEnd,
   "1.543",
   NOW()
from
     Site,
     Probe,
     VOProbeSummary Main
where
      Site.SiteName = "UTA_SWT2"
  and Site.siteid = Probe.siteid
  and Probe.ProbeName  = Main.ProbeName
  and Main.ResourceType = 'Batch'
  and Main.VOName in ( "usatlas","atlas","uscms","cms" )
  and Main.EndTime &gt;= "2008-11-01 00:00:00"
  and Main.EndTime &lt; "2008-12-01 00:00:00"
group by ExecutingSite,
         LCGUserVO
       <b>, UserDN</b>
</pre>

The reason for the complexity in extracting <nop>DistinguishedName in Gratia is 2-fold:
   1 the check for empty or 'Unknown' is because the <nop>DistinguishedName was not available in Gratia until 11/1/2009
   1 the even more complex exclusion of everything after the first ":/' was  to compensate for a new feature in Condor 7.3.2 and 7.4 that captured the VOMS proxies extended attributes and appended them to the _x509userproxysubject_ attribute which is the source of the data.



---++ APEL/EGEE Treatment of Virtual Organizations / VO Info and Site Names
In general, there are several outstanding accounting issues that are being addressed and can be viewed on the %EGEE_PORTAL_ACCOUNTING_ISSUES% page.

---+++ EGEE Portal Virtual Organizations / VO Info Mappings
The APEL/EGEE portal does some internal mapping of reported <nop> _LCGUserVO_  name to the VO name you view on the EGEE portal.  This mapping can be viewed at %EGEE_PORTAL_VO_MAPPINGS%


---+++ EGEE Portal OSG View - Site Names
For site name (<nop> _ExecutingSite_ in the APEL database), the %EGEE_PORTAL_OSG_VIEW% requires that a site be registered with %OIM_HOME% using the group names in %MYOSG_SITES%..

If the site is __not__ registered in OIM, it will __not__ be aggregated and sent to the EGEE portal OSG view.




---+++ EGEE Portal Tier1 View - Names and Sites
For  the %EGEE_PORTAL_TIER1_VIEW%, there is a table (_org_Tier1_) that defines the hierarchy or tree structure for the relationship between the Tier1 names and the Tier1 sites.  For the 2 VO's (cms and atlas) this interface is concerned with, these are the _org_Tier1_ table entries:

%TABLE{ tableborder="0" cellpadding="0" cellspacing="1",databg="none,none"}%
    | US-FNAL-CMS                 |1.3 |
    | USCMS-FNAL-WC1-CE |1.3.1 |
    | US-T1-BNL                       |1.4 |
    | BNL_ATLAS_1                |1.4.1 |
    | BNL                                   |1.4.2 |

US-FNAL-CMS and US-T1-BNL are the Tier1 names.

USCMS-FNAL-WC1-CE and BNL_ATLAS_1 are the respective Gratia reported sites (_ExecutingSite_ in the _OSG_DATA_ table) that comprise that name.

The BNL site is a special case.  It actually represents BNL_LCG2 data.  The data for BNL_LCG2 predates Gratia. Prior to having the BNL sites reporting  to Gratia, BNL had a special interface they developed to populate the APEL database in a table called OSG_DATA_BNL.  This table contains data from October 2005 through April 2007.  There was a transitional period (March/April 2007) where BNL migrated reporting  their nodes to Gratia.  Data for the BNL nodes for that period is contained in both the OSG_DATA_BNL and OSG_DATA tables.  We do not have visibility/access to the OSG_DATA_BNL table.  Since BNL_LCG2 predates Gratia, it was never registered in the GOC/VORS database.  So an  %EGEE_PORTAL_ASSOCIATION_TABLE%. is maintained that allows mapping of unregistered to registered sites.  There should exist an entry showing BNL_LCG2 mapped to BNL in that table.



---++ Normalization Factor and <nop>SpecInt 
As you've seen in the usage data sent to the APEL/WLCG data base, there is both a raw and normalized value.  The WLCG requires a normalization factor to be applied.  It is felt that this is the only fair means of comparing data across a wide variety of grid clusters. 

The normalization factor is basically a weighted average of a site's sub-cluster configuration as reported via GIP/BDII using <nop>SpecInt2000 benchmarks.
%TABLE%
| *Processor* | *Cores* | *SpecInt* | |
| Intel(R) Pentium(R) 4 CPU 2.60GHz | 120| 978 | 117,360|
| Dual Core AMD Opteron(tm) Processor 270 | 102| 1,452 | 148,104|
| Summary:  (2 Subclusters) - Totals| 222|| 265,464|
| Normalization Factor ||| 1,196|

The following information related to the calculation of the normalization factor for each site can be at this Nebraska site: 
   * http://t2.unl.edu/gratia/wlcg_reporting#gip
and contains the following information:
   * GIP Sub-cluster Data (including the <nop>SpecInt for the processor)
   * Site Normalization Factors (as calculated using the GIP data and as used in the reporting to APEL/WLCG)

It should be noted that the validity of using <nop>SpecInt2000 as the basis of processor comparisons is something that is not addressed in this document.  

---++ VOs, Sites and Normalization Factors Used.
The list of sites, VOs, CPU/Wall Hours and normalization factors being reported can be viewed here under the ."Per-site WLCG Accounting Summary" table of contents entry:
   * http://t2.unl.edu/gratia/wlcg_reporting


---++ Multiple names for the same physical site
BNL_ATLAS_1 and BNL_ATLAS_2 are actually the same physical site with 2 head nodes which are both advertised in %MYOSG_SITES%. However, the site owner prefers to gather their accounting info  under a single umbrella (BNL_OSG) rather seeing it as 2 independent entities.  We currently have the mechanism to 'aggregate' more than one gatekeeper under one name. This is used by BNL to aggregate BNL_ATLAS_1 and BNL_ATLAS_2 under the name BNL_OSG. 

This same mechanism is used to easily renamed a site (for presentation purpose and upload to WLCG).    However this mechanism also means that for Gratia the 'sub' site are never reported about independently (So currently if you want information about  BNL_ATLAS_1 you need to go the 'Probe' reports and select the probe name (usually close to the hostname of the gatekeeper).

---++ Validation/Verification that sites are reporting.
As a part of the interface process, a check is made at the site/resource level (not individual probes) to determine if data is being reported to Gratia every day.  If a site/resource has missing data for any day,  checks are made to see if this is due to planned maintenance or if a site/resource has gone inactive based on OIM/MyOSG data.  If after these checks are made  and a site/resource still has missing data for more than 2 days in the month an email "WARNING" notification is issued to initiate an OSG GOC ticket.  Note: this is a manual ticket initiation.

During each daily run, a html file is created identifying this information and is visible from the production gratia collector in the last column of the table shown here: http://gratia-osg-prod.opensciencegrid.org/gratia-data/interfaces/apel-lcg/ .  This page is also accessible from the main OSG Gratia reporting menu (http://gratia-osg-prod.opensciencegrid.org/gratia-reporting/ ) on the left side under <i>WLCG ATLAS/CMS Tier1/2</i>.

---++ Pending Enhancements
---+++ Replace the !SiteFilterFile (lcg-reportableSites) with !MyOSG
Eventually  the [[#SiteFilterFile_lcg_reportableSit][SiteFilterFile (lcg-reportableSites]] file should be replaced with a query to !MyOSG.   The interface should utilize the WCLG Accounting Data  elements defined there.  This is awaiting some stabilization of the naming conventions used in OIM and Gratia in terms of Gratia Site versus OIM Resource Name.  Currently, if a site/resource is added/deleted from the interface, an email to gratia-operations@opensciencegrid.org is required.  This would eliminate the need for this to some extent.  The reason for saying "to some extent" is that there needs to be an analysis of how APEL uses !MyOSG in determining what sites/resources to subsequently transfer to the EGEE portal.  The handling of inactive sites is really not handled too well by this whole interface.  Fortunately, these type of changes have occurred too frequently and this is not a high priority item.

---++ Open issues / To-Do's

---+++ Normalization factor issues
<OL>
<LI>As far as Gratia/Accounting is concerned, we would like to get to a point where each job usage record contain the type of cpu  that the job ran on.  This would give Gratia the most flexibility to normalized the result (normalization is required by WLCG and is the only to fairly compare the result). 

However, at this point the batch system does not gives us enough information (Condor 6.9 might be able to make the information available).   So for now we will rely for  normalization on a rougher estimate.  Currently the estimate comes from the average on one existing farm for which I know the actual hardware.  When the GLUE schema is properly filled, we will use the average for  the Site the job ran on.
</LI>

<LI>
The normalization factor is currently reflecting the latest cluster configuration.  As these clusters are upgraded over time, these factors will change.  In order to be able to re-create the normalized view of past periods, these configurations/factors will need to be keyed by time period somehow.
</LI>
</OL>

---++ Known issues
   * The issue of using SPEC_int2000 as a performance benchmark is becoming increasingly problematic as the benchmark has been deprecated, replaced by SPEC_int2006.  There are additional complications arising from differences in server/motherboard manufacturer, compiler option settings, etc.   There has been discussion of forming an agreed set of metrics for OSG using information collected through !HEPiX, evaluations within labs participating in OSG, etc.  At present, the following table has been prepared: see [[http://www.usatlas.bnl.gov/twiki/bin/view/Admins/AccountingP2.html#Scaling_factors][this table for Fall 2007]] for *Fall 2007* figures.
   * The file =osg-user-vo-map.txt= *must* be kept up to date to correctly associate resource usage by specific Unix accounts in the accounting records to the corresponding VO.

---++ Developers Corner
This section attempts to describe the scripts and configuration files used by this interface.

---+++ Scripts
---++++ LCG.py
This is the main interface program performing the following functions: 

1. Determines a default 'normalization factor' using a specified probe as the base node. This value is applied against the CPU and Wall time data collected.  It is only used when a normalization factor for a site is not specified in the lcg-reportableSites file. The probe used is defined by the 'NormalizationProbe' attribute of the lcg.conf file.

 2. Retrieves the accounting data from the Gratia database for selected OSG sites and VOs for a month. Sites are defined in a file identified by the 'SiteFilterFile' attribute of the lcg.conf file. VOs are defined in a file identified by the 'VOFilterFile' attribute of the lcg.conf file
With the change implemented on 6/19/07 providing for individual normalization factor by site, instead of a single query being used to retrieve the gratia data, individual queries by site are performed.  In order to reduce the verbage in the log file, only the first query is output to the log file.  The site and normalization factor used is displayed for the other site queries.

3. Formats SQL DML INSERT statements to update the OSG_DATA table of the APEL/LCG database. The table name is defined by the 'LcgTable' attribute of the lcg-db.conf file.  For testing purposes a clone table called OSG_TABLE_TEST can be set instead. The SQL DML statements for the last run are placed in a directory defined by the 'LogSqlDir' attribute of the lcg.conf file. The file name is YYYY-MM.sql and contains only the DML from the last update run. 

 4. Updates the APEL/CLG database. In order to handle site and VO name changes, the SQL DML is set up to DELETE all data for the month/year and then INSERT the new data. This is a simple approach to handling these kinds of changes and works as of 4/25/2007.  It may be this will not hold up over the long run and will have to be re-visited.

Additional functionality:

  1. The script has been design to do everything EXCEPT update the APEL database unless the --update option is used.  This prevents accidental running of the script especially when testing.

  2. Log files are creeted in the directory specified by the 'LogSqlDir' attribute of the lcg.conf file. The format of the log files is YYYY-MM.log.

  3. A file containing the latest SQL DML statements used to update the APEL database is created in the same directory as the log files. The format of the sql file is YYYY-MM.sql

  4. The script will, after completing the APEL database update, create  xml and html files of the data contained in the APEL database table. This was added on 4/17/08 to provide visibility into the data being sent.  No functionality is contained in this script to use these files.  This just makes them available.

Usage:
<verbatim>
  LCG.py(lcg.sh)  --conf=config_file --date=month [--update] [--no-email]

     --conf - specifies the main configuration file to be used
              which would be the lcg.conf file normally

     --date - specifies the monthly time period to be updated:
              Valid values:
                current  - the current month
                previous - the previous month
                YYYY/MM  - any year and month

              The 'current' and 'previous' values are to facillitate running
              this as a cron script.  Generally, we will run a cron
              entry for the 'previous' month for n days into the current
              month in order to insure all reporting has been completed.

     The following 2 options are to facillitate testing and to avoid
     accidental running and updating of the APEL/LCG database and are
     therefore considered optional:

     --update - this option says to go ahead and update the APEL/LCG database.
                If this option is NOT specified, then everything is executed
                EXCEPT the actual updating of the database.  The SQL DML
                file used to update the database will be created.

     --no-email - this option says to turnoff the sending of email
                notifications on failures and successful completions.
</verbatim>


---++++ !DownTimes.py
Class used to query !MyOSG for planned downtimes for a site/resource.

---++++ !InactiveResources.py
Class used to query !MyOSG for sites/resources that have been marked as <I>inactive</i>.

---++++ lcg.sh
This shell script is used to execute the LCG.py process.  The primary purpose of this shell script is to get access to a !MySql client. The !MySql being used comes from Fermi UPS.  It assumes UPS is available via /fnal/ups/etc/setups.sh. There is no command line argument to override this.  All other command line arguments are passed directly to the LCG.py script which collects the data from the gratia database and updates the APEL database. <br /> <br />This script will log error messages to stdout. So it is important you do not redirect stdout/err in the cron entry.  This will insure that someone gets an email notification if a failure occurs. <br /> <br />It is also important that you 'cd' to the lcg.sh parent directory if you specify relative paths for the various files in the lcg.conf file.

---++++ find-late-updates.sh
Shell script used to show sites/resource that have updated Gratia for the previous month during the current month.  This output of this is visible in the table column <i>late updates</i> here: http://gratia-osg-prod.opensciencegrid.org/gratia-data/interfaces/apel-lcg/

---++++ create-apel-index.sh
Shell script that creates the index.html for: http://gratia-osg-prod.opensciencegrid.org/gratia-data/interfaces/apel-lcg/ <br />This is based on certain files in the log directory specified by the <i>LogSqlDir</i> attribute in the <i>lcg.conf</i> file.

---+++ Configuration (lcg.conf)
The <i>lcg.conf</i> is the main configuration file used by the interface.

%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}% 
%EDITTABLE{   format="| text, 25 | textarea, 4x50 |"  changerows="on" quietsave="on" editbutton="Edit table" }% 
| *File* | *Description* |
| !GratiaCollector | Data directory for Gratia collector. <br />   * /data/tomcat-gratia/webapps/gratia-data/interfaces/apel-lcg <br />The xml and html files are made accessible via this collector (uses an scp format). If you do not want the files copied to a collector, then use the keyword 'DO_NOT_COPY'. <br /> |
| [[#SiteFilterFile_lcg_reportableSit][SiteFilterFile]] | File with list of sites/resources to be reported and the normalization factor. |
| !SiteFilterHistory | History directory for keeping previous periods (months)!SiteFilterFile's (<NAME>.YYYYMM) <br /> |
| [[#VOFilterFile_lcg_reportableVOs][VOFilterFile]] | File with list of VOs to be reported |
| [[#DBConfFile_lcg_db_conf][DBConfFile]] | Configuration file for databases |
| !LogSqlDir | Directory for log files and the sql dml update file. |
| !MissingDataDays | Number of days where a site/resource has no data reported to Gratia for the month.  If more than this number of days, a warning/advisory email will be generated. |
| !NormalizationProbe | Probe name to calculate a default normalization factor. <b>Note:</b> This is obsolete as all sites/resources have a normalization factor. |
| !NormalizationPeriod | Number of periods (months) to use in calculating the normalization factor.  The period will be a full 3 months when the run is made for any previous period and from 2-3 months depending on the day the process is run in a current month. <br /><b>Note:</b> This is obsolete as all sites/resources have a normalization factor. |
| !NormalizationDefault | Default value to use if no data is available for the !NormalizationProbe (can occur at beginning of a month and the !NormalizationPeriod is <= 1, or if there is a problem with that probe) <br /><b>Note:</b> This is obsolete as all sites/resources have a normalization factor. |
| !FromEmail | Email address of the sender.  Since this is a cron run process, this is dependent on how email is set up locally. |
| !ToEmail | List of comma separated email addresses.  Email notifications are sent to this list for all executions of this interface for both success and failure. |


---++++ !SiteFilterFile (lcg-reportableSites)
This file identifies the set of sites/resources reportable to the APEL-LCG database and the normalization factor to be used in the gratia query.
   * token 1 - The !SiteName/Resource name as reported in Gratia.
   * token 2 - The normalization value to be used. This was obtained from site surveys regarding the hardware used on a site's clusters and is an estimated value based on a SPECint2000 specification.  If no value is specified, then a value is derived from the  gratia database using the gratia_psacct.!ProbeName specified in lcg.conf file.
      * These tokens are whitespace separated.   
      * Comments - line starting with a # sign 
      * Empty lines are permitted.

Example:
<verbatim>
#
#--- CMS Tier 1 ----
USCMS-FNAL-WC1-CE   1809
#--- CMS Tier 2 ----
CIT_CMS_T2          3046
GLOW                2408
HEPGRID_UERJ        2117
  :
####################################
#--- ATLAS Tier 1 ----
BNL_ATLAS_1         2302
#--- ATLAS Tier 2 ----
AGLT2               3130
BU_ATLAS_Tier2      2022
   :
</verbatim>
<b>Note: In the future, the need for this configuration file should be eliminated.  It would be replaced by a query of !MyOSG using the WLCG Accounting data for the Resource/Site.</b>

---++++ !VOFilterFile (lcg-reportableVOs)
This file identifies the VO data reported for each reportable site/resource.  
Example:
<verbatim>
cms
uscms
atlas
usatlas
</verbatim>

---++++ !DBConfFile (lcg-db.conf)
Identifies access information for the Gratia and APEL databases.

%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}% 
%EDITTABLE{   format="| text, 25 | textarea, 2x50 |"  changerows="on" quietsave="on" editbutton="Edit table" }% 
| *File* | *Description* |
| !GratiaHost | Gratia database host |
| !GratiaPort | Gratia database port |
| !GratiaUser | Gratia user (should always be a read only) |
| !GratiaPswd | File containing the !GratiaUser password. Permissions should be set to read only by the owner.) |
| !GratiaDB | Gratia database (schema) |
| | |
| !LcgHost | APEL database host |
| !LcgPort | APEL database port |
| !LcgUser | APEL database user ("OSG" for both production and test) |
| !LcgPswd | File containing the !LcgUser password. Permissions should be set to read only by the owner.) |
| !LcgDB | APEL database/schema ("accounting" for both production and test) |
| !LcgTable | APEL data base table for Site-Resource summary data <br />   * production (OSG_DATA) <br />   * test (OSG_DATA_TEST) |
| !LcgUserTable | APEL data base table for Site-Resource/DN summary data <br />   * production (OSG_CN_DATA) <br />   * test (OSG_CN_DATA_TEST) |

<b>IMPORTANT:</b> !MySql access permissions for the APEL accounting database is based on the node running this interface.  Currently, access is being granted from gr8x0, gratia02 and gratia03 nodes at fnal.gov.  In addition to the 4 tables updated (OSG_DATA, OSG_DATA_TEST, OSG_CN_DATA, OSG_CN_DATA_TEST), this interface needs "read-only" access to the following 2 tables:
   * org_Tier1
   * org_Tier2

---+++ Crontab
As mentioned somewhere way back in this document, the general practice has been run this interface from the 1st of the current month thru the 15th of the next month (e.g. for November, it will run nightly from 11/1 thru 12/15) to accommodate sites/resources that may have had reporting problems and are in "catch-up" mode.  So 2 cron entries are required:
<verbatim>
##########################################################################
# Gratia-to-APEL (WLCG) transfer crontab entry
#
# Note: When scheduling the time of these scripts, you should first
#       check with the root cron's database backup to insure there
#       is not a conflict.
#       This script also must be run on the same host as the
#       tomcat-gratia collector as it copies files into its
#       ./webapps/gratia-data/interfaces/apel-lcg directory.
#-------------------------------------------------------------------------
#
# Previous month's transfers
# For just the 1st n days of the month to insure all have reported
#
15 0 1-15 * *   dir=/home/gratia/interfaces/apel-lcg; cd $dir; ./lcg.sh --config=lcg.conf --date=previous --update; ./create-apel-index.sh /data/tomcat-gratia
#
#-------------------------------------------------------------------------
# Current month's transfers.
# Always daily.
#
15 1 * * *   dir=/home/gratia/interfaces/apel-lcg; cd $dir; ./lcg.sh --config=lcg.conf --date=current --update; ./find-late-updates.sh /data/tomcat-gratia; ./create-apel-index.sh /data/tomcat-gratia
#
##########################################################################
</verbatim>



---++ More information
   *  %EGEE_PORTAL_OSG_VIEW%
   *  %EGEE_PORTAL_TIER1_VIEW%
   *  %EGEE_PORTAL_TIER2_VIEW%
   *  %EGEE_PORTAL_USER_VIEW%

%STOPINCLUDE%




<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
---++!! Major updates
<!--Future editors should add their signatures beneath yours!-->
-- Main.JohnWeigand - 19 Nov 2009: Updated for implementation of User Distinguished Name on 11/1/2009%BR%


%META:FILEATTACHMENT{name="Normalization-factors.xls" attr="" autoattached="1" comment="Normalization factor calculations" date="1206131451" path="Normalization-factors.xls" size="38912" user="Main.JohnWeigand" version="2"}%
%META:FILEATTACHMENT{name="lcg-reportableSites" attr="" autoattached="1" comment="APEL/WLCG site table" date="1206131342" path="lcg-reportableSites" size="6951" user="Main.JohnWeigand" version="13"}%
%META:FILEATTACHMENT{name="OIM-registered-resource-3-5-2009.xls" attachment="OIM-registered-resource-3-5-2009.xls" attr="" comment="OIM Registered Resources 3/5/2009 (.xls format)" date="1237479078" path="OIM-registered-resource-3-5-2009.xls" size="49359" stream="OIM-registered-resource-3-5-2009.xls" tmpFilename="/usr/tmp/CGItemp6367" user="JohnWeigand" version="1"}%
