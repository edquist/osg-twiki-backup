%META:TOPICINFO{author="JohnWeigand" date="1338481166" format="1.1" reprev="1.57" version="1.57"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! Gratia Interfaces - APEL/WLCG

<!--
   * Set OIM_HOME= [[http://oim.grid.iu.edu/][OIM (OSG Information Management System)]]

   * Set MYOSG_HOME= [[http://myosg.grid.iu.edu/about][MyOSG]]

   * Set GRATIA_APEL_UI = [[http://gratia-osg-prod-reports.opensciencegrid.org/gratia-data/interfaces/apel-lcg/][Gratia-APEL WLCG Interface]]
   * Set OSG_WLCG_REPORTING = [[http://gratiaweb.grid.iu.edu/gratia/wlcg_reporting][OSG WLCG Reporting]]

   * Set EGI_PORTAL                        = [[http://accounting.egi.eu/osg.php][EGI Accounting Portal]]
   * Set EGI_PORTAL_OSG_VIEW   = [[http://accounting.egi.eu/osg.php][EGI Accounting Portal - OSG view]]
   * Set EGI_PORTAL_TIER1_VIEW = [[http://accounting.egi.eu/tier1.php][EGI Accounting Portal - Tier 1 view]]
   * Set EGI_PORTAL_TIER2_VIEW = [[http://accounting.egi.eu/tier2.php][EGI Accounting Portal - Tier 2 view]]
   * Set EGI_PORTAL_USER_VIEW = [[http://www3.egee.cesga.es/gridsite/accounting/CESGA/user/user_view.html][EGI Accounting Portal - User view]]
   * Set EGI_PORTAL_VOMEMBER_VIEW = [[https://accounting.egi.eu/user/vomem.php][EGI Accounting Portal - VO Member view]]

   * Set EGI_PORTAL_ACCOUNTING_ISSUES=[[http://goc.grid.sinica.edu.tw/gocwiki/Outstanding_Accounting_Issues][UK Grid Operations Outstanding Accounting Issues]]
   * Set EGI_PORTAL_VO_MAPPINGS=[[http://goc.grid.sinica.edu.tw/gocwiki/Outstanding_Accounting_Issues#head-f60e4af38c1f855b02e7ad065bc0871f39f8a4f5][EGI Accounting Portal - Treatment of Virtual Organizations / VO Info Accounting section]]
   * Set EGI_PORTAL_ASSOCIATION_TABLE=[[http://goc.grid.sinica.edu.tw/gocwiki/Outstanding_Accounting_Issues#head-c1c04b4c3ed06c5a7dc95efe037fc55cd6085623][EGI Accounting Portal - Unregistered Site Association Table]]

   * Set EGI_PORTAL_LINKS = [[http://www3.egee.cesga.es/gridsite/accounting/CESGA/links.html][EGI Portal links]]
   * Set APEL_FAQ=[[https://twiki.cern.ch/twiki/bin/view/EMI/APELFAQ][APEL FAQ and Troubleshooting]]
   * Set APEL_SERVER=[[https://wiki.egi.eu/wiki/APEL/Server][APEL Server]]
   * Set APEL_SUMMARY_RECS=[[https://wiki.egi.eu/wiki/APEL/MessageFormat#Summary_Job_Records][APEL Job Summary Records]]

   * Set WLCG_REBUS_TOPOLOGY = [[http://wlcg-rebus.cern.ch/apps/topology/][WLCG REBUS topology]]

   * Set NORMALIZATION_FACTOR = [[#Normalization_Factor][Normalization Factor]]
   * Set OSG_CN_DATA = [[#OSG_CN_DATA_table][OSG_CN_DATA table]]
-->

%TOC%

%STARTINCLUDE%

---++ Description
Accounting records collected by Gratia are forwarded to the EGI accounting system, APEL. This is important for US-LHC Tier1 and Tier2 facilities which have to demonstrate to the LHC project delivered computing resources on behalf of ATLAS, CMS and ALICE collaborations, in accordance with signed Memorandum of Understanding agreements. A service outside the OSG software infrastructure (VDT) runs at Fermilab, parses and analyzes accounting records for a resource, scales wall time and cpu usage into <nop>HepSpec2006 for the processor type, and then forwards this data to the %APEL_SERVER% at the EGI GOC

The APEL Accounting Portal at RAL has been storing CPU accounting results for WLCG.  On behalf on the ATLAS, CMS and ACLIE Tier 1 and Tier 2 that are part of OSG, OSG uploads usage information from Gratia to the APEL accounting system.  This OSG data can be viewed in the 
%EGI_PORTAL_OSG_VIEW%.  APEL is using OSG __resource groups__  registered in %OIM_HOME% and viewable in %MYOSG_HOME%



---++ Contact Information
For support issues on this interface, the contacts are:
   * Gratia Operations gratia-operations@opensciencegrid.org
   * APEL-WLCG Operations: apel-support@jiscmail.ac.uk
   * %APEL_FAQ%

For non-support general type issues on this interface, the contacts are:
   * osg-wlcg-reports@opensciencegrid.org


---++ Frequency
The update to APEL from Gratia is performed daily, aggregating usage information for the current month on a per __resource group__  and VO basis (and effective 11/1/2009 by User Distinguished Name).  Each update is a complete refresh of the current month's usage.  

In order to insure completeness of the previous month's usage, a special update is performed for the previous month for the 1st 8 days of the current month.  This special update allows for any late reporting to Gratia that may occur.   In addition, this been set  to coincide with the LCG Accounting Office extract of the data from the EGI accounting portal for the monthly MOU reports.  This occurs on the 8th of each month.

These are cron jobs running between 00:00 and 02:00 Central Time daily. The update is performed by deleting the entire months data and then re-inserting (all using sql dml statements) the new summaries.  

The APEL system then performs an aggregation of all the accounting data collected from all sites (inclusive of OSG) and updates the %EGI_PORTAL% at least once per day.  As this process involves a lot of aggregation over a large database the actual time this occurs can vary.  The last update time can be viewed at the bottom of the %EGI_PORTAL% page.


---++ Accounting Data
Since Gratia handles the collection of detailed accounting data for OSG, this interface sends only monthly summaries for select OSG __resource_groups__ and __VOs__ as shown below:

<blockquote>
%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}%
|  *Data*  |  *Description*  |
| Month |  |
| Year   |  |
| Resource Group | APEL/EGI Site is equivalent to OSG's OIM resource group |
| VO                      | VO |
| User Name          | User's DN |
| Number of jobs    | Total jobs for the period |
| CPU time              | Total CPU time (in hours) |
| Wall Time              | Total Wall time (in hours)  |
| Normalized CPU    | CPU Time normalized by the resource group's HEPSPEC06 |
| Normalized Wall       | Wall Time normalized by the resource group's HEPSPEC06 |
| Earliest End Time | End time of the  first job in the month |
| Latest End Time | End time of the last job in the month |
</blockquote>

Details on the complete set of summary data accepted can be found here: %APEL_SUMMARY_RECS%.
It should be noted that APEL/EGI is designed to accept VOMS group and role attributes but, as of this time, we have not been asked to provide them.

---++ The Process


The sub-sections that follow represents the process flow for the interface.

---+++ Reportable resource groups
This is a manually maintained configuration file (__lcg-reportableSites__) identifying  the __resource_groups__ that are interfaced to APEL/WLCG.   This file contains the __resource_group__ and normalization factor used.   
<blockquote><pre>
#--- CMS Tier 1 ----
USCMS-FNAL-WC1-CE   2566
#--- CMS Tier 2 ----
CIT_CMS_T2          3236
GLOW                2408
    :
#--- ATLAS Tier 1 ----
BNL_ATLAS_1         3093
#--- ATLAS Tier 2 ----
AGLT2               2125
HU_ATLAS_Tier2      2218
    :
#--- ALICE Tier 2 ---- 
NERSC-PDSF          3420
LC-glcc             3920
</blockquote></pre>

---++++ Normalization Factor
As you've seen in the usage data sent to the APEL/WLCG data base, there is both a raw and normalized value.  The WLCG requires a normalization factor to be applied.  It is felt that this is the only fair means of comparing data across a wide variety of grid clusters.   Prior to January 2011, the normalization factor was based on <nop>SpecInt2000 benchmark values for a  processor and the monthly MOU reports reflected that.  Starting in January 2011, the MOU reports and Tier 1 spreadsheets reflect <nop>HepSpec2006 benchmarks.

The normalization factor is basically a simple weighted average of a site's sub-cluster configuration.  
%TABLE%
| *Processor* | *Cores* | *Benchmark* | *(Cores * Benchmark)* |
| Intel(R) Pentium(R) 4 CPU 2.60GHz | 120| 978 | 117,360|
| Dual Core AMD Opteron(tm) Processor 270 | 102| 1,452 | 148,104|
| Summary:  (2 Subclusters) - Totals| 222|| 265,464|
| Normalization Factor (265464 / 222) ||| 1,196|

As newer processors were put into production, a problem started to emerge in that <nop>SpecInt benchmarks were unavailable and only <nop>HepSpec benchmarks were. On the other side, there were no <nop>HepSpec values available for the older processors.  In addition, given the current interface, there was no way of distinguishing between a <nop>SpecInt and <nop>HepSpec derived normalization factors and there was really no way to compare the two values, a decision was made by the WLCG to apply a factor of 4 as an arbitrary equalization factor for the two benchmarks.   

However, the interface (as defined by the %OSG_CN_DATA%), only provides for normalized data using a <nop>SpecInt benchmark:
   * if the processor has a <nop>SpecInt value, we use that.
   * if the processor has a <nop>HepSpec value, we divide by 4 and use that.
Then, when the data is sent to APEL and subsequently to the EGI portal, the <nop>SpecInt normalized values are multiplied by 4 to reflect the <nop>HepSpec normalized values.   This can be seen under any of the views in the EGI Accounting portal like %EGI_PORTAL_OSG_VIEW% when you select the _Data to graph_ pull down at the top.

---+++ Reportable VO data 
     A manually maintained configuration file (__lcg-reportableVOs__) identifying the VOs for which accounting data is interfaced. Only accounting data for the CMS, ATLAS and ALICE VOs is sent to APEL/WLCG for each of the __resource_groups__. 
<blockquote><pre>
cms
uscms
atlas
usatlas
alice
</blockquote></pre>

---+++ <nop>MyOSG query
For each __resource_group__ in the [[#Reportable_resource_groups][lcg-reportableSites]] file, a query is made of <nop>MyOsg to determine all __resources__ that are to be interfaced based on the <nop>WLCGInformation <nop>InteropAccounting flag set to True.

---+++ Gratia query
Gratia is then accessed using the following query for each __resource_group__ :
<blockquote><pre>
SELECT '<a href="#Reportable_resource_groups"><b><font color="red">RESOURCE_GROUP</font></b></a>' AS ExecutingSite,
   VOName as LCGUserVO,
   <font color="navy"><b><i> IF(DistinguishedName NOT IN ("", "Unknown"),IF(INSTR(DistinguishedName,":/")>0,
         LEFT(DistinguishedName,INSTR(DistinguishedName,":/")-1), 
         DistinguishedName),CommonName) as UserDN,</b></i></font>
   Sum(NJobs),
   Round(Sum(CpuUserDuration+CpuSystemDuration)/3600) as SumCPU,
   Round((Sum(CpuUserDuration+CpuSystemDuration)/3600)*<a href="#Reportable_resource_groups"><b><font color="red">NORMALIZATION_FACTOR</font></b></a>) as NormSumCPU,
   Round(Sum(WallDuration)/3600) as SumWCT,
   Round((Sum(WallDuration)/3600)*<a href="#Reportable_resource_groups"><b><font color="red">NORMALIZATION_FACTOR</font></b></a>) as NormSumWCT,
   date_format(min(EndTime),"%m")       as Month,
   date_format(min(EndTime),"%Y")       as Year,
   date_format(min(EndTime),"%Y-%m-%d") as RecordStart,
   date_format(max(EndTime),"%Y-%m-%d") as RecordEnd,
   "<a href="#Reportable_resource_groups"><b><font color="red">NORMALIZATION_FACTOR</font></b></a>",
   NOW()
from
     Site,
     Probe,
     VOProbeSummary Main
where
      Site.SiteName in ( <a href="#MyOSG_query"><b><font color="red">LIST_OF_MYOSG_RESOURCES_WITH_INTEROPACCUNTING_FLAG_TRUE</font></b></a> )
  and Site.siteid = Probe.siteid
  and Probe.ProbeName  = Main.ProbeName
  and Main.ResourceType = 'Batch'
  and Main.VOName in ( <a href="#Reportable_VO_data"><b><font color="red">LIST_OF_REPORTABLE_VOS</font></b></a>)
  and Main.EndTime &gt;= "<font color="red">FIRST_DAY_MONTH(YYYY_MM_01)</font></b> 00:00:00"
  and Main.EndTime &lt; "<font color="red">FIRST_DAY_NEXT_MONTH(YYYY_MM_01)</font></b> 00:00:00"
group by ExecutingSite,
         LCGUserVO
       <b>, UserDN</b>
</pre></blockquote>

The reason for the complexity in extracting <nop>DistinguishedName in Gratia is 2-fold:
   1 the check for empty or 'Unknown' is because the <nop>DistinguishedName was not available in Gratia until 11/1/2009
   1 the even more complex exclusion of everything after the first ":/' was  to compensate for a new feature in Condor 7.3.2 and 7.4 that captured the VOMS proxies extended attributes and appended them to the _x509userproxysubject_ attribute which is the source of the data.




---+++ Validation/Verification that sites are reporting.
As a part of the interface process, a check is made at the site/resource level (not individual probes) to determine if data is being reported to Gratia every day.  If a site/resource has missing data for any day,  checks are made to see if this is due to planned maintenance or if a site/resource has gone inactive based on OIM/MyOSG data.  If after these checks are made  and a site/resource still has missing data for more than 2 days in the month an email "WARNING" notification is issued to initiate an OSG GOC ticket.  Note: this is a manual ticket initiation.

---+++ Validation/Verification that !MyOSG and %WLCG_REBUS_TOPOLOGY% agree


---++ Maintaining the Normalization Factors
The following information related to the calculation of the normalization factor for each site can be seen at this Nebraska site: 
   * http://t2.unl.edu/gratia/wlcg_reporting#gip
and contains the following information:
   * GIP Sub-cluster Data (including the <nop>SpecInt for the processor)
   * Site Normalization Factors (as calculated using the GIP data and as used in the reporting to APEL/WLCG)

It should be noted that the validity of using <nop>SpecInt2000 as the basis of processor comparisons is something that is not addressed in this document.  

---++ APEL/EGI Treatment of Virtual Organizations / VO Info and Site Names
In general, there are several outstanding accounting issues that are being addressed and can be viewed on the %EGI_PORTAL_ACCOUNTING_ISSUES% page.

---+++ EGI Portal Virtual Organizations / VO Info Mappings
The APEL/EGI portal does some internal mapping of reported <nop> _LCGUserVO_  name to the VO name you view on the EGI portal.  This mapping can be viewed at %EGI_PORTAL_VO_MAPPINGS%


---+++ EGI Portal OSG View - Site Names
For site name (<nop> _ExecutingSite_ in the APEL database), the %EGI_PORTAL_OSG_VIEW% requires that a site be registered in %OIM_HOME% as a __resource_group__ as seen in MyOsg.

If the site is __not__ registered in OIM, it will __not__ be aggregated and sent to the EGI portal OSG view.




---+++ EGI Portal Tier1 View - Names and Sites
For  the %EGI_PORTAL_TIER1_VIEW%, there is a table (_org_Tier1_) that defines the hierarchy or tree structure for the relationship between the Tier1 names and the Tier1 sites.  For the 2 VO's (cms and atlas) this interface is concerned with, these are the _org_Tier1_ table entries:

%TABLE{ tableborder="0" cellpadding="0" cellspacing="1",databg="none,none"}%
    | US-FNAL-CMS                 |1.3 |
    | USCMS-FNAL-WC1-CE |1.3.1 |
    | US-T1-BNL                       |1.4 |
    | BNL_ATLAS_1                |1.4.1 |
    | BNL                                   |1.4.2 |

US-FNAL-CMS and US-T1-BNL are the Tier1 names.

USCMS-FNAL-WC1-CE and BNL_ATLAS_1 are the respective Gratia reported sites (_ExecutingSite_ in the _OSG_DATA_ table) that comprise that name.

The BNL site is a special case.  It actually represents BNL_LCG2 data.  The data for BNL_LCG2 predates Gratia. Prior to having the BNL sites reporting  to Gratia, BNL had a special interface they developed to populate the APEL database in a table called OSG_DATA_BNL.  This table contains data from October 2005 through April 2007.  There was a transitional period (March/April 2007) where BNL migrated reporting  their nodes to Gratia.  Data for the BNL nodes for that period is contained in both the OSG_DATA_BNL and OSG_DATA tables.  We do not have visibility/access to the OSG_DATA_BNL table.  Since BNL_LCG2 predates Gratia, it was never registered in the GOC/VORS database.  So an  %EGI_PORTAL_ASSOCIATION_TABLE%. is maintained that allows mapping of unregistered to registered sites.  There should exist an entry showing BNL_LCG2 mapped to BNL in that table.


---++ Multiple names for the same physical site
BNL_ATLAS_1 and BNL_ATLAS_2 are actually the same physical site with 2 head nodes which are both advertised in %MYOSG_HOME%. However, the site owner prefers to gather their accounting info  under a single umbrella (BNL_OSG) rather seeing it as 2 independent entities.  We currently have the mechanism to 'aggregate' more than one gatekeeper under one name. This is used by BNL to aggregate BNL_ATLAS_1 and BNL_ATLAS_2 under the name BNL_OSG. 

This same mechanism is used to easily renamed a site (for presentation purpose and upload to WLCG).    However this mechanism also means that for Gratia the 'sub' site are never reported about independently (So currently if you want information about  BNL_ATLAS_1 you need to go the 'Probe' reports and select the probe name (usually close to the hostname of the gatekeeper).


During each daily run, a html file is created identifying this information and is visible from the production gratia collector in the last column of the table shown here: http://gratia-osg-prod.opensciencegrid.org/gratia-data/interfaces/apel-lcg/ .  This page is also accessible from the main OSG Gratia reporting menu (http://gratia-osg-prod.opensciencegrid.org/gratia-reporting/ ) on the left side under <i>WLCG ATLAS/CMS Tier1/2</i>.

---++ Would like to have enhancements
---+++ Eliminate the manually maintained configuration files
Eventually  the [[#SiteFilterFile_lcg_reportableSit][SiteFilterFile (lcg-reportableSites]] file should be replaced with a query to !MyOSG.   The interface should utilize the WCLG Accounting Data  elements defined there.  This is awaiting some stabilization of the naming conventions used in OIM and Gratia in terms of Gratia Site versus OIM Resource Name.  Currently, if a site/resource is added/deleted from the interface, an email to gratia-operations@opensciencegrid.org is required.  This would eliminate the need for this to some extent.  The reason for saying "to some extent" is that there needs to be an analysis of how APEL uses !MyOSG in determining what sites/resources to subsequently transfer to the EGI portal.  The handling of inactive sites is really not handled too well by this whole interface.  Fortunately, these type of changes have occurred too frequently and this is not a high priority item.



---++ Open issues / To-Do's

---+++ Synchronization of OIM/MyOSG with Gratia
The intent of this initiative is to align OIM/MyOSG with Gratia and, additionally, extend that to the APEL/WLCG interface. The motivation is to eliminate the manual intervention required when new resources (Gratia sites) are added or removed from service.  Currently, there does not exist any true relationship between resources in OIM/MyOsg and Gratia.  The OIM/MyOSG resource name should correspond to a Gratia site name.  In the following paragraphs, when the term 'resource' is used, it is considered synonymous with Gratia 'site name'.

In OIM/MyOSG, the ability to define resources that are involved in the APEL/WLCG interface currently exists  This data is at the resource level and contained in the WLCG Information section:
   1 Interop Accounting flag - True if the resource is interfaced to APEL/WLCG for accounting purposes
   1 Accounting Name - if the Interop Accounting flag is True, this contains the Tier 1 or 2 WLCG federation name (e.g., T2-US-Caltech)

From an APEL/WLCG perspective, we need to handle the following use cases:
   1 Addition of a new resource for a Tier1/2 Federation
   1 Removal of a resource from a Tier1/2 Federation (aka, disabling a resource in OIM/MyOSG terms).  This requires preserving the historical data for that resource.


---+++ Validation/verification of monthly MOU reports
When the Tier 2 monthly reports are issued by the LCG accounting office (e.g, http://lcg.web.cern.ch/LCG/accounting/Tier-2/2010/january-10/Tier2_Accounting_Report_January2010.pdf), a validation of the OSG federation resource is being performed manually.  The data has been accurate for probably the last 6  months.  However, this January's report indicated that the EGI portal has not been updated since Jan 21 for OSG sites.  The APEL database showed current data through Jan31.

It would be "nice" to be able to able perform some form of automated validation and eliminate this manual effort.  I am not sure if this is totally viable.




---+++ Normalization factor issues
<OL>
<LI>As far as Gratia/Accounting is concerned, we would like to get to a point where each job usage record contain the type of cpu  that the job ran on.  This would give Gratia the most flexibility to normalize the result (normalization is required by WLCG and is the only way to fairly compare the result). 

However, at this point the batch system does not gives us enough information (Condor 6.9 might be able to make the information available).   So for now we will rely for  normalization on a rougher estimate.  Currently the estimate comes from the average on one existing farm for which I know the actual hardware.  When the GLUE schema is properly filled, we will use the average for  the Site the job ran on.
</LI>

<LI>
The normalization factor is currently reflecting the latest cluster configuration.  As these clusters are upgraded over time, these factors will change.  In order to be able to re-create the normalized view of past periods, these configurations/factors will need to be keyed by time period somehow.
</LI>
</OL>

---++ Known issues
   * The issue of using SPEC_int2000 as a performance benchmark is becoming increasingly problematic as the benchmark has been deprecated, replaced by SPEC_int2006.  There are additional complications arising from differences in server/motherboard manufacturer, compiler option settings, etc.   There has been discussion of forming an agreed set of metrics for OSG using information collected through !HEPiX, evaluations within labs participating in OSG, etc.  At present, the following table has been prepared: see [[http://www.usatlas.bnl.gov/twiki/bin/view/Admins/AccountingP2.html#Scaling_factors][this table for Fall 2007]] for *Fall 2007* figures.
   * The file =osg-user-vo-map.txt= *must* be kept up to date to correctly associate resource usage by specific Unix accounts in the accounting records to the corresponding VO.




---++ History
This section just documents when major changes to the interface took place:
%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}%
|  *Date*  |  *Description*  |
| September 2008 | Added methods to create xml/hmtl/dat files to provide visibility to the data sent and displayed at %GRATIA_APEL_UI% and %OSG_WLCG_REPORTING% |
| November 2008 | Added an additional filter on the selection criterea. Only selecting <nop>ResourceType='Batch'.  Changes to the condor probes (v1.00.3) will result in distinguishing between the actual  grid jobs (Batch) and the grid monitoring job (<nop>GridMonitor) when jobs are submitted using condor_submit. Any 'local' job used to submit a job on the CE node will be filtered, but should they at some point be passed to Gratia, these will be identified as Local. |
| March 2009 | Started saving the configuration file for reportable sites and normalization factors for each month.  This provided the capability to re-send prior months data in the event a site had problems and still retain that period's configuration. |
| May 2009 | Added the User's Distinguished Name (DN) as part of the summary criterea and data sent. |
| June 2009 | Started checking for Gratia sites that had stopped reporting data to Gratia.  This provided a pro-active means of identifying problems rather than waiting for the monthly MOU reports to be issued. |
| July 2009 | Added an extract of OIM downtimes to use  when determining if a Gratia site failed to report |
| December 2009 | Added use of a new class (!InactiveResources) to query MyOsg for Resource that have been marked inactive.  This is used in conjunction with the Downtimes class when checking why a site/resourcehas not reported |
| January 2010 | APEL/EGI started reporting MOU reports using <nop>HEPSpec2006 normalization factors in place of the <nop>SpecInt2000 values we are reporting.  We still use <nop>SpecInt2000.  They apply a factor of 4x as means of adjusting until all sites report using <nop>HEPSpec2006.  When we have <nop>HEPSpec2006 available we divide by 4 to maintain consistency. |
| December 2010 | The ALICE VO was added to the list of reportable VOs and sites. |
| August 2011 | This represents a major change to the interface.  All OSG reporting to WLCG has been in reference to !MyOsg resource group.  However, the <nop>MyOsg <nop>InteropAccounting flag for WLCG Information is at the resource, not resource group, level.  The changes made in this revision will now:%BR%1. treat the lcg-reportableSites config file entries as resource groups. This also means the Normalization Factors should be calculated at the resource group level.%BR%2. determine which resources within that resource group should have their gratia data reported to APEL/EGI.%BR%3. summarize (using sql) the accounting data for the month for all interfaced resources for the resource group. A new class, <nop>InteropAccounting(.py), provides the access to <nop>MyOsg. |
| June 2012 | Changed the APEL interface from a direct update of the APEL database to the use of a messaging system (SSM) |

More detail information related to code, reportable sites and normalization factors can be found in the [[GratiaInterfacesApelLcgHistory][Gratia Interfaces - APEL/WLCG - History twiki]]

---++ More information
---+++ ILC VO
   * [[GratiaInterfacesApelLcgIlcVo][ILC VO Requirements (9/23/11)]]
---+++ APEL SSM/ActiveMQ Interface
   * [[Interoperability/AccountingInteropQuestionsAndIssues][APEL SSM/ActiveMQ Interface]]

---+++ Developers Corner
   * [[ApelWlcgDevelopersCorner][APEL/WLCG Developers Corner twiki]].

---+++ EGI Portal Views
   *  %EGI_PORTAL_OSG_VIEW%
   *  %EGI_PORTAL_TIER1_VIEW%
   *  %EGI_PORTAL_TIER2_VIEW%
   *  %EGI_PORTAL_USER_VIEW%
   *  %EGI_PORTAL_VOMEMBER_VIEW% 

---+++ WLCG/APEL/EGI Links:
   * %EGI_PORTAL_LINKS%
   * %WLCG_REBUS_TOPOLOGY%

%STOPINCLUDE%




<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
---++!! Major updates
<!--Future editors should add their signatures beneath yours!-->
-- Main.JohnWeigand - 19 Nov 2009: Updated for implementation of User Distinguished Name on 11/1/2009%BR%
-- Main.JohnWeigand - 08 Feb 2010: Split the developers corner (doc) out as a separate twiki (!ApelWlcgDevelopersCorner) %BR%

%META:FILEATTACHMENT{name="Normalization-factors.xls" attr="" autoattached="1" comment="Normalization factor calculations" date="1206131451" path="Normalization-factors.xls" size="38912" user="Main.JohnWeigand" version="2"}%
%META:FILEATTACHMENT{name="lcg-reportableSites" attr="" autoattached="1" comment="APEL/WLCG site table" date="1206131342" path="lcg-reportableSites" size="6951" user="Main.JohnWeigand" version="13"}%
%META:FILEATTACHMENT{name="OIM-registered-resource-3-5-2009.xls" attachment="OIM-registered-resource-3-5-2009.xls" attr="" comment="OIM Registered Resources 3/5/2009 (.xls format)" date="1237479078" path="OIM-registered-resource-3-5-2009.xls" size="49359" stream="OIM-registered-resource-3-5-2009.xls" tmpFilename="/usr/tmp/CGItemp6367" user="JohnWeigand" version="1"}%
