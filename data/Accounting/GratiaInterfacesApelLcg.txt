%META:TOPICINFO{author="JohnWeigand" date="1191344390" format="1.1" reprev="1.5" version="1.5"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! Gratia Interfaces - APEL/WLCG


%TOC%

%STARTINCLUDE%
---++ APEL/WLCG
---+++ Description
The APEL Accounting Portal at RAL has been storing CPU accounting results for WLCG.  On behalf on the ATLAS and CMS tier 1 and tier 2 that are part of OSG, OSG uploads usage information from Gratia into the APEL database.  This OSG data can be viewed in the 
[[http://www3.egee.cesga.es/gridsite/accounting/CESGA/osg_view.html][UK Grid Operations Centre's EGEE Accounting Portal - OSG view]]. APEL has decided to use [[http://vors.grid.iu.edu/cgi-bin/tindex.cgi?region=0&VO=0&res=0&grid=1)][VORS]] for its list of OSG sites. 

---+++ Frequency
The update is performed daily aggregating usage information for the current month on a per site and VO basis.  Each update is a complete refresh of the current month's usage.  In order to insure completeness of the previous month's usage, a special update is performed for the previous month for the 1st 15 days of the current month.  This special update allows for any late reporting to Gratia that may occur.  

These are cronjobs running at 02:00 Central Time daily. The update is performed by deleting the entire months data and then re-inserting (all using sql dml statements) the new summaries.  

The EGEE aggregator runs at 20 minutes past the hour, every two hours. As this process involves a lot of aggregation over a large database the actual time when the script looks in the OSG_TABLE table and adds this to the summary can vary. As a rule of thumb though, it should be every two hours.

---+++ Gratia Usage information as it maps to APEL
The table below shows mapping of Gratia data to the APEL database's _OSG_DATA_ table and to the [[http://www3.egee.cesga.es/gridsite/accounting/CESGA/osg_view.html][UK Grid Operations Centre's EGEE Accounting Portal - OSG view]].  It's purpose is to aid in understanding the data where different names are used for the data shown.
 
%TABLE{ tableborder="1" cellpadding="0" cellspacing="1" headerbg="#99CCCC" databg="#FFFFCC, #FFFFFF"}%
|  *EGEE Accounting Portal%BR%OSG view*  |  *APEL%BR%OSG_DATA*  |  *Gratia data (all data is from the <nop>VOProbeSummary table unless otherwise noted)*  |
| Sites | <nop>ExecutingSite | <nop>Site.SiteName |
| VO | <nop>LCGUserVO | <nop>VOName |
| Number of jobs |<nop>Njobs | Sum of <nop>NJobs |
| Sum CPU | <nop>SumCPU | Sum of (<nop>CpuUserDuration + <nop>CpuSystemDuration) / 3600 |
| Norm Sum CPU | <nop>NormSumCPU | (Sum of (<nop>CpuUserDuration + <nop>CpuSystemDuration) / 3600) * Normalization Factor |
| Sum Elapsed | <nop>SumWCT | Sum of <nop>WallDuration / 3600  |
| Norm Sum Elapsed | <nop>NormSumWCT | (Sum of <nop>WallDuration / 3600) * Normalization Factor |
| | <nop>Month | The month the data is collected for |
| | <nop>Year | The year the data is collected for |
| | <nop>RecordStart | Earliest date reported for the month |
| | <nop>RecordEnd | Latest data reported for the month |
| | <nop>NormFactor | Normalization Factor used |
| | <nop>MeasurementDate | Date of update into APEL |


---+++ Normalization Factor
As you've seen in the usage data sent to the APEL/WLCG data base, there is both a raw and normalized value.  The WLCG requires a normalization factor to be applied.  It is felt that this is the only fair means of comparing data across a wide variety of grid clusters. 

The calculations for the normalization factor used for a site can be seen  in this spreadsheet :%BR%[[%ATTACHURL%/Normalization-factors.xls][Normalization-factors.xls]]

The basic factor in determining the normalization factor is the value of [[http://www.spec.org/cpu/results/cint2000.html][<nop>SpecInt 2000]] divided by 1000 for the processors in a site's grid cluster. 

To obtain the needed data, a survey was sent out to all OSG sites requesting the information needed to determine processor composition of their subclusters . For those  OSG Sites that properly filled out a survey of the actual composition of their farm, we use the weighted average of the normalization factor for the various hardware deployed.  For the sites that did not provide any information about their farm's composition, we use the actual normalization factor from a representative farm (CMS Tier1 at Fermilab). 






---+++ VOs, Sites and Normalization Factors Used.
The list of VOs, sites and normalization factors used can be seen in the [[%ATTACHURL%/lcg-reportableSites][lcg-reportableSites file]] that is used in the daily updates.



---+++ Open issues / To-do's
---++++ Normalization factor issues
As far as Gratia/Accounting is concerned, we would like to get to a point where each job usage record contain the type of cpu  that the job ran on.  This would give Gratia the most flexibility to normalized the result (normalization is required by WLCG and is the only to fairly compare the result). 

However, at this point the batch system does not gives us enough information (Condor 6.9 might be able to make the information available).   So for now we will rely for  normalization on a rougher estimate.  Currently the estimate comes from the average on one existing farm for which I know the actual hardware.  When the GLUE schema is properly filled, we will use the average for  the Site the job ran on.

---+++ Anomolies (for lack of a better way to describe it)
---++++ Multiple names for the same physical site
BNL_ATLAS_1 and BNL_ATLAS_2 are actually the same physical site with 2 head nodes which are both advertised in VORS. However, the site owner prefers to gather their accounting info  under a single umbrella (BNL_OSG) rather seeing it as 2 independent entities.  We currently have the mechanism to 'aggregate' more than one gatekeeper under one name. This is used by BNL to aggregate BNL_ATLAS_1 and BNL_ATLAS_2 under the name BNL_OSG. 

This same mechanism is used to easily renamed a site (for presentation purpose and upload to WLCG).    However this mechanism also means that for Gratia the 'sub' site are never reported about indepedently (So currenty if you want information about  BNL_ATLAS_1 you need to go the 'Probe' reports and select the probe name (usually close to the hostname of the gatekeeper).



%STOPINCLUDE%




<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
---++!! Major updates
<!--Future editors should add their signatures beneath yours!-->
-- Main.JohnWeigand - 26 Sep 2007%BR%


%META:FILEATTACHMENT{name="Normalization-factors.xls" attachment="Normalization-factors.xls" attr="" comment="Normalization factor calculations" date="1191344389" path="Normalization-factors.xls" size="29184" stream="Normalization-factors.xls" user="Main.JohnWeigand" version="2"}%
%META:FILEATTACHMENT{name="lcg-reportableSites" attr="" autoattached="1" comment="APEL/WLCG site table" date="1191344077" path="lcg-reportableSites" size="3857" user="Main.JohnWeigand" version="1"}%
