%META:TOPICINFO{author="PhilippeCanal" date="1204738771" format="1.1" reprev="1.8" version="1.8"}%
%META:TOPICPARENT{name="WebHome"}%
---+ Database Backups

---++ Stragegy

To backup and restore the MySQL database when using Innodb we have 3 possible levels depending on the uptime and recovery time requirement.

---+++ Simpliest

The database are backed up locally using mysqldump.  To simplify the backup maintenance scheduling and recovery are done via Zamanda

---+++ Higher availability.

The database is replicated to a secondary node.  The replicated database is backed up via mysql dump which can be used to recover both
the main and replicated database.

---+++ Lowest recovery time.

The database is replicated to a secondary node.  The replicated database is backed up by shutting down the DB server and doing a cold
copy of the file system.

---++Implementation

---+++ Backup

On gratia06,  the backup are driven by the script mysqlhotcopy_cron.sh.  It has 2 phases:

   * Local backup using mysql-zrm
   * Upload of the backups to gratia07

The local backup configurations are in /etc/mysql-zrm/[SchemaName]

The backups are copied into gratia06:/backup/mysqldb/zrm
The remote backups are copied into gratia07:/data/zrm

As of 2008/03/05, all databases have been transitioned.

As of 2008/03/04, The remote hot backup have been replaced by a simple uploading of the backup files except for the gratia and gratia_itb databases.

Note: We are not using the mysql-zrm scheduler directly in order to enforce the sequentially of the backups.

---+++ Recovery

---++++Simple reload of one of the schema:

<pre>mysql-zrm --verbose --action restore --backup-set gratia_qcd --source-directory /test/zrm/gratia_qcd/_last_directory_ --tmpdir=/test/tmp</pre>

where /test/tmp has enough space to hold a copy of the backup files.

---++++Full reload of the database

This is intended to be used in case of total loss of the DB disks.

   1. Create empty MySQL database, add the usual users (reader, gratia).
   2. Create the empty databases (fermi_osg, gratia_itb, gratia_osg_integration, gratia_qcd, fermi_itb, gratia, gratia_osg_daily, gratia_psacct)
   3. Restore the data from the backups of each database (see above .....)
   4. Make the stored procedure and trigger are reloaded.   This currently requires calling post-install.sh on each Collector (tomcats)

---++ Performance

ITB Innodb schema with 3.3 millions rows (7G) on disk, backup in 13 minutes.  Resulting file is also 7G.  Full reload took 1 hour.

---++ Zamanda cheat-sheet

See Documentation at http://mysqlbackup.zmanda.com/

Location of configuration files: /etc/mysql_zrm

Performance info: <pre>mysql-zrm-reporter --show backup-performance-info --destination /test/zrm/</pre>

Backup 'now':

<pre>mysql-zrm-scheduler --now --backup-set dailyrun --backup-level 0</pre>

Restore:

<pre>mysql-zrm --verbose --action restore --backup-set itb_innodb --source-directory /test/zrm/itb_innodb/20080214144217/ --tmpdir=/test/tmp</pre>

where /test/tmp has enough space to hold a copy of the backup files.


Changes from the default zrm configuration file:
<pre>
# Request explicitly full backups
backup-level=0
# Select where to write the backup file
destination=/backup/mysqldb/zrm
# Select how many days (D) to keep the backup file
retention-policy=3D
# Request explicit compression
compress=1
# Select which schema to backup
databases=gratia_qcd
# Select the DB user
user="..."
password="...."
# Select where to send result emails, use an empty string for no emails at all.
mailto="pcanal@fnal.gov"

-- Main.PhilippeCanal - 27 Feb 2008
