%META:TOPICINFO{author="ChrisGreen" date="1216143701" format="1.1" reprev="1.14" version="1.14"}%
%META:TOPICPARENT{name="WebHome"}%
<table width="100%">
<tr><td valign="top">
</td>
<td valign="top">
---+!! Gratia Backups
%TOC%
</td>
<td valign="top" align="right" width="25%">
%TABLE{ sort="off" dataalign="left" tableborder="0" cellpadding="1" cellspacing="3" headerbg="#F3EDE7" databg="#F3EDE7"}%
</td></tr></table>
%STARTINCLUDE%

---+ Database Backups

---++ Stragegy

To backup and restore the !MySQL database when using !InnoDB we have 3 possible levels depending on the uptime and recovery time requirement.

---+++ Simpliest

The database are backed up locally using mysqldump.  To simplify the backup maintenance scheduling and recovery are done via Zamanda

---+++ Higher availability.

The database is replicated to a secondary node.  The replicated database is backed up via mysql dump which can be used to recover both
the main and replicated database.

---+++ Lowest recovery time.

The database is replicated to a secondary node.  The replicated database is backed up by shutting down the DB server and doing a cold
copy of the file system.

---++Implementation

---+++ Backup

On gratia06,  the backup are driven by the script gratia_backup_cron.sh.  It has 2 phases:

   * Local backup using mysql-zrm
   * Upload of the backups to gratia07

The local backup configurations are in /etc/mysql-zrm/[SchemaName]

The backups are copied into gratia06:/backup/mysqldb/zrm

Except for the main OSG gratia database with is copied in gratia06:/backup/mysqldb/gratia/zrm

The remote backups are copied into gratia07:/data/mysqldb/zrm

As of 2008/03/05, all databases have been transitioned.

As of 2008/03/04, The remote hot backup have been replaced by a simple uploading of the backup files except for the gratia and gratia_itb databases.

Note: We are not using the mysql-zrm scheduler directly in order to enforce the sequentially of the backups.

---+++ Recovery

---++++Simple reload of one of the schema:

<pre>mysql-zrm --verbose --action restore --backup-set gratia_qcd --source-directory /test/zrm/gratia_qcd/_last_directory_ --tmpdir=/test/tmp</pre>

where /test/tmp has enough space to hold a copy of the backup files.

Important Note:

In mysql 5.0.22, the result of mysqldump is incorrect for views in 2 ways:
   * views are created sometimes before the table they use are created
   * existing views are not delete (but a table of the same would).
There is indication that this may have been fixed in newer version of mysql.

To work around the problem, before executing the restore command we need to:
   * Make sure to have a fleshed out schema by either
      * start from existing db. 
      * start fresh and first connect a collector to the database to let hibernate create the tables. Before starting the collector, set =gratia.service.safeStart = 1= in service-configuration.properties.
   * Remove all views
      * SELECT table_schema,table_name FROM information_schema.views;
      * and execute 'drop view name_of_view;' on each of the views

---++++Full reload of the database

This is intended to be used in case of total loss of the DB disks.

   1. Create empty !MySQL database, add the usual users (reader, gratia).
   1. Create the empty databases (fermi_osg, gratia_itb, gratia_osg_integration, gratia_qcd, fermi_itb, gratia, gratia_osg_daily, gratia_psacct)
   1. Restore the data from the backups of each database (see above .....)
   1. Catalyze the restoration of triggers and procedures by executing this SQL prior to starting the collector for recovery:%BR%<verbatim>update SystemProplist set cdr = 0 where BINARY car like '%Version'</verbatim>

---++ Performance

ITB Innodb schema with 3.3 millions rows (7G) on disk, backup in 13 minutes.  Resulting file is also 7G.  Full reload took 1 hour.

---++ Zamanda cheat-sheet

See Documentation at http://mysqlbackup.zmanda.com/

Location of configuration files: /etc/mysql_zrm

Performance info: <pre>mysql-zrm-reporter --show backup-performance-info --destination /test/zrm/</pre>

Backup 'now':

<pre>mysql-zrm-scheduler --now --backup-set dailyrun --backup-level 0</pre>

Get information about the backups:

<pre>mysql-zrm --action list --backup-set gratia_pcanal</pre>

Restore:

<pre>mysql-zrm --verbose --action restore --backup-set itb_innodb --source-directory /test/zrm/itb_innodb/20080214144217/ --tmpdir=/test/tmp</pre>

where /test/tmp has enough space to hold a copy of the backup files.


Changes from the default zrm configuration file:
<pre>
# Request explicitly full backups
backup-level=0
# Select where to write the backup file
destination=/backup/mysqldb/zrm
# Select how many days (D) to keep the backup file
retention-policy=3D
# Request explicit compression
compress=1
# Select which schema to backup
databases=gratia_qcd
# Select the DB user
user="..."
password="...."
# Select where to send result emails, use an empty string for no emails at all.
mailto="pcanal@fnal.gov"

-- Main.PhilippeCanal - 27 Feb 2008
