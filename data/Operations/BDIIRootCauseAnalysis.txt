%META:TOPICINFO{author="RobQ" date="1248895625" format="1.1" version="1.10"}%
%META:TOPICPARENT{name="WebHome"}%
---+Root Cause Analysis of BDII Update on July 8th, 2009

%TOC%

---++ Situation

On July 8th, the GOC updated the IP address on the Bloomington BDII server to facilitate an upcoming physical move of the IU machine room. The IP switch went smoothly and service was restored on the new IP in less than 10 minutes. During the process DNS round-robining was used to steer traffic to the Indianapolis BDII service. After the end of the maintenance window CMS reported OSG BDII information not getting published to the top level BDII at CERN. Non US users were unable to submit CMS jobs. 

After investigation the GOC was notified by CMS that the BDII at CERN was trying to contact the old BDII IP and when not finding the address dropping the OSG BDII information. This was due to the DNS change not being propagated. The GOC published Time to Live was 4 hours. It is still unknown if there are additional caching of DNS entries at CERN.

---++ Time Table

All times eastern (EST).

July 8th, 2009
| *Time* | *Event* | 
| 1:00 | IU DNS Removes RR from Bloomington BDII |
| 2:00 | Maintenance window begins |
| ~2:10 | Maintenance is completed, new IP is in place on BDII |
| 3:00 | Maintenance window is over, IU DNS switches RR back on with new IP in place. |
| ~3:40 | The GOC hears from CMS that OSG resources are not being published to the top level WLCG BDII, this message is routed via IM to Arvind first then to Rob |
| ~3:50 | Rob calls Dan and describes the problem. CERN had gone home for the day four hours earlier and was unreachable. |
| ~4:00 | Concall with Rob, Dan, Burt - Agreement that if this cannot be fixed within an hour, old BDII will be restored. |
| | Attempts were made to reach CERN sysadmin but he was already gone for the day and unreachable.|
| | ongoing IM communication between Rob, Burt, Dan |
| ~5:00 | Dan calls Rob to say that we need to restore the old BDII. Rob informs Dan that the IU DNS person has already gone home for the day and that this will be difficult. | 
| ~5:10 | Burt notifies Rob & Dan via IM that Service is restored, temporary fix described below | 

July 14th, 2009
Coordinated with CMS the removal of temporary fix. 

---++ Background

In January, 2009 the BDII contact was changed to use a Round Robin DNS access to two servers, one at IU in Bloomington and the other one at IUPUI in Indianapolis. This change was announced to the community via mail and in this news release ([[http://osggoc.blogspot.com/2009/01/notification-of-bdii-redundancy.html][Link]]), this was also communicated directly with CMS who requested the redundancy as well as in the OSG Facility and Operations Meetings.

---+++ Testing

The GOC tested that resources were publishing to both bdii instances and that a ldap query would access is1.grid.iu.edu and is2.grid.iu.edu alternately. Both cases were confirmed. 

---+++ Not Tested

Testing should have been done by removing one instance from DNS RR and watching the affects on outside systems. 

---++ Fix

The fix at the GOC required a separate ethernet card on the BDII machine to be brought up and listen on the old IP address. 

---++ Best Practices

Suggested Future Best Practices with BDII Maintenace

   1 Preform maintenance in the morning to coordinate with CERN and the 5/6 hour time difference. This also gives us time to rollback with IU DNS if necessary, though this can only happen hourly.
   2 Coordinate more closely with CMS. We did formally notify them of the change, and were in contact with them informally via IM, but we should have a post-change testing period where they can actively search for issues and confirm things are working as expected at the end of the maintenance window. 
   3 Update the DNS TTL at IU to 10 minutes. This will force connecting services to refresh the address mapping every 10 minutes. (%RED%Note: This was put in place by IU DNS admins this morning for BDII, we have asked them to do this on all of our services.%ENDCOLOR%)
   4 The WLCG Top Level BDII gets a list from OIM. Since we run the Interoperability BDII with only resource that should be published to WLCG this list is unnecessary in !MyOSG and provides an extra point of failure. Even though the list is cached, we would like to remove this dependency. 
   5 A full [[ItbBDIITesting][test]] should be conducted on the ITB BDII to be sure the steps we have taken ease the unpublished time to WLCG.
   6 We plan to meet with CMS to discuss what additional steps might be taken to ensure maximal success of the operation. Some possibilities include a test at the CERN BDII to determine when contact is lost, and fall back on cached data, or fail over to a different address.

---++ Notification Schedule

   1 Operations Meeting July 6th [[https://twiki.grid.iu.edu/bin/view/Operations/Minutes2009July06][Link]]
   2 Email Notification and RSS Post July 6th [[http://osggoc.blogspot.com/2009/07/july-8-maintenance-on-myosg-and.html][Link]]
   3 Email Notification and RSS Post of Completion July 8th [[http://osggoc.blogspot.com/2009/07/completed-july-8-maintenance-on-myosg.html][Link]]

---++ Other Notes

Burt mentioned on the July 8 Ops call that we did function within the SLA for the BDII service. However he'd like to make sure the Change Management and Testing are refined to make sure a similar situation does not occur in the future.

-- Main.RobQ - 09 Jul 2009