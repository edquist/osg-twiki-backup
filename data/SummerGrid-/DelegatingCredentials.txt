%META:TOPICINFO{author="BenClifford" date="1172842858" format="1.1" version="1.4"}%
%META:TOPICPARENT{name="LectureTwoTutorial"}%
<link rel="stylesheet" type="text/css" href="%PUBURL%/%WEB%/WorkshopTutorialModules/exercises.css">


---+!! %SPACEOUT{ "%TOPIC%" }%

%TOC%

%STARTINCLUDE%
%EDITTHIS%

<span class="firstterm">Delegation</span> is where you empower another entity to act as you for some period of time. In this exercise we will try to submit a job that uses <nop>GridFTP to copy the executable =whoami= from local machine, run the executable on the remote machine, save output to a file and use <nop>GridFTP to transfer file back to local machine.

The following job description can be used for doing the above:

<pre class="programlisting">
&lt;job&gt;
 &lt;executable&gt;my_whoami&lt;/executable&gt;
  &lt;directory&gt;${GLOBUS_USER_HOME}&lt;/directory&gt;
  &lt;stdout&gt;${GLOBUS_USER_HOME}/stdout&lt;/stdout&gt;
  &lt;stderr&gt;${GLOBUS_USER_HOME}/stderr&lt;/stderr&gt;
  &lt;fileStageIn&gt;
   &lt;transfer&gt;
    &lt;sourceUrl&gt;
      gsiftp://%OTHERHOST%:2811/usr/bin/whoami
    &lt;/sourceUrl&gt;
    &lt;destinationUrl&gt;
      gsiftp://%OTHERHOST%:2811/${GLOBUS_USER_HOME}/my_whoami
    &lt;/destinationUrl&gt;
   &lt;/transfer&gt;
  &lt;/fileStageIn&gt;
  &lt;fileStageOut&gt;
   &lt;transfer&gt;
    &lt;sourceUrl&gt;
      gsiftp://%OTHERHOST%:2811/${GLOBUS_USER_HOME}/stdout
    &lt;/sourceUrl&gt;
    &lt;destinationUrl&gt;
      gsiftp://%LOGINHOST%:2811/tmp/train31DelTest
    &lt;/destinationUrl&gt;
   &lt;/transfer&gt;
  &lt;/fileStageOut&gt;
  &lt;fileCleanUp&gt;
   &lt;deletion&gt;
    &lt;file&gt;file:///${GLOBUS_USER_HOME}/my_whoami&lt;/file&gt;
   &lt;/deletion&gt;
  &lt;/fileCleanUp&gt;
&lt;/job&gt;
</pre>

Copy the RSL above and paste to file called =rsl=. Replace =train31DelegTest= with some other filename. The output will be written to this file.

---+++ Use non-GCS credential

<pre class="screen">
[train31 ~]$ <userinput>unset X509_USER_PROXY</userinput>
[train31 ~]$ 
</pre>

---+++ Submit job to run globus-url-copy on remote machine
Try to submit without delegation option =-S=.

<pre class="screen">
[train31 ~]$ <userinput>globusrun-ws -F https://%OTHERHOST%:8443/wsrf/services/ManagedJobFactoryService -submit -f rsl 
</userinput>
Submitting job...Done.
Job ID: uuid:028f85e0-023d-11db-bb44-000feae0c5a8
Termination time: 06/23/2006 22:18 GMT
Current job state: StageIn
Current job state: Failed
Destroying job...Done.
globusrun-ws: Job failed: Staging error for RSL element fileStageIn.
A stagingCredentialEndpoint element was not specified in the RSL, but is needed for staging.
[train31 ~]$ 
</pre>


Above error indicates no delegated credential was found for staging (transferring) of files to occur.


---+++ Submit job with delegation to run globus-url-copy on remote machine
Run same command with =-S= option.

<pre class="screen">
[train31 ~]$ <userinput>globusrun-ws -F https://%OTHERHOST%:8443/wsrf/services/ManagedJobFactoryService -S -submit -f rsl 
</userinput>
Delegating user credentials...Done.
Submitting job...Done.
Job ID: uuid:306922c8-023d-11db-b66c-000feae0c5a8
Termination time: 06/23/2006 22:19 GMT
Current job state: StageIn
Current job state: Active
Current job state: StageOut
Current job state: CleanUp
Current job state: Done
Destroying job...Done.
Cleaning up any delegated credentials...Done.
[train31 ~]$ 
</pre>

Note that credentials are delegated now. Also the delegated credentials are destroyed so as to prevent any misuse.

If you open the output file in =/tmp/=, you should see the result of running =whoami= on the remote machine. 

%STOPINCLUDE%

<!--                                                                            
      * Set LOGINHOST = gridlab1                                                
      * Set GRIDHOST = tg-login.ncsa.teragrid.org                               
      * Set OTHERHOST = gridlab2                                                
-->

%BOTTOMMATTER%
-- Main.ForrestChristian - 2007 Jan 29: pulled from original %BR%