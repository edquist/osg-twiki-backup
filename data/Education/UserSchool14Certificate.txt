%META:TOPICINFO{author="TimCartwright" date="1404407847" format="1.1" reprev="1.1" version="1.1"}%
%META:TOPICPARENT{name="UserSchool14Materials"}%
<style type="text/css">
pre em { font-style: normal; background-color: yellow; }
pre strong { font-style: normal; font-weight: bold; color: #008; }
</style>

---+ Obtaining an OSG PKI User Certificate

In some of the exercises for the OSG User School, the programs that you run must identify you to other programs, often running on other computers. It is part of the overall security infrastructure of the OSG. Think of it as presenting a driver’s license or passport to identify yourself. Your identity is represented by a __certificate__, specifically an OSG user certificate based on the [[http://en.wikipedia.org/wiki/X.509 X.509 standard]] for [[http://en.wikipedia.org/wiki/Public-key_infrastructure Public Key Infrastructure]] (PKI). For now, you do not need to understand these terms or how PKI works.

You must get and install a certificate before the Tuesday afternoon sessions. The procedure below covers all steps that you need to do, without explanation of the background. We want you to have the certificate ready to use, and various aspects will be explained as needed throughout the School.

There are several sections to the process. In some cases, you must wait for other people to take action in between the sections, which is noted where appropriate.

---++ Section ##sec#.: Requesting a Certificate

Most likely, you do not have an X.509 user certificate from !DigiCert or !DOEGrids already. However, if you are sure that you have a grid-ready certificate, skip to Section&nbsp;3, “Installing Your Certificate”.

Otherwise, continue with the following steps.

   1. <p>In a web browser, go to https://oim.grid.iu.edu/oim/certificaterequestuser</p>
   1. <p>Click on the “Request New” link located beneath the “USER CERTIFICATES” section in the left navigation area</p>\
       <p> %ATTACHURL%/Request_new.png </p>
   1. <p>Complete the fields in the *Contact Information* section:
      * <p>For the *Full Name* field, use the name that you are commonly known as. This field does not need to contain your full legal name, just enough to clearly identify you. Capitalize your names normally (i.e., not all lowercase).</p>
      * <p>For the *Phone* and *Email* fields, try to provide contact information that is likely to be useful over the next year or so. Imagine that we need to contact you about a problem with your certificate in, for example, next February.</p>
      * <p>For the *Password* field, please record your password reliably and securely. It is not stored in the system in any way. Instead, it is used to encrypt your private key and, for security reasons, is not stored and cannot be recovered by anyone for any reason. If you forget your password, the only option available is to invalidate the old certificate and submit a new certificate request.</p>
   1. <p>Complete the fields in the *Sponsor* section:
      * <p>For the *Virtual Organization*, select “OSGEDU”</p>
      <p> %ATTACHURL%/VO_select.png </p>
      * <p>For the *Sponsor* field, make sure that “Tim Cartwright &lt;cat@cs.wisc.edu&gt;” is selected</p>
      <p> %ATTACHURL%/Sponsor_select.png </p>
   1. <p>Read the OSG Policy Agreement, check the “I AGREE” checkbox, and click the “Submit” button</p>
      <p> %ATTACHURL%/OSG_Policy.png </p>
   1. <p>Shortly after submitting your request, you will receive an automated email acknowledging your request; it will contain your requested Distinguished Name (DN) and a link to the request ticket</p>
      <p> %ATTACHURL%/Request_email.png </p>
   1. <p>Wait for your request to be approved</p>
      <p> *Note:* The two people who are likely to approve your request are in the room! Tim Cartwright is one person, although he is fairly busy today. Vince Neal, from the OSG Grid Operations Center (GOC) is also present. One of these two people may come find you personally to verify your request. Do not be concerned, this is a normal part of the process! We will do our best to approve your request quickly.</p>


---++ Section ##sec#.: Downloading Your Certificate

After your certificate request is approved, you must download the certificate file to your computer.

   1. <p>When your request is approved, you will receive another automated email stating that your request has been approved</p>
       <p> %ATTACHURL%/Approved_email.png </p>
   1. <p>In the email, click on the link that appears after the text, “To retrieve your certificate please visit”</p>
       <p>This link will take you to the “User Certificate Requests” page in OIM.</p>
   1. <p>On the OIM page, find the section labeled “Next Action”</p>
       <p> %ATTACHURL%/Issue_cert_password.png </p>
   1. <p>Enter your password in the *top box* (not the cancellation one!), and click on the “Issue Certificate …" button</p>
       <p>The page will reload with new information.</p>
   1. <p>Find the section labeled “Certificates”, and click on the “Download Certificates & Private Key (PKCS12)” button</p>
       <p> *Note:* Save the resulting file to a location on your computer that you remember. You will need to find the saved =.p12= file in following steps.  The user has a time limit of 30 minutes to download their PKCS12 certificate after which the option will no longer be available, only the certificate in PKCS7 format.</p>


---++ Section ##sec#.: Installing Your Certificate

You must install your certificate in at least two places: your web browser(s) and, in a different format, on the =osg-ss-submit= machine.

---+++ Installing Your Certificate in a Web Browser

Unfortunately, there are so many different combinations of operating systems, web browsers, and so forth that we can give only general directions for installing your certificates properly. If you get stuck on this step, please contact the instructors, and we will help you through the process or find someone who can help.

Find the subsection that best applies to you:

---++++ OS X With Safari or Chrome

On OS X, both Safari and Chrome use the built-in login keychain to store and use certificates. Thus, you can install your certificate once and use it in both browsers. Installing the =.p12= file is easy:

   1. Start the Keychain Access application
   1. Select the “File > Import Items…” menu option
   1. In the dialog:
      1. Find and select your saved =.p12= file in the file browser section
      1. Select *login* from the “Destination Keychain:” drop-down menu
      1. Click the “Open” button
   1. In the new window that pops up, enter your certificate password and click the “OK“ button
       <p>If you requested your certificate as above, this is the same password you entered in Section 1, step 4.</p>
   1. Quit the Keychain Access application
   1. You may need to restart Safari or Chrome to pick up your new certificate

---++++ Firefox (Any OS)

Firefox uses its own store of certificates, so you load your certificate directly into the browser.

   1. Start the Firefox application
   1. Open the Preferences dialog
   1. Select the “Advanced” tab, then the “Encryption” sub-tab
   1. Click the “View Certificates” button
   1. Select the “Your Certificates” tab
   1. Click the “Import…” button at the bottom of the window
   1. Find and select your saved =.p12= file in the file browser
   1. Click the “Open” button
   1. In the new dialog that pops up, enter your certificate password and click the “OK“ button
       <p>If you requested your certificate as above, this is the same password you entered in Section 1, step 4.</p>
   1. Close all dialog windows

---+++ Installing Your Certificate on the Submit Machine

To install your certificate on the submit machine, =osg-ss-submit=, you must copy the certificate file there, then convert it to a more suitable format.

   1. Copy your saved =.p12= file to =osg-ss-submit.chtc.wisc.edu=
       <p>On OS X or Linux, start a local terminal window and use the =scp= program to upload the file:</p>
       <pre class="screen"> %UCL_PROMPT_SHORT% <strong>scp <em>certificate_file.p12</em> '<em>userid</em>@osg-ss-submit.chtc.wisc.edu:~/'</strong></pre>
       <p>If you are using Putty on Windows, start a command-line window and use [[http://the.earth.li/~sgtatham/putty/0.62/htmldoc/Chapter5.html the PSCP program]] to upload the file. Ask instructors for help if you get stuck.</p>
   1. Log in to =osg-ss-submit= (see [[UserSchool13Mon11LogIn][here]] if you have not done so yet)
   1. Run the following commands, substituting the actual name of your =.p12= certificate file as appropriate:\
       <pre class="screen">
%UCL_PROMPT_SHORT% <strong>mkdir $HOME/.globus</strong>
%UCL_PROMPT_SHORT% <strong>openssl pkcs12 -in <em>certificate_file.p12</em> -clcerts -nokeys -out $HOME/.globus/usercert.pem</strong>
%UCL_PROMPT_SHORT% <strong>openssl pkcs12 -in <em>certificate_file.p12</em> -nocerts -out $HOME/.globus/userkey.pem</strong>
%UCL_PROMPT_SHORT% <strong>chmod 0644 $HOME/.globus/usercert.pem</strong>
%UCL_PROMPT_SHORT% <strong>chmod 0400 $HOME/.globus/userkey.pem</strong>
</pre>
   1. Test your new certificate files:\
<pre class="screen">
%UCL_PROMPT_SHORT% <strong>grid-proxy-init</strong>
Your identity: <em>your DN is printed here</em>
Enter GRID pass phrase for this identity: <em>type password here - will not be displayed</em>
Creating proxy ................................... Done
Your proxy is valid until: <em>date and time</em>
</pre>


---++ Section ##sec#.: Register With the OSGEDU Virtual Organization

Finally, you must register your certificate with a __Virtual Organization__ or __VO__ as we usually say. Membership in the VO gives you access to certain kinds of grid computing resources. We will explain more about VOs and what they provide later in the School.

To register with our “OSGEDU” (OSG Education) VO, you must use a web browser that has your certificate installed (see above). *Note:* The VO website seems to work only with Chrome and Firefox, so it is best to use one of those browsers to complete this task.

   1. In Chrome or Firefox, go to https://voms.grid.iu.edu:8443/voms/osgedu/
   1. Under “Your certificate subject (DN)”, make sure that the DN of your certificate is correct
   1. Complete the rest of the fields in the form (again, this is long-term contact information in case there are problems)
   1. Click the “Register” button
   1. Watch your email for a confirmation of your *request* (check your spam folder, too!)
   1. Click the link in the email to confirm your request
   1. When your request is approved, you will receive another email with an approval message

%META:FILEATTACHMENT{name="Approved_email.png" attachment="Approved_email.png" attr="h" comment="" date="1404407627" path="Approved_email.png" size="34119" stream="Approved_email.png" tmpFilename="/usr/tmp/CGItemp16634" user="TimCartwright" version="1"}%
%META:FILEATTACHMENT{name="Issue_cert_password.png" attachment="Issue_cert_password.png" attr="h" comment="" date="1404407676" path="Issue_cert_password.png" size="31774" stream="Issue_cert_password.png" tmpFilename="/usr/tmp/CGItemp16723" user="TimCartwright" version="1"}%
%META:FILEATTACHMENT{name="OSG_Policy.png" attachment="OSG_Policy.png" attr="h" comment="" date="1404407689" path="OSG_Policy.png" size="40227" stream="OSG_Policy.png" tmpFilename="/usr/tmp/CGItemp16771" user="TimCartwright" version="1"}%
%META:FILEATTACHMENT{name="Request_email.png" attachment="Request_email.png" attr="h" comment="" date="1404407701" path="Request_email.png" size="30635" stream="Request_email.png" tmpFilename="/usr/tmp/CGItemp16869" user="TimCartwright" version="1"}%
%META:FILEATTACHMENT{name="Request_new.png" attachment="Request_new.png" attr="h" comment="" date="1404407713" path="Request_new.png" size="48663" stream="Request_new.png" tmpFilename="/usr/tmp/CGItemp16651" user="TimCartwright" version="1"}%
%META:FILEATTACHMENT{name="Sponsor_select.png" attachment="Sponsor_select.png" attr="h" comment="" date="1404407726" path="Sponsor_select.png" size="7077" stream="Sponsor_select.png" tmpFilename="/usr/tmp/CGItemp16671" user="TimCartwright" version="1"}%
%META:FILEATTACHMENT{name="VO_select.png" attachment="VO_select.png" attr="h" comment="" date="1404407740" path="VO_select.png" size="12328" stream="VO_select.png" tmpFilename="/usr/tmp/CGItemp16820" user="TimCartwright" version="1"}%
