%META:TOPICINFO{author="BalamuruganDesinghu" date="1437997485" format="1.1" reprev="1.11" version="1.11"}%
%META:TOPICPARENT{name="UserSchool15Materials"}%
<style type="text/css">
pre em { font-style: normal; background-color: yellow; }
pre strong { font-style: normal; font-weight: bold; color: #008; }
</style>

---+ Using HTCondor file transfer 

<center>
<img src="%ATTACHURLPATH%/data_tranfer_1.jpg " alt="data_tranfer_1.jpg " width='400' height='150'/>
</center>

In this example, we focus on how to transfer the input files from the submit node to workers.   A job wrapper file is preferred to execute the program and is transferred along with the job.  For vanilla universe jobs, condor transfers back the output files. So we need to take care of sending the input files to the workers.

<pre class="screen">
%UCL_PROMPT_SHORT% <strong>cd ~/namd/namd-ct-local </strong>
%UCL_PROMPT_SHORT% <strong>ls </strong>
namd_run.sh    # Job wrapper script to execute NAMD job
namd_run.submit    # Condor job description file
par_all27_prot_lipid.inp  #  Parameter file: required by NAMD
ubq_gbis_eq.conf    # NAMD input configuration file
ubq.pdb    # Protein structure file: required by NAMD
ubq.psf     # Protein topology file: required by NAMD
</pre>

To load the NAMD program, we use the OSG Distributed Environment Modules on login.osgconnect.net. OSG (See https://support.opensciencegrid.org/support/solutions/articles/5000634394-accessing-software-using-distributed-environment-modules for more details)

 Here is our job wrapper script:
<pre class="file">
#!/bin/bash
source /cvmfs/oasis.opensciencegrid.org/osg/modules/lmod/current/init/bash    # sets up the module environment
module load namd/2.9    # Loads the NAMD module version 2.9
namd2 ubq_gbis_eq.conf > ubq_gbis_eq.log    # executes NAMD simulation 
</pre> 

In  the job description file (==namd_run.submit==),  the key word  =transfer_input_files= is empty. The input files ==par_all27_prot_lipid.inp==, ==ubq_gbis_eq.conf==, ==ubq.pdb==, and ==ubq.psf== need to be transfered along with the job.

<pre class="file">
Universe = vanilla
Executable = namd_run.sh
transfer_input_files = 
output  = job.out
error = job.error
log = job.log
requirements = (HAS_CVMFS_oasis_opensciencegrid_org =?= TRUE)
Queue 1
</pre>

In condor job description file, we make sure that the distributed environmental modules are available on the remote machine via ==requirements = (HAS_CVMFS_oasis_opensciencegrid_org =?= TRUE)==. 

Now submit the job
<pre class="screen">
%UCL_PROMPT_SHORT% <strong>condor_submit namd_run.submit </strong>
</pre>
and check the status of the job with JOBID
<pre class="screen">
%UCL_PROMPT_SHORT% <strong>condor_q JOBID </strong>
</pre>

Once the job finished (may take 3-5 minutes  run time) you will see bunch of output files (trajectory, log file with energy, velocity and so on).

After the job has completed, run:

<pre class="screen">
%UCL_PROMPT_SHORT% <strong> tail -n 1 ubq_gbis_eq.log   </strong>
</pre>

and if you see the following line
<pre>
Program finished.
</pre> 
your job was successful. 


---++ Compress input files

Sometimes when you have a lot of input files it makes more sense to compress them before sending them with a job. For this exercise, we want to compress our four NAMD input files and send them to the remote worker node. 

For this part of the exercise, you will need to:

   1. Compress the input files using the =tar= command
   1. Modify =transfer_input_files= in the file =namd_run.submit= to transfer your compressed file
   1. Edit =namd_run.sh= and add a line to decompress the input files.

HINT: Compressing files
<pre class="screen">
%UCL_PROMPT_SHORT% <strong> tar -cvzf [compressed filename] [list of files] </strong>
</pre>

Replace =-c= with =-x= to decompress. Refer to the slides if you get confused.

%BR%
-- Main.BalamuruganDesinghu - 23 Jul 2015

%META:FILEATTACHMENT{name="data_tranfer_1.jpg" attachment="data_tranfer_1.jpg" attr="" comment="Transfer input files. Condor transfers the wrapper script by default." date="1437761680" path="data_tranfer_1.jpg" size="24319" stream="data_tranfer_1.jpg" tmpFilename="/usr/tmp/CGItemp9889" user="BalamuruganDesinghu" version="1"}%
