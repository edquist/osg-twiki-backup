%META:TOPICINFO{author="IgorSfiligoi" date="1372172037" format="1.1" version="1.6"}%
%META:TOPICPARENT{name="UserSchool13Materials"}%
---+ 2013 OSG User School - Running jobs with glideinWMS

Time to spend on this: 1 hour 

Reminder: All exercises are run on the [[OSGSS2013TueGlideinSetup][school infrastructure]].

During this exercise, we will create a video using the [[http://www.povray.org/][POV-Ray tool]].
There is really nothing glideinWMS specific about this task, but it does take a lot of CPU cycles to create a decent video,
so using a DHTC system like glideinWMS is a good way to finish the task in a reasonable way.

This exercise session has all the need files ready to be used. So, if you do not feel like doing much computing related work, you can basically just cut-and-paste through it.
However, I would encourage you to try to understand what is being done and tweak it a little bit here and there.

---+++ The available files

The [[http://www.povray.org/][povray]] executable is available in
<pre class="screen">
/share/video1/povray/povray.gz
</pre>
It is compressed, so it uses less network bandwidth (remember, we will use remote resources).

The scene description files are located in
<pre class="screen">
/share/video1/pov/tree.tgz
</pre>

We use a tarball since they are composed of several files, with the top file being
<pre class="screen">
TreeAni.pov
</pre>

The description files are tuned to use a clock in the 0-20 range, and povray will create a still snapshot at each point in time we specify. 
To collate them together, we will use [[http://libav.org/avconv.html][avconv]], a copy of which is available in
<pre class="screen">
/share/video1/avconv/avconv
</pre>

---+++ Creating a draft video

The total compute time need to create a 600 frame video is about 100 hours. So, before wasting them on something that might not work, let's first create a draft version of the video.

Create a working directory, and copy into it
<pre class="screen">
/share/video1/condor/basic/basic.condor
</pre>

At this point, just run condor_submit with this file, and after a while you will get the snapshots back into this directory. Use the standard HTCondor commands to monitor what's going on.<br>
(should take in the order of 10 minutes)<br>
Hint: Use the long version of the monitoring commands, and grep for MATCH and GLIDEIN.

Once you get all the 30 files back, to collate them together run
<pre class="screen">
/share/video1/avconv/avconv -r 1 -i TreeAni%02d.png -r 1 TreeAni_lo.avi
</pre>

Copy the avi file to your laptop to visualize it.

---+++ Creating the final video

In parallel with creating the draft, we can start preparing and submitting the jobs to create the real, high-def video.<br>
(we can do it in parallel... if the draft turns out to be bad we can always cancel the jobs in the queue)

Since may not have enough time to create all 600 high quality frames in the available time, 
we will take the HTC approach, and try to get the best video possible before the deadline.

This implies we will create the frames in an a interlace mode, and will fill any spaces between them with previous frames, if needed.<br>
I.e. we will first create frames 0,10,20,..590, then 4,14,... and so on. 

If you want to just cut-and-paste, create a new working directory and copy in:
<pre class="screen">
/share/video1/condor/detailed/detailed.condor
</pre>

Submit and monitor as usual.<br>
(each job will take between 10 and 30 minutes to complete)

You are of course encouraged to understand what's going on.

Once you have at least the first set of frames back in your work directory, this script will create the best possible avi file from them:
<pre class="screen">
/share/video1/avconv/avconv_partial_600.sh
</pre>

-- Main.IgorSfiligoi 

%META:FILEATTACHMENT{name="tree.tgz" attachment="tree.tgz" attr="" comment="POVRay config files of the example" date="1371779075" path="tree.tgz" size="385795" stream="tree.tgz" tmpFilename="/usr/tmp/CGItemp16523" user="IgorSfiligoi" version="1"}%
%META:FILEATTACHMENT{name="basic.sh" attachment="basic.sh" attr="" comment="Basic wrapper script" date="1371779111" path="basic.sh" size="505" stream="basic.sh" tmpFilename="/usr/tmp/CGItemp16557" user="IgorSfiligoi" version="1"}%
%META:FILEATTACHMENT{name="detailed.sh" attachment="detailed.sh" attr="" comment="Detailed wrapper script" date="1371779132" path="detailed.sh" size="563" stream="detailed.sh" tmpFilename="/usr/tmp/CGItemp16485" user="IgorSfiligoi" version="1"}%
%META:FILEATTACHMENT{name="basic.condor" attachment="basic.condor" attr="" comment="HTCondor submit file for the basic example" date="1371779163" path="basic.condor" size="377" stream="basic.condor" tmpFilename="/usr/tmp/CGItemp16355" user="IgorSfiligoi" version="1"}%
%META:FILEATTACHMENT{name="detailed.condor" attachment="detailed.condor" attr="" comment="HTCondor submit file for the detailed example" date="1371779186" path="detailed.condor" size="682" stream="detailed.condor" tmpFilename="/usr/tmp/CGItemp16463" user="IgorSfiligoi" version="1"}%
%META:FILEATTACHMENT{name="avconv_partial_600.sh" attachment="avconv_partial_600.sh" attr="" comment="Detailed vidoe creation script" date="1371779263" path="avconv_partial_600.sh" size="895" stream="avconv_partial_600.sh" tmpFilename="/usr/tmp/CGItemp16602" user="IgorSfiligoi" version="1"}%
