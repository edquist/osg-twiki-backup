%META:TOPICINFO{author="BenClifford" date="1172842391" format="1.1" version="1.2"}%
%META:TOPICPARENT{name="LectureTwoTutorial"}%
<link rel="stylesheet" type="text/css" href="%PUBURL%/%WEB%/WorkshopTutorialModules/exercises.css">

---+!! Obtaining a New Certificate

%TOC%

%STARTINCLUDE%
%EDITTHIS%

A valid certificate was already installed for you and configuration was set up to use it. In this step we will attempt to get a new certificate from Globus Certificate Service. Globus Certificate Service(GCS) is a web-based CA service that issues certificates.

These are not secure certificates since anyone can obtain certificates from this CA and are generally used for testing. But since an infrastructure needs to trust a CA for anyone to use the certificate issued by the CA, issuing such certificates doesn't pose any security threat. For instance the certificates you obtain from this CA can be used to submit jobs or transfer files on the server running on your local machine, but will fail if you submit jobs on the remote cluster, since the cluster does not trust GCS CA.

---+++ Create a certificate request
<pre class="screen">
[train31 ~]$ <userinput>grid-cert-request -dir testCerts</userinput>
Enter your name, e.g., John Smith: <userinput>Trainee 31</userinput>
A certificate request and private key is being created.
You will be asked to enter a PEM pass phrase.
This pass phrase is akin to your account password, 
and is used to protect your key file.
If you forget your pass phrase, you will need to
obtain a new certificate.

Generating a 1024 bit RSA private key
..........++++++
...............++++++
writing new private key to '/home/train31/testCerts/userkey.pem'
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
...
A private key and a certificate request has been generated with the subject:

/C=US/O=Globus Alliance/OU=User/CN=Trainee 31

If the CN=Trainee 31 is not appropriate, rerun this
script with the -force -cn "Common Name" options.

Your private key is stored in /home/train31/testCerts/userkey.pem
Your request is stored in /home/train31/testCerts/usercert_request.pem
..
[train31 ~]$ 
</pre>

The command will ask for a pass phrase and this is used to encrypt the private key. The =-dir= option stores the created certificates in the specified directory. This is so that we don't overwrite the certificates in the default directory 

%NOTE% Ignore notes on emailing it. We will upload it.

<pre class="screen">
[train31 ~]$ <userinput>ls -lt testCerts/</userinput>
total 8
-rw-r--r--  1 train31 train31 1322 Jun 23 10:10 usercert_request.pem
-r--------  1 train31 train31  963 Jun 23 10:10 userkey.pem
-rw-r--r--  1 train31 train31    0 Jun 23 10:10 usercert.pem
[train31 ~]$ 
</pre>

The =testCerts= directory has three files: 
   1. =usercert_request.pem=: the request that the CA needs to sign.
   1. =userkey.pem=: the file with encrypted private key. Note the permissions on the file.
   1. =usercert.pem=: a place holder for the signed certificate obtained from the CA. It currently has a zero file size.


---+++ Sign the Request
The request must now be signed by the CA, which in our case is the GCS. The GCS allows for the certificate request to be pasted on to their webpage. 
   1. In your browser open [[http://gcs.globus.org:8080/gcs/index.html][Globus Certificate Service]]. 
   1. Click *Acquiring User Certificate* under *Available Services*. %BR% The first two steps have already been completed: the CA certificate has been installed on your machine.
   1, Choose the second option, *Paste the certificate request text in the box below*.
   1. Open =testCerts/usercert_request.pem=, copy its complete contents and paste them into the text box. %BR% %BR% The service returns the signed certificate. 
   1. Copy the contents from =----BEGIN CERTIFICATE----= to =----END CERTIFICATE----= into =testCerts/usercert.pem=.

---+++ Proxy certificate using GCS Certificates
First we need to ensure the GCS certificates have been installed correctly and a proxy can be generated.

<pre class="screen">
[train31 ~]$ <userinput>grid-proxy-init -cert testCerts/usercert.pem -key testCerts/userkey.pem -out gcsProxy -verify</userinput>
Your identity: /C=US/O=Globus Alliance/OU=User/CN=10c00791bfb.54294d53
Enter GRID pass phrase for this identity: <em><strong># not echoed!</strong></em>
Creating proxy ............................................ Done
Proxy Verify OK
Your proxy is valid until: Fri Jun 23 22:14:26 2006
[train31 ~]$ 
</pre>

The certificate name is chosen in random by GCS. This is because there is no explicit Registration Authority to determine that the name is unique. There are several options used:
   * =-cert= and =-key= allow you to specify non-default certificate and key file locations.
   * =-out= allows you to specify a non-default location for the proxy file.
   * =-verify= ensures that both the certificates used to create proxy and the CA are installed correctly and valid.

The contents of this proxy can be viewed using the _grid-proxy-info_.

<pre class="screen">
[train31 ~]$ <userinput>grid-proxy-info -file gcsProxy </userinput>
subject  : /C=US/O=Globus Alliance/OU=User/CN=10c00791bfb.54294d53/CN=1488313937
issuer   : /C=US/O=Globus Alliance/OU=User/CN=10c00791bfb.54294d53
identity : /C=US/O=Globus Alliance/OU=User/CN=10c00791bfb.54294d53
type     : Proxy draft (pre-RFC) compliant impersonation proxy
strength : 512 bits
path     : gcsProxy
timeleft : 11:58:33
[train31 ~]$ 
</pre>

The =-file= allows you to specify a non-default location for the proxy file.

The environment variable _X509_USER_PROXY_ can be set to the proxy location. These tools will use that rather than default location. 

%NOTE% The issuer of the proxy is the DN from your GCS certificate.

%STOPINCLUDE%

%BOTTOMMATTER%
-- Main.ForrestChristian - 2007 Jan 29: pulled from original %BR%