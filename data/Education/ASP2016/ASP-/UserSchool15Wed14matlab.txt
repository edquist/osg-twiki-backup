%META:TOPICINFO{author="ChristinaKoch" date="1437082437" format="1.1" version="1.2"}%
%META:TOPICPARENT{name="UserSchool15Materials"}%
<style type="text/css">
pre em { font-style: normal; background-color: yellow; }
pre strong { font-style: normal; font-weight: bold; color: #008; }
</style>

---+ Wednesday Exercise 1.4: Matlab

Matlab is licensed.  One way to run Matlab without a license is to compile Matlab .m files into a binary file and run the binary by using a set of files called the Matlab runtime. Same wrapper script technique as last exercise of previous session.  

---++ Compiling Matlab

Log in to the CHTC submit node.  Make directory.  Download or copy code to =spline.m=

<pre class="file">
pp =[zeros(1,7); 5.4, 3, 6.9, 2.75, 2.5, .5, 5];
alpha = 2*pi/3; ca = cos(alpha); sa = sin(alpha); c = [ca sa;-sa ca];
d = [0 0 .05 -.05;1 -1 .98 .98]; d = [d c*d];
yin = rscvn([pp(:,[7,1:3]),c*pp(:,3:4),pp(:,3)], d(:,[1 2 1 4 7 5 1]));
fnplt(yin), hold on, fnplt(fncmb(yin,c)), fnplt(fncmb(yin,c'))
yang = rscvn([pp(:,6),-pp(:,6),pp(:,5),c*pp(:,4)],[d(:,[2 1 1]),c(:,2)]);
fnplt(yang), fnplt(fncmb(yang,c)), fnplt(fncmb(yang,c'))
axis([-7.2 7.2 -7.2 7.2]), axis equal, axis off, hold off
print('medallion','-dpng')
</pre>

Need access to a machine w/ matlab installed.  In the CHTC pool, two build machines.  Can't ssh to directly, must use interactive job.  

Interactive job - create =compile.submit= file

(add comments to this, like in our interactive submit example at chtc.cs.wisc.edu/inter-submit.shtml?)

<pre class="file">
universe = vanilla

output = compile.out
error = compile.err
log = compile.log

+IsBuildJob = true
requirements = (OpSysAndVer =?= "SL6") && ( IsBuildSlot == true )

should_transfer_files = YES
when_to_transfer_output = ON_EXIT

transfer_input_files = spline.m

queue
</pre>

<pre class="screen">
%UCL_PROMPT_SHORT% <strong>condor_submit -i compile.submit</strong>
</pre>

Now on submit node.  Different versions of Matlab.  Compile using: 

<pre class="screen">
%UCL_PROMPT_SHORT% <strong>/usr/local/MATLAB/R2013b/bin/mcc -m -R -singleCompThread -R -nodisplay -R -nojvm foo.m</strong>
</pre>

=exit= , should return to submit node, =ls -l= note which files have been created

---++ Wrapper script

Wrapper script, like GROMACS example.  Matlab compile has pre-written most of it.  Just need to add steps to access runtime (discuss why we download, etc.)

<pre class="file">
##run_spline.sh

wget http://proxy.chtc.wisc.edu/SQUID/r2014b.tar.gz 
tar xzf r2014b.tar.gz
rm r2014b.tar.gz 
</pre>

---++ Submit file

Make copy of previous wrapper submit file (=gromacs.submit=), named =matlab.submit=.  Which lines to change?  

* executable: run_spline.sh
* transfer_input_files: spline
* arguments -> look at the readme!  unpack the tar file to find out directory name

submit job

<pre class="screen">
%UCL_PROMPT_SHORT% <strong>condor_submit matlab.submit</strong>
</pre>

Should return =medallion.png=