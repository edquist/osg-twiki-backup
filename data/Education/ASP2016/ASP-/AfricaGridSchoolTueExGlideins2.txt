%META:TOPICINFO{author="RobQ" date="1343655779" format="1.1" reprev="1.1" version="1.1"}%
%META:TOPICPARENT{name="AfricaGridSchool12Materials"}%
---+ Tue Morning Exercise - Using the glideinWMS - Part 2

<!-- ASP 2012 Defaults
   * Local UCL_HOST = %URLPARAM{"INPUT_HOST" encode="quote" default="osg-ss-glidein"}%
   * Local UCL_USER = %URLPARAM{"INPUT_USER" encode="quote" default="user"}%
   * Local UCL_DOMAIN = %URLPARAM{"INPUT_DOMAIN" encode="quote" default="chtc.wisc.edu"}%
   * Local UCL_CWD= %URLPARAM{"INPUT_CWD" encode="quote" default="~/osg_school/glidein1"}%
   * Local UCL_JOB= %URLPARAM{"INPUT_JOB" encode="quote" default="555.0"}%
-->

---+ Introduction
In this session you will try to run some compute jobs with glideinWMS.

---+ Prerequisite 

Learn how to use our [[https://twiki.grid.iu.edu/bin/view/Education/AfricaGridSchoolTueGlideinSetup][glideinWMS installation]].

Run the [[https://twiki.grid.iu.edu/bin/view/Education/AfricaGridSchoolTueExGlideins][Part 1 of this exercise]].

---+ Run a BLAST example -  The right way

You should have experienced some problems running the [[OSGSS2012CondorBLAST][BLAST jobs]] without any changes.

How would you fix the problem?

%TWISTY{
mode="div"
showlink="Show solution 1."
hidelink="Hide solution 1."
showimgleft="%ICONURLPATH{toggleopen-small}%"
hideimgleft="%ICONURLPATH{toggleclose-small}%"
}%
The glideinWMS policy allows us to only run on sites that have BLAST pre-installed; it was mentioned in the [[OSGSS2012TueGlideinSetup][glideinWMS policy document]].<br>
Just add <pre>
+REQUIRE_BLAST = True
</pre> to the job submission file.

One thing it is not in that document, is that different sites may have BLAST installed in a different location.
For this reason, the glideins also advertise <pre>
BLAST_PATH
</pre> in the environment. I.e. the BLST executable is now in <pre>
$BLAST_PATH/bin/blastp
</pre>. Change your wrapper script accordingly.

</pre>

Moreover, we know BLAST is installed locally, but the [[OSGSS2012TueGlideinSetup][default glideinWMS policy]] prevents us to run locally.<br>
Change this by adding also <pre>
+OFFSITE_ONLY = False
</pre> to the job submission file.

Try them out (say, a cluster of 5), see where they run and what results you get back. 
%ENDTWISTY%
<br>

%TWISTY{
mode="div"
showlink="Show solution 2."
hidelink="Hide solution 2."
showimgleft="%ICONURLPATH{toggleopen-small}%"
hideimgleft="%ICONURLPATH{toggleclose-small}%"
}%
Instead of restricting ourselves to a subset of sites, let's instead transfer the necessary files to the worker node.

We need two pieces:
   * The binary itself.<br>Since blast is statically linked, just transfer the file itself and execute it.
   * The database.<br>Here we need more than a single file; the database is composed of many files; in case of the yeast DB, it is yeast.aa*<br>The best way to do it, is to tar them up and untar them once on the worker node.

Can you change the submit file and the wrapper script accordingly?

%TWISTY{
mode="div"
showlink="Show script and submit file"
hidelink="Hide script and submit file"
showimgleft="%ICONURLPATH{toggleopen-small}%"
hideimgleft="%ICONURLPATH{toggleclose-small}%"
}%
<pre class="screen">
# create tar file
m=$PWD
cd /share/blast/data/; tar -czf $m/yeast.tgz yeast.aa*
cd $m
</pre>

<pre style="margin-left:4em" class="screen">
Universe   = vanilla
Executable = myscript.sh
arguments = query1 myoutput
Log        = mytest.log
Output     = mytest.out.$(Cluster).$(Process)
Error      = mytest.error.$(Cluster).$(Process)
transfer_input_files=query1,/share/blast/bin/blastp,yeast.tgz
should_transfer_files   = YES
when_to_transfer_output = ON_EXIT
Queue 5
</pre>

<pre style="margin-left:4em" class="screen">
#!/bin/sh

if [ $# -ne 2 ]; then
    echo "Usage: run-blast <query> <output>"
    exit 1
fi

chmod a+x blastp
tar -xzf yeast.tgz

# Run the query
./blastp -db yeast.aa -query $1  > $2
</pre>
%ENDTWISTY%
<br>
Try them out (again, say 5), see where they run and what results you get back. 

%TWISTY{
mode="div"
showlink="What next?"
hidelink="Hide hint"
showimgleft="%ICONURLPATH{toggleopen-small}%"
hideimgleft="%ICONURLPATH{toggleclose-small}%"
}%
See how big was the yeast tar file.

Now try to create a tar file of the [[OSGSS2012CondorBLAST][nr database]].

Do you think it is reasonable to transfer such a big file each time your job starts? Let's discuss it.
%ENDTWISTY%
<br>

%ENDTWISTY%
<br>



---+ Customize this Document

%ICON{"warning"}% %RED% Please change your user name and click on the Customize button!%ENDCOLOR%
<form action="%SCRIPTURLPATH{"view"}%/%WEB%/%TOPIC%">
<table>
  <tr>
    <td>
      Login Name
    </td>
    <td>
      <input size=100 type="text" name="INPUT_USER" value="%UCL_USER%"/>
    </td>
  </tr>
  <tr>
    <td>
      Job number
    </td>
    <td>
      <input size=100 type="text" name="INPUT_JOB" value="%UCL_JOB%"/>
    </td>
  </tr>
  <tr>
    <td>
     &nbsp;
     <input type="submit" class="twikiSubmit" value="Customize" />
    </td>
  </tr>
</table>
</form>

-- Main.IgorSfiligoi - 25 Jun 2012



-- Main.RobQ - 30 Jul 2012
