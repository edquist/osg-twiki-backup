%META:TOPICINFO{author="ForrestChristian" date="1178117060" format="1.1" version="1.4"}%
%META:TOPICPARENT{name="LectureTwoTutorial"}%
<link rel="stylesheet" type="text/css" href="%PUBURL%/%WEB%/WorkshopTutorialModules/exercises.css">

---+!! Obtaining a New Certificate with cacl

%TOC%

%STARTINCLUDE%
%EDITTHIS%

A valid certificate was already installed for you and configuration was set up to use it. In this step we will attempt to get a new certificate from the San Diego Supercomputer Center certificate authority (SDSC CA) using a command-line tool called cacl.

Certificates issued by the SDSC CA will be valid on many grid resources, as it is a widely trusted certificate authority.

---+++ Log into SDSC login host

<pre class="screen">
$ <userinput>ssh tg-login.sdsc.teragrid.org</userinput>
Enter password: <userinput>[SDSC password from instructors]</userinput>
Last login: Mon Mar 19 16:05:02 2007 from h-66-134-156-130.chcgilgm.covad.net
Welcome to the TeraGrid Itanium2 Linux Cluster
San Diego Supercomputer Center

---
This system may be used by authorized persons only.
 
Unauthorized individuals' activity may be monitored 
and/or recorded by administrative personnel.  In 
the course of such monitoring or system maintenance, 
the activities of authorized users may also be monitored.
 
Use of this system expressly implies consent to such 
monitoring and is advised that evidence of criminal 
activity may be provided to law enforcement officials. 
---

Email help@teragrid.org for assistance.

Check http://clumon.sdsc.edu for cluster status.

Please visit http://news.teragrid.org and add your email address under "Manage Subscriptions" to receive email updates about the status of the system. 

Please use the parallel filesystem /gpfs for output from batch jobs, not your home directory.

*** NOTICE *** The /gpfs filesystem is being regularly purged.  Any files older than 4 days not associated with a queued or active batch job may be purged.  Please be sure to back up your data to a long-term archive.  ***

If you have questions, send them to SDSC consultants - send email to
help@teragrid.org or use the webpage at: www.sdsc.edu/user_services/consulting .

Directory: /users/%LOGINNAME%
Tue Mar 20 08:29:58 PDT 2007
tg-login1 /users/%LOGINNAME%> 

</pre>

<!-- ***  Comments plugin to create comments table for section   ***    -->
<span style="text-align:center; font-weight:bold; font-size:1.2em;">ADD A COMMENT</span>
%STARTMore%

%TABLE{ }%
|  *COMMENT*  |  *NAME*  |  *DATE*  |
%COMMENT{ type="tableappend" }%

%ENDMore%
<!-- ***  End Comment                                            ***    -->


---+++ Request credential from cacl

<pre class="screen">
tg-login1 /users/%LOGINNAME%> <userinput>cacl</userinput>

You already have a .globus directory.  It will be moved to 
.globus.old and a new .globus directory will be created. 

Please enter your login password: <userinput>SDSC password from instructors</userinput>
 
Next you will be prompted to enter a password which will serve as both
the encryption key for your certificate's private key and as the 
'export password' for your PKCS#12 converted certificate.  Please choose 
a password that you can remember, you will need to use it in the future.


Please enter your private key encryption password: <userinput>choose your own password and remember it!</userinput>
Verifying private key password, please reenter password: <userinput>same again</userinput>



You already have a certificate issued by this CA.  If you have forgotten 
your private key encryption password, lost your certificate or key,
or suspect that your certificate and key may have been compromised you
can request that your current certificate be revoked.  This will make
current certifcate invalid and unuseable.  It will also allow you to
immediately get a new certificate to replace your current certificate.



Would you like your current certificate to be revoked? [yes/no]: <userinput>yes</userinput>



You now have a .globus directory containing the following files: 

usercert.p12 - Your digital certificate and private key in 
               a PKCS#12 format certificate 

usercert.pem - Your digital certificate, signed by the CA 
               daemon 

userkey.pem  - Your encrypted private key matching the 
               public key contained in your usercert.pem 


********************************************************** 

 YOUR CERTIFICATE IS VALID FOR FOUR YEARS, DO NOT FORGET 
 YOUR PRIVATE KEY ENCRYPTION PASSWORD AND, DO NOT DELETE 
 YOUR .globus DIRECTORY. 

********************************************************** 

tg-login1 /users/%LOGINNAME%> 
</pre>

---+++ Copy credentials from SDSC to login host


<pre class="screen">
tg-login1 /users/%LOGINNAME%> <userinput>logout</userinput>
Connection to tg-login.sdsc.teragrid.org closed.

$ <userinput>mkdir ~/sdsccert</userinput>

$ <userinput>scp tg-login.sdsc.teragrid.org:.globus/* ~/sdsccert/</userinput>
Enter password:
usercert.p12                                  100% 2878     2.8KB/s   00:00    
usercert.pem                                  100% 4998     4.9KB/s   00:00    
userkey.pem                                   100% 1743     1.7KB/s   00:00    
$ 

</pre>

---+++ Proxy certificate using CACL Certificates
First we need to ensure the SDSC certificates have been installed correctly and a proxy can be generated.

<pre class="screen">
[%LOGINNAME% ~]$ <userinput>grid-proxy-init -cert sdsccert/usercert.pem -key sdsccert/userkey.pem -out sdscProxy -verify</userinput>
Your identity: %CERTSUBJECT%
Enter GRID pass phrase for this identity: <em><strong># not echoed!</strong></em>
Creating proxy ............................................ Done
Proxy Verify OK
Your proxy is valid until: Fri Jun 23 22:14:26 2006
[%LOGINNAME% ~]$ 
</pre>

There are several grid-proxy-init options used:
   * =-cert= and =-key= allow you to specify non-default certificate and key file locations.
   * =-out= allows you to specify a non-default location for the proxy file.
   * =-verify= ensures that both the certificates used to create proxy and the CA are installed correctly and valid.

The contents of this proxy can be viewed using the _grid-proxy-info_.

<pre class="screen">
[%LOGINNAME% ~]$ <userinput>grid-proxy-info -file sdscProxy </userinput>
subject  : /C=US/O=Globus Alliance/OU=User/CN=10c00791bfb.54294d53/CN=1488313937
issuer   : /C=US/O=Globus Alliance/OU=User/CN=10c00791bfb.54294d53
identity : /C=US/O=Globus Alliance/OU=User/CN=10c00791bfb.54294d53
type     : Proxy draft (pre-RFC) compliant impersonation proxy
strength : 512 bits
path     : sdscProxy
timeleft : 11:58:33
[%LOGINNAME% ~]$ 
</pre>

The =-file= allows you to specify a non-default location for the proxy file.

The environment variable _X509_USER_PROXY_ can be set to the proxy location. These tools will use that rather than default location. 

%NOTE% The issuer of the proxy is the DN from your SDSC certificate.

<!-- ***  Comments plugin to create comments table for section   ***    -->
<span style="text-align:center; font-weight:bold; font-size:1.2em;">ADD A COMMENT</span>
%STARTMore%

%TABLE{ }%
|  *COMMENT*  |  *NAME*  |  *DATE*  |
%COMMENT{ type="tableappend" }%

%ENDMore%
<!-- ***  End Comment                                            ***    -->


%STOPINCLUDE%
<!--                                                                            
      * Set LOGINHOST = workshop1.lac.uic.edu
      * Set LOGINIP = 131.193.181.56
      * Set GRIDHOST = tg-login.sdsc.teragrid.org
      * Set OTHERHOST = workshop2.lac.uic.edu
      * Set CERTSUBJECT = /O=Grid/OU=OSG/CN=Training User 99
      * Set LOGINNAME = train99
      * Set HOMEDIR = /home/%LOGINNAME%
--> 

%BOTTOMMATTER%

-- Main.BenClifford - 19 Mar 2007 based on ObtainingANewCertificateWithCacl
-- Main.ForrestChristian - 24 Mar 2007 added variables