%META:TOPICINFO{author="IgorSfiligoi" date="1309286374" format="1.1" version="1.3"}%
%META:TOPICPARENT{name="OSGSS2011Materials"}%
---+ Overlay Exercises - Overlay pool basics

This exercise will give you some experience using glideinWMS.

%TOC%

---++ Environment

We will use the usual Condor submit host:<br>
=vdt-itb.cs.wisc.edu=

The glideinWMS is installed alongside the local Condor pool.

There will be no shared file system between the submit and the execute hosts, so you will should plan on transferring all the needed files with you.

---++ Exercise 1 - Overlay job basics

As stated above, the glideinWMS is installed alongside the regular Condor pool.

To tell the jobs to use the glideins (and glideins only), you just need to add:
<pre style="margin-left:4em" class="screen">
+DESIRED_Sites="any"
requirements = GLIDEIN_Site=!=UNDEFINED
</pre>
to any vanilla jobs.

For example:
<pre style="margin-left:4em" class="screen">
# this is standard Condor part
Universe = vanilla
Executable = &lt;your executable here&gt;
Arguments  = &lt;your arguments here&gt;
transfer_input_files = &lt;list any additional files you need here&gt;
Log        = simple.log
Output     = simple.out.$(Cluster).$(Process)
Error      = simple.error.$(Cluster).$(Process)

# this tells glideinWMS you want to run on remote resources
+DESIRED_Sites="any"
# this forces the job to run on glideins only
requirements = GLIDEIN_Site=!=UNDEFINED

Queue &lt;as many as you need&gt;
</pre>

Each of the students should submit 10 jobs. Pick any job you want; you can take any of the ones you run today or yesterday, or create a new one if you like; just make sure that it lasts at least a minute, and not more than about ten minutes.

Can you tell where they are running?<br>
%TWISTY{
showlink="Show solution"
hidelink="Hide solution"
start="hide"
mode="div"
showimgleft="%ICONURLPATH{toggleopen-small}%"
hideimgleft="%ICONURLPATH{toggleclose-small}%"
}%
Each job has an attribute called =MATCH_GLIDEIN_Site=. You can look at it using condor_q.

Each job also has a =RemoteHost= attribute that tells you exactly which node it is running on.
%ENDTWISTY% 

When they are finished, do you know where they ran?<br>
%TWISTY{
showlink="Show solution"
hidelink="Hide solution"
start="hide"
mode="div"
showimgleft="%ICONURLPATH{toggleopen-small}%"
hideimgleft="%ICONURLPATH{toggleclose-small}%"
}%
The  =MATCH_GLIDEIN_Site= is preserved even when the job finishes. You can look at it using condor_history.
%ENDTWISTY% 

What do you think of the experience.

---++ Exercise 2 - Selecting a site

In the previous exercise, you told the glideinWMS to run just anywhere.
Suppose you had data pre-installed at a site... how do you limit where will the jobs go?

The answer is in the =DESIRED_Sites= attribute you publish in your job.
Instead of using ="any"=, provide a list of sites (coma separated).

Then limit your jobs to those sites with:
<pre style="margin-left:4em" class="screen">
requirements = stringListMember(GLIDEIN_Site,DESIRED_Sites)
</pre>

To get the list of available sites, run:
<pre style="margin-left:4em" class="screen">
/opt/glidein/list_sites.sh
</pre>

Each of you pick 1 or 2 sites, and run 10 jobs.
Check that they ran where you expected to.

%TWISTY{
showlink="Show hint"
hidelink="Hide hint"
start="hide"
mode="div"
showimgleft="%ICONURLPATH{toggleopen-small}%"
hideimgleft="%ICONURLPATH{toggleclose-small}%"
}%
<pre style="margin-left:4em" class="screen">
+DESIRED_Sites="UNL,UCSD"
requirements =  stringListMember(GLIDEIN_Site,DESIRED_Sites)
</pre>
%ENDTWISTY% 


%TWISTY{
showlink="Show follow up"
hidelink="Hide"
start="hide"
mode="div"
showimgleft="%ICONURLPATH{toggleopen-small}%"
hideimgleft="%ICONURLPATH{toggleclose-small}%"
}%
The glideins also advertise the Grid CE used to obtain the resources. The attribute to look for is =GLIDEIN_Gatekeeper=.

Similarly, the jobs has this value in their own =MATCH_GLIDEIN_Gatekeeper= attribute.

To get the list of all available CEs, run
<pre style="margin-left:4em" class="screen">
/opt/glidein/list_CEs.sh
</pre>
%ENDTWISTY% 

---++ Exercise 3 - Mixing local and remote resources

The previous two exercises forced the jobs to use remote resources only; while the local ones were idle doing nothing.

There is no reason to do this; you could easily use all of them. 

Can anyone tell me how?

%TWISTY{
showlink="Show hint"
hidelink="Hide hint"
start="hide"
mode="div"
showimgleft="%ICONURLPATH{toggleopen-small}%"
hideimgleft="%ICONURLPATH{toggleclose-small}%"
}%
<pre style="margin-left:4em" class="screen">
+DESIRED_Sites="UNL,UCSD"
requirements =  stringListMember(GLIDEIN_Site,DESIRED_Sites) || GLIDEIN_Site=?=UNDEFINED
</pre>
%ENDTWISTY% 

Then each run 40 [[OSGSS2011TueDHTCEx2#Exercise_2_Many_users][1 minute jobs]], and let's see if things work as expected.

Let's now have a brief discussion about the experience, compared to the partitioning earlier this morning.

---++ Exercise 4 - BLAST

Let's now re-run the [[OSGSS2011CondorBLAST][BLAST exercise]] using also the glideinWMS provided resources.

The system has been instrumented to do the right thing if you use:
<pre style="margin-left:4em" class="screen">
+DESIRED_Sites="any"
+NEED_BLAST=True
requirements = (HAS_BLAST=?=True)
</pre>

Of course, the BLAST binaries and database can be installed in slightly different locations, on different sites. The nodes that have BLAST have the following variables defined:
   * BLAST_BIN - You can be sure to find =$BLAST_BIN/blastp= in your job.
   * BLAST_DATA - You can be sure to find =$BLAST_DATA/yeast.aa= in your job.

All the databases you have in the local pool should be available at all sites. Try it out. Run a 10-20 jobs each and see if you get the results you expect.

Where did you end running?
