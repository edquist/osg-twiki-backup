%META:TOPICINFO{author="KyleGross" date="1225985937" format="1.1" version="1.21"}%
---+ !!Discover the prized Higgs boson with CMS on the Open Science Grid
---++++ !!Original author: Oliver Gutsche of CMS and Fermilab
%TOC{title="Outline:"}% 

---++ Introduction

In a nutshell, the Higgs boson is a hypothesised particle which, if it exists, would give the mechanism by which particles acquire mass. 

Feel the thrill of discovery as you use the CMS software and simulated data to find this elusive, coveted treasure! You'll run your job real-time on remote computers made available through Open Science Grid.

Only people eligible for membership in the CMS VirtualOrganizations/VOInfo can set up their computing environments appropriately to run this demo. If you're not affiliated with CMS, you'll have to run the demo with somebody who is.

---++ Overview

In this demo you will create analysis code to use within the CMS analysis software framework.  This diagram illustrates the steps that you'll follow and how the pieces in the demo fit together.

<!-- cms higgs demo flow (2): -->
     <img src="%ATTACHURLPATH%/cms_higgs_demo_flow2.gif" alt="cms_higgs_demo_flow2.gif" width='912' height='432' />

---++ Things to do ahead of time
   * Get a grid (PKI) certificate; load it into your browser and copy it into the =$HOME/.globus area= of the UNIX/Linux machine you're going to use.
   * Convert the certificate using the =openssl= command as shown (use your actual =.pl2= certificate filename with no angle brackets; use the output names =usercert.pem= and =userkey.pem= as shown):
<verbatim style="background-color: lightblue;  text-align: left;padding: 10px; font-weight: 700; margin-left: 20px;margin-right: 20px;color: black;">
      openssl pkcs12 -in <YourCert>.p12 -clcerts -nokeys -out $HOME/.globus/usercert.pem
      openssl pkcs12 -in <YourCert>.p12 -nocerts -out $HOME/.globus/userkey.pem
      chmod go-rw $HOME/.globus/userkey.pem
</verbatim>
   * Join the CMS VO. Go to [[https://lcg-voms.cern.ch:8443/vo/cms/vomrs?path=/RootNode][the CMS VirtualOrganizations/VOInfo registration page]]. It may take a day or so to get approved and become fully registered.

---++ Set up your environment and prepare your user area

   * First, check the [[CmsDemoFormatConventions][Format conventions]] to understand what the blue, red and gray sections mean as you go through the demo.
   * [[MidWestGridWorkshop2007Setup][Set up your CMS software environment]].
   *  Get a grid proxy. Run
<verbatim style="background-color: lightblue;  text-align: left;padding: 10px; font-weight: 700; margin-left: 20px;margin-right: 20px;color: black;">
grid-proxy-init
</verbatim>
(or if you prefer, you can run =voms-proxy-init= instead.) In either case 
you will be prompted for your pass phrase.
   * To check your proxy, run
<verbatim style="background-color: lightblue;  text-align: left;padding: 10px; font-weight: 700; margin-left: 20px;margin-right: 20px;color: black;">
voms-proxy-info -all
</verbatim>
If it doesn't work, go back and check your certificate and make sure that the =.globus/userkey.pem= file is there.

---++ Prepare the analysis code 
The overall collection of CMS analysis software, referred to as CMSSW, is built around a Framework, an Event Data Model, and Services needed by the simulation, calibration and alignment, and reconstruction modules that process event data. 

The CMSSW framework implements a software bus model wherein there is one executable and many plug-in modules which run algorithms. The same executable is used for both detector and Monte Carlo (simulation) data.   You will need to create a plug-in module for the Higgs analysis; it will plug into the Framework.

Your Higgs analysis module will access reconstructed simulated tracks, and write out a file with histograms.

Go to the [[CmsCodePrep][Code preparation]] page. 

---++ Find the dataset

CMSSW data discovery is available on the [[http://cmsdbs.cern.ch/DBS2_discovery/][DBS/DLS discovery]] page. You'll want to search on the string: 
<verbatim>
*Higgs-ZZ-4mu
</verbatim>
The search is case sensitive. Cut and paste this string (including the asterisk) into the long field near the bottom labelled "Processed dataset", then click "Find".
The returned page gives both the dataset names and, for each, the set of locations (destination sites) from which to choose. Make a note of the dataset and location you want. Since you're using real datasets, they will change over time.

---++ Execute your analysis job on an OSG resource
---+++ Set up the build program
Cms Remote Analysis Builder (CRAB) is a Python program intended to simplify the process of creation and submission of CMS analysis jobs into a grid environment.

Setup CRAB (using =.sh= or =.csh= as appropriate):
<verbatim style="background-color: lightblue;  text-align: left;padding: 10px; font-weight: 700; margin-left: 20px;margin-right: 20px;color: black;">
source /uscmst1/prod/grid/CRAB_1_5_1/crab.sh
</verbatim>
---+++ Make a configuration file
Create the CRAB configuration file: =Demo/MyTrackAnalyzer/test/crab.cfg= and give it the following contents, replacing the items in brackets <...> appropriately: 
<verbatim style="background-color: lightgrey;  text-align: left;padding: 10px;margin-left: 20px;margin-right: 20px;color: black;">
[CRAB]
jobtype                = cmssw
scheduler              = condor_g

[CMSSW]
datasetpath            = <dataset name discovered with discovery page>
pset                       = <parameter-set for analysis code (e.g., demotest.cfg)>
total_number_of_events = 100
events_per_job         = 10
output_file            = <histogram file name (e.g., histograms.root)>

[EDG]
se_white_list          = <location found with dataset discovery page (e.g., srm.unl.edu)>
virtual_organization   = cms
lcg_catalog_type       = lfc
lfc_host               = lfc-cms-test.cern.ch
lfc_home               = /grid/cms

[USER]
return_data       = 1
</verbatim>
---+++ Create your jobs
Now it's time to create the 10 jobs (notice in file above, 100 events/10 evts-per-job).  CRAB does this for you. It will read this configuration file. 

If you have any outstanding jobs, kill them first (use =crab -kill all=).  It may prompt for your passphrase.

Run the command:
<verbatim style="background-color: lightblue;  text-align: left;padding: 10px; font-weight: 700; margin-left: 20px;margin-right: 20px;color: black;">
crab -create
</verbatim>
...end of output ...
<verbatim style="background-color: lightblue;  text-align: left;padding: 10px; margin-left: 20px;margin-right: 20px;color: black;">
...
crab. Contacting DLS...
crab. Sites (1) hosting part/all of dataset: ['srm.unl.edu']

crab. 10 job(s) can run on 100 events.

crab. Creating 10 jobs, please wait...

crab. Total of 10 jobs created.

crab. Log-file is /uscms/home/aheavey/demo/CMSSW_1_2_0/src/Demo/MyTrackAnalyzer/test/crab_0_070529_144807/log/crab.log
</verbatim>
---+++ Submit your jobs to the grid
Use CRAB to submit these jobs to the grid:
<verbatim style="background-color: lightblue;  text-align: left;padding: 10px; font-weight: 700; margin-left: 20px;margin-right: 20px;color: black;">
crab -submit all -continue
</verbatim>
...end of output ...
<verbatim style="background-color: lightblue;  text-align: left;padding: 10px;margin-left: 20px;margin-right: 20px;color: black;">
...
crab. Total of 10 jobs submitted.
crab. Log-file is /uscms/home/aheavey/demo/CMSSW_1_2_0/src/Demo/MyTrackAnalyzer/test/crab_0_070531_120336/log/crab.log
</verbatim>

If something fails after submission, before resubmitting, first kill them (=crab -kill all=). Then rerun =crab -create= and resubmit them (=crab -resubmit all=). 
---+++ Check status of your jobs
To check the status, run:
<verbatim style="background-color: lightblue;  text-align: left;padding: 10px; font-weight: 700; margin-left: 20px;margin-right: 20px;color: black;">
crab -status -c
</verbatim>
Initially you should see that each job is scheduled, and near the end it says =10 Jobs Scheduled=.  Time can vary, but a few minutes later, it's likely that the status will have changed to "Running".  Try again every few minutes until you see that they're completed; status will be "Done (success)".

You can also check your jobs' status at the [[http://lxarda09.cern.ch/dashboard/request.py/jobsummary][DashBoard]].  If your job isn't progressing fast enough at your chosen location, you can check site activity here and choose a different location if you like. You'll have to kill the jobs, edit your =crab.cfg= and resubmit, of course. 

---+++ Retrieve your output
Use CRAB to retrieve your output:
<verbatim style="background-color: lightblue;  text-align: left;padding: 10px; font-weight: 700; margin-left: 20px;margin-right: 20px;color: black;">
crab -getoutput -c
</verbatim>
The output will tell you which directory contains the output it returned.  Change to that directory. 

---++ Make some histograms
Add histogram files of individual jobs together using the ROOT tool's =hadd= command: 
<verbatim style="background-color: lightblue;  text-align: left;padding: 10px; font-weight: 700; margin-left: 20px;margin-right: 20px;color: black;">
cd crab_?_*_*/res
hadd histograms.root *.root
</verbatim>
To display the histograms, start up ROOT:
<verbatim style="background-color: lightblue;  text-align: left;padding: 10px; font-weight: 700; margin-left: 20px;margin-right: 20px;color: black;">
root histograms.root
</verbatim>
then at its numbered prompts, the following three =Draw= commands will each produce a histogram.
<verbatim style="background-color: lightblue;  text-align: left;padding: 10px; font-weight: 700; margin-left: 20px;margin-right: 20px;color: black;">
pt->Draw();
mmumu->Draw();
mzz->Draw();
</verbatim>
Congratulations! Now just wait for Stockholm to call.
---

-- Main.AnneHeavey - 21 June 2007




%META:FILEATTACHMENT{name="cms_higgs_demo_flow.gif" attr="" autoattached="1" comment="flow" date="1182449862" path="cms_higgs_demo_flow.gif" size="79189" user="Main.AnneHeavey" version="1"}%
%META:FILEATTACHMENT{name="cms_higgs_demo_flow2.gif" attr="" autoattached="1" comment="cms higgs demo flow (2)" date="1182460197" path="cms_higgs_demo_flow2.gif" size="9760" user="Main.AnneHeavey" version="1"}%
