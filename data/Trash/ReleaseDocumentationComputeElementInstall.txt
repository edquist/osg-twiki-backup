%META:TOPICINFO{author="RobertEngel" date="1284527937" format="1.1" version="1.99"}%
%DOC_STATUS_TABLE%

---+!! Compute Element Installation Guide
%TOC%

---+ About this Document

<!-- conventions used in this document
   * Local UCL_CWD  = /opt/osg-%VERSION%
   * Local UCL_HOST = ce
-->

%ICON{hand}% This document is for System Administrators. It covers the installation of a %LINK_GLOSSARY_CE% on the %LINK_OSG%. This document applies to the latest release %RED% OSG-%OSG_VERSION% %ENDCOLOR%. The procedures presented in this document in general require _root_ privileges.

%INCLUDE{"Documentation/DocumentationTeam/DocConventions" section="Header"}%
%INCLUDE{"Documentation/DocumentationTeam/DocConventions" section="CommandLine"}%

---+ Engineering Considerations

The %LINK_GLOSSARY_CE% is a selection of software provided by the %LINK_VDT% bundled for the use on the %LINK_OSG%.  A Compute Element provides services to allow grid users to run jobs on a grid resource. The [[ReleaseDocumentation/SitePlanning][Site Planning Guide]] will help you avoid many of the common problems while installing a new site.

---+ Requirements

   1 new System Administrators should read the [[ReleaseDocumentation/SitePlanning][Site Planning Guide]]
   1 execute all steps to [[ReleaseDocumentation/PreparingComputeElement][prepare your Compute Element]]
   1 verify that your Operating System is [[http://vdt.cs.wisc.edu/releases/2.0.0/requirements.html][supported]]
   1 a %LINK_PACMAN% installation of version %PACMAN_VERSION% or later
   1 a valid [[ReleaseDocumentation/GetGridCertificates][grid host certificate]] is required
   1 to test and use the installation a valid [[ReleaseDocumentation/CertificateGet][grid user certificate]] is required

---+ How to get Help?

To get assistance please use [[HelpProcedure][this page]]. 

---+ Installation Procedure

The installation procedure consists of the following steps:

   1 deactivate an existing installation. I.e start the installation with a clean environment
   1 create an empty installation directory
   1 use %LINK_PACMAN% to install the %LINK_GLOSSARY_CE%
   1 install the [[Documentation/GlossaryC#DefsCA][CA Certificates]] and the %LINK_GLOSSARY_CRL%
   1 connect %LINK_GLOSSARY_GRAM% to your Batch System
   1 execute the post installation script

---++ Deactivate an existing Installation

Before you proceed you must [[ReleaseDocumentation/InstallingComputeElementServices#Service_Deactivation][deactivate]] an existing installation to avoid to have leftover processes. Make sure to start the installation with a clean environment. If VDT_LOCATION is in your environment you probably need to log-in again and make sure that no setup file is sourced in your login script.

---++ Create the Installation Directory

Create an empty installation directory and change into it. Make sure the directory is world readable if the installation is to be shared by grid users: 

<pre class="rootscreen">
[root@%UCL_HOST% ~]$ mkdir -p %UCL_CWD%
[root@%UCL_HOST% ~]$ cd %UCL_CWD%
[root@%UCL_HOST% %UCL_CWD%]$ ln -s %UCL_CWD% /opt/osg
</pre>

%WARNING% Please do not use a system directory like =/opt= or =/usr= here. The installation routine will create many sub-directories in the main directory.

---++ Use Pacman to install the Compute Element Software

In the next step we will use the =pacman= command line tool to install the package from the OSG software cache. %LINK_PACMAN% will ask whether you want to "trust the caches and accept the license", answer =yall= and =y= to install Compute Element.

<pre class="rootscreen">
%UCL_PROMPT_ROOT% pacman -get %CACHE%:ce
Do you want to add [%CACHE%] to [trusted.caches]? (y/n/yall): %RED%yall%ENDCOLOR%
...
</pre>

%TWISTY{%TWISTY_OPTS_OUTPUT%}%
<pre class="rootscreen">
%UCL_PROMPT_ROOT% pacman -get %CACHE%:ce
Do you want to add [%CACHE%] to [trusted.caches]? (y/n/yall): %RED%yall%ENDCOLOR%
Beginning VDT prerequisite checking script vdt-common/vdt-prereq-check...       

All prerequisite checks are satisfied.
                                                          


========== IMPORTANT ==========
Most of the software installed by the VDT *will not work* until you install
certificates.  To complete your CA certificate installation, see the notes
in the post-install/README file.

                                                                              
Pacman Installation of OSG-%VERSION% Complete
 </pre>
%ENDTWISTY%

%NOTE% Depending on your network connection and hardware capabilities the installation process will take between 5 and 30 minutes to complete. Meanwhile you can =tail= the main installation logfile =%UCL_CWD%/vdt-install.log=.

%WARNING% Do not continue if the pacman command indicated an error.

---++ Update the Environment

Depending on your shell update your environment by sourcing =%UCL_CWD%/setup.sh= or =%UCL_CWD%/setup.csh=:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% . %UCL_CWD%/setup.sh
</pre>

Depending on your preference you might want to optionally include the setup script in your system or user profile.

---++ Install the CA Certificates and the CRL

The OSG distributes a number of certificates of [[Documentation/GlossaryC#DefsCA][Certificate Authorities]] that issue certificates to their members. By installing these certificates you establish a chain of trust with each of the certificate authorities and trust the servers and services certified by those authorities. The %LINK_GLOSSARY_CRL% is used to inform you about individual certificates that have been revoked.

We will use the =vdt-ca-manage= command to download the CA Certificates and the Certificate Revocation List. The command line option =--location root= copies the CA certificates into the subdirectory =/etc/grid-security/certificates=. 

<pre class="rootscreen">
%UCL_PROMPT_ROOT% vdt-ca-manage setupca --url %RED%osg%ENDCOLOR% --location %RED%root%ENDCOLOR%
Setting CA Certificates for VDT installation at '%UCL_CWD%'

Setup completed successfully.
</pre>

---++ Connect your Batch System

The Grid Resource Allocation Manager connects to the batch system using a %LINK_GLOSSARY_JM%. By default only the =fork= job manager is supported which allows grid users to execute jobs on the %LINK_GLOSSARY_GATEKEEPER%. To connect %LINK_GLOSSARY_GRAM% to an _existing_ batch system, you need to install the _corresponding_ job manager.

---+++ Instructions for Condor

Before you proceed to install the Condor job manager, you must define two environment variables that point to the _existing_ Condor installation and its configuration file:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% export VDTSETUP_CONDOR_LOCATION = &lt;Path to Condor&gt;
%UCL_PROMPT_ROOT% export VDTSETUP_CONDOR_CONFIG   = &lt;Path to Condor configuration file&gt;
</pre>

Then continue to use =pacman= to install the Condor job manager:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% pacman -get %CACHE%:Globus-Condor-Setup
</pre>

%NOTE% By default The Condor job manager located at =%UCL_CWD%/globus/lib/perl/Globus/GRAM/JobManager/condor.pm= will require that all jobs run on nodes of the _same_ architecture as the %LINK_GLOSSARY_GATEKEEPER% architecture. To disable this feature _comment out_ following line in the file above:

<pre class="file">
#    $requirements .= " && Arch == \"" . $description->condor_arch() . "\" ";
</pre>

---+++ Instructions for PBS

Before you proceed make sure that the =$PATH= environment variable contains the path to the binaries for the [[http://en.wikipedia.org/wiki/Portable_Batch_System][Portable Batch System]]. Then use =pacman= to install the PBS job manager:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% pacman -get %CACHE%:Globus-PBS-Setup
</pre>

Otherwise the installation will silently fail and the error will be reported to =%UCL_CWD%/vdt-install.log= only. In this case you must _remove_ the =Globus-PBS-Setup= package, correct the =$PATH= environment variable and install the PBS job manager once again. To remove the =Globus-PBS-Setup= use:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% pacman -remove %CACHE%:Globus-PBS-Setup
</pre>

---+++ Instructions for SGE

Before you proceed make sure that the =$PATH= environment variable contains the path to the binaries for the [[http://gridengine.sunsource.net/][SUN Grid Engine]]. Then use =pacman= to install the PBS job manager:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% pacman -remove %CACHE%:Globus-SGE-Setup
</pre>

---+++ Instructions for LSF

Before you proceed make sure that the =$PATH= environment variable contains the path to the binaries for the [[http://www.platform.com/workload-management/high-performance-computing][Platform LSF]]. Then use =pacman= to install the LSF job manager:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% pacman -remove %CACHE%:Globus-LSF-Setup
</pre>

---++ Post-Install Procedure

To finalize your installation you must run the =vdt-post-install= program on the command line:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% vdt-post-install
Starting...
Configuring PRIMA... Done.
Configuring EDG-Make-Gridmap... Done.
Configuring PRIMA-GT4... Done.
Done.
</pre>

---+ Activate and Deactivate Services
%INCLUDE{"ReleaseDocumentation/StartingServices" section="About" SHIFT_TOC="+"}%
%INCLUDE{"ReleaseDocumentation/StartingServices" section="List" SHIFT_TOC="+"}%
%INCLUDE{"ReleaseDocumentation/StartingServices" section="Activate" SHIFT_TOC="+"}%
%INCLUDE{"ReleaseDocumentation/StartingServices" section="Deactivate" SHIFT_TOC="+"}%

<!-- so far so good -->

%INCLUDE{"CaCertificatesUpdatesConfig"}%
On Compute Element (CE) installs, the enabling of these services  is performed by the _configure-osg_ script based on the following option in the _config.ini_ file:<pre class="file">
[Misc Services]
use_cert_updater = %(enable)s
</pre>

---++ Additional Installations.
There are several pieces of software closely related to, but not a part of the default CE install.  We recommend to carefully consider the following installs:
   * *[[ManagedFork][Managed Fork]]*: By default, anyone can launch an arbitrary number of processes on the CE node itself (through "jobmanager-fork").  Most "good users" know not to do this, but accidents have happened previously.  Managed fork uses Condor to manage incoming fork requests. Commands such as condor_q and condor_history can be used to see the fork jobs, providing an important tracing capability.  The number of concurrently running fork jobs can be set in the Condor config file.  Managed fork does not prevent a malicious user from overwhelming the CE.  We recommend large sites (>1000 cores) consider running managed fork. 
   * *[[GlobusWebServicesInstall][Globus Web Services]]*:  This is a web service that implements a variety of protocols, including WS-GRAM, a replacement for the GRAM protocol used widely in the OSG.  Currently, this is rarely used or configured.
For brevity of the CE install documents, these have been split out into a separate page.  
<!--
It was an easy decision to move Globus-WS off to another page; the Managed Fork stuff is closer to belonging on the top page.
-->

%BR%
---+ Configuration
This next major chapter of this document covers the configuration of the OSG CE.  We first introduce the configuration tool itself, then provide a high-level description of the configuration file.

%INCLUDE{"ConfigureOSGAttributes"}%
%INCLUDE{"FullPrivPreConfig"}%
%INCLUDE{"GipConfiguration"}%
%INCLUDE{"InstallAndConfigureRSV"}%

---++ Run =configure-osg=

At this point, you should have configured every section in the config.ini.  First, validate the setup with:
<pre class="screen">
configure-osg -v
</pre>
This may discover several issues you have to address; don't forget to [[SiteAdminResources][ask for help if needed]].  Once this exits successfully, you are ready to run the configuration:
<pre class="screen">
configure-osg -c
</pre>
This will additionally enable any services required by your configuration settings, but not turn them on.

%INCLUDE{"StartingServices"}%
<!--
%BR%
Note: MPI documentation needs a major overhaul before it can be included here.
[[https://twiki.grid.iu.edu/bin/view/Documentation/AdminSetupMPI][How to Support MPI Jobs On Your Site]]
-->
%BR%


---++ *Comments*
| If you have a server certificate but it is expired "vdt-control --on" will start your service but they will not work. Check the gatekeeper log file if you cannot authenticate. | Main.MarcoMambelli | 10 Jul 2009 - 19:15 |
| If the OLD_VDT_LOCATION is set there is no need to run the cert updater by hand, the certs will be handled same way as they were in the old install. I am not sure whether that happens always, but always for me.<br />Also seems to me that the Enabling Full Privilege Authentication is done automatically based on config.ini and the files are placed where they need to be - nothing to be done for it these days.<br /> | Main.IwonaSakrejda | 23 Jul 2009 - 20:54 |
| TAG_TEST = YES | Main.RobertEngel | 14 May 2010 - 17:47 |
| If Condor has been installed via RPM what should VDTSETUP_CONDOR_LOCATION be? Or, better, how do I point the condor-jobmanager to it? | Main.MarcoMambelli | 26 May 2010 - 23:44 |
| Above, in the multi-ce section it says &#60;br /&#62;Set the value of site_name in the &#34;Site Information&#34; section to be the same for each CE. &#60;br /&#62;Shouldn&#39;t that be resource_group setting to be the same now, and resource (only used&#60;br /&#62;by gratia) to be different for each &#37;(localhost)s&#60;br /&#62; | Main.StevenTimm | 30 Aug 2010 - 17:57 |
%COMMENT{type="tableappend"}%



<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = RobertEngel

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = ComputeElement

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = Installation
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %NO%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %NO%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = IwonaSakrejda
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %YES%


 DEAR DOCUMENT TESTER
 ====================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = IwonaSakrejda
 Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %YES%
############################################################################################################
-->


%META:TOPICMOVED{by="RobGardner" date="1192745464" from="Integration/ITB_0_7.ComputeElementInstallGuide" to="Integration/ITB_0_7.ComputeElementInstall"}%
