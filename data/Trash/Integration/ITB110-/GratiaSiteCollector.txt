%META:TOPICINFO{author="CharlesBacon" date="1212087510" format="1.1" version="1.10"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! *<nop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%

<!--
   * Set GRATIA_SECURITY_ENABLED_YN = N
   * Set GRATIA_COLLECTOR_PORT = %IF{"%CACHE% = OSG" then="8880" else="8881"}%
   * Set GRATIA_COLLECTOR = http://gratia.opensciencegrid.org:%GRATIA_COLLECTOR_PORT%
   * Set GRATIA_REPORTING_DIR = gratia-reporting
   * Set GRATIA_ADMIN_DIR = gratia-administration
   * Set GRATIA_REPORTING_URL = %GRATIA_COLLECTOR%/%GRATIA_REPORTING_DIR%/
   * Set GRATIA_ADMIN_URL = %GRATIA_COLLECTOR%/%GRATIA_ADMIN_DIR%/
   * Set GRATIA_EXAMPLE_COLLECTOR = http://mycollector.mydomain:myport
   * Set GRATIA_EXAMPLE_REPORTING_URL = %GRATIA_EXAMPLE_COLLECTOR%/%GRATIA_REPORTING_DIR%/
   * Set GRATIA_EXAMPLE_ADMIN_URL = %GRATIA_EXAMPLE_COLLECTOR%/%GRATIA_ADMIN_DIR%/
   * Set GRATIA_SECURITY_ENABLED_TEXT = %IF{"%GRATIA_SECURITY_ENABLED_YN% = Y" then="enabled" else="disabled"}%
-->

---++ Introduction
This topic covers an (optional) installation, configuration and operation of a site-level Gratia collector and reporting services..  

---++ Preinstallation
<ol>
<li>HTTP certificate<br>
You will need to apply for an http certificate for the host you are installing the local Gratia Collector on.  If you do not already have one, refer to the [[GetHostCertificate][Get Grid Certificate]] topic of the documentation.

This http certificate should be copied into an =/etc/grid-security/http/= directory as =httpcert.pem= and =httpkey.pem=. The directory and certificate files should have the following  ownership and permissions:
<pre class="programlisting">
drwxr-xr-x  2 daemon root 4096 Nov  5 13:50 /etc/grid-security/http
-rw-r--r--  1 daemon root 1473 May 29 11:20 /etc/grid-security/http/httpcert.pem
-rw-------  1 daemon root 1679 May 29 11:20 /etc/grid-security/http/httpkey.pem
</pre>

</li>
<li>Pacman<br>
All %CACHE% installations are performed using pacman.  This must be installed first.  Documentation on pacman can be found in the 
[[WebHome#Installation_and_update_tools][Installation and update tools]] section of the documentation.  For %CACHE% %VERSION% we recommend using Pacman %PACMAN_VERSION%. While older or newer versions may work, you are on your own if you try them. 
</li>

<li>Most installations of  OSG services are done as =root= user<br>
Paraphrasing from the [[%VDT_DOCS_URL%/installation_think.html][VDT site]], if you install as root the VDT's programs can be made available to all the users on your system. Additionally, the VDT will be able to configure and start some of the grid services you might be installing.  Some services can only be run if you are root. _Corollary:_ If you don't install as root, you cannot do these things.  Unless your local policy states otherwise, you will want to install the OSG Gratia Collector as root.
</li>

<li>Consult the [[OperatingSystems][Operating Systems]] topic for supported operating systems.</li>

<li>You will need to create an installation directory. 
 This directory will henceforth be referred to as the VDT_LOCATION.
</li>

</ol>

---++ Installation and configuration
Now you're ready to start installing the Gratia Collector and Reporting services.  

---+++ Shutdown existing installation
If you have an existing Gratia Collector installed and running, you *must* do a complete shutdown and confirm that all processes associated with it have been stopped.  Refer to  [[GratiaShutdownGuide][Gratia Shutdown Guide]] for details.

*Important:*  Remember you are not shutting down this version, so choose the correct link in that section for the specific version you are replacing.  Be sure all services and crons are disabled.

---+++ Install the Gratia Collector/Reporting
The installation described here is done as root even though services will not necessarily run as root:
   * A few questions regarding trust of the caches from which the software is downloaded will be displayed.   %BR%  Please answer *y* (yes) so that the software can be retrieved.
   * Finally, make sure there are no non-standard versions of perl, tcsh, or bash in your $PATH variable.

The following pacman command will install the package:
<pre class="screen">
# <b>pacman -get %VDT_CACHE_URL%:Gratia-Reporting</b>    
</pre>
*Note:* This installs both the Gratia-Reporting and Gratia-Collector packages.

See the [[PacmanBestPractices][Pacman section]] of this guide if you encounter an 'unsupported' platform message.

This will take about 5 minutes to complete, depending upon the system and network connection. During this time you may open a second terminal and watch the progress by monitoring the =$VDT_LOCATION/vdt-install.log= file.

You should not be asked any other questions during the installation process. The installation should complete with the following message:
<pre class="programlisting">
Downloading [gratia-reporting-0.28.tar.gz] from [http://vdt.cs.wisc.edu/software//gratia/gratia-reporting/0.28]...
</pre>

At this point your Gratia collector is fully configured and can being collecting accounting data.

---++ Starting Services
For general information on starting and stopping OSG services, refer to the [[StartingServices][Starting Services]] topic of this documentation.

For this Gratia Collector/Reporting installation, the services available are:
<pre class="programlisting">
 vdt-control --list
Service            | Type   | Desired State
-------------------+--------+--------------
fetch-crl          | cron   | enable
mysql5             | init   | enable
vdt-rotate-logs    | cron   | enable
mysql              | init   | do not enable
apache             | init   | enable
tomcat-55          | init   | enable

<b>So to start all services, you would do:</b>
 vdt-control --on 
</pre>

<b>A couple <u>very important</u>  points regarding Gratia services as deployed by the VDT:</b>

<ul>
<li>As you can see above there are 2 !MySql services defined.  This is an anomaly in the VDT installation that should be corrected in the future.  Gratia uses !MySql V5.  The other mysql entry is  related to the =apache= installation and is not used by Gratia. Since it is marked =do not enable=, it will never be started.</li>

<li>With the 2 !MySql services installed, the =$VDT_LOCATION/setup.sh= script sets the ~MySql socket for connecting via the !MySql client incorrectly.  This does not affect the Gratia services as they connect to the database via a port specified in the =$VDT-LOCATION/tomcat/v55/gratia/service-configuration.properties= file.  However, if you have a need to access the database using the !MySql client you need to do so with the =--socket= argument. 
<pre>
source $VDT_LOCATION/setup.sh
mysql --socket /usr/local/osg-collector/vdt-app-data/mysql5/var/mysql.sock --host=localhost -u root -p
</pre>
</li>
</ul>

---++ Secure the !MySql database
The !MySql database is installed without a =root= password.  You should secure it now.
<pre>
source $VDT_LOCATION/setup.sh
mysql --socket /usr/local/osg-collector/vdt-app-data/mysql5/var/mysql.sock --host=localhost -u root 
mysql&gt; set password for 'root'@'localhost'=PASSWORD('YOUR_DB_ROOT_PASSWORD');
mysql&gt; quit
</pre>

You must then configure the Gratia services to use the root password by:
<pre>
source $VDT_LOCATION/setup.sh
cd $VDT_LOCATION/gratia/etc
printf "YOUR_DB_ROOT_PASSWORD" &gt; mysql5.root.pass
$VDT_LOCATION/vdt/setup/configure_gratia --reporting --services
</pre>

---++ Validate your installation

Follow the instructions on the [[ValidateGratia#Gratia_Collector][Gratia validation page]].

---++ Accessing Gratia Administration and Reporting via your browser.
The URLs for the Gratia services are:
   * Gratia Administration: %GRATIA_EXAMPLE_ADMIN_URL%
   * Gratia Reporting:          %GRATIA_EXAMPLE_REPORTING_URL%

%INCLUDE{"Accounting.GratiaConfigurationGuide" pattern=".*(......Changing your Gratia probes.*)" }%

%BR%
%COMPLETE3% %BR%
%RESPONSIBLE% Main.ChrisGreen - 5 Nov 2007 %BR%
%REVIEW%

%META:TOPICMOVED{by="RobGardner" date="1192820398" from="Integration/ITB_0_7.GratiaSiteService" to="Integration/ITB_0_7.GratiaSiteCollector"}%
