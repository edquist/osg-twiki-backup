%META:TOPICINFO{author="KyleGross" date="1225985944" format="1.1" version="1.35"}%
%META:TOPICPARENT{name="ValidationPageRel01"}%
<!-- This is the default OSG Integration template. 
Please modify it in the sections indicated to create your topic!
If you have any comments/complaints about this template, then please email me:
rwg@hep.uchicago.edu.  (Adapted from Atlas wiki template, Ed Moyse)
--> 

<!-- By default the title is the WikiWord used to create this topic !-->
<!-- if you want to modify it to something more meaningful, just replace %TOPIC% below with i.e "My Topic"!-->

---+!!<nop>%TOPIC%
%TOC%
%STARTINCLUDE%


---++Introduction
The <a href="http://monalisa.caltech.edu">MonALISA  (Monitoring Agents in A Large Integrated Services Architecture)</a> system provides a distributed service for monitoring, control and global optimization of complex systems. It is based on an ensemble of autonomous multi-threaded, agent-based subsystems which are registered as dynamic services and are able to collaborate and cooperate in performing a wide range of monitoring and decision tasks in large scale distributed applications, and to be discovered and used by other services or clients that require such information. 



---++Known Problems
<OL>
<LI>
<nop>MonALISA is known not to report VirtualOrganizations/VOInfo Jobs correctly when it is attempting to get information from a condor installation using condor_quill.  This is due to subtle differences in the output of condor_q.  <br>
<a href="http://vdt.cs.wisc.edu/rt/Ticket/Display.html?id=1575">VDT ticket 1575</a> submitted  3/20/06
<br><b>Update 4/19/06: </b> This was thought to be resolved with <nop>MonALISA 1.5.0, but problems have now been identified in the <i>condor_q -l </i> command. It is apparently returning a non-zero return code causing the VirtualOrganizations/VOInfo Jobs module to fail.  ( -- Main.JohnWeigand 4/19/06)
<br><b>Resolution:</b> Fixed in <nop>MonALISA version 1.5.4 and will be available in OSG 0.5.0 / VDT 1.3.11 ( -- Main.JohnWeigand 4/21/06)<br>

<p><LI>
The VirtualOrganizations/VOInfo_IO gridftp module encounters problems under certain conditions when the <i>VDT_LOCATION/monitoring/grid3-user-vo-map.txt</i> is updated.
When this occurs, it will stop reporting the gridftp metrics. 
<br>GOC ticket #77164  / <a href="http://vdt.cs.wisc.edu/rt/Ticket/Display.html?id=1629">VDT ticket 1629</a>
submitted on 4/19/06. (-- Main.JohnWeigand 4/19/06)
<br><b>Resolution: </b>Fixed in <nop>MonALISA version 1.5.4 and will be available in OSG 0.5.0 / VDT 1.3.11 ( -- Main.JohnWeigand 4/21/06)  <br>

<p><LI>
The <i>/etc/init.d/MLD</i> script only supports the <i>start</i>, <i>stop</i> and <i>restart</i> options of the underlying ML_SER script.
If you are installing the OSG/VDT distribution where <i>daemon</i> is, by default, the <nop>MonALISA user <u>and</u> the <i>daemon</i>
user is created as a <i>nologin</i> account, then you will have difficulty using any of the other available arguments with the MLD script 
(update, version, forcedstopedb and stopedb).  
<br>GOC ticket #75818 / <a href="http://vdt.cs.wisc.edu/rt/Ticket/Display.html?id=1577">VDT ticket 1577</a>
submitted on 3/21/06. (-- Main.JohnWeigand 3/21/06)
<br><b>Resolution: </b>Will be available in OSG 0.5.0 / VDT 1.3.11 ( -- Main.JohnWeigand 4/21/06)  <br>

</OL>

<b><u>Work-arounds:</u></b>
<UL>
<LI>VDT tickets 1575, 1629<br>
The OSG 0.4.1 is installed using VDT 1.3.10b and therefore installs <nop>MonALISA version 1.4.12 by default. 
If  you are affected by these, you can upgrade <nop>MonALISA independent of the OSG/VDT installations by doing a one-time
update of <nop>MonALISA by executing:
<pre>
&gt;   $VDT_LOCATION/MonaLisa/Service/CMD/ML_SER update
</pre>
and can verify the version by executing:
<pre>
&gt;   $VDT_LOCATION/MonaLisa/Service/CMD/ML_SER version
</pre>
If you are running with a <nop>MonALISA user that is a <i>nologin</i> account, see the work-around for ticket 1577 below.
<p>
<LI>VDT ticket 1577<br>
Add the following lines to the "case" statement in the <i>/etc/init.d/MLD</i> script and execute the <i>MLD</i> command in
place of the <i>ML_SER</i> script with the desired argument as shown in the previous work-around.
<pre>
'version')
                  cd $MonaLisa_HOME; /usr/local/osg-ce/vdt/sbin/vdt-change-user $MONALISA_USER  $PRG_NAME version
                ;;
'restart')
                  cd $MonaLisa_HOME; /usr/local/osg-ce/vdt/sbin/vdt-change-user $MONALISA_USER  $PRG_NAME restart
                ;;
'update')
                  cd $MonaLisa_HOME; /usr/local/osg-ce/vdt/sbin/vdt-change-user $MONALISA_USER  $PRG_NAME update
                ;;
</pre>

</UL>

---++ Installing the <nop>MonALISA software package
<nop>MonALISA is downloaded in the CE node distribution but not automatically activated.


---++Configuring <nop>MonALISA
Prior to ITB 0.3.6 / OSG 0.4.1, the <i>$VDT_LOCATION/vdt/setup/configure_monalisa</i> script was used to configure and activate <nop>MonALISA. 

In order to provide consistency across the various mandatory and optional packages run on the CE node, we are slowly migrating to capture all the necessary information needed by these packages in the <i>configure-osg.sh</i> file and corresponding <i>osg-attributes.conf</i> file.

Now, during the OSG CE configuration (<i>$VDT_LOCATION/monitoring/configure-osg.sh</i>), you will be asked if you wish to activate/run <nop>MonALISA and population of any additional information that <nop>MonALISA might need will be requested in that script.  The VDT <i>configure_monalisa</i> script will be run internally at that time.

So, you should <font color=blue><b>never</b></font> run the <i>configure_monalisa</i> script 
independently.



---++ The <nop>MonALISA configuration files
From the OSG perspective, all changes to the 'real' <nop>MonALISA configuration files should be done using the <i>configure-osg.sh</i> script.  This section is provided only as general information about these files.  

Additional information about these variables and other <nop>MonALISA configuration variables can be viewed at the <a href="http://monalisa.caltech.edu">MonALISA web site</a> under the "Documentation" menu item.

The variables/parameters that are updated by the <i>configure-osg.sh</i> script are noted in each section and should not be updated manuallly.


---+++ml_env
The file for the global configuration is <font color=blue>$MonaLisa_HOME/Service/CMD/ml_env</font>. Some key configuration parameters in this file are:

<TABLE border=1>
<TR><TD colspan=2><font color=blue>These variables are updated by <ii>configure-osg.sh</i>:</TD></TR>
<TR><TD valign=top>
MONALISA_USER 
</TD><TD>
 The name of the user that is running the service. The <i>daemon</i> account is the default and should be satisfactory for most installations.<b>MonALISA should <u>never</u> be run under the <i>root</i> account.</b>  The /etc/init.d/MLD script
will <i>su</i> to MONALISA_USER before starting.
</TD><TD></TR>

<TR><TD valign=top>
SHOULD_UPDATE
</TD><TD>
    Thisparameter tells  !MonALISA to check for updates when it is started.<br>
<b>OSG recommends this option be set to <i>false</i>.</b><br>
When !MonALISA is started:
<OL><LI>If "true", it will first check for updates, install them and then start !MonALISA.
          <LI>If "false" it will not check for updates before starting.
</OL>
</TD><TD></TR>

<TR><TD valign=top>
!MonaLisa_HOME
</TD><TD>
    Path to your <nop>MonALISA installation directory. 
</TD><TD></TR>

<TR><TD valign=top>
FARM_NAME
</TD><TD>
    The name for your farm (as entered in the configuration above). (e.g FARM_NAME="OSG_INSTALL_TEST").
    <br>FARM_NAME in <nop>MonALISA and OSG  [[OSGResourceName][OSG Resource Name]] are synonomous..
</TD><TD></TR>

<TR><TD colspan=2><font color=blue>These variables are <u>not</u> updated by <ii>configure-osg.sh</i>:</TD></TR>
<TR><TD valign=top>
FARM_CONF_FILE
</TD><TD>
    The file used at the startup of the services to define the clusters, nodes and the monitor modules to be used for collecting metrics. It should be in the ${FARM_HOME} directory. (e.g FARM_CONF_FILE="${MonaLisa_HOME}/Services/VDTFarm/vdtFarm.conf").
</TD><TD></TR>

<TR><TD valign=top>
JAVA_HOME 
</TD><TD>
 The path to your current JDK.
</TD><TD></TR>

<TR><TD valign=top>
JAVA_OPTS
</TD><TD>
    An optional parameter to pass parameters directly to the Java Virtual Machine (e.g JAVA_OPTS="-Xmx=128m").
</TD><TD></TR>
</TABLE>


---+++site_env
The file for the site (local) configuration is <i>$MonaLisa_HOME/Service/CMD/site_env</i>. 
This file is used to configure the location for the local batch queuing system used by <nop>VirtualOrganizations/VOInfo_Modules.
An example of this file  is shown below for a CE  node using the Condor job manager:

<font color=blue>All changes to the  variables in this file should be done nusing the  <i>configure-osg.sh</i> script.</font>
<pre>
VDT_LOCATION=/storage/local/data1/osg
export VDT_LOCATION
. $VDT_LOCATION/setup.sh
FBS_LOCATION=
export FBS_LOCATION
LSF_LOCATION=
export LSF_LOCATION
CONDOR_LOCATION=/storage/local/data1/osg/condor
export CONDOR_LOCATION
GLOBUS_LOCATION=/storage/local/data1/osg/globus
export GLOBUS_LOCATION
SGE_LOCATION=
export SGE_LOCATION
CONDOR_CONFIG=/storage/local/data1/osg/condor/etc/condor_config
export CONDOR_CONFIG
SGE_ROOT=
export SGE_ROOT
PBS_LOCATION=
export PBS_LOCATION
CONDOR_LOCAL_DIR=/storage/local/data1/osg/condor/local.cmssrv09
export CONDOR_LOCAL_DIR
</pre>

<font color=blue><b>Note:</b></font> If you are using a batch system other than Condor, the <i>configure-osg.sh</i> should set the correct variables in this file correctly.

---+++vdtFarm.conf
This file, <i>$MonaLisa_HOME/Service/VDTFarm/vdtFarm.conf</i>, specifies the modules which are used to collect the monitoring metrics and the frequency at which they are executed.

<font color=blue><b>The modules that are turned on/off (uncommented/commented) by the <i>configure-osg-sh</i> script are noted.  Do not change these manually except when trouble-shootting as they will be reset on the next execution of the <i>configure-osg.sh</i></b>.</font>

Here is a simple snapshot.  
<pre>
###########################################################
###    Modules used to monitor the master node
#

*Master
>localhost
monProcLoad%30
monProcStat%30
monProcIO%30

###########################################################
### new VO Modules for Jobs and IO 
# 
# The module will use the local job manager
# defined in CMD/site_env. It works with
# Condor, PBS, LSF, FBS, SGE

*osgVO_JOBS{monOsgVoJobs, localhost, }%180          <b><font color=blue>(Set by configure-osg.sh)</font></b>

#
#   
#  If you have Condor installed at your site and you
#  would like to monitor all Condor servers
#  please comment the line above and uncomment the following one
#
#*osgVO_JOBS{monOsgVoJobs, localhost, condoruseglobal }%180
#
# If you would like to export the monitoring information only from
# a specified set of Condor servers, and not from all of them
# use the following format
# The following line will query only the servers IP1, IP2 and IP3
#
#*osgVO_JOBS{monOsgVoJobs, localhost, server=IP1, server=IP2, server=IP3}%180
#
#
# The new VO IO module is using grid FTP logs  

*osgVO_IO{monOsgVO_IO, localhost, }%180              <b><font color=blue>(Set by configure-osg.sh)</font></b>

# The old VO modules are not necessary
#*VO_JOBS{monVoJobs,localhost, }%300
#*VO_IO{monVOgsiftpIO, localhost, }%300
#
#
###########################################################
###   Configuration to monitor the worker nodes
#
# If your site uses Ganglia to monitor the nodes
# left this line uncommented.
# 
# Replace localhost with the node where "gmond" runs.
# If gmond runs on a different port than the standard port
# 8649, please replace 8649 in the following line
#
*PN_vdt{monIGangliaTCP, localhost, 8649}%30                     <b><font color=blue>(Set by configure-osg.sh)</font></b>
# 
# If you want to monitor the worker nodes based on Condor_status 
# using only the local manager please uncomment the following line
# 
#*PN_Condor{monPN_Condor, localhost, }%120                   
#

# If you want to monitor the worker nodes based on Condor_status 
# using a list of condor managers please uncomment the following line
# and provide the names or IPs for the servers.
#
#*PN_Condor{monPN_Condor, localhost, server=IP1, server=IP2, server=IP3 }%120
#
# 
# If you want to use PBS to get monitoring information for the worker node
# please uncomment this line
#
#*PN_PBS{monPN_PBS, localhost, }%120
# 
# PBS module accepts multiple servers and the syntax is as for the condor module
#
###########################################################
###         The ABping module
#   It is used to perform simple network measurements and it is configured dynamically
#   
*ABPing{monABPing, localhost, " "}
#
# 
###########################################################
###      ApMon module  
#        Used to collect monitoring information from the CMS/ARDA jobs 
^monXDRUDP{ParamTimeout=3600,NodeTimeout=3600,ClusterTimeout=3600,ListenPort=58884,AppendIPToNodeName=true}%20
#
#
#
###########################################################
###     Tracepath module 
#       Used to perform monitoring for network topology
#       It is configured dynamically 
#*Tracepath{monTracepath, localhost, " "}
</pre>



---++Operational Notes

---+++Starting and Stopping <nop>MonALISA
<nop>MonALISA should always be started and stopped using the <i>/etc/rc.d</i> services only.
<pre>
   Usage:  /etc/init.d/MLD  [start|stop|restart]
</pre>
By default, <nop>MonALISA is run under the <i>daemon</i> account.  This can be changed (actually
manually overridden) but it is not advisable to do so as most of files and directories require read and write persmissions by the <nop>MonALISA user and ownership has been changed to the <i>daemon</i> account.


---+++Identifying the <nop>MonALISA processes
<nop>MonALISA is a java application  and can be identified as follows:
<pre>
&gt;  ps -efwww |grep -i $VDT_LOCATION/MonaLisa
<b>.... output....</b>
daemon   11062  1.2  1.8 276328 75108 ?      Sl   Mar22   7:33 /storage/local/data1/osg/jdk1.4/bin/java 
      -DMonaLisa_HOME=/storage/local/data1/osg/MonaLisa -Djava.util.logging.config.class=lia.Monitor.monitor.LoggerConfigClass 
      -Djava.security.policy=/storage/local/data1/osg/MonaLisa/policy/policy.all 
      -Dlia.Monitor.SKeyStore=/storage/local/data1/osg/MonaLisa/Service/SSecurity/FarmMonitor.ks -Dlia.Monitor.update=false 
      -Dlia.Monitor.Farm.HOME=/storage/local/data1/osg/MonaLisa/Service/VDTFarm 
      -Dlia.monitor.updateURLs=http://monalisa.cacr.caltech.edu/FARM_ML,http://monalisa.cern.ch/MONALISA/FARM_ML -
      -Dlia.Monitor.ConfigURL=file:/storage/local/data1/osg/MonaLisa/Service/VDTFarm/ml.properties -Xms64m -Xmx64m -jar 
      /storage/local/data1/osg/MonaLisa/Service/lib/JFarmMonitor.jar ITB_INSTALL_TEST
     /storage/local/data1/osg/MonaLisa/Service/VDTFarm/vdtFarm.conf
</pre>
Note: depending on your kernel configuration you may see many threads (the highest count thus far is 98) or you may see just one as shown above.  Do not be concerned.

<nop>MonALISA uses a <i>POSTGRES</i> database for local persistent storage of the metrics collected and runs as an independent process (not a child or thread) of <nop>MonALISA.   If you are running other <i>POSTGRES</i> applications on your platform,  it may be difficult to distinguish  which instance is for what application.  This following is a display from a machine on which the <nop>Monalisa <i>POSTGRES</i> is the only one running:
<pre>
&gt; ps -efwww |grep -i postgres
<b>.... output ...</b>
daemon   11497 11494  0 Mar22 ?        00:00:00 postgres: writer process                         
daemon   11498 11494  0 Mar22 ?        00:00:00 postgres: stats buffer process                   
daemon   11499 11498  0 Mar22 ?        00:00:00 postgres: stats collector process                
daemon   11536 11494  0 Mar22 ?        00:01:00 postgres: mon_user mon_data 127.0.0.1(58721) idle
</pre>
<font color=blue>You should never have to explicitely kill/stop the <nop>MonALISA <i>POSTGRES</i> processes.  This is handled in the <i>/etc/init.d/MLD</i> script.</font>

A little subtlety that you might see when stopping <nop>MonALISA, and may raise some concern on your part, is an "ML_SER stopedb" that shows up:
<pre>
&gt; /etc/init.d/MLD stop
Trying to stop MonaLisa ....STOPPED
Trying to stop epgsqldb...OK

&gt; ps -ef  | grep -i monalisa
daemon   21034     1  0 10:33 ?        00:00:00 /bin/sh -c sleep 45; /storage/local/data1/osg/MonaLisa/Service/CMD/ML_SER stopedb
</pre>
Do not be concerned even when you start <nop>MonALISA immediately.  This process is spawned whenever <nop>MonALISA is stopped and will eventually stop the <i>postgres</i> database server if it has not already been stopped.   The latency may be there as a safeguard for the main <nop>MonALISA repositories processes that pull from the local  databases.








---++Some things to look for in your !MonALISA log file.
After <nop>MonALISA has started, here are a couple items to look for related to the
 <b>VDT_LOCATION/monitoring/grid3-user-vo-map.txt</b> file.  
The  <nop>MonALISA log file is <b>$VDT_LOCATION/MonaLisa/Service/VDTFarm/ML0.log</b>.
<OL>
 <LI>INFO: osgVO_IO-monOsgVO_IO:  [ computeVoAcctsDiff ] Dead VOs [  No VOs removed ]
      <br>- If a VirtualOrganizations/VOInfo was identified as 'dead', it means you  user-vo-map file contained a VirtualOrganizations/VOInfo that no users will be mapped to.
<p>
  <LI>osgVO_IO-monOsgVO_IO[validateMappings]: No VirtualOrganizations/VOInfo account for unix account (des)<br>
          osgVO_IO-monOsgVO_IO[validateMappings]:  ignoredUNIXAccts = des
      <br>- Says the 'des' UNIX account will not map to a VO.
</OL>

---++VirtualOrganizations/VOInfo Modules 
For a description of the metrics collected by the VirtualOrganizations/VOInfo Modules in !MonALISA, please review the following documentation 
<font color=blue>The  documentaion is general in nature and the only part you should be concerned with is the description of the metrcs collected.</font>
<UL>
<LI><a href="http://monalisa.caltech.edu/monalisa__Documentation__Service_Extensions_Guide__vo_io_ug.html">VirtualOrganizations/VOInfo_IO</a></LI>
<LI><a href="http://monalisa.caltech.edu/monalisa__Documentation__Service_Extensions_Guide__vo_jobs_ug.html">VirtualOrganizations/VOInfo_JOBS</a></LI>
</UL>

---++Impact Of  <nop>MonALISA On Host Services
CPU  consumption on the host (CE) server is collected using the 'ps' command.  If you are showing 0 (zero) CPU on that
node, there may be a problem with the command.

The <nop>MonALISA monitoring agents should have a minimal impact the CPU load  of the host (CE) servers.  The  job and gridftp
metrics collected by the VirtualOrganizations/VOInfo_Modules processes have generally  been the biggest consumers of CPU on the host server.
Potential things to look at are:
   * The level of CPU used when your  job manager status command is executed as a part of the VirtualOrganizations/VOInfo Modules..
   * The size of your  globus-gatekeeper.log  and gridftp.log files.  Both of these log files are parsed to collect the job and gridftp metrics.  If logrotate (or your own script)  is performed daily on these logs,  CPU utilization will be minimal.  These files should be rotated at midnight and no more that once per day.
   * Some sites require all E-mail to be sent through a fixed outbound E-mail gateway. !MonALISA is not using a normal sendmail process to send its E-mail and thus any such configuration will be ignored and the mail will not be delivered.  It is possible to disable !MonALISA sending E-mail by 
adding the following lines to $VDT_LOCATION/MonaLisa/Service/VDTFarm

<pre>
lia.util.mail.DEVEL_STATION=true
</pre>




<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->

*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.RobGardner - 09 Mar 2005<br>
-- Main.IosifLegrand - 18 Mar 2005<br>
-- Main.AnneHeavey - 2 Jun 2005<br>
-- Main.JohnWeigand - 03 Jun 2005 - added !VirtualOrganizations/VOInfo_Modules Description  page to VirtualOrganizations/VOInfo_Modules TOC<br>
-- Main.JohnWeigand - 13 Jun 2005 - added  Impact Of  !MonALISA On Host Services to TOC<br>
-- Main.JohnWeigand - 30 Nov 2005 - updated for ITB 03.1 / VDT 1.3.8 releases<br>
-- Main.JohnWeigand - 12 Dec 2005 - updated for ITB 03.3 / VDT 1.3.89releases<br>
-- Main.BurtHolzman - 29 Dec 2005<br>
-- Main.JohnWeigand - 06 Jan 2006<br>
-- Main.JohnWeigand - 20-23 Mar 2006<br>
%STOPINCLUDE%