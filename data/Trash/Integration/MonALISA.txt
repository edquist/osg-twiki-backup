%META:TOPICINFO{author="StevenTimm" date="1142623443" format="1.0" version="1.26"}%
%META:TOPICPARENT{name="ValidationPageRel01"}%
<!-- This is the default OSG Integration template. 
Please modify it in the sections indicated to create your topic!
If you have any comments/complaints about this template, then please email me:
rwg@hep.uchicago.edu.  (Adapted from Atlas wiki template, Ed Moyse)
--> 

<!-- By default the title is the WikiWord used to create this topic !-->
<!-- if you want to modify it to something more meaningful, just replace %TOPIC% below with i.e "My Topic"!-->

---+!!<nop>%TOPIC%
%TOC%
%STARTINCLUDE%


---++Introduction
The <a href="http://monalisa.caltech.edu">MonALISA  (Monitoring Agents in A Large Integrated Services Architecture)</a> system provides a distributed service for monitoring, control and global optimization of complex systems. It is based on an ensemble of autonomous multi-threaded, agent-based subsystems which are registered as dynamic services and are able to collaborate and cooperate in performing a wide range of monitoring and decision tasks in large scale distributed applications, and to be discovered and used by other services or clients that require such information. 

---++Known Problems
%RED% This guide says that all the monalisa properties are
stored in VDT_LOCATION/vdt-app-data/MonaLisa/monalisa.properties
but it also gives instructions to modify other configuration
files which are stored in various subdirectories of
$VDT_LOCATION/MonaLisa.  (Experience tells me the latter is correct).
Need to clear up this ambiguity and be clear of what is set where.
S. Timm 3/17/06
%ENDCOLOR%
---++ Installing the !MonALISA software package

!MonALISA is downloaded in the CE node distribution but not automatically configured and setup to execute at boot time.


---++Configuration 
The configuration script =monitoring/configure_osg.sh= must be run. This script queries regarding MonALISA support.
It needs to know the $VDT_LOCATION so it is best to 
source the $VDT_LOCATION/setup.sh(csh) script prior to running it.

<pre>
Information needed for the MonALISA monitoring.
-----------------------------------------------
MonALISA services are NOT being used.

If you do not intend to run MonALISA for monitoring purposes, you can
skip this section.

Ganglia host: The host machine ganglia is running on.
Ganglia port: The host machine's port ganglia is using.
VO Modules:	(y or n) If 'y', this will activate the VO Modules module
				  in the MonALISA configuration file.

Are you running the MonALISA monitoring services [n] (y/n): 
</pre>

Enter %RED%y%ENDCOLOR%.

For a VDT installed !MonALISA, the configuration variables are stored in 
VDT_LOCATION/vdt-app-data/MonaLisa/monalisa.properties.  After the initial download is complete, this file contains the
default values the !MonALISA will be populated with.  <b>These must be changed</b> as not all answers can be resolved 
automatically.

The information below documents the full configurion options which are complete by the =/monitoring/configure-osg.sh= script
and is available.

---++Additional Information for the interested

<TABLE border=1>
<TR bgcolor="blue">
  <TD><center><font color=white><b>
	 VDT_LOCATION/vdt-app-data/Monalisa/<BR>
	 monalisa.properties
	 </center></font></b></TD>
  <TD><B><center><font color=white>Command line<br> arguments</center></font></b></TD>
  <TD><B><center><font color=white>Description</font></center></b></TD>
</TD</TR>
<TR><TD valign=top></TD>
  <TD valign=top>--help</TD><TD valign=top>
	Lists all options
</TD</TR>
<TR><TD valign=top></TD>
  <TD valign=top>--server y|n</TD><TD valign=top>
	Installs the MLD startup script in /etc/init.d.  It does not start the !MonALISA server.
</TD</TR>
<TR><TD valign=top></TD>
  <TD valign=top>
			--prompt<br>--noprompt
</TD><TD valign=top>
	 --prompt, puts you in question/answer mode. <b>Recommended.</b><br>
	--noprompt, then you need the command line arguments for the attributes you wish to change.<p>
	The script uses the monalisa.properties file (1st column) for all missing arguments.<br>
	This file is always updated regardless of the prompt  mode.
</TD</TR>
<TR><TD valign=top> 
VDT_LOCATION="/storage/local/data1/osg"</TD>
  <TD valign=top>--vdt-install</TD><TD valign=top>
	Parent directory of the !MonALISA installation.
	<b>
	Required unless you source the VDT_LOCATION/setup.sh script first.
</TD</TR>
<TR><TD valign=top>
CONTACT_NAME="root"<BR>
CONTACT_EMAIL="root@cmssrv09.fnal.gov"</TD>
  <TD valign=top>--contact-name<BR>--contact-email</TD><TD valign=top>
	This is the name and email address of the person responsible for the site/CE node.
</TD</TR>
<TR><TD valign=top>
MONITOR_GROUP="Test"</TD>
  <TD valign=top>--monitor-group</TD><TD valign=top> 
	  This specifies the group in which !MonALISA places your site/CE for monitoring.
	  <BR>For the OSG, use <b>OSG</b>.
</TD</TR>
<TR><TD valign=top>
FARMNAME="cmssrv09.fnal.gov"</TD>
  <TD valign=top>--farm</TD><TD valign=top>
	 This is your <b>OSG resource name</b> that you chose during the pre-installation check list.<p>
	  Please refer to the [[OSGResourceName][OSG Resource Name Guide]] for further details.
 
</TD</TR>
<TR><TD valign=top>
GANGLIA="y"<BR>
GANGLIA_HOST="localhost"<BR>
GANGLIA_PORT="8649"</TD>
  <TD valign=top><BR>--ganglia-host<BR>--ganglia-port</TD><TD valign=top>
	 To enable Ganglia interaction with !MonALISA, answer "y" when asked if you want to connect to a
	 ganglia instance. Otherwise answer "n" for no.
	 <p>
	 If yes, then the hostname and the port on which that Ganglia instance runs is required.
	 <p>
	 To test if !MonALISA is able to access Ganglia monitoring information just telnet on the
	 <b><i>gmond</i></b> port and check if you get an XML.
	 <OL><b><i>telnet localhost 8649</b></i></OL>
</TD</TR>
<TR><TD valign=top>
USER="daemon"</TD>
  <TD valign=top>--user</TD><TD valign=top>
	 The username under which !MonALISA runs on your CE node. <br>
	 In most cases it will be either daemon or monalisa.
</TD</TR>
<TR><TD valign=top>
VO_MODULES="y"</TD>
  <TD valign=top>--vo-modules y|n</TD><TD valign=top>
	 If yes, then job submission and job queue metrics will be collected by !MonALISA.
	 <p>
	 See the <a href="#VO_Modules">VO Modules section </a> of this guide for more details.

</TD</TR>
<TR><TD valign=top>
CITY=<BR>
COUNTRY=<BR>
LAT="0"<BR>
LONG="0"</TD>
  <TD valign=top>--city<BR>--country<BR>--latitude<BR>--longitude</TD><TD valign=top>
	These attributes will identify your site/node on the world map.<br>
	You can find some approximate values for your geographic location from:
	<OL>http://geotags.com/ <br>
	 or you can search your location on Google.
	</OL>
	<P>
	Use only numbers to specify the geographic location.<br>
	<b>Important:</b> Use "-" to specify West (longitude) or South (latitude).
	For example, for the longitude of 118W, use -118.
</TD</TR>
<TR><TD valign=top>
GLOBUS_LOCATION="$GLOBUS_LOCATION"<BR>
CONDOR_LOCATION="$CONDOR_LOCATION"<BR>
CONDOR_CONFIG="$CONDOR_CONFIG"<BR>
FBS_LOCATION=""<BR>
LSF_LOCATION=""<BR>
PBS_LOCATION=""<BR>
SGE_LOCATION=""</TD>
  <TD valign=top>--globus-location<BR>
				 --condor-location<BR>
				 --condor-config<BR>
				 --fbs-location<BR>
				 --pbs-location<BR>
				 --lsf-location<BR>
				 --sge-location<BR>
					 </TD><TD valign=top>
	This information about Globus and the job managers is needed by the VO_Modules metrics.<br>
See the <a href="#VO_Modules">VO Modules section </a> of this guide for more details.
	<p>
	The VDT installation attempts to detect what you have and where its at to initially populate
	these values.
</TD</TR>
<TR><TD valign=top>
SHOULD_UPDATE="n"</TD>
  <TD valign=top>--auto-update y|n</TD><TD valign=top>
	<b>It is recommended that this be set to "n".</b>
	<p>
	This tells !MonALISA to look (if set to "y") for software updates whenever a restart of
	the !MonALISA daemon (/etc/init.d/MLD) is performed.
	<P>
	For the OSG installation, the recommendation is to <b>NOT</b> have automatic
	software updates.  This insures consistency in the metrics being reported across sites.

</TD</TR>
</TABLE>


Here is an example execution of the configuration script with the <b>--prompt</b> argument specified:<br>
Note:  The <b>--server y</b> argument is also used so the MLD startup file is installed in /etc/init.d.
<pre>
$  source $VDT_LOCATION/setup.sh
$  $VDT_LOCATION/vdt/setup/configure_monalisa  --prompt  --server y

To configure MonaLisa you need to specify a few parameters.
Please answer the following questions:

Please specify user account to run !MonaLisa daemons as: [daemon] <i><b>daemon</b></i>

This is the name you will be seen by the world, so please choose
a name that represents you. Make sure this name is unique in the
!MonaLisa environment.
Please specify the farm name: [cmssrv09.fnal.gov] <b><i>OSG_INSTALL_TEST</b></i>  <b>NOTE: This is your OSG Resource Name</b>

Your Monitor Group name is important to group your site correctly
in the global site list. OSG users should enter "OSG"
Please enter your monitor group name: [Test] <b>OSG</b>

Please enter your contact name (your full name): [root] <i><b>John Weigand</b></i>
Contact email (your email): [root@cmssrv09.fnal.gov] <i><b>weigand@fnal.gov</b></i>
City (server's location): [] <i><b>Batavia, IL</b></i>
Country: [] <i><b>USA</b></i>

  You can find some approximate values for your geographic location from:
http://geotags.com/
or you can search your location on Google
For USA: LAT  is about	29 (South)		...  48 (North)
			LONG is about -123 (West coast) ... -71 (East coast)
Location latitude ( -90 (S) .. 90 (N) ): [0] <i><b>41.50</b></i>
Location longitude ( -180 (W) .. 180 (E) ): [0] <i><b>-88.18</b></i>

Will you connect to a Ganglia instance (y/n): [y] <i><b>n</b></i>

Do you want to run OSG_VO_Modules (y/n): [y] <i><b>y</b></i>

Please specify GLOBUS location: [/storage/local/data1/osg/globus] <i><b>/storage/local/data1/osg/globus</b></i>
Please specify CONDOR location: [/storage/local/data1/osg/condor] <i><b>/storage/local/data1/osg/condor</b></i>
Please specify the path to condor_config: [/storage/local/data1/osg/condor/etc/condor_config] <i><b>/storage/local/data1/osg/condor/etc/condor_config</b></i>
Please specify PBS location: []
Please specify LSF location: []
Please specify FBS location: []
Please specify SGE location: []

Do you want to enable the MonALISA auto-update feature (y/n): [n] <b>n</b>

Applying Site Env Variables [ /storage/local/data1/osg/MonaLisa/Service/CMD/site_env ]
		  VDT_LOCATION = /storage/local/data1/osg
		  GLOBUS_LOCATION = /storage/local/data1/osg/globus
		  CONDOR_LOCATION = /storage/local/data1/osg/condor
		  CONDOR_CONFIG = /storage/local/data1/osg/condor/etc/condor_config
		  PBS_LOCATION =
		  LSF_LOCATION =
		  FBS_LOCATION =
		  SGE_LOCATION =
		  SGE_ROOT =
Applying ML Env Variables [ /storage/local/data1/osg/MonaLisa/Service/CMD/ml_env ]
		  FARM_HOME = ${MonaLisa_HOME}/Service/VDTFarm
		  JAVA_HOME = /storage/local/data1/osg/jdk1.4
		  MONALISA_USER = daemon
		  FARM_CONF_FILE = ${FARM_HOME}/vdtFarm.conf
		  FARM_NAME = OSG_INSTALL_TEST
		  SHOULD_UPDATE = false
		  MonaLisa_HOME = /storage/local/data1/osg/MonaLisa
Applying ML Properties [ /storage/local/data1/osg/MonaLisa/Service/VDTFarm/ml.properties ]
		  MonaLisa.LAT = 41.50
		  MonaLisa.ContactEmail = weigand@fnal.gov
		  lia.Monitor.group = OSG
		  MonaLisa.LONG = -88.18
		  MonaLisa.Country = USA
		  MonaLisa.ContactName = John Weigand
		  MonaLisa.Location = Batavia, IL
Enabling ML modules [ /storage/local/data1/osg/MonaLisa/Service/VDTFarm/vdtFarm.conf ]
		  Ganglia = disabled
		  monPN_Condor = enabled
		  monPN_PBS = disabled
		  VO Modules (monOsgVoJobs and monOsgVO_IO) = enabled
		  GridFTP log = /storage/local/data1/osg/globus/var/log/gridftp.log
ML configuration was written successfully!
</pre>


---+++Configuring /etc/init.d services for the !MonALISA server 
In order to get the MLD startup script installed in /etc/init.d (if you did not do so when configuring), run:
<pre>
	 $ cd VDT_LOCATION
	 $ source setup.sh
	 $ $VDT_LOCATION/vdt/setup/configure_monalisa --server y
</pre>

The !MonALISA server  should have started as a part of the above configuration. if you used the --server option.  To verify, try:
<pre>
	$ ps  -ef  | grep MonaLisa_HOME
</pre>


Verify the services have been added and activated (on some systems this will not occur as shown below):
<pre>
	&gt; chkconfig --list MLD
	MLD				 0:off	1:off	2:off	3:off	4:off	5:off	6:off
</pre>

To activate the services for the run level:
<pre>
	&gt; chkconfig MLD on
</pre>


---+++ Starting/Stopping  !MonALISA 
Usage: <b>/etc/init.d/MLD start  | stop | restart </b>

To verify yoursite is reporting to !MonALISA, wait at least 15 minutes, then check the OSG repository by:
<OL><LI>Go to the <a href="http://monalisa.caltech.edu">MonALISA web site</a></LI>
		  <LI>Click on Repositories</LI>
		  <LI>Click on OSG </LI>
		  <LI>and verify that your site is represented there. </LI>
</OL>


---+++ The !MonALISA configuration files
From the OSG perspective, all changes to the basic !MonALISA configuration files should be done using the <i>configure_monalisa</i> script.
This script updates the "real" !MonALISA configuration files as identified in the output after you confirm your changes <i>AND</i> also updates the <b>$VDT_LOCATION/vdt-app-data/Monalisa/monalisa.properties</b> file that is used by other OSG services.

Additional information about these variables and other !MonALISA configuration variables can be viewed at the 
<a href="http://monalisa.caltech.edu">MonALISA web site</a>
under the "Documentation" menu item.


---++++ml_env

The file for the global configuration is <b>$MonaLisa_HOME/Service/CMD/ml_env</b>. Some key configuration parameters in this file are:

<TABLE border=1>
<TR><TD valign=top>
MONALISA_USER 
</TD><TD>
 The name of the user that is running the service. The <i>daemon</i> account is the default and should be satisfactory for most installations.<b>MonALISA should <u>never</u> be run under the <i>root</i> account.</b>  The /etc/init.d/MLD script
will <i>su</i> to MONALISA_USER before starting.
</TD><TD></TR>

<TR><TD valign=top>
JAVA_HOME 
</TD><TD>
 The path to your current JDK.
</TD><TD></TR>

<TR><TD valign=top>
SHOULD_UPDATE
</TD><TD>
	 This parameter tells  !MonALISA to check for updates when it is started.<br>
<b>OSG recommends this option be set to <i>false</i>.</b><br>
When !MonALISA is started:
<OL><LI>If "true", it will first check for updates, install them and then start !MonALISA.
			 <LI>If "false" it will not check for updates before starting.
</OL>
</TD><TD></TR>

<TR><TD valign=top>
!MonaLisa_HOME
</TD><TD>
	 Path to your !MonALISA installation directory. 
</TD><TD></TR>

<TR><TD valign=top>
FARM_CONF_FILE
</TD><TD>
	 The file used at the startup of the services to define the clusters, nodes and the monitor modules to be used for collecting metrics. It should be in the ${FARM_HOME} directory. (e.g FARM_CONF_FILE="${MonaLisa_HOME}/Services/VDTFarm/vdtFarm.conf").
</TD><TD></TR>

<TR><TD valign=top>
FARM_NAME
</TD><TD>
	 The name for your farm (as entered in the configuration above). (e.g FARM_HOME="OSG_INSTALL_TEST").
	 <br>FARM_NAME in !MonALISA and  [[OSGResourceName][OSG Resource Name]] are the same thing..
	 <br>
 <b>This should be the same name used when you ran <i>configure_osg.sh</i> specifying your <i>SITE_NAME</i>.</b>
</TD><TD></TR>

<TR><TD valign=top>
JAVA_OPTS
</TD><TD>
	 An optional parameter to pass parameters directly to the Java Virtual Machine (e.g JAVA_OPTS="-Xmx=128m").
</TD><TD></TR>
</TABLE>


---++++site_env
The file for the site (local) configuration is <b>$MonaLisa_HOME/Service/CMD/site_env</b>. 
This file is used to configure the location for the local batch queuing system used by !VO_Modules.
An example of this file  is shown below for a CE  node using the Condor job manager:
<pre>
VDT_LOCATION=/storage/local/data1/osg
export VDT_LOCATION
. $VDT_LOCATION/setup.sh
FBS_LOCATION=
export FBS_LOCATION
LSF_LOCATION=
export LSF_LOCATION
CONDOR_LOCATION=/storage/local/data1/osg/condor
export CONDOR_LOCATION
GLOBUS_LOCATION=/storage/local/data1/osg/globus
export GLOBUS_LOCATION
SGE_LOCATION=
export SGE_LOCATION
CONDOR_CONFIG=/storage/local/data1/osg/condor/etc/condor_config
export CONDOR_CONFIG
SGE_ROOT=
export SGE_ROOT
PBS_LOCATION=
export PBS_LOCATION
CONDOR_LOCAL_DIR=/storage/local/data1/osg/condor/local.cmssrv09
export CONDOR_LOCAL_DIR
</pre>

---++++vdtFarm.conf
  This file, <b>$MonaLisa_HOME/Service/VDTFarm/vdtFarm.conf</b>,
specifies the modules which are used for monitoring.
Here is a simple snapshot.  
<pre>
###########################################################
###	 Modules used to monitor the master node
#

*Master
>localhost
monProcLoad%30
monProcStat%30
monProcIO%30

###########################################################
### new VO Modules for Jobs and IO 
# 
# The module will use the local job manager
# defined in CMD/site_env. It works with
# Condor, PBS, LSF, FBS, SGE

*osgVO_JOBS{monOsgVoJobs, localhost, }%180

#
#	
#  If you have Condor installed at your site and you
#  would like to monitor all Condor servers
#  please comment the line above and uncomment the following one
#
#*osgVO_JOBS{monOsgVoJobs, localhost, condoruseglobal }%180
#
# If you would like to export the monitoring information only from
# a specified set of Condor servers, and not from all of them
# use the following format
# The following line will query only the servers IP1, IP2 and IP3
#
#*osgVO_JOBS{monOsgVoJobs, localhost, server=IP1, server=IP2, server=IP3}%180
#
#
# The new VO IO module is using grid FTP logs  

*osgVO_IO{monOsgVO_IO, localhost, }%180

# The old VO modules are not necessary
#*VO_JOBS{monVoJobs,localhost, }%300
#*VO_IO{monVOgsiftpIO, localhost, }%300
#
#
###########################################################
###	Configuration to monitor the worker nodes
#
# If your site uses Ganglia to monitor the nodes
# left this line uncommented.
# 
# Replace localhost with the node where "gmond" runs.
# If gmond runs on a different port than the standard port
# 8649, please replace 8649 in the following line
#
*PN_vdt{monIGangliaTCP, localhost, 8649}%30
# 
# If you want to monitor the worker nodes based on Condor_status 
# using only the local manager please uncomment the following line
# 
#*PN_Condor{monPN_Condor, localhost, }%120
#

# If you want to monitor the worker nodes based on Condor_status 
# using a list of condor managers please uncomment the following line
# and provide the names or IPs for the servers.
#
#*PN_Condor{monPN_Condor, localhost, server=IP1, server=IP2, server=IP3 }%120
#
# 
# If you want to use PBS to get monitoring information for the worker node
# please uncomment this line
#
#*PN_PBS{monPN_PBS, localhost, }%120
# 
# PBS module accepts multiple servers and the syntax is as for the condor module
#
###########################################################
###			The ABping module
#	It is used to perform simple network measurements and it is configured dynamically
#	
*ABPing{monABPing, localhost, " "}
#
# 
###########################################################
###		ApMon module  
#		  Used to collect monitoring information from the CMS/ARDA jobs 
^monXDRUDP{ParamTimeout=3600,NodeTimeout=3600,ClusterTimeout=3600,ListenPort=58884,AppendIPToNodeName=true}%20
#
#
#
###########################################################
###	  Tracepath module 
#		 Used to perform monitoring for network topology
#		 It is configured dynamically 
#*Tracepath{monTracepath, localhost, " "}
</pre>


---++Some things to look for in your !MonALISA log file.
After !MonALISA has started, here are a couple items to look for related to the
 <b>VDT_LOCATION/monitoring/grid3-user-vo-map.txt</b> file.  
The  !MonALISA log file is <b>$VDT_LOCATION/MonaLisa/Service/VDTFarm/ML0.log</b>.
<OL>
 <LI>INFO: osgVO_IO-monOsgVO_IO:  [ computeVoAcctsDiff ] Dead VOs [  No VOs removed ]
		<br>- If a VO was identified as 'dead', it means you  user-vo-map file contained a VO that no users will be mapped to.
<p>
  <LI>osgVO_IO-monOsgVO_IO[validateMappings]: No VO account for unix account (des)<br>
			 osgVO_IO-monOsgVO_IO[validateMappings]:  ignoredUNIXAccts = des
		<br>- Says the 'des' UNIX account will not map to a VO.
</OL>

---++VO Modules 
For a description of the metrics collected by the VO Modules in !MonALISA, please review the following documentation:
<UL>
<LI><a href="http://monalisa.caltech.edu/monalisa__Documentation__Service_Extensions_Guide__vo_io_ug.html">VO_IO</a></LI>
<LI><a href="http://monalisa.caltech.edu/monalisa__Documentation__Service_Extensions_Guide__vo_jobs_ug.html">VO_JOBS</a></LI>
</UL>

---++Impact Of  !MonALISA On Host Services
CPU  consumption on the host (CE) server is collected using the 'ps' command.  If you are showing 0 (zero) CPU on that
node, there may be a problem with the command.

The !MonALISA monitoring agents should have a minimal impact the cpu load  of the host (CE) servers.  The  job and gridftp
metrics collected by the VO_Modules processes have generally  been the biggest consumers of CPU on the host server.
Potential things to look at are:
	* The level of CPU used when your  job manager status command is executed as a part of the VO Modules..
	* The size of your  globus-gatekeeper.log  and gridftp.log files.  Both of these log files are parsed to collect the job and gridftp metrics.  If logrotate (or your own script)  is performed daily on these logs,  CPU utilization will be minimal.  These files should be rotated at midnight and no more that once per day.
	* Some sites require all E-mail to be sent through a fixed outbound E-mail gateway. !MonALISA is not using a normal sendmail process to send its E-mail and thus any such configuration will be ignored and the mail will not be delivered.  It is possible to disable !MonALISA sending E-mail by 
adding the following lines to $VDT_LOCATION/MonaLisa/Service/VDTFarm

<pre>
lia.util.mail.DEVEL_STATION=true
</pre>




<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->

*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.RobGardner - 09 Mar 2005<br>
-- Main.IosifLegrand - 18 Mar 2005<br>
-- Main.AnneHeavey - 2 Jun 2005<br>
-- Main.JohnWeigand - 03 Jun 2005 - added !VO_Modules Description  page to VO_Modules TOC<br>
-- Main.JohnWeigand - 13 Jun 2005 - added  Impact Of  !MonALISA On Host Services to TOC<br>
-- Main.JohnWeigand - 30 Nov 2005 - updated for ITB 03.1 / VDT 1.3.8 releases<br>
-- Main.JohnWeigand - 12 Dec 2005 - updated for ITB 03.3 / VDT 1.3.89releases<br>
-- Main.BurtHolzman - 29 Dec 2005<br>
-- Main.JohnWeigand - 06 Jan 2006<br>
%STOPINCLUDE%

