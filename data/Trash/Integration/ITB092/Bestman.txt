%META:TOPICINFO{author="JamesWeichel" date="1317149003" format="1.1" version="1.27"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! *<nop>Berkeley Storage Manager (!BeStMan)*
%TOC%

%STARTINCLUDE%

*Purpose*: The purpose of this document is to provide [[http://datagrid.lbl.gov/bestman][BeStMan]] based SE administrators the information on how to prepare, install and validate the SE.

---++ Introduction
 Berkeley Storage Manager ([[http://datagrid.lbl.gov/bestman][BeStMan]]) is a full implementation of SRM v2.2, developed by Lawrence Berkeley National Laboratory, for a disk based storage and mass storage systems such as HPSS. End users may have their own personal [[http://datagrid.lbl.gov/bestman][BeStMan]] that manages and gives an SRM interface to their own local disks. It works on top of existing disk-based unix file systems, and has been reported so far to work on file systems such as NFS, GPFS, PVFS, GFS, Ibrix, HFS+, Hadoop, !XrootdFS and Lustre. It also works with any existing file transfer service, such as gsiftp, http, https, bbftp and ftp. It requires minimal administrative efforts on the deployment and updates. If storage is hierarchical and/or spans multiple file system types and storage systems, [[ReleaseDocumentation.DCacheInstall][SRM/dCache]] should be considered. 

---+++ Current version info
   * March 16, 2009  !BeStMan 2.2.1.2.i3
 
---++ Installation from VDT distribution

While it is possible to deploy !BeStMan as a personal disk manager, the following descriptions target a more general use installation that provides an SE functionality for serving as a data gateway into your cluster. !BeStMan is distributed by the VDT and, like other services deployed in the OSG. It installs with Pacman and assumes PacmanInstall steps have been taken. This process will  install in a directory selected by an administrator of the SE (e.g. /opt/osg-1.0/) the necessary software by running the following command line. 
%NOTE% If you are doing a fresh install on a host that has a previous installation, setting =export OLD_VDT_LOCATION = /path-to-old-vdt/= will pre-answer the following questions.

---+++ 
=export VDT_GUMS_HOST =  &#60; GUMS hostname &#62;=      # if you want to use GUMS for !GridFtp and Gratia !GridFTP probe authorization

=pacman -get ITB:Bestman=

The install process will ask to accept the vdt-cache, check for prequisites and ask to accept licenses. It will then ask several questions about deploying and enabling services for the GRID access. Specifically (though edited to only show the questions and suggested answers) :
<verbatim>
Do you want to add [http://software.grid.iu.edu/itb/] to [trusted.caches]? (y/n/yall): yall
Do you agree to the licenses? [y/n]  y
Where would you like to install CA files?
Choices:
        r (root)  - install into /etc/grid-security/certificates
                   (existing CA files will be preserved)
        l (local) - install into $VDT_LOCATION/globus/share/certificates
        n (no)    - do not install
r
Do you want to automatically update your CA Certificates? [y/n] y
Would you like to enable Globus GridFTP daemon to run automatically? y
Would you like to setup daily rotation of VDT log files? y
Would you like to enable the Bestman server to run automatically? y
Do you want to update the CA certification revocation lists (CRLs) automatically? [y/n] y
(downloading)                                                             
========== IMPORTANT ==========
The VDT no longer installs certificate authority certificates at install time.
Most of the software installed by the VDT *will not work* until you install
certificates.  To complete your CA certificate installation, see the notes
in the post-install/README file.
</verbatim>

The installation should finish quietly. You can review what has been in stalled by the following commands:
<verbatim>
# source setup.sh
# vdt-version

You have installed a subset of VDT version 1.10.98v:

Software                                                 Status              
--------                                                 ------              
Berkeley Storage Manager (BeStMan) 2.2.1.2.i4            OK                  
EDG Make Gridmap 3.0.0                                   OK                  
Fetch CRL 2.6.6                                          -                   
GPT 3.2autotools2004-NMI-9.0                             -                   
Gratia GridFTP Probe 1.02.1-5                            OK                  
Grid User Management System (GUMS) Client 1.3.14         OK                  
Java 5 SDK 1.5.0_17                                      OK                  
Java 6 SDK 1.6.0_11                                      OK                  
Logrotate 3.7                                            -                   
PRIMA Authorization Module 0.8.3                         OK                  
vdt-update-certs 2.2                                     -                   
Wget 1.11.4                                              OK                  


Status legend:
OK: Software is up to date with the latest release in VDT version 1.10.98
- : Not enough information to determine if updates are available.
See man page for more information.
</verbatim>

And check which services are ready to deploy with:
<verbatim>
# vdt-control --list
Service            | Type   | Desired State
-------------------+--------+--------------
fetch-crl          | cron   | enable
vdt-rotate-logs    | cron   | enable
vdt-update-certs   | cron   | enable
gsiftp             | inetd  | enable
gratia-gridftp-tran| cron   | do not enable
bestman            | init   | enable
</verbatim>


---+++ Configuration for VDT installation

The full review of !BeStMan configuration options are provided in the [[http://datagrid.lbl.gov/bestman/docs/bestman-guide.html][Bestman Administrative Guide]]. The process is controlled by a !BeStMan-specific configuration script ( =$VDT_LOCATION/bestman/setup/configure= ) with command line arguments to define such items as cache directories, CA cert and CRL locations, service ports, logging information ... During the VDT installation, some defaults are used to do an initial configuration and can be reviewed from the =vdt-install.log= file. For example:
<verbatim>
# grep /bestman vdt-install.log | grep configure
### 2009-02-18 15:27:48 (failsafe_system) cd /opt/osg/itb-0.9.2/bestman/setup; 
./configure     --with-java-home=/opt/osg/itb-0.9.2/jdk1.6    \
--with-srm-home=/opt/osg/itb-0.9.2/bestman    \
--with-srm-owner=daemon   \
--with-cacert-path=/opt/osg/itb-0.9.2/globus/TRUSTED_CA   \
--with-certfile-path=/etc/grid-security/http/httpcert.pem   \
--with-keyfile-path=/etc/grid-security/http/httpkey.pem   \
--with-eventlog-path=/opt/osg/itb-0.9.2/vdt-app-data/bestman/logs    \
--with-cachelog-path=/opt/osg/itb-0.9.2/vdt-app-data/bestman/logs   \
--with-http-port=10080    \
--with-https-port=10443   \     
--with-globus-tcp-port-range=62000,65000  \
--with-replica-storage-path=/opt/osg/itb-0.9.2/vdt-app-data/bestman/cache   \
 --with-replica-storage-size=11368 
</verbatim>

This configuration is done by a script =$OSG_LOCATION/vdt/setup/configure_bestman=. This script sets/changes the following Bestman parameters:
<verbatim>
#./configure_bestman --help
Usage: ./configure_bestman --vdt-install <vdt install root>
        --server <y,n>
        --user <bestman user>
        --cert <bestman service cert>
        --key  <bestman service key>
        --http-port <public port number>
        --https-port <secure port number>
        --globus-tcp-port-range <low_port,high_port>
        --volatile-file-lifetime <lifetime in seconds>
        --cache-size <Cache size in MB>
        --gums-host <GUMS hostname>
        --gums-port <GUMS port number>
        --gums-url <GUMS URL>
        --gums-dn <Client DN for GUMS interface>
        --enable-gateway
        --use-xrootd
        --with-tokens-list <token-list>
        --with-transfer-servers <GridFTP server list>
        --with-allowed-paths <List of accessible paths>
        --with-blocked-paths <List of non-accessible paths>

If you specify --user you must specify --cert and --key as well
</verbatim>
The default configuration sets up !BeStMan to use grid mapfiles, but bestman is also fully capable of using the GUMS server.
If there is a need to change any of the parameters the =configure_bestman= script should be always used. Here is an example
how the owner, ports and dependence on GUMS were changed using this script:
<verbatim>
vdt/setup/configure_bestman --user srm \
--cert /etc/grid-security/srm/hostcert.pem \
--key /etc/grid-security/srm/hostkey.pem  \
--server y  \
--http-port=60080    \
--https-port=60443 \
--gums-host osp2.lbl.gov \
--gums-port 8443
</verbatim>

It is important to notice that --server y should be specified, otherwise the =configure_bestman= script disables the bestman server and then
it needs to be turned on again with the =vdt-control --on bestman=.

 !BeStMan installation comes with a !GridFTP server.  If you want to use a GUMS server for user authentication and authorization copy two files from _$VDT_LOCATION/post-install_ to in _/etc/grid-security_: 
 
<pre >
cp $VDT_LOCATION/post-install/prima-authz.conf /etc/grid-security 
cp $VDT_LOCATION/post-install/gsi-authz.conf /etc/grid-security 
</pre>

---+++ Integration with the information system

Integration of the SE with the central information systems takes place during the Compute Element installation/configuration. See the topic [[ReleaseDocumentation/GenericInformationProviders][Generic Information Providers]]. The SE does not collect or publish information independently.

---++ Installation from downloaded tar file

   * Manual installation is possible after downloading !BeStMan from [[http://datagrid.lbl.gov/bestman][http://datagrid.lbl.gov/bestman]], and run configure.

---+++ Manual configuration
   * More configuration samples are available in README file from the downloaded package.
<verbatim>
cd bestman/setup
./configure \ 
--with-replica-storage-path=/data/osgdemo/data \ 
--with-replica-storage-size=20000 \ 
--with-http-port=10080 \ 
--with-https-port=10443 \ 
--with-globus-tcp-port-range=62001,65000 \ 
--with-certfile-path=/home/srm/osgdemo/srmtestcert.pem \ 
--with-keyfile-path=/home/srm/osgdemo/srmtestkey.pem \ 
--with-eventlog-path=/data/osgdemo/log \ 
--with-cachelog-path=/data/osgdemo/log 
</verbatim>

---+++ Server control
   * to Start the !BeStMan server, in $SRM_HOME/sbin
      * SXXbestman start  or SXXbestman.personal start
   * to Stop the !BeStMan server, in $SRM_HOME/sbin
      * SXXbestman stop  or SXXbestman.personal stop
   * Or manually
      * e.g. nohup $SRM_HOME/sbin/bestman.server >& /tmp/bestman-.log 2>&1 &

---++ Firewall issues

If you have firewall, the gridftp port range should be properly set. In order to do so, you need to modify vdt-local-setup.sh.

edit =$VDT_LOCATION/vdt/etc/vdt-local-setup.sh=
<pre> 
GLOBUS_TCP_SOURCE_RANGE= low_port,high_port 
GLOBUS_TCP_PORT_RANGE= low_port,high_port
export GLOBUS_TCP_SOURCE_RANGE
export GLOBUS_TCP_PORT_RANGE
</pre>
Where low_port,high_port - controls all outbound globus connections for gridftp (e.g GLOBUS_TCP_PORT_RANGE=40000,49150).<br>
This low_port,high_port must correspond to --globus-tcp-port-range of VDT configuration of !BeStMan (or --with-globus-tcp-port-range and --with-globus-tcp-source-range from the !BeStMan manual configuration).<br>
Also, make sure that two ports for !BeStMan (--http-port and --https-port from the VDT configuration) are open.<br>


---++ Validation

---+++ Site registration and daily monitoring
Once you have your SE setup and configured, you can register it with the [[http://datagrid.lbl.gov/sitereg/][LBNL SRM monitoring system]]. This will run daily tests against your SE and the results can be viewed [[http://datagrid.lbl.gov/osg/][here]].

---+++ Self-testing with srm clients
A series of self-testing can be done with [[Trash.StorageSRMv2Client][srm clients]]. Follow instructions and samples below or on the [[Trash.StorageSRMv2Client][srm client page]].

---+++ Self-testing with srm-tester
A series of self-testing can be done with [[Storage.SRMTester][srm-tester]]. Follow instructions and samples on the [[Storage.SRMTester][srm-tester page]].

---++ Sample client runs (or [[Trash.StorageSRMv2Client][more SRM v2.2 client command line examples]])

   * Assuming that !BeStMan or LBNL srm client installation is in the PATH
      * ping
         * srm-ping srm://osp4.lbl.gov:62443/srm/v2/server
      * put
         * srm-copy file:////tmp/test.data srm://osp4.lbl.gov:62443/srm/v2/server\?SFN=/srmcache/star/osg.test.data
      * ls
         * srm-ls srm://osp4.lbl.gov:62443/srm/v2/server\?SFN=/srmcache/star/osg.test.data
      * get
         * srm-copy srm://osp4.lbl.gov:62443/srm/v2/server\?SFN=/srmcache/star/osg.test.data file:////tmp/osg.data
      * rm
         * srm-rm srm://osp4.lbl.gov:62443/srm/v2/server\?SFN=/srmcache/star/osg.test.data
      * mkdir
         * srm-mkdir srm://osp4.lbl.gov:62443/srm/v2/server\?SFN=/srmcache/star/osg.test.dir
      * rmdir
         * srm-rmdir srm://osp4.lbl.gov:62443/srm/v2/server\?SFN=/srmcache/star/osg.test.dir

---++ Space Usage in !BeStMan
---+++ Iintroduction
   * Generally there are two ways of using spaces in !BeStMan
      * Automatic space allocation and garbage collection: when a user "put"s files into !BeStMan managed cache, a certain amount of space is allocated for the operation. When the files are "not in use" any more, the allocated space is claimed for other files.
      * Dynamic space reservation: Users are allowed to reserve a certain amount of space with the designated quality of service when !BeStMan is configured in such a way, as long as space is available. This can be considered as a case for opportunistic storage space usage, and explained in more details in the following section.

---+++ Space Reservation in !BeStMan

   * As SRM v2.2 specification provides [[http://sdm.lbl.gov/srm-wg/doc/SRM.v2.2.html#_Toc163229731][space reservation]], !BeStMan supports space reservation by individual users in its online managed cache space, through !srmReserveSpace interface. Users can call command line client, srm-sp-reserve with desired space size inputs. 
      * Each space reservation returns a space token when successful, and the space token can be used in "put", "get", "bring online", or "copy" operations. 
      * Space will be reserved in replica quality space area by default unless requested otherwise, and all replica quality spaces will have associated space lifetimes. 
      * Files in the reserved space will not have file lifetimes greater than the space lifetime.
      * The total space size and the guaranteed space size through space reservation are the same in !BeStMan.
   * !BeStMan configuration entries in bestman/conf/bestman.rc
      * !PublicTokenMaxMBPerUser: Max space allocation size when automatic space allocation is done for a user when space is not reserved beforehand.
      * !DefaultMBPerToken: Default space reservation size when !srmReserveSpace is requested without specific size
   * It is possible for individuals that belong to particular VOs and Roles to allow using a specific disk or mss space through an additional configuration.

---+++ Sample client runs for space usage in !BeStMan and other SRMs
   * Similar commands will work with other SRM implementations. Just change the SRM service endpoint. e.g. dCache on srm://fapl033.fnal.gov:8442/srm/managerv2
      * space reservation
         * srm-sp-reserve -serviceurl srm://osp4.lbl.gov:62443/srm/v2/server -size 1000 -gsize 900 -lifetime 900
      * space update
         * srm-sp-update -serviceurl srm://osp4.lbl.gov:62443/srm/v2/server -size 5000 -gsize 4000 -lifetime 300 -spacetoken V.10
      * space tokens retrieval
         * srm-sp-tokens -serviceurl srm://osp4.lbl.gov:62443/srm/v2/server
      * space information retrieval
         * srm-sp-info -serviceurl srm://osp4.lbl.gov:62443/srm/v2/server -spacetoken V.10
      * put operation with the reserved space
         * srm-copy file:////tmp/test.data srm://osp4.lbl.gov:62443/srm/v2/server\?SFN=/srmcache/star/osg.test2.data -spacetoken V.10
      * purge an SURL in the reserved space
         * srm-sp-purge -serviceurl srm://osp4.lbl.gov:62443/srm/v2/server -s "srm://osp4.lbl.gov:8443/srm/v2/server?SFN=/srmcache/star/osg.test2.data" -spacetoken V.10 
      * space release
         * srm-sp-release -serviceurl srm://osp4.lbl.gov:62443/srm/v2/server -spacetoken V.10

---+++ 

---++ More Information

In order to learn more about [[http://datagrid.lbl.gov/bestman][BeStMan]], please visit the [[http://datagrid.lbl.gov/bestman][BeStMan official website]].

---++ References

   * [[Storage.BeStMan][OSG BeStMan page]] (deprecated)
   * [[Integration.ITB092.BestmanGateway][OSG BeStMan Gateway Mode page]]
   * [[Integration.ITB092.BestmanGatewayXrootd][OSG BeStMan Gateway and Xrootd page]]
   * [[Integration.ITB092.BestmanOnCE][OSG BeStMan Gateway on CE page]]
   * [[Integration.ITB092.GratiaTransferProbe][OSG Gratia Transfer Probe page]]
   * [[http://datagrid.lbl.gov/bestman][BeStMan website at LBNL]] - [[http://datagrid.lbl.gov/bestman/docs/bestman-guide.html][BeStMan User guides]], [[http://datagrid.lbl.gov/bestman/docs/bestman-faq.html][BeStMan FAQ]] and latest downloadable tar files available here. Latest downloadables should be the same version as in VDT.
   * [[Trash.StorageSRMv2Client][SRM v2.2 LBNL client command line examples]]
   * [[Storage.SRMTester][SRM-Tester]]
   * [[http://hep-t3.physics.umd.edu/HowToForAdmins.html#osginstall][UMD !BeStMan Admin Instruction]] - UMD experience on how to admin !BeStMan
   * [[http://t2.unl.edu/documentation/hadoop/bestman-hdfs][UNL !BeStMan Instruction]]
   * [[http://wt2.slac.stanford.edu/xrootdfs/bestman-gateway.html][SLAC !BeStMan Gateway mode Instruction]] - SLAC guide on !BeStMan gateway mode
   * [[http://www.usatlas.bnl.gov/twiki/bin/view/Admins/BestMan][US ATLAS !BeStMan instruction page]]
   * [[http://datagrid.lbl.gov/osg][OSG SRM Daily Testing Results]] - OSG provides SRM v2.2 daily testing. Site registration is needed [[http://datagrid.lbl.gov/sitereg][HERE]]
   * [[http://sdm.lbl.gov/srm-wg][SRM specifications and collaboration]] - from SRM collaboration working group
   * [[http://s-2.sourceforge.net/][S2]] - A SRM v2.2 test suite from CERN. It provides basic functionality tests based on use cases, and cross-copy tests, as part of the certification process and supports file access/transfer protocols: rfio, dcap, gsidcap, gsiftp

---++ Support
   * osg-storage@opensciencegrid.org
   * srm@lbl.gov

---+++ 

%STOPINCLUDE% 
%BR% 
%COMPLETE2% %BR% 
%RESPONSIBLE% Main.AlexSim - 16 March 2009 %BR% 
%REVIEW% Main.RobGardner - 23 May 2008 %BR% 