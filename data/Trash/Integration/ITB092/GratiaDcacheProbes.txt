%META:TOPICINFO{author="TanyaLevshina" date="1239739149" format="1.1" version="1.3"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! *<nop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%

%STARTINCLUDE%
%BR%

<hmtl> <img src="https://twiki.grid.iu.edu/twiki/pub/Integration/ITB092/WebHome/images.jpg"/></hml>
---+ _%INCLUDEHEADING%  %SPACEOUT{ "%TOPIC%" }%_

The probes report storage related information to the central Gratia collector. There are two types of probes:
    * The transfer probe reports to Gratia the details of each file transfer into or out of a dCache file server. 
    * The storage probe is responsible for reporting storage capacity and storage usage to the central Gratia repository. The information reported is:
       * The storage capacity and amount used for each dCache pool.
       * The storage capacity and amount used for each SRM Space reservation.

%EDITTHIS%
%BR%

---++  Gratia dCache Probes Installation
 
In order to install the latest release of Gratia dCache Probes you may do the following:
   * Install and configure them when installing vdt-dCache (fresh install) 
   * Upgrade existing vdt-dCache installation (full upgrade)
   * Upgrade just gratia dCache probes without upgrading vdt-dCache (partial upgrade)
   * Install gratia dCache probes on top of dCache installed from [[http://www.dcache.org][dCache site]] (installation without vdt-dcache)

---+++  Installation of Gratia dCache probes with vdt-dCache installation (fresh install)

During vdt-dCache installation you will be first running [[http://vdt.cs.wisc.edu/extras//2.3.0/InstallingDcacheForOSG.README.html][configuration script]. At some point  you will be asked if you wish to install gratia probes:
<pre class="screen">
Do you wish to use gratia probes? [y or n]:
</pre>

If you answered __y__ the following questions will be asked:
<pre class="screen">
Enter the name of the host running your local gratia repository [eg. gratia-fermi.fnal.gov:8881]: 
Enter the name of your Storage Element []:                  
Enter the name of the grid to which this SE belongs to [OSG-ITB or OSG or LOCAL ]:                    
Enter the port used for dCache Admin interface [22223]:                      
Enter the login name for dCache Admin interface [admin]:                       
Enter the name of the mail server that should be used to send emails [smtp.fnal.gov]:         
Enter the sender's name under which you would like the emails to be sent [dCacheProbe]:                   
Enter the comma separated list of email addresses to which you would like to send email or enter N if you do not want email to be sent []:  
</pre>

Your answers depend on the type of your site. In case this is a production OSG site you have to specify the following answers:
 _host running your local gratia repository_ - gratia-osg-transfer.opensciencegrid.org:8881

 _name of the grid to which this SE belongs to_ - OSG

in case if your site is a part of ITB please provide the following answers:
_host running your local gratia repository_ - gratia-osg-itb.opensciencegrid.org

_name of the grid to which this SE belongs to_ - OSG_ITB

When you proceed with vdt-dcache the installation script will unpack the gratia probes on admin and srm door nodes and will modify the configuration files.
The following rpms will be installed:
   * gratia-probe-common-&lt;version&gt;.noarch.rpm
   * gratia-probe-dCache-storage-itb-&lt;version&gt;.noarch.rpm
   * gratia-probe-dCache-transfer-itb-&lt;version&gt;.noarch.rpm
   * gratia-probe-extra-libs-&lt;version&gt;.noarch.rpm
   * gratia-probe-extra-libs-arch-spec-&lt;version&gt;.&lt;arch&gt;.rpm

The gratia executables, configuration and log files will be placed under _/opt/d-cache/gratia_. The configration file is called _ProbeConfig_.
Please follow first to [[Improving dCache transfer probe performance)]] then look at [[Create osg-user-vo-map]] to create OSG user-VO mapping and at [[Start/Stop gratia dCache probes]] to start/stop the service.

---+++  Upgrade existing vdt-dCache installation (full upgrade)

If you already installed vdt-dcache and are in the process of upgrading it you should follow instructions provided in [[http://vdt.cs.wisc.edu/extras//2.3.0/UpgradeDcacheForOSG.html][Upgrade Procedure Document]]. 

If you didn't enable gratia dCache probe last time you have installed dCache, please follow instruction provided in [[][Enable dCache Probe section]].
Please then follow  to [[Improving dCache transfer probe performance)]] then look at [[Create osg-user-vo-map]] to create OSG user-VO mapping and at [[Start/Stop gratia dCache probes]] to start/stop the service.

---+++  Upgrade gratia dCache probes without upgrading vdt-dCache (partial upgrade)
If you already installed vdt-dcache and just want to upgrade Gratia  dCache probes you have to do the following steps on admin and srm door nodes :
   1. download the new release (Check the right architecture, OS and postgres version):
<pre class="screen">
cd /usr/local/vdt-dcache-SL&lt;OS&gt;_&lt;ARCH&gt;-2.2.8/RPMS
wget http://vdt.cs.wisc.edu/software/dcache/gratia/1.02.1-5_post_&lt;POSTGRES_VERSION&gt;/gratia-probe-dcache-1.02.1-5.sl&lt;OS&gt;_&lt;ARCH&gt;_postgres_&lt;POSTGRES_VERSION&gt;.tar.gz
</pre>
  where sl&lt;OS&gt; could be sl4 or sl5,  &lt;ARCH&gt; should be replaced with "32" or "64", and &lt;POSTGRES_VERSION&gt; could be 8.1.4, 8.3.5 or 8.3.7, e.g: 
<pre class="screen">
wget http://vdt.cs.wisc.edu/software/dcache/gratia/1.02.1-5_post_8.3.5/gratia-probe-dcache-1.02.1-5.sl4_32_postgres_8.3.5.tar.gz
</pre>
   1. Untar file:
<pre class="screen">
tar xvfz gratia-probe-dcache-1.02.1-5.sl&lt;OS&gt;_&lt;ARCH&gt;_postgres_&lt;POSTGRES_VERSION&gt;tar.gz
</pre>

   1. Upgrade rpms:
<pre class="screen">
rpm -Uvh gratia-probe-dCache-transfer-itb-1.02.1-5.noarch.rpm
rpm -Uvh  gratia-probe-dCache-storage-itb-1.02.1-5.noarch.rpm
rpm -Uvh  gratia-probe-common-1.02.1-5.noarch.rpm
rpm -Uvh  gratia-probe-extra-libs-1.02.1-5.noarch.rpm
rpm -Uvh  gratia-probe-extra-libs-arch-spec-1.02.1-5.i386.rpm
#or
rpm -Uvh  gratia-probe-extra-libs-arch-spec-1.02.1-5.x86_64.rpm
</pre>

If you didn't enable gratia dCache probe last time you have installed dCache, please follow instruction provided in [[][Enable dCache Probe section]].
Please then follow  to [[Improving dCache transfer probe performance)]] then look at [[Create osg-user-vo-map]] to create OSG user-VO mapping and at [[Start/Stop gratia dCache probes]] to start/stop the service.

---+++ Installing Gratia dCache probes without vdt-dcache
If want to install Gratia  dCache probes on top of "native" dCache installation you have to do the following steps on admin and srm door nodes:
   1. download the new release (Check the right architecture, OS and postgres version):
<pre class="screen">
cd /tmp
wget http://vdt.cs.wisc.edu/software/dcache/gratia/1.02.1-5_post_&lt;POSTGRES_VERSION&gt;/gratia-probe-dcache-1.02.1-5.sl&lt;OS&gt;_&lt;ARCH&gt;_postgres_&lt;POSTGRES_VERSION&gt;.tar.gz
</pre>
  where sl&lt;OS&gt; could be sl4 or sl5,  &lt;ARCH&gt; should be replaced with "32" or "64", and &lt;POSTGRES_VERSION&gt; could be 8.1.4, 8.3.5 or 8.3.7, e.g: 
<pre class="screen">
wget http://vdt.cs.wisc.edu/software/dcache/gratia/1.02.1-5_post_8.3.5/gratia-probe-dcache-1.02.1-5.sl4_32_postgres_8.3.5.tar.gz
</pre>
   1. Untar file:
<pre class="screen">
tar xvfz gratia-probe-dcache-1.02.1-5.sl&lt;OS&gt;_&lt;ARCH&gt;_postgres_&lt;POSTGRES_VERSION&gt;tar.gz
</pre>

   1. Install rpms:
<pre class="screen">
rpm -i gratia-probe-dCache-transfer-itb-1.02.1-5.noarch.rpm
rpm -i  gratia-probe-dCache-storage-itb-1.02.1-5.noarch.rpm
rpm -i  gratia-probe-common-1.02.1-5.noarch.rpm
rpm -i  gratia-probe-extra-libs-1.02.1-5.noarch.rpm
rpm -i  gratia-probe-extra-libs-arch-spec-1.02.1-5.i386.rpm
#or
rpm -i  gratia-probe-extra-libs-arch-spec-1.02.1-5.x86_64.rpm
</pre>

To enable gratia dCache probe last time you have installed dCache, please follow instruction provided in [[][Enable dCache Probe section]].
Please then follow  to [[Improving dCache transfer probe performance)]] then look at [[Create osg-user-vo-map]] to create OSG user-VO mapping and at [[Start/Stop gratia dCache probes]] to start/stop the service.


---++Enable Gratia dCache Probes

If you are not using vdt-dcache instal.sh script you will have to modify Gratia dCache probes configuration files manually. In order to do so, you have to login on admin and srm door node and modify _ProbeConfig_ file.
On dCache admin node do the following:
<pre class="screen">
cd /opt/d-cache/gratia/probe/dCache-transfer/
edit ProbeConfig     #modify the fields:
SSLRegistrationService="&lt;GRATIA_COLLECTOR&gt;:&lt;COLLECTOR_PORT&gt;"
SiteName="&lt;SITE_NAME&gt;"
Grid="&lt;GRID_TYPE&gt;" 
OnlySendInterSiteTransfers="false"
EnableProbe="1"
DBHostName="localhost"
DBLoginName="&lt;DB_LOGIN&gt;"
DBPassword="&lt;DB_PASSWORD&gt"
DCacheServerHost="&lt;DCACHE_ADMIN_NODE&gt;"
EmailServerHost="smtp.&lt;DOMAIN&gt;"
EmailFromAddress="dCacheProbe"
EmailToList="&lt;email1@domain,email2@domain"
</pre>

Where



On dCache srm door  node do the following:
<pre class="screen">
cd /opt/d-cache/gratia/probe/dCache-storage/
edit ProbeConfig     #modify the fields:
SSLRegistrationService="&lt;GRATIA_COLLECTOR&gt;:&lt;COLLECTOR_PORT&gt;"
SiteName="&lt;SITE_NAME&gt;"
Grid="&lt;GRID_TYPE&gt;" 
OnlySendInterSiteTransfers="false"
EnableProbe="1"
DBHostName="localhost"
DBLoginName="&lt;DB_LOGIN&gt;"
DBPassword="&lt;DB_PASSWORD&gt"
DCacheServerHost="&lt;DCACHE_ADMIN_NODE&gt;"
AdminSvrPort="&lt;ADMIN&gt;"
AdminSvrLogin="&lt;ADMIN_LOGIN&gt;"
AdminSvrPassword="&lt;ADMIN_PASSWORD&gt;"
</pre>

Where

---++ Setting index on dCache billing database

If you already set index on your billing database skip this section. Index shoud be set on the datestamp and transaction fields, otherwise the probe will put significant load on your DB! 

In order to set index you have to log in to the billing DB using the following command:
<pre class="screen">
psql -U postgres billing
\d doorinfo
\d billinginfo
# If you don't see an index, execute the following commands:

create unique index transaction on doorinfo(transaction);
create index dates_di on doorinfo(datestamp);
create index initiator on billinginfo(initiator);
create index dates on billinginfo(datestamp);
</pre>
 
The above commands may take awhile before they finish, especially if your billing database is large.

---++ Creating  OSG User-VO Mapping 

---++  Creating osg-user-vo-map

Please read  [[https://twiki.grid.iu.edu/bin/view/Integration/ITB092/OsgSupportedVos][this page]] about files that are required to accurately collect grid resource usage and metrics by VO for transfer submitted using grid proxies or where voms proxy information is not available. 

---+++ Using GUMS based authorization mode
In order to enable generation of osg-user-vo-map from GUMS  do the following:
<pre class="screen">
cd &lt;VDT_LOCATION&gt;
. setup.sh
vdt-control -enable gums-host-cron
vdt-control -on gums-host-cron
touch $VDT_LOCATION/monitoring/osg-attributes.conf
$VDT_LOCATION/gums/scripts/gums-host-cron
</pre>

---+++ Using Gridmap based authorization mode

In order to enable generation of gridmap-file and  osg-user-vo-map by using the edg-mkgridmap cron process to get information form VOMS servers do the following:
<pre class="screen">
cd &lt;VDT_LOCATION&gt;
. setup.sh
vdt-control -enable edg-mkgridmap
vdt-control -on edg-mkgridmap
$VDT_LOCATION/edg/sbin/edg-mkgridmap 
</pre>


# Copy osg-user-vo-map.txt from your CE to this machine; in ProbeConfig, point the UserVOMapFile attribute to the map file.

    * The UserVOMapFile attribute isn't present by default in the ProbeConfig; you'll have to add it yourself.
    * If the user-vo-map changes often, we recommend you automatically update this copy of the file.
    * This page covers the gums-client installation and configuration -- if you skip the Hadoop / GridFTP probe portions. This would automatically update the file for you.
    * Some sites don't use the same usernames for the SE and the CE! In this case, your SE admins will need to write a script which generates this file dynamically
          o In this case, Gratia does in fact use the strange VOI/VOc "comment" lines at the beginning of the file. Write gratia-operations an email if you don't understand how to fill this information in correctly.
          o In fact, you don't have to keep the "osg-user-vo-map.txt" name - you can name it anything you want as long as the UserVOMapFile points to it.
---++ Starting/Stopping Gratia dCache Probes
	- gratia transfer probe will need to be started  by
          running "service gratia-dcache-transfer start" on admin node
        - gratia storage probe is a cronjob that is run by default
          every hour. The cron file gratia-probe-dcache-storage.cron 
          is located in /etc/cron.d
 
---++ Validation
---++ Known issues

---++ More information


%STOPINCLUDE%
%BR%
%COMPLETE1% %BR%
%RESPONSIBLE% Main.TanyaLevshina - 13 Apr 2009 %BR%
%REVIEW%