%META:TOPICINFO{author="KyleGross" date="1329927410" format="1.1" version="1.14"}%
<!-- This is the default OSG Integration template. 
Please modify it in the sections indicated to create your topic!
If you have any comments/complaints about this template, then please email me:
rwg@hep.uchicago.edu.  (Adapted from Atlas wiki template, Ed Moyse)
--> 

<!-- By default the title is the WikiWord used to create this topic !-->
<!-- if you want to modify it to something more meaningful, just replace %TOPIC% below with i.e "My Topic"!-->

---+!!<nop>GUMS Troubleshooting Guide
%TOC%
%STARTINCLUDE%


---++Introduction
This document is intended to provide some assistance in troubleshooting  problems which may or may be related to GUMS.


---++Log files
When in doubt, this is the best place to find the problems in GUMS.

---+++VDT_LOCATION/gums/var/log
These logs cover the activities associated with the <b>gums</b> and <b>gums-host</b> processes.
   * gums-developer.[USER].log
   * gums-edg-security.[USER.log
   * gums-privilege.[USER]..log

Their location and information levels are controlled by the <b>VDT_LOCATION/gums/log4j.properties</b> file.

---+++VDT_LOCATION/tomcat/v5/logs
These logs cover those activites using web services/ui.
   * gums-service-admin.log
   * gums-service-cybersecurity.log
   * gums-service-edg-security.log
   * gums-service-privilege.log

Their location and information levels are controlled by the <b>VDT_LOCATION/gums-service/var/war/WEB-INF/classes/log4j.properties</b> file.

---+++VDT_LOCATION/apache/logs
If  it does not look  like a request is getting through to GUMS, then the Apache log files are next.

---++Authorization Denied
This occurs if you have not added yourself to the <b>admins</b> group in GUMS and, generally you will see the following message:
     <verbatim>
     GUMS encountered an error
     Error Type: gov.bnl.gums.admin.AuthorizationDeniedException
     Error Message: Authorization denied
     </verbatim>   

A couple of things to look for:
   * If you encounter this in your browser, verify you are using the correct certificate.
   * From command line, verfiy you have a valid proxy (grid or voms) and it is for for the DN of the <b>admins</b>.
   * If you have access to the GUMS database in !MySql, execute the following query and verify that your
       certificate belongs to the 'admins' userGroup.  This is the admin authorization it is looking for.
  <dd>select userDN from User where userGroup = 'admins'; </dd>

See the "[[GumsAdmins#Create_a_GUMS_administrator][Creating a GUMS adminstrator]]"  instructions if necessary.

---++GUMS is misconfigured
This error message can appear iin the following log files:
<DD>gums-service-privilege.log</DD>
<DD>gums-service-admin.log</DD>

This error condition in GUMS will result in the PRIMA authorization service returning an <b>INDETERMINATE</b> decision response back to the CE gatekeeper  PRIMA callout and fail to authorized the user.

Some of the reasons for the message may not be caused by the gums.config file itself:
   * Before checking the actual <b>gums.config</b> file for errors (which is not easy), first verify that  you don't have multiple 
       instances of tomcat running.  This has been known to happen.
       <DD> ps -efwww |grep tomcat |grep v5 | egrep -v grep</DD>
   Some version of Linux show all threads, some do not.  So verify that only one Tomcat V5 process has the  <b>init (PID 1)</b> 
   for a parent.

   * Check the <b>gums-service-admin.log</b> for what looks like duplicate message followed by the error message:
       <DD>29 Jun 2005 12:57:45,806 [INFO ]: Starting automatic updateGroups</DD>
       <DD>29 Jun 2005 12:57:45,806 [INFO ]: Starting automatic updateGroups</DD>
       <DD>29 Jun 2005 12:57:45,807 [ERROR]: Automatic updateGroups failed -<DD>
        <DD>GUMS is misconfigured: please check the resource admin log for errors, and the gums.config file.</DD><p>
   We have not figured out how this happens (or even the actual reason), but if the times are identical (or very close), it seems like GUMS is starting more than one thread for the update process.  One fails with the error condition.  I have seen as many as 5 of these starting at the same time.<p>
    <b>Resolution:</b> Kill all the tomcat process/threads off using: first, the /etc/init.d/tomcat-5 script and , if not successful, kill the processes/threads manually.  Then restart tomcat-5 and check the log file on startup.


   * Verify that <b>gums.config</b> is, in fact, syntactically correct.   Then check the [[GUMSTroubleshootingGuide#gums_config][TOC for gums.config on this page]] for additional guidance.



---++Error Message: Some groups weren't updated correctly
This message occurs when attempting to update GUMS from the various VOMS servers specified in the <b>gums.config</b> configuration file's <b>groupMapping</b> element.  This exception can occur:
<UL><LI>when using the "Update Members" option on the web ui (<b>//https:your_gums_server:8443/gums</b>)
          <LI>or in an internal GUMS thread that functions like a cron process which exercises the "Update Members" functionality on
                   a periodic basis defined by the <B>env-entry-value</B> tag (for the "updateGroupsMinutes" env-entry-name tag) 
                   normally found at the end of the 
                    <B>$VDT_LOCATION/gums-service/var/war/WEB-INF/web.xml</b> file.
</UL>

The full message text may include the java !RuntimeException: 
  <pre>
    Error Type: java.lang.RuntimeException

    Error Message: Some groups weren't updated correctly: consult the logs for 
    more details. Check GUMS configuration or the status of the VO servers.
</pre>


The key here is to <b>...consult the logs for more details...</b> as the message states.  The [[#VDT_LOCATION_tomcat_v5_logs][tomcat v5 gums log files]] will contain the additional information as to which VOMS server  is not accessible and may give a clue as to what the problem is.  The  ==gums-service-admin.log==  is many times the most useful.

<b>Note:</b> Before going into the <b>gums.config</b> file for errors, check the <b>gums-service-admin.log</b>  for the following 'memory' problem. This ( ==java.lang.OutOfMemoryError== ) may appear in the log
file without an full stacktrace and is sometimes difficult to find.  If found, restart <b>tomcat</b>. Then, perform a manually
initiated update using the Web UI.
 



The elements/attributes in the <b>gums.config</b>  affecting the GUMS update process are attributes of the <b>groupMapping/userGroup</b> element:
<OL><li>url  (just plain bad)
             <UL>
              <LI>In the log files, you may see a java !UnknownHostException .
              <LI>Put the "url" attribute value in your browser, preferably, one running on your gums server especially if running behind a
                                 firewall.  You can use your personal certificate in fyour first attempt just to verify the address.
                       <br>- If you get a "404 NOT FOUND", it may be something wrong in the address or you may have just been unlucky
                                             at this moment and that particular VOMS server is offline for the moment.
                        <br>-  If you get a  "VOMSAdmin    Hi there, this is an AXIS service!", then the address is good.
               </UL>
          <li>voGroup / voRole<br>
                The group/subgroup or role may not exist for that VOMS server.
          <li>sslCertfile / sslKey 
                <br>- the certificate file do not exist,  wrong permissions, wrong ownership, expired?  Messages/exceptions in the 
                           log files will provided more  information.
                 <br>- remember that this is what identifies your GUMS server.
                  <br>- The VOMS servers can be setup to allow read only access to anyone who presents a valid certificate or can be setup 
                                   to only allow read access to specific certificates.  If you are being denied access and your certificate is valid, you will
                                   need to contact the individual VOMS admins and request your gums http certificate be added with read privileges.
</OL>



---++Exception: The trusted certificate authority certificates reading failed
<verbatim>
   java.lang.Exception: The trusted certificate authority certificates
   reading failed:  java.io.IOException: No CA files found matching
   "/etc/grid-security/certificates/*.0
</verbatim>

During the OSG GUMS installation process you may have chosen "local" when asked where to install the certificate authorities.  This puts them in <b>$VDT_LOCATION/globus/share/certificates</b> instead of 
<b>/etc/grid-security/certificates</b> which is where GUMS is looking for them.

<b>Resulution:</b> Move them to /etc/grid-securities/certificates.<br>
You may be considering just putting a soft link to them from the /etc area, but this may not be advisable
siince the revocation lists need to be kept up-to-date and the <b>edg-crl-upgrade</b> daemon may not be able to update through the soft link.  This is an unknown as of 7/6/05.  (If someone knows the answer then 
the soft/symbolic link is an option and this can be changed).

An additional possibility is that there is a permission's problem on the directory so that GUMS cannot
read the certificates.
<br>.-- Main.JohnWeigand - 07 Jul 2005







---++gums-service-privilege.log: INDETERMINATE decision
When the PRIMA authorization service cannot make a determination whether to authenticate a user request, it will return a decision of <b>Indeterminate</b>  to the gatekeeper callout.  The <b>Indeterminate</b> response has the same effect as a <b>Deny</b> authorization response.  The only difference is that the authorization service did not have sufficient information to perform the request.

A couple of things to look for:  (well not a couple yet, just one)
   * A misconfigured <b>gums.config</b> file can result in an <b>Indeterminate</b> ressponse since, without the configuration file, GUMS does not have suffiicient information about the authorization policy.  If this is the problem, see the TOC entry for [[GUMSTroubleshootingGuide#GUMS_is_misconfigured][GUMS is misconfigured]] in this section.


---++GUMS client
---+++pool-addRange
Main.JohnWeigand - 07 Jun 2005<br>
<b>Command:</b><br>
 ./gums/bin/gums pool-addRange mysql uscmsPool uscms01-09<br>
An error accoured when connecting to GUMS: (0)null

<b>VDT_LOCATION/apache/logs:</b><br>
[Tue Jun 07 15:02:45 2005] [error] Certificate Verification: Error (20): unable to get local issuer certificate

<b>Resolution:</b><br>
Not resolved for certain as of 6/7 15:30.  Believe vdt 1.3.6 will resolve this.


---++gums.config
When modifying the <b>gums.config</b>,  it is best to validate the changes by executing the GUMS UI in your 
browser:
   * Select 'Update Members'
   * Then select  'Update Members VO Database'

If an error is encountered, the first thing to check is:
   *  Since the gums.config file is in an xml format, the first thing to verify is that every element has a close tag.
   * Check the log files for recent changes.  Sometimes the errors shown in there are more descriptive.

If still not resolved, here is an additional  list of things to look for:
<ol>
<li>Verify the <b>sslCertfile</b> and <b>sslKey</b> attributes of  the <b>userGroup</b> element  are
        pointing to the 'http' certificate. 
      <ul><li>Standard location would be <b>/etc/grid-security/http</b>.
              <li>Verfiy  permissions and ownership:  owner(daemon) permissions(644 and 600 respectively)
               <li>Verify they are the same for all <b>userGroup</b> elements.
      </ul>
<li>Verify that each <b>name</b> attribute of the <b>groupMapping</b> element is included  in a <b>hostGroup</b>
element's <b>groups</b> attribute.  They all have be accounted for.
<li>GUMS 1.0 syntax:  If you are using the <b>cn</b> attribute of  the <b>hostGroup</b> element,   verify that the CE node that is having a problem is correctly identified for the <b>groups</b> specified.  If your  GUMS server is providing authorization services for mulitple CE nodes, double check the <i>subject</i> of the host certificate you are having problems with.  For example, if some hosts have a host certificate <i>subject</i> that contains something like "host/fermigrid1.fnal.gov" and some contain just "quux.fnal.gov", then the attribute should look like <b><i>cn='*.fnal.gov,host/*.fnal.gov'<</i></b>.
</ol>

<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->

*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.JohnWeigand - 03 Jun 2005<br>
-- Main.JohnWeigand - 23 Jun 2005 - added Authorizaztion Denied TOC<br>
-- Main.JohnWeigand - 29 Jun 2005 - added GUMS is misconfigured and the INDETERMINATE TOC entries<br>
-- Main.JohnWeigand - 06 Jul 2005  - added  Error Message: Some groups weren't updated correctly TOC entry<br>
-- Main.JohnWeigand - 19 Jul 2005 -  added 'outof Memory' problem in "Some groups....."<br>

%STOPINCLUDE%

