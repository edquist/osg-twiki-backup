%META:TOPICINFO{author="KyleGross" date="1225985939" format="1.1" version="1.6"}%
%META:TOPICPARENT{name="CEInstallGuide050"}%
<!-- This is the default OSG Integration template. 
Please modify it in the sections indicated to create your topic!
If you have any comments/complaints about this template, then please email me:
rwg@hep.uchicago.edu.  (Adapted from Atlas wiki template, Ed Moyse)
--> 

<!-- By default the title is the WikiWord used to create this topic !-->
<!-- if you want to modify it to something more meaningful, just replace %TOPIC% below with i.e "My Topic"!-->

---+!!<nop>CEMon Installation / Activation
%TOC%
%STARTINCLUDE%
---+++CEmon
<div class="twikiSmall" style="text-align: left; font-style: italic;"><a href="%SCRIPTURLPATH%/edit%SCRIPTSUFFIX%/%WEB%/%TOPIC%?t=%SERVERTIME{ "$epoch" }%">Edit this section</a></div>

The [[http://grid.pd.infn.it/cemon/field.php][CEMon]] (CEMonitor) service is responsible for providing information coming from the Computing Element (CE) and is being implemented as an optional component in the OSG Compute Element (CE) architecture in support of the [[ResourceSelection.WebHome][ReSS (Resource Selection Service) OSG project]].  This service is capable of collecting the CE resource information by using [[http://lfield.home.cern.ch/lfield/cgi-bin/wiki.cgi?area=gip&page=documentation][Generic Information Provider]] (GIP). GIP works with the Condor, PBS, LSF and SGE job managers. A properly installed and configured CEMonitor service pushes collected information in classad format to a central [[ResourceSelection.WebHome][Information Gatherer]] (IG) running on designated host (<i>osg-ress-1.fnal.gov</i>). IG advertises these classads to the [[http://www.cs.wisc.edu/condor][Condor Match Maker]] service.

---++++CEMon configuration files
The configuration of <i>CEMon</i> is done for you in the <i>configure_cemon</i> script which is automatically run as a part of the OSG 0.5.1 installation process.  This section is intended to highlight the key configuration files and changes made by that script.

---+++++cemonitor-config.xml
Located in the <i>$VDT_LOCATION/glite/etc/glite-ce-monitor</i> directory, this configuration file defines
<UL>
<LI> the script used to collect the CE node data and the frequency at which it is run
<LI> the URL of the <nop>ReSS server and the frequency the data is published
</UL>
<pre>
&lt; service id="main-service"
      :
         sslkeyfile="/etc/grid-security/http/httpkey.pem"        
         sslcertfile="/etc/grid-security/http/httpcert.pem"
            <i><b>(your HTTP certificates)</b></i>
      :
         sslCAfiles="/storage/local/data1/osg-ce/globus/TRUSTED_CA/*.0"   
             <i><b>(your TRUSTED_CA directory)</b></i>
&gt;
     :
  &lt;sensor id="sensor-osg-ce"
          name="OSG CE Sensor"
          type="OSG_CE"
     :
     &lt;property name="executionDelay" value="300000" /&gt;
            <b><i>(frequency in millseconds the information gathered by the script below)</i></b>
    &lt;property name="scriptURI" value="/storage/local/data1/osg-ce/glite/etc/glite-ce-ce-plugin/glite-ce-info" /&gt;
            <b><i>(this is the script that gathers the information about the CE node)</i></b>
     :

&lt;/service&gt;
     :
&lt;subscription 
         id="subscription-https___osg-ress-1_fnal_gov_8443_ig_services_CEInfoCollector-OSG_CE-OLD_CLASSAD"
         monitorConsumerURL="https://osg-ress-1.fnal.gov:8443/ig/services/CEInfoCollector"
            <b><i>(the URL of the ReSS server)</i></b>
     :
      &lt;topic name="OSG_CE"&gt;
         &lt;dialect name="OLD_CLASSAD" /&gt;
      &lt;/topic&gt;
      &lt;policy rate="300000"&gt;          
            <b><i>(frequency in millseconds the information is pushed to the IG)</i></b>
    :
&lt;/subscription&gt;
    :
</pre>
</UL>


---++++Activating CEMon
---+++++CEMon for OSG 0.5.0
In this release, <nop>CEMon is not installed.  To install it in a pre-OSG 0.5.1 release, refer to the [[ResourceSelection.CEMonAndGIPInstallationNotes][CEMon installation instructions for OSG 0.4.1 and OSG 0.5.0]].

---+++++CEMon for OSG 0.5.1
The <nop>CEMon package is installed and configured, but not activated, with this release.  CEMon uses both <i>apache</i> and <i>tomcat-5</i>.  To activate it, you will need to (<b>as root</b>):

<OL><LI>Copy the startup scripts to <i>/etc/init.d</i>
<pre>
&gt;  cp $VDT_LOCATION/post-install/apache /etc/init.d/.  
&gt;  cp $VDT_LOCATION/post-install/tomcat-5 /etc/init.d/.  
</pre>
        <LI>Activate the services so, they will automatically start when the node is booted.
<pre>
&gt;  chkconfig --add  apache
&gt;  chkconfig  apache on 
&gt;  chkconfig --add  tomcat-5
&gt;  chkconfig  tomcat-5 on 
</pre>
        <LI>Start the services.
<pre>
&gt;  /etc/init.d/apache start
&gt;  /etc/init.d/tomcat-5 start
</pre>
</OL>

<b>Note:</b> <i>CEMon</i> requires an <i>/etc/grid-security/grid-mapfile</i> to exist.  It can be an empty file, but it must exist.   The  <i>$VDT_LOCATION/vdt/setup/configure_cemon</i> script checks for this and creates an empty one, if none exists.

---++++Verifying CEMon is functional
Check the <i>tomcat</i> <i>CEMon</i> log file, <i>$VDT_LOCATION/tomcat/v5/logs/glite-ce-monitor.log</i> for this entry:
<pre>
20 Oct 2006 13:39:58,881 org.glite.security.trustmanager.CRLFileTrustManager -
       Client CN=osg-ress-1.fnal.gov, OU=Services, DC=doegrids, DC=org accepted
</pre>
Have a little patience, however, as the publishing of the information is performed by default every 5 minutes.

Once you've started publishing to the CEMon server, you might want to verify the information.  You can do this my running:
<pre>
&gt;  condor_status \
         -pool osg-ress-1.fnal.gov \
         -constraint "GlueCEInfoHostName == \"YOUR_HOST_NAME\"" 
  <b><i>(remember to change YOUR_HOST_NAME with your fully
   qualified hostname.  In addition, the backslashes are critical
   in the constraint argument)</b></i>
</pre>
Be prepared for a lot of output if you are successful.


---++++Troubleshooting CEMon
The first thing you will want to do is verify <i>apache</i> and  <i>tomcat</i> are running.
<pre>
&gt;  ps -ef | grep apache | grep httpd   
      <b><i>Note: The head process is normally owned by root.
       The child processes' user should be the owner of  the http
       certificate.)</b></i>

&gt;  ps -ef | grep tomcat
</pre>
If <i>apache/tomcat</i> are not running, restart them and re-verify.<br>
If they are still not running after a restart, check their respective log files to a get some idea what the problem is:
<UL><LI><b>apache</b> - <i>$VDT_LOCATION/apache/logs directory
         <LI><b>tomcat</b> - </i>$VDT_LOCATION/tomcat/v5/logs/catalina.out
</UL>

Then, check the <i>CEMon</i> log file, <i>$VDT_LOCATION/tomcat/v5/logs/glite-ce-monitor.log</i> for any messages indicating a problem.
<UL>
<LI>gridMapFileNotFound exception<br>
       <b>Resolution:</b> Since <i>CEMon</i> requires a <i>grid-mapfile</i>, create and empty <i>/etc/gird-security/grid-mapfile</i>.

<LI>No files found matching /etc/grid-security/http/httpcert.pem<br>
<b>or</b> Error while reading certificates or CRLs: No files found matching /etc/grid-security/http/httpcert.pem<br>
<b>or</b> Connection refused by the Consumer (<nop>https:&lt;The_ReSS_Server&gt;)<br>
       <b>Resolution:</b> If you do not have an HTTP certificate in <i>/etc/grid-security/http/httpcert.pem(httpkey.pem)</i> file or a symlink to one from that location, you will see these  messages.   The correct ownershop is critical, as well.  The http certificates are defined in the  <i>cemonitor-config.xml</i>  and <i>ce-monitor.xml</i> files of the <i.$VDT_LOCATION/glite/etc/glite-ce-monitor</i> directory.
      
<LI>Connection refused by the Consumer<br>
         <b>Resolution:</b>Verify the URL in the message,
Using a browser that contains a valid grid certificate,  cut and paste the url shown in the message. The following should appear if CEMon is working.
<pre>
CEInfoCollector
Hi there, this is an AXIS service!
Perhaps there will be a form for invoking the service here...
</pre>
    <BR>If it does not appear correct, <i>ping</i> the hostname.  
</UL>

When all else fails, contact  the DZero support person shown in the [[http://www.grid.iu.edu/osg-includes/sc.php][VirtualOrganizations/VOInfo Support Center]].

%STOPINCLUDE%
<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->

*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.JohnWeigand - 20 Oct 2006<br>

%INCLUDE{"WhuReferences"}%