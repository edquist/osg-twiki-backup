%META:TOPICINFO{author="JohnWeigand" date="1117662255" format="1.0" version="1.13"}%
%META:TOPICPARENT{name="VoAdmins"}%
<!-- This is the default OSG Integration template. 
Please modify it in the sections indicated to create your topic!
If you have any comments/complaints about this template, then please email me:
rwg@hep.uchicago.edu.  (Adapted from Atlas wiki template, Ed Moyse)
--> 

<!-- By default the title is the WikiWord used to create this topic !-->
<!-- if you want to modify it to something more meaningful, just replace %TOPIC% below with i.e "My Topic"!-->

---+!!<nop>How to Install VOMS
%TOC%
%STARTINCLUDE%
---++Introduction
The [[http://hep-project-grid-scg.web.cern.ch/hep-project-grid-scg/voms.html VOMS]] has three main parts: a mysql database which is a persistent repository for VO membership information, the VOMS Admin piece which provides the web UI to maintain the VO membership, and the VOMS server, a daemon process which services the voms-proxy-init requests.

Here we describe how to install and configure VOMS on your linux machine. When you install VOMS as described here, you get all three parts.  It comes with a test VO called VDT. We suggest that you use it for testing. You're going to need to create your real VO with the appropriate name; instructions for doing that are also on this page.

We also describe how to remove a VO from VOMS, and how to uninstall VOMS, should the need arise.

All the sample commands are shown with Bourne shell syntax.  Substitute appropriate values as needed.

---++Prerequisites for VOMS install

	* Download and install Pacman (if not already available); see PacmanInfo. You will use pacman to install VOMS.
	* Request and install an http certificate for your system
	* Review the "Known Problems" section of the ItbRel015 page.
	* If you have an OSG VOMS running and you're about to reinstall, see the Shutdown instructions below.

---++Install VOMS
The current (4/14/2005) installation is tested working with the pre-release of VDT 1.3.5.  Please note: the edg-mkgridmap client in previous releases of VDT (1.3.2 and below) and in Grid3 is incompatible with the VDT-installed VOMS in VDT 1.3.3 and beyond.  If this is of concern to you, you will have to run both an older and a newer VOMS to retain compatibility with the older versions of edg-mkgridmap.

The installation and configuration must be done as root, so su/ssh to root. Use pacman to install VOMS.

Set the install location of the VOMS software (shown below as /data/osg-itb-015; put it wherever you like). 
<verbatim>
  VDT_LOCATION=/data/osg-itb-015
</verbatim>
Install VOMS:
<verbatim>
  cd $VDT_LOCATION 
  pacman -get http://www.cs.wisc.edu/vdt/vdt_135_cache:VOMS
</verbatim>
When done, setup your environment. To do so, run (in same directory):
<verbatim>
  source setup.sh
</verbatim>
Csh users source the <tt>setup.csh</tt> file instead. 

This installation creates a default VO called VDT and a database to go with it.  (For details on what gets created, see the section below on "Creating a new VO".)
---+++Check VOMS-Admin
After this completes, the EDG-VOMS-Admin should be running for the VDT VO; point a certificate-enabled browser window to https://your.host.name:8443/edg-voms-admin/VDT.  You won't be able to do anything with it yet since you're not added as a user, but verify that it comes up. Click "Administrate VOMS" -- you should get "Access Denied".
#AddUserAsAdmin
---+++Add a user as Admin
Add yourself or someone else as the VO-Admin for the VO VDT;
you will need the personal certificate file to do this.
Set the certfile variable to the path for the cert file (an example is shown), and run the command:
<verbatim>
	 certfile=~weigand/.globus/usercert.pem 
	 $EDG_LOCATION/sbin/edg-voms-admin-local VDT --add-admin $certfile 
</verbatim>
(No output indicates success.)
---+++Test VOMS-Admin again
You should now be able to go up in your browser and navigate through the various menus without getting an "Access Denied" message. Do not add anyone else until you test the voms-proxy-init command.

---+++Test voms-proxy-init
In order for a client voms-proxy-init to access the VO's server, you
need a configuration file available to tell it which voms server to access. The config file is found here:
<verbatim>
VO=VDT
cp $EDG_LOCATION/var/etc/edg-voms-admin/${VO}/vomses $EDG_LOCATION/etc/vomses/${VO}
</verbatim>

As yourself, get a voms proxy; shown here for VO VDT and attribute /VDT:
<verbatim>
source $VDT_LOCATION/setup.sh
voms-proxy-init --voms=VDT:/VDT
</verbatim>

Output 
<verbatim>
Your identity: /DC=org/DC=doegrids/OU=People/CN=John Weigand 458491
Enter GRID pass phrase:
Creating temporary proxy .................................................. Done
Contacting  cd-94372.dhcp.fnal.gov:15007 [/DC=org/DC=doegrids/OU=Services/CN=cd-94372.dhcp.fnal.gov] "VDT" Done
Creating proxy ........................................................... Done
Your proxy is valid until Wed May 11 04:31:06 2005
</verbatim>

End of output

Verify that you got a proxy with the attribute requested.	 
Note the 'attribute' line below specifying the group requested.
<verbatim>
voms-proxy-info --all
</verbatim>
Output
<verbatim>
error = 5025
WARNING: Unable to verify signature!
subject	: /DC=org/DC=doegrids/OU=People/CN=John Weigand 458491/CN=proxy
issuer	 : /DC=org/DC=doegrids/OU=People/CN=John Weigand 458491
identity  : /DC=org/DC=doegrids/OU=People/CN=John Weigand 458491
type		: proxy
strength  : 512 bits
path		: /tmp/x509up_u9789
timeleft  : 11:58:31
VO		  : VDT
subject	: /DC=org/DC=doegrids/OU=People/CN=John Weigand 458491
issuer	 : /DC=org/DC=doegrids/OU=Services/CN=cd-94372.dhcp.fnal.gov
attribute : /VDT/Role=NULL/Capability=NULL
timeleft  : 11:58:31
</verbatim>
End of output

Now try one for a group you do not belong to, e.g., /MyGroup
<verbatim>
voms-proxy-init --voms=VDT:/MyGroup
</verbatim>
Output -----
<verbatim>
Your identity: /DC=org/DC=doegrids/OU=People/CN=John Weigand 458491
Enter GRID pass phrase:
Creating temporary proxy .................................... Done
Contacting  cd-94372.dhcp.fnal.gov:15007 [/DC=org/DC=doegrids/OU=Services/CN=cd-94372.dhcp.fnal.gov] "VDT"
Warning: VDT: Unable to satisfy G/MyGroup Request! Error: VERR_SERVERCODE Failed.
Failed to contact servers for VDT.
</verbatim>
End of output

Note the misleading message saying you "Failed to contact servers for VDT."
This is not true.
The key to the real error is in "Warning: VDT: Unable to satisfy G/MyGroup Request!" which has your request embedded in it. 

Also note that if you do a voms-proxy-init immediately after the failure, your 
previous is proxy is still valid.

---++Create a new VO
You won't be able to use the default VO named VDT (the VO name must be unique). You'll have to create a new one (or any number of new ones).
---+++What to expect and what you need to know
When you create a new VO, many things occur. In particular, a database and several files are created, and you need to know what they're used for. CreateNewVoForVomsInfo lists and describes these things.
---+++Before creating the VO
Define the following series of environment variables representing the arguments used on the install command line.  Note: the syntax used for defining this data is in Bourne shell format.  Depending on whether you need to change the value, you may be able to just cut/paste a lot of these
		commands during the installation process.  
		
	 VO=Test	<br />	  
		The name of your VO (shown as Test).  Mixed case is permissable. 
		This will also be the top level (root) group for the VO.

	 PORT=15007	 <br />
		Port number the voms server listens on for voms-proxy-init requests.
		Each VO has a unique instance of the voms server running and listening on a port.

	 SMTP_HOST=smtp.fnal.gov	<br />
		The hostname of the SMTP delivery service at the site of this VOMS server.
		The host must accept emails for delivery.

	 MAIL_FROM=your-email-address <br />
		The sender email address for the notification messages sent by this VOMS service.
		This should be a read address otherwise the failure notifications will end up in 
		/dev/null.

	 PASSWORD=some-unique-password  <br />
		The password of this VO's voms database users mentioned above ($VO_adm, $VO_que, $VO_seq and $VO_upd).
		Please change ffomr what is shown above!

	 VOMS_GROUP=daemon <br />
		The Unix group name of the user the VOMS server runs under. 
		The default with VDT installations is 'daemon'.  

	 TOMCAT_GROUP=daemon <br />
		The Unix group name of the user that tomcat4 runs under. 
		The default with VDT installations is 'daemon'.  

	 CERTDIR=$GLOBUS_PATH/TRUSTED_CA <br />
		Not sure if this has any affect as it does not appear to be picking up
		all the CAs in this directory.  Actually, this is a link and this may
		be the problem.

You need to know your root password for the mysql database, if you have one.  If you don't, you don't need one.
If you want to set the root password:
<verbatim>
	  $VDT_LOCATION/mysql/bin/mysqladmin -u root password 'new-password'
	  $VDT_LOCATION/mysql/bin/mysqladmin -u root -h $(hostname) password 'new-password'
</verbatim>
The VDT setup script should set the EDG_LOCATION variable needed by VOMS
if it is installed there. (Check to be sure; it should be set to $VDT_LOCATION/voms.)

---+++Execute the script to create the VO

Execute the $EDG_LOCATION/edg-voms-admin-configure script with the 'install' argument and
the required set of parameters shown below (and described above). This will create a set of sql files containing the ddl and initial data for 
  the VOMS database for your VO. It will create the directories and data files for the VO. If you've set all the variables, you should be able to just cut and paste.

<verbatim> 
  $EDG_LOCATION/sbin/edg-voms-admin-configure install \
		--port			 $PORT \
		--vo				$VO \
		--voalias		 $VO \
		--mail-from	  $MAIL_FROM \
		--smtp-host	  $SMTP_HOST \
		--password		$PASSWORD  \
		--voms-group	 $VOMS_GROUP \
		--tomcat-group  $TOMCAT_GROUP \
		--certdir		 $CERTDIR
</verbatim>

Output (many values will be different for your case):
<verbatim>
WARNING: Fallback to file based DB setup.
WARNING: You must feed the database with the generated SQL files manually.

/data/osg-itb-015/voms/sbin/edg-voms-admin-configure uses the following settings:

	EDG_LOCATION		  /data/osg-itb-015/voms
	EDG_LOCATION_VAR	 /data/osg-itb-015/voms/var
	EDG_TMP				 /tmp
	VO name				 TEST1
	VO alias				TEST1
	vomsd port number	15007
	X509 certificate	 /etc/grid-security/hostcert.pem
	CA certificates	  /data/osg-itb-015/globus/TRUSTED_CA
	config userid		 0
	config group tomcat 2
	config group voms	2
	smtp host			  smtp.fnal.gov
	mail from			  root@cd-94372.dhcp.fnal.gov
	Database name		 voms_TEST1

WARNING: Please feed install-voms-1-mysql-as-root.sql to MySQL by hand.
Creating the database...
processing template 
		  /data/osg-itb-015/voms/etc/edg-voms-admin/databases/MySQL/db_create.sql to 
		  /data/osg-itb-015/voms/var/etc/edg-voms-admin/TEST1/install-voms-2-mysql-as-root.sql
WARNING: Please feed install-voms-2-mysql-as-root.sql to MySQL by hand.
WARNING: Please feed install-voms-3-mysql-as-root.sql to MySQL by hand.
...creating the roles
WARNING: Please feed install-voms-4-mysql-as-root.sql to MySQL by hand.
...inserting the initial values
...saving the settings ... processing template 
		  /data/osg-itb-015/voms/etc/edg-voms-admin/voms.database.properties.template to 
		  /data/osg-itb-015/voms/var/etc/edg-voms-admin/TEST1/voms.database.properties
Installing vomsd configuration ... 
		  /data/osg-itb-015/voms/etc/voms/TEST1/voms.pass
		  /data/osg-itb-015/voms/etc/voms/TEST1/voms.database.properties
Service properties ... processing template 
		  /data/osg-itb-015/voms/etc/edg-voms-admin/voms.service.properties.template to 
		  /data/osg-itb-015/voms/var/etc/edg-voms-admin/TEST1/voms.service.properties
context block ... processing template 
		  /data/osg-itb-015/voms/etc/edg-voms-admin/context.xml.template to 
		  /data/osg-itb-015/voms/var/etc/edg-voms-admin/TEST1/edg-voms-admin-TEST1.xml
Miscellaneous files ... Installation complete.
</verbatim>
End of output

Heed any and all WARNINGS or ERRORS except the following:
<verbatim>
	  WARNING: Fallback to file based DB setup.
	  WARNING: You must feed the database with the generated SQL files manually.
	  WARNING: Please feed install-voms-1-mysql-as-root.sql to MySQL by hand.
	  WARNING: Please feed install-voms-2-mysql-as-root.sql to MySQL by hand.
	  WARNING: Please feed install-voms-3-mysql-as-root.sql to MySQL by hand.
	  WARNING: Please feed install-voms-4-mysql-as-root.sql to MySQL by hand.
</verbatim>
These listed warnings will be processed in the next step.

The file system directories and files have been created as mentioned in the beginning.
You can view their contents:
<verbatim>
  ls -l $EDG_LOCATION/etc/voms
  ls -l $EDG_LOCATION/var/etc/edg-voms-admin
 (Ignore this last one for now) ls -l $EDG_LOCATION/etc/vomses/$VO
</verbatim>

---++ Create the VOMS database for the VO

The voms database for a VO is created in mysql as 'voms_$VO' (e.g., voms_TEST1)

To create it, we need to run the following series of commands (notice they're run as the mysql root user):
<verbatim>
  cd $EDG_LOCATION/var/etc/edg-voms-admin/$VO
  mysql -uroot < install-voms-1-mysql-as-root.sql
  mysql -uroot voms_$VO < install-voms-2-mysql-as-root.sql
  mysql -uroot voms_$VO < install-voms-3-mysql-as-root.sql
  mysql -uroot voms_$VO < install-voms-4-mysql-as-root.sql
</verbatim>
No output indicates success; any output needs to be reconciled.
If all was successful, you should have a voms database for the VO.
You can view this if you go into the mysql database.

---++Get Tomcat Up and Running

Tomcat still does not know about the VO, however. For Tomcat to know about the VO, 
the edg-voms-admin-$VO.xml file must be moved to $VDT_LOCATION/tomcat/v4/webapps. 
This xml configuration file provides the context for the VO within Tomcat.
<verbatim>
cd $EDG_LOCATION/var/etc/edg-voms-admin/$VO
cp -p edg-voms-admin-$VO.xml $VDT_LOCATION/tomcat/v4/webapps/.
</verbatim>
First stop tomcat-4 if you have it running:
<verbatim>
/etc/init.d/tomcat-4 stop
</verbatim>
output (the path shown in the output is $VDT_LOCATION/tomcat):
<verbatim>
Using CATALINA_BASE:	/data/osg-itb-015/tomcat/v4
Using CATALINA_HOME:	/data/osg-itb-015/tomcat/v4
Using CATALINA_TMPDIR: /data/osg-itb-015/tomcat/v4/temp
Using JAVA_HOME:		 /data/osg-itb-015/jdk1.4
</verbatim>

Restart tomcat-4:
<verbatim>
/etc/init.d/tomcat-4 start
</verbatim>
output(the path shown in the output is $VDT_LOCATION/tomcat):
<verbatim>
Using CATALINA_BASE:	/data/osg-itb-015/tomcat/v4
Using CATALINA_HOME:	/data/osg-itb-015/tomcat/v4
Using CATALINA_TMPDIR: /data/osg-itb-015/tomcat/v4/temp
Using JAVA_HOME:		 /data/osg-itb-015/jdk1.4
</verbatim>

---+++Bring up the VOMS-Admin Web UI
Bring up a browser with your personal certificate in it and access the VOMS UI
for your newly created VO. 
The URL is https://your.host.name:8443/edg-voms-admin/{your_VO_name}

You won't be able to do anything in it yet.  Return to the <a href="#AddUserAsAdmin">"Add a user as Admin"</a> section
to progress further.
 
The command below shows a different way to add an admin, and also should allow you to assign
a role, but is failing with a relocation error on sn ssl library in perl.
<verbatim>
	  $EDG_LOCATION/sbin/edg-voms-admin \
				 --url=http://$(hostname):8080/edg-voms-admin/${VO} \
			create-user \
				$certfile \
			assign-role \
				${VO} \
				VO-Admin \
				$certfile 
</verbatim>
---++Start the VOMS server for the VO
Make sure you're root. Run:
<verbatim>
$EDG_LOCATION/etc/init.d/voms start $VO
</verbatim>
Output (showing the VO name; yours will be different):
<verbatim>
Starting edg-voms(TEST1):											 [  OK  ]
</verbatim>
Verify the VOMS server is running:
<verbatim>
$EDG_LOCATION/etc/init.d/voms status $VO
</verbatim>
output (showing the VO name; yours will be different):
<verbatim>
Status edg-voms(Test3): (pid 7715) is running...
</verbatim>
---++Set the Global ACL for list access to each Group
(moved here from VoAdmins page, and lightly edited; needs more clarification by author. AH)

We suggest that you set the global ACL on the web UI to allow access to anyone who presents a valid certificate issued by a known CA.  The following procedure will allow any valid certificate to query the server:
	* Go to the web UI (with a browser with the certificate you use as admin)<br>
		 - https://[YOUR_VOMS_HOST]:8443/edg-voms-admin/[YOUR_VO]
	* Select <b>Administrate VOMS</b> under the <b>Adminstration</b> menu item from the left panel
	* Select <b>Global ACL</b> from the left panel
	* Press <b>Edit this ACL</b>
	* - From the <b>Allow:</b> pull down, select "<b>Allow</b>" <br>
		- From the <b>Operation</b> pull down, select "<b>list</b>".<br>
		  <b>NOTE:</b> Be sure to select "list", default is "all".	You do NOT want "all".<br>
		- From the <b>For</b> selection, select  "<b>Anyone who presents a certificate issued by a known CA</b>"<br>
		- Press "Add new entry"<br>
		- NOTE: If you already have this entry in the list of ACL's you did not need to do this.

Note that this will allow newly-added services to provide access to members of your VO without you specifically adding them to the list of machines allowed to access your list of users (I don't follow this sentence. AH).  To gain access to the member list, such a machine or service (or person) will have to present a valid grid certificate.

Warning:

  At present, there is no way to prevent the harvesting of such a list of users for a potential spoofing attack that would use such a list of users to present a false service on the grid.  To create such an exploit, someone with a valid grid certificate would have to pretend to offer a service that would imitate one that would be discovered by an automatic discovery service.  By having a list of valid users, such a theoretical imitation service could accept jobs and divert them to other purposes.  VO's that are sensitive to the possibility of such a "discovery service" attack and who do not have methods of validating the list of offered services for users should not set the Global ACL as above, and will therefore have to fall back to entering each machine or service on the grid manually that they want to allow access to their list of users.

---++ Test access to your VOMS from a gatekeeper with simple grid-mapfile
(taken from 
"Ye olde grid3 mode" -- and adapted)

Your VO maintains a secure membership
service which may be queried on a gatekeeper node with the utility
<verbatim>
$VDT_LOCATION/edg/sbin/edg-mkgridmap
</verbatim>
To create a <b>grid-mapfile</b> containing an entry for every
member of the VO (probably just yourself, at this stage), first you need to copy and start the <b>edg-gridmapfile-upgraded</b> daemon. (If the ITB is already installed, a file of this name will already be in place.)
<pre> 
	 cp $VDT_LOCATION/post-install/edg-gridmapfile-upgraded /etc/init.d/
	 /etc/init.d/edg-gridmapfile-upgraded start
</pre>

Now, su/ssh to root so that the host certificate can be used.

 The gatekeeper should test the <b>$VDT_LOCATION/edg/sbin/edg-mkgridmap</b> script to ensure
there are no connection errors to your VOMS services. First, make a short conf file with just the users known to your VO.
The default conf file is
<pre>
$VDT_LOCATION/edg/etc/edg-mkgridmap.conf
</pre>
Make yours in the same directory. It can just have one line:
<pre>
group vomss://{your voms host}:8443/edg-voms-admin/{your VO name} {account name}
</pre>
E.g.,
<pre>
group vomss://cd-94372.dhcp.fnal.gov:8443/edg-voms-admin/Test3 aheavey
</pre>
Now, run edg-mkgridmap. The --output argument specifies the grid-mapfile name (e.g., test.out); it is NOT optional. The --conf argument specifies the conf file, e.g., my.conf.
<pre>
  cd $VDT_LOCATION/edg/sbin
  ./edg-mkgridmap --verbose --conf=my.conf --output=test.out
</pre>
Check your output file (shown here as test.out).  It should contain the DN of each member you've added to the VO.  If it does, it worked!


  The most common error is "Internal Server Error" which indicates an
  authentication failure.  This can happen either because access to the
  VOMS DB has not been completed, or because the local site credentials
  (host certificate and key) are not valid.  If this occurs, set the X509_USER_CERT and
  X509_USER_KEY variables to test using a different, valid certificate
  and key.

---++Add users, groups, and roles to your VOMS installation

Go to your VOMS web UI, click Adminstrate VOMS.  Use the Users, Groups and Roles links to add these items.


---++Remove a VO from your VOMS Database
First su/ssh to root.

You need to know your root password for the mysql database, if it exists.
If you did not set a root password, leave dbpasswd empty
If you want to set the root password:
<verbatim>
	 VDT_LOCATION/mysql/bin/mysqladmin -u root password 'new-password'
	 VDT_LOCATION/mysql/bin/mysqladmin -u root -h $(hostname) password 'new-password'
</verbatim>
Set your environment:
<verbatim>
VDT_LOCATION=/data/osg-itb-015
cd $VDT_LOCATION
source setup.sh
</verbatim>
Change the VO variable to the VO you want to remove.
<verbatim>
VO=your_vo_name
</verbatim>
Stop the VOMS server for the VO
<verbatim>
$EDG_LOCATION/etc/init.d/voms stop $VO
</verbatim>
Stop tomcat, remove the VO context file from the /var/tomcat4/webapps directory, and retart tomcat:
<verbatim>
/etc/init.d/tomcat-4 stop
rm -f $VDT_LOCATION/tomcat/v4/webapps/edg-voms-admin-$VO.xml 
/etc/init.d/tomcat-4 start
</verbatim>

This script creates a sql file for cleaning up the database
This file needs to use the mysql script as mysql root.
<verbatim>
$EDG_LOCATION/sbin/edg-voms-admin-configure remove \
  --vo				$VO \
  --voms-group	 $VOMS_GROUP  \
  --tomcat-group  $TOMCAT_GROUP 
</verbatim>

Remove the database and users from the mysql database
<verbatim>
sqlfile=$EDG_LOCATION/var/etc/edg-voms-admin/${VO}/remove-voms-mysql-as-root.sql
</verbatim>

NOTE: you can remove the $DBA_PSWD (mysql root password) from the command and 
enter it at the command line prompt which is more secure:
<verbatim>
mysql -u root -p$DBA_PSWD <$sqlfile
mysql -u root <$sqlfile
</verbatim>

Check:
<verbatim>
ls -l $EDG_LOCATION/etc/voms
ls -l $EDG_LOCATION/var/etc/edg-voms-admin
ls -l $EDG_LOCATION/etc/vomses/$VO
</verbatim>
Remove the following:
	* the voms server configuration directory
	* the tomcat configuration directory
	* the vomses file in the ./vomses directroy for client access
<verbatim>
rm -rf $EDG_LOCATION/var/etc/edg-voms-admin/$VO  ## tomcat configs
rm -f  $EDG_LOCATION/etc/vomses/$VO				  ## vomses file 
</verbatim>
Done!
---++VOMS Install Troubleshooting Guide
Known problems are documented in the "Known Problems" section of the ItbRel015 page.

For other things that arise, see VomsTroubleshootingGuide.

---++Shutdown Guide
The OSG VOMS starts up several processes.  If you try to re-install/upgrade the OSG VOMS without shutting them down it will fail.  Run the following commands to turn off the OSG VOMS services before upgrading:

<ul>
  <li>/etc/init.d/apache stop
  <li>/etc/init.d/tomcat-4 stop
  <li>/etc/init.d/voms stop
  <li>/etc/init.d/mysql stop
</ul>


<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->

*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.AnneHeavey - 18 May 2005
-- John Weigand - 13 May 2005

%STOPINCLUDE%

