%META:TOPICINFO{author="IwonaSakrejda" date="1255744763" format="1.1" reprev="1.18" version="1.18"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! *<nop>%SPACEOUT{%TOPIC% Server Installation}%*
%TOC%

---++Introduction

The gsiftp package contains components necessary to set up a stand-alone gsiftp server and tools necessary to monitor and report its performance.
A stand-alone gsiftp server might be used under the following circumstances:
   * A simple front-end to a filesystem allowing access over WAN - for example [[Storage/HadoopUnderstanding][HDFS]].
   * Bestman is capable of distributing its workload among several gsiftp servers so if you expect large movements of data into/out of your site, multiple gsiftp servers can be set up.

---++++++!!Applicable Versions
This document applies to an install of 
%RED%
*osg-version 1.2.3* 
%ENDCOLOR%
(or higher) and 
%RED%
*vdt-version  2.0.0*
%ENDCOLOR%
(or higher).

---++++++!!Engineering Considerations
It is recommended that the gsiftp package be installed on its own server if:
   * You are serving the VOs that use storage heavily (CMS, ATLAS, CDF, and D0) and have more than 250 cores
   * Your site will be managing more than 50 TB of disk space

If you are planning to have a Storage Element with !BeStMan and have more
than 1Gbps bandwidth, then you should plan on at least one !GridFTP server
per 4Gbps of available bandwidth (assuming you have 10Gbps interfaces on the
server) if you want to maximize throughput. 

---++Checklist
   1. [[PacmanInstall][pacman]] %PACMAN_VERSION% installed at $PACMAN%PACMAN_VERSION%
   1. [[GetGridCertificates][host certificate]] installed in =/etc/grid-security/
   1. storage filesystem mounted on the server
   1. opened ports for authentications with ftp server (typically 2811) and for the data transfers (high ports typically in range 32769-65535). If this is your first time install and your system is behind a firewall, consulting  the [[ComputeElementFirewalls][Firewalls document]] is recommended.
   1. GUMS server is up and running if prima  authorization is used.

---++Installation Procedure
Login as root and set up pacman environment:
<pre class="screen">
su root
source $PACMAN%PACMAN_VERSION%/setup.sh
</pre>
Create a directory where the software will be located and download it there. The downloading procedure will ask whether you want to trust the OSG and VDT caches ( =yall=) and wheher you accept the license (also =y=).
<pre class="screen">
mkdir /opt/osg/osg-%OSG_VERSION%-gsiftp/
cd /opt/osg/osg-%OSG_VERSION%-gsiftp/
pacman -get %CACHE%:GridFTP
</pre>

The install procedure will print out a warning:
<verbatim>
========== IMPORTANT ==========
Most of the software installed by the VDT *will not work* until you install
certificates.  To complete your CA certificate installation, see the notes
in the post-install/README file.
</verbatim>

Instead of reading the README file set up CA certificates in the following way:
<pre class="screen">
source setup.sh
$VDT_LOCATION/vdt/bin/vdt-ca-manage setupca --location local -url osg
</pre>
This command will download certificates distributed by OSG to =$VDT_LOCATION/globus/share/certificates= and create a link from =$VDT_LOCATION/globus/TRUSTED_CA= to that location. [[VDTCAManage][Other options]] are also available.

Configure newly downloaded environment, verify downloaded versions are what you expected, and that the VDT version is correct.
<pre class="screen">
source setup.sh
vdt-post-install
vdt-control --list
vdt-version
</pre>

Edit both the files below by entering the transfer ports (high opened ports):

   * $VDT_LOCATION/vdt/etc/vdt-local-setup.sh :
<verbatim>
GLOBUS_TCP_PORT_RANGE=low_port,high_port
export GLOBUS_TCP_PORT_RANGE
GLOBUS_TCP_SOURCE_RANGE=low_port,high_port
export GLOBUS_TCP_SOURCE_RANGE
</verbatim>

   * $VDT_LOCATION/vdt/etc/vdt-local-setup.csh:
<verbatim>
setenv GLOBUS_TCP_PORT_RANGE low_port,high_port
setenv GLOBUS_TCP_SOURCE_RANGE low_port,high_port
</verbatim>

---++ Service Configuration
The !GsiFTP Stand-Alone server is configured with the =configure-osg= script  based on entries in the =$VDT_LOCATION/osg/etc/config.ini= configuration file.
The =$VDT_LOCATION/osg/etc/= directory contains two template files =config.ini= and =storage.ini=. First remove the =config.ini= and then rename =storage.ini= to be =config.ini=. This procedure will be simplified in the future.
<pre class="screen">
rm $VDT_LOCATION/osg/etc/config.ini
mv $VDT_LOCATION/osg/etc/storage.ini $VDT_LOCATION/osg/etc/config.ini
</pre>
Then edit the =$VDT_LOCATION/osg/etc/config.ini= file following instructions that precede each entry.  Here is an example of entries that needed editing:
<pre class="screen">
[Gridftp]
enabled = %(enable)s
mode = standalone

[Misc Services]
use_cert_updater = %(enable)s
gums_host = osp3.lbl.gov
authorization_method = prima

[Gratia]
enabled = %(enable)s
sitename = LBNL_VTB
probes = %(itb-gridftp-gratia)s
</pre>
Now verify your configuration and then execute it:
<pre class="screen">
configure-osg -v
configure-osg -c
</pre>

---++ Service Startup/Shutdown
To start type:
<pre class="screen">
vdt-control --on
</pre>
and to stop:
<pre class="screen">
vdt-control --off
</pre>

---++ Validation of Service Operation

On a client host run the globus-url-copy to verify the gsiftp service can successfully transfer a file:
<pre class="screen">
globus-url-copy file:///etc/hosts  gsiftp://osp1.lbl.gov/tmp/hostscopy
</pre>

Verify that the [[GratiaTransferProbe#Sanity_Check][gratia probe is working]].



---++Debugging Information
---++++++!!File Locations
   * Configuration file:
      * $VDT_LOCATION/vdt/services/vdt-run-gsiftp.sh.env  
      * $VDT_LOCATION/gratia/probe/gridftp-transfer/ProbeConfig	 
   * Log Files
      * $VDT_LOCATION/globus/var/log/gridftp.log
      * $VDT_LOCATION/globus/var/log/gridftp-auth.log 
      * $VDT_LOCATION/gratia/var/logs 

---++++++!!Debugging Procedure
   * Look at the [[#Checklist][Checklist]] and make sure you really checked those items.

---++++++!!Caveates/Known Issues
---++++++!!Screendump of Install
<pre class="screen">
[root@osp4 osg]#  source /opt/osg/pacman-3.28/setup.sh
[root@osp4 osg]#  mkdir /opt/osg/osg-1.2.3-gsiftp/
[root@osp4 osg]#  cd /opt/osg/osg-1.2.3-gsiftp/
[root@osp4 osg-1.2.3-gsiftp]# pacman -get VTB:GridFTP
Do you want to add [http://osg-vtb.uchicago.edu/vtb/] to [trusted.caches]? (y/n/yall): yall
Beginning VDT prerequisite checking script vdt-common/vdt-prereq-check...        

The VDT installs a variety of software, each with its own license.
In order to continue, you must agree to the licenses.
You can view the licenses online at:

    http://vdt.cs.wisc.edu/licenses/

After the installation has completed, you will also be able to
view the licenses in the "licenses" directory.

Do you agree to the licenses? [y/n]
y
All prerequisite checks are satisfied.
                                                          


========== IMPORTANT ==========
Most of the software installed by the VDT *will not work* until you install
certificates.  To complete your CA certificate installation, see the notes
in the post-install/README file.



[root@osp4 osg-1.2.3-gsiftp]# source setup.sh
[root@osp4 osg-1.2.3-gsiftp]# $VDT_LOCATION/vdt/bin/vdt-ca-manage setupca --location local -url osg
Setting CA Certificates for VDT installation at '/opt/osg/osg-1.2.3-gsiftp'

Setup completed successfully.
[root@osp4 osg-1.2.3-gsiftp]# source setup.sh
[root@osp4 osg-1.2.3-gsiftp]# vdt-post-install
Starting...
Configuring PRIMA... Done.
Configuring EDG-Make-Gridmap... Done.
Completed all configuration.
[root@osp4 osg-1.2.3-gsiftp]# vdt-control --list
Service                 | Type   | Desired State
------------------------+--------+--------------
fetch-crl               | cron   | do not enable
vdt-rotate-logs         | cron   | do not enable
vdt-update-certs        | cron   | do not enable
gsiftp                  | inetd  | do not enable
gratia-gridftp-transfer | cron   | do not enable
gums-host-cron          | cron   | do not enable
edg-mkgridmap           | cron   | do not enable
[root@osp4 osg-1.2.3-gsiftp]# vdt-version

You have installed a subset of VDT version 2.0.89p11:

Software                                                 Status             
--------                                                 ------             
vdt-ca-manage 1.0                                        OK                 
vdt-update-certs 2.5                                     OK                 
CA Certificates 1.9 (includes IGTF 1.31 CAs)             -                  
EDG Make Gridmap 3.0.0                                   OK                 
Fetch CRL 2.6.6                                          OK                 
GPT 3.2-4.0.8p1                                          OK                 
Gratia GridFTP Probe 1.04.4d-1                           OK                 
Grid User Management System (GUMS) Client 1.3.17         OK                 
Java 5 SDK 1.5.0_21                                      OK                 
Logrotate 3.7                                            OK                 
PRIMA Authorization Module 0.8.4                         OK                 
pyOpenSSL module 0.9                                     OK                 
VOMS Client 1.8.8-2p1                                    OK                 
Wget 1.11.4                                              OK                 


Status legend:
OK: Software is up to date with the latest release in VDT version 2.0.89
- : Not enough information to determine if updates are available.
See man page for more information. 

[root@osp4 osg-1.2.3-gsiftp]# cd osg/etc
[root@osp4 etc]# rm config.ini
[root@osp4 etc]# mv storage.ini config.ini
[root@osp4 etc]# vi config.ini
[root@osp4 etc]# configure-osg -v
Using /opt/osg/osg-1.2.3-gsiftp/osg/etc/config.ini for configuration information
Configuration verified successfully
[root@osp4 etc]# configure-osg -c
Using /opt/osg/osg-1.2.3-gsiftp/osg/etc/config.ini for configuration information
running 'vdt-register-service --name fetch-crl --enable'... ok
Running /opt/osg/osg-1.2.3-gsiftp/fetch-crl/share/doc/fetch-crl-2.6.6/fetch-crl.cron, this process make take some time to fetch all the crl updates
running 'vdt-register-service --name vdt-update-certs --enable'... ok
running 'vdt-register-service --name gums-host-cron --enable'... ok
running 'vdt-register-service --name edg-mkgridmap --disable'... ok
Running /opt/osg/osg-1.2.3-gsiftp/gums/scripts/gums-host-cron, this process make take some time to query vo and gums servers
running 'vdt-register-service --name gsiftp --enable'... ok
running 'vdt-register-service --name vdt-rotate-logs --enable'... ok
Configure-osg completed successfully
[root@osp4 etc]# cd ../..
[root@osp4 osg-1.2.3-gsiftp]# vdt-control --list
Service                 | Type   | Desired State
------------------------+--------+--------------
fetch-crl               | cron   | enable
vdt-rotate-logs         | cron   | enable
vdt-update-certs        | cron   | enable
gsiftp                  | inetd  | enable
gratia-gridftp-transfer | cron   | enable
gums-host-cron          | cron   | enable
edg-mkgridmap           | cron   | do not enable

[root@osp4 osg-1.2.3-gsiftp]#
[root@osp4 osg-1.2.3-gsiftp]# vdt-control --on
enabling cron service fetch-crl... ok
enabling cron service vdt-rotate-logs... ok
enabling cron service vdt-update-certs... ok
enabling inetd service gsiftp... ok
enabling cron service gratia-gridftp-transfer... ok
enabling cron service gums-host-cron... ok
skipping cron service 'edg-mkgridmap' -- marked as disabled
</pre>


---++Comments
%COMMENT{type="tableappend"}%

%STOPINCLUDE%
%BR%
%COMPLETE2% %BR%
%RESPONSIBLE% Main.IwonaSakrejda - 17 Sep 2009 %BR%
%REVIEW% Main.TanyaLevshina - 
