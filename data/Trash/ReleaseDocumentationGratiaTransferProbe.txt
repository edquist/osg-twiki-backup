%META:TOPICINFO{author="RobGardner" date="1247163782" format="1.1" reprev="1.6" version="1.6"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! *<nop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%

%STARTINCLUDE%
%BR%
---+ _%INCLUDEHEADING%  %SPACEOUT{ "%TOPIC%" }%_
The !BeStMan server is using !GridFTP server to transfer files to/from  any Posix compliant file system. Gratia !GridFTP  transfer probe generates accounting  information about these transfers  by parsing the Globus !GridFTP server logs. 
This document describes the Gratia !GridFTP transfer probe configuration procedure. This procedure must be repeated once for every !GridFTP server in the SE.

%EDITTHIS%
%BR%

---++ Configuring Gratia !GridFTP transfer probe
Gratia !GridFTP  transfer probe is installed simultaneously with !BeStMan or standalone !GridFTP server. It is not enabled by default. In order to see what is installed from %CACHE%:BeStMan execute the following commands:

<pre class="screen">
cd &lt;VDT_LOCATION&gt;
. setup.sh
vdt-control --list
[root@fg0x1 itb_bestman]# vdt-control --list
Service            | Type   | Desired State
-------------------+--------+--------------
fetch-crl          | cron   | enable
vdt-rotate-logs    | cron   | enable
vdt-update-certs   | cron   | enable
gsiftp             | inetd  | enable
gratia-gridftp-tran| cron   | do not enable
bestman            | init   | enable
edg-mkgridmap      | cron   | do not enable
gums-host-cron     | cron   | do not enable
</pre>  

To configure Gratia !GridFTP transfer probe do the following:
<pre class="screen">
cd &lt;VDT_LOCATION&gt;
. setup.sh
$VDT_LOCATION/vdt/setup/configure_gratia  \
 --probe gridftp-transfer \
 --report-to &lt;gratia_host:gratia_port&gt; \
 --probe-cron --site-name &lt;SiteName&gt;
</pre>

Where _gratia_host_ is FQDN of Gratia collector, _gratia_port_ is Gratia Collector port and  _SiteName_ is your site name.
For ITB collector use the following values:<br/>
_gratia_host_ gratia-osg-itb.opensciencegrid.org<br/>
_gratia_port_ 8881<br/>

For OSG collector use the following values:<br/>
_gratia_host_  gratia-osg-transfer.opensciencegrid.org<br/>
_gratia_port_  8881<br/>

If you want to do additional changes in configuration, eg change location of gridftp logs or name of the Grid (default is OSG) you can edit _ProbConfig_ file  located in
_$VDT_LOCATION/gratia/probe/gridftp-transfer_ directory.

---++  Creating osg-user-vo-map

Please read  [[https://twiki.grid.iu.edu/bin/view/Integration/ITB092/OsgSupportedVos][this page]] about files that are required to accurately collect grid resource usage and metrics by VO for transfer submitted using grid proxies or where voms proxy information is not available. 

---+++ Using GUMS based authorization mode
In order to enable generation of osg-user-vo-map from GUMS  do the following:
<pre class="screen">
cd &lt;VDT_LOCATION&gt;
. setup.sh
vdt-control -enable gums-host-cron
vdt-control -on gums-host-cron
touch $VDT_LOCATION/monitoring/osg-attributes.conf
$VDT_LOCATION/gums/scripts/gums-host-cron
</pre>

---+++ Using Gridmap based authorization mode

In order to enable generation of gridmap-file and  osg-user-vo-map by using the edg-mkgridmap cron process to get information form VOMS servers do the following:
<pre class="screen">
cd &lt;VDT_LOCATION&gt;
. setup.sh
vdt-control -enable edg-mkgridmap
vdt-control -on edg-mkgridmap
$VDT_LOCATION/edg/sbin/edg-mkgridmap 
</pre>

---++ Enable Gratia !GridFTP Transfer probe

You will now need to enable Gratia !GridFTP transfer probe:
<pre class="screen">
cd &lt;VDT_LOCATION&gt;
. setup.sh
vdt-control --enable gratia-gridftp-transfer
</pre>

----++ Starting/Stopping Gratia !GridFTP transfer probe
   1. Gratia  !GridFTP  probe installed on !BeStMan or !GridFTP nodes could be started together with all other services by issuing _vdt-control --on_ command. If you want to start it separately do the following:<pre class="screen">
cd &lt;VDT_LOCATION&gt;
. setup.sh
vdt-control --on gratia-gridftp-transfer
</pre>
   1. Gratia  !GridFTP probe installed on !BeStMan or !GridFTP nodes could be stopped together with all other services by issuing _vdt-control --off_ command. If you want to stop it separately do the following:
<pre class="screen">
cd &lt;VDT_LOCATION&gt;
. setup.sh
vdt-control --off gratia-gridftp-transfer
</pre>

----++ Log files and configuration location
You could find log and configuration files related to probe at the following  location on a relevant node: 

| *Module Name* |  *Configuration files* | *Log files* | 
|Gratia !GridFTP probe|$VDT_LOCATION/gratia/probe/gridftp-transfer/ProbeConfig|$VDT_LOCATION/gratia/var/logs|

---++ Sanity Check

If you turned on !GridFTP Gratia transfer probes you should be able to see the accounting information by accessing your Gratia collector. Keep in mind that probe collection is executed by a cron job, so check the time
the cron job will be executed:
<pre class="screen">
crontab -l
5,15,25,35,45,55 * * * * &lt;VDT_LOCATION&gt;/gratia/probe/gridftp-transfer/gridftp-transfer_meter.cron.sh > &lt;VDT_LOCATION&gt;gratia/var/logs/gratia-probe-gridftp-transfer.log 2>&1
</pre>

To access the information, go to http://&lt;gratia_host&gt;:&lt;gratia_port&gt;/gratia-reporting/, click on "Custom SQL Query" on the left site menu frame, enter the following query into provided text box:
<pre class="screen">
select * from MasterTransferSummary where ProbeName like 'gridftp-transfer:&lt;your_host_name&gt;';
</pre>
click on "Execute Query" and you will see the total number of transfer per user. To get more detailed information you can execute the following query:
<pre class="screen">
select j.dbid, j.ResourceType ,j.LocalJobId,LocalUserId,j.CommonName,j.KeyInfoContent,j.Status,j.StartTime,
         j.EndTime,j.SubmitHost,m.ReportedSiteName,m.Grid, n.Value,n.StorageUnit 
         from JobUsageRecord j, JobUsageRecord_Meta m, Network n  
         where j.dbid=m.dbid and j.dbid=n.dbid and m.ProbeName like 'gridftp-transfer:&lt;your_host_name&gt;'  order by dbid;
</pre>

To check ITB Gratia collector click here [[http://gratia-osg-itb.opensciencegrid.org/gratia-reporting/][ITB Gratia]].

To check OSG Gratia collector click here [[http://gratia-osg-transfer.opensciencegrid.org/gratia-reporting/][OSG Gratia]].




%STOPINCLUDE%
%BR%
%COMPLETE1% %BR%
%RESPONSIBLE% Main.TanyaLevshina - 18 Feb 2009 %BR%
%REVIEW%

%REVFLAG% %X% %BR%

---++ *Comments*
%COMMENT{type="tableappend"}%
