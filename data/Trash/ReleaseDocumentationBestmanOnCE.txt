%META:TOPICINFO{author="TanyaLevshina" date="1285700921" format="1.1" reprev="1.12" version="1.12"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! <nop> !BeStMan on CE 
%DOC_STATUS_TABLE%
%TOC{depth="2"}%
%STARTINCLUDE%
%BR%

---++ Introduction
The purpose of this document is to describe how to handle !BeStMan (full-mode or gateway) installation on Compute Element (CE) node. Please refer to [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/Bestman][BeStMan full-mode Installation Guide]] and [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/BestmanGateway][BeStMan-gateway Installation Guide]] for more details.

---+++!! Applicable Versions
The applicable software versions for this document are 
%RED%
%OSG_VERSION% 
%ENDCOLOR%
(or higher) and 
%RED%
*vdt-version  2.0*
%ENDCOLOR%
(or higher).

---+++!!Engineering Considerations

It could be not a very wise idea to install !BeStMan on heavily used CE node but if you need to do that you should keep in mind that you will need to use non-standard ports for !BeStMan to avoid conflict with apache/tomcat servers as well as use !GridFTP server and authorization infrastructure that are already installed on CE node.   

The following questions should be answered before you can proceed with installation and  configuration:

   $ Q. _What flavor of !BeStMan do you want to use?_: You can use either fullmode or gateway. Please read [[http://sdm.lbl.gov/bestman/docs/bestman-guide.html][BeStMan documentation]] for details.

   $ Q. _What authorization mechanism do you prefer?_: You have to decide if you want to use grid-map-file or !GUMS server for users’ authentication and authorization. Most logically will be to select the same approach that is already being used on CE (e.g authorization mechanism used for gatekeeper)
 
   $ Q. _If you are using !BeStMan-gateway, do you need to support static space tokens?_ : !BeStMan-gateway supports predefined, static space tokens that should be included in configuration. It doesn't keep trace or enforce static space tokens.  If you want partition your storage space and have a “designated” space for some  VOs or users you can choose to use space tokens. You will have to decide the names and descriptions of the tokens as well as the size of the area.  

   $ Q. _Do you want to enable Gratia gridftp-transfer probes?_: Yes!  The Gratia gridftp-transfer probes provide much-desired statistics that OSG uses for accounting, much like the Gratia job accounting.  More details can be found at [[https://twiki.grid.iu.edu/bin/view/Accounting/WebHome  Gratia Home Page]]. The reported information will include the source and destination of transfer, certificate subject of transfer initiator, size and status of the transferred file. This probe captures transfer statistics, hence it needs to be installed on your !GridFTP server. Keep in mind that you will report all the transfers that are going through !GridFTP server and not only the one that are initiated via !BeStMan.

---+++!!Help!
If a problem occurs during installation or verification of the service, see [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/Bestman#Debugging_Information][BeStMan-fullmode debugging Information]] or  [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/BestmanGateway#Debugging_Information][BeStMan-gateway debugging Information]] .

---++Checklist
   1. [[ReleaseDocumentation/PacmanInstall][pacman]] version >= %PACMAN_VERSION% is required. You should already installed it before you have installed CE.
   1. The server must have a fully qualified domain name and a valid [[ReleaseDocumentation/GetGridCertificates][grid host certificate]] installed in =/etc/grid-security/=
   1. !BeStMan server needs to have a valid service certificate. The certificate should be own by a user login that is running !BeStMan server.The right permission (600) should be set on those files. By default !BeStMan is using a service certificate =/etc/grid-security/http/httpcert.pem= and certificate key =/etc/grid-security/http/httpkey.pem=.

%ICON{warning}%  !BeStMan should be configured with host certificate in order to be able to handle requests from !LCG-Utils tools. This is mandatory for at least all !BeStMan servers that support ATLAS experiment. Normally the OSG !BeStMan implementation uses a service certificate, not a host certificate. This causes lcg-cp to fail because the certificate name (which looks like http/hostname instead of just hostname or host/hostname) doesn't match the hostname. There are two ways to solve this problem:
   * copy hostcert.pem, hostkey.pem into /etc/grid-security/http and rename these two files to httpcert.pem, httpkey.pem respectively. Change ownership of these files and directory.
   * create a directory  /etc/grid-security/bestmancert copy hostcert.pem, hostkey.pem into this directory and  these two files to bestmancert.pem, bestmankey.pem.respectively. Change ownership of these files and directory. You will need to use relevant options to specify certificate and certificate key while configuring !BeStMan.

   1. The firewall issues for !Grid FTP and a working GUMS server or a gridmap-file should be already in place fater CE installation.

---++ !BeStMan Installation Procedure

%INCLUDE{"Documentation/DocumentationTeam/DocConventions" section="Header"}%
%INCLUDE{"Documentation/DocumentationTeam/DocConventions" section="CommandLine"}%
%INCLUDE{"BestmanGateway" section="Installation"}%

---++ !BeStMan Configuration
You will need to configure !BeStMan-Gateway first in order to enable it as a service. !BeStMan is recommended to run under non-root account.
Keep in mind that you have to use ports different from 8080 and 8443 and same authorization mechanism that is in use on that CE node.

---+++ !BeStMan-gateway
If you are installing !BeStMan-gateway mode follow these instructions:
%INCLUDE{"BestmanGateway" section="ComplexConfiguration"}%

---+++ !BeStMan-fullmode
If you are installing !BeStMan-fullmode follow these instructions.
%TWISTY%
%INCLUDE{"Bestman" section="ComplexConfiguration"}%
%ENDTWISTY%


---++ Configuring Gratia !GridFTP Transfer Probe
If you want to enable Gratia !GrdFTP transfer probe you will need to follow instructions provided in  [[GratiaTransferProbe#Configuring_Gratia_GridFTP_trans][Configuring Gratia transfer probe]]
After you have finished with configuration you will need to change the  location of gridftp logs. By default  the  location is pointing to !GridFTP logs for the !GridFTP server installed with !BeSTMan cache. If you are using CE !GridFTP server you have to edit _ProbConfig_ file  located in
_$VDT_LOCATION/gratia/probe/gridftp-transfer_ directory.

You will need to modify the following parameters in probe configuration file.
   1. Location of !GridFTP logs<pre class="screen">
   UserVOMapFile="&lt;CE_VDT_LOCATION&gt;/monitoring/osg-user-vo-map.txt"
</pre>   
   1. Location of _osg-vo-map.txt_ file <pre class="screen">
    GridftpLogDir="&lt;CE_VDT_LOCATION&gt;/globus/var/log"
</pre>

---++ Enabling the Services
Follow [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/Bestman#Enabling_the_Services][these instructions]] to enable services.

%ICON{"warning"}%  Remember that you do not want to enable !GridFTP (gsifrp service) if you are planning to use !GridFTP already installed with CE installation.

---++ Services Startup/Shutdown 
Follow  [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/Bestman#Services_Startup_Shutdown][ these instructions]] to start/stop services.

---+++ Integration with the information system

Integration of the SE with the central information systems takes place during the Compute Element installation/configuration. See the topic [[ReleaseDocumentation/GenericInformationProviders][Generic Information Providers]]. The SE does not collect or publish information independently.

---++ Validation of Service Operation 

Please see [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/Bestman#Validation_of_Service_Operation][BeStMan-fullmode]] and [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/BestmanGateway#Validation_of_Service_Operation][BeStMan-gateway]] for service validation and troubleshooting information. 

---++ *Comments*
| This isn't an installation mode OSG recommends, however, probably good for test sites and tutorials. | Main.RobGardner | 21 Jul 2009 - 16:05 |
%COMMENT{type="tableappend"}%
<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = TanyaLevshina

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = Storage

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = Installation
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %YES%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %NO%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = AlexSim
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %YES%


 DEAR DOCUMENT TESTER
 ====================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = IwonaSakrejda
 Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %IN_PROGRESS%
############################################################################################################
-->
