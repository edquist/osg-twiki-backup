%META:TOPICINFO{author="KarthikArun" date="1305758086" format="1.1" reprev="1.1" version="1.1"}%
%TOC%
-- Main.KarthikArun - 18 May 2011
---++Updating the normalization factor for OSG sites (affects WLCG reporting)
---+++Normalization factor
The normalization factor for a OSG site is the value by which the accounting numbers (the CPU hours, Wall time etc.) for that site is scaled/weighted (multipled by), in order to account for differences in the CPU types that make up the subclusters that constitute the site. For the sake of a simple example, 10 CPU hours on a CPU that is rated at 2 Ghz is equivalent to 20 CPU hours on a CPU that is rated at 1 GHz. So the normalization factor helps to even out these differences and provides a way to compare the numbers reported from different sites. 
---+++Gratia APEL interface
The <a href=https://twiki.grid.iu.edu/bin/view/Accounting/GratiaInterfacesApelLcgNotes>Gratia APEL interface</a> provides the mechanism by which accounting information for OSG sites are reported to the WLCG. For this purpose the APEL interface maintains the normalization factor for the different OSG sites. As sites evolve/change/upgrade/downgrade etc. the normalization factor for a site will change and these values need to be modified/updated/edited in the APEL interface, so that the correct values are reported to the WLCG. Hence it is important to keep the normalization factor values up to date in the Gratia APEL interface. Now we will explain  how to edit these values in order to keep them up to date. 

The Gratia APEL interface stores/maintains the normalization factor values in a plain text configuration file (lcg-reportableSites) that has to be edited manually. The APEL interface scripts (that report to WLCG), read the normalization factor from this file and use them to scale the numbers reported to the WLCG. In order to effect changes to the normalization factor, this file needs to be edited. A copy of the most latest update to this file is also maintained at the gratia svn repository at <a href=http://gratia.svn.sf.net/viewvc/gratia/trunk/interfaces/apel-lcg/lcg-reportableSites?view=log>lcg-reportableSites</a>.
---+++How to access and edit the normalization factor values for OSG sites
Now let us discuss where/how to access this lcg-ReportableSites file and how to update it. The Gratia APEL interface executes on the machines at Fermilab (FNAL) as the user "gratia" and in order to edite this file, on needs to have access to the machines at Fermilab as a "gratia" user. This means one needs to have a fnal account with the right privileges. If you don't have an account already, please contact the Fermilab helpdesk or someone at your organization to get help to setup an account. Once you have the account, do the following:

Login into one of the fermilab machines where the Gratia APEl interface runs
<pre>
ssh gratia@gr6x1.fnal.gov
cd interfaces/apel-lcg
</pre>

Use your favorite editor in order to edit the file
<pre>
vi lcg-reportableSites
</pre>

Guidelines on what/how to edit the file:

The lcg-reportableSites file consists of entries like the one shown below (Note: All entries in the file that start with # are commented out and hence ignored by the APEL inerface script):

<table border=0 cellspacing=0>
<tr><td colspan=2> ------------------------------------------------------------</td></tr>
<tr><td>Site</td><td> SPECint2000</td></tr>
<tr><td colspan=2> ------------------------------------------------------------</td></tr>
<tr><td>AGLT2</td><td> 2125</td></tr>
<tr><td>HU_ATLAS_Tier2</td><td>      2218</td></tr>
<tr><td>BU_ATLAS_Tier2</td><td>      2095</td></tr>
<tr><td>MWT2_IU</td><td> 2170</td></tr>
<tr><td>MWT2_UC</td><td>2178</td></tr>
<tr><td>OU_OCHEP_SWT2</td><td>2255</td></tr>
<tr><td>WT2</td><td>2650</td></tr>
<tr><td>SWT2_CPB</td><td> 2107</td></tr>
<tr><td>UTA_SWT2</td><td> 2810</td></tr>
<tr><td colspan=2> ------------------------------------------------------------</td></tr>
</table>


As you could see the first column represents the site and the 2nd column represents the value for SPECint2000 for the site. This is the normalized value for the entire site. Refer to the <a href=https://twiki.grid.iu.edu/bin/view/Accounting/GratiaInterfacesApelLcgNotes>Gratia APEL interface</a> on how to calculate this normalization factor value. This value might also available from other sources like the <a href=http://red-web.unl.edu/gratia/wlcg_reporting#sitenorm>UNL page</a> (some inconsistencies in the values reported in this page are still being worked on as of this writing on Wed, 5/18/2011) and the <a href=http://www.usatlas.bnl.gov/twiki/bin/view/Admins/CapacitySummary.html>USATLAS spreadsheet</a> (one can use this for the USATLAS sites). 

Whenever the normalization factor for one or more site changes (the only way to figure this out right now is by manually comparing the normalization factor value in the lcg-reportableSites file against the actual value that is either maintained in a reliable source or calculated in a reliable manner), the lcg-reportableSites file needs to be updated. Please note that the value stored in this file is in SPECint2000. So if your original value is in HS06, divide it by 4 and use that number. Here is an example calculation for site AGLT2 (in order to explain how we arrived at 2125 in the above table):

<pre>
Measured HS06 for AGLT2 is 8.5 (taken from USATLAS spreadsheet)
To convert this to SPECint2000, do the following:
8.5 * 1000 / 4 = 2125
</pre>

In order to edit this value for a particular site, simply change the value that is in the 2nd column (corresponding to the site in the 1st column). Also make sure to document the change as shown below for example:

<table cellspacing=0>
<tr><td colspan=3> 04/29/2011 (Your name)</td></tr>
<tr><td colspan=3> ------------------------------------------------------------</td></tr>
<tr><td>Site</td><td>                old</td><td>       new</td></tr>
<tr><td colspan=3> ------------------------------------------------------------</td></tr>
<tr><td>BU_ATLAS_Tier2</td><td>      2003</td><td>      2095</td></tr>
<tr><td>OU_OCHEP_SWT2</td><td>       2413</td><td>      2255</td></tr>
<tr><td>SWT2_CPB</td><td>            1865</td><td>      2107</td></tr>
<tr><td colspan=3> ------------------------------------------------------------</td></tr>
</table>


The changes are in effect immediately and it would affect the data reported to the WLCG as soon as the APEL interface script runs the next time. Also make sure that you commit the changes to the <a href=http://gratia.svn.sf.net/viewvc/gratia/trunk/interfaces/apel-lcg/lcg-reportableSites?view=log>svn repository</a> as discussed previously. In addition to this, there are files maintained for history purposes and also to apply changes retroactively for previous months if any. For example at the beginning of June 2011, you need to do the following:

<pre>
cp lcg-reportableSites lcg-reportableSites.history/lcg-reportableSites.201105 
cp lcg-reportableSites lcg-reportableSites.history/lcg-reportableSites.201106
</pre>

If something isn't clear or If you have questions, please refer to the <a href=https://twiki.grid.iu.edu/bin/view/Accounting/GratiaInterfacesApelLcgNotes>Gratia APEL interface</a> page for details. You could also get in touch with John Weigand at Fermilab for clarification. 
