%META:TOPICINFO{author="JamesWeichel" date="1269890404" format="1.1" reprev="1.9" version="1.9"}%
%META:TOPICPARENT{name="WebHome"}%
---+ Metric for Non HEP Science Usage of the OSG
%TOC%

---++ Introduction
One of the statements in the OSG Charter is, "The Open Science Grid will be open to all sciences that have a need for distributed large scale computing and data management, and can bring resources to be federated."  Two measures of progress on this goal are 1) the number of distinct scientific domains using OSG and 2) the amount (e.g. wall or cpu hours) of that usage.  This document covers a measure of the usage of OSG by scientific domains.

---++ Background Information
The accounting records collected by [[https://twiki.grid.iu.edu/bin/view/MonitoringInformation/WebHome#Gratia_Accounting][Gratia]] contain the VO Distinguished Name (DN) but not the Science Domain.  Therefore, to sum usage by Science Domain, an additional mapping from VO and/or DN is required.  For some VOs, all (or nearly all) users are working on the same project and are in the same Science Domain.  For example, the the ATLAS and CMS VOs are both in the High Energy Physics domain.  Other VOs have usage by users in different science domains.  For these VOs, a mapping is required from each specific user to their science domain.

---+++ Mapping of Records to Science Domain
Currently, to provide this mapping, the accounting records must be post-processed to add the science domain.  The source of these mappings is either the OIM (for VOs representing a single domain) or a set of tables (in csv format) that map individual user DNs to Science Domain.  Specifically, the Engage, NYSGrid, and GPN VOs maintain tables for their users.  These tables, unfortunately, must be manually maintained.  Here are the links for our current tables:

   * Engage data source: http://engage-central.renci.org/engage-sciences.csv
   * NYSGrid data source: https://www.ccr.buffalo.edu/download/attachments/31558659/NYSGrid-classifications.csv
   * GPN (and other overrides): http://t2.unl.edu/store/override-classifications.csv
   * Final set of overrides: %ATTACHURL%/othermapping.csv

Other mappings can be developed, upon request, for other VOs.

Given the large number of users of OSG, the user mapping is always incomplete.  Only the set of users with significant usage have a entry.  This leads to only a small error in the cpu hours per domain since these users typically represent on the order of 95% of the usage.  Small users often graduate to large users over time, so the mapping must be updated on at least a yearly basis.

---+++ Some Background on Gratia Queries
There can be a significant number of hours represented by the "unknown" VO.  In most cases these records are generated by:
   1 Local jobs that are running on local resources that are part of OSG but are not "OSG" jobs.  These were submitted directly to the local batch system not via OSG.  (These are automatically excluded on sites running current Gratia probes by selecting Grid='OSG' as is done in the graph links below.)
   1 Jobs that are submitted through a local submit host that show up without a VO, but when they run they do have a VO.  Those local jobs that are OSG jobs also appear in other records with the correct VO and DN shown.  (The non-VO versions are excluded from sites running current probes by selecting !ResourceType = 'Batch' as is done in the graph links below.)

Both "unknown" and "other" VOs are removed from the query without any significant loss of hours that should be credited to OSG.

---+++ Gratia Query
One can query Gratia and compare the results with the hours shown by links in the [[#GraphsAndData][Graphs and Data]] section as a check that most of the hours are being counted.  The following is a Gratia query that will provide the non-HEP user hours for a year.  The query is easily edited to show all hours or only hours in the 'unknown' VO, etc.  
%BR%
%TWISTY%
%BR%
Go to the [[http://gratia-osg-prod-reports.opensciencegrid.org/gratia-reporting/showQuery.jsp][Gratia Query]] page and paste the query text below:
<pre class="file">
SELECT VO.VOName AS VOName,
      MSD.CommonName AS UserName,
      MSD.ProbeName,
      SUM(MSD.WallDuration)/3600 AS WallDuration,
      SUM(MSD.CpuUserDuration + MSD.CpuSystemDuration)/3600 AS cpu,
      SUM(MSD.CpuUserDuration)/3600 AS cpuUser,
      SUM(MSD.CpuSystemDuration)/3600 AS cpuSystem,
      SUM(MSD.Njobs) AS Njobs,
      Cores
FROM Site,Probe, MasterSummaryData MSD
    join VONameCorrection VC on (MSD.VOCorrid = VC.corrid)
    join VO on (VC.void = VO.void)
WHERE Probe.siteid = Site.siteid
 AND MSD.ProbeName = Probe.probename
 AND MSD.EndTime >= '2009-03-01'
 AND MSD.EndTime < '2010-03-01'
 AND ResourceType = 'Batch'
 AND Grid = 'OSG'
 AND VO.VOName NOT IN ( 'accelerator','alice','cdf','cdms','cern','cms',
   'dzero','fermilab','fgtest','geant4','gluex','ilc','ilc4c','ktev',
   'ligo','mariachi','minerva','miniboone','minos','mipp','mis','mu2e',
   'nova','numi','oiv_test1','ops','other','other EGEE','patriot','star',
   't2k.org','theory','usatlas' )
GROUP BY UserName, VOName, ProbeName, Cores
HAVING SUM(MSD.WallDuration)/3600 > 100
ORDER BY VOName, WallDuration desc;
</pre>
%ENDTWISTY%

---++ Method Used to Derive Usage by Science Domain
Graphs showing the usage over time by Science Domain are generated using the following process.
   1. Query production OSG records, excluding "unknown" and "other" VOs
   1. Develop a mapping from VO and/or specific OSG user identified by Distinguished Name (DN)
      A. Interrogate [[http://myosg.grid.iu.edu/vosummary/index?datasource=summary&summary_attrs_showfield_of_science=on&start_type=7daysago&end_type=now&all_vos=on&active_value=1][MyOSG VO Page]] (derived from OIM) to map VOs with a single science domain which is not "Community Grid".
      A. Use the file provided by engage (see above) for mapping of Engage users.  This is updated only upon request.  The contact is Mats Rynge.
      A. Use the file provided by NYSGrid (see above) for mapping of NYSGrid users.  The contact is: Steve Gallo.
      A. Use the file provided by gpn (see above) for mapping of gpn users.  Also included in this mapping are a few special cases (e.g. fgstore).  The contact is Brian Bockelman.
      A. Use the file attached to this !TWiki page where additional mappings can be added.
   1. Use the mappings from the previous step to add Science Domain to VO and/or User records
   1. Provide a data table of results with Plot of Wall hours vs. time by Science Domain
   1. Provide another data table with Plot of Wall hours vs. time by Science Domain not including HEP usage

---++ Procedure to Update (Yearly)
Given that the mapping tables from user DN to Science Domain are manually maintained, they must be updated as new users appear or existing users submit job using a new DN.  This should be done on a yearly basis or whenever the most accurate results are desired.

The format of the csv files, including the attachment to this page is:
<verbatim>
DN,/DC=...,Science Domain,Subdomain (optional)
DN,/CN=...,Science Domain,Subdomain (optional)
</verbatim>

A [[http://t2.unl.edu/gratia/xml/unclassified_users][plot or table]] is provided to get a measure of how much time is not being classified.  This can be used to identify large users that need to be classified using the various mapping tables discussed above.

#GraphsAndData
---++ Graphs and Data
%NOTE% On the graphs below, you can force the display to show only full months by changing the starttime and endtime to be the first day of a month (e.g. 20100301 00:00:00).

---+++ Wall Hours by Science Domain
View: [[http://t2.unl.edu/gratia/xml/monthly_field][Monthly Wall Hours vs. Time for all Science Domains]]

---+++ Wall hours for Non-HEP Science Domains
View: [[http://t2.unl.edu/gratia/xml/monthly_nonhep_field][Monthly Wall Hours vs. Time for Non-HEP Science Domains]]

---++ What Would Required to Have a Production View by Science

Two things need to occur to improve this system:
   1 Pilot Jobs for Community Grids need some way to report the payload job instead of the pilot job; Gratia would need to be modified in order to remove the overlapping information.  It is not easily apparent how to accomplish this.
   1 VOs would need to better integrate the field of science data into their VOMS server.  This is technically possible to do, but is difficult due to:
      * This is not built-in to the VOMS server, and would require some sort of maintenance on the VOMS server.  We do not have good VOMS documentation currently.
      * There's no accepted list of science fields; it would be difficult to make everyone use the same terminology without enforcing the constraint in VOMS (and there is no effort available for VOMS modifications).  If we allow science users to enter their own free-form text, then we must accept the fact that someone will enter the incorrect data or ignore it.

%META:FILEATTACHMENT{name="othermapping.csv" attachment="othermapping.csv" attr="" comment="Additional DN to Science Domain Mapping (Overrides DNs)" date="1269879503" path="othermapping.csv" size="435" stream="othermapping.csv" tmpFilename="/usr/tmp/CGItemp536" user="JamesWeichel" version="2"}%
