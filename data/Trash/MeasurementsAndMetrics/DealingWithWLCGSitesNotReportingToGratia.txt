%META:TOPICINFO{author="KarthikArun" date="1305764971" format="1.1" reprev="1.1" version="1.1"}%
---++Dealing with WLCG sites not reporting to gratia
%TOC%
-- Main.KarthikArun - 18 May 2011
---+++Background - WLCG MOU committments and reporting of accounting information:
Each OSG site that is part of the WLCG has a MOU committment to report their accounting data to the WLCG. This reporting is done by the Gratia APEL/WLCG interface which runs a reporting script every day in order to report the accounting data from OSG to WLCG. The APEL interface in turn extracts/obtains its data by querying the gratia database. This means in order for the APEL interface to report new data everyday to WLCG, the OSG sites have to continue reporting their accounting data to gratia everyday. The only exception to this would be when the OSG site has a downtime. If the OSG site isn't reporting to gratia, but at the same time doesn't have a downtime accounted for through the OIM, then the APEL interface detects this and raises an alert about that site not reporting accounting information to gratia. This alert is sent as an email. Below is a sample of how this alert email looks. Actually you will see the real WARNING about one or more sites reporting at the very bottom of the email. 

<pre>
Date: Mon, 16 May 2011 01:19:01 -0500
From: gratia-root@fnal.gov
To: <list of emails>
Subject: Gratia transfer to APEL (WLCG) for 2011/05 - WARNINGS/ADVISORY

Gratia to APEL/WLCG transfer.

This is normally run as a cron process.  The log files associated with this
process can provide further details.

Script............ LCG.py
Node.............. gr13x0.fnal.gov
User.............. gratia
Log file.......... /home/gratia/interfaces/apel-lcg/logs/2011-05.log
......
......
The interface from Gratia to the APEL (WLCG) database was successful.

However, the following possible problems were detected during the execution
of the interface script and should be investigated.

WARNING/ADVISORY: Purdue-RCAC missing data for more than 2 days: ['2011-05-14', '2011-05-15', '2011-05-16']
</pre>

In order to receive this alert, your email needs to be included in the APEL interface alert list. If you want to be included, please get in touch with John Weigand of Fermilab. 

---+++How to deal with the alert or WARNING/advisory
Now let us look at how to deal with this alert if you receive one.

The alert as shown above includes the site name for which the alert belongs to and the days for which the site hasn't been reporting to gratia. In order to deal with this, you need to <a href=https://ticket.grid.iu.edu/goc/resource>open up a ticket with the GOC.</a>. Once you are at the GOC site, fill in the appropriate information for the different fields. Provided below is a sample of the message body you could provide. Please be sure to change the site name and the dates for which it hasn't been reporting. 

Note: In addition you could also provide the URL for the site admin to go to and verify that the site indeed isn't reporting. For this you need to go to <a href=http://gratia-osg-prod-reports.opensciencegrid.org/gratia-reporting/>the gratia reporting page</a> and click on "Daily usage by site" link on the left hand side. Then you need to select the site name (and change the dates if needed) and bring up the bar graph (preferably in a new window by clicking on "Open in new window" button), which will verify that the site is missing data for these days). It would be handy to create a tiny url (as shown below) to paste in the goc ticket. 

<pre>
Purdue-RCAC has not been reporting to Gratia during ['2011-05-14', '2011-05-15', '2011-05-16']. 
You could verify this by going to http://tinyurl.com/3tp782s

This is affecting the data that is being reported to WLCG for MOU purposes.
We want to clarify if this is part of a planned downtime and not a
real problem before it gets too difficult to catch up.

The Gratia-APEL interface checks for sites not reporting any data in a given
day and validates that against MyOsg planned downtime before raising a warning
flag.

So, if this is part of the planned downtime period, it would help if
OIM is updated for these days.  If not, then we need to
troubleshoot the problem with Gratia reporting.
</pre>

Once this ticket is created and sent, it is expected that the site admin would follow up on the ticket. If  the site happened to have a downtime, but it wasn't scheduled, then the site admin could also enter this information into OIM, in which case the missing days would be accounted by the APEl interface. But if the reporting mechanism is broken then the site admin is expected to troubleshoot/resolve the issue that is preventing the site from reporting (if the reporting is really broken). Once the issue is resolved no more alerts would be sent by the APEL interface. 

In case the site admin couldn't figure out why gratia isn't reporting, you need to take the issue with the gratia team at fermilab to get help. Looking at the log files of gratia could be a good start. But the issue could be complicated (like some processes hanging up and preventing reporting etc.). Send email to the Gratia operations team at gratia-operation@opensciencegrid.org to request for help. 
