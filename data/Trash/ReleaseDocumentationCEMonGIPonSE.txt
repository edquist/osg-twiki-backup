%META:TOPICINFO{author="TanyaLevshina" date="1278817350" format="1.1" reprev="1.3" version="1.3"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! *<nop>%SPACEOUT{%TOPIC%}%*
%DOC_STATUS_TABLE%
%TOC{depth="2"}%


---++ Introduction
This document describes how to install and configure !CEMon and !GIP on a Storage Element.

---+++!! Applicable Versions
The applicable software versions for this document are 
%RED%
*osg-version 1.2* 
%ENDCOLOR%
(or higher) and 
%RED%
*vdt-version  a.b*
%ENDCOLOR%
(or higher).




---++ Checklist
An in-line numbered list of items assumed to have been already performed
E.g.:
   1. You storage resource should be register in OIM and are accepted in ITB or production BDII.
   1. [[ReleaseDocumentation/PacmanInstall][pacman]] version >= %PACMAN_VERSION% is required
   1. The !CEMon/GIP will be run on a machine with the same type of access to an SE that a CE normally would have.
   1. If you  use GUMS for authorization, you should be able to access existing GUMS server  or install it yourself on a different node, following [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/InstallConfigureAndManageGUMS][GUMS Server Installation Guide ]]. If you choose to use grid-mapfile for authorization you may generate it during the installation.  
   1. Ports 8080 and 8443 are not in use by any server on that node(apache is configured to use this ports)
   1. The server must have a fully qualified domain name and a valid [[ReleaseDocumentation/GetGridCertificates][grid host certificate]] installed in =/etc/grid-security/=
   1. !Tomcat server needs to have a valid service certificate. The certificate should be own by a user login that is running tomcat server.The right permission (600) should be set on those files. 

---+++!!Help!
If a problem occurs during installation or verification of the service, see [[#DebugInfo][Debugging Information]].
%BR%
If you cannot resolve the problem, the best way to get help is by following this ReleaseDocumentation.HelpProcedure.
---++ Installation Procedure
---+++ CEMon-Server and GIP installation
Login as root and check if pacman version >=%PACMAN_VERSION% is installed:
<pre class="screen">
<verbatim>
su root
cd <PACMAN3.28_LOCATION>
. setup.sh
pacman -version
</verbatim>
</pre>

Next create and change to an installation directory. This directory will later be used to get the !CEMon-Server package  from the VDT test cache.
<pre class="screen">
mkdir /opt/vdt_cemon
cd /opt/vdt_cemon
</pre>

Finally execute pacman to get the !CEMon-Server package from the VDT test  cache. Pacman will ask whether you want to trust the cache (=yall=) and whether you want to accept the license (=y=).
<pre class="screen">
pacman -get http://vdt.cs.wisc.edu/test-cache/se-info:CEMon-Server
</pre>
The install procedure will print out a warning:
<verbatim>
Do you want to add [http://vdt.cs.wisc.edu/test-cache/se-info] to [trusted.caches]? (y/n/yall): yall
Beginning VDT prerequisite checking script vdt-common/vdt-prereq-check...           

The VDT installs a variety of software, each with its own license.
In order to continue, you must agree to the licenses.
You can view the licenses online at:

    http://vdt.cs.wisc.edu/licenses/

After the installation has completed, you will also be able to
view the licenses in the "licenses" directory.

Do you agree to the licenses? [y/n]
y
All prerequisite checks are satisfied.
</verbatim>
Please setup the CA certificates in the following way instead:
<pre class="screen">
source setup.sh
$VDT_LOCATION/vdt/bin/vdt-ca-manage setupca --location local -url osg
</pre>
This command will download certificates distributed by the OSG to =$VDT_LOCATION/globus/share/certificates= and create a symlink from =$VDT_LOCATION/globus/TRUSTED_CA= to that location. [[VDTCAManage][Other options]] are also available.

To reflect the changes update the environment and run the post installation script:
<pre class="screen">
vdt-post-install
</pre>
---+++ Configuring CEMon-Server 
In order to configure CEMon-Server you have to run ==vdt_cemon_configure script and specified what servers should receive information from !CEMon and in what format:
<pre class="screen">
 $VDT_LOCATION/vdt/setup/configure_cemon --server y --consumer http://is-itb1.grid.iu.edu:14001 --topic OSG_CE --dialect RAW
The following consumer subscription has been installed:
        HOST:    http://is-itb1.grid.iu.edu:14001
        TOPIC:   OSG_CE
        DIALECT: RAW
$VDT_LOCATION/vdt/setup/configure_cemon --server y --consumer http://is-itb2.grid.iu.edu:14001 --topic OSG_CE --dialect RAW
The following consumer subscription has been installed:
        HOST:    http://is-itb2.grid.iu.edu:14001
        TOPIC:   OSG_CE
        DIALECT: RAW
</pre>

Now, you have to edit ==$VDT_LOCATION/glite/etc/glite-ce-ce-plugin/glite-ce-info== that will be periodically executed by !CEMon server.  This is a wrapper script for collecting GIP data.
The file contains:
<pre class='file'>
#!/bin/sh
sleep 1
</pre>

This should be replaced with the following content:
<pre class='file'>
#!/bin/sh
/opt/vdt_cemon/gip/bin/run_gip.sh  2> /dev/null
</pre>

---+++Configuring GIP 
Now, you have to configure GIP. Several manual steps are required to do so:
   1. Create ==gip.conf== file.<pre class="screen">
cd $VDT_LOCATION/gip/etc
cp  gip.se_only.example.conf  gip.conf
</pre>
   1. Edit ==gip.conf== file and modify this content:<pre class="file">
[gip]
override = False
check_osg = False
osg_config = /put/your/path/here/gip/etc/config.ini

[vo]
user_vo_map = /put/your/path/here/gip/etc/osg-user-vo-map.txt
</pre>the following way:<pre class="file">
[gip]
override = False
check_osg = False
osg_config = /opt/vdt_cemon/gip/etc/config.ini

[vo]
user_vo_map = /opt/vdt_cemon/monitoring/osg-user-vo-map.txt
</pre>
   1. Fill out a config.ini for the SE only site.  The known minimum sections are: DEFAULT, Site Information, Storage, GIP, and SE <name>. See the OSG twiki for specific help on each of the sections.
    * the Storage section only needs:<pre class="file">
<verbatim>
        se_available = %(enable)s
        default_se = <se fqdn>
</verbatim>
</pre>
    * the GIP section only needs:<pre class="file">
<verbatim> 
        advertise_gsiftp = %(disable)s
</verbatim>
</pre> In order to modify the file you will need first to copy ==config.ini.se_only.example== to ==config.ini== first.<pre class="screen">
cp config.ini.se_only.example config.ini
vi config.ini.se
</pre> You will need to modify ==config,ini== accordingly following the instruction given above. Here are two examples for !dCache  installation: %TWISTY%<pre class="file">
[DEFAULT]
unavailable = UNAVAILABLE
default = UNAVAILABLE
disable = False
enable = True
localhost = fg0x5.fnal.gov
admin_email = tlevshin@fnal.gov
osg_location = /opt/vdt_cemon

[Site Information]
resource =  FNAL-ITB-GIP-TEST1
resource_group =  FNAL-ITB-GIP-TEST1
sponsor = cms:100
site_policy = http://www.uscms.org/SoftwareComputing/Grid/Policy/OSG_VO.html
contact = cms-t1@fnal.gov
city = Batavia, IL
country = USA
longitude = -88.2546
latitude = 41.8412
group = OSG-ITB
email = %(admin_email)s
host_name = %(localhost)s

[Storage]
se_available = %(enable)s
default_se = cmssrm.fnal.gov

[GIP]
advertise_gsiftp = %(disable)s
advertise_accesspoints = False

[SE dCache]
enabled = True
name = cmssrm.fnal.gov
srm_endpoint = httpg://gwdca04.fnal.gov:8443/srm/managerv2
provider_implementation = dcache19
implementation = dcache
version = 1.9.5-19
default_path = /
infoprovider_endpoint = http://gwdca06.fnal.gov/site/info
spaces = flushPools,ResilientPools,LFSOnlyPools,ReadOnlyPools,stagePools
space_stagePools_vos = cms,mis
space_ReadOnlyPools_vos = cms,mis
space_LFSOnlyPools_vos = cms,mis
space_ResilientPools_vos = cms,mis
space_flushPools_vos = cms,mis
space_flushPools_path = mis:/NotWrittenToTape,ops:/NotWrittenToTape
space_ResilientPools_path = mis:/NotWrittenToTape,ops:/NotWrittenToTape
space_LFSOnlyPools_path = mis:/NotWrittenToTape,ops:/NotWrittenToTape
space_ReadOnlyPools_path = mis:/NotWrittenToTape,ops:/NotWrittenToTape
space_stagePools_path = mis:/NotWrittenToTape,ops:/NotWrittenToTape
</pre>%ENDTWISTY% or  !BeStMan installation:%TWISTY%<pre class="file">
[DEFAULT]
unavailable = UNAVAILABLE
default = UNAVAILABLE
disable = False
enable = True
localhost = fg0x5.fnal.gov
admin_email = tlevshin@fnal.gov
osg_location = /opt/vdt_cemon

[Site Information]
resource = FNAL-ITB-GIP-TEST1
resource_group = FNAL-ITB-GIP-TEST1
sponsor = cms:100
site_policy = http://www.uscms.org/SoftwareComputing/Grid/Policy/OSG_VO.html
contact = tlevshin@fnal.gov
city = Batavia, IL
country = USA
longitude = -88.2546
latitude = 41.8412
group = OSG-ITB
email = %(admin_email)s
host_name = %(localhost)s

[Storage]
se_available = %(enable)s
default_se = fg0x5.fnal.gov

[GIP]
advertise_gsiftp = %(disable)s
advertise_accesspoints = False

[SE BeStMan]
enabled = True
name = fg0x5.fnal.gov
srm_endpoint = httpg://fg0x5.fnal.gov:10443/srm/v2/server
provider_implementation = BeStMan
implementation = BeStMan
version = 2.2.2.0.0
default_path = /cache
</pre>%ENDTWISTY%
   1. Prepare ==run_gip.sh== script: %NOTE% The original file has a typo. Please follow this example!<pre class="screen">
cd $VDT_LOCATION/gip/bin
cp  run_gip.sh.se_only.example  run_gip.sh
vi run_gip.sh
</pre>modify ==run_gip.sh== accordingly:<pre class="file">
export VDT_LOCATION=/opt/vdt_cemon
export GIP_LOCATION=/opt/vdt_cemon/gip
$GIP_LOCATION/bin/gip_info
</pre>
   1. You will need to set right permission on ==$VDT_LOCATION/gip/var== directory. It should belong to the user that is running tomcat service (==daemon==).<pre class="screen">
cd $VDT_LOCATION/gip
chown daemon.daemon var
</pre>

---+++ Installation of   OSG User-VO Mapping 

Please read  [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/OsgSupportedVos][this page]] about files that are required to accurately collect grid resource usage and metrics by VO for transfer submitted using grid proxies or where voms proxy information is not available. 


You may choose to  install VO-Map-Utilities from VDT in the same directory you have installed !CEMon. If you choose to install it in the other directory you will need to modify ==user_vo_map== in  the ==$VDT_LOCATION/gip/etc/gip.conf== file.

You have to decide if you are going to use gridmap-file or GUMS for user-vo mapping and answer appropriately questions asked during package installation. 

If you are using GUMS, setup VDT_GUMS_HOST:
<pre class="screen">
<verbatim>
export VDT_GUMS_HOST=<GUMS hostname>  
</verbatim>
</pre>

The next step is to install vo-map-utilities:

<pre class="screen">
cd $VDT_LOCATION
pacman -get  %CACHE%:VO-Map-Utilities
. setup.sh
</pre>

 Pacman will ask whether you want to trust the cache and updater. (=yall=).

The install procedure will print out a warning:
<verbatim>
Do you want to add [http://software.grid.iu.edu/osg-1.2] to [trusted.caches]? (y/n/yall): yall
OK to overwrite [/opt/vdt_cemon/vdt/update/vdt-updater] untarring [/opt/vdt_cemon/vdt-updater-2.0.0p18-2.tar.gz]? (y/n/yall): yall
WARNING: Untarring tarball [/opt/vdt_cemon/vdt-updater-2.0.0p18-2.tar.gz] will overwrite [/opt/vdt_cemon/vdt/update/vdt-updater]...

</verbatim>

To reflect the changes update the environment and run the post installation script:
<pre class="screen">
vdt-post-install
</pre>

You will have to enable and start all the services related to user-vo mapping:

   * if you are using GUMS
<pre class="screen">
vdt-control -enable gums-host-cron
vdt-control -on gums-host-cron
touch $VDT_LOCATION/monitoring/osg-attributes.conf
$VDT_LOCATION/gums/scripts/gums-host-cron
</pre>

   * if you are using edg-grid-map file
<pre class="screen">
vdt-control -enable edg-mkgridmap
vdt-control -on edg-mkgridmap
</pre>


Check that osg-user-vo-map.txt is present and not empty, eg:
<pre class="screen">
ls -l   $VDT_LOCATION/monitoring/osg-user-vo-map.txt
-rw-r--r--  1 root root 6224 Apr 14 14:23 /opt/vdt_vomap/monitoring/osg-user-vo-map.txt
</pre>

---+++ Enabling Services
You will need to enable several services before you can start !CEMon service. Check what services have been installed:
<pre class="screen">
 vdt-control --list
Service                 | Type   | Desired State
------------------------+--------+--------------
fetch-crl               | cron   | do not enable
vdt-rotate-logs         | cron   | do not enable
vdt-update-certs        | cron   | do not enable
apache                  | init   | enable
tomcat-55               | init   | enable
gums-host-cron          | cron   | enable
edg-mkgridmap           | cron   | do not enable

</pre>

Enable services:
<pre class="screen">
vdt-control --enable fetch-crl  vdt-rotate-logs   vdt-update-certs
running 'vdt-register-service --name fetch-crl --enable'... ok
running 'vdt-register-service --name vdt-rotate-logs --enable'... ok
running 'vdt-register-service --name vdt-update-certs --enable'... ok
</pre> 
---++ Services /Startup/Shutdown

Start services do:

<pre class="screen">
vdt-control --on
enabling cron service fetch-crl... ok
enabling cron service vdt-rotate-logs... ok
enabling cron service vdt-update-certs... ok
enabling init service apache... ok
enabling init service tomcat-55... ok
enabling cron service gums-host-cron... ok
</pre>

To stop services 
<pre class="screen">
vdt-control --off
</pre>

---++ Validation of Service Operation
Commands to be used to verify the service is working correctly.  This can be combined with the previous section if they are both short.

#DebugInfo
---++ Debugging Information

---+++!!Caveats/Known Issues
%NOTE% For some reason the directories that are created under ==$VDT_LOCATION/gip/var== on start up are belong to user ==root==. You have to do the following before the system can function normally.
<pre class="screen">
cd $VDT_LOCATION/gip
chown -R daemon.daemon var
</pre>

---+++!!File Locations
You could find log and configuration files for each of the module in the following location: 

| *Module Name* |  *Configuration files* | *Log files* | 
|!CEMon | $VDT_LOCATION/glite/etc/glite-ce-monitor/cemonitor-config.xml </br>$VDT_LOCATION/tomcat/v55/conf/Catalina/localhost/ce-monitor.xml  | $VDT_LOCATION/glite/var/log/glite-ce-monitor.log | 
|!GIP |$VDT_LOCATION/gip/etc/gip.conf</br>$VDT_LOCATION/gip/etc/gip.conf| $VDT_LOCATION/gip/var/log|
|Tomcat|$VDT_LOCATION/tomcat/v55/lconf/server.xml|$VDT_LOCATION/tomcat/v55/logs/catalina.out|

---+++!!Open Ports
The following ports are opened for the installed services
|*Module Name*|*Port Number*| *Protocol*|
|!Apache| 8080| tcp|
|8443||tcp|
|!Tomcat|8943|tcp|

---+++!!Debugging Procedure
   1. Check if information becomes available in [[http://is-itb1.grid.iu.edu/cgi-bin/status.cgi?grid_type=OSG-ITB][ITB BDII]] ten minutes after you have started the service.  
   1. Check the output of !CEMon server, you should see something like the following:<pre class="screen">
tail -f $VDT_LOCATION/glite/var/log
10 Jul 2010 21:12:54,886 org.glite.ce.monitor.CEMonitorService - doOnResourceEvent() - added new subscription [id = subscription-http___is-itb2_grid_iu_edu_14001-OSG_CE-RAW]
10 Jul 2010 21:12:54,890 org.glite.ce.monitor.CEMonitorService - doOnResourceEvent() - added new subscription [id = subscription-http___is-itb1_grid_iu_edu_14001-OSG_CE-RAW]
10 Jul 2010 21:12:54,912 org.glite.ce.monitor.holder.NotificationHolder - [name=subscription-http___is-itb2_grid_iu_edu_14001-OSG_CE-RAW] - sending notification (containing 1 events) to http://is-itb2.grid.iu.edu:14001 ...
10 Jul 2010 21:12:54,914 org.glite.ce.monitor.holder.NotificationHolder - [name=subscription-http___is-itb1_grid_iu_edu_14001-OSG_CE-RAW] - sending notification (containing 1 events) to http://is-itb1.grid.iu.edu:14001 ...
10 Jul 2010 21:12:55,310 org.glite.ce.monitor.holder.NotificationHolder - [name=subscription-http___is-itb1_grid_iu_edu_14001-OSG_CE-RAW] - [done]
10 Jul 2010 21:12:55,313 org.glite.ce.monitor.holder.NotificationHolder - [name=subscription-http___is-itb2_grid_iu_edu_14001-OSG_CE-RAW] - [done]
</pre>
   1. Try to run ==$VDT_LOCATION/gip/etc/run_gip.sh== manually as user daemon. You should see something like that:
%TWISTY%
<pre class="screen">
$VDT_LOCATION/gip/bin/run_gip.sh 2>/dev/null
dn: GlueSEUniqueID=fg0x5.fnal.gov,Mds-Vo-name=local,o=grid
objectClass: GlueInformationService
objectClass: GlueKey
objectClass: GlueSE
objectClass: GlueSETop
objectClass: GlueSchemaVersion
GlueSEPort: 8443
GlueSchemaVersionMajor: 1
GlueSchemaVersionMinor: 3
GlueSEImplementationVersion: 2.2.2.0.0
GlueSETotalNearlineSize: 0
GlueSEName: fg0x5.fnal.gov
GlueSEArchitecture: disk
GlueSESizeTotal: 9
GlueSETotalOnlineSize: 9
GlueSEImplementationName: BeStMan
GlueSEUsedOnlineSize: 8
GlueForeignKey: GlueSiteUniqueID=FNAL-ITB-GIP-TEST1
GlueSEUsedNearlineSize: 0
GlueSEStatus: Production
GlueSEUniqueID: fg0x5.fnal.gov
GlueSESizeFree: 1
GlueInformationServiceURL: ldap://is.grid.iu.edu:2170

dn: GlueSALocalID=default,GlueSEUniqueID=fg0x5.fnal.gov,Mds-Vo-name=local,o=grid
objectClass: GlueKey
objectClass: GlueSA
objectClass: GlueSAAccessControlBase
objectClass: GlueSAPolicy
objectClass: GlueSAState
objectClass: GlueSATop
objectClass: GlueSchemaVersion
GlueSATotalOnlineSize: 9
GlueSAPolicyMaxNumFiles: 0
GlueSAFreeNearlineSize: 0
GlueSchemaVersionMajor: 1
GlueSAUsedNearlineSize: 0
GlueSAExpirationMode: neverExpire
GlueSAAccessLatency: online
GlueSchemaVersionMinor: 3
GlueSAStateUsedSpace: 8292044
....
</pre>
%ENDTWISTY%
---+++!!References
References to additional information.  This document should be as concise as possible, but the reader can use these links if he/she wants more background or information.

---+++!!Screen Dump of the Complete Install Process
%TWISTY{
mode="div"
showlink="Show..."
hidelink="Hide"
showimgleft="%ICONURLPATH{toggleopen-small}%"
hideimgleft="%ICONURLPATH{toggleclose-small}%"
}%
<pre class="screen">
complete screen dump of the install procedure
</pre>
%ENDTWISTY%

---++ *Comments*
%COMMENT{type="tableappend"}%

<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = TanyaLevshina

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = Storage

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = Installation
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %YES%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %YES%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       =  SuchandraThapa
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %IN_PROGRESS%


 DEAR DOCUMENT TESTER
 ====================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         =   	 HironoriIto
 Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %IN_PROGRESS%
############################################################################################################
-->
-- Main.JamesWeichel - 03 Feb 2010
