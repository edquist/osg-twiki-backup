%META:TOPICINFO{author="GregorySharp" date="1169559817" format="1.1" reprev="1.1" version="1.1"}%
%META:TOPICPARENT{name="GregSharp"}%
*dCache release*: 1.7

*Symptom*:

The Billing Cell drops billing messages to the sql database if there is a transient break in the connection to the database.
It should retry the write to the database.

*Diagnosis*:

In =modules/dCache/diskCacheV111/cells/BillingCell.java=, starting around line 277, we find the code

<verbatim>
             say("Trying to reconnect");
             try {
                 _sqlLog = new BillingDB(_args);
             } catch( SQLException sqe2) {
</verbatim>

This code attempts to call =_sqlLog.log()=. If it fails, it reconnects to the billing database by creating a new instance of the database, but it does *NOT* retry the call to =_sqlLog.log()=. So, in the event of failure, it drops a log message on the floor.

*Proposed Resolution*:

Change the reconnect code to be:

<verbatim>
             say("Trying to reconnect");
             try {
                 _sqlLog = new BillingDB(_args);
                 _sqlLog.log(info);                         // Add this line
             } catch( SQLException sqe2) {
</verbatim>


-- Main.GregorySharp - 23 Jan 2007
