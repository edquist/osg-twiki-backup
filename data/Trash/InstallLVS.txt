%META:TOPICINFO{author="BrianLin" date="1482338290" format="1.1" version="1.10"}%
<style type="text/css">
code em, pre em { color: red; font-weight: normal; font-style: normal; }
</style>

---+ Installing and Maintaining a Linux Virtual Server [DRAFT]

%TOC{depth="3"}%

---++ About This Guide

A [[http://www.linuxvirtualserver.org/whatis.html][Linux Virtual Server]] (LVS) is a cluster of nodes consisting of one or more _load balancers_ distributing requests among multiple _real servers_, giving the appearance of a single high-performance host. In the most basic LVS setup, a single load balancer listening on a virtual IP address monitors the health of its real servers and forwards requests to the available ones. A highly-available LVS has at least one inactive, backup load balancer that activates itself by taking over the virtual IP address in the case of primary load balancer failure.

LVS is implemented by the [[http://www.linuxvirtualserver.org/software/ipvs.html][IP Virtual Server]] (IPVS) kernel module, which can be managed by userspace services on the load balancers such as [[http://www.keepalived.org][keepalived]]. This guide will cover how to install, configure, run, test, and troubleshoot the =keepalived= service on a load balancing host for a set of [[Documentation.Release3/InstallOSGGridFTP][GridFTP]] real servers.

---++ Before Starting

%INCLUDE{"Documentation/Release3.DocumentationSnippets" section="OsgPreReqs"}%

---++ Installing Keepalived

=keepalived= should be available through the core OS repos. Install it on your *load balancers* via the following commands:

<ol>
%INCLUDE{"Documentation/Release3/OSGReleaseSeries" section="Update"}%
  <li>
    <p>Install the =keepalived= package:</p>
    <pre class="rootscreen">yum install keepalived</pre>
  </li>
</ol>


---++ Configuring Your Load Balancers

For an LVS with a single load balancer and real server, edit =/etc/keepalived/keepalived.conf=:

<pre class="file">global_defs {
   router_id <span style="background-color: #FFCCFF;">&lt;Name for your LVS&gt;</span>
}

vrrp_instance VI_gridftp {
    state MASTER
    interface <span style="background-color: #FFCCFF;">&lt;Interface (e.g. eth0)&gt;</span>
    virtual_router_id <span style="background-color: #FFCCFF;">&lt;Arbitrary # between 0 and 255&gt;</span>
    priority 100
    virtual_ipaddress {
        <span style="background-color: #FFCCFF;">&lt;Virtual IP Address&gt;</span>/<span style="background-color: #FFCCFF;">&lt;Subnet Mask&gt;</span> dev <span style="background-color: #FFCCFF;">&lt;Interface (e.g. eth0)&gt;</span>
    }
}

virtual_server <span style="background-color: #FFCCFF;">&lt;Virtual IP Address&gt;</span> 2811{
    delay_loop 10
    lb_algo wlc
    lb_kind DR
    protocol tcp

    real_server <span style="background-color: #FFCCFF;">&lt;GridFTP IP Address&gt;</span> 2811 {
        TCP_CHECK {
            connect_timeout 3
        }
    }
}
</pre>

%NOTE% Use the same *Virtual IP Address* throughout your LVS configuration.

Insert additional =real_server= stanzas within the =virtual_server= section for each !GridFTP server you wish to load-balance.

#OptionalConfig
---+++ Optional Configuration

The following configuration steps are optional and will likely not be required for setting up a small cluster of !GridFTP hosts. If you do not need any of the following special configurations, skip to [[#ConfigureReal][the section on configuring your real servers]].

   * [[#BackupLoadBalancers][Adding backup load balancers]]
   * [[#EmailNotifications][Enabling e-mail notifications]]

#BackupLoadBalancers
---++++ Adding backup load balancers

If you need to add backup load balancers, copy =/etc/keepalived/keepalived.conf= from your primary load balancer and change the =state= and priority attributes under your =vrrp_instance VI_gridftp= section:

<pre class="file">vrrp_instance VI_gridftp {
    state <span style="background-color: #FFCCFF;">&lt;BACKUP&gt;</span>
    interface <span style="background-color: #FFCCFF;">&lt;Interface (e.g. eth0)&gt;</span>
    virtual_router_id <span style="background-color: #FFCCFF;">&lt;Arbitrary # between 0 and 255&gt;</span>
    priority <span style="background-color: #FFCCFF;">&lt;50&gt;</span>
    virtual_ipaddress {
        <span style="background-color: #FFCCFF;">&lt;Virtual IP Address&gt;</span>/<span style="background-color: #FFCCFF;">&lt;Subnet Mask&gt;</span> dev <span style="background-color: #FFCCFF;">&lt;Interface (e.g. eth0)&gt;</span>
    }
}
</pre>

#EmailNotifications
---++++ Enabling e-mail notifications

To receive e-mails when the state of your LVS cluster changes, update the =global_defs= section of =/etc/keepalived/keepalived.conf= for each of your load balancer nodes:

<pre class="file">
notification_email {
<span style="background-color: #FFCCFF;">admin@example.com</span>
<span style="background-color: #FFCCFF;">admin2@example.com</span>
<span style="background-color: #FFCCFF;">...</span>
}
notification_email_from <span style="background-color: #FFCCFF;">noreply@example.com</span>
smtp_server <span style="background-color: #FFCCFF;">127.0.0.1</span>
smtp_connect_timeout 60
router_id <span style="background-color: #FFCCFF;">&lt;Machine identifying string&gt;</span>
</pre>

#ConfigureReal
---++ Configuring Your Real Servers

Each real server requires changes to its IP configuration and potentially its arptables: 

   * [[#AddingVIP][Adding your virtual IP address]]
   * [[#DisableArp][Disabling ARP]] &minus; if your real servers are on the same network as the virtual IP

#AddingVIP
---+++ Adding your virtual IP address

Use the same virtual IP address as your load balancers as the secondary IP on your real servers. Add it using the =ip= tool:

<pre class="rootscreen">%UCL_PROMPT_ROOT% ip addr add <span style="background-color: #D1CAF2;">&lt;Virtual IP Address&gt;</span>/<span style="background-color: #D1CAF2;">&lt;Subnet Mask&gt;</span> dev <span style="background-color: #D1CAF2;">&lt;Interface (e.g. eth0)&gt;</span></pre>

TODO: How to persist across reboots?

#DisableArp
---+++ Disabling ARP

If your real servers are only listening on the same network as your virtual IP address, skip to [[#UsingKeepalived][the section on using keepalived]]. If your real servers and load balancer(s) are on the same public network, you will have to disable ARP on the real servers to avoid [[http://kb.linuxvirtualserver.org/wiki/ARP_Issues_in_LVS/DR_and_LVS/TUN_Clusters][ARP race conditions]]:

   1. Install =arptables= package: \
<pre class="rootscreen">%UCL_PROMPT_ROOT% yum install arptables_nf</pre>
   1. Disable ARP: \
<pre class="rootscreen">%UCL_PROMPT_ROOT% arptables -F
%UCL_PROMPT_ROOT% arptables -A IN -d <span style="background-color: #D1CAF2;">&lt;Virtual IP Address&gt;</span> -j DROP
%UCL_PROMPT_ROOT% arptables -A OUT -s <span style="background-color: #D1CAF2;">&lt;$VIP&gt;</span> -j mangle --mangle-ip-s <span style="background-color: #D1CAF2;">&lt;Real IP address&gt;</span></pre>
   1. Save ARP tables to survive reboots:\
<pre class="rootscreen">%UCL_PROMPT_ROOT% arptables-save > /etc/sysconfig/arptables</pre>

#UsingKeepalived
---++ Using Keepalived

---+++ Managing keepalived and associated services

%TABLE{sort="off"}%
| *Software* | *Service name* | *Notes* |
| Keepalived | =keepalived= | |

%INCLUDE{"Documentation/Release3.DocumentationSnippets" section="ServiceManagement"}%

---++ Getting Help

To get assistance with =keepalived= in front of OSG Software services, please use the [[Documentation.HelpProcedure][this page]].

#ReferenceSection
---++ Reference

   * [[http://www.linuxvirtualserver.org/whatis.html][Linux Virtual Server homepage]]
   * [[http://www.keepalived.org/index.html][Keepalived homepage]]
   * [[https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Load_Balancer_Administration/index.html][RHEL 7 Load Balancer Administration Guide]]
   * [[https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Load_Balancer_Administration/index.html][RHEL 6 Load Balancer Administration Guide]]
   * [[https://github.com/gattebury/gridftp-with-lvs][T2 Nebraska LVS installation notes]]
