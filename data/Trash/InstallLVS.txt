%META:TOPICINFO{author="BrianLin" date="1482186334" format="1.1" version="1.8"}%
<style type="text/css">
code em, pre em { color: red; font-weight: normal; font-style: normal; }
</style>

---+ Installing and Maintaining a Linux Virtual Server [DRAFT]

%TOC{depth="3"}%

---++ About This Guide

A [[http://www.linuxvirtualserver.org/whatis.html][Linux Virtual Server]] (LVS) is a cluster of nodes consisting of one or more _load balancers_ distributing requests among multiple _real servers_, giving the appearance of a single high-performance host. In the most basic LVS setup, a single load balancer listening on a virtual IP address monitors the health of its real servers and forwards requests to the available ones. A highly-available LVS has at least one inactive, backup load balancer that activates itself by taking over the virtual IP address in the case of primary load balancer failure.

LVS is implemented by the [[http://www.linuxvirtualserver.org/software/ipvs.html][IP Virtual Server]] (IPVS) kernel module, which can be managed by userspace services on the load balancers such as [[http://www.keepalived.org][keepalived]]. This guide will cover how to install, configure, run, test, and troubleshoot the =keepalived= service on a load balancing host for a set of [[Documentation.Release3/InstallOSGGridFTP][GridFTP]] real servers.

---++ Before Starting

%INCLUDE{"Documentation/Release3.DocumentationSnippets" section="OsgPreReqs"}%

---++ Installing Keepalived

=keepalived= is available through the core OS repos. Install it via the following commands:

<ol>
%INCLUDE{"Documentation/Release3/OSGReleaseSeries" section="Update"}%
  <li>
    <p>Install the =keepalived= package:</p>
    <pre class="rootscreen">yum install keepalived</pre>
  </li>
</ol>


---++ Configuring your Linux Virtual Server


---+++ Configuring Keepalived

<pre class="file">virtual_server <span style="background-color: #FFCCFF;">&lt;Virtual IP Address&gt;</span> 2811{
    delay_loop 10
    lb_algo wlc
    lb_kind DR
    protocol tcp

    real_server <span style="background-color: #FFCCFF;">&lt;GridFTP IP Address&gt;</span> 2811 {
        TCP_CHECK {
                connect_timeout 3
        }
    }
}
</pre>

Insert additional =real_server= stanzas for each !GridFTP server you wish to load-balance.

---+++ Disabling ARP on your real servers

If your real servers and load balancer(s) are on the same public network, you will have to disable ARP on the real servers to avoid [[http://kb.linuxvirtualserver.org/wiki/ARP_Issues_in_LVS/DR_and_LVS/TUN_Clusters][ARP race conditions]].

---+++ Optional Configuration

The following configuration steps are optional will likely not be required for setting up a small cluster of !GridFTP hosts. If you do not need any of the following special configurations, skip to [[#UsingKeepalived][the section on using keepalived]].

   * [[#BackupLVS][Adding backup Virtual Servers]]
   * [[#EmailNotifications][Enabling e-mail notifications]]

#BackupLVS
---++++ Adding backup Virtual Servers



<pre class="file">vrrp_sync_group VG1 {
   group {
      RH_EXT
      RH_INT
   }
}

vrrp_instance RH_EXT {
    state MASTER
    interface eth0
    virtual_router_id 50
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
	auth_pass password123
    }
    virtual_ipaddress {
    10.0.0.1
    }
}

vrrp_instance RH_INT {
   state MASTER
   interface eth1
   virtual_router_id 2
   priority 100
   advert_int 1
   authentication {
       auth_type PASS
       auth_pass password123
   }
   virtual_ipaddress {
       192.168.1.1
   }
}</pre>

#EmailNotifications
---++++ Enabling e-mail notifications

To receive e-mails when the state of your LVS cluster changes, update the =global_defs= section of =/etc/keepalived/keepalived.conf= for each of your load balancer nodes:

<pre class="file">
global_defs {

   notification_email {
       <span style="background-color: #FFCCFF;">admin@example.com</span>
       <span style="background-color: #FFCCFF;">admin2@example.com</span>
       <span style="background-color: #FFCCFF;">...</span>
   }
   notification_email_from <span style="background-color: #FFCCFF;">noreply@example.com</span>
   smtp_server <span style="background-color: #FFCCFF;">127.0.0.1</span>
   smtp_connect_timeout 60
   router_id <span style="background-color: #FFCCFF;">&lt;Machine identifying string&gt;</span>
}
</pre>

#UsingKeepalived
---++ Using Keepalived

---+++ Managing keepalived and associated services

%TABLE{sort="off"}%
| *Software* | *Service name* | *Notes* |
| Keepalived | =keepalived= | |

%INCLUDE{"Documentation/Release3.DocumentationSnippets" section="ServiceManagement"}%

---++ Troubleshooting Keepalived

---++ Getting Help

To get assistance with =keepalived= in front of OSG Software services, please use the [[Documentation.HelpProcedure][this page]].

#ReferenceSection
---++ Reference

   * [[http://www.linuxvirtualserver.org/whatis.html][Linux Virtual Server homepage]]
   * [[http://www.keepalived.org/index.html][Keepalived homepage]]
   * [[https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Load_Balancer_Administration/index.html][RHEL 7 Load Balancer Administration Guide]]
   * [[https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Load_Balancer_Administration/index.html][RHEL 6 Load Balancer Administration Guide]]
   * [[https://github.com/gattebury/gridftp-with-lvs][T2 Nebraska LVS installation notes]]
