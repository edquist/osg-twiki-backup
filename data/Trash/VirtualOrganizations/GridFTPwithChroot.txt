%META:TOPICINFO{author="TanyaLevshina" date="1352841321" format="1.1" reprev="1.1" version="1.1"}%
%META:TOPICPARENT{name="DESUserAccess"}%
---+!! How To Setup !GridFtp Server with chroot
%TOC%
---++ Requirements 
   1. DES user should have limited access to output data root directory and subdirectories. They can not browse any directory via gridftp server.

---++ Administrator's Tasks

   1. Install standalone grdiftp server by following this  [[https://twiki.grid.iu.edu/bin/view/Documentation/Release3/InstallOSGGridFTP][instructions]] - no edg-makegridmap, no gums
   1. decide  where to make ROOT_DIR for desreader <pre class="rootscreen">
$export ROOT_DIR=%RED%/opt/desreader%ENDCOLOR%
$mkdir $ROOT_DIR
</pre>
   1. execute ==globus-gridftp-server-setup-chroot== <pre class="rootscreen">
$/usr/sbin/globus-gridftp-server-setup-chroot -c /etc/grid-security/certificates/ -r $ROOT_DIR
</pre>
   1. create "datadir" directory under  ROOT_DIR <pre class="rootscreen">
$mkdir $ROOT_DIR/datadir
 </pre>
   1. mount   /blue-orch/DTS/output<pre class="rootscreen">
$mount --bind /blue-orch/DTS/output  $ROOT_DIR/datadir
</pre>
   1. in ==/etc/passwd== and ==$ROOT_DIR/etc/passwd== modify desreader home area to /desreader<pre class="file">
$desreader:x:1234:999:NCSA DESDM:/datadir:/sbin/nologin
    </pre>
   1. modify ==/etc/init.d/globus-gridftp-server== in two places (in ==start== function and ==start-lsb== function) by adding <pre class="file">
$gridftpd -S -c $conf -C $confdir -pidfile "${pidfile}"
</pre> chroot-path command line option:<pre class="file">
$gridftpd -S -c $conf -C $confdir -pidfile "${pidfile}"  -chroot-path %RED%ROOT_DIR%ENDCOLOR%
</pre>
   1. restart server<pre class="rootscreen">
$service globus-gridftp-server start
</pre>
   1. make sure that you have right mapping in gridmapfiler<pre class="file">
"/DC=org/DC=doegrids/OU=Services/CN=desreader/desxxx.fnal.gov" desreader
</pre>
---++ Verification
   1. Verify that grdftp server is running and chroot-path is set <pre class="rootscreen">
$ps auxww|grep gridftp
%BLUE%root     14069  0.0  0.1  98256  3496 ?        Ss   14:50   0:00 /usr/sbin/globus-gridftp-server -c /etc/gridftp.conf -C /etc/gridftp.d -pidfile /var/run/globus-gridftp-server.pid -chroot-path %RED%ROOT_DIR%ENDCOLOR% -no-detach%ENDCOLOR%</pre>
   1. login as a non-root user, get proxy certificate from ==myproxy.ncsa.uiuc.edu== that is mapped to desreader user<pre class="screen">
uberftp des08.fnal.gov
ls
get some_file
</pre>




-- Main.TanyaLevshina - 13 Nov 2012
