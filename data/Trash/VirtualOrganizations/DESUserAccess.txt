%META:TOPICINFO{author="TanyaLevshina" date="1352908827" format="1.1" version="1.7"}%
---+!! How To Setup Limited Access to DES Data
%TOC%

---++ Requirements 
   1. This is a temporary service that should be available ~30-60 days
   1. The number of users is limited. In general, users don't have certificates and don't have access to fermilab site
   1. The users will have READ ONLY access to the produced sets of output data


Proposed solution: Use globus connect/globus-online mechanism to allow users access to the above mentioned output data.
---++ Administrator's Tasks
This will require the following preliminary steps from a administrator:

   1. setup gridftp server with gridmapfile authentication (Brian has mentioned that des09.fnal.gov could be used and we need to coordinate this with Nikolay). The instruction how to setup a standalone grdiftp server could be found [[https://twiki.grid.iu.edu/bin/view/Documentation/Release3/InstallOSGGridFTP][here]].  We have setup a new gridftp server with chroot, so user can access only specified area. The instruction is provided [[GridFTPwithChroot][here]].
   1. mount bluearc /des/orchestration area on this machine
   1. create a unix user (==%RED%desuser%ENDCOLOR%==) on the gridftp server machine, allow read ONLY access to  /des/orchestration/DTS/%RED%output-data%ENDCOLOR% directory
   1. request and obtain service certificate by following [[https://www.opensciencegrid.org/bin/view/Documentation/Release3/GetHostServiceCertificates#Send_the_request_AN1][this instruction]]%BLUE%Steve Timm has created server certificate ==/DC=org/DC=doegrids/OU=Services/CN=desreader/des09.fnal.gov== and Marko has access to it. We will transfer it to Nikolay%ENDCOLOR%
   1. add DN of this service certificate to gridmapfile mapped to ==%RED%desuser%ENDCOLOR%==
   1. register with [[https://www.globusonline.org/SignUp][Globus Online]] or [[https://www.globusonline.org/SignIn][login]] to an existing account. %BLUE% Tanya has an account and can setup this endpoint%ENDCOLOR%
   1. setup a public endpoint </br><img src="%ATTACHURLPATH%/Screen_shot_2012-10-26_at_9.52.31_AM.png" alt="Screen_shot_2012-10-26_at_9.52.31_AM.png" width='770' height='440' border='20' />    
   1. setup identity provider: use myproxy server, e.g myproxy.ncsa.uiuc.edu</br><img src="%ATTACHURLPATH%/Screen_shot_2012-10-26_at_10.18.05_AM.png" alt="Screen_shot_2012-10-26_at_10.18.05_AM.png" width='500' height='384' border='20' />    
   1. implement a cron job that periodically creates a limited proxy certificate and loads it to myproxy server. The cron script  can look like the following:<pre class="file">
!/bin/bash
if [ $# -ne 3 ]
then
        echo "Usage: ./renew_certs.sh user_name myProxyServer password_file"
        exit 1
fi
user=$1
myProxyServer=$2
pswd=$3
#creates limited proxy for 12 hours
#we assume that cron jobs setup X509_USER_CERT,X509_USER_KEY with service certificate and key
#export X509_USER_CERT=%RED%~/des/desreadercert.pem%ENDCOLOR%
#export X509_USER_KEY=%RED%~/des/desreaderkey.pem%ENDCOLOR%

grid-proxy-init -limited  -out %RED%~/des/desreader_limited_proxy%ENDCOLOR%
if [ $? -ne 0 ]
then
        exit 1
fi
#sets location of proxy file
export X509_USER_CERT=%RED%~/des/desreader_limited_proxy%ENDCOLOR%
export X509_USER_KEY=%RED%~/des/desreader_limited_proxy%ENDCOLOR%
#read password for storing proxy in myProxy in a file
if [ ! -f  $pswd ]
then
        echo "password is not set in $pswd file"
        exit 1
fi
passwd=`cat  $pswd `
#upload credential to myProxyServer
myproxy-init -v -l $user  -S -s $myProxyServer << EOF
$passwd
EOF
exit $?
</pre> 
   1. notify set of users about globusonline endpoint, username/password for myproxy retrieval
---++ User's Tasks
   1. Register with [[https://www.globusonline.org/SignUp][globus online]]
   1. Install globus-connect [[https://www.globusonline.org/dashboard/Main?LinkAccount=true/][Globus Connect download]]
   1. Start transfering files by selecting  DES endpoint on the left hand site of WEBUI and activate it by specifying myproxy server ( myproxy.ncsa.uiuc.edu, user/password):</br>
     <img src="%ATTACHURLPATH%/Screen_shot_2012-10-26_at_10.18.05_AM.png" alt="Screen_shot_2012-10-26_at_10.18.05_AM.png" width='500' height='384' /> </br>On the right hand site select your Globus-connect endpoint.</br>
 <img src="%ATTACHURLPATH%/Screen_shot_2012-10-26_at_10.18.05_AM.png" alt="Screen_shot_2012-10-26_at_10.18.05_AM.png" width='500' height='380' />    
---++ Monitoring and troubleshooting
Monitoring could be done via gridftp log files:
gridftp-auth.log
 New connection from: transfer.api.globusonline.org:35448
[11448] Thu Oct 25 13:57:10 2012 :: DN  /DC=org/DC=doegrids/OU=Services/CN=desreader/des09.fnal.gov successfully authorized.
[11448] Thu Oct 25 13:57:10 2012 :: User desuser successfully authorized.

gridftp log
DATE=20121025155815.542534 HOST=fermigridosg1.fnal.gov PROG=globus-gridftp-server NL.EVNT=FTP_INFO START=20121025155815.128710 USER=desuser FILE=/des/orchestration/....../test_job_script BUFFER=0 BLOCK=262144 NBYTES=4505 VOLUME=/ STREAMS=1 STRIPES=1 DEST=[67.184.183.224] TYPE=RETR CODE=226
 
Destination gives you the hostname of a computer from where the transfer has been instantiated.

-- Main.TanyaLevshina - 26 Oct 2012

  

%META:FILEATTACHMENT{name="Screen_shot_2012-10-26_at_9.52.31_AM.png" attachment="Screen_shot_2012-10-26_at_9.52.31_AM.png" attr="h" comment="Endpoint Registration" date="1351263589" path="Screen shot 2012-10-26 at 9.52.31 AM.png" size="159325" stream="Screen shot 2012-10-26 at 9.52.31 AM.png" tmpFilename="/usr/tmp/CGItemp14211" user="TanyaLevshina" version="1"}%
%META:FILEATTACHMENT{name="Screen_shot_2012-10-26_at_10.18.05_AM.png" attachment="Screen_shot_2012-10-26_at_10.18.05_AM.png" attr="h" comment="" date="1351288893" path="Screen shot 2012-10-26 at 10.18.05 AM.png" size="76014" stream="Screen shot 2012-10-26 at 10.18.05 AM.png" tmpFilename="/usr/tmp/CGItemp14049" user="TanyaLevshina" version="1"}%
