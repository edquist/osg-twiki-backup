%META:TOPICINFO{author="YalingZheng" date="1340906544" format="1.1" reprev="1.4" version="1.4"}%
%META:TOPICPARENT{name="OSGasXsedeSp"}%
---+ *Describe the use case, the queries used, and the query pattern of gratia-gold script*

%TOC{depth="2"}% 

---++ *About the Use Case*

This script is meant to synchronize and summarize jobs from the OSG Gratia system (osg-gratia-prod.opensciencegrid.org) for GOLD at OSG-XSEDE so that GOLD can charge these jobs for the time, processors, nodes, and machines they requested. The script charges the jobs which submitted to a specific portal, such as "condor:osg-xsede.grid.iu.edu". 

The script intends to run periodically, such as hourly or daily so that those submitted jobs can be charged in time. 

Currently, this script querys jobs from rcf-gratia.unl.edu at Nebraska and charges the jobs because the production database osg-gratia-gold.opensciencegrid.org and rcf-gratia.unl.edu have the same database scheme for storing job information. Once we finish testing the script on rcf-gratia.unl.edu, we want read access of OSG Gratia system for the purpose of charging jobs queried from the production database.

---++ *About the Query Used*

The script querys the tables <pre>JobUsageRecord</pre> and <pre>JobUsageRecord_Meta</pre> in database gratia to get information of these jobs that submitted to specific portal (such as "condor:osg-xsede.grid.iu.edu") and charge these jobs. Because of the large quantities of the jobs, we group jobs when querying them in the following form

<pre class="screen">
SELECT
  max(JUR.dbid) as dbid,
  ResourceType,
  ReportableVOName,
  LocalUserId,
  sum(Charge) as Charge,
  sum(WallDuration) as WallDuration,
  sum(CpuUserDuration) as CpuUserDuration,
  sum(CpuSystemDuration) as CpuSystemDuration,
  NodeCount,
  count(Njobs) as Njobs,
  Processors,
  DATE(EndTime),
  MachineName,
  ProjectName
FROM
  JobUsageRecord JUR
JOIN
  JobUsageRecord_Meta JURM ON JUR.dbid = JURM.dbid
WHERE
  JUR.dbid >= %%(last_successful_id)s AND
  JUR.dbid < %%(last_successful_id)s + 100000 AND   
  ProbeName REGEXP %%(probename)s
GROUP BY
  ResourceType,
  ReportableVOName,
  LocalUserId,
  NodeCount,
  Processors,
  DATE(EndTime),
  MachineName,
  ProjectName
ORDER BY JUR.dbid ASC
LIMIT 10000
</pre>

---++ *About the Query Pattern*


---++ Comments
%COMMENT{type="tableappend"}%
