%META:TOPICINFO{author="ArvindGopu" date="1210282612" format="1.1" reprev="1.13" version="1.13"}%
%META:TOPICPARENT{name="RSV"}%
%TOC%
%LINKCSS%

---+Upgrade !RSV from version 1 to version 2 on OSG CE 0.8.0 resources
%STARTINCLUDE%
%BR%

---++ Background

<p> This document is for OSG admins who wish to upgrade !RSV on an OSG CE 0.8.0 to a newer version of the probes <u><strong>only on systems that use condor-devel  to run !RSV </strong></u>.

---++ Get new files, and do some clean-up

---+++ Turn off osg-rsv related services, and back up your existing !RSV directories just to be safe
<pre class="screen"> vdt-control --off osg-rsv condor-devel apache
 cd $VDT_LOCATION
 cp -a osg-rsv osg-rsv-bkup
 cp -a condor-devel condor-devel-bkup</pre>

---+++ Get new files and place them in appropriate directories

   <pre class="screen"> cd $VDT_LOCATION/vdt/setup
 mv configure_osg_rsv configure_osg_rsv.old
 wget http://rsv.grid.iu.edu/downloads/pre-release/0.8.0/configure_osg_rsv
 chmod +rx $VDT_LOCATION/vdt/setup/configure_osg_rsv

 cd $VDT_LOCATION/osg-rsv/config
 wget http://rsv.grid.iu.edu/downloads/pre-release/0.8.0/rsv-gratia.info
 wget http://rsv.grid.iu.edu/downloads/pre-release/0.8.0/rsv-nagios.conf
 chmod -R go+rX $VDT_LOCATION/osg-rsv/config/

 cd $VDT_LOCATION/osg-rsv/bin
 mv probes probes.old
 wget http://rsv.grid.iu.edu/downloads/RSV-v1-tarballs/OSG_RSV_Probes-1.6.4.tar.gz
 tar -zxvf OSG_RSV_Probes-1.6.4.tar.gz
 mv rsv-probes-upgrade probes
  
 mkdir $VDT_LOCATION/osg-rsv/bin/misc
 cd $VDT_LOCATION/osg-rsv/bin/misc
 wget http://rsv.grid.iu.edu/downloads/pre-release/0.8.0/cleanup-rsv.pl
 chmod -R go+rX $VDT_LOCATION/osg-rsv/bin/ </pre>



---+++ Clean up some old files

  <pre class="screen"> ## move this file out of the way
 mv $VDT_LOCATION/osg-rsv/specs/global-specs/ping-host-probe\@org.osg.general.ping-host.spec /tmp

 perl $VDT_LOCATION/osg-rsv/bin/misc/cleanup-rsv.pl --reset</pre>
 
 <pre class="programlisting">Continue (y/n) [n]: y</pre>


%INCLUDE{"MonitoringInformation/ShouldIUserServiceCert"}%

---++ !RSV configuration steps
%INCLUDE{"MonitoringInformation/PreConfigCheckListRsv"}%

---+++ !RSV running on OSG CE <strong>using GUMS</strong>; and <strong>using !RSV service cert</strong> to run probes:
   <pre class="screen"> $VDT_LOCATION/vdt/setup/configure_osg_rsv --user <em><strong>rsvuser</strong></em> --init --server y \
      --ce-probes --ce-uri "<em><strong>&#60;CE_FQDN&#62;</strong></em>" \ 
      --gridftp-probes [--gridftp-uri "<em><strong>&#60;GridFTP_FQDN&#62;</strong></em>" --gridftp-dir <em><strong>/path/to/write/test/file</strong></em>] \ 
      --gums-probes [--gums-uri "<em><strong>&#60;CE_FQDN&#62;</strong></em>"] \ 
      --gratia --grid-type "<strong><em>OSG-ITB</em></strong>" --verbose --consumers --setup-for-apache --use-rsv-cert \
      [--rsv-cert-file <em>/path/to/cert/public/cert</em> --rsv-key-file <em>/path/to/cert/private/key</em>] </pre>

---+++ !RSV running on !SRM dCache based OSG SE <strong>using GUMS</strong>; and <strong>using RSV service cert</strong> to run probes:

   <pre class="screen"> $VDT_LOCATION/osg-rsv/setup/configure_osg_rsv --user <em><strong>rsvuser</strong></em> --init --server y \
      --srm-probes --srm-uri "<em><strong>&#60;SRM_FQDN&#62;</strong></em>" \
      --srm-dir <em><strong>/foo/path/to/store/test/files</strong></em> \
      --gums-probes \ 
      --gratia --grid-type "<em><strong>OSG-ITB</strong></em>" --verbose --setup-for-apache --use-rsv-cert 
      [--rsv-cert-file <em>/path/to/cert/public/cert</em> --rsv-key-file <em>/path/to/cert/private/key</em>] </pre>
      For more example configurations, [[#more_example_configs][see here]]. More information on the !RSV configuration script is [[http://rsv.grid.iu.edu/documentation/vdt-1.8.1a-package.html#configure_osg_rsv_script][available here]].


      For more example configurations, [[#more_example_configs][see here]]. More information on the !RSV configuration script is [[http://rsv.grid.iu.edu/documentation/vdt-1.8.1a-package.html#configure_osg_rsv_script][available here]].

---++ Start !RSV and related services
<p> Start Condor-devel and !RSV services (plus Apache, if you want the VDT Apache to serve your local status pages, and specified the <tt>--setup-for-apache</tt> switch above)

  <pre class="screen">  ## Important: cd into your VDT_LOCATION before you turn on RSV
  cd $VDT_LOCATION
  vdt-control --on condor-devel osg-rsv apache </pre>
      More information on this  is [[http://rsv.grid.iu.edu/documentation/vdt-1.8.1a-package.html#start_rsv][available here]].

%INCLUDE{"MonitoringInformation/ValidateRsvV1Configuration"}%


---++ REVERT If things do not work out, then bail ...
<pre class="screen"> vdt-control --off osg-rsv condor-devel apache

 cd $VDT_LOCATION
 mv osg-rsv osg-rsv.bad
 mv condor-devel condor-devel.bad
 cp -a osg-rsv.bkup osg-rsv
 cp -a condor-devel.bkup condor-devel
  
 cd $VDT_LOCATION/vdt/setup
 mv configure_osg_rsv configure_osg_rsv.bad
 mv configure_osg_rsv.old configure_osg_rsv
 chmod +rx $VDT_LOCATION/vdt/setup/configure_osg_rsv

 vdt-control --on condor-devel osg-rsv apache</pre>

<p>And you should be back in business ... at least to the state you were in before you started this upgrade :-)

<p><br>

<hr color="#111111">
<p><br>

---++ More Example Configurations
<a name="more_example_configs"></a>
  <p> In the additional examples shown below, replace entries in =<em><strong>italics</strong></em>= to appropriate values; All steps below need to be executed as =root=. 

---+++ !RSV running on OSG CE <strong>not using GUMS</strong>; and <strong>using !RSV service cert</strong> to run probes:

   <pre class="screen"> $VDT_LOCATION/vdt/setup/configure_osg_rsv --user <em><strong>rsvuser</strong></em> --init --server y \
      --ce-probes --ce-uri "<em><strong>&#60;CE_FQDN&#62;</strong></em>" \ 
      --gridftp-probes [--gridftp-uri "<em><strong>&#60;GridFTP_FQDN&#62;</strong></em>" --gridftp-dir <em><strong>/path/to/write/test/file</strong></em>] \ 
      --gratia --grid-type "<strong><em>OSG-ITB</em></strong>" --verbose --consumers  --setup-for-apache --use-rsv-cert \
      [--rsv-cert-file <em>/path/to/cert/public/cert</em> --rsv-key-file <em>/path/to/cert/private/key</em>] </pre>

---+++ !RSV running one CE/standalong machine <em>monitoring multiple !OSG CEs/SEs</em>; <strong>must use user certificate</strong> to run probes:
   <pre class="screen"> # If you are installing !RSV on a separate host, then get it first:
 # pacman -get http://vdt.cs.wisc.edu/vdt_1100_cache:OSG-RSV
 ## Then do updates as mentioned in earlier section

 $VDT_LOCATION/vdt/setup/configure_osg_rsv --user <em><strong>rsvuser</strong></em> --init --server y \
      --ce-probes --ce-uri "<em><strong>&#60;CE_FQDN1 CE_FQDN2 CE_FQDN3&#62; </strong></em>" \ 
      --srm-probes --srm-uri "<em><strong>&#60;SE_FQDN1 SE_FQDN2 SE_FQDN3&#62;</strong></em>" --srm-dir <em><strong>/pnfs/destination/test/directory</strong></em> \ 
      --gums-probes [--gums-uri "<em><strong>&#60;CE_FQDN1 CE_FQDN2 CE_FQDN3&#62;</strong></em>"] \ 
      --gridftp-probes [--gridftp-uri "<em><strong>&#60;GridFTP_FQDN&#62;</strong></em>" --gridftp-dir <em><strong>/path/to/write/test/file</strong></em>] \ 
      --gratia --grid-type "<strong><em>OSG-ITB</em></strong>" --verbose --consumers --setup-for-apache \
      --proxy /path/to/rsvuser/proxy</pre>

---+++ !RSV running on !Bestman-xrootd based OSG SE. and <strong>using RSV service cert</strong> to run probes:

   <pre class="screen"> $VDT_LOCATION/osg-rsv/setup/configure_osg_rsv --user <em><strong>rsvuser</strong></em> --init --server y \
      --srm-probes --srm-uri "<em><strong>&#60;SRM_FQDN&#62;</strong></em>" \
      --srm-dir "<em><strong>/foo/path/to/store/test/files</strong></em>" \ 
      --srm-webservice-path "srm/v2/server" \ 
      --gratia --grid-type "<em><strong>OSG-ITB</strong></em>" --verbose --setup-for-apache --use-rsv-cert 
      [--rsv-cert-file <em>/path/to/cert/public/cert</em> --rsv-key-file <em>/path/to/cert/private/key</em>] </pre>

---+++ !RSV running on OSG CE <strong>not using GUMS</strong>; <strong>using !RSV service cert</strong> to run probes; and with <strong>!RSV-Nagios forwarding enabled</strong>
    <p> First you'll have to edit =$VDT_LOCATION/osg-rsv/config/rsv-nagios.conf=, and fill in your Nagios server details -- see comments in that conf file for more details. Contact rsv-dev if you have questions. Then run configure_osg_rsv script as follows.
   <pre class="screen"> $VDT_LOCATION/vdt/setup/configure_osg_rsv --user <em><strong>rsvuser</strong></em> --init --server y \
      --ce-probes --ce-uri "<em><strong>&#60;CE_FQDN&#62;</strong></em>" \ 
      --gridftp-probes [--gridftp-uri "<em><strong>&#60;GridFTP_FQDN&#62;</strong></em>" --gridftp-dir <em><strong>/path/to/write/test/file</strong></em>] \ 
      --gratia --grid-type "<strong><em>OSG-ITB</em></strong>" --verbose --consumers  --setup-for-apache --use-rsv-cert \
      --setup-rsv-nagios [--rsv-nagios-conf-file <em><strong>/optional/path/to/rsv-nagios.conf/file</strong></em>]
      [--rsv-cert-file <em>/path/to/cert/public/cert</em> --rsv-key-file <em>/path/to/cert/private/key</em>] </pre>

<p>
More information on configuring !RSV and related topics is available in the [[http://rsv.grid.iu.edu/documentation/vdt-package.html][RSV documentation pages]].

-- Main.ArvindGopu - 08 May 2008

