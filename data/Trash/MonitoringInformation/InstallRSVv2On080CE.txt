%META:TOPICINFO{author="ArvindGopu" date="1210282748" format="1.1" reprev="1.4" version="1.4"}%
%META:TOPICPARENT{name="RSV"}%
%TOC%
%LINKCSS%

---+Install !RSV version 2 separately on an existing OSG CE 0.8.0 resource
%STARTINCLUDE%
%BR%

---++ Background

<p> This document is for OSG admins who wish to install the newer version 2 of !RSV on an existging OSG CE 0.8.0 node. The new version will be installed in a <strong> separate location compared to the CE</strong>. 

<p><u>IMPORTANT: Please follow the instructions below carefully -- if you don't, especially if you don't install the new !RSV package in a new directory as shown, then there's a chance you might mess up your CE install! Please contact rsv-dev if you have any questions <strong>before</strong> you begin. Thank you!</u>


---++ Turn off old !RSV bits, and disable those services

<pre class="screen">  export EXISTING_CE_LOCATION=/path/to/0.8.0/CE
  . $EXISTING_CE_LOCATION/setup.sh
  vdt-control --off osg-rsv
  vdt-control --off condor-devel
  vdt-register-service --disable --name osg-rsv
  vdt-register-service --disable --name condor-devel

  ## Watch for errors in $EXISTING_CE_LOCATION/vdt-install.log</pre>


---++ In separate (fresh) terminal, get new !RSV package in new directory

<p> In a <u>separate fresh terminal</u>, as root, create a directory for !RSV version 2 package, and then get it using pacman.

<pre class="screen">  . /path/to/pacman-3.20-or-greater/setup.sh
  export NEW_RSV_LOCATION=/opt/new/rsv-2.0
  mkdir $NEW_RSV_LOCATION 
  cd $NEW_RSV_LOCATION 
  pacman -get http://vdt.cs.wisc.edu/vdt_1100_cache:OSG-RSV</pre>

<p> Answer the !VDT questions as follows -- i.e. we recommend you do _not_ install CA certs and CRLs again, and that you do not enable log_rotate (!RSV has its own logrotate). Just ensure you enable osg-rsv and condor-cron.

<pre class="programlisting">     Do you want to add [http://vdt.cs.wisc.edu/vdt_1100_cache] to [trusted.caches]? (y or n): y
     Do you agree to the licenses? [y/n] y
     Would you like to setup daily rotation of VDT log files?
     n

     Do you want to automatically update your CA Certificates? [y/n] n

     Where would you like to install CA files?
     n

     Would you like to enable OSG-RSV to run automatically?
     y

     Do you want to update the CA certification revocation lists (CRLs) automatically? [y/n] n

     Would you like to enable the Condor Cron batch system to run automatically? 
     y</pre>
 

---++ Get a couple more recent updates from !RSV downloads web site
   <pre class="screen">  . $NEW_RSV_LOCATION/setup.sh
  cd $VDT_LOCATION/osg-rsv/setup
  mv configure_osg_rsv configure_osg_rsv.old
  wget http://rsv.grid.iu.edu/downloads/pre-release/0.9.0/configure_osg_rsv
  chmod +rx $VDT_LOCATION/vdt/setup/configure_osg_rsv

  cd $VDT_LOCATION/osg-rsv/bin/probes
  wget http://rsv.grid.iu.edu/downloads/pre-release/0.9.0/OSG_RSV_Probes_2.2.5-patch.tar.gz
  tar -zxvf OSG_RSV_Probes_2.2.5-patch.tar.gz
  ## Ensure 2 srm-*-probe files, gums-*-probe, and OSG_RSV_Probe_Base.pm get updated
  chmod -R go+rX $VDT_LOCATION/osg-rsv/bin/probes/
  
  ## sym link CAcerts/CRLs to your CE location
  export EXISTING_CE_LOCATION=/path/to/0.8.0/CE
  ln -s  $EXISTING_CE_LOCATION/globus/share/certificates $NEW_RSV_LOCATION/globus/share/certificates</pre>

---++ !RSV configuration steps

%INCLUDE{"MonitoringInformation/ShouldIUserServiceCert"}%

%INCLUDE{"MonitoringInformation/PreConfigCheckListRsv"}%


---+++ !RSV running on OSG CE <strong>not using GUMS</strong>; and <strong>using !RSV service cert</strong> to run probes:

   <pre class="screen">  export EXISTING_CE_LOCATION=/path/to/0.8.0/CE
  $VDT_LOCATION/vdt/setup/configure_osg_rsv --user <em><strong>rsvuser</strong></em> --init --server y \
      --ce-probes --ce-uri "<em><strong>&#60;CE_FQDN&#62;</strong></em>" \ 
      --gridftp-probes [--gridftp-uri "<em><strong>&#60;GridFTP_FQDN&#62;</strong></em>" --gridftp-dir <em><strong>/path/to/write/test/file</strong></em>] \ 
      --gratia --grid-type "OSG" --verbose --consumers  --setup-for-apache \
      --apache-conf-file $EXISTING_CE_LOCATION/apache/conf/httpd.conf \
      --apache-index-file $EXISTING_CE_LOCATION/apache/htdocs/index.html \
      --use-rsv-cert \
      [--rsv-cert-file <em>/path/to/cert/public/cert</em> --rsv-key-file <em>/path/to/cert/private/key</em>] </pre>

      For more example configurations, [[#more_example_configs][see here]]. More information on the !RSV configuration script is [[http://rsv.grid.iu.edu/documentation/vdt-1.8.1a-package.html#configure_osg_rsv_script][available here]].


---++ Start !RSV and related services
<p> Start Condor-devel and !RSV services (plus restart your CE's Apache, if you want the VDT Apache to serve your local status pages, and specified the <tt>--setup-for-apache</tt> switch above)

  <pre class="screen">  . $NEW_RSV_LOCATION/setup.sh
  vdt-control --on condor-cron osg-rsv
  vdt-control --disable apache</pre>

  <pre class="screen">  . $EXISTING_CE_LOCATION/setup.sh
  ## Ensure apache is a registered and enabled service
  vdt-register-service --enable --name apache
  vdt-control --off apache
  vdt-control --on apache

   ## Go back to using new RSV's commands once Apache has been (re)started.
   . $NEW_RSV_LOCATION/setup.sh</pre>

<p>      More information on this  is [[http://rsv.grid.iu.edu/documentation/vdt-1.8.1a-package.html#start_rsv][available here]].



%INCLUDE{"MonitoringInformation/ValidateRsvV2Configuration"}%


<p><br>

<hr color="#111111">
<p><br>

---++ More Example Configurations
<a name="more_example_configs"></a>
  <p> In the additional examples shown below, replace entries in =<em><strong>italics</strong></em>= to appropriate values; All steps below need to be executed as =root=. 

---++++ !RSV running on OSG CE <strong>not using GUMS</strong>; and <strong>using !RSV service cert</strong> to run probes:

   <pre class="screen"> $VDT_LOCATION/vdt/setup/configure_osg_rsv --user <em><strong>rsvuser</strong></em> --init --server y \
      --ce-probes --ce-uri "<em><strong>&#60;CE_FQDN&#62;</strong></em>" \ 
      --gridftp-probes [--gridftp-uri "<em><strong>&#60;GridFTP_FQDN&#62;</strong></em>" --gridftp-dir <em><strong>/path/to/write/test/file</strong></em>] \ 
      --gratia --grid-type "OSG" --verbose --consumers  --setup-for-apache \
      --apache-conf-file $EXISTING_CE_LOCATION/apache/conf/httpd.conf \
      --apache-index-file $EXISTING_CE_LOCATION/apache/htdocs/index.html \
      --use-rsv-cert \
      [--rsv-cert-file <em>/path/to/cert/public/cert</em> --rsv-key-file <em>/path/to/cert/private/key</em>] </pre>

---++++ !RSV running one CE/standalong machine <em>monitoring multiple !OSG CEs/SEs</em>; <strong>must use user certificate</strong> to run probes:
   <pre class="screen"> # If you are installing !RSV on a separate host, then get it first:
 # pacman -get http://vdt.cs.wisc.edu/vdt_1100_cache:OSG-RSV
 ## Then do updates as mentioned in earlier section

 $VDT_LOCATION/vdt/setup/configure_osg_rsv --user <em><strong>rsvuser</strong></em> --init --server y \
      --ce-probes --ce-uri "<em><strong>&#60;CE_FQDN1 CE_FQDN2 CE_FQDN3&#62; </strong></em>" \ 
      --srm-probes --srm-uri "<em><strong>&#60;SE_FQDN1 SE_FQDN2 SE_FQDN3&#62;</strong></em>" --srm-dir <em><strong>/pnfs/destination/test/directory</strong></em> \ 
      --gums-probes [--gums-uri "<em><strong>&#60;CE_FQDN1 CE_FQDN2 CE_FQDN3&#62;</strong></em>"] \ 
      --gridftp-probes [--gridftp-uri "<em><strong>&#60;GridFTP_FQDN&#62;</strong></em>" --gridftp-dir <em><strong>/path/to/write/test/file</strong></em>] \ 
      --gratia --grid-type "OSG" --verbose --consumers  --setup-for-apache \
      --apache-conf-file $EXISTING_CE_LOCATION/apache/conf/httpd.conf \
      --apache-index-file $EXISTING_CE_LOCATION/apache/htdocs/index.html \
      --proxy /path/to/rsvuser/proxy</pre>

---++++ !RSV running on OSG CE <strong>not using GUMS</strong>; <strong>using !RSV service cert</strong> to run probes; and with <strong>!RSV-Nagios forwarding enabled</strong>
    <p> First you'll have to edit =$VDT_LOCATION/osg-rsv/config/rsv-nagios.conf=, and fill in your Nagios server details -- see comments in that conf file for more details. Contact rsv-dev if you have questions. Then run configure_osg_rsv script as follows.
   <pre class="screen"> $VDT_LOCATION/vdt/setup/configure_osg_rsv --user <em><strong>rsvuser</strong></em> --init --server y \
      --ce-probes --ce-uri "<em><strong>&#60;CE_FQDN&#62;</strong></em>" \ 
      --gridftp-probes [--gridftp-uri "<em><strong>&#60;GridFTP_FQDN&#62;</strong></em>" --gridftp-dir <em><strong>/path/to/write/test/file</strong></em>] \ 
      --gratia --grid-type "OSG-ITB" --verbose --consumers  --setup-for-apache \
      --apache-conf-file $EXISTING_CE_LOCATION/apache/conf/httpd.conf \
      --apache-index-file $EXISTING_CE_LOCATION/apache/htdocs/index.html \
      --use-rsv-cert \
      --setup-rsv-nagios [--rsv-nagios-conf-file <em><strong>/optional/path/to/rsv-nagios.conf/file</strong></em>]
      [--rsv-cert-file <em>/path/to/cert/public/cert</em> --rsv-key-file <em>/path/to/cert/private/key</em>] </pre>


---++++ !RSV running on OSG CE <strong>using GUMS</strong>; and <strong>using !RSV service cert</strong> to run probes:
<p> This option is not documented right now because the one GUMS probe that exists does not work properly, and is being re-written. Do not use the --gums-probes switch till we update this section of this document. Thank you.

<p>
<!-- More information on configuring !RSV and related topics is available in the [[http://rsv.grid.iu.edu/documentation/vdt-package.html][RSV documentation pages]]. -->


-- Main.ArvindGopu - 08 May 2008

