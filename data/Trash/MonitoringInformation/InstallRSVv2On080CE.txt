%META:TOPICINFO{author="ArvindGopu" date="1209051166" format="1.1" version="1.3"}%
%META:TOPICPARENT{name="RSV"}%
---+Install !RSV version 2 separately on an existing OSG CE 0.8.0 resource
%TOC%

%STARTINCLUDE%
%BR%

---++ Background

<p> This document is for OSG admins who wish to install the newer version 2 of !RSV on an existging OSG CE 0.8.0 node. The new version will be installed in a <strong> separate location compared to the CE</strong>. 

<p><u>IMPORTANT: Please follow the instructions below carefully -- if you don't, especially if you don't install the new !RSV package in a new directory as shown, then there's a chance you might mess up your CE install! Please contact rsv-dev if you have any questions <strong>before</strong> you begin. Thank you!</u>


---++ Turn off old !RSV bits, and disable those services

<pre>  export EXISTING_CE_LOCATION=/path/to/0.8.0/CE
  . $EXISTING_CE_LOCATION/setup.sh
  vdt-control --off osg-rsv
  vdt-control --off condor-devel
  vdt-register-service --disable --name osg-rsv
  vdt-register-service --disable --name condor-devel

  ## Watch for errors in $EXISTING_CE_LOCATION/vdt-install.log</pre>


---++ In separate (fresh) terminal, get new !RSV package in new directory

<p> In a separate fresh terminal, as root, create a directory for !RSV version 2 package, and then get it using pacman.

<pre>  . /path/to/pacman-3.20-or-greater/setup.sh
  export NEW_RSV_LOCATION=/opt/new/rsv-2.0
  mkdir $NEW_RSV_LOCATION 
  cd $NEW_RSV_LOCATION 
  pacman -get http://vdt.cs.wisc.edu/vdt_1100_cache:OSG-RSV</pre>

<p> Answer the !VDT questions as follows -- i.e. we recommend you do _not_ install CA certs and CRLs again, and that you do not enable log_rotate (!RSV has its own logrotate). Just ensure you enable osg-rsv and condor-cron.

<pre>     Do you want to add [http://vdt.cs.wisc.edu/vdt_1100_cache] to [trusted.caches]? (y or n): y
     Do you agree to the licenses? [y/n] y
     Would you like to setup daily rotation of VDT log files?
     n

     Do you want to automatically update your CA Certificates? [y/n] n

     Where would you like to install CA files?
     n

     Would you like to enable OSG-RSV to run automatically?
     y

     Do you want to update the CA certification revocation lists (CRLs) automatically? [y/n] n

     Would you like to enable the Condor Cron batch system to run automatically? 
     y</pre>
 

---++ Get a couple more recent updates from !RSV downloads web site
   <pre>  . $NEW_RSV_LOCATION/setup.sh
  cd $VDT_LOCATION/osg-rsv/setup
  mv configure_osg_rsv configure_osg_rsv.old
  wget http://rsv.grid.iu.edu/downloads/pre-release/0.9.0/configure_osg_rsv
  chmod +rx $VDT_LOCATION/vdt/setup/configure_osg_rsv

  cd $VDT_LOCATION/osg-rsv/bin
  mv probes probes.old
  wget http://rsv.grid.iu.edu/downloads/OSG_RSV_Probes-2.2.2b.tar.gz
  tar -zxvf OSG_RSV_Probes-2.2.2b.tar.gz
  mv rsv-probes probes
  cp -p $VDT_LOCATION/osg-rsv/bin/probes.old/probe_wrapper.pl $VDT_LOCATION/osg-rsv/bin/probes
  cp -p $VDT_LOCATION/osg-rsv/bin/probes.old/add_new_probe $VDT_LOCATION/osg-rsv/bin/probes
  chmod -R go+rX $VDT_LOCATION/osg-rsv/bin/probes/
  
  ## sym link CAcerts/CRLs to your CE location
  ln -s  $EXISTING_CE_LOCATION/globus/share/certificates $NEW_RSV_LOCATION/globus/share/certificates</pre>

---++ !RSV configuration steps
---++++ Should I use a service certificate or a user certificate?
<p> If you run !RSV right on a CE (SE), and only monitor that CE (SE), then you can use a service certificate to run RSV probes. The important factor is that the <em> service certificate or its proxy, per its policy and the OSG security group's mandate, should not leave the host it was generated for, and can only be used to test that host</em>. If you want to use a service certificate for !RSV,  then:
   * You must get one using [[https://twiki.grid.iu.edu/twiki/bin/view/ReleaseDocumentation/GetGridCertificates#Other_service_certificates][usual methods]]
   * You must ensure that service cert is authorized to run jobs on the CE/SE it is being used to test (GUMS or grid-mapfile).
   * Place RSV service cert in /etc/grid-security/ as <tt>rsvkey.pem</tt> and <tt>rsvcert.pem</tt>, or use command line switches to point to those files.

---++++ Pre-config check list
   * Ensure you have a <strong> valid username for !RSV</strong> (say, =rsvuser=); then as =root=,  replace entries in =<em><strong>italics</strong></em>= to appropriate values, and run the !RSV config script using <u>one of the following example configurations</u>
      * We expect that these command line instructions will have to be used till configure_osg is completely ready to take over configuring packages, including RSV, using a central !OSG-level .ini file.   
      * If you specify =--gridftp-probes= or =--gums-probes=, then the corresponding =--xyz-uri= switch(es) (=--gridftp-uri= and =--gums-uri=) are optional; if none is provided (i.e your CE host is where the gums probes should run/ CE is the gridftp server as well), then those URIs default to the the =--ce-uri= assuming that is provided. 
      * If you configure !SRM probes, then you'll have to also provide a =--srm-dir= value where test files can be copied over to.

---++++ !RSV running on OSG CE <strong>not using GUMS</strong>; and <strong>using !RSV service cert</strong> to run probes:

   <pre>  export EXISTING_CE_LOCATION=/path/to/0.8.0/CE
  $VDT_LOCATION/vdt/setup/configure_osg_rsv --user <em><strong>rsvuser</strong></em> --init --server y \
      --ce-probes --ce-uri "<em><strong>&#60;CE_FQDN&#62;</strong></em>" \ 
      --gridftp-probes [--gridftp-uri "<em><strong>&#60;GridFTP_FQDN&#62;</strong></em>" --gridftp-dir <em><strong>/path/to/write/test/file</strong></em>] \ 
      --gratia --grid-type "OSG" --verbose --consumers  --setup-for-apache \
      --apache-conf-file $EXISTING_CE_LOCATION/apache/conf/httpd.conf \
      --apache-index-file $EXISTING_CE_LOCATION/apache/htdocs/index.html \
      --use-rsv-cert \
      [--rsv-cert-file <em>/path/to/cert/public/cert</em> --rsv-key-file <em>/path/to/cert/private/key</em>] </pre>

      For more example configurations, [[#more_example_configs][see here]]. More information on the !RSV configuration script is [[http://rsv.grid.iu.edu/documentation/vdt-1.8.1a-package.html#configure_osg_rsv_script][available here]].


---++ Start !RSV and related services
<p> Start Condor-devel and !RSV services (plus restart your CE's Apache, if you want the VDT Apache to serve your local status pages, and specified the <tt>--setup-for-apache</tt> switch above)

  <pre>  . $NEW_RSV_LOCATION/setup.sh
  vdt-control --on condor-cron osg-rsv
  vdt-control --disable apache</pre>

  <pre>  . $EXISTING_CE_LOCATION/setup.sh
  ## Ensure apache is a registered and enabled service
  vdt-register-service --enable --name apache
  vdt-control --off apache
  vdt-control --on apache

   ## Go back to using new RSV's commands once Apache has been (re)started.
   . $NEW_RSV_LOCATION/setup.sh</pre>

<p>      More information on this  is [[http://rsv.grid.iu.edu/documentation/vdt-1.8.1a-package.html#start_rsv][available here]].

---++++ Check if everything is in good shape
   * You can check all the condor-cron !RSV jobs that got submitted typing:
  <pre> condor_cron_q</pre>.
   *  After waiting about 15 minutes, check out the local status web page that is created with results of !RSV probe runs each day. By default, this page is =$VDT_LOCATION/osg-rsv/output/html/index.html=, but can be reconfigured. You can either view the local status pages directly on the monitoring host ; or you can view these pages on the web at !http://&#60;FQDN_of_monitoring_host&#62;:8443/rsv, once again assuming you [[http://rsv.grid.iu.edu/documentation/vdt-package.html#configure_osg_rsv_script_localweb][configured !RSV to use the !VDT Apache]] to serve them in the above configuration steps. Beware that you <em>need to have an !OSG approved cert loaded in your web browser</em> to be able to view them page. The status pages should look similar to [[http://rsv.grid.iu.edu/documentation/sample_status.html][what is documented here]].

   * Look at Gratia consumer log file: =$VDT_LOCATION/osg-rsv/logs/consumers/gratia-script-consumer.out= to see if probe results were uploaded successfully to the !GOC maintained !RSV database. You should a bunch of entries similar to this:
   <pre>   08-20-2007 16:35:26 - Executing script '/usr/local/grid/ . . . record.py'
   OK </pre>


<!--   * Configure Metrics to run and how often: If this is the first time you're configuring !RSV, then copy the sample metrics file =$VDT_LOCATION/osg-rsv/config/sample_metrics.conf= to =$VDT_LOCATION/osg-rsv/config/&#60;host_FQDN&#62;_metrics.conf=, and make further edits to it if necessary. The sample file has the metrics listed with appropriate (recommended) time intervals. Enable/Disable a particular metric: Any line that starts with *on* is enabled; change that keyword to *off* to disable a metric. For example, if you site runs only the PBS job-manager, then you might disable the other jobmanagers-status probes.
   <pre>   on jobmanagers-status-probe@org.osg.batch.jobmanager-pbs-status 24 */2 * * *</pre>
   More information on this is [[http://rsv.grid.iu.edu/documentation/vdt-1.8.1a-package.html#configure_metrics][available here]]. Go here for documenation on [[http://rsv.grid.iu.edu/documentation/vdt-1.8.1a-package.html#extra_probe_specs][adding custom switches to the !RSV !probes]].
-->

<p><br>

<hr color="#111111">
<p><br>

---++ More Example Configurations
<a name="more_example_configs"></a>
  <p> In the additional examples shown below, replace entries in =<em><strong>italics</strong></em>= to appropriate values; All steps below need to be executed as =root=. 

---++++ !RSV running on OSG CE <strong>not using GUMS</strong>; and <strong>using !RSV service cert</strong> to run probes:

   <pre> $VDT_LOCATION/vdt/setup/configure_osg_rsv --user <em><strong>rsvuser</strong></em> --init --server y \
      --ce-probes --ce-uri "<em><strong>&#60;CE_FQDN&#62;</strong></em>" \ 
      --gridftp-probes [--gridftp-uri "<em><strong>&#60;GridFTP_FQDN&#62;</strong></em>" --gridftp-dir <em><strong>/path/to/write/test/file</strong></em>] \ 
      --gratia --grid-type "OSG" --verbose --consumers  --setup-for-apache \
      --apache-conf-file $EXISTING_CE_LOCATION/apache/conf/httpd.conf \
      --apache-index-file $EXISTING_CE_LOCATION/apache/htdocs/index.html \
      --use-rsv-cert \
      [--rsv-cert-file <em>/path/to/cert/public/cert</em> --rsv-key-file <em>/path/to/cert/private/key</em>] </pre>

---++++ !RSV running one CE/standalong machine <em>monitoring multiple !OSG CEs/SEs</em>; <strong>must use user certificate</strong> to run probes:
   <pre> # If you are installing !RSV on a separate host, then get it first:
 # pacman -get http://vdt.cs.wisc.edu/vdt_1100_cache:OSG-RSV
 ## Then do updates as mentioned in earlier section

 $VDT_LOCATION/vdt/setup/configure_osg_rsv --user <em><strong>rsvuser</strong></em> --init --server y \
      --ce-probes --ce-uri "<em><strong>&#60;CE_FQDN1 CE_FQDN2 CE_FQDN3&#62; </strong></em>" \ 
      --srm-probes --srm-uri "<em><strong>&#60;SE_FQDN1 SE_FQDN2 SE_FQDN3&#62;</strong></em>" --srm-dir <em><strong>/pnfs/destination/test/directory</strong></em> \ 
      --gums-probes [--gums-uri "<em><strong>&#60;CE_FQDN1 CE_FQDN2 CE_FQDN3&#62;</strong></em>"] \ 
      --gridftp-probes [--gridftp-uri "<em><strong>&#60;GridFTP_FQDN&#62;</strong></em>" --gridftp-dir <em><strong>/path/to/write/test/file</strong></em>] \ 
      --gratia --grid-type "OSG" --verbose --consumers  --setup-for-apache \
      --apache-conf-file $EXISTING_CE_LOCATION/apache/conf/httpd.conf \
      --apache-index-file $EXISTING_CE_LOCATION/apache/htdocs/index.html \
      --proxy /path/to/rsvuser/proxy</pre>

---++++ !RSV running on OSG CE <strong>not using GUMS</strong>; <strong>using !RSV service cert</strong> to run probes; and with <strong>!RSV-Nagios forwarding enabled</strong>
    <p> First you'll have to edit =$VDT_LOCATION/osg-rsv/config/rsv-nagios.conf=, and fill in your Nagios server details -- see comments in that conf file for more details. Contact rsv-dev if you have questions. Then run configure_osg_rsv script as follows.
   <pre> $VDT_LOCATION/vdt/setup/configure_osg_rsv --user <em><strong>rsvuser</strong></em> --init --server y \
      --ce-probes --ce-uri "<em><strong>&#60;CE_FQDN&#62;</strong></em>" \ 
      --gridftp-probes [--gridftp-uri "<em><strong>&#60;GridFTP_FQDN&#62;</strong></em>" --gridftp-dir <em><strong>/path/to/write/test/file</strong></em>] \ 
      --gratia --grid-type "OSG-ITB" --verbose --consumers  --setup-for-apache \
      --apache-conf-file $EXISTING_CE_LOCATION/apache/conf/httpd.conf \
      --apache-index-file $EXISTING_CE_LOCATION/apache/htdocs/index.html \
      --use-rsv-cert \
      --setup-rsv-nagios [--rsv-nagios-conf-file <em><strong>/optional/path/to/rsv-nagios.conf/file</strong></em>]
      [--rsv-cert-file <em>/path/to/cert/public/cert</em> --rsv-key-file <em>/path/to/cert/private/key</em>] </pre>


---++++ !RSV running on OSG CE <strong>using GUMS</strong>; and <strong>using !RSV service cert</strong> to run probes:
<p> This option is not documented right now because the one GUMS probe that exists does not work properly, and is being re-written. Do not use the --gums-probes switch till we update this section of this document. Thank you.

<p>
More information on configuring !RSV and related topics is available in the [[http://rsv.grid.iu.edu/documentation/vdt-package.html][RSV documentation pages]].


-- Main.ArvindGopu - 23 Apr 2008
