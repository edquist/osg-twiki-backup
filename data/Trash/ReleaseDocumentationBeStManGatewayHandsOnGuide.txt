%META:TOPICINFO{author="TanyaLevshina" date="1280962977" format="1.1" reprev="1.5" version="1.5"}%
%META:TOPICPARENT{name="SiteAdminsWorkshopTutorialsAug10"}%
---+!! *<nop>BeStMan-gateway Hands-on Guide*
%DOC_STATUS_TABLE%
%TOC{depth="2"}%

---++ Introduction
This tutorial covers step by step !BeStman installation and gateway mode configuration. We will also provide tips some tips on  how to increase scalability and reliability of your !BeStMan installation for heavy load. We will explain how to enable and configure gratia !gridFTP transfer probe in case you would like to report transfer data to Gratia (the OSG accounting service).

---+++!! Applicable Versions
The applicable software versions for this document are 
%RED%
*osg-version 1.2* 
%ENDCOLOR%
(or higher) and 
%RED%
*vdt-version  2.0*
%ENDCOLOR%
(or higher).

---+++!!Engineering Considerations
The [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/BestmanGateway][BeStMan Installation Guide]] provides detailed instructions and various configuration options. Please refer to this guide for more information.
It is recommended to install !BeStMan on its own server though, in principal, it could be installed on CE node and configured to use !GridFTP server  that have been already installed with CE.  

You can choose to run multiple GridFTP servers to achieve load balance and better performance if you are installing !BeStMan not on the local disk but on NFS or some other DFS. If you really expecting a heavy load on your SE you should acquire additional nodes for your !GRidFTP servers and have a node for !BeStMan server.

---+++!!Help!
If you cannot resolve the problem, the best way to get help is by following this [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/BestmanGateway#Debugging_Information][debugging information]].

---++ Checklist
   1. you have at least one node you can login as root
   1. [[ReleaseDocumentation/PacmanInstall][pacman]] version >= %PACMAN_VERSION% is required
   1. The server must have a fully qualified domain name and a valid [[ReleaseDocumentation/GetGridCertificates][grid host certificate]] installed in =/etc/grid-security/=
   1. !BeStMan server needs to have a valid service certificate. The certificate should be own by a user login that is running !BeStMan server.The right permission (600) should be set on those files. By default !BeStMan is using a service certificate =/etc/grid-security/http/httpcert.pem= and certificate key =/etc/grid-security/http/httpkey.pem=. %ICON{warning}%  !BeStMan should be configured with host certificate in order to be able to handle requests from !LCG-Utils tools. This is mandatory for at least all !BeStMan servers that support ATLAS experiment. Normally the OSG !BeStMan implementation uses a service certificate, not a host certificate. This causes lcg-cp to fail because the certificate name (which looks like http/hostname instead of just hostname or host/hostname) doesn't match the hostname. 
   1. The firewall must allow incoming connections for two !BeStMan ports (defaults: 1080, 10443)
   1. The firewall must allow incoming connections to the !GridFTP port (default 2811). Outgoing connections must be allowed from high ports ( typically in range 32769-65535 ). We recommend to consult the [[ReleaseDocumentation/ComputeElementFirewalls][Firewall Guide]] if you install the !GridFTP server for the first time.
   1. A working GUMS server or a grid-mapfile is needed for authentication and authorization using grid certificates.
   1. A disk area that you want to export with !BeStMan ==/cache== in this document. This directory should have adequate permissions so users have read/write/execute access. 
   1.  You will have to have all unix user names mapped in GUMS or grid-mapfile to be listed in /etc/passwd. These user do not need an account.

---++ Installation Procedure
This installation procedure assumes that you have functional GUMS server and are installing !BeStMan on dedicated node. It also assumes that you don't have firewall on that node. 

Login on the node dedicated for !BeStMan as user ==root==. 

If you have pacman installed on that node skip to the next step, otherwise do this:
<pre class="screen">
<verbatim>
cd /opt
wget http://physics.bu.edu/pacman/sample_cache/tarballs/pacman-latest.tar.gz
tar xvfz pacman-latest.tar.gz 
cd pacman-3.29
. setup.sh
</verbatim>
</pre>

If you have already installed pacman in <PACMAN_LOCATION> directory do:
<pre class="screen">
. %BLUE%&lt;PACMAN_LOCATION&gt;%ENDCOLOR%/setup.sh
</pre>

Create a directory with certificate and key files that belong to !BeStMan owner (default is ==daemon==):
<pre class="screen">
<verbatim>
cd /etc/grid-security
mkdir bestman_cert
cp hostcert.pem bestman_cert/bestmancert.pem  
cp hostkey.pem bestman_cert/bestmankey.pem
chown -R daemon.daemon bestman_cert
chmod 644 bestman_cert/bestmancert.pem  
chmod 600 bestman_cert/bestmankey.pem
</verbatim>
</pre>

Set up ==VDT_GUMS_HOST== environment variable (replace  %BLUE%your_gums_host%ENDCOLOR% with the FQN of the host where  GUMS service is installed):
<pre class="screen">
 export VDT_GUMS_HOST=%BLUE%your_gums_host%ENDCOLOR%
</pre>
Install !BeStMan from OSG:
<pre class="screen">
<verbatim>
cd /opt
mkdir osg-bestman
cd osg-bestman
pacman -get http://software.grid.iu.edu/osg-1.2:Bestman
Do you want to add [http://software.grid.iu.edu/osg-1.2] to [trusted.caches]? (y/n/yall): yall
</verbatim>
</pre>

---+++ Post-installation steps
Perform required post-install actions:
   1. setup environment <pre class="screen">
<verbatim>
cd /opt/osg-bestman
. setup.sh
</verbatim>
</pre>
   1. run post-install script<pre class="screen">
<verbatim>
vdt-post-install 
Starting...
Configuring PRIMA... Done.
Configuring EDG-Make-Gridmap... Done.
Done.
</verbatim>
</pre>
   1. install CAs<pre class="screen">
<verbatim>
$VDT_LOCATION/vdt/bin/vdt-ca-manage setupca --location local  --url osg
 </verbatim>
</pre>
   1. copy the configuration files that required for !GridFTP if GUMS is used:
<pre class="screen">
<verbatim>
cp post-install/gsi-authz.conf  /etc/grid-security/gsi-authz.conf
cp post-install/prima-authz.conf  /etc/grid-security/prima-authz.conf 
</verbatim>
</pre>


---++ Service Configuration 
---+++ Configure !BeStMan
Create a storage area that will be used by !BeStMan to store files:<pre class="screen">
<verbatim>
mkdir /cache
chmod 777 /cache
chown daemon.daemon /cache
</verbatim>
</pre>

Configure !BeStMan with these options:<pre class="screen">
<verbatim>
$VDT_LOCATION/vdt/setup/configure_bestman --server y --user daemon \
--cert /etc/grid-security/bestman_cert/bestmancert.pem \
--key /etc/grid-security/bestman_cert/bestmankey.pem \
--with-allowed-paths /cache \
--gums-host gums.fnal.gov \
--gums-port 8443 \
--enable-gateway
</verbatim>
</pre>
---++++Sudoers File Modification
Please, make the appropriate modification to ==/etc/sudoers== described in the !BeStMan documentation, namely add the following lines to this file : 
<pre class="file">
<verbatim>
# Comment out this line, if it is in your ==/etc/sudoers== file (RHEL5+)
#Defaults    requiretty

Cmnd_Alias SRM_CMD = /bin/rm, /bin/mkdir, /bin/rmdir, /bin/mv, /bin/ls 
Runas_Alias SRM_USR = ALL, !root 
daemon ALL=(SRM_USR) NOPASSWD: SRM_CMD 
</verbatim>
</pre>

---+++ Configure Gratia !GridFTP Transfer Probe
Configure transfer probe, replace ==your_site_name== with actual name of your sites:
<pre class="screen">
<vebratim>
 $VDT_LOCATION/vdt/setup/configure_gratia --probe gridftp-transfer \
--report-to gratia-osg-itb.opensciencegrid.org:8881 --probe-cron \
--site-name your_site_name
</verbatim>
</pre>
Run ==gums-host-cron== command to generate VO-user mapping file:
<pre class="screen">
<vebratim>
$VDT_LOCATION/gums/scripts/gums-host-cron
</verbatim>
</pre>

---++ Enabling Services
Check what services are need to be enabled:
<pre class="screen">
<vebratim>
vdt-control -list
Service                 | Type   | Desired State
------------------------+--------+--------------
fetch-crl               | cron   | do not enable
vdt-rotate-logs         | cron   | do not enable
vdt-update-certs        | cron   | do not enable
gsiftp                  | inetd  | do not enable
gratia-gridftp-transfer | cron   | enable
gums-host-cron          | cron   | do not enable
edg-mkgridmap           | cron   | do not enable
bestman                 | init   | enable
</verbatim>
</pre>

Enable the following services:
<pre class="screen">
<vebratim>
 vdt-control -enable gsiftp vdt-update-certs vdt-rotate-logs fetch-crl gums-host-cron
</verbatim>
</pre>

---++ Service Startup/Shutdown
Start all the services:<pre class="screen">
<vebratim>
 vdt-control -on
enabling cron service fetch-crl... ok
enabling cron service vdt-rotate-logs... ok
enabling cron service vdt-update-certs... ok
enabling inetd service gsiftp... ok
enabling cron service gratia-gridftp-transfer... ok
enabling cron service gums-host-cron... ok
skipping cron service 'edg-mkgridmap' -- marked as disabled
enabling init service bestman... ok
</verbatim>
</pre>
Stop all the services: <pre class="screen">
<vebratim>
vdt-control -off
disabling init service bestman... ok
disabling cron service edg-mkgridmap... ok
disabling cron service gums-host-cron... ok
disabling cron service gratia-gridftp-transfer... ok
disabling inetd service gsiftp... ok
disabling cron service vdt-update-certs... ok
disabling cron service vdt-rotate-logs... ok
disabling cron service fetch-crl... ok
</verbatim>
</pre>

Stop/start a specific service:<pre class="screen">
vdt-control -off %BLUE%&lt;service_name&gt;%ENDCOLOR%
vdt-control -on %BLUE%&lt;service_name&gt;%ENDCOLOR%
</pre>

---++ Validation of Service Operation
In order to verify that the service is working

#DebugInfo
---++ Debugging Information
---+++!!File Locations
Locations of configuration files, input/output files, log files, etc. that are important for an administrator to know about if something doesn't work.  

---+++!!Debugging Procedure
What are the first things to check, step-by-step instructions to determine source of problem for this service

---+++!!Caveats/Known Issues
Restrictions and/or work around for known issues 

---+++!!References
References to additional information.  This document should be as concise as possible, but the reader can use these links if he/she wants more background or information.

---+++!!Screen Dump of the Complete Install Process
%TWISTY{
mode="div"
showlink="Show..."
hidelink="Hide"
showimgleft="%ICONURLPATH{toggleopen-small}%"
hideimgleft="%ICONURLPATH{toggleclose-small}%"
}%
<pre class="screen">
complete screen dump of the install procedure
</pre>
%ENDTWISTY%

---++ *Comments*
%COMMENT{type="tableappend"}%

<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = TanyaLevshina

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = Storage

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = Installation
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %NO%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %NO%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = MarcoMambelli
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %YES%


 DEAR DOCUMENT TESTER
 ====================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = RobSnihur
 Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %YES%
############################################################################################################
-->
-- Main.JamesWeichel - 03 Feb 2010
