%META:TOPICINFO{author="KyleGross" date="1242049290" format="1.1" version="1.2"}%
%META:TOPICPARENT{name="ForrestChristianSandbox"}%
%LINKCSS%

---+ Installing the VDT: One Person's Experience
%TOC%

%NOTE% These are from [[Main.PenelopeConstanta][Penelope Constanta's]] notes.

Follow the [[http://vdt.cs.wisc.edu/releases/1.3.11/installation.html][VDT installation instructions]] as follows:

---++ Install pacman: 
Create the top level directory that pacman will be installed under and then get and install the package:

<pre class="screen">
$ <userinput>mkdir &#8230;/pacman</userinput>
$ <userinput>cd &#8230;/pacman</userinput>
$ <userinput>wget http://physics.bu.edu/pacman/sample_cache/tarballs/pacman-latesttar.gz</userinput>
$ <userinput>tar xzvf pacman-latest.tar.gz</userinput>
$ <userinput>cd pacman-3.xx</userinput>
$ <userinput>source setup.sh</userinput>    # or setup.csh according to shell used
</pre>

%NOTE% The first execution of the =setup.sh= or =setup.csh= needs to be done from the pacman-xxx directory.

---++ Install VDT
Full installation requires root access on the machine. The following are the steps in order they need to be done:

   * Create users for the various daemons:
      * =/usr/sbin/adduser -d /home/globus globus=
      * =/usr/sbin/adduser -d /home/monalisa monalisa=
      * =/usr/sbin/adduser -d /home/condor condor=
   * Go to the top-level directory of the VDT installation. Create the =vdt= directory and use pacman to install it. For example:
<pre class="screen">
$ <userinput>cd /data</userinput>
$ <userinput>mkdir vdt</userinput>
$ <userinput>cd vdt</userinput>
$ <userinput>export VDT_LOCATION=/data/vdt/</userinput>
</pre>

---+++ Installing over a previous version of VDT
To install on a system that already has a previous version of VDT you need to stop tomcat and apache. The installation will fail if they are running. 
<pre class="screen">
$ <userinput>ksu</userinput>
$ <userinput>service tomcat-5 stop</userinput>
$ <userinput>service tomcat-55 stop</userinput>
$ <userinput>service apache stop</userinput>
</pre>

---+++ Installing on Scientific Linux
To install on a system running Scientific Linux run pacman as follows:

<pre class="screen">
$ <userinput>pacman   &#8211;pretend-platform:RHEL-3   &#92;
   &#8211;get http://www.cs.wisc.edu/vdt/vdt_139_cache:VDT</userinput>
</pre>

Or one might use two commands:
<pre class="screen">
$ <userinput>pacman   &#8211;pretend-platform:RHEL-3</userinput>
$ <userinput>pacman &#8211;get http://www.cs.wisc.edu/vdt/vdt_139_cache:VDT</userinput>
</pre>

---++ Using VDT
To use VDT, =source= the VDT setup file under the =vdt= directory:

<pre class="screen">
$ <userinput>cd vdt</userinput>
$ <userinput>source setup.sh</userinput>   #or setup.csh
</pre>

---++ Installing Tomcat v5.5


<pre class="screen">
$ <userinput>source $PACMAN_LOCATION/setup.sh</userinput>
$ <userinput>export VDT_LOCATION=/data/vdt_1_3_11</userinput>
$ <userinput>cd $VDT_LOCATION</userinput>
$ <userinput>pacman -get http://vdt.cs.wisc.edu/vdt_1311_cache:Tomcat-5.5</userinput>
</pre>

---++ Installing VDT Tests

<pre class="screen">
$ <userinput>source $PACMAN_LOCATION/setup.sh</userinput>
$ <userinput>source $VDT_LOCATION/setup.sh</userinput>
$ <userinput>cd $VDT_LOCATION</userinput>
$ <userinput>pacman -get VDT:VDT-Test</userinput>
</pre>

---++ Certificates
Once you have exported from the browser your certificate as a file with extension p12, to get the usercert.pem and userkey.pem files do the following, do not ignore the last step of changing the access rights:

<pre class="screen">
$ <userinput>openssl pkcs12 -in mycertificate.p12 -nocerts -out usercert.pem</userinput>
 Enter Import Password: 
 MAC verified OK
$ <userinput>openssl pkcs12 -in mycertificate.p12 -nocerts -out userkey.pem</userinput>
 Enter Import Password: 
 MAC verified OK
 Enter PEM pass phrase:
 Verifying - Enter PEM pass phrase:
$ <userinput>chmod go-rw *.pem</userinput>
</pre>

---+++ Get Host and service certificates:
The certificate related files location depends on the answer to the VDT installation question:

<pre class="screen">
Where would you like to install CA files?

Choices:
        r (root)  - install into /etc/grid-security/certificates
            (existing CA files will be preserved)
        l (local) - install into $VDT_LOCATION/globus/share/certificates
        n (no)    - do not install
</pre>

If you answered to be installed as root (r &#8211; root) then the =/etc/grid-security/certificates=
directory is created (if its does exist) and populated. 

If the answer to be installed as local (l &#8211; local) then all the files are under =$VDT_LOCATION/globus/=.

The link =TRUSTED_CA= in the =$VDT_LOCATION/globus/= directory points to your certificate area. 
For example: 
   =TRUSTED_CA= &#8594;  =/etc/grid-security/certificates=

---+++ Get a host certificate using VDT globus installation:
If the installation was done as root, then the =/etc/grid-security doegrids= directory was also created with the appropriate files. (I have not done that local installation for instructions there but something similar undet the =$VDT_LOCATION/globus/= must be installed). The following are the commands to use to get a host certificate, where =cd-psg2.fnal.gov= is the host name for which a certificate is requested:


<pre class="screen">
$ <userinput>cd /etc/grid-security/doegrids</userinput>
$ <userinput>./doegrids-cert-request -host cd-psg2.fnal.gov</userinput>
</pre>

This will create three files under =/etc/grid-security=:
   * =hostkey.pem= 
   * =hostcert.pem=
   * =hostcert_request.pem=
   
The script will supply also the following information:

Go to https://pki1.doegrids.org and choose the "Grid or SSL Server" menu item on the Enrollment page. There, cut and paste the file =/etc/grid-security/hostcert_request.pem= into the =PKCS#10= text field. 

An email will be sent with the URL of the certificate. Copy the text under &#8220;Base 64 encoded certificate&#8221; and paste it in =/etc/grid-security/hostcert.pem=.

Under =/etc/grid-security= there are three valid pem files that contain the host certificate.

Get an http service certificate using VDT globus installation:

<pre class="screen">
$ <userinput>cd /etc/grid-security/doegrids</userinput>
$ <userinput>./doegrids-cert-request &#8211;service http &#8211;host cd-psg2.fnal.gov</userinput>
</pre>

This will create two three files under the =/etc/grid-security/http=:
   * =httpkey.pem=
   * =httpcert.pem=
   * =httpcert_request.pem=

The script will supply also the following information:

Go to https://pki1.doegrids.org and choose the "Grid or SSL Server" menu item on the Enrollment page. There, cut and paste the file =/etc/grid-security/http/httpcert_request.pem= into the =PKCS#10= text field. 

An email will be sent with the URL of the certificate. The email has the wrong information about where to copy the certificate, So, copy the text under &#8220;Base 64 encoded certificate&#8221; and paste it into =/etc/grid-security/http/httpcert.pem=.

Under =/etc/grid-security/http= there are three valid pem files that contain the http service certificate.

---+++ Get a host or service certificate
Get a host or service certificate using the doegrids site instructions. The following is if you need to get the scripts from the doegrids site:


---++++ Getting service/host certificates
Get the service/host certificates from [[http://www.doegrids.org/pages/ModelCertificateDeployment.html][Model Certificate Trash/Deployment page]].  Get [[http://pki1.doegrids.org/Other/doegrids.tar][doegrid.tar]].

<pre class="screen">
$ <userinput>mkdir /etc/grid-security</userinput>
$ <userinput>cd /etc/grid-security</userinput>
$ <userinput>tar xvf doegrids.tar</userinput>
</pre>

This creates three directories. All information on what to do next is in %BR% =/etc/grid-security/doegrids/README.doegrids=

Before running the /etc/grid-security/doegrids/grid-cert-request,  the following files need to be copied as follows (the script requires these files in order to work properly):

<pre class="screen">
$ <userinput>cp  /data/vdt/globus/TRUSTED_CA/grid-security.conf.1c3f2ca8    &#92;
   /data/vdt/globus/etc/grid-security.conf</userinput>
$ <userinput>cp  /data/vdt/globus/TRUSTED_CA/globus-host-ssl.conf.1c3f2ca8    &#92;
   /data/vdt/globus/etc/globus-host-ssl.conf</userinput>
</pre>


To create a host or service certificate follow the instructions above this section

 
---++ JCLARENS

---+++ Starting and stopping Apache:

VDT installation adds user daemon to run apache and tomcat as daemon. To change the user you will need to add the new user that apache and tomcat will run under and then modify the =/etc/init.d/{apache, tomcat-5}= services to reflect the new user.

Need to make some changes in the =$VDT_LOCATION/apache/conf/httpd.conf=:

<pre class="programlisting">
Listen 80  <em>(port that apache will listen to)</em>
ServerAdmin <em>adminaddress@wherever.youare</em>
</pre>

---++++ To start or stop apache:
<pre class="screen">
$ <userinput>service apache start</userinput>
$ <userinput>service apache stop</userinput>
</pre>


---+++ Starting Tomcat:
Customize =$VDT_LOCATION/tomcat/v5/conf/server.xml= to include the port that tomcat will run under and the secure ports that jclarens services will use:
<pre class="programlisting">
&lt;Connector port="8080"
   maxThreads="150" minSpareThreads="25" maxSpareThreads="75"
   enableLookups="false"  acceptCount="100"
   debug="0" connectionTimeout="20000"
   disableUploadTimeout="true" maxHttpHeaderSize="8192" />

&lt;Connector port="8443"
sSLImplementation="org.glite.security.trustmanager.tomcat.TMSSLImplementation"
   sslCAFiles="/etc/grid-security/certificates/*.0"
   crlFiles="/etc/grid-security/certificates/*.crl_url"
   sslCertFile="/etc/grid-security/http/httpcert.pem"
   sslKey="/etc/grid-security/http/httpkey.pem"
   log4jConfFile="/data/test-vdt/tomcat/v5/conf/log4j-trustmanager.properties"
   maxThreads="150" minSpareThreads="25" maxSpareThreads="75"
   enableLookups="false" disableUploadTimeout="true"
   acceptCount="100" debug="0" scheme="https" secure="true"
   clientAuth="true" sslProtocol="TLS" />

&lt;Connector port="8009"
   enableLookups="false" redirectPort="8443" debug="0"
   protocol="AJP/1.3" />
</pre>

---++++ To start or stop tomcat:
<pre class="screen">
$ <userinput>service tomcat-5 start</userinput>
$ <userinput>service tomcat-5 stop</userinput>
</pre>

---+++ Customize jclarens
To create a new service under jclarens the following should be done:

   1. Write the appropriate java application code and place them under the package directory structure naming the top directory =java=, e.g. if the package is =osg.gratia=, then all java files should be under the following directory tree: %BR% =~myhome/GratiaServices/java/osg/gratia=
   1. Since =jclarens= uses the =ant= building tool, do not name any of your java files as:
   * =MyService.java=
   * =MyServiceService.java=
   * =MyServiceServiceLocator.java=
   * =MyServiceSoapBindingImpl.java=
   * =MyServiceSoapBindingStub.java=
   * =MyServiceXmlRpcBinding.java=

The main service call should be in a file named:
   * =MyServiceImpl.java=

The file should look like:
<pre class="programlisting">
package osg.gratia;

import java.io.*;
import java.util.ArrayList;
import java.util.Iterator;
import java.io.File;
import org.dom4j.*;
import org.dom4j.io.SAXReader;
import org.hibernate.*;
import org.hibernate.cfg.Configuration;

public class MyServiceImpl implements osg.gratia.MyService {
your service implementation
}
</pre>

Under the top directory of the source code (for example =~myhome/GratiaServices/=), the following files need to be in place (for an example of these files look at the appendix). You may pickup example files from the [[http://clarens.sourceforge.net/jclarens/][jclarens site]].
   * =build.xml=
   * =MyService.wsdl=
   
Assuming that you have installed the VDT, before doing anything else you need to pickup some environment variables from the package, so:
<pre class="screen">
$ <userinput>source $VDT_LOCATION/setup.sh</userinput>   <em>#or setup.csh</em>
$ <userinput>ant wsdl2java</userinput>
</pre>

The ant command will create the following files under your package java directory tree:
   * =MyService.java=
   * =MyServiceService.java=
   * =MyServiceServiceLocator.java=
   * =MyServiceSoapBindingImpl.java=
   * =MyServiceSoapBindingStub.java=
   * =MyServiceXmlRpcBinding.java=
   * =deploy.wsdd=
   * =undeploy.wsdd=

Also, at the top directory structure the following files will be copied (if included in the build file): 
   * =MyService_deploy.wsdd=
   * =MyService_undeploy.wsdd=


At this point you should edit the =MyServiceSoapBindingImpl.java= to contain the specifics for your service, e.g.:

<pre class="programlisting">
package osg.gratia;

public class CollectorSoapBindingImpl implements osg.gratia.MyService {
    public java.lang.String MyServiceRoutine(java.lang.String MyArg1, java.lang.String MyArg2) 
    throws java.rmi.RemoteException {
        return null;
    }
}
</pre>

Now you need to compile the sources and create the jar files. Use ant and the associated =build.xml= file for this. Remember to include any jar libraries required in the build path. This step will create the directory classes and the main service jar file =MyService.jar=:

<pre class="screen">
$ <userinput>ant jar</userinput>
</pre>

Before going to the installation step, the =MyService_service.properties= jclarens-specific file needs to be edited. For an example look at the appendix.

The next step is to install the service under jclarens (=$VDT_LOCATION/tomcat/v5/webapps/jclarens=)
The steps for this are simply to copy the created files to certain locations. Look at the =build.xml= file example.

<pre class="screen">
$ <userinput>ant install</userinput>
</pre>

Once this is done, you need to add the service to jclarens. To do so:
<pre class="screen">
$ <userinput>cd $VDT_LOCATION/tomcat/v5/webapps/jclarens/ </userinput>
</pre>

Edit =xmlrpc_handlers.properties= and add the following line:
<pre class="programlisting">
service.MyService.properties= MyService_service.properties
</pre>


The general JClarens configuration is stored at =$VDT_LOCATION/tomcat/v5/webapps/jclarens/xmlrpc_handlers.properties=. The following were changed: 
   * <tt>service.system.hostKeyPass=password</tt>
   * <tt>clarens.admin=</tt>

The following were commented (could not find these files): 
   * =# clarens.trustStore=/usr/lib/jclarens/jakarta-tomcat-5.0.28/webapps/jclarens/keystores/cacerts.jks=
   * =#  clarens.trustStorePassword=changeit=


---++++ Java
<pre class="programlisting">
CollectorImpl.java
CollectorImpl.java.debug
Collector.java
CollectorService.java
CollectorServiceLocator.java
CollectorSoapBindingImpl.java
CollectorSoapBindingStub.java
CollectorXmlRpcBinding.java
DateElement.java
deploy.wsdd
DurationElement.java
FloatElement.java
IntegerElement.java
JobIdentity.java
JobUsageRecord.java
KeyInfoType.java
RecordIdentity.java
ResourceElement.java
StringElement.java
undeploy.wsdd
UsageRecordLoader.java
UsageRecordLoader.java.debug
UserIdentity.java
Utils.java
Utils.java.debug
Utils.java.orig
XmlElement.java
</pre>

---++++ Src
<pre class="programlisting">
CollectorImpl.java          
Collector.java           
DateElement.java            
DurationElement.java     
FloatElement.java     
IntegerElement.java   
JobIdentity.java
JobUsageRecord.java
KeyInfoType.java
RecordIdentity.java
ResourceElement.java
StringElement.java
UsageRecordLoader.java
UserIdentity.java
Utils.java
XmlElement.java
</pre>


---+++ Discovery Service
The Discovery Service has two configuration files, but only one needs to be customized: %BR% =$VDT_LOCATION/tomcat/v5/webapps/jclarens/mlstore.properties=

The Discovery Service group, defined by the <tt>lia.Monitor.Group = Test</tt> property, must match the group set in the MonALISA configuration =$VDT_LOCATION/MonaLisa/Service/VDTFarm/ml.properties=.

%BOTTOMMATTER%
-- Main.PenelopeConstanta -- created the notes %BR%
-- Main.ForrestChristian - transcribed and edited %BR%