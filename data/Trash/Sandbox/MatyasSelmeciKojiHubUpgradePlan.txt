%META:TOPICINFO{author="MatyasSelmeci" date="1421098311" format="1.1" reprev="1.1" version="1.1"}%
%META:TOPICPARENT{name="MatyasSelmeciSandbox"}%

---++ Koji-Hub Upgrade Plan

Upgrading koji-hub will require a day of downtime and timely assistance from CHTC infrastructure, so we need to schedule a day that works for everyone.

Tasks which we can do are marked with (OSG); tasks that CHTC infrastructure needs to do are marked with (INF).

---+++ Upgrade

   1. (OSG) Shut down koji-hub
   1. (OSG) Stop postgres on db-01 and make a backup of the database (dirclone /var/lib/pgsql /var/lib/pgsql.snapshot)
   1. (INF) Take out the hard drive from koji-hub and put in a blank hard drive of at least the same size
   1. (INF) Install EL6 on the blank hard drive, making sure it has the following partitions at least:
      * 40G for /var/lib/mock
      * 350G+ for /mnt/koji, preferably a lot more
   1. (INF) Shut off the machine, put the old hard drive into a secondary drive bay
   1. (INF) Turn on the machine and mount the partitions from the old hard drive, read-only:
      * /dev/mapper/VolGroup0-LogVol00 as /old-koji
      * /dev/mapper/VolGroup0-LogVol01 as /old-koji/home
      * /dev/mapper/VolGroup0-LogVol03 as /old-koji/mnt/koji
   1. (OSG) Follow the "Restoring Koji-Hub" section in MatyasSelmeciKojiHubRestoreRecipe, except restore from /old-koji instead of backups
   1. (OSG) Start postgres on db-01
   1. (OSG) Follow the "Starting Services and Validation" section in the restore recipe

---+++ Rollback

   1. (OSG) Stop postgres on db-01
   1. (OSG) Restore postgres database from snapshot on db-01 (dirclone /var/lib/pgsql.snapshot /var/lib/pgsql)
   1. (OSG) Start postgres on db-01
   1. (INF) Remove the new hard drive from koji-hub and put the old hard drive back in
   1. (INF) Start koji-hub
