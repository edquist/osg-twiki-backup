%META:TOPICINFO{author="MatyasSelmeci" date="1421114011" format="1.1" reprev="1.3" version="1.3"}%
%META:TOPICPARENT{name="MatyasSelmeciSandbox"}%
---++ Koji-Hub Upgrade Plan

Upgrading koji-hub will require a day of downtime and timely assistance from CHTC infrastructure, so we need to schedule a day that works for everyone.

Tasks which we can do are marked with (OSG); tasks that CHTC infrastructure needs to do are marked with (INF).

---+++ Upgrade

   1. =(OSG)= Shut down koji-hub
   1. =(OSG)= Stop postgres on db-01 and make a backup of the database (dirclone /var/lib/pgsql /var/lib/pgsql.snapshot)
   1. =(INF)= Take out the hard drive from koji-hub and put in a blank hard drive of at least the same size
   1. =(INF)= Install EL6 on the blank hard drive, making sure it has the following partitions at least:
      * 40G for /var/lib/mock
      * 350G+ for /mnt/koji, preferably a lot more
   1. =(INF)= Shut off the machine, put the old hard drive into a secondary drive bay, turn on the machine
   1. =(OSG)= Mount the partitions from the old hard drive, read-only:
      1. Edit /etc/fstab and add:<pre class="file">
UUID=1bc76f3e-6762-4ef3-beae-4c4c10dd90c8  /mnt/oldkoji           ext4  noauto,ro  1 1
UUID=110be48f-a256-45ac-852d-cf8c7030f96f  /mnt/oldkoji/home      ext4  noauto,ro  1 2
UUID=815e97cf-08fe-4221-8e0c-49ea49a2d9a5  /mnt/oldkoji/mnt/koji  ext4  noauto,ro  1 2
</pre>
      1. Create the mount points: <code>mkdir -p /mnt/oldkoji/{home,mnt/koji}</code>
      1. Mount: <code>mount /mnt/oldkoji; mount /mnt/oldkoji/home; mount /mnt/oldkoji/mnt/koji</code>
   1. =(OSG)= Follow the "Restoring Koji-Hub" section in MatyasSelmeciKojiHubRestoreRecipe, except restore from /mnt/oldkoji instead of backups
   1. =(OSG)= Start postgres on db-01
   1. =(OSG)= Follow the "Starting Services and Validation" section in the restore recipe

---+++ Rollback

   1. =(OSG)= Shut down koji-hub
   1. =(OSG)= Stop postgres on db-01
   1. =(OSG)= Restore postgres database from snapshot on db-01 (dirclone /var/lib/pgsql.snapshot /var/lib/pgsql)
   1. =(OSG)= Start postgres on db-01
   1. =(INF)= Remove the new hard drive from koji-hub and put the old hard drive back in
   1. =(INF)= Start koji-hub
