%META:TOPICINFO{author="SuchandraThapa" date="1226537030" format="1.1" reprev="1.9" version="1.9"}%
%META:TOPICPARENT{name="Main.SuchandraThapa"}%
---+ Installing a CE in Relatively Few Easy Steps
---++ Preinstallation
Before you install you'll need a few things:
    1 DOE grid certificate 
    2 DOE host certificate 
    3 an user account for rsv
    4 an user account called daemon for the osg services 
    5 ntp set up and providing time synchronization
Getting these will require some time so it's best to do these well in advance of installing your CE.  We will outline how to do steps 1 and 2 below, the other steps are system specific so you will need to do that as well.

----+++ Getting a DOE grid certificate
A DOE grid certificate is a certificate for individuals that will allow you to identify yourself when access grid services.  It is needed to submit jobs to grid sites and to test your new installation.  In order to get  a certificate, you will need to go to the DOE certificate [[https://pki1.doegrids.org/ca/][page]] and then fill in the form.  You will need to have a sponsor and know the VO that your site will be a member of.  If you are not a member of any VO, then you should be able to use OSG if you discuss it with the OSG registration authority.

Once you get the certificate, you should move it and your private key to the =~/.globus= directory of your user account  in order to use it.  The certificate should be saved to =~/.globus/usercert.pem= and the corresponding private key should be called =~/.globus/userkey.pem=.  

Also you should make note of your certificate's distinguished name (DN).  This is a string that should be something like =DC=org/DC=doegrids/OU=People/CN=Your Name Serial= where =Serial= is a automatically generated serial number for the certificate and =Your Name= is the name you gave when applying for the certificate.

---+++ Getting a DOE host  certificate
Getting a host certificate is a little more involved.  You will need a host certificate and 2 service certificates (http and rsv) for your site so that your site will be able to authenticate itself when accepting requests from grid enabled tools such as globus-job-run or gridftp.  If you have an existing OSG installation you can request certificates by issuing the following commands after going to a directory that is readable only by the root account and which can be used to hold your certificate requests and private keys.
<verbatim>
source $OSG_LOCATION/setup.sh
cd 
mkdir host_cert
cd host_cert
cert-request  -host your.host  -dir .  -ou s
mkdir http_cert
cd http_cert
cert-request  -host your.host  -dir .  -ou s -service http 
mkdir rsv_cert
cd rsv_cert
cert-request  -host your.host  -dir .  -ou s -service rsv 
</verbatim>

You will need to answer a few questions when generating the requests and will get a serial number after the command completes.  This serial will let you retrieve your certificate once it has been signed.  Also after running these commands, you will have a file of the form xxxkey.pem where xxx is a number.  You will need that file since it contains the private key for your certificate.  

After a little time, you should receive an email from the registration authority (RA) of the virtual organization (VO) that you indicated that your site is a member of.  The email will give you instructions on how to retrieve your host certificates.  You can also check the status of your request and retrieve your certificates from the [[https://pki1.doegrids.org/ca/][DOE Grids site]].

If you don't have an existing OSG CE installation, you can create a certificate in the process of installing the CE software.  We will outline how to do so below.

---++ Installation
This guide will assume that you install software in the /opt directory and that this directory is located on a local drive (or a networked drive that has fairly high performance and low latency).  The installation will require about 4 GB of space.  This guide will also install a condor batch manager in your osg installation.  *Please adjust this to your specific circumstances.*

---+++ Pacman
The first component you will need to install is pacman.  Pacman is the package manager that is used by the OSG to distribute it's software.  The installation process for this is fairly simple and is outlined below

   * =cd /opt=
   * <verbatim>wget http://physics.bu.edu/pacman/sample_cache/tarballs/pacman-latest.tar.gz</verbatim>
<verbatim>
[root@uct3-edge5 opt]# wget http://physics.bu.edu/pacman/sample_cache/tarballs/pacman-latest.tar.gz
--15:20:25--  http://physics.bu.edu/pacman/sample_cache/tarballs/pacman-latest.tar.gz
           => `pacman-latest.tar.gz'
Resolving physics.bu.edu... 128.197.41.42
Connecting to physics.bu.edu|128.197.41.42|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 852,424 (832K) [application/x-gzip]

100%[====================================>] 852,424        1.67M/s             

15:20:26 (1.67 MB/s) - `pacman-latest.tar.gz' saved [852424/852424]
</verbatim>
   * =tar xzf pacman-latest.tar.gz=
   * At this point you will have a directory called pacman-*x.xx* where *x.xx* is version number of pacman
   * =ln -s pacman-*x.xx* pacman=, This will allow you to upgrade pacman at a later time without changing your references to the pacman binaries
   * =cd pacman=
   * =source setup.sh= or =source setup.csh= depending on whether you are using a bash shell or c shell.  This step will initialize the pacman setup and get the correct environment variables and paths into your environment.

At this point, pacman is setup and is ready for your use.

---+++ Create directories for OSG services
   * =cd /opt=
   * =mkdir share=
   * =mkdir share/data=
   * =mkdir share/app=

---+++ Installing the CE software
This guide assumes that you will be using a gridmap for your setup and not a GUMS server.  To setup things up using a gums server, please refer to the release documentation for OSG CE software.

   * =cd /opt=
   * =mkdir osg-1.0.0=
   * =ln -s osg-1.0.0 osg=, Doing this lets you refer to things in /opt/osg so that you can upgrade your osg ce installation in a versioned directory (e.g. osg-x.y.z) and seamlessly switch from an older install to a newer install.
   * =cd osg=
   * =export PER_JOB_HISTORY_DIR = /opt/osg/gratia/var/data=
   * =pacman -get OSG:ce= , you should see the following
<verbatim>
[root@uct3-edge5 osg]# pacman -get OSG:ce
Do you want to add [http://software.grid.iu.edu/pacman/] to [trusted.caches]? (y/n/yall): yall
Beginning VDT prerequisite checking script vdt-common/vdt-prereq-check...       

All prerequisite checks are satisfied.
                                                               


========== IMPORTANT ==========
The VDT no longer installs certificate authority certificates at install time.
Most of the software installed by the VDT *will not work* until you install
certificates.  To complete your CA certificate installation, see the notes
in the post-install/README file.



Existing /tmp/opt/osg-1.0.0/edg/etc/edg-mkgridmap.conf moved to /tmp/opt/osg-1.0.0/edg/etc/edg-mkgridmap.conf.orig
Merge it manually with the new /tmp/opt/osg-1.0.0/edg/etc/edg-mkgridmap.conf if you had a special edg-mkgridmap.conf
                                  
Pacman Installation of OSG-1.0.0 Complete
</verbatim>
   * =source setup.sh=
   * =pacman -get OSG:Globus-Condor-Setup=
   * =pacman -get OSG:ManagedFork=

The software should be installed at this point and you can move on to configuration.
---+++ Configuring the CE software
At this point, the CE software will have been installed and is partially configured.  There are a few more steps needed to get a working setup.

---++++ Setting up gridmap files
For a simple install, you can use a gridmap file to create a list of users that are allowed to access your compute element.  Since this is an example installation, we will just set things up so that you are the sole authorized user.

   * =cd /etc=
   * =mkdir grid-security=
   * =chmod 755 grid-security=
   * =cd grid-security=
   * =echo '"DN" USER_ACCOUNT' > grid-mapfile= , here you will need to replace *DN* with the DN of your grid certificate and *USER_ACCOUNT* with the name of the account that this DN should map to.  *Note, the do not map this DN to root or any other privileged account*
   * =chmod 644 grid-mapfile=

---++++ Setting up your CA certificate updater
You will now need to setup and retrieve the ca certs updater in order to have a functional 
   * Open =/opt/osg/vdt/etc/vdt-update-certs.conf= in your text editor of choice
   * Uncomment the line the following line (i.e. remove the leading =#= mark)
<verbatim>
#cacerts_url = http://software.grid.iu.edu/pacman/cadist/ca-certs-version
</verbatim>
   * Run the following commands at the command line:
<verbatim>
. $VDT_LOCATION/vdt-questions.sh; $VDT_LOCATION/vdt/sbin/vdt-setup-ca-certificates
vdt-control --enable vdt-update-certs
vdt-control --on vdt-update-certs
</verbatim>

You should now have the ca certs updater setup and it will automatically update your ca certificates using the certs distributed by the OSG grid operations center (GOC).

---++++ Generating host and service certificates (Optional)
If you already have your host and service certificates, you can skip this section.  Otherwise, the instructions in this section will allow you to create host and service certificates.

First go to a directory that is readable only by the root account and which can be used to hold your certificate requests and private keys. Then run the following commands:
<verbatim>
source $OSG_LOCATION/setup.sh
cd 
mkdir host_cert
cd host_cert
cert-request  -host your.host  -dir .  -ou s
mkdir http_cert
cd http_cert
cert-request  -host your.host  -dir .  -ou s -service http 
mkdir rsv_cert
cd rsv_cert
cert-request  -host your.host  -dir .  -ou s -service rsv 
</verbatim>

You will need to answer a few questions when generating the requests and will get a serial number after the command completes.  This serial will let you retrieve your certificate once it has been signed.  Also after running these commands, you will have a file of the form xxxkey.pem where xxx is a number.  You will need that file since it contains the private key for your certificate.    

After a little time, you should receive an email from the registration authority (RA) of the virtual organization (VO) that you indicated that your site is a member of.  The email will give you instructions on how to retrieve your host certificates.  You can also check the status of your request and retrieve your certificates from the [[https://pki1.doegrids.org/ca/][DOE Grids site]].

---++++ Installing host certificates
At this point you should have 3 pem files with your host certificates and the corresponding private keys.  You will need to place these in the grid-security directory as follows.
   * copy the host certificate to =/etc/grid-security/hostcert.pem=
   * copy the host private key to =/etc/grid-security/hostkey.pem=
   * =mkdir /etc/grid-security/http=
   * =mkdir /etc/grid-security/rsv=
   * =chmod 755 /etc/grid-security/http=
   * =chmod 755 /etc/grid-security/rsv=
   * =chmod 644 /etc/grid-security/hostcert.pem=
   * =chmod 400 /etc/grid-security/hostkey.pem=
   * copy the http service certificate to  =/etc/grid-security/http/httpcert.pem=
   * copy the http service key to  =/etc/grid-security/http/httpkey.pem=
   * =chmod 644 /etc/grid-security/http/httpcert.pem=
   * =chmod 400 /etc/grid-security/http/httpkey.pem=
   * copy the http service certificate to  =/etc/grid-security/containercert.pem=
   * copy the http service key to  =/etc/grid-security/containerkey.pem=
   * =chmod 644 /etc/grid-security/containercert.pem=
   * =chmod 400 /etc/grid-security/containerkey.pem=
   * copy the rsv service certificate to  =/etc/grid-security/rsv/rsvcert.pem=
   * copy the rsv service key to  =/etc/grid-security/rsv/rsvkey.pem=
   * =chmod 644 /etc/grid-security/rsv/rsvcert.pem=
   * =chmod 400 /etc/grid-security/rsv/rsvkey.pem=
   
---++++ Generate support files and enable edg-mkgridmap
This step will generate the vo support files needed by your system.

   * =vdt-register-service --name edg-mkgridmap --enable=
   * =vdt-control --on edg-mkgridmap=
   * =/opt/osg/edg/sbin/edg-mkgridmap  >>/opt/osg/edg/log/edg-mkgridmap.log 2>&1=

---++++ Configuring your system 
Here we will configure the majority of the system using the configure-osg script and a configuration file.  In order to do this, follow the steps below:

   * =cd /tmp=
   * =source /opt/osg/setup.sh=
   * =cp $OSG_LOCATION/monitoring/simple-config.ini .=
   * Edit the simple-config.ini file and make the following changes
      * Go to the section starting with =[Site Information]=
         * Remove the =%(unavailable)s= and replace it with the correct values for the variables listed below
         * =site_name=
         * =sponsor=
         * =site_policy=
         * =contact=, set this to your email address
         * =city=
         * =country=
         * =latitude=
         * =longitude=
      * Go to the section starting with =[Condor]=
         * Remove the =%(unavailable)s= and replace it with the correct values for the variables listed below
         * =enabled= , change the =%(unavailable)s= to =%(enable)s=
         * =home=, set this to =/opt/osg/condor=
         * =wsgram= , change the =%(unavailable)s= to =%(enable)s=
      * Go to the section starting with =[ManagedFork]=
         * Remove the =%(unavailable)s= and replace it with the correct values for the variables listed below
         * =enabled= , change the =%(unavailable)s= to =%(enable)s=
         * =condor_location= , change the =%(unavailable)s= to =/opt/osg/condor=
      * Go to the section starting with =[Misc Services]=
         * Remove the =%(unavailable)s= and replace it with the correct values for the variables listed below
         * =use_cert_updater= , change the =%(unavailable)s= to =%(enable)s=
      * Go to the section starting with =[Storage]=
         * Remove the =%(unavailable)s= and replace it with the correct values for the variables listed below
         * =grid_dir= , change the =%(unavailable)s= to =/opt/wn=
         * =app_dir= , change the =%(unavailable)s= to =/opt/share/app=
         * =data_dir= , change the =%(unavailable)s= to =/opt/share/data=
         * =worker_node_temp= , change the =%(unavailable)s= to =/tmp=
         * =site_read= , change the =%(unavailable)s= to =/opt/share/data=
         * =site_write= , change the =%(unavailable)s= to =/opt/share/data=
      * Go to the section starting with =[GIP]=
         * Remove the =%(unavailable)s= and replace it with the correct values for the variables listed below
         * =batch= , change the =%(unavailable)s= to =condor=
         * =gsiftp_path= , change the =%(unavailable)s= to =/opt/share/data=
         * =sc_name_1= , change the =%(unavailable)s= to the name of your cluster
         * =sc_vendor_1= , change the =%(unavailable)s= to the vendor of your  cluster's cpus (e.g. =Genuine Intel=, =Authentic AMD=)
         * =sc_model_1= , change the =%(unavailable)s= to the model of your  cluster's cpus 
         * =sc_clock_1= , change the =%(unavailable)s= to the clock speed of your  cluster's cpus 
         * =sc_numlcpus_1= , change the =%(unavailable)s= to the number of logical cpus your cluster has
         * =sc_numpcpus_1= , change the =%(unavailable)s= to the number of physical cpus your cluster has
         * =sc_ramsize_1= , change the =%(unavailable)s= to the ram that the worker nodes your cluster has
         * =sc_nodes_1= , change the =%(unavailable)s= to =1=
      * Go to the section starting with =[RSV]=
         * Remove the =%(unavailable)s= and replace it with the correct values for the variables listed below
         * =enabled= , change the =%(unavailable)s= to =%(enable)s=
         * =rsv_user= , change the =%(unavailable)s= to name of the account that has been created for rsv
         * =enable_ce_probes= , change the =%(unavailable)s= to =%(enable)s=
         * =ce_hosts= , change the =%(unavailable)s= to =%(localhost)s=
         * =enable_gridftp_probes= , change the =%(unavailable)s= to =%(enable)s=
         * =gridftp_hosts= , change the =%(unavailable)s= to =%(localhost)s=
         * =use_service_cert= , change the =%(unavailable)s= to =%(enable)s=
         * =rsv_cert_file= , change the =%(unavailable)s= to =/etc/grid-security/rsv/rsvcert.pem=
         * =rsv_key_file= , change the =%(unavailable)s= to =/etc/grid-security/rsv/rsvkey.pem=
           


---++++ Configuring WS-GRAM
The ws-gram system is a web services enabled method for submitting and monitoring jobs on grid resources.  The ws-gram system requires the following steps to configure it.

   * run =visudo= to edit the sudoers file
   * copy the contents of the =/opt/osg/monitoring/sudo-example.txt= file to the sudoers file
 
---++ Finishing up
----+++ Testing your installation
We will test your installation by checking to see whether it accepts grid jobs, gridftp requests, ws-gram job requests and that the rsv system checks are up and running.

For these steps, you will need to  login to your user account which should have your grid cert and key in the =~/.globus= directory.  Before you start you will need to do the following:
   * =source  /opt/osg/setup.sh=
   * =grid-proxy-init= , you should get output similar to:
<verbatim>
[sthapa@uct3-edge6 ~]$ grid-proxy-init
Your identity: /DC=org/DC=doegrids/OU=People/CN=Suchandra Thapa 757586
Enter GRID pass phrase for this identity:
Creating proxy ...................................................... Done
Your proxy is valid until: Wed Nov 12 23:21:53 2008
</verbatim>

----++++ Testing grid jobs
Here we will test the grid job submission system.  You can do this using the following steps:

   * =globus-job-run your.ce.hostname:2119/jobmanager /usr/bin/id= where your.ce.hostname is replaced with the hostname of your CE

You should get the uid and gids for the user account that your DN is mapped to.  In addition, you should be able to do this using a different job manager by specifying jobmanager-condor instead of jobmanager.

---++++ Testing gridftp
Gridftp is a system for transfering files between various grid aware systems.  You can test your system by following the steps below:
    
   * =echo "test file" > test.file=
   * =globus-url-copy file://path/to/current/dir/test.file gsiftp://your.ce.hostname/tmp/=  where the appropriate path to the current directory and your CE's hostname has been substituted
   * Once this is done, you should see a test.file in the /tmp on your ce
   * =globus-url-copy gsiftp://your.ce.hostname/tmp/test.file file://path/to/current/dir/new.file= where the appropriate substitutions have been made again
   * Once this is done, you should have a file called new.file in your current directory

---++++ Testing WS-GRAM
Testing ws-gram is similar to testing the job grid submission:

   * =globusrun-ws -submit -Ft Fork -F uct3-edge7.uchicago.edu:9443 -s -c /usr/bin/whoami=

You should get the uid and gids for the user account that your DN is mapped to.  In addition, you should be able to do this using a different job manager by specifying jobmanager-condor instead of jobmanager.

---++++ Checking RSV
RSV consists of a series of probes that run at varying intervals on your system to test your system's integrity and functionality. You can see the results of these probe tests by going to [[https://uct3-edge7.uchicago.edu:8443/rsv/][https://uct3-edge7.uchicago.edu:8443/rsv/]].

----++++
At this point your installation should be complete and operational.  The =README= file in the =/opt/osg/post-install= directory will have more information on other things you can do and additional information on your installation.

-- Main.SuchandraThapa - 10 Nov 2008
