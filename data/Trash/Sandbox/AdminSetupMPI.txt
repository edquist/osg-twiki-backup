%META:TOPICINFO{author="ShreyasCholia" date="1234484832" format="1.1" reprev="1.5" version="1.5"}%
---+!! *<noop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%

---++ Adding site specific MPI attributes
Follow the instructions on the [[ReleaseDocumentation.GenericInformationProviders][Generic Information Providers]] page to add Glue attributes. The following is an example of how to add an MPICH version along with the module information.

In etc/add-attributes.conf:
<pre class=screen>
# MPICH Intel
dn: GlueSoftwareLocalID=MPICH_1.2.7p1_intel, GlueSubClusterUniqueID=lepton.rcac.
purdue.edu, GlueClusterUniqueID=lepton.rcac.purdue.edu,mds-vo-name=local,o=grid
objectClass: GlueClusterTop
objectClass: GlueSoftware
objectClass: GlueKey
objectClass: GlueSchemaVersion
GlueHostApplicationSoftwareRunTimeEnvironment: MPICH_1.2.7p1_intel
GlueSoftwareLocalID: MPICH_1.2.7p1_intel
GlueSoftwareName: MPICH
GlueSoftwareVersion: 1.2.7.p1_intel
GlueSoftwareInstalledRoot: /apps/steele/mpich-1.2.7p1/64/p4-intel-10.1.015
GlueSoftwareModuleName: mpich-intel
GlueSoftwareEnvironmentSetup: module load mpich-intel
GlueChunkKey: GlueSubClusterUniqueID=lepton.rcac.purdue.edu
GlueSchemaVersionMajor: 1
GlueSchemaVersionMinor: 3
</pre>

in etc/alter-attributes.conf:
<pre class=screen>
GlueHostApplicationSoftwareRunTimeEnvironment: MPICH_1.2.7p1_gcc
</pre>

There are a few points to make here. First, the SoftwareInstalledRoot tells the user the location of the binaries and libraries for each MPI version. The SoftwareEnvironmentSetup attribute tells the user what module or softenv command to use in order to utilize the MPI version in their job. Finally, the SoftwareName and SoftwareVersion attributes make the MPI version easier to find using an ldapsearch.

---++ Add JobManager-specific bits
The hardest part of getting MPI jobs running is setting up the JobManager to deal with different MPI versions. In a general sense, there are only two things that need to be done:
   * Enable the "handle" attribute in the appropriate .rvf file
   * Add an MPI section to your JobManager <scheduler>.pm file


---++ PBS and Modules (Purdue)
Purdue uses a combination of the PBS scheduler and the [[http://modules.sourceforge.net/][modules]] environment management software. Most schedulers and environment managers should follow a similar pattern.

---+++ Enable the "handle" attribute
The first thing to do is to change the appropriate .rvf file in Globus. For PBS, this is in $GLOBUS_LOCATION/share/globus_gram_job_manager/pbs.rvf

Add the following lines to enable the "handle" RSL attribute:
<pre class=screen>
Attribute: handle
Description: "Defines the module that should be loaded"
ValidWhen: GLOBUS_GRAM_JOB_SUBMIT
</pre>

---+++ Make appropriate changes to the Globus JobManager
Next, the appropriate JobManager file needs to be modified to do something with our new handle attribute. For PBS, this file is located in $GLOBUS_LOCATION/lib/perl/Globus/GRAM/JobManager/pbs.pm

The first change to make is to get the handle name from the job description. To do this, add the following line in the sub submit{} stanza:
<pre class=screen>
    my $handle = $description->handle();
</pre>

The next change is the stanza to take care of the PBS job script:
<pre class=screen>
        if ($description->jobtype() eq "mpi")
        {
            my $this_count = ($description->totalprocesses() > 0) ?
                $description->totalprocesses() : $description->count();
            my $machinefilearg = ($cluster) ? ' -machinefile $PBS_NODEFILE' : '';

            if ($mpisoftenv)
            {
                print JOB 'which mpiexec >/dev/null 2>&1' . "\n";
                print JOB 'if [ $? == 0 ]; then' . "\n";
                print JOB "  mpiexec $machinefilearg -n " . $this_count;
                print JOB " $cmd_script_name < " .  $description->stdin() . "\n";
                print JOB 'else' . "\n";
                print JOB '  which mpirun >/dev/null 2>&1' . "\n";
                print JOB '  if [ $? == 0 ]; then' . "\n";
                print JOB "    mpirun -np " . $this_count . $machinefilearg;
                print JOB " $cmd_script_name < " .  $description->stdin() . "\n";
                print JOB '  else' . "\n";
            }
            else
            {
                print JOB ". /etc/profile.d/modules.sh\n";
                # ahoward Thu Aug 21 14:05:57 EDT 2008  
                # Check to see if user specified a module to load...
                if ($description->handle() ne '')
                {
                    print JOB "module load $handle\n";
                }
                # ... otherwise load a default module
                else
                {
                    print JOB " module load mpich-1.2.7p1-intel64/9.1.045\n";
                }
        
                if ($handle =~ m/mpich2/)
                {
                    print JOB "$mpirun -np " . $this_count;
                }
                else        
                {
                    print JOB "$mpirun -np " . $this_count . $machinefilearg;
                }
                
                #print JOB " " .  $description->executable() . " < " .  $description->stdin() . "\n";
                print JOB " " .  $description->executable() . " $args < " . $description->stdin() . "\n";
                #print JOB " $cmd_script_name < " .  $description->stdin() . "\n";

            }
            if ($mpisoftenv)
            {
                print JOB '  fi' . "\n";
                print JOB 'fi' . "\n";
            }

        }
</pre>

---++ PBS and Modules (NERSC)
---+++ NERSC-Franklin (Cray Environment)
The interactive login environment on the NERSC-Franklin Cray XT4 CE (based on SLES 10) is fundamentally different from the Worker node environment (Compute Node Linux). The implications of this are:
   * All MPI codes must be cross compiled so that they can run on the worker nodes
   * Worker nodes do not have support for dynamically loaded libraries. This means that the MPI job executable must be launched directly, and cannot be contained in a wrapper script
   * Users do not invoke "modules" in their jobs because of the above constraint.
   * Because of the complexities of cross-compilation, it is recommended to login directly via ssh and compile any codes directly on the interactive nodes. More details can be found here: http://www.nersc.gov/nusers/systems/franklin/programming/

Once codes have been compiled for the worker node environment, users may launch MPI jobs using grid interfaces, with the caveat that MPI jobs must *not* be wrapped in a shell script. 

---+++ NERSC-Jacquard and NERSC-Davinci (SLES 10 environment)
MPI Modules are automatically sourced for jobs on the NERSC-Jacquard and NERSC-Davinci systems. To enable this we add the following lines to $VDT_LOCATION/vdt/etc/vdt-local-setup.sh{.csh}
<pre class=screen>
# vi $VDT_LOCATION/vdt/etc/vdt-local-setup.sh
source /etc/profile.d/modules.sh
module load mvapich path

# vi $VDT_LOCATION/vdt/etc/vdt-local-setup.csh
source /etc/profile.d/modules.csh
module load mvapich path
</pre>

To source other modules (in this example: module_name) in your job, simply add the following line to your job script:
<pre class=screen>
module load module_name
</pre>

---+++ Globus Jobmanager Changes

Here is a diff of the NERSC PBS jobmanager from the original PBS jobmanager (for non Cray systems NERSC-Jacquard and NERSC-Davinci)

<pre class='screen'>
$ diff pbs.pm pbs.pm.orig 
24,25c24
<     # Change CPU per node - SPC, NERSC
<     $cpu_per_node = 2;
---
>     $cpu_per_node = 1;
72,78d70
< 
<         # For non-mpi jobs, change cluster variable to bypass bogus ssh - SPC, NERSC
<         if($description->jobtype !~ /^(mpi)$/)
<         {
<            $cluster = 0;
<         }
< 
271d262
<         # Add ppn parameter - SPC, NERSC
273c264
<         myceil($description->count() / $cpu_per_node), ":ppn=$cpu_per_node", "\n";
---
>         myceil($description->count() / $cpu_per_node), "\n";
512,514c503
<             # NODEFILE semantics not supported at NERSC - SPC, NERSC
<             # my $machinefilearg = ($cluster) ? ' -machinefile $PBS_NODEFILE' : '';
<             my $machinefilearg = '';
---
>             my $machinefilearg = ($cluster) ? ' -machinefile $PBS_NODEFILE' : '';
</pre>

The Cray systems have additional MPI changes due to an idiosyncratic job launcher (aprun instead of mpirun), lack of dynamic library support and specialized PBS variables.
Here is the diff for the NERSC-Franklin Cray XT4 system:
<pre class='screen'>
19,20c19
<     # Change to aprun - SPC, NERSC
<     $mpirun = '/usr/bin/aprun';

---
>     $mpirun = 'no';
72,77d70
< 
<         # For non-mpi jobs, change cluster variable to bypass bogus ssh - SPC, NERSC
<         if($description->jobtype !~ /^(mpi)$/)
<         {
<            $cluster = 0;
<         }
262,265c255
< 
<       # Change -l nodes to -l mppwidth - SPC, NERSC
<       print JOB '#PBS -l mppwidth=', $description->nodes(), "\n";
---
>       print JOB '#PBS -l nodes=', $description->nodes(), "\n";
269,271c259
<       # Change -l nodes to -l mppwidth - SPC, NERSC
<       print JOB '#PBS -l mppwidth=', $description->host_count(), "\n";
---
>       print JOB '#PBS -l nodes=', $description->host_count(), "\n";
275,284c263,264
<       # Change -l nodes to -l mppwidth - SPC - NERSC
<       print JOB '#PBS -l mppwidth=', $description->count(), "\n";
< 
<       # May want to tweak mppnppn later - SPC - NERSC
<       # print JOB '#PBS -l mppnppn=', $cpu_per_node, "\n";
<       # myceil($description->count() / $cpu_per_node), "\n";
< 
< 
---
>         print JOB '#PBS -l nodes=',
>         myceil($description->count() / $cpu_per_node), "\n";
523,525c503
<           #  NODEFILE semantics not supported at NERSC - SPC - NERSC
<           my $machinefilearg = '';
---
>             my $machinefilearg = ($cluster) ? ' -machinefile $PBS_NODEFILE' : '';
547,551c525,526
<               # NERSC aprun mods - SPC - NERSC
<               # directly launch executable on worker node, since scripts are not supported
<               print JOB "$mpirun -n " . $this_count . $machinefilearg . " ";
<               print JOB $description->executable()," $args < " .  $description->stdin() . "\n";
---
>               print JOB "$mpirun -np " . $this_count . $machinefilearg;
>               print JOB " $cmd_script_name < " .  $description->stdin() . "\n";
</pre>

-- Main.ShreyasCholia - 12 Feb 2009

-- Main.AndrewHoward - 06 Oct 2008
