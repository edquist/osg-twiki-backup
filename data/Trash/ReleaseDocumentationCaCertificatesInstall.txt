%META:TOPICINFO{author="RobertEngel" date="1284600659" format="1.1" reprev="1.12" version="1.12"}%
%META:TOPICPARENT{name="WebHome"}%
%DOC_STATUS_TABLE%

---+!! CA Certificates Installation Guide
%TOC%

---+ About this Document

<!-- useful variable definitions
   * Local UCL_USER = user
   * Local UCL_HOST = host
   * Local UCL_CWD   = /opt/osg-%VERSION%

   * Set INSTALL_LOGIN=user
   * Set INSTALL_HOST=host
   * Set INSTALL_DIR=/install_dir
-->

%ICON{hand}% This document is for system administrators and grid users alike. It contains the procedure to install certificates from [[Documentation/GlossaryC#DefsCA][Certificate Authorities]] recognized by the %LINK_OSG%.

---+ About Certificate Authorities and the Certificate Revocation List

The %LINK_OSG% distributes a number of certificates of [[Documentation/GlossaryC#DefsCA][Certificate Authorities]] that issue certificates to their members. By installing these certificates you establish a chain of trust with each of the certificate authorities and trust the servers and services certified by those authorities. The %LINK_GLOSSARY_CRL% is used to inform you about individual certificates that have been revoked.

%NOTE% The installation of CA Certificates is required on a %LINK_GLOSSARY_CE%, a %LINK_GLOSSARY_SE%, a [[ReleaseDocumentation/ClientInstallationGuide][OSG Client]] and in some cases on %LINK_GLOSSARY_WN%s.

---+ How to get Help?

If a problem cannot be resolved by following the [[#DebugInfo][Debugging Information]] on this page then follow the generic help procedures [[ReleaseDocumentation/HelpProcedure][here]]!

---+ Requirements

Before you proceed:

   1. decide which %LINK_GLOSSARY_CA% Package you want to install,
   1. decide between a system wide or local installation,
   1. decide who will maintain the %LINK_GLOSSARY_CA% Package,
   1. decide who will update the %LINK_GLOSSARY_CRL%,
   1. make sure the Certificate Scripts Package has been installed.

%STARTINCLUDE%

---+%IF{"defined 'DOC_TitleSubLevel'" then="%DOC_TitleSubLevel%" else=""}% CA Certificates Installation Procedure

The installation procedure contains several steps:

   1. Install the Certificate Scripts Package (Optional).
   1. Install a %LINK_GLOSSARY_CA% Package using =vdt-ca-manage=.
   1. Configure automatic updates of the CA Package and the %LINK_GLOSSARY_CRL%

<!-- include instructions that test and install the Certificate Scripts Package from the VDT -->
%INCLUDE{"ReleaseDocumentation/GetGridCertificates" section="InstallCertificateScriptsPackage" TOC_SHIFT="+"}%

---++%IF{"defined 'DOC_TitleSubLevel'" then="%DOC_TitleSubLevel%" else=""}% Install the Certificate Scripts Package

The Certificate Scripts Package is distributed by the %LINK_VDT% and is installed on every %LINK_GLOSSARY_CE%, %LINK_GLOSSARY_SE% and comes with every  [[ReleaseDocumentation/ClientInstallationGuide][OSG Client]]. By looking for the =vdt-ca-manage= program you can check if the package is already installed:

<pre class="screen">
[%UCL_USER%@%UCL_HOST% ~]$ cd $VDT_LOCATION
%UCL_PROMPT% . $VDT_LOCATION/setup.sh
%UCL_PROMPT% which vdt-ca-manage
%UCL_CWD%/vdt/bin/vdt-ca-manage
</pre>

=vdt-ca-manage= provides convenient options to configure which [[Documentation/GlossaryC#DefsCA][Certificate Authority]] to trust and how to install the CA Certificates on your resource. For all options you must have write permission on the installation directory. Some require _root_ privileges because are writing in system directories.

The most important options of =vdt-ca-manage= are:
   * =url= to choose one of the CADistribution made available by OSG, VDT or a custom one
   * =location= to select the path where the the CA certificates and the CRLs will be installed

A full description of the command is at VDTCAManage.

Here follow some common examples.
For all of them before running =vdt-ca-manage= you have to source the setup script in the install directory if you did not already. 

---+++%IF{"defined 'DOC_TitleSubLevel'" then="%DOC_TitleSubLevel%" else=""}% System-wide Installation

The location =/etc/grid-security/certificates= is one of the directories in the default search path for CA Certificates and it 
should preferably be used to make the certificates system-wide available when there are multiple VDT or Globus installations sharing the same certificates. This requires _root_ privileges: 

<pre class="rootscreen">
[root@%INSTALL_HOST% %INSTALL_DIR%]# source setup.sh
[root@%INSTALL_HOST% %INSTALL_DIR%]# vdt-ca-manage setupca %RED%--location root%ENDCOLOR% --url osg
Setting CA Certificates for VDT installation at '%INSTALL_DIR%'

Setup completed successfully.
</pre>

---+++%IF{"defined 'DOC_TitleSubLevel'" then="%DOC_TitleSubLevel%" else=""}% Use an existing CA Installation

It is often practical to reuse an existing %LINK_GLOSSARY_CA% Installation instead of creating a new installation using =vdt-ca-manage=:

<pre class="screen">
[%INSTALL_LOGIN%@%INSTALL_HOST% %INSTALL_DIR%]# vdt-ca-manage setupca %RED%--location /etc/grid-security/certificates%ENDCOLOR% --no-update
Setting CA Certificates for VDT installation at '%INSTALL_DIR%'

Setup completed successfully.
</pre>

%ICON{hand}% The command line option =--location= points to the existing installation. The command creates a softlink from =%INSTALL_DIR%/globus/TRUSTED_CA= to the existing installation (=/etc/grid-security/certificates= in this example).

This option is recommended when another package is maintaining the CA Installation, e.g. if you install the worker node client on the CE.

Other cases are when the CA Installation is managed centrally and exported via a shared file system or when it is installed and updated using RPM or DEB packages.

---++++%IF{"defined 'DOC_TitleSubLevel'" then="%DOC_TitleSubLevel%" else=""}% Rsync for CA/CRL's

This is a variation of using an existing CA installation  that can be used for the worker nodes of a big cluster. You can point to the local directory:
<pre class="screen">
[%INSTALL_LOGIN%@%INSTALL_HOST% %INSTALL_DIR%]# vdt-ca-manage setupca --location local --no-update
Setting CA Certificates for VDT installation at '%INSTALL_DIR%'

Setup completed successfully.
</pre>

Then download the tarball at http://fermigrid.fnal.gov/files/csync/csync-0.9.0.tgz and follow the instructions on how to set up the rsync server and clients to get your CA certs and CRLs in the local directory (=%INSTALL_DIR%/globus/share/certificates=). This package has been contributed to the VDT and will be part of the VDT in future versions.


---+++%IF{"defined 'DOC_TitleSubLevel'" then="%DOC_TitleSubLevel%" else=""}% Local installation

The local installation is recommended for self contained installations, e.g. a personal OSG client installation, testing of new packages or whenever you want to limit your footprint.

<pre class="screen">
[%INSTALL_LOGIN%@%INSTALL_HOST% %INSTALL_DIR%]# vdt-ca-manage setupca --location local --url osg
Setting CA Certificates for VDT installation at '%INSTALL_DIR%'

Setup completed successfully.
</pre>

By default this enables the periodic update of the CA Certificates and the CRL.

---+++%IF{"defined 'DOC_TitleSubLevel'" then="%DOC_TitleSubLevel%" else=""}% Provide and Install a custom CA Package

If a custom %LINK_GLOSSARY_CA% certificates package was made available on a web server, it can be used to be installed instead of the OSG specific CA package using the =--url= option on the command line to =vdt-ca-manage=:

<pre class="screen">
[%INSTALL_LOGIN%@%INSTALL_HOST% %INSTALL_DIR%]# vdt-ca-manage setupca --location /full/path/to/CAinstallation --url http://your.web.server/path/to/CA_distribution
</pre>

By default this enables the periodic update of the CA Certificates and the CRL.

---+++%IF{"defined 'DOC_TitleSubLevel'" then="%DOC_TitleSubLevel%" else=""}% Adding a Squid proxy to download CA certificates and CRLs
Specially if you have many hosts each one with its own CA Installation, you should always use a Squid proxy to reduce the network load. This is done by creating the file =/etc/sysconfig/fetch-crl with contents=
<pre class="screen">
export http_proxy=squid.gridcluster.org:3128
</pre>
where =squid.gridcluster.org= would be replaced with whatever the name of your site Squid server is and =3128= can be replaced if you are not using the default port. Then restart or enable the CA and CRL fetching scripts.


%STOPINCLUDE%

---++ Service Configuration/Startup/Shutdown
There are two services related to CAs: one to update the CA certificates, one to update the CRLs.

In the CE configuration they are enabled with the following lines in the configuration file: <pre class="file">
[Misc Services]
use_cert_updater = %(enable)s
</pre>

Alternatively you can enable and start the service manually:<pre class="rootscreen">
vdt-control --enable vdt-update-certs
vdt-control --on vdt-update-certs
</pre>
For the fetch_crl service (this will activate the service and the last command will retrieve an initial set of CRLs):<pre class="rootscreen">
vdt-control --enable fetch-crl
vdt-control --on fetch-crl
$VDT_LOCATION/vdt/bin/vdt-ca-manage fetchCRL
</pre>

If you did not install the certificate in a _root_ owned directory you don't need to be root to enable and start the service manually. You can use the =--non-root= option:<pre class="screen">
vdt-control --enable vdt-update-certs
vdt-control --enable fetch-crl
vdt-control --on --non-root
</pre>

---++ Validation of Service Operation

#DebugInfo
---++ Debugging Information
---+++!!File Locations
The certificate directory you specify will contain CA certificates and CRLs

---+++!!Debugging Procedure
If a certificate/CRL download is failing, check if you can connect to the server.

---+++!!Caveats/Known Issues
If a certificate has been downloaded partially you have to remove it. The utilities will not overwrite it.

---++ References
   * VDT documentation of =vdt-ca-manage: http://vdt.cs.wisc.edu/releases/2.0.0/certificate_authorities.html
   * VDT CA manage: VDTCAManage


---++ *Comments*
%COMMENT{type="tableappend"}%

<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = MarcoMambelli

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = General

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = Installation
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %YES%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %YES%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = RobertEngel
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %IN_PROGRESS%


 DEAR DOCUMENT TESTER
 ====================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = IwonaSakrejda
 Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %IN_PROGRESS%
############################################################################################################
-->
-- Main.JamesWeichel - 03 Feb 2010
