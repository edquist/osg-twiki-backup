%META:TOPICINFO{author="RobertEngel" date="1285769122" format="1.1" reprev="1.21" version="1.21"}%
%META:TOPICPARENT{name="WebHome"}%
%DOC_STATUS_TABLE%

---+!! CA Certificates Installation Guide
%TOC%

---+ About this Document

<!-- useful variable definitions
   * Local UCL_USER = user
   * Local UCL_HOST = host
   * Local UCL_CWD   = /opt/osg-%VERSION%
-->

%ICON{hand}% This document is for system administrators and grid users alike. It contains the procedure to install certificates from [[Documentation/GlossaryC#DefsCA][Certificate Authorities]] recognized by the %LINK_OSG%.

---+ About Certificate Authorities and the Certificate Revocation List

The %LINK_OSG% distributes a number of certificates of [[Documentation/GlossaryC#DefsCA][Certificate Authorities]] that issue certificates to their members. By installing these certificates you establish a chain of trust with each of the certificate authorities and trust the servers and services certified by those authorities. The %LINK_GLOSSARY_CRL% is used to inform you about individual certificates that have been revoked.

%NOTE% The installation of CA Certificates is required on a %LINK_GLOSSARY_CE%, a %LINK_GLOSSARY_SE%, a [[ReleaseDocumentation/ClientInstallationGuide][OSG Client]] and in some cases on %LINK_GLOSSARY_WN%s.

---+ How to get Help?

If a problem cannot be resolved by following the [[#Troubleshooting][Troubleshooting Information]] on this page then follow the generic help procedures [[ReleaseDocumentation/HelpProcedure][here]]!

---+ Requirements

Before you proceed:

   1. decide which %LINK_GLOSSARY_CA% Package you want to install, see [[ReleaseDocumentation/CaCertificatesInstall#Install_a_Certificate_Authority][here]]
   1. decide between a _system wide_ or _local_ installation, [[ReleaseDocumentation/CaCertificatesInstall#Install_a_Certificate_Authority][here]]
   1. make sure the Certificate Scripts Package has been [[ReleaseDocumentation/CaCertificatesInstall#Install_the_Certificate_Scripts][installed]]

%STARTINCLUDE%

---+%SHIFT% CA Certificates Installation Procedure

The installation procedure contains several steps:

   1. Install the Certificate Scripts Package (Optional).
   1. Install a %LINK_GLOSSARY_CA% Package using =vdt-ca-manage=.
   1. Configure automatic updates of the CA Package and the %LINK_GLOSSARY_CRL%

%NOTE% The installation procedure differs for worker and storage nodes part of a %LINK_GLOSSARY_CE% and %LINK_GLOSSARY_SE%. Please review the available [[ReleaseDocumentation/CaCertificatesInstall#CA_Installation_on_Worker_and_St][installation options]] before you proceed!

<!-- include instructions that test and install the Certificate Scripts Package from the VDT -->
%INCLUDE{"ReleaseDocumentation/GetGridCertificates" section="InstallCertificateScriptsPackage" TOC_SHIFT="+"}%

%STARTSECTION{"InstallACertificateAuthorityPackage"}%

---++%SHIFT% Install a Certificate Authority Package

Before you proceed to install a Certificate Authority Package you should decide which of the available packages to install. Choose according to the _resource group_ you chose earlier during the resource registration process with the %LINK_OIM%:

   * =osg= the package recommended to be used by production resources on the %LINK_OSG%, approved by the OSG Security Team
   * =itb= the package recommended to be used by resources of the %LINK_GLOSSARY_ITB%, approved by the OSG Security Team
   * =vdt= the package distributed with the %LINK_VDT% identical to the %LINK_GLOSSARY_CA% distribution of the %LINK_IGTF%
   * =url= a package provided at a given URL

%NOTE% If in doubt, please consult the policies of your home institution and get in contact with the [[Security/WebHome][Security Team]].

Next decide at what location to install the Certificate Authority Package:

   1. on the =local= file system beneath the current installation directory =%UCL_CWD%=
   1. on the =root= file system in a system directory =/etc/grid-security/certificates=
   1. in a =custom= directory that can also be shared

The instructions below illustrate each method using the Certificate Authority Package used on the %LINK_OSG%. Choose a package by changing the =--url= argument provided to =vdt-ca-manage=. 


%STARTSECTION{"LocalInstallation"}%
---+++%SHIFT% Local Installation

This local installation of the Certificate Authority Package is preferably be used by grid users without root privileges or if the CA certificates will not be shared by other VDT installations on the same host.

<pre class="screen">
%UCL_PROMPT% vdt-ca-manage setupca --location %RED%local%ENDCOLOR% --url osg
Setting CA Certificates for VDT installation at '%UCL_CWD%'

Setup completed successfully.
</pre>

After a successful installation the certificates will be installed in =%UCL_CWD%/globus/share/certificates=.

%ENDSECTION{"LocalInstallation"}%


---+++%SHIFT% Root Installation

This root installation of the Certificate Authority Package is preferably be used if the CA certificates will be shared by several VDT installations on the same host.

<pre class="rootscreen">
%UCL_PROMPT_ROOT% vdt-ca-manage setupca --location %RED%root%ENDCOLOR% --url osg
Setting CA Certificates for VDT installation at '%UCL_CWD%'

Setup completed successfully.
</pre>

After a successful installation the certificates will be installed in =/etc/grid-security/certificates=.

---+++%SHIFT% Custom Installation

This custom installation of the Certificate Authority Package is preferably be used if the CA certificates will be shared by several VDT installations on different hosts.

<pre class="screen">
%UCL_PROMPT% vdt-ca-manage setupca --location %RED%/mnt/nfs%ENDCOLOR% --url osg
Setting CA Certificates for VDT installation at '%UCL_CWD%'

Setup completed successfully.
</pre>

After a successful installation the certificates will be installed in =/mnt/nfs/certificates=.


---+++%SHIFT% Provide and Install a custom CA Package

If a custom %LINK_GLOSSARY_CA% certificates package was made available on a web server, it can be used to be installed using the =--url= option on the command line to =vdt-ca-manage=:

<pre class="screen">
%UCL_PROMPT% vdt-ca-manage setupca --location /mnt/nfs --url %RED%&lt;url to custom CA Package&gt;%ENDCOLOR%
Setting CA Certificates for VDT installation at '%UCL_CWD%'

Setup completed successfully.
</pre>

After a successful installation the certificates provided at the provided =--url= location will be installed in =/mnt/nfs/certificates=.
%ENDSECTION{"InstallACertificateAuthorityPackage"}%


%STARTSECTION{"EnableCACertificates"}%
---%SHIFT%++ Enable Updates of the CA Certificates

CA certificates have a limited lifetime and will expire. To keep the installed certificates current it is necessary to update them automatically using the =vdt-update-certs= provided by the %LINK_VDT%:

To _enable_  the service use:

<pre class="screen">
%UCL_PROMPT% vdt-control %RED%--enable%ENDCOLOR% vdt-update-certs
running 'vdt-register-service --name vdt-update-certs --enable'... %GREEN%ok%ENDCOLOR%
</pre>
%ENDSECTION{"EnableCACertificates"}%


%STARTSECTION{"EnableCRL"}%
---%SHIFT%++ Enable Updates of the Certificate Revocation List

The %LINK_GLOSSARY_CRL% lists certificates that have been temporarily or permanently revoked. To keep the CRL current it is necessary to update it automatically using =fetch-crl= provided by the %LINK_VDT%:

<pre class="screen">
%UCL_PROMPT% vdt-control %RED%--enable%ENDCOLOR% fetch-crl
running 'vdt-register-service --name vdt-update-certs --enable'... %GREEN%ok%ENDCOLOR%
</pre>
%ENDSECTION{"EnableCRL"}%

%STARTSECTION{"CACertificatesOnNodes"}%
---+%SHIFT% CA Certificates Installation on Worker and Storage Nodes

A %LINK_GLOSSARY_CE% or a %LINK_GLOSSARY_SE% may contain many worker or storage nodes respectively. Each node may require a %LINK_GLOSSARY_CA% installation. Several options exist to make CA Certificates available:

   1 Install the CA Certificates [[ReleaseDocumentation/CaCertificatesInstall#Local_Installation][locally]] on each node _and either_ proceed to instruction describing how to:
      * enable updates of the [[ReleaseDocumentation/CaCertificatesInstall#Enable_Updates_of_the_CA_Certifi][CA Certificates]] and the [[ReleaseDocumentation/CaCertificatesInstall#Enable_Updates_of_the_Certificat][Certificate Revocation List]] (%RED%Not recommended!%ENDCOLOR%).
      * [[ReleaseDocumentation/CaCertificatesInstall#Use_a_Web][use a web proxy]] to cache update requests from nodes.
      * [[ReleaseDocumentation/CaCertificatesInstall#Sync_the_local_CA_Installation][sync]] the CA Installation.
   1 Install and provide the CA Certificates in a [[ReleaseDocumentation/CaCertificatesInstall#Custom_Installation][shared location]] on another host _and_ proceed to instructions describing how to [[ReleaseDocumentation/CaCertificatesInstall#Reuse_an_existing_CA_Installation][reuse]] an existing CA Installation.

%STARTSECTION{"UseAnExistingCAInstallation"}%
---++%SHIFT% Use an existing CA Installation

It is often practical to reuse an existing %LINK_GLOSSARY_CA% Installation instead of creating a new installation. It is preferably be used when another VDT installation is managing the CA Installation. This installation can be on the same host or a different host who is providing the certificates on a shared file system.

See [[ReleaseDocumentation/CaCertificatesInstall#CA_Certificates_Installation_Pro][these instructions]] to install the CA Certificates in a shared location before you proceed.

<pre class="screen">
%UCL_PROMPT% vdt-ca-manage setupca --location /mnt/nfs/certificates %RED%--no-update%ENDCOLOR%
Setting CA Certificates for VDT installation at '%UCL_CWD%'

Setup completed successfully.
</pre>

%ICON{hand}% The command line option =--location= points to the existing installation. The command creates a softlink from =%UCL_CWD%/globus/TRUSTED_CA= to the existing installation =/mnt/nfs/certificates=.
%ENDSECTION{"UseAnExistingCAInstallation"}%

%STARTSECTION{"UseAWebProxy"}%
---++%SHIFT% Use a Web Proxy

An existing web proxy can be used to cache the requests from the individual nodes by creating the file =/etc/sysconfig/fetch-crl= with following content.

<pre class="file">
export http_proxy=your.existing.proxy:3128
</pre>

If you are not using the default port =3128= of the Squid Web Proxy, adjust the port as well.
%ENDSECTION{"UseAWebProxy"}%


---++%SHIFT% Sync the local CA Installation

First install the Certificate Authority Package in a =local= or =custom= directory and disable automatic updates:

<pre class="screen">
%UCL_PROMPT% vdt-ca-manage setupca --location local %RED%--no-update%ENDCOLOR%
Setting CA Certificates for VDT installation at '%UCL_CWD%'

Setup completed successfully.
</pre>

Next download and untar the =csync= utility provided externally by the %LINK_VDT%:

<pre class="screen">
%UCL_PROMPT% wget -q http://fermigrid.fnal.gov/files/csync/csync-0.9.0.tgz
%UCL_PROMPT% tar -zxf csync-0.9.0.tgz
</pre>

Then follow the instructions on how to set up the rsync server and clients to get your CA certificates and the CRL in the local directory =%UCL_CWD%/globus/share/certificates=. 

%ENDSECTION{"CACertificatesOnNodes"}%

%TWISTY{%TWISTY_OPTS_REVIEW%}%
   * Where are the instructions for that?
   * The csync tools is from 2007 and hasn't made it into the VDT I assume?
   * Is that procedure still useful and being used?
%ENDTWISTY%

%STOPINCLUDE%

---+ Troubleshooting

#DefsTroubleshooting

---++!!Debugging Procedure

If a certificate/CRL download is failing, check if you can connect to the server.

%TWISTY{%TWISTY_OPTS_REVIEW%}%
   * What is that server?
   * How do I test the connection?
%ENDTWISTY%

---++!!Caveats/Known Issues

If a certificate has been downloaded partially you have to remove it. The utilities will not overwrite it.

%TWISTY{%TWISTY_OPTS_REVIEW%}%
   * How do I even notice that a certificate has had a download failure?
%ENDTWISTY%

---++!! References

   * VDT documentation of [[http://vdt.cs.wisc.edu/releases/2.0.0/certificate_authorities.html][vdt-ca-manage]]


---+ Comments

%COMMENT{type="tableappend"}%

<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = MarcoMambelli

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = General

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = Installation
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %YES%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %YES%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = RobertEngel
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %IN_PROGRESS%


 DEAR DOCUMENT TESTER
 ====================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = IwonaSakrejda
 Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %IN_PROGRESS%
############################################################################################################
-->
-- Main.JamesWeichel - 03 Feb 2010
