%META:TOPICINFO{author="DerekWeitzel" date="1317854085" format="1.1" reprev="1.1" version="1.1"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! Installing OSG Usage Monitor

%TOC%

---++ Installing Pre-Requisites
The OSG Usage Monitor is distributed in a RPM.  We distribute the RPM with the official OSG Release.

The RPM requires the Condor to be installed as an RPM (From OSG or any other RPM source).  Otherwise, it will install Condor along with the probe.

---+++ Installing the OSG Repos
%INCLUDE{"Documentation.InstallVDTRepo" headingoffset="1"}%

---++ Configuring Condor
Add to the condor configuration (any condor configuration file).
<pre class="file">
JOBGLIDEIN_ResourceName="$$([IfThenElse(IsUndefined(TARGET.GLIDEIN_ResourceName), IfThenElse(IsUndefined(TARGET.GLIDEIN_Site), FileSystemDomain, TARGET.GLIDEIN_Site), TARGET.GLIDEIN_ResourceName)])"
SUBMIT_EXPRS = $(SUBMIT_EXPRS) JOBGLIDEIN_ResourceName   
</pre>

---++ Installing the Usage Monitor
To install the monitor, issue the command:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% yum --enablerepo=osg-testing install gratia-probe-condor </pre>

---+++ Configuration of the Usage Monitor
Condor is configured (by the gratia-probe-condor rpm) to write a job history file into a special directory.  The usage probe wakes up every few minutes, checks the special history directory, and sends usage up to a database at Fermilab.  

A small amount of configuration is needed for the usage probe.

In the gratia-condor configuration file, =/etc/gratia/condor/ProbeConfig=, check the line:
<pre class="file">
ProbeName="condor:%RED%&lt;hostname>%ENDCOLOR%"
SiteName="%RED%Generic Site%ENDCOLOR%"
</pre>

The value should include your hostname in the format =condor:&lt;hostname>=.  If the hostname is inaccurate, or you would like to change it to something more descriptive, please do.  This is an arbitrary name that will be stored in the database, and be associated with your recorded usage.  The site name should be a short title of the site this probe belongs to.  There can be multiple probes in a site.

The only other line that you should edit is the =EnableProbe= line.  Set it to "1".

---+++ Optional Configuration Options
---++++ Users without x509 certificates
Users without x509 certificates will not be correctly accounted for by the probe.  But, the probe has an option to use the user's group name as their usage identifier.  Add to the probe config (=/etc/gratia/condor/ProbeConfig=):
<pre class="file">
...
MapUnknownToGroup="1"
...
/>
</pre>

---++ Usage Graphs
Usage graphs can be found under the heading Glidein Bar Graphs at 
http://gratiaweb.grid.iu.edu/gratia/xml

Specifically, [[http://gratiaweb.grid.iu.edu/gratia/xml/glidein_hours_bar_smry][this page]] may be useful.  Replace the variable =probe= with the name of your probe that you configured above.

*NOTE:* Usage could be delayed up to a few hours after the job has completed.
