%META:TOPICINFO{author="DerekWeitzel" date="1288724251" format="1.1" reprev="1.2" version="1.2"}%
%META:TOPICPARENT{name="CampusGridTechnology"}%
---+ Offline !ClassAd Matching 

---++ About this page
This page describes the offline classad matching that the factory can use.

---++ About Offline Ads
Offline ads are designed to be used for power management.  When a node hasn't been matched for a configurable amount of time, the machine can be turned off to save power.  When the machine is preparing to turn off, it sends an offline ad to the collector that describes the machine.  When the offline ad describing the machine is matched to a job, a second process, the Condor Rooster, wakes the powered off node to run the job.

The collector maintains the offline ads for a configurable amount of time using the configuration variable [[http://www.cs.wisc.edu/condor/manual/v7.4/3_3Configuration.html#param:OfflineExpireAdsAfter][OFFLINE_EXPIRE_ADS_AFTER]].  During this time, the condor negotiator will treat the offline ad just as it would a real ad and match it to idle jobs.  Since the Negotiator sees no difference between running and offline ads, the offline ads will be matched even when flocking from another condor pool.

When an offline ad is matched to an idle job, the negotiator updates the MachineLastMatchTime of the matched classad to the current time.  Another process can look at this attribute and take action.

---++ How the Campus Factory handles Offline !ClassAds

---+++ Creating !ClassAds
The factory detects classads of running glideins, copies the classads, and re-advertises them as offline ads.  Since the offline ad is an exact copy of a running glidein, it is reasonably expected that you can get a similar glidein when you submit to the local scheduler.

To change a glidein into a offline ad, the following attributes must be changed
   * Offline = true
   * Name - to a unique name
   * !MyCurrentTime = !LastHeardFrom - Time now
   * !ClassAdLifetime - To address a bug in the handling of offline ads.  This is how many seconds the collector will keep this ad
   * State = Unclaimed - Make sure it will match with idle jobs.
   * Activity = Idle - Again, for matching

Convenience attributes:
   * !PreviousName - Value of 'Name' attribute of the original ad.  Useful for debugging.


---+++ Managing !ClassAds
By default, the factory will attempt to maintain a specific number of idle


-- Main.DerekWeitzel - 02 Nov 2010
