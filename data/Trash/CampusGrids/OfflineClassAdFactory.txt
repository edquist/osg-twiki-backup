%META:TOPICINFO{author="DerekWeitzel" date="1289537180" format="1.1" version="1.5"}%
%META:TOPICPARENT{name="CampusGridTechnology"}%
---+ Offline !ClassAd Matching 

---++ About Offline Ads
Offline ads are designed to be used for power management.  When a node hasn't been matched for a configurable amount of time, the machine can be turned off to save power.  When the machine is preparing to turn off, it sends an offline ad to the collector that describes the machine.  When the offline ad describing the machine is matched to a job, a second process, the Condor Rooster, wakes the powered off node to run the job.

The collector maintains the offline ads for a configurable amount of time using the configuration variable [[http://www.cs.wisc.edu/condor/manual/v7.4/3_3Configuration.html#param:OfflineExpireAdsAfter][OFFLINE_EXPIRE_ADS_AFTER]].  During this time, the condor negotiator will treat the offline ad just as it would a real ad and match it to idle jobs.  Since the Negotiator sees no difference between running and offline ads, the offline ads will be matched even when flocking from another condor pool.

When an offline ad is matched to an idle job, the negotiator updates the !MachineLastMatchTime of the matched classad to the current time.  Another process can look at this attribute and take action.

---++ How the Campus Factory handles Offline !ClassAds

---+++ Creating !ClassAds
The factory detects classads of running glideins, copies the classads, and re-advertises them as offline ads.  Since the offline ad is an exact copy of a running glidein, it is reasonably expected that you can get a similar glidein when you submit to the local scheduler.

To change a glidein into a offline ad, the following attributes must be changed
   * Offline = true
   * Name - to a unique name
   * !MyCurrentTime = !LastHeardFrom - Time now
   * !ClassAdLifetime - To address a bug in the handling of offline ads.  This is how many seconds the collector will keep this ad
   * State = Unclaimed - Make sure it will match with idle jobs.
   * Activity = Idle - Again, for matching

Convenience attributes:
   * !PreviousName - Value of 'Name' attribute of the original ad.  Useful for debugging.


---+++ Managing !ClassAds
By default, the factory will attempt to maintain a specific number of offline ads.  This can be done in a number of ways, such as always maintaining the newest 10 ads.  Or you can sort by different 'types' of machines (big memory, big disk), and keep an assortment of unique ads.  Currently, the factory only keeps the latest 10 ads.

To maintain the classads, the factory queries the collector for offline ads.  If it detects more than 10, it will only keep the newest 10.  If less then ten, the offline ad manager will list the site as Delinquent, and will recommend submitting more glideins.

---++ Influence offline ads have on the Factory
The !OfflineAds do not completely replace all logic relating to the factory.  The site must still meet the idle glideins/idle slots requirements that were originally used to throttle new glideins.  The !OfflineAds do replace the need for the factory to query remote schedd's to for idle jobs.  The negotiator and collector take care of all job matching with semi-accurate glidein classads.

The logic of the factory follows:
   1. Are there idle startd's?
   1. Are there idle glideins in queue?
   1. Have any of the idle offline ads matched in the last x seconds?
   1. If we get this far, submit some glideins.



-- Main.DerekWeitzel - 02 Nov 2010