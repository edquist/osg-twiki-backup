%META:TOPICINFO{author="AnwarMamat" date="1278002052" format="1.1" reprev="1.8" version="1.8"}%
-- Main.AnwarMamat - 16 Jun 2010
---+ Linux Condor Pool on Windows Lab Machines
---++Project Description
In this project, we build a Linux Condor Pool out of Windows lab machines. The system structure is shown in the figure. When the Windows host  is idle, the Condor (Condor 1
 in the Figure) on the Windows hosts starts the Virtual Machine and the guest OS on the Virtual machine. Then the Condor (Condor 2 in the figure) on the Guest OS reports itself to the head node condor pool. If user activity is detected on the Windows host, the virtual machine is terminated. 

---++structure: <br />
     <img src="%ATTACHURLPATH%/Condor_head.png" alt="Condor_head.png" width='797' height='529' />    
---++ Software Configuration
   * Linux Head node: CentOS5.5
   * Condor: Condor 7.4
   * Linux Head Node Hostname: condor.unl.edu
   * Windows Host OS: Windows 7 Enterprise
   * Virtual Machine: VMware Workstation 7.1
   * Guest OS: CentOS 5.5
---++ Installing the Head Node

For the Head node, we install Condor 7.4 on the CentOS 5.5. In this tutorial, we only introduce the necessary steps. For the details, please read the “Installation” section in Condor Manual.

Change/Add the Head Node hostname  into  “/etc/sysconfig/network”:
<pre class="screen">
HOSTNAME=condor.unl.edu
</pre>
Also, set the correct hostname:
<pre class="screen">
hostname condor.unl.edu
</pre>

Check the Condor yum repository at http://cs.wisc.edu/condor/yum for supported platforms. If your platform (here it is RHEL5), follow the yum install instructions:

Get latest Condor's release 
<pre class="screen">
cd /etc/yum.repos.d
wget http://www.cs.wisc.edu/condor/yum/repo.d/condor-stable-rhel5.repo
</pre>
Install Condor as root:
<pre class="screen">
su -
</pre>
The Condor package will automatically add a 'condor' user/group if it does not exist already. Sites with a specific security policy should add the 'condor' user/group manually before performing the installation. 

Add condor user. 
<pre class="screen">
adduser condor
</pre>


Install Condor RPM 
<pre class="screen">
yum install condor
</pre>
Condor will be install in:

The following table shows path layout compare to original Condor's binary package. 


|Orignal Location|Current Location|
|bin|/usr/bin|
|etc|/etc/condor/|
|etc/examples|/usr/share/doc/condor-{version}/etc/examples|
|examples|/usr/share/doc/condor-{version}/examples|
|include|/usr/include/condor|
|lib|/usr/lib/condor   /usr/lib64/condor|
|libexec|/usr/libexec/condor|
|local/condor_config.local|/etc/condor/|
|local/execute|/var/lib/condor/execute|
|local/spool|/var/lib/condor/spool|
|man|/usr/share/man|
|sbin|/usr/sbin|
|sql|/usr/share/condor/sql|
|src|/usr/src|
|INIT|/etc/init.d/condor|
|PID|/var/run/condor|
|LOGS|/var/log/condor|
|LOCK|/var/lock/condor|




After Condor is installed, check the environment variables:
<pre class="screen">
condor_config_val FULL_HOSTNAME
</pre>
	condor.unl.edu
<pre class="screen">
condor_config_val CONDOR_HOST
</pre>
	condor.unl.edu
</pre>

Next step, edit Condor's configuration file locates at /etc/condor/condor_config.local
<pre class="screen">
CONDOR_HOST = $(FULL_HOSTNAME)
DAEMON_LIST = COLLECTOR, MASTER, NEGOTIATOR, SCHEDD, STARTD
</pre>
If the head node does not execute jobs, then “STARTD” can be removed from the daemon list.

Edit Condor's configuration file which locates at /etc/condor/condor_config
<pre class="screen">
ALLOW_WRITE=*
</pre>
Now, condor head node is ready to use and should be able to submit and execute jobs.
Start Condor (as root):
<pre class="screen">
service condor start
</pre>
Check if condor is running:
<pre class="screen">
ps -ef |grep condor
</pre>
You see the condor daemons:
<pre class="screen">
condor_master
condor_collector
condor_sched
condor_startd
condor_procd
</pre>
To stop condor:
<pre class="screen">
service condor stop
</pre>


---++ Installing the worker Node

Worker nodes are Windows 7 lab machines. Worker node installation needs these steps.
   * Condor on the Host Machine
   * Virtual Machine Software (VMware Workstation or Vmware Player)
   * Guest OS
   * Condor on the Guest OS
---++++ Condor on the Host Machine
Download Condor for Windows  from 
<pre class="screen">
http://www.cs.wisc.edu/condor/downloads-v2/download.pl
</pre>
For Condor 7.4, download the file 
<pre class="screen">
condor-7.4.2-winnt50-x86.msi
</pre>

Run condor-7.4.2-winnt50-x86.msi as Administrator, then follow the steps:
   * Condor Host: <br />
     <img src="%ATTACHURLPATH%/1.png" alt="1.png" width='501' height='389' />    

   * Condor Behavior: <br />
     <img src="%ATTACHURLPATH%/2.png" alt="2.png" width='500' height='392' />    

   * Accounting Domain: <br />
     <img src="%ATTACHURLPATH%/3.png" alt="3.png" width='499' height='385' />    

   * Email Settings: <br />
     <img src="%ATTACHURLPATH%/4.png" alt="4.png" width='500' height='386' />    

   * Java Settings: <br />
     <img src="%ATTACHURLPATH%/5.png" alt="5.png" width='497' height='387' />    

   * Host Permission Settings: <br />
     <img src="%ATTACHURLPATH%/6.png" alt="6.png" width='498' height='388' />    

   * VM Universe Settings: <br />
     <img src="%ATTACHURLPATH%/7.png" alt="7.png" width='500' height='391' />    

   * HDFS Settings: <br />
     <img src="%ATTACHURLPATH%/8.png" alt="8.png" width='500' height='386' />    

   * Install Condor: <br />
     <img src="%ATTACHURLPATH%/9.png" alt="9.png" width='498' height='391' />    


Add following items into condor configuration file condor_config.local at C:\condor
<pre class="screen">
DAEMON_LIST = MASTER  STARTD KBDD 
use_visible_desktop=true
NUM_CPUS = 1
CCB_ADDRESS=$(CONDOR_HOST)
</pre>

Let's explain above items:
   * DAEMON_LIST = MASTER  STARTD KBDD: The Condor on Windows Host works as a Watchdog, which starts the Virtual machine when the Windows host is idle and kill the virtual machine when user activity is detected. Therefore, only the Condor Master and Condor STARTD are running. 
   * use_visible_desktop=true: This is for debug purposes. The jobs that submitted from head node to the Windows Host run in background, as condor-reuse-slotXXX user. With 'use_visible_desktop=true', we can bring the background condor job to the desktop to see what is happening in background. This is very useful when you need to press the "OK" button to confirm the EULA etc.
   * NUM_CPUS = 1: As we said, condor on the Windows Host only executes the jobs that START/STOP the virtual machine. For a DUO/QUAD core machines, actually we only need one slot to execute START/STOP jobs.
   * CCB_ADDRESS=$(CONDOR_HOST): If the Windows Host is behind NAT, we need to configure Condor Connection Broker.
 


---++++ Create the Virtual Machine and Install the Guest OS

 We install VMware WorkStation into C:\VMware. If it is installed in different directory, the "virtual machine start script" must be correspondingly modified. 
As we have tested, the free version of VMware Player 3.0 also worked. Because department has the license, here we used VMware Workstation.

Next step, we create the Virtual machine and install Guest OS CentOS 5.5. Start VMware Workstation, in "File"->"New"->"Virtual Machine", choose "Typical"

   * VM_typical: <br />
     <img src="%ATTACHURLPATH%/VM_typical.png" alt="VM_typical.png" width='946' height='724' />    
Choose "I will install OS later". If you choose "Installer Disc from DVD", easy install will skip the installer options. Here we recommend minimum text linux installation. The "Install OS later" will give you the "install mode" options. For CentOS, you have to type "linux text" to install text based linux installation.

   * InstallLater: <br />
     <img src="%ATTACHURLPATH%/InstallLater.png" alt="InstallLater.png" width='940' height='718' />    

   * NewVirtualMachine.png: <br />
     <img src="%ATTACHURLPATH%/NewVirtualMachine.png" alt="NewVirtualMachine.png" width='938' height='594' />    

   * VirtualMachinePath.png: <br />
     <img src="%ATTACHURLPATH%/VirtualMachinePath.png" alt="VirtualMachinePath.png" width='946' height='596' />    


   * CentOS: <br />
     <img src="%ATTACHURLPATH%/CentOS.png" alt="CentOS.png" width='943' height='591' />    

  The minimal installation is about 1.2 GB. The disk space must be enough to install Condor, libraries, tools and user data. Our Virtual Disk size is 50GB.
   * DiskSIze: <br />
     <img src="%ATTACHURLPATH%/VirtualMachineDiskSize.png" alt="VirtualMachineDiskSize.png" width='940' height='597' />    

   * PowerOn: <br />
     <img src="%ATTACHURLPATH%/VirtualMachinePowerOn.png" alt="VirtualMachinePowerOn.png" width='944' height='601' />    


"Finish" and insert the "CentOS Installation DVD" into the DVD drive. It will bring you to the Guest OS installation. Please refer specific Guest OS installation guide.

---++++ Install Condor on the Guest OS
Now, we install the Condor on the guest OS.

Set the worker node host name in /etc/sysconfig/network
<pre class="screen">
HOSTNAME=v-node
</pre>

Install Condor as root:
<pre class="screen">
su -
</pre>
Add condor user. 
<pre class="screen">
adduser condor
</pre>
Change the password of user condor
<pre class="screen">
passwd condor xxxxx
</pre>


Obtain the Condor RPM
<pre class="screen">
cd /etc/yum.repos.d
wget http://www.cs.wisc.edu/condor/yum/repo.d/condor-stable-rhel5.repo
</pre>
The Condor package will automatically add a 'condor' user/group if it does not exist already. Sites with a specific security policy should add the 'condor' user/group manually before performing the installation. 

Install Condor RPM 
<pre class="screen">
yum install condor
</pre>

Edit/Add the condor configuration file at /etc/condor/condor_config.local
<pre class="screen">
CONDOR_HOST= condor.unl.edu
DAEMONLIST=MASTER,STARTD
ALLOW_WRITE=$(CONDOR_HOST)
ALLOW_NEGOTIATPOR=$(CONDOR_HOST)
COLLECTOR_HOST=$(CONDOR_HOST)
</pre>
Since the worker nodes are behind tha NAT, head node can not directly communicate with the worker nodes. Here, we need to configure the Condor Communication Broker (CCB).

Add the condor configuration file at /etc/condor/condor_config.local
<pre class="screen">
CCB_ADDRESS=$(CONDOR_HOST)
</pre>
Restart Condor
<pre class="screen">
condor_reconfig
</pre>
After Condor is installed, check the environment variables:

<pre class="screen">
condor_config_val FULL_HOSTNAME
	v-node
</pre>
<pre class="screen">
condor_config_val CONDOR_HOST
	condor.unl.edu
</pre>

    
Now, restart your Windows Host, start VMware Workstation, power on the virtual machine. After few minutes, you should be able to see the worker node slots in your head node condor pool. For example: If you execute:
<pre class="screen">
condor_status
</pre>
You should be able to see:
<pre class="screen">
Name               OpSys      Arch   State     Activity LoadAv Mem   ActvtyTime

slot1@PC2 LINUX      X86_64 Unclaimed Idle     0.000   501  0+01:17:25
slot2@PC2 LINUX      X86_64 Unclaimed Idle     0.000   501  0+01:17:26
slot1@PC1 LINUX      X86_64 Unclaimed Idle     0.000   250  0+01:17:21
slot2@PC1 LINUX      X86_64 Unclaimed Idle     0.000   250  0+01:17:21
slot3@PC1 LINUX      X86_64 Unclaimed Idle     0.000   250  0+01:17:22
slot4@PC1 LINUX      X86_64 Unclaimed Idle     0.000   250  0+01:17:24
PC2    	  WINNT61    INTEL  Claimed   Busy     0.000  2043  0+18:31:59
PC1	  WINNT61    INTEL  Claimed   Busy     0.080  4094  0+18:35:57
                     Total Owner Claimed Unclaimed Matched Preempting Backfill

       INTEL/WINNT61     2     0       2         0       0          0        0
        X86_64/LINUX     6     0       0         6       0          0        0

               Total     8     0       2         6       0          0        0

</pre>

If you do not see the correct machines list, please check the "Collerctor.log" on the head node and the "StartLog" and "StarterLog" on the worker nodes. 

So far, we have installed and configured the head node and worker nodes. In next step, we discuss how we START/STOP worker node virtual machine from head node.

---++++ Job Submission Examples

1. Submit a job to Windows Host
<pre class="screen">
Universe=vanilla
executable=dir.bat
requirements=(Arch == "INTEL" && OpSYS == "WINNT61" && name == "PC1")
should_transfer_files = YES
when_to_transfer_output = ON_EXIT
output=results.output.$(Cluster)
error=results.error.$(Cluster)
log=results.log.$(Cluster)
notification=never
queue
</pre>
The execution file dir.bat is:
<pre class="screen">
dir C:\condor
</pre>
This will return the list of files in the "C:\condor" folder on the Windows Host. If the Windows Host shows up in your pool, but never executes the job, check the Condor Connection Broker configuration. 

2. Submit a job to the Linux Guest
<pre class="screen">
executable=m.sh
arguments=TestJob 15
output=results.output.$(Cluster)
error=results.error.$(Cluster)
log=results.log.$(Cluster)
notification=never
universe=vanilla
when_to_transfer_output = ON_EXIT
queue 100
</pre>

The execution file m.sh:

<pre class="screen">
#! /bin/sh
echo "I'm process id $$ on" `hostname`
echo "This is sent to standard error" 1>&2
date
echo "Running as binary $0" "$@"
echo "My name (argument 1) is $1"
echo "My sleep duration (argument 2) is $2"
sleep $2
echo "Sleep of $2 seconds finished.  Exiting"
echo "RESULT: 0 SUCCESS"
</pre>
If the jobs completes, the result.out.XXX is:
<pre class="screen">
I'm process id 9901 on PC1
Thu Jul  1 08:46:31 CDT 2010
Running as binary /var/lib/condor/execute/dir_9889/condor_exec.exe TestJob 15
My name (argument 1) is TestJob
My sleep duration (argument 2) is 15
Sleep of 15 seconds finished.  Exiting
RESULT: 0 SUCCESS
</pre>
---++ Start the Virtual machine

We submit this script to START the virtual machine on Windows Host PC1.
<pre class="screen">
Universe=vanilla
executable=VMPlay_AutoRun.bat
requirements=(Arch == "INTEL" && OpSYS == "WINNT61" && name == "PC1")
should_transfer_files = YES
when_to_transfer_output = ON_EXIT
output=results.output.$(Cluster)
error=results.error.$(Cluster)
log=results.log.$(Cluster)
notification=never
transfer_input_files = set_vm_preferences.pl
queue
</pre>

The execution file VMPlay_AutoRun.bat is:
<pre class="screen">
set_vm_preferences.pl
C:\VMware\vmware -x C:\VirtualMachines\v-node\v-node.vmx
</pre>

This file set_vm_preferences.pl is:
<pre class="screen">
use Win32;

my $name;
$name=Win32::LoginName();
print "Process launched by user : $name\n";

use File::Path;
use File::Copy;

my $target_path = "C:/Users/$name/AppData/Roaming/VMware";
$file = "preferences.ini";
my $source_path = "C:/VirtualMachines/v-node/$file";

if (! -d $target_path)
{
  mkpath($target_path) or die "Failed to create $path: $!\n";
}
copy($source_path,$target_path) or die "Failed to copy $file: $!\n";
#$cmd = "copy $file c:/Users/$name/$file";
#print "$cmd\n";
#system($cmd);
</pre>

When a new user starts VMware Workstation, it asks for the End User License Agreement. The condor job running in background has to respond to the EULA too. To overpass this, wen can copy the  "preferences.ini" file of an old user to the new user. If you start the VMware workstation as the user "XXX", then you can find the "preferences.ini"  at "C:/Users/XXX/AppData/Roaming/VMware. Copy the file into the folder "C:\virtualMachines\v-node". When condor job starts the virtual machine, it first copies the "preferences.ini" to the condor submit user's folder. Doing so, we can overpass the background message asking you to answer the EULA.


After few minutes, you can see the process "vmware.exe" or "vmware-vmx.exe" on the Windows Host Processes list. 

---++ Stop the Virtual machine
To Stop the virtual machine, you can simply kill the running job "VMPlay_AutoRun.bat"

%META:FILEATTACHMENT{name="Condor_head.png" attachment="Condor_head.png" attr="" comment="structure" date="1277309936" path="Condor_head.png" size="31191" stream="Condor_head.png" tmpFilename="/usr/tmp/CGItemp24606" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="VM_typical.png" attachment="VM_typical.png" attr="" comment="VM_typical" date="1277750815" path="VM_typical.png" size="145205" stream="VM_typical.png" tmpFilename="/usr/tmp/CGItemp56080" user="AnwarMamat" version="2"}%
%META:FILEATTACHMENT{name="CentOS.png" attachment="CentOS.png" attr="" comment="CentOS" date="1277750675" path="CentOS.png" size="111916" stream="CentOS.png" tmpFilename="/usr/tmp/CGItemp56103" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="InstallLater.png" attachment="InstallLater.png" attr="" comment="InstallLater" date="1277750702" path="InstallLater.png" size="109439" stream="InstallLater.png" tmpFilename="/usr/tmp/CGItemp56053" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="NewVirtualMachine.png" attachment="NewVirtualMachine.png" attr="" comment="" date="1277999525" path="NewVirtualMachine.png" size="114577" stream="NewVirtualMachine.png" tmpFilename="/usr/tmp/CGItemp55705" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="VirtualMachineDiskSize.png" attachment="VirtualMachineDiskSize.png" attr="" comment="DiskSIze" date="1277750746" path="VirtualMachineDiskSize.png" size="127124" stream="VirtualMachineDiskSize.png" tmpFilename="/usr/tmp/CGItemp56038" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="VirtualMachinePath.png" attachment="VirtualMachinePath.png" attr="" comment="" date="1277999538" path="VirtualMachinePath.png" size="119996" stream="VirtualMachinePath.png" tmpFilename="/usr/tmp/CGItemp55712" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="VirtualMachinePowerOn.png" attachment="VirtualMachinePowerOn.png" attr="" comment="PowerOn" date="1277750789" path="VirtualMachinePowerOn.png" size="133244" stream="VirtualMachinePowerOn.png" tmpFilename="/usr/tmp/CGItemp56099" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="1.png" attachment="1.png" attr="" comment="Condor Host" date="1277759188" path="1.png" size="22795" stream="1.png" tmpFilename="/usr/tmp/CGItemp23339" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="2.png" attachment="2.png" attr="" comment="Condor Behavior" date="1277759229" path="2.png" size="31374" stream="2.png" tmpFilename="/usr/tmp/CGItemp23498" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="3.png" attachment="3.png" attr="" comment="Accounting Domain" date="1277759253" path="3.png" size="21865" stream="3.png" tmpFilename="/usr/tmp/CGItemp23552" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="4.png" attachment="4.png" attr="" comment="Email Settings" date="1277759278" path="4.png" size="21089" stream="4.png" tmpFilename="/usr/tmp/CGItemp23501" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="5.png" attachment="5.png" attr="" comment="Java Settings" date="1277759299" path="5.png" size="19640" stream="5.png" tmpFilename="/usr/tmp/CGItemp23497" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="6.png" attachment="6.png" attr="" comment="Host Permission Settings" date="1277759329" path="6.png" size="23728" stream="6.png" tmpFilename="/usr/tmp/CGItemp28253" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="7.png" attachment="7.png" attr="" comment="VM Universe Settings" date="1277759357" path="7.png" size="30477" stream="7.png" tmpFilename="/usr/tmp/CGItemp28308" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="8.png" attachment="8.png" attr="" comment="HDFS Settings" date="1277759380" path="8.png" size="27443" stream="8.png" tmpFilename="/usr/tmp/CGItemp28235" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="9.png" attachment="9.png" attr="" comment="Install Condor" date="1277759403" path="9.png" size="27363" stream="9.png" tmpFilename="/usr/tmp/CGItemp28272" user="AnwarMamat" version="1"}%
