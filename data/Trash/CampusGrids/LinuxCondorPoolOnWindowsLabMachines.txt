%META:TOPICINFO{author="AnwarMamat" date="1277752329" format="1.1" reprev="1.5" version="1.5"}%
-- Main.AnwarMamat - 16 Jun 2010
---+ Linux Condor Pool on Windows Lab Machines
---++Project Description
In this project, we build a Linux Condor Pool out of Windows lab machines. The system structure is shown in the figure. When the Windows host  is idle, the Condor (Condor 1
 in the Figure) on the Windows hosts starts the Virtual Machine and the guest OS on the Virtual machine. Then the Condor (Condor 2 in the figure) on the Guest OS reports itself to the head node condor pool. If user activity is detected on the Windows host, the virtual machine is terminated. 

---++structure: <br />
     <img src="%ATTACHURLPATH%/Condor_head.png" alt="Condor_head.png" width='797' height='529' />    
---++ Software Configuration
   * Linux Head node: CentOS5.5
   * Condor: Condor 7.4
   * Linux Head Node Hostname: condor.unl.edu
   * Windows Host OS: Windows 7 Enterprise
   * Virtual Machine: VMware Workstation 7.1
   * Guest OS: CentOS 5.5
---++ Installing the Head Node

In this tutorial, we only introduce the necessary steps. For the details, please read the “Installation” section in Condor Manual.

Change/Add the Head Node hostname  into  “/etc/sysconfig/network”:
<pre class="screen">
HOSTNAME=condor.unl.edu
</pre>
Also, set the correct hostname:
<pre class="screen">
hostname condor.unl.edu
</pre>

Check the Condor yum repository at http://cs.wisc.edu/condor/yum for supported platforms. If your platform (here it is RHEL5), follow the yum install instructions:

Get latest Condor's release 
<pre class="screen">
cd /etc/yum.repos.d
wget http://www.cs.wisc.edu/condor/yum/repo.d/condor-stable-rhel5.repo
</pre>
Install Condor as root:
<pre class="screen">
su -
</pre>
The Condor package will automatically add a 'condor' user/group if it does not exist already. Sites with a specific security policy should add the 'condor' user/group manually before performing the installation. 

Add condor user. 
<pre class="screen">
adduser condor
</pre>


Install Condor RPM 
<pre class="screen">
yum install condor
</pre>
Condor will be install in:

The following table shows path layout compare to original Condor's binary package. 


|Orignal Location|Current Location|
|bin|/usr/bin|
|etc|/etc/condor/|
|etc/examples|/usr/share/doc/condor-{version}/etc/examples|
|examples|/usr/share/doc/condor-{version}/examples|
|include|/usr/include/condor|
|lib|/usr/lib/condor   /usr/lib64/condor|
|libexec|/usr/libexec/condor|
|local/condor_config.local|/etc/condor/|
|local/execute|/var/lib/condor/execute|
|local/spool|/var/lib/condor/spool|
|man|/usr/share/man|
|sbin|/usr/sbin|
|sql|/usr/share/condor/sql|
|src|/usr/src|
|INIT|/etc/init.d/condor|
|PID|/var/run/condor|
|LOGS|/var/log/condor|
|LOCK|/var/lock/condor|




After Condor is installed, check the environment variables:
<pre class="screen">
condor_config_val FULL_HOSTNAME
</pre>
	condor.unl.edu
<pre class="screen">
condor_config_val CONDOR_HOST
</pre>
	condor.unl.edu
</pre>

Next step, edit Condor's configuration file locates at /etc/condor/condor_config.local
<pre class="screen">
CONDOR_HOST = $(FULL_HOSTNAME)
DAEMON_LIST = COLLECTOR, MASTER, NEGOTIATOR, SCHEDD, STARTD
</pre>
If the head node does not execute jobs, then “STARTD” can be removed from the daemon list.

Edit Condor's configuration file which locates at /etc/condor/condor_config
<pre class="screen">
ALLOW_WRITE=*
</pre>
Now, condor head node is ready to use and should be able to submit and execute jobs.
Start Condor (as root):
<pre class="screen">
service condor start
</pre>
Check if condor is running:
<pre class="screen">
ps -ef |grep condor
</pre>
You see the condor daemons:
<pre class="screen">
condor_master
condor_collector
condor_sched
condor_startd
condor_procd
</pre>
To stop condor:
<pre class="screen">
service condor stop
</pre>


---++ Installing the worker Node

Worker nodes are Windows 7 lab machines. Worker node installation needs these steps.
   * Condor on the Host Machine
   * Virtual Machine Software (VMware Workstation or Vmware Player)
   * Guest OS
   * Condor on the Guest OS


 We install VMware WorkStation into C:\VMware. If it is installed in different directory, the "virtual machine start script" must be correspondingly modified. 
As we have tested, the free version of VMware Player 3.0 also worked. Because department has the license, here we used VMware Workstation.

Next step, we create the Virtual machine and install Guest OS CentOS 5.5. Start VMware Workstation, in "File"->"New"->"Virtual Machine", choose "Typical"

   * VM_typical: <br />
     <img src="%ATTACHURLPATH%/VM_typical.png" alt="VM_typical.png" width='946' height='724' />    
Choose "I will install OS later". If you choose "Installer Disc from DVD", easy install will skip the installer options. Here we recommend minimum text linux installation. The "Install OS later" will give you the "install mode" options. For CentOS, you have to type "linux text" to install text based linux installation.

   * InstallLater: <br />
     <img src="%ATTACHURLPATH%/InstallLater.png" alt="InstallLater.png" width='940' height='718' />    


   * CentOS: <br />
     <img src="%ATTACHURLPATH%/CentOS.png" alt="CentOS.png" width='943' height='591' />    

  The minimal installation is about 1.2 GB. The disk space must be enough to install Condor, libraries, tools and user data. Our Virtual Disk size is 50GB.
   * DiskSIze: <br />
     <img src="%ATTACHURLPATH%/VirtualMachineDiskSize.png" alt="VirtualMachineDiskSize.png" width='940' height='597' />    

   * PowerOn: <br />
     <img src="%ATTACHURLPATH%/VirtualMachinePowerOn.png" alt="VirtualMachinePowerOn.png" width='944' height='601' />    


"Finish" and insert the "CentOS Installation DVD" into the DVD drive. It will bring you to the Guest OS installation. Please refer specific Guest OS installation guide.

Now, we install the Condor on the guest OS.

Set the worker node host name in /etc/sysconfig/network
<pre class="screen">
HOSTNAME=v-node
</pre>

Install Condor as root:
<pre class="screen">
su -
</pre>
Add condor user. 
<pre class="screen">
adduser condor
</pre>
Change the password of user condor
<pre class="screen">
passwd condor xxxxx
</pre>


Obtain the Condor RPM
<pre class="screen">
cd /etc/yum.repos.d
wget http://www.cs.wisc.edu/condor/yum/repo.d/condor-stable-rhel5.repo
</pre>
The Condor package will automatically add a 'condor' user/group if it does not exist already. Sites with a specific security policy should add the 'condor' user/group manually before performing the installation. 

Install Condor RPM 
<pre class="screen">
yum install condor
</pre>

Edit/Add the condor configuration file at /etc/condor/condor_config.local
<pre class="screen">
CONDOR_HOST= condor.unl.edu
DAEMONLIST=MASTER,STARTD
ALLOW_WRITE=$(CONDOR_HOST)
ALLOW_NEGOTIATPOR=$(CONDOR_HOST)
COLLECTOR_HOST=$(CONDOR_HOST)
</pre>
Since the worker nodes are behind tha NAT, head node can not directly communicate with the worker nodes. Here, we need to configure the Condor Communication Broker (CCB).

Add the condor configuration file at /etc/condor/condor_config.local
<pre class="screen">
CCB_ADDRESS=$(CONDOR_HOST)
</pre>
Restart Condor
<pre class="screen">
condor_reconfig
</pre>
After Condor is installed, check the environment variables:

<pre class="screen">
condor_config_val FULL_HOSTNAME
	v-node
</pre>
<pre class="screen">
condor_config_val CONDOR_HOST
	condor.unl.edu
</pre>

    
Now, you should be able to see the worker node slots in your head node condor pool.

%META:FILEATTACHMENT{name="Condor_head.png" attachment="Condor_head.png" attr="" comment="structure" date="1277309936" path="Condor_head.png" size="31191" stream="Condor_head.png" tmpFilename="/usr/tmp/CGItemp24606" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="VM_typical.png" attachment="VM_typical.png" attr="" comment="VM_typical" date="1277750815" path="VM_typical.png" size="145205" stream="VM_typical.png" tmpFilename="/usr/tmp/CGItemp56080" user="AnwarMamat" version="2"}%
%META:FILEATTACHMENT{name="CentOS.png" attachment="CentOS.png" attr="" comment="CentOS" date="1277750675" path="CentOS.png" size="111916" stream="CentOS.png" tmpFilename="/usr/tmp/CGItemp56103" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="InstallLater.png" attachment="InstallLater.png" attr="" comment="InstallLater" date="1277750702" path="InstallLater.png" size="109439" stream="InstallLater.png" tmpFilename="/usr/tmp/CGItemp56053" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="NewVirtualMachine.png" attachment="NewVirtualMachine.png" attr="" comment="NewVM" date="1277750730" path="NewVirtualMachine.png" size="114577" stream="NewVirtualMachine.png" tmpFilename="/usr/tmp/CGItemp56002" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="VirtualMachineDiskSize.png" attachment="VirtualMachineDiskSize.png" attr="" comment="DiskSIze" date="1277750746" path="VirtualMachineDiskSize.png" size="127124" stream="VirtualMachineDiskSize.png" tmpFilename="/usr/tmp/CGItemp56038" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="VirtualMachinePath.png" attachment="VirtualMachinePath.png" attr="" comment="VM_Path" date="1277750766" path="VirtualMachinePath.png" size="119996" stream="VirtualMachinePath.png" tmpFilename="/usr/tmp/CGItemp56040" user="AnwarMamat" version="1"}%
%META:FILEATTACHMENT{name="VirtualMachinePowerOn.png" attachment="VirtualMachinePowerOn.png" attr="" comment="PowerOn" date="1277750789" path="VirtualMachinePowerOn.png" size="133244" stream="VirtualMachinePowerOn.png" tmpFilename="/usr/tmp/CGItemp56099" user="AnwarMamat" version="1"}%
