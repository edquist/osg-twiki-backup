%META:TOPICINFO{author="MichaelFenn" date="1272389051" format="1.1" reprev="1.2" version="1.2"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! %MAKETEXT{"Starting Virtual Machines with KVM" }%

This page seeks to be a short HOWTO on using the KVM Virtual Machine Monitor (VMM) deployed on virtualization-enabled clusters such as the Clemson University Palmetto Cluster.

%TOC%

---+ Getting Started
KVM uses the =/dev/kvm= device as an interface between the user-mode user interface code and the CPU's hardware virtualization extensions.  Thus, in order to use KVM, you must have appropriate permissions to this device.  Below is an example of how to check these permissions:
<pre class=screen>
[mfenn@node0256 ~]$ ls -l /dev/kvm 
crw-rw---- 1 root kvm 10, 232 Apr  5 11:37 /dev/kvm
[mfenn@node0256 ~]$ id mfenn
uid=86311(mfenn) gid=10000(cuuser) groups=10000(cuuser),73839(kvm)
</pre>
In the example above, the =/dev/kvm= device is readable and writable by the =kvm= group and the user =mfenn= is a member of that group.  Thus =mfenn= has enough permissions to use KVM.

---+ Creating a Disk Image
A virtual machine (VM) needs to have an file in which to store the contents of its hard disk.  This file is known as a _disk image_.  The =qemu-img= tool may be used to create a disk image. For example:
<pre class=screen>
[mfenn@node0256 ~]$ qemu-img create -f qcow2 newimage.qcow2 10G
Formatting 'newimage.qcow2', fmt=qcow2, size=10485760 kB
[mfenn@node0256 ~]$ ls -l newimage.qcow2 
-rw-r--r-- 1 mfenn cuuser 52K Apr 27 12:12 newimage.qcow2
</pre>
In the above example, the command =qemu-img create -f qcow2 newimage.qcow2 10G= creates a new image of the format =qcow2= (KVM's native image format) named =newimage.qcow2= with a maximum capacity of 10GB.  Note however that the actual file =newimage.qcow2= is only 52KB.  This is because QCOW2 is a copy-on-write file format whose size will increase as the amount of data stored in the image increases.

If the =qemu-img= tool is not available, =dd= can also be used to create disk images.  These images will be in the =raw= format and will not have the expanding-size property of that the QCOW2 images have.  A =raw= image is otherwise identical.  Below is an example of creating an image file with =dd=:
<pre class=screen>
[mfenn@node0256 ~]$ dd if=/dev/zero of=newimage.img bs=1M count=10K
10240+0 records in
10240+0 records out
10737418240 bytes (11 GB) copied, 661.776 seconds, 16.2 MB/s
[mfenn@node0256 ~]$ ls -lh newimage.img 
-rw-r--r-- 1 mfenn cuuser 10G Apr 27 12:31 newimage.img
</pre>
Note that this image also has a maximum capacity of 10GB (=bs= * =count=), but it uses 10GB of space no matter how much data is actually in the VM.  Note that the unused space is initially filled with zeros.  This means that a raw image can be compressed for transport very effectively with =gzip=.

---+ Using KVM
*Note*:  The KVM executable may variously be called =kvm=, =qemu-kvm=, or =qemu-system-x86_64=.  In addition, in order to use the SDL display option for KVM, X connections must be forwarded through SSH.  Use the =-Y= option on each invocation of =ssh= in order to enable this.  If all goes well, =$DISPLAY= environment will be non-empty.

The procedure for installing an OS on a VM is very similar to the procedure for installing an OS on a real machine.  The example below will invoke KVM with the new image attached to the first virtual hard disk and an ISO image of the OS installer attached to the virtual CDROM drive and boot from that device.  The VM will also 512MB of memory,have user-mode NAT networking enabled, it's output will be shown on in an SDL window (make sure X forwarding is enabled).
<pre class=screen>
kvm -hda newimage.img -cdrom Fedora-12-x86_64-DVD.iso -boot d -m 512 -net nic -net user
</pre>

In order to run the machine normally (i.e after the OS is installed) use the following command:
<pre class=screen>
kvm -hda newimage.img -m 512 -net nic -net user
</pre>

If the machine VM can be configured to start in a non-X runlevel, the =-curses= option can cause KVM to output the text console directly to the invoking terminal, bypassing the need for X forwarding.
<pre class=screen>
kvm -hda newimage.img -m 512 -net nic -net user -curses
</pre>

In a batch environment, it is generally wise to start the VM(s) with the =-snapshot= and =-nographic= options.  The =-snapshot= option causes disk writes within the VM to be redirected to a temporary file, thus allowing many VMs to be started from a single image file.  The =-nographic= option causes KVM not to attach any output method to the virtual video device.
<pre class=screen>
kvm -hda newimage.img -m 512 -net nic -net user -curses -snapshot -nographic
</pre>
