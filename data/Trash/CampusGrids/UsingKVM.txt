%META:TOPICINFO{author="MichaelFenn" date="1272385380" format="1.1" reprev="1.1" version="1.1"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! %MAKETEXT{"Starting Virtual Machines with KVM" }%

This page seeks to be a short HOWTO on using the KVM Virtual Machine Monitor (VMM) deployed on virtualization-enabled clusters such as the Clemson University Palmetto Cluster.

---+ Getting Started
KVM uses the =/dev/kvm= device as an interface between the user-mode user interface code and the CPU's hardware virtualization extensions.  Thus, in order to use KVM, you must have appropriate permissions to this device.  Below is an example of how to check these permissions:
<pre class=screen>
[mfenn@node0256 ~]$ ls -l /dev/kvm 
crw-rw---- 1 root kvm 10, 232 Apr  5 11:37 /dev/kvm
[mfenn@node0256 ~]$ id mfenn
uid=86311(mfenn) gid=10000(cuuser) groups=10000(cuuser),73839(kvm)
</pre>
In the example above, the =/dev/kvm= device is readable and writable by the =kvm= group and the user =mfenn= is a member of that group.  Thus =mfenn= has enough permissions to use KVM.

---+ Creating a Disk Image
A virtual machine (VM) needs to have an file in which to store the contents of its hard disk.  This file is known as a _disk image_.  The =qemu-img= tool may be used to create a disk image. For example:
<pre class=screen>
[mfenn@node0256 ~]$ qemu-img create -f qcow2 newimage.qcow2 10G
Formatting 'newimage.qcow2', fmt=qcow2, size=10485760 kB
[mfenn@node0256 ~]$ ls -l newimage.qcow2 
-rw-r--r-- 1 mfenn cuuser 52K Apr 27 12:12 newimage.qcow2
</pre>
In the above example, the command =qemu-img create -f qcow2 newimage.qcow2 10G= creates a new image of the format =qcow2= (KVM's native image format) named =newimage.qcow2= with a maximum capacity of 10GB.  Note however that the actual file =newimage.qcow2= is only 52KB.  This is because QCOW2 is a copy-on-write file format whose size will increase as the amount of data stored in the image increases.

If the =qemu-img= tool is not available, =dd= can also be used to create disk images.  These images will be in the =raw= format and will not have the expanding-size property of that the QCOW2 images have.  A =raw= image is otherwise identical.  Below is an example of creating an image file with =dd=:
<pre class=screen>

</pre>
Note that this image also has a maximum capacity of 10GB (=bs= * =count=), but it uses 10GB of space no matter how much data is actually in the VM.  Note that the unused space is initially filled with zeros.  This means that a raw image can be compressed for transport very effectively with =gzip=.
