%META:TOPICINFO{author="TanyaLevshina" date="1268800380" format="1.1" reprev="1.7" version="1.7"}%
%META:TOPICPARENT{name="NEESFileTransfer"}%
---+!! *<nop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%

%STARTINCLUDE%
%BR%



Version 1.0 Draft-1

Document Owner: Tanya Levshina, Open Science Grid, Fermilab

*Revision History*
<table width="661" cellspacing="0" style="width: 495.75pt; border-collapse: collapse" cellpadding="0" border="0"> <tbody><tr> <td width="144" valign="top" style="width: 1.5in; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt; border-width: 1pt; border-color: windowtext; border-style: solid">

*Name*
</td> <td width="277" valign="top" style="width: 207.9pt; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: windowtext; border-right-color: windowtext; border-bottom-color: windowtext; border-top-width: 1pt; border-right-width: 1pt; border-bottom-width: 1pt; border-left-style: none; border-left-width: initial; border-left-color: initial; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt">

*Change*
</td> <td width="114" valign="top" style="width: 85.4pt; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: windowtext; border-right-color: windowtext; border-bottom-color: windowtext; border-top-width: 1pt; border-right-width: 1pt; border-bottom-width: 1pt; border-left-style: none; border-left-width: initial; border-left-color: initial; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt">

*Date*
</td> <td width="126" valign="top" style="width: 94.45pt; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: windowtext; border-right-color: windowtext; border-bottom-color: windowtext; border-top-width: 1pt; border-right-width: 1pt; border-bottom-width: 1pt; border-left-style: none; border-left-width: initial; border-left-color: initial; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt">

*Version*
</td> </tr>
<tr style="height: 0.3in"> <td width="144" valign="top" style="width: 1.5in; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-top-style: none; border-top-width: initial; border-top-color: initial; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt; height: 0.3in">

Tanya Levshina
</td> <td width="277" valign="top" style="width: 207.9pt; border-top-style: none; border-top-width: initial; border-top-color: initial; border-left-style: none; border-left-width: initial; border-left-color: initial; border-bottom-style: solid; border-bottom-color: windowtext; border-bottom-width: 1pt; border-right-style: solid; border-right-color: windowtext; border-right-width: 1pt; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt; height: 0.3in">

Initial Design
</td> <td width="114" valign="top" style="width: 85.4pt; border-top-style: none; border-top-width: initial; border-top-color: initial; border-left-style: none; border-left-width: initial; border-left-color: initial; border-bottom-style: solid; border-bottom-color: windowtext; border-bottom-width: 1pt; border-right-style: solid; border-right-color: windowtext; border-right-width: 1pt; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt; height: 0.3in">

February 22,2010
</td> <td width="126" valign="top" style="width: 94.45pt; border-top-style: none; border-top-width: initial; border-top-color: initial; border-left-style: none; border-left-width: initial; border-left-color: initial; border-bottom-style: solid; border-bottom-color: windowtext; border-bottom-width: 1pt; border-right-style: solid; border-right-color: windowtext; border-right-width: 1pt; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt; height: 0.3in">

1.0-Draft-1
</td> </tr> 
<tr style="height: 0.3in"> <td width="144" valign="top" style="width: 1.5in; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-top-style: none; border-top-width: initial; border-top-color: initial; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt; height: 0.3in">

Tanya Levshina
</td> <td width="277" valign="top" style="width: 207.9pt; border-top-style: none; border-top-width: initial; border-top-color: initial; border-left-style: none; border-left-width: initial; border-left-color: initial; border-bottom-style: solid; border-bottom-color: windowtext; border-bottom-width: 1pt; border-right-style: solid; border-right-color: windowtext; border-right-width: 1pt; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt; height: 0.3in">

Added detailed to the documents
</td> <td width="114" valign="top" style="width: 85.4pt; border-top-style: none; border-top-width: initial; border-top-color: initial; border-left-style: none; border-left-width: initial; border-left-color: initial; border-bottom-style: solid; border-bottom-color: windowtext; border-bottom-width: 1pt; border-right-style: solid; border-right-color: windowtext; border-right-width: 1pt; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt; height: 0.3in">

March 16,2010
</td> <td width="126" valign="top" style="width: 94.45pt; border-top-style: none; border-top-width: initial; border-top-color: initial; border-left-style: none; border-left-width: initial; border-left-color: initial; border-bottom-style: solid; border-bottom-color: windowtext; border-bottom-width: 1pt; border-right-style: solid; border-right-color: windowtext; border-right-width: 1pt; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt; height: 0.3in">

1.0-Draft-2
</td> </tr> 
</table>

---++Introduction
The purpose of this document is to describe the design storage archiving tools. The tools are the general purpose software intended for NEES data archiving to tapes. This document is intended for people who are planning to perform archiving and/or would like better understand the design and purpose of the provided tools.The readers are not expected to be familiar with srm protocol, dCache/Enstore HSM and with the srm-client commands.

The document will cover the initial assumptions, high level design, software dependency, implementation decisions and test plan, 
The tools could be deployed on Linux nodes with  SL 4 or 5 OS. 

---++ Overview:

The archiving tools should be able to perform the following tasks:
   * Prepare a file for archiving
   * Upload a file to the remote storage
   * Verify that a file is on tape
   * Retrieve a file from the storage
   * Get metadata about stored files:
      * remote checksum
      * file size
      * location (disk/tape)
      * path
      * creation date

The other requirements are listed below:
   * Bookkeeping - It is expected that all the tools provide comprehensive log in machine-readable format
   * In order to organize an archiving workflow  all the tools should return easily interpretable error code
   * Storage requirements: data should be stored on tape


---+++ Assumptions and Dependencies
Due to requirement to archive files on tapes the only choice of storage in OSG is dcache/Enstore. This selection results in the following limitations:
   * srm 2.2 or gsiftp protocol should be used for data archival/retrieval 
   * srm 2.2 protocol should be used for metadata retrieval
   * to achieve the best performance and tape utilization the size of the archived file should be between 5 GB - 10 GB   
   * only adler32 checksum could be used for data integrity verification due to specifics of dCache
   * authentication/authorization for storage requires X509 certificate
   * standard srm client should be used to access storage
   * standard tools should be used for certificate handling

These limitations require the installation of the latest VDT package (client) which requires SL4 or SL5 OS.

It is possible that in the future the other storage solution may be used and tools should be designed with this in mind.    

It is essential that all the tools have comprehensive machine and human readable logs that could be easily parsed to generate reports and gather statistics. We propose to follow [[http://www.cedps.net/images/f/fd/CEDPS-troubleshooting-bestPractices.pdf][Grid Logging: Best Practices Guide]] and use [[http://acs.lbl.gov/NetLoggerWiki/index.php/Main_Page][NetLogger]] API to perform all logging tasks.
This will provide:
   * Consistently structured, typed, log events
   * A standard high-resolution timestamp
   * Use of logging levels and categories to separate logs by detail and purpose.
   * Consistent use of global and local identifiers.
   * Use of regular, newline-delimited ASCII text format

This approach will meet  basic practical requirements: 
   * human "readable" in a terminal or text editor
   * directly compatible with syslog and grep

It is very costly to store on  tape the huge amount of small files. In order to improve performance and reliability we have to create tar files of predefined size. It will be extremely time consuming process to do tar file creation manually. More reasonable approach is to use software that creates multivolume tar with volumes of the same predefined length.  

In order to satisfy these assumptions the following packages should be installed on the node:
   * java 1.5 and higher
   * python 2.4.6 and higher
   * netlogger 4.1.2 and higher
   * gnutar 1.17
   * OSG client 1.2.18 and higher

---++ System Architecture

The following components are essential to provide archiving/retrieving functionality:
   * Tar Tool to create multivolume tar file from subset of data. The same tool should be used to list content of multivolume tar file or extract files from it.  The tool should be able to create the volumes of the specified size.  
   * Archiver to archive multiple files to remote storage 
   * Verification tool  to check file location and compare remote and local checksums 
   * Recovery tool to retrieve multiple files from remote storage
   * Report generator to produce predefined reports from storage tools log files 

<img src="%ATTACHURLPATH%/tools_design.jpg" alt="tools_design" width='600' height='400' />
---+++ Multivolume tar file tool

Comming soon....

---+++ Archiver tool
*Purpose:*

The purpose of the tool is to archive multiple files to tape.

*Functionality:*

For each file scheduled for archiving the tool will performed the following operations:
   * calculate checksum
   * log checksum in the log file
   * copy the file to the storage
   * log the result of copy command
   * get file metatadata from storage 
   * compare remote and local checksum
   * log result of comparison

If one of these operations fails the tool stops the processing and continues to the next file.

*Input:*
   * [[#Configuration_File][configuration file]]

*Output:*
   * log file stored in the directory specified in the configuration file

*Error conditions:*
   * For each file  failed to be archived the appropriate error with ERROR level will be logged in the log file 
   * The archival exit  code would be 0 if all the files archived successfully and 1 if at least one of the operations described above failed.

*Synopsis:*

_archive.sh config_file_

---+++ Verification tool
*Purpose:*

The purpose of the tool is to verify the location of archived files.

*Functionality:*

For each file that has been successfully archived the tool will performed the following operations:
   * get file metatadata from storage 
   * log the result of this command
   * verify that the file is located on tape
   * log the result of verification
   * compare remote and local checksum
   * log result of comparison

If one of these operations fails the tool stops the processing and continues to the next file.

*Input:*
   * [[#Configuration_File][configuration file]]

*Output:*
   * log file stored in the directory specified in the configuration file

*Error conditions:*
   * For each failed file verification the appropriate error with ERROR level will be logged in the log file 
   * The verification tool exit  code would be 0 if all the files information is correct  and 1 if at least one of the operations described above failed.

*Synopsis:*

_verify.sh config_file_
---+++ Recovery tool
*Purpose:*

The purpose of the tool is to retrieve the archived files from tapes.

*Functionality:*

For each file that has been successfully archived the tool will performed the following operations:
   * get file from tape
   * log the result of this command
   * calculate a  new checksum, compare with the old one
   * log  result of verification

If one of these operations fails the tool stops the processing and continues to the next file.

*Input:*
   * [[#Configuration_File][configuration file]]

*Output:*
   * retrieved files
   * log file stored in the directory specified in the configuration file
   
*Error conditions:*
   * For each failed file retrieval the appropriate error with ERROR level will be logged in the log file 
   * The verification tool exit  code would be 0 if all the files are retrieved  and 1 if at least one of the operations described above failed.

*Synopsis:*

_retrieve.sh config_file_

---+++ Report Generator
*Purpose:*
The purpose of the tool is to generate the various reports from the log files

*Functionality:*
   * list of files that have been attempted to archive during a particular period of time
   * list of failed attempts to archive files
   * list of files that are successfully archived
   * list of files currently on tapes
   * list of files that are in dCache but not on tape
   * list of corrupted files on tape
   * time interval needed for file archiving 


*Input:*
   * [[#Log_File][Log file name]]

*Output:*
   * stdout in "raw" format or in "html" format in order to be displayed on the web.
   
*Error conditions:*
   * Returns 1 in case of failure to generate report

*Synopsis:*

_report.sh  [-h|--help] |  -r|--report_number <number> [-s|--start_time] <date> [-e|--end_time] <date> -f|--format <type>  log_name_

Where
<verbatim>
number (1-8) 
                         #1 - list of files that have been attempted to archive;
                         #2 - list of failed attempts to archive files;
                         #3 - list of files that are successfully archived;
                         #4 - list of files currently on tapes;
                         #5 - list of files that are in dCache but not on tape;
                         #6 - list of corrupted files on tape;
                         #7 - list time interval needed for file archiving
date: year-month-day-hour-min-sec
format: raw|html
</verbatim>

*Example:*
The example of "raw" report that lists all the successfully archived files with checksum:
<pre class="screen">
report.sh  -r 3 ../../var/log/FileArchive.file_list_test-20100224104728.log 
2010-02-24 10:47:46  /home/tlevshin/dcache_validation_test_1/dcache_validation_test/var/test_files/test1_1 adc41975
2010-02-24 10:47:57  /home/tlevshin/dcache_validation_test_1/dcache_validation_test/var/test_files/test1_2 b83a1dfa
2010-02-24 10:48:24  /home/tlevshin/dcache_validation_test_1/dcache_validation_test/var/test_files/test1_3 c3f2865
2010-02-24 10:48:50  /home/tlevshin/dcache_validation_test_1/dcache_validation_test/var/test_files/test1_4 86f51f96
2010-02-24 10:49:09  /home/tlevshin/dcache_validation_test_1/dcache_validation_test/var/test_files/test1_5 8198143a
2010-02-24 10:49:26  /home/tlevshin/dcache_validation_test_1/dcache_validation_test/var/test_files/test1_6 38301fb2
2010-02-24 10:49:44  /home/tlevshin/dcache_validation_test_1/dcache_validation_test/var/test_files/test1_7 dab21888
2010-02-24 10:49:56  /home/tlevshin/dcache_validation_test_1/dcache_validation_test/var/test_files/test1_8 419f1f50
2010-02-24 10:50:16  /home/tlevshin/dcache_validation_test_1/dcache_validation_test/var/test_files/test1_9 b53b161b
</pre>
[[https://twiki.grid.iu.edu/twiki/pub/SoftwareTools/NEESStorageToolsDesignDocument/report_1.pdf][This  link]] provides the examples of two of the others reports. It lists all the files that has been archived and their status.



---+++ Configuration File 
The following information should be specified in the configuration file:
<pre class="screen">
#CONFIGURATION FILE FOR NEES ARCHIVE
#FQN of the file that lists all the files that should be archived/checked
FILELIST_NAME = /tmp/file_list

#SURL - storage url
SURL = srm://fndca1.fnal.gov:8443/srm/managerv2\?SFN=/pnfs/fnal.gov/usr/nees

#LOG file directory
LOG_DIR = /home/tlevshin/nees/var/log

#LOG level
LOG_LEVEL = INFO
</pre>
---+++ Files List Structure
Files list is a file that contains all the fqn of the files that are scheduled for archiving, verification or retrieval. In case of verification or retrieval it should also contain the adler32 checksum of the files. For example:
<pre class="screen">
NEES-2007-0409.groups.tar d2b072c7
tanya_test_1G_random_data 7cdd0473
</pre>
---+++ Bookkeeping

Log files name will be formed by combing the following info:
   * tool name
   * files list name
   * data stamp (year/month/day/hour/min/second)

For example: _FileRetrieve.file_list_2-20100222120008.log_ or  _VerifyArchive.file_list_1-20100222113843.log_

The structure of the log file will consists of the following fields:
   * time stamp (see details in NetLogger documentation)
   * log level
   * event name 
   * file name or file list
   * exit status of the event and reason and error when relevant
 
For example the content could look like the following:
<pre class="screen">
more   ../../var/log/VerifyArchive.file_list_1-20100222113843.log
ts=2010-02-22T17:38:43.566899Z event=VerifyArchive.verifyList.start level=INFO file_list=/tmp/file_list_1
ts=2010-02-22T17:38:43.567161Z event=VerifyArchive.verify.file.start level=INFO local_checksum=7cdd0473 file=tanya_test_1G_random_data
ts=2010-02-22T17:38:43.567267Z event=VerifyArchive.shellexecutor.start level=INFO command="srmls  -2 -l srm://fndca1.fnal.gov:8443/srm/managerv2\?SFN=/pnfs/fnal.gov/usr/nees/tanya_test_1G_random_data"
ts=2010-02-22T17:38:48.425712Z event=VerifyArchive.shellexecutor.end level=INFO status=0 command="srmls  -2 -l srm://fndca1.fnal.gov:8443/srm/managerv2\?SFN=/pnfs/fnal.gov/usr/nees/tanya_test_1G_random_data"
ts=2010-02-22T17:38:48.426235Z event=VerifyArchive.verify.file.end level=INFO local_checksum=7cdd0473 remote_checksum=7cdd0473 file=tanya_test_1G_random_data locality=ONLINE_AND_NEARLINE
ts=2010-02-22T17:38:48.426354Z event=VerifyArchive.verifyList.end level=INFO file_list=/tmp/file_list_1 status=0 number_failures=0 number_of_files=1
</pre>

---++ Class Diagram
<img src="%ATTACHURLPATH%/st_class_diagram.jpg" alt="st_class_diagram.jpg" width='600' height='400' />
---+++ Directory Structure
The following directory structure is proposed for these tools:

<img src="%ATTACHURLPATH%/st_dir_str.jpg" alt="st_dir_strjpg" width='500' height='700' />

---++ Implementation 

Python , java

-- Main.TanyaLevshina - 15 March 2010

%META:FILEATTACHMENT{name="st_class_diagram.jpg" attachment="st_class_diagram.jpg" attr="" comment="" date="1266868317" path="st_class_diagram.jpg" size="36045" stream="st_class_diagram.jpg" tmpFilename="/usr/tmp/CGItemp27388" user="TanyaLevshina" version="1"}%
%META:FILEATTACHMENT{name="st_dir_str.jpg" attachment="st_dir_str.jpg" attr="" comment="" date="1267212664" path="st_dir_str.jpg" size="38949" stream="st_dir_str.jpg" tmpFilename="/usr/tmp/CGItemp34534" user="TanyaLevshina" version="3"}%
%META:FILEATTACHMENT{name="reprt_1.html" attachment="reprt_1.html" attr="" comment="" date="1267047251" path="report_1.pdf" size="51096" stream="report_1.pdf" tmpFilename="/usr/tmp/CGItemp34482" user="TanyaLevshina" version="2"}%
%META:FILEATTACHMENT{name="report_1.pdf" attachment="report_1.pdf" attr="" comment="" date="1267051733" path="report_1.pdf" size="57555" stream="report_1.pdf" tmpFilename="/usr/tmp/CGItemp34382" user="TanyaLevshina" version="4"}%
%META:FILEATTACHMENT{name="tools_design.jpg" attachment="tools_design.jpg" attr="" comment="" date="1268776895" path="tools_design.jpg" size="59519" stream="tools_design.jpg" tmpFilename="/usr/tmp/CGItemp35399" user="TanyaLevshina" version="1"}%
