%META:TOPICINFO{author="TanyaLevshina" date="1267634297" format="1.1" version="1.4"}%
%META:TOPICPARENT{name="NEESFileTransfer"}%
---+!! *<nop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%

%STARTINCLUDE%
%BR%



Version 1.0 Draft-1

Document Owner: Tanya Levshina, Open Science Grid, Fermilab

*Revision History*
<table width="661" cellspacing="0" style="width: 495.75pt; border-collapse: collapse" cellpadding="0" border="0"> <tbody><tr> <td width="144" valign="top" style="width: 1.5in; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt; border-width: 1pt; border-color: windowtext; border-style: solid">

*Name*
</td> <td width="277" valign="top" style="width: 207.9pt; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: windowtext; border-right-color: windowtext; border-bottom-color: windowtext; border-top-width: 1pt; border-right-width: 1pt; border-bottom-width: 1pt; border-left-style: none; border-left-width: initial; border-left-color: initial; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt">

*Change*
</td> <td width="114" valign="top" style="width: 85.4pt; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: windowtext; border-right-color: windowtext; border-bottom-color: windowtext; border-top-width: 1pt; border-right-width: 1pt; border-bottom-width: 1pt; border-left-style: none; border-left-width: initial; border-left-color: initial; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt">

*Date*
</td> <td width="126" valign="top" style="width: 94.45pt; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-top-color: windowtext; border-right-color: windowtext; border-bottom-color: windowtext; border-top-width: 1pt; border-right-width: 1pt; border-bottom-width: 1pt; border-left-style: none; border-left-width: initial; border-left-color: initial; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt">

*Version*
</td> </tr>
<tr style="height: 0.3in"> <td width="144" valign="top" style="width: 1.5in; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-right-color: windowtext; border-bottom-color: windowtext; border-left-color: windowtext; border-right-width: 1pt; border-bottom-width: 1pt; border-left-width: 1pt; border-top-style: none; border-top-width: initial; border-top-color: initial; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt; height: 0.3in">

Tanya Levshina
</td> <td width="277" valign="top" style="width: 207.9pt; border-top-style: none; border-top-width: initial; border-top-color: initial; border-left-style: none; border-left-width: initial; border-left-color: initial; border-bottom-style: solid; border-bottom-color: windowtext; border-bottom-width: 1pt; border-right-style: solid; border-right-color: windowtext; border-right-width: 1pt; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt; height: 0.3in">

Initial Design
</td> <td width="114" valign="top" style="width: 85.4pt; border-top-style: none; border-top-width: initial; border-top-color: initial; border-left-style: none; border-left-width: initial; border-left-color: initial; border-bottom-style: solid; border-bottom-color: windowtext; border-bottom-width: 1pt; border-right-style: solid; border-right-color: windowtext; border-right-width: 1pt; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt; height: 0.3in">

February 22,2010
</td> <td width="126" valign="top" style="width: 94.45pt; border-top-style: none; border-top-width: initial; border-top-color: initial; border-left-style: none; border-left-width: initial; border-left-color: initial; border-bottom-style: solid; border-bottom-color: windowtext; border-bottom-width: 1pt; border-right-style: solid; border-right-color: windowtext; border-right-width: 1pt; padding-top: 0in; padding-right: 5.4pt; padding-bottom: 0in; padding-left: 5.4pt; height: 0.3in">

1.0-Draft-1
</td> </tr> 
</table>

---++Introduction
This is a design document for NEES Storage Tools. The tools are planning to be used for NEES data archiving to Fermi dCache public Storage. There is nothing specific to NEES in this design document. 
---++Tools Overview
The following tools has been identify as essential to perform the task in hand:
   * Tar Tool  that allows to create multivolume tar file from subset of NEES data. Same tool should be used to list content of multivolume tar file or extarct files from it.  
   * Archiver that archives multiple files to the remote storage 
   * Verification tool  that checks file location and compares remote and local checksums 
   * Recovery tool that retrieve multiple files from remote storage
   * Report generator that is able to produce predefined reports from storage tools log files 


---++ Design Consideration
The proposed tools should be used by users that are not familiar with dCache/Enstore HSM and with the client commands. The tools should be easy to install and use. It is essential that all the tools have comprehensive machine and human readable logs that could be easily parsed to generate reports and gather statistics.  

We propose to follow [[http://www.cedps.net/images/f/fd/CEDPS-troubleshooting-bestPractices.pdf][Grid Logging: Best Practices Guide]] and use [[http://acs.lbl.gov/NetLoggerWiki/index.php/Main_Page][NetLogger]] API to perform all logging tasks.
This will provide:
   * Consistently structured, typed, log events
   * A standard high-resolution timestamp
   * Use of logging levels and categories to separate logs by detail and purpose.
   * Consistent use of global and local identifiers.
   * Use of some regular, newline-delimited ASCII text format

This approach will meet some basic practical requirements: 
   * human "readable" in a terminal or text editor
   * directly compatible with syslog and grep

---++ Software Architecture

---+++ Class Diagram
<img src="%ATTACHURLPATH%/st_class_diagram.jpg" alt="st_class_diagram.jpg" width='600' height='400' />
---+++ Directory Structure
The following directory structure is proposed for these tools:

<img src="%ATTACHURLPATH%/st_dir_str.jpg" alt="st_dir_strjpg" width='500' height='700' />



---+++ Configuration file 
The following information should be specified in the configuration file:
<pre class="screen">
#CONFIGURATION FILE FOR NEES ARCHIVE
#FQN of the file that lists all the files that should be archived/checked
FILELIST_NAME = /tmp/file_list

#SURL - storage url
SURL = srm://fndca1.fnal.gov:8443/srm/managerv2\?SFN=/pnfs/fnal.gov/usr/nees

#LOG file directory
LOG_DIR = /home/tlevshin/nees/var/log

#LOG level
LOG_LEVEL = INFO
</pre>
---+++ Files List Structure
Files list is a file that contains all the fqn of the files that are scheduled for archiving, verification or retrieval. In case of verification or retrieval it should also contain the adler32 checksum of the files. For example:
<pre class="screen">
NEES-2007-0409.groups.tar d2b072c7
tanya_test_1G_random_data 7cdd0473
</pre>
---+++ Bookkeeping

Log files name will be formed by combing the following info:
   * tool name
   * files list name
   * data stamp (year/month/day/hour/min/second)

For example: _FileRetrieve.file_list_2-20100222120008.log_ or  _VerifyArchive.file_list_1-20100222113843.log_

The structure of the log file will consists of the following fields:
   * time stamp (see details in NetLogger documentation)
   * log level
   * event name 
   * file name or file list
   * exit status of the event and reason and error when relevant
 
For example the content could look like the following:
<pre class="screen">
more   ../../var/log/VerifyArchive.file_list_1-20100222113843.log
ts=2010-02-22T17:38:43.566899Z event=VerifyArchive.verifyList.start level=INFO file_list=/tmp/file_list_1
ts=2010-02-22T17:38:43.567161Z event=VerifyArchive.verify.file.start level=INFO local_checksum=7cdd0473 file=tanya_test_1G_random_data
ts=2010-02-22T17:38:43.567267Z event=VerifyArchive.shellexecutor.start level=INFO command="srmls  -2 -l srm://fndca1.fnal.gov:8443/srm/managerv2\?SFN=/pnfs/fnal.gov/usr/nees/tanya_test_1G_random_data"
ts=2010-02-22T17:38:48.425712Z event=VerifyArchive.shellexecutor.end level=INFO status=0 command="srmls  -2 -l srm://fndca1.fnal.gov:8443/srm/managerv2\?SFN=/pnfs/fnal.gov/usr/nees/tanya_test_1G_random_data"
ts=2010-02-22T17:38:48.426235Z event=VerifyArchive.verify.file.end level=INFO local_checksum=7cdd0473 remote_checksum=7cdd0473 file=tanya_test_1G_random_data locality=ONLINE_AND_NEARLINE
ts=2010-02-22T17:38:48.426354Z event=VerifyArchive.verifyList.end level=INFO file_list=/tmp/file_list_1 status=0 number_failures=0 number_of_files=1
</pre>

---+++ Report Generator
Report Generator should be able to generate the following reports from the log files:
   * list of files that have been attempted to archive during a particular period of time
   * list of failed attempts to archive files
   * list of files that are successfully archived
   * list of files currently on tapes
   * list of files that are in dCache but not on tape
   * list of corrupted files on tape
   * time interval needed for file archiving 

Reports could be generated via command line in "raw" format or in "html" format in order to be displayed on the web.
This is "usage" of report generator:
<pre class="screen">
-bash-3.00$  python Report.py --help
usage: Usage:Report.py [options] log_name

options:
  -h, --help            show this help message and exit
  -r REPORT_NUMBER, --report_number=REPORT_NUMBER
                       where report_number (1-8) 
                         #1 - list of files that have been attempted to archive;
                         #2 - list of failed attempts to archive files;
                         #3 - list of files that are successfully archived;
                         #4 - list of files currently on tapes;
                         #5 - list of files that are in dCache but not on tape;
                         #6 - list of corrupted files on tape;
                         #7 - list time interval needed for file archiving
  -s START_TIME, --start_time=START_TIME
                        start time of report: year-month-day-hour-min-sec
  -e END_TIME, --end_time=END_TIME
                        end time of report: year-month-day-hour-min-sec
  -f FORMAT, --format=FORMAT
                        output format: [raw|html]
</pre>


The example of "raw" report that lists all the successfully archived files with checksum:
<pre class="screen">
-bash-3.00$ python Report.py  -r 3 ../../var/log/FileArchive.file_list_test-20100224104728.log 
2010-02-24 10:47:46  /home/tlevshin/dcache_validation_test_1/dcache_validation_test/var/test_files/test1_1 adc41975
2010-02-24 10:47:57  /home/tlevshin/dcache_validation_test_1/dcache_validation_test/var/test_files/test1_2 b83a1dfa
2010-02-24 10:48:24  /home/tlevshin/dcache_validation_test_1/dcache_validation_test/var/test_files/test1_3 c3f2865
2010-02-24 10:48:50  /home/tlevshin/dcache_validation_test_1/dcache_validation_test/var/test_files/test1_4 86f51f96
2010-02-24 10:49:09  /home/tlevshin/dcache_validation_test_1/dcache_validation_test/var/test_files/test1_5 8198143a
2010-02-24 10:49:26  /home/tlevshin/dcache_validation_test_1/dcache_validation_test/var/test_files/test1_6 38301fb2
2010-02-24 10:49:44  /home/tlevshin/dcache_validation_test_1/dcache_validation_test/var/test_files/test1_7 dab21888
2010-02-24 10:49:56  /home/tlevshin/dcache_validation_test_1/dcache_validation_test/var/test_files/test1_8 419f1f50
2010-02-24 10:50:16  /home/tlevshin/dcache_validation_test_1/dcache_validation_test/var/test_files/test1_9 b53b161b
</pre>
[[https://twiki.grid.iu.edu/twiki/pub/SoftwareTools/NEESStorageToolsDesignDocument/report_1.pdf][This  link]] provides the examples of two of the reports. It lists all the files that has been archived and their status.


---++ Implementation 

Python , java

---+++ Dependencies
   * java 1.5 and higher
   * python 2.4.6 and higher
   * netlogger 4.1.2 and higher
   * gnutar 1.17
-- Main.TanyaLevshina - 22 Feb 2010

%META:FILEATTACHMENT{name="st_class_diagram.jpg" attachment="st_class_diagram.jpg" attr="" comment="" date="1266868317" path="st_class_diagram.jpg" size="36045" stream="st_class_diagram.jpg" tmpFilename="/usr/tmp/CGItemp27388" user="TanyaLevshina" version="1"}%
%META:FILEATTACHMENT{name="st_dir_str.jpg" attachment="st_dir_str.jpg" attr="" comment="" date="1267212664" path="st_dir_str.jpg" size="38949" stream="st_dir_str.jpg" tmpFilename="/usr/tmp/CGItemp34534" user="TanyaLevshina" version="3"}%
%META:FILEATTACHMENT{name="reprt_1.html" attachment="reprt_1.html" attr="" comment="" date="1267047251" path="report_1.pdf" size="51096" stream="report_1.pdf" tmpFilename="/usr/tmp/CGItemp34482" user="TanyaLevshina" version="2"}%
%META:FILEATTACHMENT{name="report_1.pdf" attachment="report_1.pdf" attr="" comment="" date="1267051733" path="report_1.pdf" size="57555" stream="report_1.pdf" tmpFilename="/usr/tmp/CGItemp34382" user="TanyaLevshina" version="4"}%
