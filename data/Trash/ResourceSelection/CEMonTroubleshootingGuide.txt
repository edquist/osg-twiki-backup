%META:TOPICINFO{author="KyleGross" date="1328026262" format="1.1" version="1.20"}%
%META:TOPICPARENT{name="WebHome"}%
---+ CEMon Trash/Troubleshooting Guide for OSG Site Administrators

In case of user problems reported to the OSG GOC, site administrators should use the following troubleshooting guide before asking expert help.
   * Most of the tasks listed in the guide v5.2 below are automated in [[%ATTACHURL%/ReSSCEMonTestSuite-0.1.0.tar.gz][ReSSCEMonTestSuite-0.1.0]]. Steps starting from Step 4 are not automated at present. Visit the ReSSCEMonTestSuite for more information.
   * CEMON_Troubleshooting_Guide v5.2 - OSG 1.0 & OSG 1.2 ([[%ATTACHURL%/CEMON_Troubleshooting_Guide_5_2.doc][doc]] | [[%ATTACHURL%/CEMON_Troubleshooting_Guide_5_2.pdf][pdf]] | <a href="#OSG-1.0">twiki</a>) by Tanya Levshina, April 11 2008 (updated by Gabriele Garzoglio, June 3, 2008)
   * CEMON_Troubleshooting_Guide v4 - OSG 0.8 ([[%ATTACHURL%/CEMON_Troubleshooting_Guide_4.doc][doc]] | [[%ATTACHURL%/CEMON_Troubleshooting_Guide_4.pdf][pdf]]| <a href="#OSG-0.8">twiki</a>) by Tanya Levshina, Nov 01 2007

-- Main.ParagMhashilkar - 06 May 2009

---++ Enable logging in tomcat
Sometimes it is very useful to enable detailed logging in tomcat to understand certain types of failures. Follow the instruction below (Thanks to Luigi Zangrando from the CEMon group)
   * Copy/Create the log4j.properties file with following contents into $CATALINA_HOME/common/classes
<pre>
log4j.rootLogger=DEBUG, R 
log4j.appender.R=org.apache.log4j.RollingFileAppender 
log4j.appender.R.File=${catalina.home}/logs/tomcat.log 
log4j.appender.R.MaxFileSize=10MB 
log4j.appender.R.MaxBackupIndex=10 
log4j.appender.R.layout=org.apache.log4j.PatternLayout 
log4j.appender.R.layout.ConversionPattern=%p %t %c - %m%n          
</pre>
   * Download (if not already installed) Log4J (v1.2 or later) and place the log4j jar in $CATALINA_HOME/common/lib.
   * Download (if not already installed) Commons Logging and place the commons-logging-x.y.z.jar (not commons-logging-api-x.y.z.jar) in $CATALINA_HOME/common/lib with the log4j jar.
   * (Re)Start Tomcat. You can find further debugging info in $CATALINA_HOME/logs/tomcat.log


<a name="OSG-1.0">
---++ Guide v5.2 (OSG 1.0 and OSG 1.2) TEXT DUMP

VERY QUICK CHECKLIST:

1.	To verify that your CEMon is successfully reporting to ReSS issue the following command from the node where condor is installed:
<verbatim>
condor_status -pool osg-ress-1.fnal.gov -l -constraint "GlueCEInfoHostName == \"<YOUR HOST_NAME>\""
</verbatim>

it should report back something like the following:

<verbatim>
MyType = "Machine"
TargetType = "Job"
Name = "tier2-02.uchicago.edu:2119/jobmanager-condor-atlas.1231388458"
GlueCEInfoContactString = "tier2-02.uchicago.edu:2119/jobmanager-condor"
CurMatches = 0
Requirements = (CurMatches < 10)
WantAdRevaluate = TRUE
ReSSVersion = "1.0.6"
GlueCEInfoApplicationDir = "/share/app"
GlueHostProcessorModel = "Intel(R) Xeon(TM) CPU 3.00GHz"
GlueCEName = "atlas"
GlueCEHostingCluster = "tier2-02.uchicago.edu"
GlueCEPolicyPriority = 0
GlueHostProcessorVendor = "GenuineIntel"
GlueHostProcessorClockSpeed = 1000
GlueSiteUniqueID = "tier2-02.uchicago.edu"
</verbatim>

If this command returns no output, then ReSS is NOT receiving your site information from CEMon. In this case, do the following:

2.	Check permission on the service certificate and key. Verify that service certificate in apache =$VDT_LOCATION/apache/conf/extra/httpd-ssl.conf=  exists and is owned by "daemon" (or whatever daemon is running apache and tomcat) and have a right permission (httpkey.pem should be readable only by user "daemon")

=SSLCertificateFile /etc/grid-security/http/httpcert.pem=

=SSLCertificateKeyFile /etc/grid-security/http/httpkey.pem=

           After changing permissions restart apache and tomcat.

            Check the permission of a gridmap file (It should be set to readable to world 644).   
            The file location is defined in =$VDT_LOCATION/glite/etc/glite-ce-monitor/authconfig.xml= 
      
             After changing permissions restart apache and tomcat.
	Check that the certificate is not expired by executing command:

                 =openssl x509 -dates -in /etc/grid-security/http/httpcert.pem   -noout=


3.	Check that apache  and tomcat are running (use ps command, for example "ps -efw | grep tomcat")  and if you have a certificate uploaded to your browser check if you can access CEMon by using your browser to check the CE-Monitor running on your site: 

=https://YOUR_HOST_NAME:8443/ce-monitor/TopicList=

(for example:
=https://cms-xen1.fnal.gov:8443/ce-monitor/TopicList=)

If you have your DN listed in /etc/grid-security/grid-mapfile you will get back a web page showing the "CE Monitor Topics", consisting of a table with two columns: (1) topics (it should show OSG_CE); (2) dialects (it should show at least OLD_CLASSAD and RAW).

Click on "OLD_CLASSAD" and "RAW" links: you should be able to see the last event  that CEMON sent to ReSS and BDII Consumer respectively.

If your DN is not listed you should get something like this:
User DC=org,DC=doegrids,OU=People,CN=Name LastName ....  not authorized for {http://glite.org/ce/monitor}BrowseTopicList


4.	Verify that your GIP configuration is correct.

a.	Run GIP wrapper script manually and save its std output and error e.g. in /tmp/out and /tmp/err
<verbatim>
$VDT_LOCATION/gip/libexec/osg-info-wrapper >/tmp/out 2>/tmp/err
</verbatim>

b. Check that you do not have any errors in /tmp/err. 

c. cd $VDT_LOCATION

d. . setup.sh

e. cd verify-gip-for-cemon

f. run the following script, so that it processes the gip output saved in point a. above

=./verify-gip-for-cemon-wrapper  /tmp/out=

            	The script will either print out the valid gip configuration          
formatted for CEMon OR generate an error that would help you with the 
diagnostic of GIP configuration problems.


5. Check firewall settings on your local computer


6. Increase level of debugging.

a. Modify =$VDT_LOCATION/tomcat/v55/webapps/ce-monitor/WEB-INF/classes/log4j.properties=:
<verbatim>
log4j.logger.org.glite=debug, fileout
#log4j.logger.org.glite.ce.monitor.holder.NotificationHolder=debug, fileout

# log4j.logger.org.glite=info, fileout
log4j.appender.fileout=org.apache.log4j.RollingFileAppender
log4j.appender.fileout.File=/usr/local/osg-ce/glite/var/log/glite-ce-monitor.log
log4j.appender.fileout.MaxFileSize=2MB
log4j.appender.fileout.MaxBackupIndex=20
log4j.appender.fileout.layout=org.apache.log4j.PatternLayout
log4j.appender.fileout.layout.ConversionPattern=%d{dd MMM yyyy HH:mm:ss,SSS} %c - %m%n
</verbatim>
      
b. Restart tomcat


7. If everything mentioned above does not expose any problem, contact expert support and provide the following information:

a. catalina log (=$VDT_LOCATION/tomcat/v55/logs/catalina.out=)

b. cemonitor log (=$VDT_LOCATION/glite/var/log/glite-ce-monitor.log=)

c. output of the wrapper script (=$VDT_LOCATION/gip/libexec/osg-info-wrapper=)

d. configuration files located in (=$VDT_LOCATION/glite/etc/glite-ce-monitor/=)


<a name="OSG-0.8">
---++ Guide v4 (OSG 0.8) TEXT DUMP

CEMON Trash/Troubleshooting Guide 
    T.Levshina 
 
VERY QUICK CHECKLIST: 
 
1. To verify that your CEMon is successfully reporting to ReSS issue the following 
command:
<verbatim>
condor_status -pool osg-ress-1.fnal.gov -l -constraint 'GlueCEInfoHostName == "YOUR_FQDN_HOST_NAME" '
</verbatim>
(e.g. abitibi.sbgrid.org) 

it should report back something like the following: 

<verbatim>
MyType = "Machine" 
TargetType = "Job" 
Name = "tier2-02.uchicago.edu:2119/jobmanager-condor-atlas.1231388458" 
GlueCEInfoContactString = "tier2-02.uchicago.edu:2119/jobmanager-condor" 
....
</verbatim>

with one such block per VO you support.  If this works, then CEMon should be working fine.  Otherwise, go to 2.

2. Check permission on the service certificate and key. Verify that service certificate 
in apache =$VDT_LOCATION/apache/conf/extra/httpd-ssl.conf=  exists and is 
owned by &#8220;daemon&#8221; (or whatever daemon is running apache and tomcat)
 
=SSLCertificateFile /etc/grid-security/http/httpcert.pem=

=SSLCertificateKeyFile /etc/grid-security/http/httpkey.pem=

After changing permissions restart apache and tomcat. 
 
Check the permission of a gridmap file (It should be set to readable to world 0644). The file location is defined in =$VDT_LOCATION/glite/etc/glite-ce-monitor/authconfig.xml=. After changing permissions restart apache and tomcat. 
 
3. Check that apache  and tomcat are running (use ps command) and if you have a 
certificate uploaded to your browser check if you can access CEMon by this link:

=https://<YOUR_HOST_NAME>:8443/ce-monitor/services/CEMonitor?method=getInfo=

If you have your DN listed in /etc/grid-security/grid-mapfile you will get back some XML which will include =CE-Monitor_web_application=, otherwise you'll have XML which contains =Server.GeneralException= and it should show the cert DN which has been rejected.
 
4. Verify that your GIP configuration is correct. 
   a. Run GIP wrapper script manually:

=$VDT_LOCATION/lcg/libexec/osg-info-wrapper >/tmp/out 2>/tmp/err=

   b. Check that you do not have any errors in =/tmp/err=.
   c. Check that you have all essential Glue Schema attributes in =/tmp/out= (such as GlueCEUniqueID , GlueClusterUniqueID, GlueSubClusterUniqueID).
If installed version of VDT is 1.8.1 and higher you can test your GIP  configuration by running =verify-gip-for-cemon-wrapper= script. In order to do so you have to: 

<verbatim>
cd $VDT_LOCATION 
. setup.sh 
cd verify-gip-for-cemon 
run the script 
./verify-gip-for-cemon-wrapper 
</verbatim>

The script will either print out the valid gip configuration formatted for CEMon or generate an error that would help you with  
diagnostic of GIP configuration problems.  For help: =./verify-gip-for-cemon-wrapper -h=

=Usage: java -DVDT_LOCATION=$VDT_LOCATION [OPTION...] [FILE]=
 
If FILE is specified checks Glue Schema format  of that file else checks output of =$VDT_LOCATION/glite/etc/glite-ce-ce-plugin/glite-ce-info=.  The format should be complaint to OSG_CE topic/OLD_CLASSAD dialect 

5. If everything mentioned above is working, contact export support and provide the 
following information: 
   * catalina log (=$VDT_LOCATION/tomcat/v4/logs/catalina.out=)
   * cemonitor log (=$VDT_LOCATION/tomcat/v4/logs/glite-ce-monitor.log=) 
   * output of the wrapper script (=$VDT_LOCATION/lcg/libexec/osg-info-wrapper=) 

%META:FILEATTACHMENT{name="CEMON_Troubleshooting_Guide_5_2.doc" attr="" autoattached="1" comment="" date="1212507122" path="CEMON_Troubleshooting_Guide_5_2.doc" size="346624" user="Main.GabrieleGarzoglio" version="1"}%
%META:FILEATTACHMENT{name="CEMON_Troubleshooting_Guide_4.doc" attr="" autoattached="1" comment="" date="1193935325" path="CEMON_Troubleshooting_Guide_4.doc" size="54272" user="Main.TanyaLevshina" version="1"}%
%META:FILEATTACHMENT{name="CEMON_Troubleshooting_Guide_2.doc" attr="" autoattached="1" comment="" date="1187189192" path="CEMON_Troubleshooting_Guide_2.doc" size="46080" user="Main.GabrieleGarzoglio" version="1"}%
%META:FILEATTACHMENT{name="CEMON_Troubleshooting_Guide_5_2.pdf" attr="" autoattached="1" comment="" date="1212507107" path="CEMON_Troubleshooting_Guide_5_2.pdf" size="274673" user="Main.GabrieleGarzoglio" version="1"}%
%META:FILEATTACHMENT{name="CEMON_Troubleshooting_Guide_5_1.pdf" attr="" autoattached="1" comment="" date="1212157913" path="CEMON_Troubleshooting_Guide_5_1.pdf" size="273695" user="Main.GabrieleGarzoglio" version="1"}%
%META:FILEATTACHMENT{name="CEMON_Troubleshooting_Guide_5.doc" attr="" autoattached="1" comment="" date="1207932053" path="CEMON_Troubleshooting_Guide_5.doc" size="347136" user="Main.TanyaLevshina" version="1"}%
%META:FILEATTACHMENT{name="CEMON_Troubleshooting_Guide_3.doc" attr="" autoattached="1" comment="" date="1191254083" path="CEMON_Troubleshooting_Guide_3.doc" size="45568" user="Main.GabrieleGarzoglio" version="1"}%
%META:FILEATTACHMENT{name="CEMON_Troubleshooting_Guide_5_1.doc" attr="" autoattached="1" comment="" date="1212157887" path="CEMON_Troubleshooting_Guide_5_1.doc" size="345088" user="Main.GabrieleGarzoglio" version="1"}%
%META:FILEATTACHMENT{name="CEMON_Troubleshooting_Guide_5.pdf" attr="" autoattached="1" comment="" date="1207932352" path="CEMON_Troubleshooting_Guide_5.pdf" size="392933" user="Main.TanyaLevshina" version="1"}%
%META:FILEATTACHMENT{name="CEMON_Troubleshooting_Guide_4.pdf" attr="" autoattached="1" comment="" date="1194031694" path="CEMON_Troubleshooting_Guide_4.pdf" size="40173" user="Main.GabrieleGarzoglio" version="1"}%
%META:FILEATTACHMENT{name="ReSSCEMonTestSuite-0.1.0.tar.gz" attachment="ReSSCEMonTestSuite-0.1.0.tar.gz" attr="h" comment="ReSSCEMonTestSuite v0.1.0" date="1241644652" path="ReSSCEMonTestSuite-0.1.0.tar.gz" size="374310" stream="ReSSCEMonTestSuite-0.1.0.tar.gz" tmpFilename="/usr/tmp/CGItemp19390" user="ParagMhashilkar" version="1"}%
