%META:TOPICINFO{author="JeffPorter" date="1229462810" format="1.1" version="1.57"}%
---+ *<noop>%SPACEOUT{ "%TOPIC%" }%*

%TOC%

---++ Introduction

[[https://www.racf.bnl.gov/Facility/GUMS/][Grid User Management System (GUMS)]] is a Grid Identity Mapping Service. Identity mapping is necessary when a site's resources do not use grid credentials natively, but instead use a different mechanism to identify users, such as UNIX accounts or Kerberos principals. In these cases, the grid credential for each incoming job must be associated with an appropriate site credential. The GUMS server performs this mapping and communicates it to the gatekeepers. The gatekeepers are charged with enforcing the site mapping established by GUMS. The GUMS client (gatekeeper) portion consists of an admin tool for querying and/or changing the state of the server. Typically, the term "GUMS" refers to the server portion.

GUMS is particularly well suited to a heterogeneous environment with multiple gatekeepers; it allows the implemenation of a single site-wide usage policy, thereby providing better control and security for access to the site's grid resources. Using GUMS, individual resource administrators are able to assign different mapping policies to different groups of users and define groups of hosts on which the mappings will be used. GUMS was designed to integrate with the site's local information services (such as HR databases or LDAP).

GUMS is intended to be used with %CACHE%, but it (the server portion) does not get installed as part of compute element software; you must install it separately. For the OSG ITB you will need to use one of three scenarios, "Local", "Full Privilege" or the "Compatibility" site configurations, which is described in the [[AboutAuthorizationForCE][AboutAuthorizationForCE]] page.

More Information can be obtained from the following resources:

   * The full GUMS service description and a detailed manual is available at the GUMS site: https://www.racf.bnl.gov/Facility/GUMS/
   * The Privilege project <a href="http://computing.fnal.gov/docs/products/voprivilege/">homepage</a> contains links to everything.  
   * vo-admins@opensciencegrid.org - you can add yourself to this mail list by sending mail to listserv@opensciencegrid.org with the body of the mail being: add vo-admins 

---++ Pre-requisites for a GUMS Installation

See SitePlanning.  In particular, install Pacman, get host and http certificates. If you have an OSG GUMS running and you're about to reinstall or if any of the following daemons are installed and running on your machine: 
   * Apache
   * Tomcat V5 or V5.5
   * !MySql

---++ Install GUMS Server

Here we describe the pacman GUMS installation. You can choose to install GUMS manually, or [[https://www.racf.bnl.gov/Facility/GUMS/1.2/installation_manual.html][learn more about the installation]]. 

If you have a $VDT_LOCATION, go to it. If you don't, then create one and cd to it.  From there, run the pacman install command:
<pre class="screen">
&gt; pacman -get %CACHE%:gums
</pre>

This installs both the GUMS server and the GUMS client. 

During the installation, you will be asked several questions about trusting the VDT caches and accepting the package licenses.

Under $VDT_LOCATION, these changes occur:
   * If mysql, tomcat v55 and/or apache aren't already installed, it/they will get installed
   * =apache/conf/httpd.conf= gets updated to include tomcat-55 installation of GUMS. 
   * There's a gums-service directory which is for tomcat-55 services provided by GUMS
   * There's a gums directory which contains the GUMS client and host scripts
   * A mysql GUMS database is created, (currently) named GUMS_1_1

If you have installed GUMS as root then you can start the services used by GUMS and configure them to start at boot time with the =vdt-control= script:

<pre class="screen">
&gt; source &lt;YOUR_VDT_LOCATION&gt;/setup.sh
&gt; vdt-control --on
</pre>

Use "off" instead of "on" to stop the services.  

If you have installed GUMS as a non-root user then you will need to start the services used by GUMS manually, even after a reboot:

<pre class="screen">
&gt; source &lt;YOUR_VDT_LOCATION&gt;/setup.sh
&gt; $VDT_LOCATION/post-install/mysql start
&gt; $VDT_LOCATION/post-install/apache start 
&gt; $VDT_LOCATION/post-install/tomcat-55 start 
</pre>

To stop each service, use "stop" instead of "start".  Make sure that the user who starts gums has read access to the http certificate and key.

Verify that you have access to your GUMS services. Go to your GUMS web interface (in a certificate-enabled browser) at =<nop>https://your-gums-server:8443/gums=. You should get a screen up. You won't be able to do anything else until you configure a GUMS administrator.

---++ Upgrade GUMS Server

Please see PacmanBestPractices.

---++ Configure GUMS server

---+++ Create a GUMS administrator
Make sure you log into your GUMS host as root.  If you have a root mysql password, you'll need it for this step.  If you don't have one, it won't be required. 

%RED%
Main.JeffPorter (12/16/08) 
   * Not clear what 1.8.0, 1.8.1, 1.8.2 is below but they refer to VDT versions. 
   * Since the addMySQLAdmin script is obsolete, recommend reversing order or now removing addMySQLAdmin altogether
%ENDCOLOR% 

Add yourself to the list of GUMS admins by running the following commands if you are using 1.8.0 or 1.8.1:
       
<pre class="screen">
&gt; <b>ssh -l root your.host </b> <em>#login as root however you like</em>
&gt; <b>source $VDT_LOCATION/setup.sh </b>
&gt; <b>$VDT_LOCATION/tomcat/v55/webapps/gums/WEB-INF/scripts/addMySQLAdmin "<replaceable>your DN</replaceable>"</b>   <em>#quotes needed due to spaces in DN string</em>
</pre>

or in 1.8.2 (where the script has been renamed and added to $PATH) run the following commands:

<pre class="screen">
&gt; <b>ssh -l root your.host </b> <em>#login as root however you like</em>
&gt; <b>source $VDT_LOCATION/setup.sh </b>
&gt; <b>gums-add-mysql-admin "<replaceable>your DN</replaceable>"</b>   <em>#quotes needed due to spaces in DN string</em>
</pre>

This will give you administrative access through your GUMS web interface.  This adds you (or the DN you provide) to the <b>admins</b> subGroup in the GUMS database.

Output of the <nop>gums-add-mysql-admin command:

<pre class="screen">
WARNING: You must have created the database before running this script!

Adding the following DN to the local database:
Certificate DN for administrator: "/DC=org/DC=doegrids/OU=People/CN=Anne Heavey 830711"

Is this correct? (Enter 'yes' to proceed)
yes

Adding the admin:
Enter the root mysql password
</pre>

If there's no password set, it will finish by itself.  Ignore the warning; the database got created during the installation.

Verify you have  administrative capabilities in GUMS by going to the web interface and clicking "Persistence Factories" as a test.  You should see a persistence factory entry.

If you get the following, you have not added yourself correctly to the <b>admins</b> group or you are using the wrong certificate in your browser:
<pre class="screen">
  Error generating grid-mapfile: You are not authorized to perform this function. Contact your gums administrator if access is needed.
</pre>   

---+++ Replace default configuration with OSG configuration

%RED%
Main.JeffPorter (12/16/08) 
   *  The osg template needs to be merged with the VDT one and the ==gums-create-config== doesn't do that. I had to do it by hand otherwise the GUMS hangs trying to connect to the wrong database.
%ENDCOLOR% 

A default barebones gums.config file is installed in =<nop>$VDT_LOCATION/tomcat/v55/webapps/gums/WEB-INF/config/gums.config=.  


Use the =gums-create-config= script to replace this default gums.config with the OSG gums.config template from http://software.grid.iu.edu/pacman/tarballs/vo-version/gums.template.  The =gums-create-config= script will be released in OSG 1.0, but 
didn't make it into OSG 0.8, so you will need to download it from https://www.racf.bnl.gov/Facility/GUMS/1.2/gums-create-config
and place into the folder =<nop>$VDT_LOCATION/tomcat/v55/webapps/gums/WEB-INF/scripts=.  Within this directory, run it by typing:

<pre class="screen">
./gums-create-config --osg-template
</pre>

---+++ Test the configuration
On your GUMS web interface at =<nop>https://your-gums-server:8443/gums=, 
    <ul><li>Click "Update VO Members" in the left pane.
             <li>Click the "Update VO Members Database" button.
   </ul>
This retrieves the members of the VOs and inserts them into the !MySql GUMS database.

Still on your GUMS web interface, 
      <ul><li>Click on "Generate Grid Mapfile".
       <li>Enter the DN of the hostname that you want to generate the grid mapfile for (e.g. <i>/DC=org/DC=doegrids/OU=Services/CN=gateway.bnl.gov</i>).</li>
    <li>Click "generate grid-mapfile."  <br>
        You should get the text of a grid-mapfile formatted output (as of this writing):
<pre class="programlisting">
#---- members of vo: osg ----#
"/DC=org/DC=doegrids/OU=People/CN=Alexis Rodriguez 233072" osg
"/DC=org/DC=doegrids/OU=People/CN=Andrew Zahn 730598" osg
"/DC=org/DC=doegrids/OU=People/CN=Craig Phillip Prescott 50911" osg
</pre></li> 
</ul>

If you get errors and need to look in log files, they're kept under <tt>$VDT_LOCATION/tomcat/v55/logs</tt>.  The first one to check is the <tt>gums-service-admin.log</tt>, and second the <tt>gums-service-developer.log</tt>.

---+++ Maintanance
You may want to add other elements to your configuration custom to your site.  For example, account mappings and user memberships may be taken from LDAP.  Or you may want to add account mappings and user memberships for individual DNs for special circumstances.  See https://www.racf.bnl.gov/Facility/GUMS/1.2/use_configuration.html for more information on configuration possibilities.

A few notes about maintenance:
   * The gums.config needs to be maintained such that it includes updated information for the VOs in the OSG you are supporting. 
   * Changes to the VOs are announced via email to the VO support centers and to the osg-sites list.
   * The most up-to-date list is available within the OSG gums configuration template at http://software.grid.iu.edu/pacman/tarballs/vo-version/gums.template.  However, note that you cannot simply cut and paste from this into a 1.2 gums configuration since it is in a 1.1 format.

---+++Other configuration options
|Logging and email notification|https://www.racf.bnl.gov/Facility/GUMS/1.2/use_logging.html|
|VOMS update frequency|https://www.racf.bnl.gov/Facility/GUMS/1.2/installation_manual.html#Frequency|

---++ Configure CE

---+++Set up CE authorization to use GUMS
Now that you have GUMS configured to perform the account authorizations, you need to effect it on the CE/gatekeeper node(s). There are 2 important aspects of this:
   * Using GUMS for authorization mappings to UNIX UID
   * Using GUMS to generate the OSG-vo-user-map map file.

Each of these is described in the [[AboutAuthorizationForCE][AboutAuthorizationForCE]] page.

---+++OSG CE authorizations
There are 3 authorization configurations involving GUMS described on the [[AboutAuthorizationForCE][AboutAuthorizationForCE]] page:
   * [[Grid3ModeAuthorization][Local]] - for the local grid-mapfile mode.
   * [[CompatibilityModeAuthorization][Compatibility]] - also uses a grid-mapfile, but aided by a GUMS server.
   * [[FullPrivilegeAuthorization][Full Privilege]] - the (role-based) extended-proxy certificate authorization mode.

---+++<nop>osg-user-vo-map file
Under both configurations, now that you are using GUMS to establish your account assigments,  you will need to use the GUMS client's "generateOsgUserVoMap" to generate the =$VDT_LOCATION/monitoring/osg-user-vo-map.txt= file which is critical to OSG accounting of the jobs on the CE/gatekeeper host.

---+++ Publishing your authorization service status (optional)
This is optional capability that allows each of the CE nodes that use your GUMS authorization service to publish, via classads, the availability/status of your authorization service.  It is only available if your CEs are operating in Full Privilege authorization mode.  This is a =GIP/CEmon= service detailed in the [[ComputeElementInstall#gumsprobe][CE Installation Guide]] section on CEMon

In addition to the configuration on each of the CE nodes, the elements named "gums-test" within =$VDT_LOCATION/tomcat/v55/webapps/gums/WEB-INF/gums.config.template= need to be included in your gums.config, if not there already.  You also need to add a userGroup with DN="/GIP-GUMS-Probe-Identity" to the gums-test userGroup (click "Manual User Group Members" on the web interface and then click the "add" button).

---+++Making GUMS compatible with PRIMA 

PRIMA 0.2 can not interface to a GUMS server that runs with a service (rather than host) certificate.  If you will be using PRIMA you need to switch the certificate used by gums:

<pre class="screen">
> <b>cd /etc/grid-security/http</b>
> <b>mv httpkey.pem httpkey.pem.sav</b>
> <b>mv httpcert.pem httpcert.pem.sav</b>
> <b>cd ..</b>
> <b>cp hostkey.pem http/httpkey.pem</b>
> <b>cp hostcert.pem http/httpcert.pem</b>
> <b>chown -R daemon:daemon http </b>
</pre>

%INCLUDE{"GumsClientInstall"}%

---++Appendix A: %CACHE% GUMS Stress Test
See  [[GumsStressTest][GUMS stress test results]]

%BR%
%COMPLETE3% %BR%
%RESPONSIBLE% Main.JayPackard - 17 Oct 2007 %BR%
%REVIEW% Main.JohnWeigand 

%META:TOPICMOVED{by="AnneHeavey" date="1192808022" from="Integration/ITB_0_7.GumsAdmins" to="Integration/ITB_0_7.InstallConfigureAndManageGUMS"}%
