%META:TOPICINFO{author="JeffPorter" date="1225325144" format="1.1" version="1.3"}%
%META:TOPICPARENT{name="ComputeElementInstall"}%
---+!! *<nop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%

%STARTINCLUDE% 
%BR%
---+ _%INCLUDEHEADING% %SPACEOUT{ "%TOPIC%" }%_
 Local Authorization (grid-mapfile) Pre-configuration steps

%EDITTHIS% 
%BR%
---++ Introduction
 The Local Authorization mode, sometimes known as "grid3" authorization mode, uses an ASCII file called a grid-mapfile to make all decisions about authorization. With this mode it is not possible to correctly implement role-based authentication for Virtual Organizations, and difficult to implement VO Groups correctly. This document provides a short guide to the steps that are necessary to perform for this mode before you run the OSG configuration utility.

In Grid3 (Local) mode, authorization is performed only via the =/etc/grid-security/grid-mapfile= on the Compute Element (CE) node. Synchronizing all the =grid-mapfiles= for multiple CE nodes needs to be done *manually* in this case.

You may prefer this configuration if:
   * You are a small site (one gatekeeper) and, 
   * You deal with a small set of fairly static VOs 
   * You are *not* supporting _role-based_ authorizations (voms proxies with extended attributes) 

The =grid-mapfile= can be maintained using the =edg-mkgridmap= cron service that is installed with the OSG CE software. A GUMS service is not used.

<font color="firebrick">Note:</font> Because you will be running =edg-mkgridmap= prior to running =configure-osg.py=, you will see a warning message about a missing =gip.attributes= file. Ignore that warning message.  

---++ Configure the list of supported VO's for your site
 During installation, a default OSG configuration file, =$VDT_LOCATION/edg/etc/edg-mkgridmap.conf=, is created providing access to all registered and approved OSG VOs VOMS servers. Review this configuration file: 
   * If the list is acceptable to you, then you're done with this step. 
   * If not, then you will need to edit the file and commenting out the line(s) for each VO you wish to disable. 

The following is a snippet of the =edg-mkgridmap.conf= file with some brief comments related to the syntax.

<pre>    __Comment lines start with "#" as in a shell script.__  #### GROUP: group URI [lcluser] #      __"# USER-VO-MAP" line has special significance in OSG:      - the 1st and 2nd tokens after this string are the subgroup and VO respectively      - it then shows the  VO administrator, VO admin email address)__ # USER-VO-MAP cdf CDF -- 1 -- Gabriele Compostella (compostella@tn.infn.it)      __1st token indicates 'group' accounts are used     2nd token (starts with "vomss:") - specifies the  web services address of this VO's VOMS service     3rd token - specifies the 'group' account assigned each member; here it is "cdf"__ group vomss://voms.cnaf.infn.it:8443/voms/cdf cdf      __Note that for Fermilab VO the support center is used__ # USER-VO-MAP fermilab FERMILAB -- 2 -- Fermilab Grid Support Center (helpdesk-admin@fnal.gov) group vomss://voms.fnal.gov:8443/voms/fermilab fermilab   :     __Some VO's may have multiple VOMS lines__ # USER-VO-MAP usatlas ATLAS -- 10 -- (usatlas-support-l@lists.bnl.gov) #group vomss://vo.racf.bnl.gov:8443/voms/atlas?/atlas/usatlas usatlas1 #group vomss://vo.racf.bnl.gov:8443/voms/atlas?/atlas/usatlas usatlas2 #group vomss://vo.racf.bnl.gov:8443/voms/atlas?/atlas/usatlas usatlas3    :  </pre>

As noted above the syntax of the =# USER-VO-MAP= line is significant for OSG accounting and monitoring to be effective. If you have not already done so, read the [[OsgSupportedVos][OSG Supported VOs]] topic *now*.

This configuration file is periodically updated by the OSG GOC and new/updated versions are issued. For this reason, it is recommended that you do not delete entries, but comment them (using =#=). This will allow you to do a comparison of your current configuration against any new OSG version more accurately and you will be more readily aware of those VOs you omitted intentionally.

Generic information can be found at the [[http://vdt.cs.wisc.edu/extras/edg-mkgridmap.conf.html][VDT edg-mkgridmap configuration file documentation page]].

---++ Setting up edg-mkgridmap for local users
 You probably want to keep some portion of your current =grid-mapfile= (at least your own entry) as locally known users so that you won't get locked out should there be a problem with a VOMS server.

You can accomplish this by adding the following directive to the end of the =edg-mkgridmap.conf= file.

<pre>#### GMF_LOCAL: gmf_local grid-mapfile-local gmf_local   /etc/grid-security/grid-mapfile-local </pre>

The local entries from this file are added to the actual =/etc/grid-security/grid-mapfile= every time the cron script is executed. A couple of key points about this file and the entry shown above:
   * In the configuration file, the location of the local grid-mapfile must contain the fully qualified path 
   * The location and name of the local file shown in above is just a recommendation. You can keep it anywhere and name it anything. 
   * The syntax of the =grid-mapfile-local= is the same as the real =grid-mapfile= 
   * Any =gmf_local= directive(s) *must* (otherwise they could get overwritten) be the last entries in the =edg-mkgridmap.conf= file. 

---++ Enable the edg-mkgridmap service

<pre>vdt-control --enable edg-mkgridmap </pre>

---++ Test the edg-mkgridmap service and configuration.
 As _root_, run: <pre>source $VDT_LOCATION/setup.(c)sh cd $VDT_LOCATION/edg/sbin ./edg-mkgridmap  --output=test.out </pre> *Note:* If this generates no output, assume complete success.

The =test.out= file contains all the gridmap entries for the supported VOs and any local gridmap entries, if specified. If you see any messages when you run the command, the members of those VOs will not appear in the =test.out= file. If you look at the files created from the above test, you will notice that the script makes a backup of your current file with a '.1' suffix. Since this was the initial running of the script, the =test.out.1= is empty.

<pre> > *ls -l test.out**    -rw-r--r--  1 root root 611236 Oct 30 13:49 test.out   -rw-r--r--  1 root root      0 Oct 30 15:03 test.out.1 </pre>

If the VO administrator has not enabled world read of the VO membership, then you must contact the VO administrator and request that your site be given access to the VOMS database. You will need to provide the Subject and Issuer Distinguished Names (DN) for your host certificate. The simplest thing to do is send email to the VO administrator requesting access and including the output of the following command (check that the path to the =hostcert.pem= is correct).
<pre> > *openssl x509 -in /etc/grid-security/hostcert.pem -subject -noout*  </pre> If you recall, the VO administrator is identified in the =# USER-VO-MAP= entry of the =edg-mkgridmap.conf= file. If you find that this is no longer the current contact for the VO, you should contact the Grid Operations Center (goc@opensciencegrid.org) for help.

---++ Create your grid-map file
 If you are satisfied with your =edg=mkgridmap.conf= file configuration, you can create your =/etc/grid-security/grid-mapfile= by running the script manually as =root= user: <pre>(YOUR_VDT_LOCATION)/edg/sbin/edg-mkgridmap </pre>

--++ WS-GRAM services sudoers file

WS-GRAM is a CE service that submits user jobs from the grid to an underlying local batch system. Users present their grid identities (user proxy) to WS-GRAM. This identity is mapped to a local user (UNIX username), for example using a gridmap-file (as explained above). Jobs are run in the batch system using this local identity. Pre-WS-GRAM and WS-GRAM use two different mechanisms to switch to the appropriate local user.

The _pre-WS_ GRAM processes run as privileged user (root) and can, therefore, change to any local unprivileged user. This mechanism, however, may present security risks: bugs in the code, which runs as root, may be exploited to gain privileged access to the machine.

To mitigate this risk, WS-GRAM processes run as an unprivileged user (either *globus* or *daemon*, depending on the local configuration). In order for these users to be able to switch to another local unprivileged user, though, the local =sudo= service must be appropriately configured. The configuration requires editing the =/etc/sudoers= file manually. *Note* This editing may be done either before or after running the OSG configuration utility.

In =$VDT_LOCATION/post-install/README=, the section _Globus-Base-WSGRAM-Server_ describes the modifications to =/etc/sudoer= necessary for the web services GRAM to function properly. To facilitate the necessary modification, the =configure-osg.py= script produces the necessary additions for the =/etc/sudoers= file and writes them into a new file =$VDT_LOCATION/monitoring/sudo-setup.txt= . The administrator should simply copy and paste the content of that file into the =/etc/sudoers= file using =visudo=.

*Note the following:*
   * You __must__ use the same authorization mode for pre-ws and web services. 
   * This must be done manually. 
   * The path defined in =/etc/sudoer= cannot be soft links. Use full paths only. Therefore, if you have your $VDT_LOCATION (e.g. /opt/local/ce-0.8/) soft linked from a generic directory (e.g. /opt/local/ce), it is the explicit path (ce-0.8) that *must* used in the =/etc/sudoers= file. If you install another version of the software into a different directory, you must change the =/etc/sudoers= to reflect the new installation since making a softlink will not work. 
   * Use the =visudo= command to modify the =/etc/sudoer= file. 
   * Beware of extra whitespace when modifying the =sudoers= file, especially at the end of a line. 

Make these changes now, keeping in mind the user under which VDT determined your container will run.

In the example (for Local/Gridmap mode) that follows, the web services user is the _daemon_ user and the real path to the VDT_LOCATION is =/usr/local/osg-ce=:
<pre>Runas_Alias GLOBUSUSERS = ALL, !root  daemon ALL=(GLOBUSUSERS)          NOPASSWD: /usr/local/osg-ce/globus/libexec/globus-gridmap-and-execute          -g /etc/grid-security/grid-mapfile          /usr/local/osg-ce/globus/libexec/globus-job-manager-script.pl *  daemon ALL=(GLOBUSUSERS)          NOPASSWD: /usr/local/osg-ce/globus/libexec/globus-gridmap-and-execute          -g /etc/grid-security/grid-mapfile          /usr/local/osg-ce/globus/libexec/globus-gram-local-proxy-tool * </pre>

---++ Known issues

---++ More information

%STOPINCLUDE% 
%BR% 
%COMPLETE1% %BR% 
%RESPONSIBLE% Main.StevenTimm - 20 May 2008 %BR% 
%REVIEW%