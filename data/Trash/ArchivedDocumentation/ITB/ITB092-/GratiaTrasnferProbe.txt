%META:TOPICINFO{author="TanyaLevshina" date="1235575521" format="1.1" version="1.3"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! *<nop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%

%STARTINCLUDE%
%BR%
---+ _%INCLUDEHEADING%  %SPACEOUT{ "%TOPIC%" }%_
The !BeStMan server is using !GridFTP server to transfer files to/from  any Posix compliant file system. Gratia !GridFTP  transfer probe generates accounting  information about the transfers  based upon the Globus !GridFTP server logs. 
This document covers the Gratia !GridFTP transfer probe configuration. It must be repeated once for every !GridFTP server in the SE.

%EDITTHIS%
%BR%

---++ Configuring Gratia transfer probe
!GridFTP  transfer probe is installed simultaneously with !BeStMan or standalone !GridFTP server. It is installed disabled. In order to see execute the following commands:

<pre class="screen">
cd &lt;VDT_LOCATION&gt;
. setup.sh
vdt-control --list
[root@fg0x1 itb_bestman]# vdt-control --list
Service            | Type   | Desired State
-------------------+--------+--------------
fetch-crl          | cron   | enable
vdt-rotate-logs    | cron   | enable
vdt-update-certs   | cron   | enable
gsiftp             | inetd  | enable
gratia-gridftp-tran| cron   | do not enable
bestman            | init   | enable
edg-mkgridmap      | cron   | do not enable
gums-host-cron     | cron   | do not enable
</pre>  

To configure !GridFTP transfer probe do the following:
<pre class="screen">
cd &lt;VDT_LOCATION&gt;
. setup.sh
$VDT_LOCATION/vdt/setup/configure_gratia  \
 --probe gridftp-transfer \
 --report-to &lt;gratia_host:gratia_port&gt; \
 --probe-cron --site-name &lt;SiteName&gt;
</pre>

Where _gratia_host_ is FQDN of Gratia collector, _gratia_port_ is Gratia Collector port and  _SiteName_ is your site name.

If you want to do additional changes in configuration, eg change location of gridftp logs or name of the Grid (default is OSG) you can edit _ProbConfig_file  located in
_$VDT_LOCATION/gratia/probe/gridftp-transfer_ directory.

---+++  Creating osg-user-vo-map

Please read  [[https://twiki.grid.iu.edu/bin/view/Integration/ITB092/OsgSupportedVos][this page]] about files that are required to accurately collect grid resource usage and metrics by VO for transfer submitted using grid proxies or where voms proxy information is not available. In order to enable this do the following:
<pre class="screen">
cd &lt;VDT_LOCATION&gt;
. setup.sh
vdt-control -enable gums-host-cron
vdt-control -on gums-host-cron
touch $VDT_LOCATION/monitoring/osg-attributes.conf
$VDT_LOCATION/gums/scripts/gums-host-cron
</pre>

---+++ Enable Gratia Transfer probe

You will now need to enable !GridFTP gratia transfer probe:
<pre class="screen">
cd &lt;VDT_LOCATION&gt;
. setup.sh
vdt-control --enable gratia-transfer-probe
</pre>

----++ Starting/Stopping Gratia transfer probe
   1. !GridFtp Gratia  probe installed on !BeStMan or !GridFTP nodes could be started together with all other services by issuing _vdt-control --on_ command. If you want to start it separately do the following:
<pre class="screen">
cd &lt;VDT_LOCATION&gt;
. setup.sh
vdt-control --on gratia-transfer-probe
</pre>
    1. !GridFtp Gratia  probe installed on !BeStMan or !GridFTP nodes could be stopped together with all other services by issuing _vdt-control --off_ command. If you want to stop it separately do the following:
<pre class="screen">
cd &lt;VDT_LOCATION&gt;
. setup.sh
vdt-control --off gratia-transfer-probe
</pre>

----++ Log files and configuration location
You could find log and configuration files related to probe at the following  location on a relevant node: 

| *Module Name* |  *Configuration files* | *Log files* | 
|!GridFTP |$VDT_LOCATION/gratia/probe/gridftp-transfer/ProbeConfig|$VDT_LOCATION/gratia/var/logs|

---++ Sanity Check

If you turned on !GridFTP Gratia transfer probes you should be able to see the accounting information by accessing your Gratia collector. Keep in mind that probe collection is executed by a cron job, so check the time
the corn job will be executed:
<pre class="screen">
crontab -l
5,15,25,35,45,55 * * * * &lt;VDT_LOCATION&gt;/gratia/probe/gridftp-transfer/gridftp-transfer_meter.cron.sh > &lt;VDT_LOCATION&gt;gratia/var/logs/gratia-probe-gridftp-transfer.log 2>&1
</pre>

To access the information, go to http://&lt;gratia_host&gt;:&lt;gratia_port&gt;/gratia-reporting/, click on "Custom SQL Query" on the right site menu frame, enter the following query into provided text box:
<pre class="screen">
select * from MasterTransferSummary where ProbeName like 'gridftp-transfer:%';
</pre>
click on "Execute Query" and you will see the total number of transfer per user. To get more detailed information you can execute the following query:
<pre class="screen">
select j.dbid, j.ResourceType ,j.LocalJobId,LocalUserId,j.CommonName,j.KeyInfoContent,j.Status,j.StartTime,j.EndTime,j.SubmitHost,m.ReportedSiteName,m.Grid, n.Value,n.StorageUnit 
from JobUsageRecord j, JobUsageRecord_Meta m, Network n  where j.dbid=m.dbid and j.dbid=n.dbid and m.ProbeName like 'gridftp-transfer:%' 
order by dbid;
</pre>

---++ Known issues

---++ More information


%STOPINCLUDE%
%BR%
%COMPLETE1% %BR%
%RESPONSIBLE% Main.TanyaLevshina - 18 Feb 2009 %BR%
%REVIEW%