%META:TOPICINFO{author="AnneHeavey" date="1178123199" format="1.1" reprev="1.3" version="1.3"}%
%LINKCSS%
---+!!<nop>OSG CE 0.6.n Installation Instructions, Install as root, use Condor, do not have an SE

This document is intended for administrators responsible for installing and configuring:%BR%
   *OSG Compute Element (CE) version 0.6.0 ff onto OSG ITB or OSG Resources*

a416 2
%TOC%
%STARTINCLUDE%

---++ Introduction
Assumptions:
   * You are installing as root.
      * Paraphrasing from the [[http://vdt.cs.wisc.edu/releases/1.6.1/installation_think.html][VDT site]]: If you install as root, the VDT's programs can be made available to all the users on your system. Additionally, the VDT will be able to configure and start some of the grid services you might be installing.  Some services can only be run if you are root. 
      * If you don't install as root, you CAN'T do these things.
   * You know how to setup and administer a cluster, if needed.  You don't?  Start with [[SiteFabricBestPractices]]. (We don't provide full documentation on this.)
   * You will use [[PacmanInfo][Pacman]] to install (more info, see [[OSGInstallationMethod][OSG Installation Method]])
   * You are installing onto a [[OperatingSystems][supported operating system]]
   * You have a Condor installation on your machine, in a different location than the OSG CE software.
   * You have thought about the configuration values needed (OSG group, resource name, server location, local storage locations, and so on).  You haven't?  See [[CESiteAdminGuide]] and [[LocalStorageConfiguration]].

This document is not meant as an all-inclusive guide to Grid computing and includes only the above-mentioned options for configuring a CE. 
   * To see updates that appear in this release of the OSG CE software stack, see [[CEReleaseChanges]].
   * If you're interested, see [[VdtReleaseNotes][VDT Release Notes]].
   * To see what's included in this OSG CE release, see [[AH_CESoftWare][CE Installed Software]]. %RED%May need to refer here again at some later stage in this doc%ENDCOLOR%
   * If you need assistance during any portion of the installation, see [[InstallationAssistance][Installation Assistance]].

%INCLUDE{"OsgConventions"}%
In this document, everything is done as =root= unless specified otherwise.

---++ Pre-installation Checklist
<!-- %INCLUDE{"AH_CEPreInstallationChecklist"}%
-->
Some items are mentioned under "Assumptions", above. First, refer there.  Next:

   * If you haven't yet installed Condor, do so now. See [[CondorBatchSystemHints]] and [[MinimalCondorHints]].  
   * Define and export the variable VDT_CONDOR_LOCATION to point to your Condor installation (i.e., the directory directly above bin, etc, lib, and so on). %BR%
<pre class="screen">
# export VDT_CONDOR_LOCATION=<i>/my/condor/location/</i>
</pre>
   * Define and export the variable VDTSETUP_CONDOR_CONFIG to point to your Condor config file (i.e., =$VDT_CONDOR_LOCATION/etc/condor_config=) %BR%
<pre class="screen">
# export VDTSETUP_CONDOR_CONFIG=$VDT_CONDOR_LOCATION/etc/condor_config
</pre>
If you have issues with things like compilers, network, firewall, time sync, DNS, and so on, see [[AH_CEPreInstallationChecklist]].
---++ Install and Setup Pacman
Choose a location for installing pacman.  It should be different from the directory in which you will install the OSG CE package.
<pre class="screen">
# cd  [install directory]
# wget http://physics.bu.edu/pacman/sample_cache/tarballs/pacman-<i>version</i>.tar.gz
</pre>
Where the pacman version appropriate for OSG 0.6.0 is 3.19. E.g.,:
<pre class="screen">
# wget http://physics.bu.edu/pacman/sample_cache/tarballs/pacman-3.19.tar.gz
</pre>
Continue with unpacking and setting up, e.g.:
<pre class="screen">
# tar --no-same-owner -xzvf pacman-3.19.tar.gz
# cd pacman-3.19
</pre>
Source the setup script there, appropriately for your shell. Now the pacman location is fixed in your $PATH (if you move the pacman directory, and you re-source this script, it won't fix the $PATH).

For examples and troubleshooting information, see [[PacmanInfo]].
Need more info? See [[PacmanInfo]].  Find pacman troubleshooting info there, too.  


---++ %RED% Ignored so far: Installing the OSG Worker Node Client Package %ENDCOLOR%

This must be installed in a location visible to jobs executing on the worker node. Refer to the 
[[WorkerNodeClient][Worker Node Client]] Guide for additional information.

%INCLUDE{"AH_CEInstallingServicesRootCondorNoSE"}%
To see what version of the OSG CE software you've installed and what services came along, run:
<pre class="screen">
# <b>source $VDT_LOCATION/setup.sh </b>
# <b>./osg-version </b>
 and
# <b>vdt-version </b>
For more info, see [[AH_CESoftWareDiscover]].

You will have to obtain at least a host certificate and possibly others.  For testing purposes later on, you'll need a personal certificate, too.  The [[AH_CEConfigurePKI]] document takes you through the process. If you already have these certificates, it tells you where to copy them and what permissions to give them.
drwxr-xr-x    2 daemon   daemon       4096 May 15 16:48 ldap

Starting and stopping services is done via the =vdt-control= script. No services are running at this point. To start them up, run:
Starting and stopping services is done via the =vdt-control= script. No services are running at this point. To start them up, go to your $VDT_LOCATION, and run:
# source setup.[c]sh
enabling cron service gratia-condor... ok
If you want to enable a service that is disabled in OSG, you must first run 
==vdt-register-service==. Here is an example using the service  <i> gris </i>:
<pre class="screen">
> <b>vdt-register-service --name <em>gris</em> --enable </b>
</pre>
after that, you can turn it on via =vdt-control=.  

More information about services is available in [[StartingServices]].

%NOTE% For sites planning to publish SRM information using their GIP, and use GUMS to do authentication, it is essential that services are started before the =configure-osg.sh= script is invoked. (You just started them.) You must also invoke the =gums-host-cron= script once manually:
Before you configure, invoke the =gums-host-cron= script once manually:
<pre class="screen">
# cd $VDT_LOCATION/gums/bin
# ./gums-host-cron
By default it runs every 6 hours. To learn how to change the timing and other info, see [[Integration/ITB_0_5/OsgCEAuthorization#Full_privilege_mode_cron_gums_ho][gums-host-cron]]. 
You will be prompted for a lot of information when you run the =$VDT_LOCATION/monitoring/configure-osg.sh= script, which is your next step.  Consult the [[AH_CESiteAdminGuide]] before running the script, and make sure you've prepared for all the questions it will ask you.

Now run the configuration, with the information at your fingertips:
<pre class="screen">
# cd $VDT_LOCATION/monitoring
# ./configure-osg.sh
</pre>
In addition, for the directories you choose to associate with storage, follow the appropriate links from [[AH_CESiteAdminGuide]] to find requirements on these directories.
Make sure you create the directories you associated with local storage (app, data, and so on), if not yet done so. Follow the appropriate links from [[AH_CESiteAdminGuide]] to find requirements on these directories. Important: set the directory permissions properly, as listed in [[LocalStorageConfiguration]].


More information on what happens during the configuration is available at [[ConfigureOSGAttributes]].

---++ Condor Batch System
If you have installed Condor as your batch queuing system (as recommended), you are required to set two environment variables so the Condor path is correctly configured. This will ensure that VDT middleware services point to appropriate locations in your external Condor installation.

If you first source the Condor setup script, it will set the variables CONDOR_LOCATION and CONDOR_CONFIG and CONDOR_ROOT.  You can use these in the following variable definitions if you like. Afterwards you will have to source the VDT setup script to reset variables. 

   * *VDTSETUP_CONDOR_LOCATION* - the location of your Condor installation  (e.g. =/opt/condor=). The Condor =bin/=, =bin=, =etc/=, =lib/=... directories should be directly under this location. E.g., 

<pre class="screen">
# export VDTSETUP_CONDOR_LOCATION=<i>/my/condor/location</i>
</pre>
This will preserve a Condor installed in the standard location.
   * *VDTSETUP_CONDOR_CONFIG* (optional): The location of your Condor configuration file (if non-standard). Default is =$VDTSETUP_CONDOR_LOCATION/etc/condor_config=.

<pre class="screen">
# cd $VDT_LOCATION
# cd $VDT_LOCATION   ###This variable won't be defined at this point; use the path name to this location
# cd $VDT_LOCATION   ###This variable isn't defined properly at this point; use the path name to this location
# source setup.[c]sh
</pre>

---++ Set up Managed Fork
To set up the Managed Fork jobmanager, run:
<pre class="screen">
# cd $VDT_LOCATION
# pacman -get ITB:ManagedFork
# pacman -get OSG:ManagedFork
Respond "y" to the question about trusting the cache. 
<!--Respond "y" to the question about trusting the cache. (this question didn't come up) -->

To set the managed fork jobmanager as the default, execute the following command.
<pre class="screen">
# $VDT_LOCATION/vdt/setup/configure_globus_gatekeeper --managed-fork y --server y
</pre>
For more information on configuring, disabling, etc., see [[ManagedFork]].


---++ Globus Configuration
Globus has been pre-configured for this installation. All you need to do is start services, and you did that above, before configurating the OSG CE software.  If you want to alter the configuration, see [[ConfiguringGlobusJobs]].
d210 1
%RED%From here on, this document is unreliable -- work is continuing %ENDCOLOR%
The earlier test case only authorized yourself as a local user.  You should now go to  [[OsgCEAuthorization][Osg CE Authorization]] document and authorize other users before performing the *OSG Registration* of your service (otherwise no one but you will be able to access it!).  You should do this before doing the rest of the monitoring configuration steps below, otherwise you may  have to repeat the steps later, particularly if your site is using GUMS.
d176 1

The GUMS-Client package was installed with OSG CE software, and you've started the =gums-host-cron= job.  Establish local accounts on the CE to match those that will be used by the GUMS service. Your local GUMS administrator can identify these for you, or you can get the list from the =osg-user-vo-map.txt= which is generated in the steps below.

Two files need to be copied to the =/etc/grid-security= directory: =prima-authz.conf= and =gsi-authz.conf=.  
<pre class="screen">
# <b>cp $VDT_LOCATION/post-install/gsi-authz.conf /etc/grid-security/. </b>
# <b>cp $VDT_LOCATION/post-install/prima-authz.conf /etc/grid-security/. </b>
</pre>
Edit the =prima-authz.conf= file, changing the <b>imsContact</b> attribute to point to your GUMS service.  By default, the installation has the log file verbosity set to 'debug'.  You may want to change this to 'info' (just comment and uncomment the lines shown).
%RED% The file editing should no longer be necessary since we set VDT_GUMS_HOST before the CE install.
Edit the =/etc/grid-security/prima-authz.conf= file, changing the <b>imsContact</b> attribute to point to your GUMS service.  By default, the installation has the log file verbosity set to 'debug'.  You may want to change this to 'info' (just comment and uncomment the lines shown).

The <i>gums.authz</i> entry is only used if you wish to use the <i>gums</i> client tool to test specific mappings from this host.  Documentation of this can be found on the [[http://grid.racf.bnl.gov/GUMS/][GUMS web site]].  This same functionality can be executed using the GUMS web UI.

<pre class="programlisting">
<em>... in this example cmssrv09 was the CE node...</em>
imsContact https://<b>cmssrv09.fnal.gov</b>:8843/gums/services/GUMSAuthorizationServicePort

# logging levels supported are debug, info, error, none
The GUMS-Client package, installed with OSG CE install, has its essential files under =$VDT_LOCATION/gums=.
#logLevel    info
</pre>

Edit the =$VDT_LOCATION/gums/etc/gums-client.properties= configuration file to point to the appropriate GUMS server:  Upon installation the file contains 2 entries both populated with the hostname of the CE node you are configuring.  In this example, cmssrv09.   
%ENDCOLOR%

<pre class="programlisting">
The <i>gums.authz</i> entry is only used if you wish to use the <i>gums</i> client tool to test specific mappings from this host.  Documentation of this can be found on the GUMS web site.  This same functionality can be executed using the GUMS web UI.

 gums.authz=https://cmssrv09:8443/gums/services/GUMSAuthorizationServicePort
---++ Authorizing Users: Operational Configuration
</pre>
---
d318 1
When  authorizing in full privilege mode, you will see the following extra entry in your =$VDT_LOCATION/globus/var/globus-gatekeeper.log= file when jobs are submitted:

<pre class="programlisting">
<verbatim>
</pre>

%NOTE% In RHEL4/SL4/Rocks 4, PRIMA requires a shared library =/usr/lib/libcom_err.so.3.0.0= which is not part of most default Redhat-like installations.  It's provided by the rpm compat-libcom_err.

</verbatim>
Instructions and configuration of WS-GRAM can be viewed [[InstallAndConfigureGlobusWebServices][here]].
%RED% First part "basics" contains commands that are only informational; go to Authorization Modes %ENDCOLOR%
For full privilege setup, all you need is:
<pre class="screen">
> cd $VDT_LOCATION
> source setup.sh
> ./vdt/setup/configure_prima_gt4 --enable \
               --gums-server YOUR_GUMS_SERVICE
</pre>
This brings up some messages; follow this doc, not those messages. %BR%
Need to do sudoers thing -- find user under which VDT has the services run: In Preinstall info, it says " if there's already a globus user, the web services container will run as globus; else as daemon.%BR%
In visudo, copy in do shift colon, then set list to check that there are no whitespaces after the slashes.%BR%
My =vdt-control --on globus-ws ...=
failed; did we forget to configure web services?%BR%
need to clone the host certs and have them owned by same owner as web services -- problem when you put in certs after ce install, which i did.
---++Monitoring Setup
John thinks certs should be in place first. %BR%
%INCLUDE{"CENodeGIP"}%
%INCLUDE{"CENodeCEMon"}%
$VDT_LOCATION/vdt/setup/configure_globus_wsgram

---++ Optional Components
---+++ !Integration.MonALISA
[[MonALISA][Integration.MonALISA]] document in this guide.
There is no extra installation or configuration to do for GIP or !CEMon. 

To learn more, see [[CESquidInstallation]].
%INCLUDE{"CESquidInstallation"}%
a340 1

---++ !Integration.MonALISA (Optional)
To configure this optional component, see the 
[[MonALISA][Integration.MonALISA]] document.
%INCLUDE{"CEFireWalls"}%
<!--  Discovery Service  To configure this optional component, see the  <a href="http://osg.ivdgl.org/twiki/bin/view/ReleaseDocumentation/Integration.DiscoveryServiceInstallation"> Discovery Service MDS)</a> document in this guide. -->
%INCLUDE{"CEInstallTroubleShooting"}%
%INCLUDE{"OSGShutdownGuide"}%
   * CEMon requires that =/etc/grid-security/grid-mapfile= exist. It can be an empty file. For more info about CEMon (about, config files, verifying that it's functional) , see [[CENodeCEMon]].

---+++crontabs
For =root= cron entries, the entry will be removed from the crontab. %RED%Which file is this?%ENDCOLOR%


<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.AnneHeavey - 08 May 2007%BR%
-- Main.JohnWeigand - 05 Oct 2006 - updated the "Activate your site" TOC entry for the new file and site-status script.<br>

%STOPINCLUDE%
%INCLUDE{"Integration.WhuReferences"}%
