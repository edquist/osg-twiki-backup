%META:TOPICINFO{author="KyleGross" date="1225985923" format="1.1" version="1.3"}%
%LINKCSS%

<!-- By default the title is the WikiWord used to create this topic !-->
<!-- if you want to modify it to something more meaningful, just replace %TOPIC% below with i.e "My Topic"!-->

---+!! Configuring the Public Key Infrastructure
%TOC%
%STARTINCLUDE%

---++ Getting Certificates
%EDITTHIS%
Read [[https://twiki.grid.iu.edu/twiki/bin/view/Documentation/CertificateWhatIs]] if you don't know about certificates.

Minimally, you will need a host certificate and private key to identify  your CE.  You may need the following additional certificates if you intend to activate certain optional components:
   * ldap certificate - for publishing the status of your Privilege authorization service (optional)
   * http certificate - for CEMon

%NOTE% For security reasons, please *DO NOT* use clones of your host certificate for these additional certificates even though it's technically possible.



---+++ Setup and maintenance of Certificate Authority connection
Configure the DOEGrids Certificate Authority (CA) to be used by default by running the utility below. 

If you are given the option "<b>choose the option which matches "1c3f2ca8 : ...</b>", 
then enter =q= at the prompts. %RED%I don't understand where this statement fits in%ENDCOLOR%

<pre class="screen">
&gt; <b>$VDT_LOCATION/vdt/setup/setup-cert-request</b>
 Reading from /g3dev/globus/TRUSTED_CA
 Using hash: 1c3f2ca8
 Setting up grid-cert-request
 Running grid-security-config...
 ......
</pre>

During the CE installation/setup, the [[http://www.cs.wisc.edu/vdt/releases/1.3.10/certificate_authorities.html][VDT's list of CAs]] was added under =$VDT_LOCATION/globus/TRUSTED_CA= as the list of authorized CAs on your system.  Also, the variable X509_CERT_DIR was set to $VDT_LOCATION/globus/TRUSTED_CA. Please review the list of authorized CAs and modify the set in $X509_CERT_DIR as needed to match your local policy.

From OSG 0.5.0/VDT-1.3.11 and greater, the daemon _edg-crl-upgrade_ has been replaced with a root cron job called _fetch-crl_ which runs daily from cron. This will refresh the CRLs from these CAs.  Some of them expire in less than 1 day and you may find it necessary to increase the frequency of the fetch-crl to be more than daily. %RED%I suppose most admins know how to do this, right?%ENDCOLOR%

%IMPORTANT%  *Change from past versions*: The OSG installation is pre-configured as of version 0.6.0 to place the CA certificates in the local =$VDT_LOCATION/globus/TRUSTED_CA= directory.  The <i>fetch-crl</i> cron job will be updating CRLs in this local directory only. If you want to maintain certificates in the (old) =/etc/grid-security/certificates= directory, you must link it to the local =TRUSTED_CA= location (symlink in either direction) and copy the CA files appropriately.

The host, ldap, http and optionally personal certificate files still go under =/etc/grid-security=.%RED%True?%ENDCOLOR%

The [[CertScripts][Certificate Scripts Package Guide]] which has been installed can assist you with choosing Certificate Authorities to trust and periodically checking that the CRLs (Certificate Revocation Lists) have not expired.

---+++ Request and Install Host Certificate
Once the OSG CE software is installed you should have the _PPDG-Cert-Scripts_ package (in =$VDT_LOCATION/cert-scripts=). The instructions below show the use of those scripts.

To authorize your resource for use, you need to get a host certificate from an appropriate Certificate Authority. 
   * Currently the [[http://www.doegrids.org][DOEGrids CA]] is the most common CA in use for OSG participants. 
   * The [[http://www.opensciencegrid.org/ra][OSG Registration Authority]] with DOEGrids handles most certificate requests for OSG participants. 

Here is a brief guide to the process assuming you have a valid User Certificate. 
 
Run the =cert-request= script  to generate your host's private key (<tt>hostkey.pem</tt>) and submit the certificate request.

<pre class="screen">
$ <b>cd $VDT_LOCATION</b>
$ <b>source  ./setup.sh</b>
$ <b>cd <i>some-work-dir</i></b>
$ <b>cert-request -ou s -dir . -label <i>my-host</i></b>
Processing OU=Services request.
Give reason (1 line) you qualify for certificate, such as
  member of CMS experiment    or
  collaborating with Condor team,  etc.
 reason: <b><i>installing gatekeeper for ZZZZZZ VO on OSG</i></b>
input server administrator's name: <b><i>Joe Admin</i></b>
input full hostname: <b><i>my-host.some.domain</i></b>
Generating a 2048 bit RSA private key
............................................+++
.......................................................................................................................................+++
writing new private key to './my-hostkey.pem'
-----
input your email address: <b><i>joe@some.domain</i></b>
input your complete phone number: <b><i>9991234567</i></b>
Choose a registration authority to which you are affiliated.
If nothing else applies, pick OSG.
_Enter__this____for this registration authority
        anl     ANL: Argonne National Lab
        esg     ESG: Earth System Grid
        esnet   ESnet: DOE Science network
        fnal    FNAL: Fermilab host and service certificates
        fusiongrid      FusionGRID: National Fusion Collaboratory Project
        lbnl    LBNL: Berkeley Lab
        lcg     LCG: LHC Computing Grid Catchall
        nersc   NERSC: computer center
        ornl    ORNL: Oak Ridge National Lab
        osg     OSG: Open Science Grid (choose this if nothing else applies)
        pnnl    PNNL: Pacific Northwest National Lab
(choose from left column): <b>osg</b>
osg
OSG
Choose a virtual organization under your OSG affiliation:
        bnl     BNL: Brookhaven lab researchers not in an OSG registered VO
        cdf     Collider Detector at Fermilab
        cms     Compact Muon Solenoid
        compbiogrid
        des     Dark Energy Survey
        dosar   Distributed Organization for Scientific and Academic Research
        dzero   D0 Experiment at Fermilab
        fermilab        Fermi National Accelerator Center
        fmri    Functional Magnetic Resonance Imaging
        gadu    Genome Analysis and Database Update
        geant4  Geant4 Software Toolkit
        glow    Grid Laboratory of Wisconsin
        gpn     Great Plains Network
        grase   Group Researching Advances in Software Engineering at UC Santa Cruz
        gridchem        Computational Chemistry Grid
        gridex  Grid Exerciser (GEx)
        grow    Grid Research and Education Group at Iowa
        gugrid  Georgetown University Grid
        i2u2    Interactions in Understanding the Universe Initiative
        ivdgl   International Virtual Data Grid Laboratory
        jlab    JLab: Jefferson Lab researchers
        ligo    Laser Interferometer Gravitational-Wave Observatory
        mariachi        Mixed Apparatus for Radar Investigation of Cosmic-rays of  High Ionization Experiment
        mis     OSG Monitoring Information System
        nanohub nanoHUB Network for Computational Nanotechnology (NCN)
        nwicg   Northwest Indiana Computational Grid
        ops     OSG Operations Group
        osg     Open Science Grid
        osgedu  OSG Education Activity
        sdss    Sloan Digital Sky Survey
        slac    SLAC: Stanford Linear Accelerator Center researchers
        star    Solenoidal Tracker at RHIC
        usatlas United States ATLAS Collaboration
(Choose from left column; pick osg if nothing else applies): <b><i>ZZZZZ</i></b>
OSG:ZZZZZ
You must agree to abide by the DOEGrids pollicies,
at
and you assert that you are authorized to request and install this
certificate on the specified host.
Do you agree (y,N): <b>y</b>

Your Certificate Request has been successfully submitted
Your Certificate Request id: <i>2394</i>

        You will receive a notification email from the CA when your certificate
        has been issued. Please disregard the instructions to download your
        certificate though a web browser and use the cert-retrieve script instead.
</pre>

%NOTE% It is possible to go on and do most of the rest of the steps in the install guide while you are waiting for your host certificate to be approved.

After the certificate is approved you will receive an email which includes the serial number of the new certificate. Use that serial number to retrieve the certificate and move it to the installation directory.

<pre class="screen">
$ <b>cert-retrieve -certnum <i>0x2e7</i> -dir . -label <i>my-host</i></b>
Checking that the usercert and ./my-hostkey.pem match
writing RSA key
./usercert.pem and ./userkey.pem now contain your Globus credential

$ <b>mv ./usercert.pem /etc/grid-security/hostcert.pem</b>
$ <b>mv ./userkey.pem /etc/grid-security/hostkey.pem</b>
$ <b>chmod 444 /etc/grid-security/hostcert.pem</b>
$ <b>chmod 400 /etc/grid-security/hostkey.pem</b>
</pre>


The following command will verify the certificate is readable.  The output shown will be similar, but specific to your request.

<pre class="screen">
$ <b>openssl x509 -text -noout -in /etc/grid-security/hostcert.pem</b>
Certificate:
  Data:
      Version: 3 (0x2)
      Serial Number: 743 (0x2e7)
      Signature Algorithm: sha1WithRSAEncryption
      Issuer: DC=org, DC=DOEGrids, OU=Certificate Authorities, CN=DOEGrids CA 1
      Validity
          Not Before: Oct 17 22:03:24 2006 GMT
          Not After : Oct 17 22:03:24 2007 GMT
      Subject: DC=org, DC=doegrids, OU=Services, CN=my-host.some.domain
      .........
</pre>
    
---+++ Get an LDAP service certificate to publish your Privilege authorization status
The capability of publishing the status of your Privilege authorization server's status is available in this release.  This is optional and you will be asked if you desire this capability when you configure your CE node using the =configure-osg.sh= script.  If you choose to publish this information, you will need an LDAP service certificate.

Follow the instructions, which are very similar to the host cert instructions, except that you are creating =ldapkey.pem= and =ldapcert.pem=.   This certificate should be should be located in the following directory with ownership and permissions as follows:

<pre class="screen">
$ <b>mkdir /etc/grid-security/ldap </b>
$ <b>mv ./usercert.pem /etc/grid-security/ldap/ldapcert.pem </b>
$ <b>mv ./userkey.pem /etc/grid-security/ldap/ldapkey.pem </b>
$ <b>chmod 444 /etc/grid-security/ldap/ldapcert.pem </b>
$ <b>chmod 400 /etc/grid-security/ldap/ldapkey.pem </b>
$ <b>chown -R daemon.daemon /etc/grid-security/ldap </b>
</pre>

---+++ Get an HTTP service certificate to activate CEMon
See the [[CEInstallGuide#CEmon][CEMon section of this guide]] for the details on activating this service.  You will need the http certificate available before you activate this service.  <i>CEMon</i> runs as a  <i>tomcat</i> service and therefore the HTTP certicate must be owned by the <i>tomcat</i> user (if you installed as <i>root</i>, the owner is probably <i>daemon</i>).

<pre class="screen">
&gt;  <b>source $VDT_LOCATION/setup.sh</b>
&gt;  <b>cert-request -ou s</b> 
                -dir . \
                -host <i>my-host.some.domain</i> \
                -service http \
                -label <i>my-host-http</i>
</pre>

Follow the instructions, which are very similar to the host cert instructions, except that you are creating =httpkey.pem= and =httpcert.pem=.  This certificate should be should be located in the following directory with ownership and permissions as follows:

<pre class="screen">
$ <b>mkdir /etc/grid-security/http </b>
$ <b>mv ./usercert.pem /etc/grid-security/http/httpcert.pem </b>
$ <b>mv ./userkey.pem /etc/grid-security/http/httpkey.pem </b>
$ <b>chmod 444 /etc/grid-security/http/httpcert.pem </b>
$ <b>chmod 400 /etc/grid-security/http/httpkey.pem </b>
$ <b>chown -R daemon.daemon /etc/grid-security/http </b>
</pre>



---+++ Getting a Personal Grid Certificate (optional)
If you do not already have a personal grid certificate, which will be needed to run the tests, then you can request one in a similar manner to the host certificate described above. You should be logged in to the user account where you will normally initiate grid actions, and the commands below will place your certificate in the globus default location ( =~/.globus= ).  You should specify OSG for the RA affiliation and also for the VirtualOrganizations/VOInfo unless you already know the more appropriate values to use.

<pre class="screen">
$ <b>source $VDT_LOCATION/setup.sh</b>
$ <b>cert-request -ou p</b>
</pre>

After you receive email notification that the certificate have been issued, then you can retrieve it with the following command, and using the serial number shown in the email notice.

<pre class="screen">
$ <b>source $VDT_LOCATION/setup.sh</b>
$ <b>cert-retrieve -certnum <i>0xYYYY</i></b>
</pre>

%STOPINCLUDE%

%BOTTOMMATTER%

<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
-- Main.RobQ - 01 May 2006 %BR%
-- Main.DougOlson - 17 Oct 2006 %BR%
-- Main.JohnWeigand - 24 Oct 2006 - added section on http certificate for CEMon%BR%
-- Main.JohnWeigand - 28 Feb 2007 - modified the section on the ldap certificate for the gums probe%BR%




-- Main.AnneHeavey - 27 Apr 2007
