%META:TOPICINFO{author="RobQ" date="1154711331" format="1.1" version="1.2"}%
%META:TOPICPARENT{name="DocumentationTable050"}%
---+!!<nop>%TOPIC%
%TOC%
%STARTINCLUDE%

d15 2
---++ Introduction

This is a minimal set of executables that need to be made available to the worker nodes in a Compute Element.

These client programs need to be available from the worker node 
so that jobs which need to access grid-enabled mass storage during
the job (e.g. via globus-url-copy, VDS, or srmcp) can do so.  The worker
node also has to have either via NFS or locally a good set of 
certificate authority files with up to date certificate revocation 
lists (CRL's) for those clients to work properly.

There are essentially three installation options:

(1) Suggested Installation:
Install the wn-client package on the file server separate from the CE that you use for $APP.
You will be installing the EDG CRL update daemon onto this node, which requires root access, and
adds a script into /etc/init.d . The daemon updates require outgoing network access from the node
it is installed on.
   1. _Suggested Installation:_ Install the wn-client package on the file server separate from the CE that you use for $APP. You will be installing the fetch-crl program onto this node, which requires root access, and adds a script into cron . The updates require outgoing network access from the node it is installed on.  (Should arrange to make it accessible from the CE as well). %BR% %BR%  
(2) CE installation:
Install the wn-client package on your CE. While we do not suggest you do this, we provide instructions, and support this installation as an option.
In all cases you need to choose a path that is common to all worker nodes and the CE. You will be prompted for this path when running the =configure-osg.sh= script on the gatekeeper in order to set the =$OSG_GRID= variable.
(3) Local Installation:
In principle, it is possible to install the wn-client package locally on all worker nodes. In practice, this introduces a number of complications due to the edg-crl updates. We include a set of instructions for this from Alan Sill, but do not support this installation variant officially via OSG operations.
---++ Known problems
In all cases you need to choose a path that is common to all worker nodes.
You will be prompted for this path when running the =configure-osg.sh= script on the gatekeeper in order to set
the =$OSG_GRID= variable.


---++ Known problems
%RED% If you answer "n" to the option to install the
CA certificate files, it will install them anyway and 
create a couple of broken symlinks.  
Also, if you answer "n" to install the edg-crl-upgraded, 
it will move any existing /etc/init.d/edg-crl-upgraded 
to edg-crl-upgraded.vdtsave and stop any existing daemons.

See below for 
suggested workaround. S. Timm 3/16/06 %ENDCOLOR%

Install with <Br>
=pacman -get OSG:wn-client=

The installation will first ask if you trust the pacman caches,
and then if you agree to the VDT licenses.  Then there is a question
about the edg-crl-upgraded daemon.

The question looks like this:
<pre>
Do you want the EDG CRL update daemon to be run automatically when
your computer starts up? If so, we will install one file,
edg-crl-updated, into etc/rc.d/init.d/.
In order to continue, you must agree to the licenses.
It will periodically update the European DataGrid (EDG) certificate
revocation lists (CRLs) It is essential if you are collaborating with
people from the EDG, and not important if you are not.

Do you want the EDG CRL update daemon to be installed? [y/n]  
</pre>
After the installation has completed, you will also be able to
For the suggested installation option, i.e. option (1) where you install this worker node client
package on the file server that serves $APP, and you have no previous installation of
the EDG CRL update daemon, you should answer "y".

If you are installing this worker node client on the OSG CE, i.e. option (2) answer "n".  

It then asks for where you would like to install the CA Files.  Question looks 
like this:
<pre>
Do you want to update the CA certification revocation lists (CRLs) automatically? [y/n] <b>y</b>

The VDT typically installs public certificates and signing policy files
for the well-known public CA's. This is necessary in order for you to
perform GSI authentication with any remote Grid services (that have
service/host certificates signed by these CA's).

For more information please refer to the VDT documentation:
http://vdt.cs.wisc.edu/setup_ca.html

Where would you like to install CA files?

            (existing CA files will be preserved)
        r (root)  - install into /etc/grid-security/certificates
                   (existing CA files will be preserved)
</pre>
<b>l</b>
Answer "l" for local.
d87 1
<pre>
If you would like, we can configure the Globus web services container 
to run automatically at boot time.

Configuring the Globus container requires changes to
- /etc/init.d (or /etc/rc.d/init.d)

Would you like to enable Globus web-services container to run automatically?
d102 1
Would you like to setup daily rotation of VDT log files?

     y: Yes. Please remove any old instances of the service and run 
Possible Answers:
     n: No. Please remove any old instances of the service, but don't 
        this one..
n
     s: Skip. Don't run the service from this installation, and if
</pre>
</pre></noautolink>
Answer "s" for skip.
The installation will first ask if you trust the pacman caches, and then if you agree to the VDT licenses.  
<pre>
Several services provided by the VDT create unbounded log files.  If you wish, we can rotate those file on a daily basis.

Would you like to setup daily rotation of VDT log files?

Possible Answers:
     y: Yes. Please remove any old instances of the service and run 
        this one..
     n: No. Please remove any old instances of the service, but don't 
        run this one.
     s: Skip. Don't run the service from this installation, and if
        there is already an instance running, leave it alone.
</pre>
For the suggested installation option, i.e. option (1) where you install this worker node client package on the file server that serves $APP, and you have no previous installation of the fetch-crl cron script, you should answer "l" for the location and "y" to run the fetch-crl cron.
Answer "s" for skip.
If you are installing this worker node client on the OSG CE, i.e. option (2) answer "l" for local location of CRL and "n" on running the cron script.

This process on many worker nodes can be automated with 
the following script so you don't have to type in the letters.
d106 2
If you are installing this worker node client on the OSG CE, i.e. option (2) answer =l= (lowercase letter L) for local location of CRL and =n= on running the cron script.

<pre>
---++Automation
This process on many worker nodes can be automated with the following script so you don't have to type in the letters.


<verbatim>
<noautolink>
<pre class="programlisting">
VDTSETUP_ENABLE_WS_CONTAINER=s
export VDTSETUP_ENABLE_WS_CONTAINER
pacman -trust-all-caches -get iVDGL:wn-client
VDTSETUP_ENABLE_ROTATE=s
</pre> 
VDTSETUP_INSTALL_CERTS=l
export VDTSETUP_INSTALL_CERTS
VDT package on any given node, you should do the following steps afterwards.
VDT package on any given node, the CE for instance, as in option 2, you should do the following steps afterwards.
Examine /etc/rc.d/init.d/edg-crl-upgraded.
Make sure that it is there, and not moved to edg-crl-upgraded.vdtsave
Make sure it is sourcing the correct location.
Make sure that it's sourcing the correct location.
pacman -trust-all-caches -get ITB:wn-client
Example: OSG CE installed in /usr/local/vdt, OSG WN Client installed 
in /usr/local/grid
Then the line in /etc/rc.d/init.d/edg-crl-upgraded should say 
=if [ -e /usr/local/vdt/setup.sh ]; then source /usr/local/vdt/setup.sh; fi=

Make sure the daemon is started.

Look at the TRUSTED_CA link.
Look at the /usr/local/grid/globus/TRUSTED_CA link.
It should point to the real area where your certificates will live,
in this example /usr/local/vdt/globus/share/certificates.
If it doesn't, change it to that location
<pre>
Look at crontab -l for root, make sure that the fetch-crl that is there is running from the correct area. Make sure that it's sourcing the correct location.
Example: If the OSG CE is installed in =/usr/local/vdt= , then the OSG WN Client is installed in =/usr/local/grid=
For example, if the OSG CE is installed in =/usr/local/vdt= , then the OSG WN Client is installed in =/usr/local/grid=

<verbatim>
d137 1
<noautolink>
d199 1
to $VDT_LOCATION/globus/share/certificates
lrwxrwxrwx  1 root root 41 Mar 16 15:44 TRUSTED_CA -> /usr/local/grid/globus/share/certificates
Note--If you are installing this package on a head node / compute 
element where an OSG CE install will also be done afterwards,
it is recommended that you log out and log back in before continuing
with the main OSG CE Install, otherwise all the wn-client
stuff will be in your path and confuse everything.
</verbatim>
Note--A side effect of the worker node client as currently configured,
is that $GLOBUS_LOCATION can and does wind up in a different location 
on the head node than it does on the worker node.  The environment
at the beginning of the job will give you $GLOBUS_LOCATION on 
the head node.  You have to source $OSG_GRID/setup.sh to get 
where $GLOBUS_LOCATION is available to you on the worker node.
To avoid this, it is required to add an appropriate 
softlink on every worker node such that $GLOBUS_LOCATION as defined on
the head node points to the place where it is located on the worker node
after the wn client installation. E.g., Resource Broker submitted 
CMS analysis jobs will presently fail without this softlink. 
d169 1
d142 1
</pre></noautolink>
   * http://software.grid.iu.edu/pacman/wn-client-0.4.1.pacman
   * http://software.grid.iu.edu/itb /wn-client-0.5.1.pacman
Also note, if Condor is involved, should also make a symlink from =/etc/grid-security/certificate= to =$VDT_LOCATION/globus/share/certificates= .
   * http://software.grid.iu.edu/itb/wn-client-0.5.1.pacman
   $ %X% *IMPORTANT* %ENDCOLOR%: If you are installing this package on a head node / compute element where an OSG CE install will also be done afterwards, it is recommended that you log out and log back in before continuing with the main OSG CE Install, otherwise all the wn-client stuff will be in your path and confuse everything.
   $ %X% *IMPORTANT* %ENDCOLOR%: A side effect of the worker node client as currently configured, is that $GLOBUS_LOCATION can and does wind up in a different location on the head node than it does on the worker node.  The environment at the beginning of the job will give you $GLOBUS_LOCATION on the head node.  You have to source $OSG_GRID/setup.sh to get where $GLOBUS_LOCATION is available to you on the worker node. %BR% %BR%   To avoid this, it is required to add an appropriate softlink on every worker node such that $GLOBUS_LOCATION as defined on the head node points to the place where it is located on the worker node after the wn client installation. E.g., CMS analysis jobs submitted via Resource Broker will presently fail without this softlink. 
   * For reference, the VDT 1.3.10 cache directory: http://vdt.cs.wisc.edu/vdt_1310_cache/.
   * For reference, the VDT 1.4.0 cache directory: http://vdt.cs.wisc.edu/vdt_140_cache/.
---++Contents
   * [[http://vdt.cs.wisc.edu/vdt_140_cache/][VDT 1.4.0 cache directory]]
   * Installation of the worker node client package does imply maintenance of the certificates that it installs.  As an alternative, it is possible to simply rsync the installed full osg installation to the worker nodes, and independently of whether this option is chosen, use rsync to keep the certificates up to date.  
   * Installation of the worker node client package does imply maintenance of the certificates that it installs.  As an alternative, it is possible to simply rsync the installed full osg installation to the worker nodes, and independently of whether this option is chosen, use rsync to keep the certificates up to date.   This is true as long as the "Worker Node Client" pacman package remains a pure subset of the OSG CE installation, which is true at the moment.
   * Doing anything automatically on the worker nodes requires care.  An example script that looks to see what worker nodes on a cluster using pbsnodes is attached to this page.  It can be edited or replaced with a more general version to match your specific cluster conditions.  Note that the example script does not use the batch system itself, but uses a feature of the local batch scheduler to avoid trying to push certificates to worker nodes that are down and to build a list of operating nodes to receive the update.  To use this script with the greatest amount of integration into existing certificate update procedures, it can be called just after the edg-fetch-crl call in the edg/sbin/edg-crl-upgrade script that should be in the edg/sbin area of your OSG VDT installation.  Example code to do so would look like:

<pre>
   * [[http://software.grid.iu.edu/pacman/][OSG cache directory]]
   * [[http://software.grid.iu.edu/itb/][ITB cache directory]]
   * [[http://vdt.cs.wisc.edu/vdt_161_cache/][VDT 1.6.1 cache directory]]

Installation of the worker node client package does imply maintenance of the certificates that it installs.  As an alternative, it is possible to simply rsync the installed full osg installation to the worker nodes, and independently of whether this option is chosen, use rsync to keep the certificates up to date.   This is true as long as the "Worker Node Client" pacman package remains a pure subset of the OSG CE installation, which is true at the moment.
need to do multiple pacman updates every time a new CA-Certificates package comes out, which 
</pre>
<verbatim>

<pre class="programlisting">
# Add section to upgrade the worker nodes:
        $VDT_LOCATION/edg/sbin/wn-cert-sync -l $CRL_UPGRADE_PATH -q
    else
</verbatim>
where the wn-cert-sync is a soft link to your particular cluster's worker node certificate synchronization script, as in the example attached. (Customize one to your cluster configuration.)

-- Main.RobGardner - 30 Nov 2005
-- Main.AlanSill - 02 Mar 2006
-- Main.FkW - 18 Mar 2006

%STOPINCLUDE%

-- Main.BurtHolzman - 29 Dec 2005
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->



-- Main.RobQ - 01 May 2006

*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.AlanSill - 02 Mar 2006   %BR%  
%INCLUDE{ "Integration.WhuReferences" }%
-- Main.BurtHolzman - 29 Dec 2005   %BR%  
-- Main.RobQ - 01 May 2006   %BR%  
-- Main.StevenTimm 21 Feb 2007 %BR%

%WHU%

%META:TOPICMOVED{by="ForrestChristian" date="1166058606" from="Integration.WorkerNodeClient050" to="Integration/ITB_0_5.WorkerNodeClient"}%
