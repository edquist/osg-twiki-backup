%META:TOPICINFO{author="KyleGross" date="1225985925" format="1.1" version="1.7"}%
%META:TOPICPARENT{name="ComputeElementInstall"}%
---+!! *<noop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%


The full privilege scenario implements the PRIMA authorization module with GUMS and does not use the grid-mapfile.  The gatekeeper uses a callout to PRIMA. Upon receipt of each request, PRIMA forwards the request to the GUMS web service which performs the dynamic mapping of the user's certrificate to a UNIX account. PRIMA can process FQAN (Fully Qualified Attribute Names), thus enabling mappings based on VirtualOrganizations/VOInfo groups and roles as defined in VirtualOrganizations/VOInfoMS.

In this configuration, requests to your gatekeeper(s) and gsiftp service(s) use the authorization callout to contact the  GUMS authorization service  which checks whether the requester is permitted access and, if access is permitted, returns a local user id assigned to the requester's grid credential. This removes the need for maintaining grid mapfiles on each gatekeeper and/or gridftp server. 

Your site must run a GUMS server in order to run in Full Privilege Mode. See [[#GUMSInstallation][GUMS installation instructions]].

---++ Full Privilege Requirements
Your site needs to install and configure GUMS service. There needs to be one GUMS server per map of 'DN to local uid'. An institution would only need one GUMS server if there is a global uid assignment (eg. a single NIS domain).  If you will have multiple account domains, you will need a GUMS server for each domain.   Each account domain can cover  any number of CE hosts, clusters storage elements (SEs)  as long as all systems have a consistent set of POSIX Users|UIDs|Groups|GIDs. 

The CE administrator needs to install and configure the GUMS Client software on the CE(s), and for each CE, identify the appropriate GUMS server to point to (if more than one is available).

You must establish local accounts on the CE to match those that will be assigned by the GUMS service.  Your local GUMS administrator can identify these for you, or you can get the list from the grid3-user-vo-map.txt which is generated in the steps below.

Globus must be configured to tell the gatekeeper to use the PRIMA authorization client.

The <i>gums-host-cron</i> must be configured (if not already done) to periodically update the =grid3-user-vo-map.txt= file.

---++Full Privilege--Configure Globus to use the PRIMA callout
The necessary configuration files are already available in the OSG CE installation in the =$VDT_LOCATION/post-install= directory:
   * =prima-authz.conf= - identifies the GUMS authorization service to use
      * _... example showing just the GUMS service line requiring modification for an install of cmssrv09. This is the identity mapping server, it performs a mapping based on the gridmap file on the service host_ %BR%   =imsContact <nop>https://cmssrv09.fnal.gov:8443/gums/services/GUMSAuthorizationServicePort=
   * =gsi-authz.conf= - tells the Globus gatekeeper and gsiftp services to use PRIMA.

%NOTE% =gsi-authz.conf= is the key to the callout being invoked.  If you remove this file (or rename it), the Globus services will revert to use of the <i>grid-mapfile</i>.

These files need to be copied to the =/etc/grid-security= directory and the =prima-authz.conf= modified to point to you GUMS service.

<pre class="screen">
 > <b>cp $VDT_LOCATION/post-install/gsi-authz.conf /etc/grid-security/. </b>
 > <b>cp $VDT_LOCATION/post-install/prima-authz.conf /etc/grid-security/. </b>
</pre>

The =prima-authz.conf= file is preconfigured during the VDT installation to your CE node host name.  Edit this file, changing the <b>imsContact</b> attribute to point to your GUMS service.  By default, the installation has the log file verbosity set to 'debug'.  You may want to change this to 'info' (just comment and uncomment the lines shown).

<pre class="programlisting">
<em>... in this example cmssrv09 was the CE node...</em>
imsContact https://<b>cmssrv09.fnal.gov</b>:8843/gums/services/GUMSAuthorizationServicePort

# logging levels supported are debug, info, error, none
logLevel    debug
#logLevel    info
</pre>


---++ Full Privilege mode -  GUMS Client software  
The GUMS-Client package is installed as part of the OSG CE install.  The essential files are located in the =$VDT_LOCATION/gums= directory.

---+++ !!Full Privilege gums-client.properties
You need to edit the =$VDT_LOCATION/gums/config/gums-client.properties= configuration file to point to the appropriate GUMS server:  Upon installation the file contains 2 entries both populated with the hostname of the CE node you are configuring.  In this example, cmssrv09.   

<pre class="programlisting">
gums.location=https://cmssrv09:8443/gums/services/GUMSAdmin
 gums.authz=https://cmssrv09:8443/gums/services/GUMSAuthorizationServicePort
</pre>

The <i>gums.authz</i> entry is only used if you wish to use the <i>gums</i> client tool to test specific mappings from this host.  Documentation of this can be found on the GUMS web site.  This same functionality can be executed using the GUMS web UI.

---+++ !!Full privilege test grid3-user-vo-map generation

To test the =grid3-user-vo-map= generation, you need to run as <i>root</i>.  This uses the host certificate.
<pre class="screen">
 > <b>source $VDT_LOCATION/setup.sh </b>
 > <b>cd $VDT_LOCATION/gums/scripts </b>
 > <b>./gums-host generateGrid3UserVoMap</b>   <em>(output goes  to stdout. To get a
                                        file: either redirect stdout or use 
                                        '--file file_name')</em>
    <em>...output  should look similar to the following dependent on you GUMS 
    server mappings..</em>
  #User-VO map
  # #comment line, format of each regular line line: account VO
  # Next 2 lines with VO names, same order, all lowercase, with case (lines starting with #voi, #VOc)
  #voi xxx test3
  #VOc OSG TEST3
  #---- accounts for vo: osg ----#
  osg01 xxx
  #---- accounts for vo: Test3userGroup ----#
  osg01account test3
    <em>.... and so on</em>
</pre>

If it fails, an error  similar to "<i>No map was found for the host xyz.dhcp.fnal.gov</i>" will occur.  Contact your GUMS administrator(s).  The problem is likely in the GUMS server's gums.config file:
   * GUMS 1.1 syntax: your host is not in the <i>cn</i> attribute of the <i>hostGroup</i> element.
   * GUMS 1.2 syntax: your host is not in the <i>cn</i> attribute of the <i>hostToGroupMapping</i> element.


---+++ !!Full privilege mode cron - gums-host-cron
See GumsHostCron.

---++ Retest Full Privilege Configuration
If there is any =/etc/grid-security/grid-mapfile=, move it to another file name. Run the [[ReleaseDocumentation.CEInstallGuide#Site_Verification][Site Verification]] script again locally (as a regular user) and verify that the authorization still works. 

To check which id you get mapped to, run (using your fully-qualified gatekeeper host in the command and your own certificate):
<pre class="screen">
 $ <b>source $VDT_LOCATION/setup.sh </b>   <em>OR $VDT_LOCATION/setup.<b>csh</b> </em>
 $ <b>grid-proxy-init </b>
    <em>(enter your passphrase)</em>
 $ <b>globus-job-run <em>your-gatekeeper-host</em>:2119/jobmanager-fork /usr/bin/id </b>
</pre>

%NOTE% Some sites may require VirtualOrganizations/VOInfo-qualified proxies.  If so, replace grid-proxy-init with voms-proxy-init in the step above.

When  authorizing in full privilege mode, you will see the following extra entry in your =$VDT_LOCATION/globus/var/globus-gatekeeper.log= file when jobs are submitted:

<pre class="programlisting">
 PID: 20269 -- PRIMA INFO  Mapping service "https://fermigrid3.fnal.gov:8443/gums/services/GUMSAuthorizationServicePort" returned local user "uscms112" for globus user "/DC=org/DC=doegrids/OU=People/CN=John Weigand 458491" 
</pre>

%NOTE% In RHEL4/SL4/Rocks 4, PRIMA requires a shared library =/usr/lib/libcom_err.so.3.0.0= which is not part of most default Redhat-like installations.  It's provided by the rpm compat-libcom_err.

---++ Enable monitoring of GUMS server
In this configuration, it is recommended to enable monitoring of the GUMS server via DBII. This requires two steps:

   1. Enable the GUMS Monitoring information provider when [[GenericInformationProvider][installing GIP on a CE Node]]. The GIP configuration script asks a direct question about this.  
   1. Ask your GUMS administrator to authorize a mapping for the information provider. This is done automatically when upgrading GUMS to v1.2 or when doing a fresh GUMS v1.2 install. In case of problem, you can look at the manual version of the steps performed to authorize the GIP probe at [[http://vdt.cs.wisc.edu/releases/1.8.1/notes/GUMS.html][VDT]].

%BR%
%COMPLETE1% %BR%
%RESPONSIBLE% Main.RobGardner - 17 Oct 2007 %BR%
%REVIEW% Main.RobGardner - 17 Oct 2007

%META:TOPICMOVED{by="AnneHeavey" date="1192818627" from="Integration/ITB_0_7.OsgCEAuthFullPriv" to="Integration/ITB_0_7.FullPrivilegeAuthorization"}%
