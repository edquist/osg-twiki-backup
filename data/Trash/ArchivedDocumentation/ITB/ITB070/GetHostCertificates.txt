%META:TOPICINFO{author="KyleGross" date="1225985925" format="1.1" version="1.44"}%
%META:TOPICPARENT{name="ComputeElementInstall"}%
---+!! *<nop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%

%STARTINCLUDE%
%BR%
---+ _%INCLUDEHEADING%  %SPACEOUT{ "%TOPIC%" }%_
%EDITTHIS%
%BR%

---++ Introduction

Background information for certificates can be found [[Documentation.CertificateWhatIs][here]].  You will need a host certificate and private key to identify your CE.  You will also need an http certificate for CEMon and anything else that runs under Apache/tomcat.

%NOTE% For security reasons, please *DO NOT* use clones of your host certificate for additional certificates even though it's technically possible.  There is one exception to this.  If you enable Globus web services, the Globus container requires  the host certificate.  Since the Globus container runs as _non_root_, the VDT configuration software will clone your host certificate as =/etc/grid-security/containercert.pem(containerkey.pem)= and will be owned by the account you configured Globus to run under (normally _globus_ or _daemon_). This is the *ONLY* exception at this time.

%NOTE% If you find the http certificate files already installed, you might want to check their end date which indicates their validity. Cd to their directory, and as root, run the =openssl= command on each of the =pem= files, e.g.,:
<pre class="screen">
# openssl x509 -in ./hostcert.pem -enddate
</pre>

---++ Install package with certificate scripts

_If you're installing the CE, it will install the scripts you need.  Skip to " Setup and maintenance of Certificate Authority connection"._  

You need to have a set of scripts in order to request and manipulate host certificates.  These scripts are described in the [[CertScripts][Certificate Scripts Package Guide]].  If you prefer, you can get these scripts ahead of time, and go ahead and request your certificates prior to the install. Both ways work.  It is also possible to request host certificates from one node from a different node on which the VDT is already installed. If you're starting fresh and you're installing something else that doesn't come with these scripts, e.g., VirtualOrganizations/VOInfoMS, etc., you'll have to install the scripts from the VDT cache.
  
Make the directory where you are going to install the package, and =cd= to it.
Find the [[http://vdt.cs.wisc.edu/documentation.html][latest VDT cache]], and download =PPDG-Cert-Scripts= from it (shown for VDT %OSG_ITB_VDT_VERSION%):

<!--Best fix would be to make PPDG-Cert-Scripts a dependency of VirtualOrganizations/VOInfoMS, VirtualOrganizations/VOInfoMRS, GUMS, etc. packages.
-->

<pre class="screen">
# pacman -get http://vdt.cs.wisc.edu/%OSG_ITB_VDT_CACHE%:PPDG-Cert-Scripts
</pre>

If installing VirtualOrganizations/VOInfoMRS, as you answer the installation questions, choose =r= to install the CA files in =/etc/grid-security=.   In ALL other cases (e.g., GUMS, VirtualOrganizations/VOInfoMS) you want to choose the =l= option.  The CE Install guide chooses this option for you.  

%NOTE% In general it is a BAD BAD IDEA to use the "r" option.

After it finishes, source the setup script. This will set $VDT_LOCATION to your installation directory.

---++ Setup and maintenance of Certificate Authority connection
Configure the DOEGrids Certificate Authority (CA) to be used by default. To do so, run the utility below.  

If you are given the option of more than one different CA in the  menu below, choose the option which matches DOEGrids, 
then enter =q= at the prompts.  If only DOEGrids is shown, then you can just enter =q= as shown in the output below.

<pre class="screen">
# <b>$VDT_LOCATION/vdt/setup/setup-cert-request</b>
 Reading from /g3dev/globus/TRUSTED_CA
 Using hash: 1c3f2ca8
 Setting up grid-cert-request
 Running grid-security-config...

Before you use the Grid Security Infrastructure, you should first
define the DN (distinguished name) that should be used for your
organization's X509 certificates.  If you do not define a DN,
a default DN will be assigned to you.

For some questions, a default response is given in [].
Pressing RETURN in response to such a question will enable the default.
This script will overwrite the file --

     /usr/local/vdt-%OSG_ITB_VDT_VERSION%/globus/etc/grid-security.conf


========================================================================

(1) Base DN for user certificates
         [ OU=People,DC=doegrids,DC=org ]
(2) Base DN for host certificates
         [ OU=Services,DC=doegrids,DC=org ]

========================================================================
(q) save, configure the GSI and Quit
(c) Cancel (exit without saving or configuring)
(h) Help
========================================================================

<b>q</b>

Successfully created cert request configuration files in:
/etc/grid-security

</pre>

During the CE installation/setup, the [[http://www.cs.wisc.edu/vdt/releases/%OSG_ITB_VDT_VERSION%/certificate_authorities.html][VDT's list of CAs]] was added under =$VDT_LOCATION/globus/TRUSTED_CA= as the list of authorized CAs on your system.  Also, the variable X509_CERT_DIR was set to $VDT_LOCATION/globus/TRUSTED_CA. Please review the list of authorized CAs and modify the set in $X509_CERT_DIR as needed to match your local policy.

From OSG 0.5.0/VDT-1.3.11 and greater, the daemon _edg-crl-upgrade_ has been replaced with a root cron job called _fetch-crl_ which runs daily from cron. This will refresh the CRLs from these CAs.  Some of them expire in less than 1 day and you may find it necessary to increase the frequency of the fetch-crl to be more than daily by manually executing crontab -e to make the frequency of the crl-update be every six hours, for instance. 

%IMPORTANT%  *Change from past versions*: The OSG installation is pre-configured as of version 0.6.0 to place the CA certificates in the local =$VDT_LOCATION/globus/TRUSTED_CA= directory.  The <i>fetch-crl</i> cron job will be updating CRLs in this local directory only. If you want to maintain certificates in the (old) =/etc/grid-security/certificates= directory, you must link it to the local =TRUSTED_CA= location (symlink in either direction) and copy the CA files appropriately.  The host and http certificate files still go under =/etc/grid-security=.

The [[CertScripts][Certificate Scripts Package Guide]] which has been installed can assist you with choosing Certificate Authorities to trust and periodically checking that the CRLs (Certificate Revocation Lists) have not expired.


---++ Request a Host Certificate

To authorize your resource for use, you need to get a host certificate from an appropriate Certificate Authority. 
   * Currently the [[http://www.doegrids.org][DOEGrids CA]] is the most common CA in use for OSG participants. 
   * The [[http://www.opensciencegrid.org/ra][OSG Registration Authority]] with DOEGrids handles most certificate requests for OSG participants. 

Here is a brief guide to the process assuming you have a valid [[UserCertificate][User Certificate]]. 
 
Run the =cert-request= script  to generate your host's private key (<tt>hostkey.pem</tt>) and submit the certificate request.
$VDT_LOCATION must point to the package in which the scripts exist, e.g., the CE install directory or where you installed PPDG-Cert-Scripts.  The =-label my-host= option is not required; but if used, use it also below when you install the cert.
<pre class="screen">
# <b>cd $VDT_LOCATION</b>
# <b>source  ./setup.sh</b>
# <b>cd vdt/setup/</b>
# <b>cert-request -ou s -dir . -label <i>my-host</i></b>
Processing OU=Services request.
Give reason (1 line) you qualify for certificate, such as
  member of CMS experiment    or
  collaborating with Condor team,  etc.
 reason: <b><i>installing gatekeeper for ZZZZZZ VO on OSG</i></b>
input server administrator's name: <b><i>Joe Admin</i></b>
input full hostname: <b><i>my-host.some.domain</i></b>
Generating a 2048 bit RSA private key
............................................+++
.......................................................................................................................................+++
writing new private key to './my-hostkey.pem'
-----
input your email address: <b><i>joe@some.domain</i></b>
input your complete phone number: <b><i>9991234567</i></b>
Choose a registration authority to which you are affiliated.
If nothing else applies, pick OSG.
_Enter__this____for this registration authority
        anl     ANL: Argonne National Lab
        esg     ESG: Earth System Grid
        esnet   ESnet: DOE Science network
<i>... and so on ...</i>
        osg     OSG: Open Science Grid <i>(choose this if nothing else applies)</i>
        pnnl    PNNL: Pacific Northwest National Lab
(choose from left column): <b>osg</b>
osg
OSG
Choose a virtual organization under your OSG affiliation:
        bnl     BNL: Brookhaven lab researchers not in an OSG registered VO
        cdf     Collider Detector at Fermilab
        cms     Compact Muon Solenoid
        compbiogrid
<i>... and so on ...</i>
(Choose from left column; pick osg if nothing else applies): <b><i>ZZZZZ</i></b>
OSG:ZZZZZ
You must agree to abide by the DOEGrids pollicies,
at
and you assert that you are authorized to request and install this
certificate on the specified host.
Do you agree (y,N): <b>y</b>

Your Certificate Request has been successfully submitted
Your Certificate Request id: <i>2394</i>

        You will receive a notification email from the CA when your certificate
        has been issued. Please disregard the instructions to download your
        certificate though a web browser and use the cert-retrieve script instead.
</pre>
The certificate request will leave a =pem= file in the directory; this will be needed when you retrieve your cert.

%NOTE% It is possible to continue with steps in the install procedure while you are waiting for your host certificate to be approved.

---++ Retrieve and Install the Host Certificate

After the certificate is approved you will receive an email which includes the serial number of the new certificate. Use that serial number to retrieve the certificate as shown below.  

From the installation directory (where your ran =cert-request= and where the new =pem= file was placed), run =cert-retrieve=.  Again, only use =-label ...= if you used it in the request.  The =-dir .= puts it in the pwd.  
<pre class="screen">
# <b>cert-retrieve -certnum <i>0x2e7</i> -dir . -label <i>my-host</i></b>
Checking that the usercert and ./my-hostkey.pem match
writing RSA key
./usercert.pem and ./userkey.pem now contain your Globus credential
</pre>
Now move the =hostcert.pem= and =hostkey.pem= files to =/etc/grid-security= and set permissions:
<pre class="screen">
# <b>mv ./usercert.pem /etc/grid-security/hostcert.pem</b>
# <b>mv ./userkey.pem /etc/grid-security/hostkey.pem</b>
# <b>chmod 444 /etc/grid-security/hostcert.pem</b>
# <b>chmod 400 /etc/grid-security/hostkey.pem</b>
</pre>


The following command will verify the certificate is readable.  The output shown will be similar, but specific to your request.

<pre class="screen">
# <b>openssl x509 -text -noout -in /etc/grid-security/hostcert.pem</b>
Certificate:
  Data:
      Version: 3 (0x2)
      Serial Number: 743 (0x2e7)
      Signature Algorithm: sha1WithRSAEncryption
      Issuer: DC=org, DC=DOEGrids, OU=Certificate Authorities, CN=DOEGrids CA 1
      Validity
          Not Before: Oct 17 22:03:24 2006 GMT
          Not After : Oct 17 22:03:24 2007 GMT
      Subject: DC=org, DC=doegrids, OU=Services, CN=my-host.some.domain
      .........
</pre>
    
<!-- Steve Timm says ldap cert no longer necessary;  AH 10/5/07

---++ Get an LDAP service certificate to publish your Privilege authorization status

The capability of publishing the status of your Privilege authorization server's status is available in this release.  This is optional and you will be asked if you desire this capability when you configure your CE node using the =configure-osg.sh= script.  If you choose to publish this information, you will need an LDAP service certificate.
%RED% There is now a way to publish your GUMS info via the GIP and not use
an LDAP certificate, in fact you can use a host cert or an http cert.  See [[http://vdt.cs.wisc.edu/releases/1.8.0/notes/GUMS.html][VDT GUMS Release Notes ]]This means that 
there is no need at all for an LDAP certificate, optional or otherwise.%ENDCOLOR%

Follow the instructions, which are very similar to the host cert instructions, except that you are creating =ldapkey.pem= and =ldapcert.pem=.   This certificate should be should be located in the following directory with ownership and permissions as follows:

<pre class="screen">
$ <b>mkdir /etc/grid-security/ldap </b>
$ <b>mv ./usercert.pem /etc/grid-security/ldap/ldapcert.pem </b>
$ <b>mv ./userkey.pem /etc/grid-security/ldap/ldapkey.pem </b>
$ <b>chmod 444 /etc/grid-security/ldap/ldapcert.pem </b>
$ <b>chmod 400 /etc/grid-security/ldap/ldapkey.pem </b>
$ <b>chown -R daemon.daemon /etc/grid-security/ldap </b>
</pre>
-->

---++ Get an HTTP service certificate to activate CEMon
See the [[CEMonOnComputeElement][CEMon section]] for the details on activating this service.  You will need the http certificate available before you activate this service.  <i>CEMon</i> runs as a  <i>tomcat</i> service and therefore the HTTP certicate must be owned by the uid under which tomcat and apache run.   (If you installed as <i>root</i>, the default user  for tomcat/apache is <i>daemon</i>).

<pre class="screen">
&gt;  <b>source $VDT_LOCATION/setup.sh</b>
&gt;  <b>cert-request -ou s</b> 
                -dir . \
                -host <i>my-host.some.domain</i> \
                -service http \
                -label <i>my-host-http</i>
</pre>

Follow the instructions, which are very similar to the host cert instructions, except that you are creating =httpkey.pem= and =httpcert.pem=.  This certificate should be should be located in the following directory with ownership and permissions as follows:

<pre class="screen">
$ <b>mkdir /etc/grid-security/http </b>
$ <b>mv ./usercert.pem /etc/grid-security/http/httpcert.pem </b>
$ <b>mv ./userkey.pem /etc/grid-security/http/httpkey.pem </b>
$ <b>chmod 444 /etc/grid-security/http/httpcert.pem </b>
$ <b>chmod 400 /etc/grid-security/http/httpkey.pem </b>
$ <b>chown -R daemon.daemon /etc/grid-security/http </b>
</pre>

%STOPINCLUDE%
%BR%
%COMPLETE2% %BR%
%RESPONSIBLE% Main.TimSilvers - 25 Oct 2007 %BR%
%REVIEW%

%META:TOPICMOVED{by="AnneHeavey" date="1192742927" from="Integration/ITB_0_7.CEConfigurePKI" to="Integration/ITB_0_7.GetHostCertificates"}%
