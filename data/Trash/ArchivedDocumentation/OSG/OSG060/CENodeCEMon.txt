%META:TOPICINFO{author="KyleGross" date="1328026174" format="1.1" version="1.22"}%
%META:TOPICPARENT{name="CEInstallGuide"}%
%LINKCSS%

---+!!<nop>CEMon Installation / Activation
%TOC%
%STARTINCLUDE%

---+++CEmon

The [[http://grid.pd.infn.it/cemon/field.php][CEMon]] (CEMonitor) service is responsible for providing information coming from the Computing Element (CE) and is being implemented as an optional component in the OSG Compute Element (CE) architecture in support of the [[ResourceSelection.WebHome][ReSS (Resource Selection Service) OSG project]].  This service is capable of collecting the CE resource information by using [[http://lfield.home.cern.ch/lfield/cgi-bin/wiki.cgi?area=gip&page=documentation][Generic Information Provider]] (GIP). GIP works with the Condor, PBS, LSF and SGE job managers. 

A properly installed and configured CEMonitor service pushes collected information in classad format to a central [[ResourceSelection.WebHome][Information Gatherer]] (IG) running on designated host (<i>osg-ress-1.fnal.gov</i>). IG advertises these classads to the [[http://www.cs.wisc.edu/condor][Condor Match Maker]] service.

In additional to the CE resource data, you can optionally have =CEMon= publish information regarding the availability/status of your authorization service.  This =only= applies to those sites operating in [[OsgCEAuthorization#FullPrivilegeMode][Full Privilege Authorization mode]].  This is described more fully in the [[#gumsprobe][a later subsection]].

<a name="gumsprobe"/a>
---++++Publishing your authorization service status (optional)
This capability only applies to those sites operating in [[OsgCEAuthorization#FullPrivilegeMode][Full Privilege Authorization mode]].  It is also optional.  When you configure your CE node using the =configure-osg.sh= script, you will be asked if you would like to publish the status of your GUMS server.  If you answer =yes= to this,  a script will be activated by =GIP= that =CEMon= will execute along with the collector script for normal resource data.  This script will send an authorization request to your GUMS server using the subject of your CE's LDAP certificate.  The success/failure of that request will result in a classad being created and reported to the <nop>ReSS service in the following form:
<pre class="programlisting">
dn: GlueServiceUniqueID=https://cmssrv08.fnal.gov:8443/gums/services/GUMSAuthorizationServicePort,Mds-vo-name=local,o=grid
objectClass: GlueTop
objectClass: GlueService
objectClass: GlueKey
objectClass: GlueSchemaVersion
GlueServiceUniqueID: https://cmssrv08.fnal.gov:8443/gums/services/GUMSAuthorizationServicePort
GlueServiceName: GUMS - Grid User Management System
GlueServiceType: GUMS
GlueServiceEndpoint: https://cmssrv08.fnal.gov:8443/gums/services/GUMSAuthorizationServicePort
GlueServiceSemantics: http://grid.racf.bnl.gov/GUMS/
GlueServiceWSDL: Not Applicable
<b>....  if available and successfully authorizing .....</b>
GlueServiceStatus: OK
GlueServiceStatusInfo: Test mapping successful: user id = GumsTestUserMappingSuccessful
<b>....  if NOT available or NOT successfully authorizing .....</b>
GlueServiceStatus: Warning
GlueServiceStatusInfo: Test mapping failed: check logs at cmssrv09.fnal.gov:/storage/local/data1/osg-ce/gums/var/log/

GlueServiceStartTime: Unavailable
GlueServiceOwner: Unavailable
GlueServiceVersion: Unavailable
</pre>

Since this authorization probe is using the identify of your CE's LDAP certificate and not a normal VO member, changes will have to made to your GUMS service for a valid authorization to occur.

---++++CEMon configuration files
The configuration of <i>CEMon</i> is done for you in the =configure_cemon= script which is automatically run when you execute the =configure-osg.sh= script

The =$VDT_LOCATION/glite/etc/glite-ce-monitor/cemonitor-config=  defines
   * the script used to collect the CE node data and the frequency at which it is run
   * the URL of the <nop>ReSS server and the frequency the data is published


<verbatim>
<service id="main-service"
         description="cemonitor service"
         sslkeyfile="/etc/grid-security/http/httpkey.pem"
         sslcertfile="/etc/grid-security/http/httpcert.pem"
         sslkeypasswd=""
         sslCAfiles="/usr/local/osg-ce/globus/TRUSTED_CA/*.0"
         >
   :
  <sensor id="sensor-osg-ce"
          name="OSG CE Sensor"
          type="OSG_CE"
          jarpath="file:/usr/local/osg-ce/glite/share/java/glite-ce-osg-ce-plugin.jar">
    <property name="executionDelay" value="300000" />
    <property name="scriptURI" value="/usr/local/osg-ce/glite/etc/glite-ce-ce-plugin/glite-ce-info" />
    <property name="not_supported_attributes" 
value="GlueSiteDescription,GlueSiteLocation,GlueSiteWeb,GlueSiteSponsor,
GlueSiteOtherInfo,GlueForeignKey,GlueChunkKey,createTimestamp,
GlueCESEBindCEUniqueID,GlueCESEBindCEAccesspoint,GlueCESEBindGroupCEUniqueID,
GlueCESEBindSEUniqueID,GlueCESEBindGroupSEUniqueID,
entryTtl,modifyTimestamp,dn,ObjectClass" />
    <property name="multiple_values_attributes" 
value="GlueSiteSponsor,GlueSiteOtherInfo,GlueServiceAccessPointURL,
GlueServiceAccessControlRule,GlueInformationServiceURL,GlueChunkKey,
GlueForeignKey,GlueCEAccessControlBaseRule,GlueClusterService,GlueHostService,
GlueHostApplicationSoftwareRunTimeEnvironment,GlueHostLocalFileSystemClient,
GlueHostRemoteFileSystemServer,GlueCESEBindGroupSEUniqueID,GlueSEHostingSL,
GlueSEAccessProtocolSupportedSecurity,GlueSLService,GlueSLLocalFileSystemClient,GlueSAAccessControlBaseRule" />
  </sensor>
  :
   <!-- Installed by the VDT -->
   <subscription id="subscription-https___osg-ress-1_fnal_gov_8443_ig_services_CEInfoCollector-OSG_CE-OLD_CLASSAD"
         monitorConsumerURL="https://osg-ress-1.fnal.gov:8443/ig/services/CEInfoCollector"
         sslprotocol="SSLv3"
         retryCount="-1">
      <topic name="OSG_CE">
         <dialect name="OLD_CLASSAD" />
      </topic>
      <policy rate="300000">
         <query queryLanguage="ClassAd"><![CDATA[GlueCEStateWaitingJobs<2]]></query>
         <action name="SendNotification" doActionWhenQueryIs="true" />
         <action name="SendExpiredNotification" doActionWhenQueryIs="false" />
      </policy>
   </subscription> 
</verbatim>

---++++Activating CEMon
The <nop>CEMon package is installed, configured and activated automatically when you run the <i>configure-osg.sh</i> script.  CEMon uses both <i>apache</i> and <i>tomcat-5</i>.  

%NOTE% _<nop>CEMon_ requires an =/etc/grid-security/grid-mapfile= to exist.  It can be an empty file, but it must exist.   The =$VDT_LOCATION/vdt/setup/configure_cemon= script checks for this and creates an empty one, if none exists.

---++++Verifying CEMon is functional
Check the <i>tomcat</i> <i>CEMon</i> log file, =$VDT_LOCATION/tomcat/v5/logs/glite-ce-monitor.log= for this entry:

<pre class="programlisting">
20 Oct 2006 13:39:58,881 org.glite.security.trustmanager.CRLFileTrustManager -
       Client CN=osg-ress-1.fnal.gov, OU=Services, DC=doegrids, DC=org accepted
</pre>

Have a little patience, however, as the publishing of the information is performed by default every 5 minutes.

Once you've started publishing to the <nop>CEMon server, you might want to verify the information.  You can do this by running:

<pre class="screen">
> <B>condor_status -pool osg-ress-1.fnal.gov -long \
      -constraint "GlueCEInfoHostName == \"<replaceable>YOUR_HOST_NAME</replaceable>\"" </b>
</pre>

%NOTE% Remember to change <em>YOUR_HOST_NAME</em> with your fully qualified hostname.  In addition, the backslashes are critical in the constraint argument.

Be prepared for a lot of output if you are successful.


---++++Trash/Troubleshooting CEMon
The first thing you will want to do is verify <em>apache</em> and  <em>tomcat</em> are running.

<pre class="screen">
> <b>ps -ef | grep apache | grep httpd</b>   
> <b>ps -ef | grep tomcat</b>
</pre>

%NOTE% The head process is normally owned by root. The child processes' user should be the owner of the http certificate.

If <i>apache/tomcat</i> are not running, restart them and re-verify.

If they are still not running after a restart, check their respective log files to a get some idea what the problem is:

   * *apache* - =$VDT_LOCATION/apache/logs= directory
   * *tomcat* - =$VDT_LOCATION/tomcat/v5/logs/catalina.out=


Then, check the <i>CEMon</i> log file, =$VDT_LOCATION/tomcat/v5/logs/glite-ce-monitor.log=, for any messages indicating a problem.

%EDITTABLE{ head="| *Message* | *Resolution* |" format="| text | text |" changerows="on" editbutton="Edit table" headerislabel="on" }%
%TABLE{ valign="top" }%
| *Message* | *Resolution* |
| =gridMapFileNotFound exception= | Since <i>CEMon</i> requires a <i>grid-mapfile</i>, create an empty =/etc/gird-security/grid-mapfile.= |
| =No files found matching /etc/grid-security/http/httpcert.pem=  %BR%%BR% <em>or</em> =Error while reading certificates or CRLs: No files found matching /etc/grid-security/http/httpcert.pem= %BR%%BR% <em>or</em> =Connection refused by the Consumer (<nop>https:&lt;The_ReSS_Server&gt;)= | If you do not have an HTTP certificate in =/etc/grid-security/http/httpcert.pem(httpkey.pem)= file or a symlink to one from that location, you will see these  messages.   The correct ownershop is critical, as well.  The http certificates are defined in the  <i>cemonitor-config.xml</i>  and <i>ce-monitor.xml</i> files of the =$VDT_LOCATION/glite/etc/glite-ce-monitor= directory. |
| =Connection refused by the Consumer= | Verify the URL in the message. Using a browser that contains a valid grid certificate,  cut and paste the url shown in the message. The following should appear if CEMon is working. %BR% =CEInfoCollector %BR% Hi there, this is an AXIS service! %BR% Perhaps there will be a form for invoking the service here...= %BR% If it does not appear correct, <i>ping</i> the hostname. |


When all else fails, contact  the DZero support person shown in the [[http://www.grid.iu.edu/osg-includes/sc.php][VO Support Center]].

%STOPINCLUDE%

%WHU%

<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->

*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.JohnWeigand - 20 Oct 2006 %BR% 



%META:TOPICMOVED{by="ForrestChristian" date="1166041027" from="Integration.CENodeCEMon050" to="Integration/ITB_0_5.CENodeCEMon"}%
