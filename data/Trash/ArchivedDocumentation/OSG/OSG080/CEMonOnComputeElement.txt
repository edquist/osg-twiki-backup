%META:TOPICINFO{author="KyleGross" date="1329928883" format="1.1" version="1.30"}%
%META:TOPICPARENT{name="ComputeElementInstall"}%
---+!! *<nop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%

%STARTINCLUDE%
%BR%

---+ _%INCLUDEHEADING%  %SPACEOUT{ "%TOPIC%" }%_
%EDITTHIS%
%BR%

---++ Introduction
The [[http://grid.pd.infn.it/cemon/field.php][CEMon]] (CEMonitor) service is responsible for providing information coming from the Computing Element (CE) and is being implemented as an component in the OSG Compute Element (CE) architecture in support of the [[ResourceSelection.WebHome][ReSS (Resource Selection Service) OSG project]].  This service is capable of collecting the CE resource information by using [[http://lfield.home.cern.ch/lfield/cgi-bin/wiki.cgi?area=gip&page=documentation][Generic Information Provider]] (GIP). GIP works with the Condor, PBS, LSF and SGE job managers. 

A properly installed and configured CEMonitor service pushes collected information in classad format to a central [[ResourceSelection.WebHome][Information Gatherer]] (IG) running on designated host (<i>osg-ress-1.fnal.gov</i>). IG advertises these classads to the [[http://www.cs.wisc.edu/condor][Condor Match Maker]] service which also runs on <i>osg-ress-1.fnal.gov</i>.  (For OSG-ITB it is osg-ress-4.fnal.gov).  CEMon also is 
configured by default to publish GIP data in "RAW" (LDIF) format to the OSG BDII at the GOC.

In addition to the CE and SE data, CEMon is configured to publish the status of your authorization service. This status is most meaningful for sites operating in [[ComputeElementAuthorization#FullPrivilegeMode][Full Privilege Authorization mode]]. As of OSG 0.8.0, configuration of CEMon, GIP, and GUMS to enable this feature is automatic and site administrators should not need to do anything. For more information or troubleshooting information see the [[http://vdt.cs.wisc.edu/releases/1.8.1/notes/GUMS.html][VDT GUMS Installation Notes]].

---++ CEMon configuration files
The configuration of <i>CEMon</i> is done for you in the =configure_cemon= script which is automatically run when you execute the =configure-osg.sh= script

The =$VDT_LOCATION/glite/etc/glite-ce-monitor/cemonitor-config=  defines
   * the script used to collect the CE node data and the frequency at which it is run
   * the URL of the <nop>ReSS server and the frequency the data is published


<verbatim>
<service id="main-service"
         description="cemonitor service"
         sslkeyfile="/etc/grid-security/http/httpkey.pem"
         sslcertfile="/etc/grid-security/http/httpcert.pem"
         sslkeypasswd=""
         sslCAfiles="/usr/local/osg-ce/globus/TRUSTED_CA/*.0"
         >
   :
  <sensor id="sensor-osg-ce"
          name="OSG CE Sensor"
          type="OSG_CE"
          jarpath="file:/usr/local/osg-ce/glite/share/java/glite-ce-osg-ce-plugin.jar">
    <property name="executionDelay" value="300000" />
    <property name="scriptURI" value="/usr/local/osg-ce/glite/etc/glite-ce-ce-plugin/glite-ce-info" />
    <property name="not_supported_attributes" 
value="GlueSiteDescription,GlueSiteLocation,GlueSiteWeb,GlueSiteSponsor,
GlueSiteOtherInfo,GlueForeignKey,GlueChunkKey,createTimestamp,
GlueCESEBindCEUniqueID,GlueCESEBindCEAccesspoint,GlueCESEBindGroupCEUniqueID,
GlueCESEBindSEUniqueID,GlueCESEBindGroupSEUniqueID,
entryTtl,modifyTimestamp,dn,ObjectClass" />
    <property name="multiple_values_attributes" 
value="GlueSiteSponsor,GlueSiteOtherInfo,GlueServiceAccessPointURL,
GlueServiceAccessControlRule,GlueInformationServiceURL,GlueChunkKey,
GlueForeignKey,GlueCEAccessControlBaseRule,GlueClusterService,GlueHostService,
GlueHostApplicationSoftwareRunTimeEnvironment,GlueHostLocalFileSystemClient,
GlueHostRemoteFileSystemServer,GlueCESEBindGroupSEUniqueID,GlueSEHostingSL,
GlueSEAccessProtocolSupportedSecurity,GlueSLService,GlueSLLocalFileSystemClient,GlueSAAccessControlBaseRule" />
  </sensor>
  :
   <!-- Installed by the VDT -->
   <subscription id="subscription-https___osg-ress-1_fnal_gov_8443_ig_services_CEInfoCollector-OSG_CE-OLD_CLASSAD"
         monitorConsumerURL="https://osg-ress-1.fnal.gov:8443/ig/services/CEInfoCollector"
         sslprotocol="SSLv3"
         retryCount="-1">
      <topic name="OSG_CE">
         <dialect name="OLD_CLASSAD" />
      </topic>
      <policy rate="300000">
         <query queryLanguage="ClassAd"><![CDATA[GlueCEStateWaitingJobs<2]]></query>
         <action name="SendNotification" doActionWhenQueryIs="true" />
         <action name="SendExpiredNotification" doActionWhenQueryIs="false" />
      </policy>
   </subscription> 
</verbatim>

---++ Activating CEMon
The <nop>CEMon package is installed, configured and activated automatically when you run the <i>configure-osg.sh</i> script.  CEMon uses both <i>apache</i> and <i>tomcat-5</i>.  

%NOTE% _<nop>CEMon_ requires an =/etc/grid-security/grid-mapfile= to exist.  It can be an empty file, but it must exist.   The =$VDT_LOCATION/vdt/setup/configure_cemon= script checks for this and creates an empty one, if none exists.

---++ Verifying CEMon is functional
Check the <i>tomcat</i> <i>CEMon</i> log file, =$VDT_LOCATION/tomcat/v5/logs/glite-ce-monitor.log= for this entry:

<pre class="programlisting">
20 Oct 2006 13:39:58,881 org.glite.security.trustmanager.CRLFileTrustManager -
       Client CN=osg-ress-1.fnal.gov, OU=Services, DC=doegrids, DC=org accepted
</pre>

Have a little patience, however, as the publishing of the information is performed by default every 5 minutes.

Once you've started publishing to the <nop>CEMon server, you might want to verify the information.  You can do this by running:

<pre class="screen">
> <B>condor_status -pool osg-ress-1.fnal.gov -long \
      -constraint "GlueCEInfoHostName == \"<replaceable>YOUR_HOST_NAME</replaceable>\"" </b>
</pre>

%NOTE% Remember to change <em>YOUR_HOST_NAME</em> with your fully qualified hostname.  In addition, the backslashes are critical in the constraint argument.

Be prepared for a lot of output if you are successful.  Firewalls have been known to block the output of this command working correctly.


---++ Troubleshooting CEMon
If you have problems with CEMon, before opening a GOC ticket, please go over the [[ResourceSelection/CEMonTroubleshootingGuide][CEMon troubleshooting guide]]. When opening a ticket, GOC will ask you to provide debugging information, as explained in the troubleshooting guide.

%STOPINCLUDE%
%BR%
%COMPLETE3% %BR%
%RESPONSIBLE% Main.GabrieleGarzoglio - 25 Oct 2007 %BR%
%REVIEW%

%META:TOPICMOVED{by="AnneHeavey" date="1192742763" from="Integration/ITB_0_7.CENodeCEMon" to="Integration/ITB_0_7.CEMonOnComputeElement"}%
