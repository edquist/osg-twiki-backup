%META:TOPICINFO{author="AnneHeavey" date="1192741798" format="1.1" version="1.4"}%
%LINKCSS%

---+!!<nop>OSG CE Authorization
%TOC%
%STARTINCLUDE%

---+ Implement Grid3 (local) Authorization on your CE
%EDITTHIS%

In Grid3 (Local) mode, authorization is performed only via the =grid-mapfile= on the Compute Element (CE) node.   Synchronizing all the <i>grid-mapfiles</i> for multiple CE nodes needs to be done *manually* in this case.  VOMS is used; GUMS is not used.

You may prefer this configuration if:
   * You are a small site (one gatekeeper) and,
   * You deal with a small set of fairly static VOs
   * You are <b>not</b> supporting <i>role-based</i> authorizations (voms proxies with extended attributes)

%NOTE% If you are supporting multiple CE nodes for your site, synchronizing all the <i>grid-mapfiles</i> across these nodes is difficult.

The grid-mapfile is either created manually on each CE node, or created using the <i>edg-mkgridmap</i> root cron entry based upon the =edg-mkgridmap.conf= configuration file in =$VDT_LOCATION/edg/etc=. Using a configuration file that identifies the VOMS servers for each VO your CE node supports, the =edg-mkgridmap= script will  pull down the VO's membership from those VOMS servers and create a new =grid-mapfile= with each invocation. This =edg-mkgridmap.conf= file is installed by the VO package which can be updated to add or update VO information. The OSG Operations sends update announcements to each support center. 


%RED% This is confusing. Is this the sequence? %ENDCOLOR%
<pre>
                                                                     VOMS servers
                                                                           |
                                                                           v
voms server info --> ops --> VO support ctr -->  edgmkgridmap.conf --> edg-mkgridmap cron entry  --> grid mapfile
</pre>


In OSG 0.4.1 and before, the =edg-mkgridmap= script ran as a system service and was installed in =/etc/init.d=. With this release, it is being installed as a <i>root</i> crontab entry.  If you are upgrading from a prior release, you must [[OSGShutdownGuide][stop the edg-mkgridmap daemon]] and delete that entry from system services.

%NOTE% =edg-mkgridmap= is not installed/configured by default.  You must enable it with the following commands (as root)
<pre class="screen">
vdt-register-service --name edg-mkgridmap --enable
vdt-control --on edg-mkgridmap
</pre>
After this is done, you will see the following entry in root's crontab.


<pre class="programlisting">
50 15,21,3,9 * * * YOUR_VDT_LOCATION/edg/sbin/edg-mkgridmap \
            >>YOUR_VDT_LOCATION/edg/log/edg-mkgridmap.log 2>&1
</pre>

---++ Preinstallation
Before you configure your CE node to use the =edg-mkgridmap= script via cron, you should:
   * verify/determine and set the list of VO's you will be supporting
   * determine/setup your CE node for use of a local gridmap file
   * test the script and verify it produces the desired results
All this is described in subsequent sections.

---+++ Configure the list of supported VOs for your site
During installation, a default OSG configuration file, =$VDT_LOCATION/edg/etc/edg-mkgridmap.conf=,  is created providing access to all registered and approved OSG VOs VOMS servers. Review this configuration file:
   * If the list is acceptable to you, then you're done with this step. 
   * If not, then you will need to edit the file and commenting out the line(s) for each VO you wish to disable.

The following is a snippet of the =edg-mkgridmap.conf= file with some brief comments related to the syntax.

<pre class="programlisting">
#### GROUP: group URI [lcluser]
#
    <b><i>Comment lines start with "#" as in a shell script. </b></i>
    <b><i>Comment line shows the VO, VO administrator, VO admin email address)</b></i>
# 1 CDF Subir Sarkar (subir.sarkar@cnaf.infn.it)
    <b><i>1st token indicates 'group' accounts are used
    2nd token (starts with "vomss:") - specifies the  web services address of this VO's VOMS service
    3rd token - specifies the 'group' account assigned each member; here it is "cdf"</b></i>
group vomss://voms.cnaf.infn.it:8443/voms/cdf cdf
    <b><i>Note that for Fermilab VO the support center is used</b></i>
# 2 FermiLab -- Fermilab Grid Support Center (helpdesk-admin@fnal.gov)
group vomss://voms.fnal.gov:8443/voms/fermilab fermilab
  :
    <b><i>Some VO's may have multiple VOMS lines</b></i>
#10a USAtlas -- (usatlas-support-l@lists.bnl.gov)
group vomss://lcg-voms.cern.ch:8443/voms/atlas/ usatlas1
group vomss://lcg-voms.cern.ch:8443/voms/atlas/?/atlas/usatlas usatlas3
group vomss://lcg-voms.cern.ch:8443/voms/atlas/ usatlas4
   : 
</pre>

This file is periodically updated by the OSG GOC and new/updated versions are issued.  For this reason, it is recommended that you do not delete entries, but comment them (using =#=).  This will allow you to do a comparison of your current configuration against any new OSG version more accurately and you will be more readily aware of those VOs you omitted intentionally.

Additional information  can be found at the [[http://vdt.cs.wisc.edu/extras/edg-mkgridmap.conf.html][VDT edg-mkgridmap configuration file documentation page]].


---+++ Set up edg-mkgridmap for local users
You probably want to keep some portion of your current grid-mapfile (at least your own entry) as locally known users so that you won't get locked out should there be a problem with a VOMS server.

You can accomplish this by adding the following directive to the end of the =edg-mkgridmap.conf= file.

<pre class="programlisting">
#### GMF_LOCAL: gmf_local grid-mapfile-local
gmf_local   /etc/grid-security/grid-mapfile-local
</pre>

The local entries from this file are added to the actual =/etc/grid-security/grid-mapfile= every time the cron script is executed.
A couple of key points about this file and the entry shown above:
   * In the configuration file, the location of the local grid-mapfile must contain the fully qualified path
   * The location and name of the local file shown in above is just a recommendation.  You can keep it anywhere and name it anything.
   * The syntax of the grid-mapfile-local is the syntax for the real =grid-mapfile=
   * Any <i>gmf_local</i> directive(s) should %RED%must? (yes, must, otherwise they could get overwritten) %ENDCOLOR% be the last entries in the =edg-mkgridmap.conf= file.


---+++ Setup and test access to each selected VOMS service
To do a "shotgun" test of them all, as <i>root</i>, run:

<pre class="screen">
# <b>source $VDT_LOCATION/setup.(c)sh </b>
# <b>cd $VDT_LOCATION/edg/sbin </b>
# <b>./edg-mkgridmap  --output=test.out</b>
</pre>

%NOTE% If this generates no output, assume complete success.

The =test.out= file contains all the gridmap entries for the supported VO's and any local gridmap entries, if specified. If you see any messages when you run the command, the members of those VO's will not appear in the =test.out= file. If you look at the files created from the above test, you will notice that the script makes a backup of your current file with a '.1' suffix.  Since this was the initial running of the script, the =test.out.1= is empty.

<pre class="screen">
 > <b>ls -l test.out* </b>
  -rw-r--r--  1 root root 611236 Oct 30 13:49 test.out
  -rw-r--r--  1 root root      0 Oct 30 15:03 test.out.1
</pre>

If the VO administrator has not enabled world read of the VO membership, then you must contact the VO administrator and request that your site be given access to the VOMS database. You will need to provide the Subject and Issuer Distinguished Names (DN) for your host certificate.  The simplest thing to do is send email to the VO administrator requesting access and including the output of the following command (check that the path to the =hostcert.pem= is correct):

<pre class="screen">
 > <b>openssl x509 -in /etc/grid-security/hostcert.pem -subject -noout </b>
</pre> 
%RED%How do you know who the VO admin is? go to support centers %ENDCOLOR%
   
---+++ Configure the CE node for use of the edg-mkgridmap script
To establish the <i>root</i> cron entry for =edg-mkgridmap=, use the following command. It will create the cron entry described above with random times:

<pre class="screen">
 > <b>cd $VDT_LOCATION </b>
 > <b>source setup.sh </b>
 > <b>vdt-register-service --name edg-mkgridmap --enable</b>
 > <b>vdt-control --on edg-mkgridmap</b>
</pre>

%NOTE% If this generates no output, assume complete success.

Verify the resulting cron entry and times.
After this is done, you will see the following entry in root's crontab.


<pre class="programlisting">
50 15,21,3,9 * * * YOUR_VDT_LOCATION/edg/sbin/edg-mkgridmap \
            >>YOUR_VDT_LOCATION/edg/log/edg-mkgridmap.log 2>&1
</pre>

---+++ Troubleshoot edg-mkgridmap
Refer to the [[EdgMkgridmapTroubleshootingGuide][edg-mkgridmap troubleshooting guide]] for any problems/errors.
 

---+++ Test  the Grid3/Local configuration
Run the [[https://twiki.grid.iu.edu/twiki/bin/view/ReleaseDocumentation/ComputeElementInstallGuide#Site_Verification][Site Verification]]
 script again locally (as a regular user, not as root) and verify that the authorization still works. 

%STOPINCLUDE%


%WHU%

<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->

---++!! Major updates
<!--Future editors should add their signatures beneath yours!-->
-- Main.DaneSkow - 11 May 2005<br>
-- Main.AnneHeavey - 24 May 2005<br>
-- Main.BurtHolzman - 04 Jan 2006<br>
-- Main.JohnWeigand - 06 Jan 2006<br>
-- Main.JohnWeigand - 13 Jan 2006<br>
-- Main.StevenTimm - 09 Mar 2006  %BR%
-- Main.ForrestChristian - 30 Jan 2007: (copyedits) %BR%
-- Main.Gabriele Garzoglio - 15 Aug 2007: (updated GUMS commands to v1.2) %BR%


