%META:TOPICINFO{author="KyleGross" date="1329928823" format="1.1" version="1.8"}%
<!-- This is the default OSG Integration template. 
Please modify it in the sections indicated to create your topic!
If you have any comments/complaints about this template, then please email me:
rwg@hep.uchicago.edu.  (Adapted from Atlas wiki template, Ed Moyse)
--> 

<!-- By default the title is the WikiWord used to create this topic !-->
<!-- if you want to modify it to something more meaningful, just replace %TOPIC% below with i.e "My Topic"!-->

---+!!<nop>OSG CE Authorization
%TOC%
%STARTINCLUDE%


---++Introduction

The Authorization system determines who can access your resources and how. A good description of the available authorization scenarios can be found on  the
<a href="http://grid.racf.bnl.gov/GUMS/guide_architecture.html#GUMS_in_the_grid_architecture">
GUMS web site</a>.  Of those discussed, OSG supports three, namely: Grid3/Local, Compatibility, and Full Privilege. All three use VOMS. Here's a brief explanation of each:

<b>Grid3 or Local !GridMap file</b><br>
Authorization is performed only via the grid-mapfile on the gatekeeper. The grid-mapfile is either created manually on each gatekeeper, or created by the edg-mkgridmap-upgraded periodically based upon the configureation file edg-mkgridmap.conf file located int $VDT_LOCATION/edg/etc. This file is installed by the VO package which can be updated to add or update VO information. The OSG Operations sends update announcements to each support center.  VOMS is used; GUMS is not used. Synchronizing all the grid-mapfiles for multiple CE nodes needs to be done manually in this case.  You may prefer this configuration if:
      <UL><LI> You are a small site (one gatekeeper) and,
                <LI>You deal with a small set of fairly static VOs
       </UL>

<b>Compatibility</b><br>
Authorization is performed via the grid-mapfile on the gatekeeper, and the
file is created by GUMS.  GUMS polls VOMS Admin periodically and creates/updates the grid-mapfile. If the site has only one GUMS server (one communication point to VOMS), centralized mapping is enabled. Given the GUMS configuration options, account pools (many accounts, one-to-one DN-to-account mapping) can be implemented as well as group accounts (many-to-one DN-to-account mapping).  You should consider this configuration if:
      <UL><LI>Your gatekeeper(s) or service must be configured using a grid-mapfile (i.e. you have tools or services that manipulate this file directly, without passing through globus)
                <LI>You'd rather approach with caution than jump right into running GUMS 24/7.
       </UL>
<b>Full Privilege</b><br>
This scenario implements the PRIMA authorization module with GUMS and does not use the grid-mapfile.  The gatekeeper uses a callout to PRIMA upon receipt of each request, PRIMA forwards the request to the GUMS web service which performs the dynamic mapping. PRIMA can process FQAN (Fully Qualified Attribute Names), thus enabling mapping based on VO groups and roles as defined in VOMS. 

The flowchart below will help you decide what kind of configuration you should set up.
<pre>
             |
             |
  --------------------------                  ----------------------
  | Is your site going to  |        YES!      | Refer to           |
  | support role-based     |----------------->| Full privilege     |
  | authorization?         |                  | configuration      |
  --------------------------                  ----------------------
             |                                           
          NO |
             |
  ------------------------------               --------------------------
  | Do you want to use account |     YES!      | Refer to compatibility |
  | pools at your site?        |-------------->| configuration          |
  ------------------------------               --------------------------
             |                                           
          NO |
             |
  ------------------------------               --------------------------
  | Would you like to use one  |     YES!      | Refer to compatibility |
  | gridmap file to control    |-------------->| configuration          |
  | all your gatekeepers?      |               --------------------------
  ------------------------------               
             |
          NO |
             |
  ----------------------- 
  | Refer to Grid3/Local|
  | configuration       |
  -----------------------
</pre>

We'll present the "how to" information in order of simplest (Grid3) to most sophisticated (full privilege) so that you can implement step-by-step and test as you go, if you like.
---++ Grid3 or Local configuration
Authorization is performed only via the grid-mapfile on the gatekeeper. The grid-mapfile is either created manually on each gatekeeper, or created by a VOMS Admin installation.  VOMS is used; GUMS is not used. Synchronizing all the grid-mapfiles for multiple CE nodes is difficult in this case.

In this configuration, you will need the EDG mkgridmap daemon running on your gatekeeper to create the grid-mapfile (discussed below). 

---+++ Setting up edg-mkgridmap for local users

You probably want to keep some portion of your current grid-mapfile (at least your own entry) as locally known users so that you won't get locked out should there be a problem with a VOMS server.

The <i>edg-mkgridmap</i> script uses a configuration file to dictate 
  its behavior. This config file is 
  <i>$VDT_LOCATION/edg/etc/edg-mkgridmap.conf</i>.

  The <i>edg-gridmapfile-upgrade</i> daemon has a similar configuration
  file: <i>$VDT_LOCATION/edg/etc/edg-gridmapfile-upgrade.conf</i>.

  One of the parameters specifies a _local_ <i>grid-mapfile</i> that
  will be added to the output of the <i>edg-mkgridmap</i> command (the set of DNs returned from all the VOMS).  You need to populate this file; it's at <i>$VDT_LOCATION/edg/etc/grid-mapfile-local</i>

Now, to create this local portion:
<OL>
<LI> Set the *GRIDMAP_LOCAL_FILE* variable in 
    <i>$VDT_LOCATION/edg/etc/edg-gridmapfile-upgrade.conf</i> as shown. <b>Warning</b>: If you put in a bad address, it won't find the file, but it fails silently.
   <pre>
      GRIDMAP_LOCAL_FILE=$VDT_LOCATION/edg/etc/grid-mapfile-local
    </pre>
</LI>
<LI>  Add this new directive to the end of the <i>$VDT_LOCATION/edg/etc/edg-mkgridmap.conf</i>  (use the actual path, not the $VDT_LOCATION variable).   If you put in a bad address, you should get an error message.
  <pre>
    gmf_local   PATH_TO_VDT_LOCATION/edg/etc/grid-mapfile-local
   </pre>
</LI>
</OL>
You should now have local <i>grid-mapfile</i> entries added to this file every time the script is executed.

---+++ Configure the list of VOs you wish to enable
The default configuration, set in the <i>$VDT_LOCATION/edg/etc/edg-mkgridmap.conf</i>  file, provides access from all registered and approved OSG VOs. If that is acceptable to you, then you're done with this step. If not, then you'll need to edit the file commenting out the line for each VO you wish to disable.

If the VO administrator has not enabled world read of the VO membership, then you must contact the VO
administrator and request that your site be given access to the VOMS database. You will need to provide
the Subject and Issuer Distinguished Names (DN) for your host certificate.  The simplest thing to do is send email
to the VO administrator requesting access and including the output of the command (check that the path to the hostcert.pem is correct for you):
<pre>
  &gt;   openssl x509 -in /etc/grid-security/hostcert.pem -subject -noout
</pre> 


---+++ Setup and test access to each selected VOMS service
To do a "shotgun" test of them all, as root, run:
<pre> 
  &gt;  source $VDT_LOCATION/setup.(c)sh
  &gt;  cd $VDT_LOCATION/edg/sbin
  &gt  ./edg-mkgridmap --verbose --output=test.out
</pre>
   
---+++Troubleshooting edg-mkgridmap
Refer to the <a href="http://info.opensciencegrid.org/bin/view/ReleaseDocumentation/EdgMkgridmapTroubleshootingGuide">edg-mkgridmap troubleshooting guide</a> for any problems/errors.
 
---+++ Configuring /etc/rc.d services for edg-mkgridmap
Since VOs are likely adding/removing members over time, you will want to update your grid-mapfile to reflect this. OSG provides  the /etc/rc scripts for this service.  The following commands will copy and start the daemon (do these as <i>root</i>). 
<pre>
   &gt; cp $VDT_LOCATION/post-install/edg-gridmapfile-upgraded /etc/init.d/.
   &gt;  /etc/init.d/edg-gridmapfile-upgraded start
</pre>
The script will run as a daemon updating the gridmap file based on the <i>GRIDMAP_UPGRADE_DELAY=1d</i> attribute in <i>VDT_LOCATION/edg/etc/edg-gridmapfile-upgrade.conf</i>.

Make sure you run <i>chkconfig --add  /etc/init.d/edg-gridmapfile-upgraded</i> so that the service will automatically start on a reboot.

---+++ Test  the Grid3/Local configuration
Run the 
<a href="http://info.opensciencegrid.org/bin/view/ReleaseDocumentation/CEInstallGuide#Site_Verification">Site Verification</a>
 script again locally (as a regular user) and verify that the authorization still works. 


---++ Compatibility configuration
Authorization is performed via the grid-mapfile on the gatekeeper, and the
file is created by GUMS.  GUMS polls VOMS Admin periodically and creates/updates the grid-mapfile. If the site has only one GUMS server (one communication point to VOMS), centralized mapping is enabled. Given the GUMS configuration options, account pools (many accounts, one-to-one DN-to-account mapping) can be implemented as well as group accounts (many-to-one DN-to-account mapping).

A couple of points to be aware of regarding this configuration relative to Full Privilege:
<UL>
<LI>You will not be able to provide role based authorization in this configuration. 
<LI>You will introduce delays since each gatekeeper will have to regenerate the map before implementing the new policy or allowing new users. 
</UL>

In the compatibility configuration, you will have:
<UL>
<LI>One GUMS server per local account domain to manage the mapping from Grid identity (DN+attributes) to local username
<LI>The GUMS client program gums-host running via cron on your gatekeeper(s) to retrieve both the forward and inverse maps (forward is DN-to-account, inverse is user-to-VO).
</UL>

---+++Compatibility Requirements
Your site needs to install and configure GUMS service. There needs to be one GUMS server per map of 'DN to local uid'. An institution would only need one GUMS server if there is a global uid assignment (eg. a single NIS domain).  If you will have multiple account domains, you will need a GUMS server for each domain.   Each account domain can cover  any number of CE hosts, clusters storage elements (SEs)  as long as all systems have a consistent set of POSIX Users|UIDs|Groups|GIDs. 

The CE administrator needs to install and configure the GUMS Client software on the CE(s), and for each CE, identify the appropriate GUMS server to point to (if more than one is available).

---+++ Compatibility mode -  GUMS Client software
The GUMS-Client package  is installed as part of the OSG CE install.  The essential files are located in the <i>$VDT_LOCATION/gums</i> directory.

---++++ gums-client.properties
You need to edit the <i>$VDT_LOCATION/gums/etc/gums-client.properties</i> configuration file to point to the appropriate GUMS server:  Upon installation the file contains 2 entries both populated with the hostname of the CE node you are configuring.  In this example, cmssrv09.  For, compatibility mode, only the <i>gums.location</i> need be changed to the hostname of your GUMS server. 
<pre>
   gums.location=https://cmssrv09:8443/gums/services/GUMSAdmin
   gums.authz=https://cmssrv09:8443/gums/services/GUMSAuthorizationServicePort
</pre>

The <i>gums.authz</i> entry is only used if you wish to use the <i>gums</i> client tool to test specific mappings from this host.  Documentation of this client is found in the Gums web site.  This same functionality can be executed using the GUMS web UI.

---++++ Testing the gums-host command
In Compatibility mode the <i>gums-host</i> command  is used to generate two essential files:
<UL>
<LI>/etc/grid-security/grid-mapfile
<LI>$VDT_LOCATION/monitoring/grid3-user-vo-map.txt  
</UL>
Execution of these commands should be set up as a cron process to keep your CE nodes current.  This is addressed later in this section of the guide under the gums-host-cron  entry. 
More complete documentation on this command is available in the offical 
<a href="http://grid.racf.bnl.gov/GUMS/guide_commands.html"> GUMS command guide</a> and 
<a href="http://grid.racf.bnl.gov/GUMS/guide_installation.html">GUMS installation guide</a>, 
near the bottom under the heading "Installing the client tools".

---+++++grid-mapfile generation
To test the <i>grid-mapfile</i> generation, you need to run as <i>root</i>.  This uses the host certificate.
<pre>
  &gt;  source $VDT_LOCATION/setup.sh
  &gt;  cd $VDT_LOCATION/gums/bin
  &gt;  ./gums-host generateGridMapfile     <b><i>(output goes  to stdout. To get a file: either redirect stdout or use '--file file_name')</i></b>
  <i>...output  should look similar to the following dependent on your GUMS server mappings..
   #---- members of vo: osg ----#
    "/DC=org/DC=doegrids/OU=People/CN=Alexis Rodriguez 233072" osg01
   "/DC=org/DC=doegrids/OU=People/CN=Andrew Zahn 730598" osg01
   "/DC=org/DC=doegrids/OU=People/CN=Craig Phillip Prescott 50911" osg01
   #---- members of vo: Test3userGroup ----#
   "/DC=org/DC=doegrids/OU=People/CN=Anne Heavey 830711" osg01account
   "/DC=org/DC=doegrids/OU=People/CN=John Weigand 458491" osg01account
    .... and so on</i>
</pre>
If it fails, an error  similar to "<i>No map was found for the host xyz.dhcp.fnal.gov</i> will occur.  Contact your GUMS administrator(s).  The
problem is likely in the GUMS server's gums.config file:
<UL>

<LI>GUMS 1.1 syntax:  your host in not in the <i>cn</i> attribute of the <i>hostGroup</i> element.
</UL>

---+++++grid3-user-vo-map  generation
To test the <i>grid3-user-vo-map</i> generation, you need to run as <i>root</i>.  This uses the host certificate.
<pre>
  &gt;  source $VDT_LOCATION/setup.sh
  &gt;  cd $VDT_LOCATION/gums/bin
  &gt;  ./gums-host generateGrid3UserVoMap   <b><i>(output goes  to stdout. To get a file: either redirect stdout or use '--file file_name')</i></b>
  <i>...output  should look similar to the following dependent on your GUMS server mappings..
  #User-VO map
  # #comment line, format of each regular line line: account VO
  # Next 2 lines with VO names, same order, all lowercase, with case (lines starting with #voi, #VOc)
  #voi xxx test3
  #VOc OSG TEST3
  #---- accounts for vo: osg ----#
  osg01 xxx
  #---- accounts for vo: Test3userGroup ----#
  osg01account test3
    .... and so on</i>
</pre>
If it fails, an error  similar to "<i>No map was found for the host xyz.dhcp.fnal.gov</i> will occur.  Contact your GUMS administrator(s).  The
problem is likely in the GUMS server's gums.config file:
<UL>
 
<LI>GUMS 1.1 syntax:  your host in not in the <i>cn</i> attribute of the <i>hostGroup</i> element.
</UL>

---++++cron file - gums-host-cron
In the Compatibility Scenario, both the <i>grid-mapfile</i> and <i>grid3-user-vo-map-txt</i> need to be updated at the same time from your GUMS server.  A cron job <i>gums-host-cron</i> has been provided in $VDT_LOCATION/gums/bin/gums-host-cron, as well as a template to insert into
/etc/cron.d in $VDT_LOCATION/post-install/gums-host-cron
<UL>
<LI>it executes the <i>gums-host</i> command  using both the <i>generateGridMapfile</i> and <i>generateGrid3UserVoMap</i> arguments
<LI>it will create a temporary copy of the files and compares them against the current copy
<LI>it only updates the CE nodes current copy if a change has occurred
</UL>
The default interval is every 6 hours. Example cron:
<pre>
  0 0,6,12,18 * * * root /storage/local/data1/osg/gums/bin/gums-host-cron
</pre>
To test the <i>gums-host-cron</i> script and to initially populate the two files for the first time using your GUMS server (as <i>root</i>):
<pre>
  &gt;  $VDT_LOCATION/gums/bin/gums-host-cron
</pre>
To implement the cron (as <i>root</i>):
<pre>
   &gt;   ln -s $VDT_LOCATION/post-install/gums-host-cron /etc/cron.d/gums-host-cron
</pre>

---+++ Retest the compatibility configuration
Run the 
<a href="http://info.opensciencegrid.org/bin/view/Integration/OSGCEInstallGuide#Site_Verification">Site Verification</a>
 script again locally (as a regular user) and verify that the authorization still works. 


---++ Full Privilege Configuration
This scenario implements the PRIMA authorization module with GUMS and does not use the grid-mapfile.  The gatekeeper uses a callout to PRIMA. Upon receipt of each request, PRIMA forwards the request to the GUMS web service which performs the dynamic mapping of the user's certrificate to a UNIX account.   PRIMA can process FQAN (Fully Qualified Attribute Names), thus enabling mappings based on VO groups and roles as defined in VOMS.

In this configuration, requests to your gatekeeper(s) and gsiftp service(s) use the authorization callout to contact the  GUMS authorization service  which checks whether the requester is permitted access and, if access is permitted, returns a local user id assigned to the requester's grid credential. This removes the need for maintaining grid mapfiles on each gatekeeper and/or gridftp server. 

---+++Full Privilege Requirements
Your site needs to install and configure GUMS service. There needs to be one GUMS server per map of 'DN to local uid'. An institution would only need one GUMS server if there is a global uid assignment (eg. a single NIS domain).  If you will have multiple account domains, you will need a GUMS server for each domain.   Each account domain can cover  any number of CE hosts, clusters storage elements (SEs)  as long as all systems have a consistent set of POSIX Users|UIDs|Groups|GIDs. 
The CE administrator needs to install and configure the GUMS Client software on the CE(s), and for each CE, identify the appropriate GUMS server to point to (if more than one is available).

You must establish local accounts on the CE to match those that will be assigned by the GUMS service.  Your local
GUMS administrator can identify these for you, or you can get the list from the grid3-user-vo-map.txt which
is generated in the steps below.

Globus must be configured to tell the gatekeeper to use the PRIMA authorization client.

The <i>gums-host-cron</i> must be configured (if not already done) to periodically update the 
<i>grid3-user-vo-map.txt</i> file.
---+++Full Privilege--Configure Globus to use the PRIMA callout
The necessary configuration files are already available in the OSG CE installation in the <i>$VDT_LOCATION/post-install</i> directory:
<UL>
<LI><b>prima-authz.conf</b> - identifies the GUMS authorization service to use
<pre>
   <i>... example showing just the GUMS service line requiring modification for an install of cmssrv09 ...</i>
    # This is the identity mapping server, it performs a mapping based on the gridmap file on the service host
   imsContact https://cmssrv09.fnal.gov:8443/gums/services/GUMSAuthorizationServicePort
</pre>
<LI><b>gsi-authz.conf</b> - tells the Globus gatekeeper and gsiftp services to use PRIMA.<br>
<b>Note</b>: This file is the key to the callout being invoked.  If you remove this file (or rename it), the Globus services will revert to use of  the <i>grid-mapfile</i>.
</UL>
These files need to be copied to the <i>/etc/grid-security</i> directory and the <i>prima-authz.conf</i> modified to point to you GUMS service.
<pre>
   &gt;  cp $VDT_LOCATION/post-install/gsi-authz.conf      /etc/grid-security/.
   &gt;  cp $VDT_LOCATION/post-install/prima-authz.conf /etc/grid-security/.
</pre>

The <i>prima-authz.conf</i> file is preconfigured during the VDT installation to your CE node host name.  Edit this file, changing the <b>imsContact</b> attribute to point to your GUMS service.  By default, the installation has the log file verbosity set to 'debug''.  You may want to change this to 'info' (just comment and uncomment the lines shown).
<pre>
   <i>... in this example cmssrv09 was the CE node...</i>
   imsContact https://<b>cmssrv09.fnal.gov</b>:8843/gums/services/GUMSAuthorizationServicePort

   # logging levels supported are debug, info, error, none
   logLevel    debug
  #logLevel    info
</pre>


---+++ Full Privilege mode -  GUMS Client software  
The GUMS-Client package is installed as part of the OSG CE install.  The essential files are located in the <i>$VDT_LOCATION/gums</i> directory.
---++++ Full Privilege gums-client.properties
You need to edit the <i>$VDT_LOCATION/gums/etc/gums-client.properties</i> configuration file to point to the appropriate GUMS server:  Upon installation the file contains 2 entries both populated with the hostname of the CE node you are configuring.  In this example, cmssrv09.   
<pre>
   gums.location=https://cmssrv09:8443/gums/services/GUMSAdmin
   gums.authz=https://cmssrv09:8443/gums/services/GUMSAuthorizationServicePort
</pre>

The <i>gums.authz</i> entry is only used if you wish to use the <i>gums</i> client tool to test specific mappings from this host.  Documentation of this can be found on the GUMS web site.  This same functionality can be executed using the GUMS web UI.

---++++Full privilege test grid3-user-vo-map generation

To test the <i>grid3-user-vo-map</i> generation, you need to run as <i>root</i>.  This uses the host certificate.
<pre>
  &gt;  source $VDT_LOCATION/setup.sh
  &gt;  cd $VDT_LOCATION/gums/bin
  &gt;  ./gums-host generateGrid3UserVoMap   <b><i>(output goes  to stdout. To get a file: either redirect stdout or use '--file file_name')</i></b>
  <i>...output  should look similar to the following dependent on you GUMS server mappings..
  #User-VO map
  # #comment line, format of each regular line line: account VO
  # Next 2 lines with VO names, same order, all lowercase, with case (lines starting with #voi, #VOc)
  #voi xxx test3
  #VOc OSG TEST3
  #---- accounts for vo: osg ----#
  osg01 xxx
  #---- accounts for vo: Test3userGroup ----#
  osg01account test3
    .... and so on</i>
</pre>
If it fails, an error  similar to "<i>No map was found for the host xyz.dhcp.fnal.gov</i> will occur.  Contact your GUMS administrator(s).  The
problem is likely in the GUMS server's gums.config file:
<UL>
<LI>GUMS 1.1 syntax:  your host is not in the <i>cn</i> attribute of the <i>hostGroup</i> element.
</UL>


---++++Full privilege mode cron - gums-host-cron
A cron job <i>gums-host-cron</i> has been provided in $VDT_LOCATION/gums/bin/gums-host-cron, as well as a template to insert into
/etc/cron.d in $VDT_LOCATION/post-install/gums-host-cron.
<ul>
<LI>The <i>gums-host-cron</i> requires no modification for Full Privilege mode.  It looks for the existence of the <i>gsi-authz.conf</i> file that activates the PRIMA callout and, if present, will not attempt a refresh of the <i>grid-mapfile</i>.
</ul>
<UL>
<LI>it executes the <i>gums-host</i> command  using both the <i>generateGridMapfile</i> and <i>generateGrid3UserVoMap</i> arguments
<LI>it will creates a temporary copy of the files and compares them against the current copy
<LI>it only updates the CE nodes current copy if a change has occured
</UL>
The default interval is every 6 hours. Example cron:
<pre>
  0 0,6,12,18 * * * root /storage/local/data1/osg/gums/bin/gums-host-cron
</pre>


---+++ Retest Full Privilege Configuration
If there is any /etc/grid-security/grid-mapfile, move it to another 
file name.
Run the 
<a href="http://info.opensciencegrid.org/bin/view/ReleaseDocumentation/CEInstallGuide#Site_Verification">Site Verification</a>
 script again locally (as a regular user) and verify that the authorization still works. 

To check which id you get mapped to, run (using your fully-qualified gatekeeper host in the command and your own certificate):
<pre>
   &gt;  source $VDT_LOCATION/setup.(c)sh
   &gt;  grid-proxy-init
    <i>....(enter your passphrase)...</i>
   &gt;  globus-job-run <b><i>your-gatekeeper-host</b></i>:2119/jobmanager-fork /usr/bin/id
</pre>
Note--some sites may require VO-qualified proxies.  If so, 
replace grid-proxy-init with voms-proxy-init in the step above.

When  authorizing in full privilege mode, you will see the following extra entry in your <i>$VDT_LOCATION/globus/var/globus-gatekeeper.log</i> file when jobs are submitted:
<pre>
 PID: 20269 -- PRIMA INFO  Mapping service "https://fermigrid3.fnal.gov:8443/gums/services/GUMSAuthorizationServicePort" returned local user "uscms112" for globus user "/DC=org/DC=doegrids/OU=People/CN=John Weigand 458491" 
</pre>

Note--in RHEL4/SL4/Rocks 4, PRIMA requires a shared library /usr/lib/libcom_err.so.3.0.0 which is not part of most default 
Redhat-like installations.  It's provided by the rpm compat-libcom_err.


<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->

*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.DaneSkow - 11 May 2005<br>
-- Main.AnneHeavey - 24 May 2005<br>
-- Main.BurtHolzman - 04 Jan 2006<br>
-- Main.JohnWeigand - 06 Jan 2006<br>
-- Main.JohnWeigand - 13 Jan 2006<br>
-- Main.StevenTimm - 09 Mar 2006<br>

%STOPINCLUDE%

