%META:TOPICINFO{author="TanyaLevshina" date="1239746410" format="1.1" reprev="1.4" version="1.4"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! *<nop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%

%STARTINCLUDE%
%BR%

<hmtl> <img src="https://twiki.grid.iu.edu/twiki/pub/Integration/ITB092/WebHome/images.jpg"/></hml>
---+ _%INCLUDEHEADING%  %SPACEOUT{ "%TOPIC%" }%_

The probes report storage related information to the central Gratia collector. There are two types of probes:
   * The dCache-transfer probe reports to Gratia the details of each file transfer into or out of a dCache file server. 
   * The dCahche-storage probe is responsible for reporting storage capacity and storage usage to the central Gratia repository. The information reported is:
      * The storage capacity and amount used for each dCache pool.
      * The storage capacity and amount used for each SRM Space reservation.

%EDITTHIS%
%BR%

---++  Gratia dCache Probes Installation
 
In order to install the latest release of Gratia dCache Probes you may do the following:
   * Install  vdt-dCache (fresh install) 
   * Upgrade existing vdt-dCache installation (full upgrade)
   * Upgrade just gratia dCache probes without upgrading vdt-dCache (partial upgrade)
   * Install gratia dCache probes on top of dCache installed from [[http://www.dcache.org][dCache site]] (installation without vdt-dcache)

---+++  Installation of Gratia dCache probes with vdt-dCache installation (fresh install)

Gratia dCache probes are part of vdt-dcache tarball and could be installed simultaneously with dCache. The whole installation procedure is described at [[http://vdt.cs.wisc.edu/extras//2.3.0/InstallingDcacheForOSG.README.html][VDT-dCache Installation].

During vdt-dCache installation you will be first running configuration script. At some point  you will be asked if you wish to install Gratia probes:
<pre class="screen">
Do you wish to use gratia probes? [y or n]:
</pre>

If you answered __y__ the following questions will be asked:
<pre class="screen">
Enter the name of the host running your local gratia repository [eg. gratia-fermi.fnal.gov:8881]: 
Enter the name of your Storage Element []:                  
Enter the name of the grid to which this SE belongs to [OSG-ITB or OSG or LOCAL ]:                    
Enter the port used for dCache Admin interface [22223]:                      
Enter the login name for dCache Admin interface [admin]:                       
Enter the name of the mail server that should be used to send emails [smtp.fnal.gov]:         
Enter the sender's name under which you would like the emails to be sent [dCacheProbe]:                   
Enter the comma separated list of email addresses to which you would like to send email or enter N if you do not want email to be sent []:  
</pre>

Your answers depend on the type of your site. In case this is a production OSG site you have to specify the following answers:
 _host running your local gratia repository_ - gratia-osg-transfer.opensciencegrid.org:8881

 _name of the grid to which this SE belongs to_ - OSG

in case if your site is a part of ITB please provide the following answers:
_host running your local gratia repository_ - gratia-osg-itb.opensciencegrid.org

_name of the grid to which this SE belongs to_ - OSG_ITB

When you proceed with vdt-dcache installation _install.sh_ script will unpack the Gratia probes on admin and srm door nodes and will modify the configuration files.
The following rpms will be installed:
   * gratia-probe-common-&lt;version&gt;.noarch.rpm
   * gratia-probe-dCache-storage-itb-&lt;version&gt;.noarch.rpm
   * gratia-probe-dCache-transfer-itb-&lt;version&gt;.noarch.rpm
   * gratia-probe-extra-libs-&lt;version&gt;.noarch.rpm
   * gratia-probe-extra-libs-arch-spec-&lt;version&gt;.&lt;arch&gt;.rpm

The gratia executables, configuration and log files will be located under _/opt/d-cache/gratia_. The configration file is called _ProbeConfig_.
To continue with the installation please go to  [[https://twiki.grid.iu.edu/bin/view/Integration/ITB092/GratiaDcacheProbes#Setting_index_on_dCache_billing][Setting index on dCache]] section.

---+++  Upgrade existing vdt-dCache installation (full upgrade)

If you already installed vdt-dcache and are in the process of upgrading it you should follow instructions provided in [[http://vdt.cs.wisc.edu/extras//2.3.0/UpgradeDcacheForOSG.html][Upgrade Procedure Document]]. 

If you had configured and enabled gratia probes during initial installation go to  [[https://twiki.grid.iu.edu/bin/view/Integration/ITB092/GratiaDcacheProbes#Setting_index_on_dCache_billing][Setting index on dCache]] section.
If you didn't enable gratia dCache probe last time you have installed dCache, please proceed to the [[https://twiki.grid.iu.edu/bin/view/Integration/ITB092/GratiaDcacheProbes#Enable_Gratia_dCache_Probes][Enable Gratiad Cache Probes]] section.


---+++  Upgrade gratia dCache probes without upgrading vdt-dCache (partial upgrade)
If you already installed vdt-dcache and just want to upgrade Gratia  dCache probes you have to do the following steps on admin and srm door nodes :
   1. download the new release (Check the right architecture, OS and postgres version):
<pre class="screen">
cd /usr/local/vdt-dcache-SL&lt;OS&gt;_&lt;ARCH&gt;-2.2.8/RPMS
wget http://vdt.cs.wisc.edu/software/dcache/gratia/1.02.1-5_post_&lt;POSTGRES_VERSION&gt;/gratia-probe-dcache-1.02.1-5.sl&lt;OS&gt;_&lt;ARCH&gt;_postgres_&lt;POSTGRES_VERSION&gt;.tar.gz
</pre>
  where sl&lt;OS&gt; could be sl4 or sl5,  &lt;ARCH&gt; should be replaced with "32" or "64", and &lt;POSTGRES_VERSION&gt; could be 8.1.4, 8.3.5 or 8.3.7, e.g: 
<pre class="screen">
wget http://vdt.cs.wisc.edu/software/dcache/gratia/1.02.1-5_post_8.3.5/gratia-probe-dcache-1.02.1-5.sl4_32_postgres_8.3.5.tar.gz
</pre>

   1. Untar file:
<pre class="screen">
tar xvfz gratia-probe-dcache-1.02.1-5.sl&lt;OS&gt;_&lt;ARCH&gt;_postgres_&lt;POSTGRES_VERSION&gt;tar.gz
</pre>

   1. Upgrade rpms:
<pre class="screen">
rpm -Uvh gratia-probe-dCache-transfer-itb-1.02.1-5.noarch.rpm
rpm -Uvh  gratia-probe-dCache-storage-itb-1.02.1-5.noarch.rpm
rpm -Uvh  gratia-probe-common-1.02.1-5.noarch.rpm
rpm -Uvh  gratia-probe-extra-libs-1.02.1-5.noarch.rpm
rpm -Uvh  gratia-probe-extra-libs-arch-spec-1.02.1-5.i386.rpm
#or
rpm -Uvh  gratia-probe-extra-libs-arch-spec-1.02.1-5.x86_64.rpm
</pre>

If you had configured and enabled gratia probes during initial installation go to  [[https://twiki.grid.iu.edu/bin/view/Integration/ITB092/GratiaDcacheProbes#Setting_index_on_dCache_billing][Setting index on dCache]] section.
If you didn't enable gratia dCache probe last time you have installed dCache, please proceed to the [[https://twiki.grid.iu.edu/bin/view/Integration/ITB092/GratiaDcacheProbes#Enable_Gratia_dCache_Probes][Enable Gratiad Cache Probes]] section.

---+++ Installing Gratia dCache probes without vdt-dcache
If want to install Gratia  dCache probes on top of "native" dCache installation you have to do the following steps on admin and srm door nodes:
   1. download the new release (Check the right architecture, OS and postgres version):
<pre class="screen">
cd /tmp
wget http://vdt.cs.wisc.edu/software/dcache/gratia/1.02.1-5_post_&lt;POSTGRES_VERSION&gt;/gratia-probe-dcache-1.02.1-5.sl&lt;OS&gt;_&lt;ARCH&gt;_postgres_&lt;POSTGRES_VERSION&gt;.tar.gz
</pre>
  where sl&lt;OS&gt; could be sl4 or sl5,  &lt;ARCH&gt; should be replaced with "32" or "64", and &lt;POSTGRES_VERSION&gt; could be 8.1.4, 8.3.5 or 8.3.7, e.g: 
<pre class="screen">
wget http://vdt.cs.wisc.edu/software/dcache/gratia/1.02.1-5_post_8.3.5/gratia-probe-dcache-1.02.1-5.sl4_32_postgres_8.3.5.tar.gz
</pre>
   1. Untar file:
<pre class="screen">
tar xvfz gratia-probe-dcache-1.02.1-5.sl&lt;OS&gt;_&lt;ARCH&gt;_postgres_&lt;POSTGRES_VERSION&gt;tar.gz
</pre>

   1. Install rpms:
<pre class="screen">
rpm -i gratia-probe-dCache-transfer-itb-1.02.1-5.noarch.rpm
rpm -i  gratia-probe-dCache-storage-itb-1.02.1-5.noarch.rpm
rpm -i  gratia-probe-common-1.02.1-5.noarch.rpm
rpm -i  gratia-probe-extra-libs-1.02.1-5.noarch.rpm
rpm -i  gratia-probe-extra-libs-arch-spec-1.02.1-5.i386.rpm
#or
rpm -i  gratia-probe-extra-libs-arch-spec-1.02.1-5.x86_64.rpm
</pre>




---++Enable Gratia dCache Probes

If you have not used vdt-dcache _install.sh_ script  to install dCache you have to modify Gratia dCache probes configuration files manually. In order to do so, you have to login on admin and srm door node and modify _ProbeConfig_ file.

On dCache admin node do the following:
<pre class="screen">
cd /opt/d-cache/gratia/probe/dCache-transfer/
edit ProbeConfig     #modify the fields:
SSLRegistrationService="&lt;GRATIA_COLLECTOR&gt;:&lt;COLLECTOR_PORT&gt;"
SiteName="&lt;SITE_NAME&gt;"
Grid="&lt;GRID_TYPE&gt;" 
OnlySendInterSiteTransfers="false"
EnableProbe="1"
DBHostName="localhost"
DBLoginName="&lt;DB_LOGIN&gt;"
DBPassword="&lt;DB_PASSWORD&gt"
DCacheServerHost="&lt;DCACHE_ADMIN_NODE&gt;"
EmailServerHost="smtp.&lt;DOMAIN&gt;"
EmailFromAddress="dCacheProbe"
EmailToList="&lt;email1@domain,email2@domain"
</pre>



On dCache srm door  node do the following:
<pre class="screen">
cd /opt/d-cache/gratia/probe/dCache-storage/
edit ProbeConfig     #modify the fields:
SSLRegistrationService="&lt;GRATIA_COLLECTOR&gt;:&lt;COLLECTOR_PORT&gt;"
SiteName="&lt;SITE_NAME&gt;"
Grid="&lt;GRID_TYPE&gt;" 
OnlySendInterSiteTransfers="false"
EnableProbe="1"
DBHostName="localhost"
DBLoginName="&lt;DB_LOGIN&gt;"
DBPassword="&lt;DB_PASSWORD&gt"
DCacheServerHost="&lt;DCACHE_ADMIN_NODE&gt;"
AdminSvrPort="&lt;ADMIN&gt;"
AdminSvrLogin="&lt;ADMIN_LOGIN&gt;"
AdminSvrPassword="&lt;ADMIN_PASSWORD&gt;"
</pre>

Where

---++ Setting index on dCache billing database

If you already set index on your billing database skip this section. Index shoud be set on the datestamp and transaction fields, otherwise the probe will put significant load on your DB! 

In order to set index you have to log in to the billing DB using the following command:
<pre class="screen">
psql -U postgres billing
\d doorinfo
\d billinginfo
# If you don't see an index, execute the following commands:

create unique index transaction on doorinfo(transaction);
create index dates_di on doorinfo(datestamp);
create index initiator on billinginfo(initiator);
create index dates on billinginfo(datestamp);
</pre>
 
The above commands may take awhile before they finish, especially if your billing database is large.

---++ Creating  OSG User-VO Mapping 

Please read  [[https://twiki.grid.iu.edu/bin/view/Integration/ITB092/OsgSupportedVos][this page]] about files that are required to accurately collect grid resource usage and metrics by VO for transfer submitted using grid proxies or where voms proxy information is not available. 

You will have to install VO-Map-Utilities from VDT. In order to so you will need first to download and install pacman:
<pre class="screen">
#get pacman 
wget http://physics.bu.edu/pacman/sample_cache/tarballs/pacman-3.26.tar.gz
# Install pacman
tar xzf pacman-3.26.tar.gz
cd pacman-3.26
. setup.sh
</pre>


Then you have to decide if you are going to use gridmap-file or GUMS for user-vo mapping and answer appropriately questions asked during package installation:

In order to enable generation of osg-user-vo-map from GUMS  you will have to install several packages from VDT and OSG cache. 
<pre class="screen">
#create an installation directory
mkdir &lt;VDT_LOCATION&gt;
cd &lt;VDT_LOCATION&gt;
export VDT_GUMS_HOST=&lt;GUMS hostname&gt;   #if you are using GUMS
pacman -get  %CACHE%:VO-Map-Utilities
. setup.sh
#edit   vdt-update-certs.conf - setup certificate
vi $VDT_LOCATION/vdt/etc/vdt-update-certs.conf
 . $VDT_LOCATION/vdt-questions.sh; $VDT_LOCATION/vdt/sbin/vdt-setup-ca-certificates
#if you are using GUMS
vdt-control -enable gums-host-cron
vdt-control -on gums-host-cron
touch $VDT_LOCATION/monitoring/osg-attributes.conf
$VDT_LOCATION/gums/scripts/gums-host-cron
#if you are using edg-grid-map file
vdt-control -on edg-mkgridmap
</pre>


Check that osg-user-vo-map.txt is present and not empty, eg:
<pre class="screen">
ls -l   /opt/vdt_vomap/monitoring/osg-user-vo-map.txt
-rw-r--r--  1 root root 6224 Apr 14 14:23 /opt/vdt_vomap/monitoring/osg-user-vo-map.txt
</pre>

As a last step you will need to modify ProbeConfig file to add location of osg-user-vo-map.txt.
<pre class="screen">
#edit ProbeConfig 
#add the following line:
UserVOMapFile="&lt;VDT_LOCATION&gt;/monitoring/osg-user-vo-map.txt"
</pre>

---++ Starting/Stopping Gratia dCache Probes

To start/stop Gratia dCache-transfer probe that should be running on dCache admin host do the following:
<pre class="screen">
/etc/init.d/gratia-dcache-transfer start/stop
</pre>

Gratia dCache-storage probe is a cronjob that is run by default every hour. The cron file gratia-probe-dcache-storage.cron is located in /etc/cron.d
 
---++ Validation
---++ Known issues

---++ More information


%STOPINCLUDE%
%BR%
%COMPLETE1% %BR%
%RESPONSIBLE% Main.TanyaLevshina - 13 Apr 2009 %BR%
%REVIEW%
