%META:TOPICINFO{author="MarcoMambelli" date="1258503133" format="1.1" version="1.1"}%
%META:TOPICPARENT{name="Tier3DocDev"}%
---++ How to setup Condor's Hawkeye monitoring

%TOC{depth="3"}%

---++ Introduction
This section describes hot to setup Hawkeye to monitor a host to cause conditional scheduling.
You may find this useful if you are sharing the cluster with other users and want that to affect your scheduling.
This is is an example that you may modify for your need.

For clarity we choose Proof as name of an heavy application. We want to avoid job scheduling when Proof is running.

---++ Description
This control is done completely on the worker node that decides whether making the job slot available or not and whether a running job should be suspended or complete.


Condor / PROOF interaction information: 

this goes into the local config file for the execute machine:
<verbatim>
================================================================
# For more information check for STARTD_CRON in Condor manual 3.3.10 
# invoke a module every 30 seconds
STARTD_CRON_JOBLIST = PSPROOF
STARTD_CRON_PSPROOF_EXECUTABLE = /export/share/condor-etc/modules/psproof
STARTD_CRON_PSPROOF_PERIOD = 30s
STARTD_CRON_PSPROOF_MODE = Periodic
# In periodic mode the whole output is collected and processed at once, the last definition of each variable is the one added as machine attribute
#   In wait for exit mode the monitoring of the output is live

# use the output of that module to control policy
# you could also use PREEMPT instead of SUSPEND if desired
# PROOF_IS_RUNNING is the named attribute returned by the program below
SUSPEND = (PROOF_IS_RUNNING =?= True)
CONTINUE = (PROOF_IS_RUNNING =!= True)
================================================================
</verbatim>

Everything coming out from stdout will be directly added as machine attribute.

here's a sample code =/export/share/condor-etc/modules/psproof=.  you
can have the script do whatever you want so long as it outputs the
attribute=value pair to standard out:
<verbatim>
#!/bin/sh

ps auxwwww | grep zkmproof | grep -v grep > /dev/null
foundproof=$?

if [ $foundproof -eq 0 ]
then
  echo "PROOF_IS_RUNNING = True"
else
  echo "PROOF_IS_RUNNING = False"
fi
</verbatim>


this causes condor to periodically (every 30 seconds) invoke the module
=/export/share/condor-etc/modules/psproof=.  this module must output to
stdout an attribute=value pair that gets inserted into the machine ad.
here i used the attribute name "PROOF_IS_RUNNING".  then, in the local
config file, i set the SUSPEND/CONTINUE policy to use this attribute.



-- Main.MarcoMambelli - 17 Nov 2009