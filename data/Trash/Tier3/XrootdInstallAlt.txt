%META:TOPICINFO{author="MarcoMambelli" date="1271115720" format="1.1" reprev="1.6" version="1.6"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! <nop>%TOPIC%
%TOC%

---++ Introduction
Xrootd is a high performance network storage system widely used in high energy physics experiments such as ATLAS and ALICE. The underlying Xroot data transfer protocol provides highly efficient access to ROOT based data files.  This page provides instructions for a simple, relatively small-scale xrootd storage system consisting of:
   * One redirector node
   * One or more data server node(s)
More advanced deployment options including larger scale systems (larger than a few TB per data server) are covered below.


---++ Getting Started

---+++ Identify hosts and roles
   * Identify the redirector node. 
   * Identify the data server(s)

---+++ Check firewall rules
It's important to make sure your firewall(s) aren't blocking the ports that xrootd uses for communication.  Otherwise, hard to diagnose errors and failures may occur.  Xrootd uses the following ports:

|*Module Name*|*Port Number*| *Protocol*|
|!Xrootd redirector|1094|tcp|
||2094|tcp|
||1213|tcp|
|!Xrootd data server| opens random port selected by OS |tcp|

<!-- TODO: iptables command -->

---+++ Create the xrootd user account
You need a non privileged Xrootd user account on the redirector and all data servers, and that user *must have a login shell*.    If you manage your accounts by hand (rather than using a service such as LDAP) you would, on your management node:
<pre class="screen">
/usr/sbin/groupadd xrootd 
/usr/sbin/useradd --gid xrootd xrootd
</pre>
and copy =/etc/passwd, /etc/shadow, /etc/group,= and =/etc/gshadow= to each of the xrootd nodes.

---+++ Install Pacman
Pacman is a package management program used to install OSG software.
ReleaseDocumentation.PacmanInstall describes how to install Pacman.
You may select  =/opt/pacman= as the installation directory.<br>
%TWISTY{
mode="div"
showlink="Show an example of how to install Pacman..."
hidelink="Hide"
showimgleft="%ICONURLPATH{toggleopen-small}%"
hideimgleft="%ICONURLPATH{toggleclose-small}%"
}%
<pre class="screen">
cd /opt
wget http://atlas.bu.edu/~youssef/pacman/sample_cache/tarballs/pacman-3.29.tar.gz
tar --no-same-owner -xzvf pacman-3.29.tar.gz
cd pacman-3.29
source setup.sh
cd ..
ln -s pacman-3.29 pacman
</pre>
%ENDTWISTY%
Once Pacman is installed do: =source /opt/pacman/setup.sh=.  You are ready to install Xrootd.

---++ Installing and configuring the redirector
Two areas need to be setup: _storage_path_ and _storage_cache_. You may use  separate disk partitions for these but for the redirector we recommend simply creating two directories:
   * /storage/cache is the name of a service directory for the redirector (it hosts actual data on data servers). Files under _storage_cache_ are not visible to users.
   * /storage/path on the redirector is the name of a directory that contains references to all files in the Xrootd system. Xrootd clients have access to _storage_path_. 
<pre class="screen">
mkdir -p /storage/path
mkdir -p /storage/cache
</pre>

Next create and change to an installation directory. <pre class="screen">
mkdir -p /opt/xrootd/
cd /opt/xrootd/
</pre>

Install the !Xrootd package from the %CACHE% cache. 
Pacman will ask whether you want to trust the cache (answer =yall=). <!-- and whether you want to accept the license (=y=).-->
<pre class="screen">
pacman -get %CACHE%:Xrootd
</pre>

Update the environment and run the post installation script:<pre class="screen">
source setup.sh
vdt-post-install
</pre>

You can verify that the version installed is the version you expected by executing =vdt-version= : <pre class="screen">
vdt-version
</pre>

This completes the installation part of the Xrootd redirector. The next step is to configure the Xrootd redirector. The command below uses the defaults chosen in these instructions; you may need to change these:
   * $VDT_LOCATION is the installation directory of the Xrootd redirector (=/opt/xrootd=)
   * xrootd is the user name of the non-privileged user that runs Xrootd 
   * =/storage/cache= and =/storage/path= are the directories discussed above
   * =--public-cache-size 1= is a configuration option necessary for historical reasons (it will be removed from future releases).

<pre class="screen">
cd /opt/xrootd
source setup.sh
$VDT_LOCATION/vdt/setup/configure_xrootd  --server y  --user xrootd  --this-is-xrdr --xrdr-storage-path /storage/path   --xrdr-storage-cache /storage/cache --public-cache-size 1
</pre>

=vdt-control -list= shows the list of available services:
<pre class="screen">
vdt-control --list
Service                 | Type   | Desired State
------------------------+--------+--------------
xrootd                  | init   | enable
</pre>

Startup the redirector:
<pre class="screen">
vdt-control --on
</pre>


---++ Installing and configuring the data server(s)
These instruction must be executed on each of the data servers.

Decide which area to use as a _storage_path_ and _storage_cache_ (e.g =/storage/path= and =/storage/cache=).For the data servers we recommend creating separate disk partitions. Note on data servers: 
   * =/storage/cache= contains the actual data. 
   * =/storage/path= is the name of the directory that contains symbolic links to the files in _storage_cache_ . Xrootd clients have access to storage_path.
You will probably:
   * choose your disk or raid array
   * create a partition, e.g. using =fdisk= 
   * format it, e.g. using ext3 file system
   * mount the disk in your main file system, e.g. adding to =/etc/fstab= a line like:<pre class="screen">
/dev/sda5               /storage                ext3    defaults        1 2
</pre>
   * create the directories<pre class="screen">
mkdir -p /storage/path
mkdir -p /storage/cache
</pre>
A more in depth discussion is below in [[#Optimizing_disk_partitions_for_p][Optimizing disk partitions for performance]].

Next create and change to an installation directory. This directory will later be used to get the Xrootd package  from the %CACHE% cache.
<pre class="screen">
mkdir -p /opt/xrootd/
cd /opt/xrootd/
</pre>

You will need to install !Xrootd package from the %CACHE% cache. 
Pacman will ask whether you want to trust the cache (=yall=) and whether you want to accept the license (=y=).
<pre class="screen">
pacman -get %CACHE%:Xrootd
</pre>

Update the environment and run the post installation script (It is OK the the result is that there is nothing to do):
<pre class="screen">
source setup.sh
vdt-post-install
</pre>

You can verify that the version installed is the version you expected by executing =vdt-version= (=man vdt-version= to get more info). 
<pre class="screen">
vdt-version
</pre>

This completes the installation part of the Xrootd data server. The next step is to configure  !Xrootd redirector. The command below uses the defaults chosen in these instructions, you may need to change them:
   * $VDT_LOCATION is a directory of Xrootd installation (=/opt/xrootd=)
   * xrootd is the user name of the non-privileged user that runs Xrootd 
   * redirector.yourdomain is the name (FQDN) of the redirector host, e.g. =redirector.yourdomain.org= 
   * =/storage/cache= and =/storage/path= are the directories created above
   * =--public-cache-size 1= is an option needed for historical reasons. It will be removed from future versions.

<pre class="screen">
cd /opt/xrootd
source setup.sh
$VDT_LOCATION/vdt/setup/configure_xrootd  --server y  --user xrootd  --xrdr-host  redirector.yourdomain.org  --xrdr-storage-path /storage/path   --xrdr-storage-cache /storage/cache  --public-cache-size 1
</pre>

Hopefully all steps completed successfully and =vdt-control -list= shows the list of available services:
<pre class="screen">
#vdt-control --list
Service                 | Type   | Desired State
------------------------+--------+--------------
xrootd                  | init   | enable
</pre>

---++ Start/Stop !Xrootd
On each node where  !Xrootd is installed (redirector or data server) to start/stop Xrtood use the following. 

To start: <pre class="screen">
cd /opt/xrootd
source setup.sh
vdt-control --on
</pre>

To stop: <pre class="screen">
cd /opt/xrootd
source setup.sh
vdt-control --off
</pre>

---++ Testing your system
 Login on the redirector node as an ordinary user.

<pre class="screen">cd /opt/xrootd 
source setup.sh 
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$VDT_LOCATION/xrootd/lib 
export LD_PRELOAD=$VDT_LOCATION/xrootd/lib/libXrdPosixPreload.so 
echo &ldquo;This is a test&rdquo; &gt;/tmp/test 
cp /tmp/test xroot://redirector:1094///storage/path/test 
cp xroot://gc1-xrdr:1094///storage/path/test /tmp/test1 
diff /tmp/test1 /tmp/test 
</pre>

For example:
<pre class="screen">cp /tmp/test xroot://redirector.yourdomain.org:1094//storage/path/test </pre>


---++ Advanced installation options
---+++ Optimizing disk partitions for performance
To maximize the performance of your xrootd installation, you should place the storage cache and storage path on separate partitions.  The partition used for the storage cache should be optimized for the type of files used by scientific applications that will utilize the xrootd installation.  In general, you can use the defaults for =mke2fs= since that will tend to optimize for large files.

The partition used for the storage path should be optimized to hold a large number of inodes and files.  Since the storage path is used to hold symlinks to the actual data files, the file system should have a large number of inodes since each symlink will require an inode to hold an entry for the symlink.  In addition, the size of the data blocks used by the filesystem on the partition should be made as small as possible.  Since symlinks will typically consume an entire block regardless of the size of data block, a small data block size results in less space being wasted.  For an ext3 file system, passing =-b 1024= to =mke2fs= will set the block size to 1kb per block which is the smallest allowed block size.

---+++ Create disk partitions for the data servers
You will probably:
   * choose your disk or raid array
   * create a partition, e.g. using =fdisk= 
   * format it, e.g. using ext3 file system
   * mount the disk in your main file system, e.g. adding to =/etc/fstab= a line like:<pre class="screen">
/dev/sda5               /storage                ext3    defaults        1 2
</pre>
   * create the directories<pre class="screen">
mkdir -p /storage/path
mkdir -p /storage/cache
</pre>


---+++ Adding a data server


---++ References



%BR%



-- Main.RobGardner - 05 Apr 2010
