%META:TOPICINFO{author="MarcoMambelli" date="1265730279" format="1.1" reprev="1.3" version="1.3"}%
%META:TOPICPARENT{name="ClusterNetworkSetup"}%
---+!! *<nop>%SPACEOUT{%TOPIC%}%* 
%TOC%

---++ Introduction
Brief description of function of software and how it fits into the overall system.

This document presents some notes about the installation of a Firewall or a Router: it is a box that may provide IP level 3 routing, IP masquerading (NAT), a DNS server and a DHCP server. 
The firewall described could be used to separate the intranet of a Tier 3 from the extranet, as the NAT server described in the "Topology with intranet and extranet" of ClusterNetwork. 
Or it could be the Firewall separating the extranet from the Internet as in the second example of Figure 3 in ClusterNetwork.

The router/firewall chosen is [[http://www.vyatta.com/index.php][vyatta]] because it is available both as hardware device or software implementation, has both a command line interface similar to other commercial routers and a Web GUI, its community edition is available free of charge.

This document covers the configuration of a Vyatta router. The router can be deployed as:
   * !LiveCD
   * Persistent Device
   * Virtual machine
Check the [[http://www.vyatta.com/downloads/documentation/VC5.0.2/Vyatta_InstallationAndUpgrade_VC5_v01.pdf][Installation guide from Vyatta.org]] for information about the deployment.

%NOTE% *DISCLAIMER:* The configuration described here is meant only to be suggestive for a *small* environment.   Network configurations for clusters vary greatly depending on the local environment, the scale of the facility, and conventions used by and preferences of systems administrators.   You should get into contact with your local network administrator to find out more information about your campus' network infrastructure and services.  

---+++!! Applicable Versions
This software is not part of OSG or VDT. 

The instruction apply to Vyatta community edition VC5 

---+++!!Engineering Considerations
It is recommended to install the router/firewall on it own host.

---+++!!Help!
If a problem occurs during installation or verification of the service, see [[#DebugInfo][Debugging Information]].
%BR%
If you cannot resolve the problem, the best way to get help using the channel described under "Best effort support" in Tier3Help

---++ Checklist
See the introduction and ClusterNetwork for a better understanding of the terms used.
E.g.:
   1. A Vyatta router has been deployed as described in the  [[http://www.vyatta.com/downloads/documentation/VC5.0.2/Vyatta_InstallationAndUpgrade_VC5_v01.pdf][Installation guide from Vyatta.org]]
   1. the Ethernet interface eth1 of the router is connnected to the network where all the Tier 3 host reside (extranet or intranet)
   1. the Ethernet interface eth0 of the router is connnected to the outside (Internet or extranet) 
   1. IP addresses are assigned as descibed in ClusterNetworkSetup

---++ First Time Install
The steps below apply to the first time install but can be followed also to fix an existing configuration.

---++ Installation Procedure
The following steps apply to the first time install but can be followed also to fix an existing configuration.

description of the steps of this Install procedure (including the commands and options required) that will have to be performed each time this is installed.

Log in into the router using the console, change password, setup the IP address and enable ssh access. The default user/password are <tt>vyatta</tt>/<tt>vyatta</tt>. <tt>configure</tt> is used to start a configuration session, <tt>commit</tt> is used to commit changes, <tt>save</tt> to save changes on the persistent support (so that they will survive a reboot)
<pre class="screen">
configure
set interfaces ethernet eth0 address 128.135.250.17/24
set service ssh
commit
</pre>
Now you can login using ssh to continue the configuration if you prefer.
Setup the host networking: hostaname, domain, DNS servers
<pre class="screen">
configure
set system host-name gc-net
set system domain-name uchicago.edu
set system name-server 128.135.247.50
set system name-server 128.135.249.50
set system gateway-address 128.135.250.1
commit
save
</pre>
Setup the private network (192.168.192.0/18 - from 192.168.192.0 to 192.168.255.254), the IP (192.168.255.254) and enable NAT
<pre class="screen">
set interfaces ethernet eth1 address 192.168.255.254/18
set service nat rule 1 source address 192.168.192.0/18 
set service nat rule 1 outbound-interface eth0
set service nat rule 1 type masquerade
commit
</pre>
To allow all hosts to go on the internet (if you like to do so)
<pre class="screen">
set protocols static route 0.0.0.0/0 next-hop 128.135.250.1
commit
</pre>
Start the DNS and DHCP servers
<pre class="screen">
set service dhcp-server shared-network-name WN_POOL subnet 192.168.192.0/18 start 192.168.193.000 stop 192.168.193.254
set service dhcp-server shared-network-name WN_POOL subnet 192.168.192.0/18 default-router 192.168.255.254
set service dhcp-server shared-network-name WN_POOL subnet 192.168.192.0/18 dns-server 128.135.247.50
commit
</pre>
VPN configuration (optional)
<pre class="screen">
[TO BE ADDED]
</pre>

This procedure covers the success legs only 

---++ Service Configuration/Startup/Shutdown
The service can be treated as a hardware service even if it is software:
   * turn it on to start the service
   * turn it off to stop the service

---++ Validation of Service Operation
To test the service you can try to ping or ssh the router to test it network configuration and to use machines in the private network to test the private network configuration. 

#DebugInfo
---++ Debugging Information
---+++!!File Locations
Configuration file is normally located in <pre>/opt/vyatta/etc/config/config.boot</pre>

---+++!!Debugging Procedure
To debug you can try normal networking commands (like: <tt>ping, traceroute, nestat -r, route, ifconfig</tt>) on the connected hosts.

There are commands to show the configuration
<pre class="screen">
show interfaces ethernet eth0
show system
</pre>

---+++!!Caveats/Known Issues
NA

---+++!!References
Vyatta.org provides a clear and comprehensive documentation: http://www.vyatta.org/documentation (intro guides are public, reference documents require registration but are free)

Vyatta can be downloaded as virtual appliance from: http://www.vyatta.com/downloads/vc5.0.2/vyatta-virtual-appliance-vc5.0.2.zip

---+++!!Screen Dump of the Complete Install Process
%TWISTY{
mode="div"
showlink="Show..."
hidelink="Hide"
showimgleft="%ICONURLPATH{toggleopen-small}%"
hideimgleft="%ICONURLPATH{toggleclose-small}%"
}%
<pre class="screen">
vyatta@vyatta:~$ configure
[edit]
vyatta@vyatta# set interfaces ethernet eth1 address 192.168.0.254/24
[edit]
vyatta@vyatta# set service nat rule 1 source address 192.168.0.0/24 
[edit]
vyatta@vyatta# set service nat rule 1 outbound-interface eth0
[edit]
vyatta@vyatta# set service nat rule 1 type masquerade
[edit]
vyatta@vyatta# save
Saving configuration to '/opt/vyatta/etc/config/config.boot'...
Done
[edit]
vyatta@vyatta# set service https
[edit]
vyatta@vyatta# commit
Generating a 1024 bit RSA private key
............++++++
.................................................++++++
writing new private key to '/etc/lighttpd/server.pem'
-----
Stopping web server: lighttpd.
Starting web server: lighttpd.
Stopping PAGER server
Starting PAGER server
[edit]
vyatta@vyatta# show interfaces ethernet eth0
 address 128.135.250.17/24
 hw-id 00:50:56:12:01:01
[edit]
vyatta@vyatta# save
Saving configuration to '/opt/vyatta/etc/config/config.boot'...
Done
[edit]
vyatta@vyatta# set system host-name gc-net
[edit]
vyatta@vyatta# set system domain-name uchicago.edu
[edit]
vyatta@vyatta# set system name-server 128.135.247.50
[edit]
vyatta@vyatta# set system name-server 128.135.249.50
[edit]
vyatta@vyatta# show system name-server
+name-server 128.135.247.50
+name-server 128.135.249.50
[edit]
vyatta@vyatta# commit
[edit]
vyatta@vyatta# show system
 domain-name uchicago.edu
 host-name gc-net
 login {
     user root {
         authentication {
             encrypted-password $1$$Ht7gBYnxI1xCdO/JOnodh.
         }
     }
     user vyatta {
         authentication {
             encrypted-password $1$$Ht7gBYnxI1xCdO/JOnodh.
         }
     }
 }
 name-server 128.135.247.50
 name-server 128.135.249.50
 ntp-server 69.59.150.135
 package {
     repository community {
         components main
         distribution stable
         url http://packages.vyatta.com/vyatta
     }
 }
[edit]
vyatta@vyatta# set system gateway-address 128.135.250.1
[edit]
vyatta@vyatta# Read from remote host 128.135.250.17: Operation timed out
Connection to 128.135.250.17 closed.

$ ssh vyatta@128.135.250.17
vyatta@128.135.250.17's password: 
Linux vyatta 2.6.26-1-486-vyatta #1 SMP Fri Feb 27 01:04:20 GMT 2009 i686
Welcome to Vyatta.
This system is open-source software. The exact distribution terms for 
each module comprising the full system are described in the individual 
files in /usr/share/doc/*/copyright.
Last login: Mon Feb  8 19:04:32 2010 from 128.135.250.209
vyatta@gc-net:~$ logout
Connection to 128.135.250.17 closed.
</pre>
%ENDTWISTY%

---++ *Comments*
%COMMENT{type="tableappend"}%

%BR%
%COMPLETE2% %BR%
%RESPONSIBLE% Main.MarcoMambelli - 08 Feb 2010 %BR%
%REVIEW%  %BR%
%REVCOM%  Under Review %BR%
%REVFLAG%  %X%  %BR%
