%META:TOPICINFO{author="KyleGross" date="1329928281" format="1.1" version="1.12"}%
%META:TOPICPARENT{name="ClusterNetworkSetup"}%
---+!! *<nop>%SPACEOUT{%TOPIC%}%* 
%DOC_STATUS_TABLE%
%TOC%

---++ Introduction
This document presents some notes about the installation of a Firewall or a Router. The Firewall/Router is a box that may provide IP level 3 routing, IP masquerading (NAT), a DNS server and a DHCP server. 
Depending on your intention and how you place it on the network and how you configure it, the firewall described could be used to separate the intranet of a Tier 3 from the extranet, as the NAT server described in the "Topology with intranet and extranet" of ClusterNetwork, or it could be the Firewall separating the extranet from the Internet as in the second example of Figure 3 in ClusterNetwork.

The configuration described is using the network 192.168.192.0/18 as intranet, coherent with all the other Tier 3 documents.

The router/firewall chosen is [[http://www.vyatta.com/index.php][Vyatta]] because it is available both as hardware device or software implementation, has both a command line interface similar to other commercial routers and a Web GUI, its community edition is available free of charge.

This document covers the configuration of a Vyatta router. The router can be deployed as:
   * !LiveCD
   * Persistent Device
   * Virtual machine
Check the [[http://www.vyatta.com/downloads/documentation/VC5.0.2/Vyatta_InstallationAndUpgrade_VC5_v01.pdf][Installation guide from Vyatta.org]] for information about the deployment.

%DISCLAIMER% The configuration described here is meant only to be suggestive for a *small* environment.   Network configurations for clusters vary greatly depending on the local environment, the scale of the facility, and conventions used by and preferences of systems administrators.   You should get into contact with your local network administrator to find out more information about your campus' network infrastructure and services.  

---+++!! Applicable Versions
This software is not part of OSG or VDT. 

The instruction apply to Vyatta community edition VC5 

---+++!!Engineering Considerations
It is recommended to install the router/firewall on it own host.

If you plan to choose your subnet you should be familiar with [[http://tools.ietf.org/rfc/rfc1918.txt][RFC1918]], in particular know the IANA reserved private subnets (non routable networks):
   * 0.0.0.0 to 10.255.255.255	(10/8 prefix)
   * 172.16.0.0 to 172.31.255.255	(172.16/12 prefix)
   * 192.168.0.0 to 192.168.255.255	(192.168/16 prefix)
And read [[http://support.apple.com/kb/TA25227?viewlocale=en_US][these useful tips]] on choosing the right subnet.

---+++!!Help!
If a problem occurs during installation or verification of the service, see [[#DebugInfo][Debugging Information]].
%BR%
If you cannot resolve the problem, the best way to get help using the channel described under "Best effort support" in Tier3Help

---++ Checklist
See the introduction and ClusterNetwork for a better understanding of the terms used.
E.g.:
   1. A Vyatta router has been deployed as described in the  [[http://www.vyatta.com/downloads/documentation/VC5.0.2/Vyatta_InstallationAndUpgrade_VC5_v01.pdf][Installation guide from Vyatta.org]]
   1. the Ethernet interface eth1 of the router is connnected to the network where all the Tier 3 host reside (extranet or intranet)
   1. the Ethernet interface eth0 of the router is connnected to the outside (Internet or extranet) 
   1. IP addresses are assigned as descibed in ClusterNetworkSetup

---++ First Time Install
The steps below apply to the first time install but can be followed also to fix an existing configuration.

---++ Installation Procedure
The following steps apply to the first time install but can be followed also to fix an existing configuration.

In this example the router is a Vyatta VC5, has public IP 128.135.250.17 and NETMASK 255.255.255.0 (CDIR 128.135.250.17/24). Replace these values with your own.
The private network is 192.168.192.0/18. Change it if you have a different one.

Log in into the router using the console, change password, setup the IP address and enable ssh access. The default user/password are <tt>vyatta</tt>/<tt>vyatta</tt>. <tt>configure</tt> is used to start a configuration session, <tt>commit</tt> is used to commit changes, <tt>save</tt> to save changes on the persistent support (so that they will survive a reboot)
<pre class="screen">
configure
set interfaces ethernet eth0 address %RED%128.135.250.17/24%ENDCOLOR%
set service ssh
commit
</pre>
Now you can login using ssh to continue the configuration if you prefer.
Setup the host networking: hostaname, domain, DNS servers. You will have to use your own gateway and DNS servers.
<pre class="screen">
configure
set system host-name gc-net
set system domain-name uchicago.edu
set system name-server %RED%128.135.247.50%ENDCOLOR%
set system name-server %RED%128.135.249.50%ENDCOLOR%
set system gateway-address %RED%128.135.250.1%ENDCOLOR%
commit
save
</pre>
Setup the private network (192.168.192.0/18 - from 192.168.192.0 to 192.168.255.254), the IP (192.168.255.254) and enable NAT
<pre class="screen">
set interfaces ethernet eth1 address 192.168.255.254/18
set service nat rule 1 source address 192.168.192.0/18 
set service nat rule 1 outbound-interface eth0
set service nat rule 1 type masquerade
commit
</pre>
To allow all hosts to go on the internet (if you like to do so)
<pre class="screen">
set protocols static route 0.0.0.0/0 next-hop %RED%128.135.250.1%ENDCOLOR%
commit
</pre>

This procedure covers the success legs only 

---+++ Optional services
These section contains notes on services that you may decide to add but are not required for the Tier 3 examples to work. These examples are provided as is to show what is possible. Please check Vyatta documentation.

VPN configuration using PPTP. *Change username and passwrd to something safer!*
<pre class="screen">
configure
set vpn pptp remote-access outside-address %RED%128.135.250.17%ENDCOLOR%
set vpn pptp remote-access client-ip-pool start 192.168.192.40
set vpn pptp remote-access client-ip-pool stop 192.168.192.45
set vpn pptp remote-access authentication mode local
set vpn pptp remote-access authentication local-users username %RED%testuser%ENDCOLOR% password %RED%testpassword%ENDCOLOR%
commit
</pre>

<!--
VPN configuration using !OpenVPN. 

<pre class="screen">
mkdir /root/ks
cd /root/ks
touch index.txt
echo 01 > serial
</pre>

<pre class="screen">
cd /usr/share/doc/openvpn/examples/easy-rsa/2.0
vi vars
[edit KEY_DIR to point to the right dir.: /root/ks]
./build-ca
./build-key-server gc-net
./build-dh
/build-key laptop
</pre>


<pre class="screen">
set interfaces openvpn vtun0
set interfaces openvpn vtun0 mode server 
set interfaces openvpn vtun0 server subnet 192.168.193.0/24
set interfaces openvpn vtun0 tls ca-cert-file /root/ks/ca.crt 
set interfaces openvpn vtun0 tls dh-file /root/ks/dh1024.pem
set interfaces openvpn vtun0 tls cert-file /root/ks/gc-net.crt
set interfaces openvpn vtun0 tls key-file /root/ks/gc-net.key
commit 

No CRL:
set interfaces openvpn vtun0 tls crl-file /root/ks/crl.pem
</pre>

Ref:
http://tuntaposx.sourceforge.net/index.xhtml
http://www.destinyforge.com/blogs/?p=38
http://code.google.com/p/tunnelblick/wiki/UsingTunnelblick
http://openvpn.net/index.php/open-source/documentation/howto.html
-->

DHCP server configuration: define an address pool from 192.168.193.100 to 192.168.193.254 to dynamically assign addresses to worker nodes on the intranet; set the default router (gateway) and DNS server.

<pre class="screen">
set service dhcp-server shared-network-name WN_POOL subnet 192.168.192.0/18 start 192.168.193.100 stop 192.168.193.254
set service dhcp-server shared-network-name WN_POOL subnet 192.168.192.0/18 default-router 192.168.255.254
set service dhcp-server shared-network-name WN_POOL subnet 192.168.192.0/18 dns-server 128.135.247.50
commit
</pre>

Some DNS configuration: listening on eth1 (intranet); a static name added to the forwarding
<pre class="screen">
set service dns forwarding listen-on eth1
set system static-host-mapping host-name mydomain.org
set system static-host-mapping host-name mydomain.org alias gc1-net
set system static-host-mapping host-name mydomain.org inet 128.135.250.17
commit
show system static-host-mapping
</pre>

A simple firewall configuration with some examples. Rule 2 allows all outgoing traffic but rule 1 blocks ftp traffic.
<pre class="screen">
set firewall name test
edit firewall name test
set rule 1
edit rule 1
set source address 192.168.192.0/18
set protocol tcp
set destination address 0.0.0.0/0
set destination port ftp
set action reject
commit
edit firewall name test
set rule 2
edit rule 2
set source address 192.168.192.0/18
set destination address 0.0.0.0/0
set action accept

edit interfaces ethernet eth0
set firewall out name test
commit
</pre>

---++ Service Configuration/Startup/Shutdown
The service can be treated as a hardware service even if it is software:
   * turn it on to start the service
   * turn it off to stop the service

---++ Validation of Service Operation
To test the service you can try to ping or ssh the router to test it network configuration and to use machines in the private network to test the private network configuration. 

---+++ Connect to the hosts in the private network
You may want to connect (e.g. ssh) to the hosts behind the firewall (your natted intranet). You have some options: 
   * port forwarding is effective but requires per host and per configuration. It may become tedious to setup.
   * If you are on the same LAN of the Firewall/Router you can use a static route
   * Else you will need a VPN (split tunnel)

If you are on the same LAN of the router/firewall, you can setup in your computer a static route that reaches the private network through the router/firewall, e.g. <pre class="screen">sudo route add -net 192.168.192 128.135.250.17 </pre>. Note that the static route will cause a routing error if you are not in the same LAN as the router.
Since you have no VPN you should pay attention not to send any password in clear because your communication may be listened before reaching the firewall. Use of =ssh= is OK.

The most flexible solution is the use of a VPN. Above is shown how to setup a PPTP server on the VC5. Most OS come with a PPTP client. You can find [[][instructions for OS X]]

After this configuration you will be able to reach the hosts in the private network, e.g. <pre class="screen">ping 192.168.192.51
ssh gcuser@192.168.192.51</pre>

#DebugInfo
---++ Debugging Information
---+++!!File Locations
Configuration file is normally located in <pre>/opt/vyatta/etc/config/config.boot</pre>

---+++!!Debugging Procedure
To debug you can try normal networking commands (like: <tt>ping, traceroute, nestat -r, route, ifconfig</tt>) on the connected hosts.

There are commands to show the configuration
<pre class="screen">
show interfaces ethernet eth0
show system
</pre>

Or to remove a configuration wrongfully added
<pre class="screen">
delete interfaces ethernet eth1 address 192.168.0.254/24
</pre>

---+++!!Caveats/Known Issues
You may end up with misconfigured networks

---++++ Unreachable network
If you encounter an error like "bind: Can't assign requested address using ssh (or anything else)"  you may have some missing or wrong entry in the routing table.
Try =netstat -nr= to view your routes and use =route add/delete= to fix them.

---++++ PPTP Error
The PPTP negotiation may fail if the server requires encryption and the client starts proposing no encryption: MPPE required but peer negotiation failed. The problem can be solved fixing the client or allowing the server to accept no encryption (unsafe) by commenting =require-mppe-128= in =/etc/ppp/options.pptpd=.
[[http://pptpclient.sourceforge.net/howto-diagnosis.phtml#mppe_rbpnf][Click here]] to read further

---+++!!References
Vyatta.org provides a clear and comprehensive documentation: http://www.vyatta.org/documentation (intro guides are public, reference documents require registration but are free)

Vyatta can be downloaded as virtual appliance from: http://www.vyatta.com/downloads/vc5.0.2/vyatta-virtual-appliance-vc5.0.2.zip

---+++!!Screen Dump of the Complete Install Process
%TWISTY{
mode="div"
showlink="Show..."
hidelink="Hide"
showimgleft="%ICONURLPATH{toggleopen-small}%"
hideimgleft="%ICONURLPATH{toggleclose-small}%"
}%
<pre class="screen">
vyatta@vyatta:~$ configure
[edit]
vyatta@vyatta# set interfaces ethernet eth1 address 192.168.0.254/24
[edit]
vyatta@vyatta# set service nat rule 1 source address 192.168.0.0/24 
[edit]
vyatta@vyatta# set service nat rule 1 outbound-interface eth0
[edit]
vyatta@vyatta# set service nat rule 1 type masquerade
[edit]
vyatta@vyatta# save
Saving configuration to '/opt/vyatta/etc/config/config.boot'...
Done
[edit]
vyatta@vyatta# set service https
[edit]
vyatta@vyatta# commit
Generating a 1024 bit RSA private key
............++++++
.................................................++++++
writing new private key to '/etc/lighttpd/server.pem'
-----
Stopping web server: lighttpd.
Starting web server: lighttpd.
Stopping PAGER server
Starting PAGER server
[edit]
vyatta@vyatta# show interfaces ethernet eth0
 address 128.135.250.17/24
 hw-id 00:50:56:12:01:01
[edit]
vyatta@vyatta# save
Saving configuration to '/opt/vyatta/etc/config/config.boot'...
Done
[edit]
vyatta@vyatta# set system host-name gc-net
[edit]
vyatta@vyatta# set system domain-name uchicago.edu
[edit]
vyatta@vyatta# set system name-server 128.135.247.50
[edit]
vyatta@vyatta# set system name-server 128.135.249.50
[edit]
vyatta@vyatta# show system name-server
+name-server 128.135.247.50
+name-server 128.135.249.50
[edit]
vyatta@vyatta# commit
[edit]
vyatta@vyatta# show system
 domain-name uchicago.edu
 host-name gc-net
 login {
     user root {
         authentication {
             encrypted-password $1$$Ht7gBYnxI1xCdO/JOnodh.
         }
     }
     user vyatta {
         authentication {
             encrypted-password $1$$Ht7gBYnxI1xCdO/JOnodh.
         }
     }
 }
 name-server 128.135.247.50
 name-server 128.135.249.50
 ntp-server 69.59.150.135
 package {
     repository community {
         components main
         distribution stable
         url http://packages.vyatta.com/vyatta
     }
 }
[edit]
vyatta@vyatta# set system gateway-address 128.135.250.1
[edit]
vyatta@vyatta# Read from remote host 128.135.250.17: Operation timed out
Connection to 128.135.250.17 closed.

$ ssh vyatta@128.135.250.17
vyatta@128.135.250.17's password: 
Linux vyatta 2.6.26-1-486-vyatta #1 SMP Fri Feb 27 01:04:20 GMT 2009 i686
Welcome to Vyatta.
This system is open-source software. The exact distribution terms for 
each module comprising the full system are described in the individual 
files in /usr/share/doc/*/copyright.
Last login: Mon Feb  8 19:04:32 2010 from 128.135.250.209
vyatta@gc-net:~$ logout
Connection to 128.135.250.17 closed.
</pre>
%ENDTWISTY%

%BR%

---++ *Comments*
%COMMENT{type="tableappend"}%


<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################ 
   DEAR DOCUMENT OWNER
   ===================

   Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER          = MarcoMambelli

   Please define the document area, choose one of the defined areas from the next line
   DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       =  Tier3

   define the primary role the document serves, choose one of the defined roles from the next line
   DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager|Documenter)
   * Local DOC_ROLE       = SysAdmin

   Please define the document type, choose one of the defined types from the next line
   DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = Installation
   
   Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %NO%

   Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %NO%

   change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %YES%

   change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %YES%

   change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   reviewed during DOC workshop
   * Local RELEASE_READY  = %YES%


   DEAR DOCUMENT REVIEWER
   ======================

   Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = 
  
   Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %IN_PROGRESS%


   DEAR DOCUMENT TESTER
   ====================

   Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = 
  
   Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %IN_PROGRESS%
############################################################################################################ 
-->