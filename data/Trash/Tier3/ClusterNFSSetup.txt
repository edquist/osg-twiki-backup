%META:TOPICINFO{author="MarcoMambelli" date="1265737139" format="1.1" reprev="1.2" version="1.2"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! *<nop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%

---++ Introduction
   * We'll setup a shared file system using NFSv4 as discussed in "Customization of the base system" (first option).
   * The NFS server is =gc1-nfs=, all other hosts import the home directories and some service directories
   * NFS directories are mounted on =/nfs= and linked to the required destination to make the configuration more explicit

---++ Directories exported
NFSv4 requires a single directory thre
   * =home= - Home directories for Grid users; these are often shared group accounts with a name similar to the VO's name; for example *osg*, *osgedu*, *uscms*, *usatlas*, ...).  Local accounts for the *condor* user, and any other local user.
   * =condor= - Condor installation and configuration directories. It may have a subdirectory for each Condor version installed. This will allow for an easy upgrade procedure for Condor. See ClusterCondorInstall for more information. 
   * =osg= - Directories used by OSG, e.g. =OSG_GRID=, =OSG_APP= and =OSG_DATA=. Their functions is explained in the OSG documentation, for example ReleaseDocumentation.LocalStorageConfiguration.
   * =certificates= - CA certificate directory, shared across the cluster, updated by a process running on the CE node (*gc1-ce*) as part of the Grid installation.

---++ Configuration of the NFS server
The NFS server is called =gc1-nfs=.  Again here we are choosing some options that imply conventions and/or policy of the local site, and so the following is meant to be suggestive.  For example the =no_root_squash= option allows the root account on another machine in the cluster to modify files exported by the NFS server. This may not be desirable since it is a little less protective of the files on the NFS server.
   * All exported directories are grouped in =/exports=, NFS root directory
   * Create the directories under =/exports=: <pre class="screen">mkdir /exports
mkdir /exports/home   
mkdir /exports/condor 
mkdir /exports/osg   
mkdir /exports/certificates 
</pre>
   * Directories are exported separately which allows mounting with different permissions.  For example, may want to mount the =condor= directory as read only from the compute nodes.
   * The configuration is in =/etc/exports=.  If the file does not exist, create it. Add lines similar to the ones in the example file: one line for each directory in =/exports=. Each line starts with the directory name, followed by the IP address of the machine  and the subnet mask (=/24= should work), followed by the parameters =(async,no_root_squash,rw)=
   * Here an example of =/etc/exports= (my IP is =192.168.60.50=, subnet =/24= because I have a class C subnet):<pre class="file">cat /etc/exports
/exports    192.168.60.50(fsid=0,no_subtree_check,async,r) 
/exports/home   192.168.60.50/24(async,no_root_squash,rw)
/exports/condor 192.168.60.50/24(async,no_root_squash,rw)
/exports/osg    192.168.60.50/24(async,no_root_squash,rw)
/exports/certificates   192.168.60.50/24(async,no_root_squash,rw)</pre>
   * =/exports= is the root of the NFS file system, identified by =fsid=0=, everything else you'd like to export has to be accessible under it. To export directories from outside a _bind mount_ is necessary, add it to =/etc/fstab.
   * NFS has to be restarted in order for any change to take effect.  This is done by =/etc/init.d/nfs restart=.
   * To enable NFS at boot-time, and to start it up: <pre class="screen">
chkconfig --level 345 nfs on
/etc/init.d/nfs start
</pre>
<!-- 
portmap is not necessary for NFSv4
   * Also check that the =portmap= service is running at levels 3,4,5:<pre class="screen">chkconfig --list portmap
portmap        	0:off	1:off	2:off	3:on	4:on	5:on	6:off</pre>
-->

Another important file is:
   * =/etc/idmapd.conf =, defining the domain and how the users are mapped
   * To test if NFS is working locally:<pre class="screen">
mkdir /tmp/test
mount -t nfs4 gc1-nfs:/condor /tmp/test
touch /exports/condor/testfile
ls -l /tmp/test/
# cleanup
umount /tmp/test
rmdir /tmp/test
</pre>
   * Note how in the mount directory in the command uses only  the relative path starting from the NFS root.
   * On the NFS server (*gc1-nfs*) the exported directories are linked to their destination.  This is usually a soft link. Sometimes a bind mount is used.

---++ Configuration on client machines: /etc/fstab
   * Almost all other hosts import directories from the NFS server.  This is controlled editing =/etc/fstab= adding the lines (the NFS server is =gs1-nfs= and it is configured as above):<pre class="file">
gc1-nfs:/exports/condor         /nfs/condor     nfs4     bg,intr,noatime
gc1-nfs:/exports/home           /nfs/home       nfs4     bg,intr,noatime
gc1-nfs:/exports/osg            /nfs/osg        nfs4     bg,intr,noatime
gc1-nfs:/exports/certificates   /nfs/certificates nfs4   bg,intr,noatime
</pre>
<!-- optional
   * A trick to speedup the configuration could be to prepare a file =fstab._addon.gc1= that can be appended to the fstab of all NFS clients.  
   * Individual client hosts can be customized (e.g. worker nodes import the =condor= directory as read-only).  
-->
   * As seen in the file above, all directories are NFS-mounted in =/nfs=, for clarity. Mount points are created.  All directories are then linked to their final path.
   * Running the commands listed below will create the mountpoints for the nfs mounts and symlinks between the mount points and the location on the filesystem where the files should be<pre class="screen">
mkdir /nfs
mkdir /nfs/condor
mkdir /nfs/home
mkdir /nfs/osg
mkdir /nfs/certificates
ls /opt/
ln -s /nfs/condor/condor /opt/condor
mv /home /home.orig
ln -s /nfs/home /home
mkdir /share
ln -s /nfs/osg /share/osg
mkdir /etc/grid-security
ln -s /nfs/certificates /etc/grid-security/certificates
</pre>
   * A mount command will need to be run for each of the mount points <pre class="screen">
mount /nfs/condor
mount /nfs/home
mount /nfs/osg
mount /nfs/certificates
</pre>


%BR%
%BR%
%RESPONSIBLE% Main.MarcoMambelli - 17 Nov 2009 %BR%
%REVIEW%

OldClusterNFSSetup

---++ *Comments*
%COMMENT{type="tableappend"}%
