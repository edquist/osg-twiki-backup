%META:TOPICINFO{author="TanyaLevshina" date="1270505118" format="1.1" reprev="1.8" version="1.8"}%
---+!! *<nop>%SPACEOUT{Bestman-Gateway Installation Guide}%*
%TOC%

---++Introduction
!BeStMan-Gateway, developed by the Scientific Data Management Group of Lawrence Berkeley National Laboratory, is a generic SRM v2.2 load balancing frontend for transfer servers. It works on top of existing disk-based POSIX-compliant file systems, and has been reported so far to work on file systems such as NFS, GPFS, PVFS2, GFS, Ibrix, HFS+, Hadoop, !XrootdFS and Lustre. It also works with any existing file transfer service, such as gsiftp, http, https, bbftp and ftp. This document is written for system administrators who are planning to use storage that is installed on top of a POSIX-compliant file system. The goal of this document is to give enough information for system administrators to do initial simple configuration of the storage as well as provide references to the documents that may help to accomplish more sophisticated configuration.

---++++++!!Applicable Versions
This document applies to an install of 
%RED%
*osg-version 1.2.4* 
%ENDCOLOR%
(or higher) and 
%RED%
*vdt-version  2.0.0*
%ENDCOLOR%
(or higher).

---++++++!!Engineering Considerations
!BeStMan-Gateway storage could be installed on one node and the installation cache consists of the following components: 
   * !BeStMan-Gateway is an implementation of SRM v2.2 for essential interfaces to disk based storage systems - [[https://sdm.lbl.gov/bestman/][BeStMan Home Page]] 
   * !GridFTP server  provides a high-performance, secure, reliable data transfer [[http://www.globus.org/toolkit/docs/4.2/4.2.1/data/gridftp/][GridFTP documentation]]. It is recommended that multiple !GridFTP instances on different servers if:
      * You are serving the VOs that use storage heavily (CMS, ATLAS, CDF, and D0) and have more than 250 cores
      * Your site will be managing more than 50 TB of disk space
      * You r site have more than 1Gbps bandwidth, then you should plan on at least one !GridFTP server per 4Gbps of available bandwidth (assuming you have 10Gbps interfaces on the server) if you want to maximize throughput. 
   * POSIX-compliant file system
   * optional package
      * Gratia gridftp transfer probe - cron job that reports all the file transfers to [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/GratiaSiteCollector Gratia collector]]
      *  [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/InstallConfigureAndManageGUMS][GUMS server]] - authentication and authorization service

---++Checklist
   1. [[ReleaseDocumentation/PacmanInstall][pacman]] version >= %PACMAN_VERSION% is required
   1. The server must have a fully qualified domain name and a valid [[ReleaseDocumentation/GetGridCertificates][grid host certificate]] installed in =/etc/grid-security/=
   1. !BeStMan server needs to have a valid host or service certificate installed in =/etc/grid-security/bestmancert= (bestmancert.pem and bestmankey.pem). The certificate should be own by a user that is running !BeStMan server. The right permission (600) should be set on those files. %ICON{warning}%  !BeStMan should be configured with host certificate in order to be able to handle requests from !LCG-Utils tools. This is mandatory for at least all !BeStMan servers that support ATLAS experiment. Normally the OSG !BeStMan implementation uses a service certificate, not a host certificate. This causes lcg-cp to fail because the certificate name (which looks like http/hostname instead of just hostname) doesn't match the hostname.
   1. A disk area that you want to export with !BeStMan. =/data= in this document. 
   1. The firewall must allow incoming connections to the !GridFTP port (default 2811). Outgoing connections must be allowed from high ports ( typically in range 32769-65535 ). We recommend to consult the [[ReleaseDocumentation/ComputeElementFirewalls][Firewall Guide]] if you install the !GridFTP server for the first time.
   1. A working GUMS server or a gridmap-file are needed for authorization using grid certificates.

---++Installation Procedure
Login as root, setup pacman and check if pacman version >=%PACMAN_VERSION% is installed:
<pre class="screen">
su root
cd /opt/pacman_%PACMAN_VERSION% 
. setup.sh
pacman -version
</pre>
Next create and change to an installation directory. This directory will later be used to get the !BeStMan package  from the %CACHE% cache.
<pre class="screen">
mkdir -p /opt/bestman/
cd /opt/bestman/
</pre>
If you are using GUMS authorization method you will need to setup VDT_GUMS_HOST environment variable, if you are using gridmap-file ,please, proceed to the next step.

<pre class="screen">
<verbatim> 
export VDT_GUMS_HOST=<GUMS hostname>  
</verbatim> 
</pre>

Finally execute pacman to get the !BeStMan package from the %CACHE% cache. Pacman will ask whether you want to trust the cache (=yall=) and whether you want to accept the license (=y=).
<pre class="screen">
pacman -get %CACHE%:Bestman
</pre>

The install procedure will print out a warning:
<verbatim>
========== IMPORTANT ==========
Most of the software installed by the VDT *will not work* until you install
certificates.  To complete your CA certificate installation, see the notes
in the post-install/README file.
</verbatim>

The information provided in the README is out of date. Please setup the CA certificates in the following way instead:
<pre class="screen">
source setup.sh
$VDT_LOCATION/vdt/bin/vdt-ca-manage setupca --location local -url osg
</pre>
This command will download certificates distributed by the OSG to =$VDT_LOCATION/globus/share/certificates= and create a symlink from =$VDT_LOCATION/globus/TRUSTED_CA= to that location. [[ReleaseDocumentation.VDTCAManage][Other certificate options]] are also available.

To reflect the changes update the environment and run the post installation script:
<pre class="screen">
source setup.sh
vdt-post-install
</pre>

You can verify that the version installed is the version you expected by executing =vdt-version=. To see all services available use =vdt-control -list=
<pre class="screen">
vdt-version
vdt-control --list
</pre>

This completes the installation of the !BeStMan server. Move to the next step to configure the !BeStMan and !GridFTP servers. You may also chose to configure Gratia transfer probe at this time.

---++ Service Configuration
You will need to configure !BeStMan-Gateway first in order to enable it as a service. The configuration command is shown below:
<pre class="screen">
<verbatim>
cd /opt/bestman 
source setup.sh 
$VDT_LOCATION/vdt/setup/configure_bestman --server y \
--cert /etc/grid-security/bestmancert/bestmancert.pem  \
--key  /etc/grid-security/bestmancert/bestmankey.pem  
--gums-host  <GUMS hostname>  \
--enable-gateway  \
--with-allowed-paths /data
</verbatim>
</pre>  

This command will install !BeStMan that will be 
   * running  by user _"daemon"_,
   * using certificate  /etc/grid-security/bestmancert/bestmancert.pem and certificate key /etc/grid-security/bestmancert/bestmankey.pem, The certificate file and key should exist for configuration to work (see #Checklist) 
   * listening on secure port 10443 and public port 10080
   * utilizing  gridftp server running on the same host on 2811 port
   * using GUMS server that is running on  <GUMS hostname>  host and using 8443 port for authorization, if you want to use gridmap file skip this option.
   *  /data will be used to store users' data. This directory should have adequate permissions so users have read/write/execute access.

Now, you should make modification in =/etc/sudoers= file namely add the following lines to this file: 
<pre class="screen">
<verbatim>
# Comment out this line, if it is in your /etc/sudoers file (RHEL5+)
#Defaults    requiretty

Cmnd_Alias SRM_CMD = /bin/rm, /bin/mkdir, /bin/rmdir, /bin/mv, /bin/ls, /bin/cp 
Runas_Alias SRM_USR = ALL, !root 
daemon ALL=(SRM_USR) NOPASSWD: SRM_CMD 
</verbatim>
</pre>
Please keep in mind that this is just an example, you can choose more  be more restrictive policy for your site.
!BeStMan server will not be able to run if this step is missed.


To configure the port range used by the server to transfer files, add following lines to =$VDT_LOCATION/vdt/etc/vdt-local-setup.sh=:

<pre class="screen">
  export GLOBUS_TCP_PORT_RANGE=32000,64000
  export GLOBUS_TCP_SOURCE_RANGE=32000,64000
</pre>

and also to =$VDT_LOCATION/vdt/etc/vdt-local-setup.csh=:

<pre class="screen">
  setenv GLOBUS_TCP_PORT_RANGE 32000,64000
  setenv GLOBUS_TCP_SOURCE_RANGE 32000,64000
</pre>

 If you want to use the grid-map-file for user authentication and authorization ignore the rest of this section. Copy two files from $VDT_LOCATION/post-install to in /etc/grid-security:
<pre class="screen">
cp $VDT_LOCATION/post-install/prima-authz.conf /etc/grid-security 
cp $VDT_LOCATION/post-install/gsi-authz.conf /etc/grid-security 
</pre>

---++ Enabling the Services
You can use the _vdt-control -list_ command to see all services that are installed as part of the install, and whether or not they are enabled or disabled. 
You will need to enable the following services:
   * fetch-crl   
   * vdt-rotate-logs  
   * vdt-update-certs       
   * gsiftp           
   * gums-host-cron   %ICON{warning}% In case you want to run Gratia !GridFTP transfer probe and are using !GUMS for authorization
   * edg-mkgridmap     %ICON{warning}% In case you want to use gridmap-file for authorization 

You can execute _vdt-control -enable_ command and list all services you want to enable:
<pre class="screen">
cd /opt/bestman
source setup.sh
vdt-control -enable fetch-crl vdt-rotate-logs vdt-update-certs gsiftp  
</pre> 

If you are using !GUMS or have gridmap-file and don't want to use automatically generated one, please, skip this section:
<pre class="screen">
cd /opt/bestman;
source setup.sh
vdt-control -enable edg-mkgridmap
edg/sbin/edg-mkgridmap
</pre> 

---++ Service Startup/Shutdown
To start type:
<pre class="screen">
vdt-control --on
</pre>
and to stop:
<pre class="screen">
vdt-control --off
</pre>

---++ Validation of Service Operation

To check if !BeStMan is installed and operational you need to [[https://twiki.grid.iu.edu/bin/view/SiteCoordination/GridClientTutorial][install client software]], obtain voms proxy certificate and then run the srm-ping to verify the !BeStMan server is up and running:
<pre class="screen">
<verbatim>
srm-ping  srm://<your bestman host fqn>:10443/srm/v2/server
</verbatim>
</pre>

To verify that you can transfer files do srm-copy:

<pre class="screen">
<verbatim>
 srm-copy file:////tmp/test srm://<your bestman host fqn>:10443/srm/v2/server\?SFN=/data/test
</verbatim>
</pre>

Verify that the [[ReleaseDocumentation/GratiaTransferProbe#Sanity_Check][gratia probe is working]].



---++Debugging Information
---++++++!!Basic Tests:

srm-ping command:
<pre class="screen">
[tlevshin@gw014k0 ~]$ srm-ping  srm://fg0x5:10443/srm/v2/server
srm-ping   2.2.1.3.2   Thu Oct 15 13:55:22 PDT 2009
.......
Extra information (Key=Value)
backend_type=BeStMan
backend_version=2.2.1.2.i7
backend_build_date=2009-07-10T20:54:10.000Z 
gsiftpTxfServers[0]=gsiftp://fg0x5.fnal.gov
clientDN=/DC=org/DC=doegrids/OU=People/CN=Tanya Levshina 508821
gumsIDMapped=fnalgrid
</pre>

srm-copy command:
<pre class="screen">
[tlevshin@gw014k0 ~]$  srm-copy file:////tmp/test srm://fg0x5.fnal.gov:10443/srm/v2/server\?SFN=/data/test_1000
..... 
SRM-CLIENT: Tue Nov 17 16:43:49 CST 2009 Connecting to httpg://fg0x5.fnal.gov:10443/srm/v2/server

SRM-CLIENT: Tue Nov 17 16:43:50 CST 2009 Calling SrmPrepareToPutRequest now ...
request.token=fnalgrid:0_PUT_3074101460
Request.status=SRM_REQUEST_INPROGRESS
explanation=null
SRM-CLIENT: Next status call in 10 seconds.
SRM-CLIENT: Tue Nov 17 16:44:01 CST 2009 Calling Status at Tue Nov 17 16:44:01 CST 2009
SRM-CLIENT: Result Status from SRM (srmStatusOfPutRequest)=SRM_SUCCESS

SRM-CLIENT: RemainingPinTime=289
SRM-CLIENT: received TURL=gsiftp://fg0x5.fnal.gov//data/test_1000

SRM-CLIENT: Tue Nov 17 16:44:02 CST 2009 start file transfer
SRM-CLIENT:Source=file:////tmp/test
SRM-CLIENT:Target=gsiftp://fg0x5.fnal.gov//data/test_1000

SRM-CLIENT: Tue Nov 17 16:44:05 CST 2009 end file transfer for file:////tmp/test

SRM-CLIENT: Tue Nov 17 16:44:05 CST 2009 Calling putDone for srm://fg0x5.fnal.gov:10443/srm/v2/server?SFN=/cache/test_1000
Result.status=SRM_SUCCESS
Result.Explanation=null

SRM-CLIENT: Request completed with success

SRM-CLIENT: Printing text report now ...

SRM-CLIENT*REQUESTTYPE=put
SRM-CLIENT*TOTALFILES=1
SRM-CLIENT*TOTAL_SUCCESS=1
SRM-CLIENT*TOTAL_FAILED=0
SRM-CLIENT*REQUEST_TOKEN=fnalgrid:0_PUT_3074101460
SRM-CLIENT*REQUEST_STATUS=SRM_SUCCESS
SRM-CLIENT*SOURCEURL[0]=file:////tmp/test
SRM-CLIENT*TARGETURL[0]=srm://fg0x5.fnal.gov:10443/srm/v2/server?SFN=/data/test_1000
SRM-CLIENT*TRANSFERURL[0]=gsiftp://fg0x5.fnal.gov//data/test_1000
SRM-CLIENT*ACTUALSIZE[0]=0
SRM-CLIENT*FILE_STATUS[0]=SRM_SUCCESS
SRM-CLIENT*EXPLANATION[0]=SRM-CLIENT: PutDone is called successfully
</pre>

---++++++!!File Locations
!BeStMan
   * Configuration file:
      * $VDT_LOCATIONbestman/conf/bestman.rc
   * Log Files
      * $VDT_LOCATION/vdt-app-data/bestman/logs/event.srm.log

!GridFTP
   * Configuration file:
      * $VDT_LOCATION/vdt/services/vdt-run-gsiftp.sh.env  
   * Log Files
      * $VDT_LOCATION/globus/var/log/gridftp.log
      * $VDT_LOCATION/globus/var/log/gridftp-auth.log 

!Gratia Transfer Probe
   * Configuration file:
      * $VDT_LOCATION/gratia/probe/gridftp-transfer/ProbeConfig	 
   * Log Files
      * $VDT_LOCATION/gratia/var/logs 

---++++++!!Debugging Procedure
   * Look at the [[#Checklist][Checklist]] and make sure you really checked those items.

---++++++!!Caveates/Known Issues
---++++++!!Screendump of Install
<pre class="screen">
. /opt/pacman_3.28/setup.sh
mkdir -p /opt/bestman/
cd /opt/bestman
export VDT_GUMS_HOST=gums.fnal.gov
pacman -get http://software.grid.iu.edu/osg-1.2:Bestman
. setup.sh
vdt-post-install
$VDT_LOCATION/vdt/setup/configure_bestman --server y --cert /etc/grid-security/bestmancert/bestmancert.pem  --key  /etc/grid-security/bestmancert/bestmankey.pem   --gums-host gums.fnal.gov  --enable-gateway  --with-allowed-paths /data
cp  /etc/grid-security/hostcert.pem /etc/grid-security/bestmancert/bestmancert.pem
cp /etc/grid-security/hostkey.pem /etc/grid-security/bestmancert/bestmankey.pem
vi /etc/sudoers
mkdir /data
chmod 777 /data
vdt-version
vdt-control --list
vdt-control -enable fetch-crl vdt-rotate-logs vdt-update-certs gsiftp  
vdt-control -on
</pre>


---++Comments
%COMMENT{type="tableappend"}%

%STOPINCLUDE%
%BR%
%COMPLETE2% %BR%
%RESPONSIBLE%  %BR%
%REVIEW% %BR%


-- Main.TanyaLevshina - 17 Nov 2009
