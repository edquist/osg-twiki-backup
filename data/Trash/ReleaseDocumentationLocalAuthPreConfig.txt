%META:TOPICINFO{author="StevenTimm" date="1281644622" format="1.1" reprev="1.16" version="1.16"}%
%META:TOPICPARENT{name="ComputeElementInstall"}%
---+!! *<nop>%SPACEOUT{ "%TOPIC%" }%*
%DOC_STATUS_TABLE%
%TOC{depth="2"}%

%STARTINCLUDE% 
%BR%
---+ _%INCLUDEHEADING% %SPACEOUT{ "%TOPIC%" }%_
 Local Authorization (grid-mapfile) Pre-configuration steps

%EDITTHIS% 
%BR%
---++ Introduction
 It is necessary to enable some mode of authentication before you can successfully 
run the OSG configuration script.  There is no mode of authentication that is enabled by 
default.  This section of the document describes how to enable the Local Authorization mode, sometimes known as "grid3" authorization.
There is more background information about the other privilege modes  at AboutAuthorizationForCE.   If you  
wish to enable a different mode, please consult [[FullPrivPreConfig][Full Privilege authorization page]] or [[CompatibilityAuthPreConfig][Compatibility authorization page]].

The Local Authorization mode, sometimes known as "grid3" authorization mode, uses an ASCII file called a grid-mapfile to make all decisions about authorization. With this mode it is not possible to correctly implement role-based authentication for Virtual Organizations, and difficult to implement VO Groups correctly. This document provides a short guide to the steps that are necessary to perform for this mode before you run the OSG configuration utility.

In Grid3 (Local) mode, authorization is performed only via the =/etc/grid-security/grid-mapfile= on the Compute Element (CE) node. Synchronizing all the =grid-mapfiles= for multiple CE nodes needs to be done *manually* in this case.

You may prefer this configuration if:
   * You are a small site (one gatekeeper) and, 
   * You deal with a small set of fairly static VOs 
   * You are *not* supporting _role-based_ authorizations (voms proxies with extended attributes) 

The =grid-mapfile= can be maintained using the =edg-mkgridmap= cron service that is installed with the OSG CE software. A GUMS service is not used.

---++ Configure edg-mkgridmap
=ekg-mkgridmap= is a service that creates =/etc/grid-security/grid-mapfile= by pulling information out of VOMS servers. It has its own configuration file, called =edg-mkgridmap.conf=.

---+++ Configure the list of supported VO's for your site
 During installation, a default OSG configuration file, =$VDT_LOCATION/edg/etc/edg-mkgridmap.conf=, is created providing access to all registered and approved OSG VOs VOMS servers. Review this configuration file: 
   * If the list is acceptable to you, then you're done with this step. 
   * If not, then you will need to edit the file and commenting out the line(s) for each VO you wish to disable. 

The following is a snippet of the =edg-mkgridmap.conf= file with some brief comments related to the syntax.

<pre>    
__Comment lines start with "#" as in a shell script.__  
#### GROUP: group URI [lcluser] #      
__"# USER-VO-MAP" line has special significance in OSG:      - the 1st and 2nd tokens after this string are the subgroup and VO respectively      - it then shows the  VO administrator, VO admin email address)__ 
# USER-VO-MAP cdf CDF -- 1 -- Gabriele Compostella (compostella@tn.infn.it)      
__1st token indicates 'group' accounts are used     2nd token (starts with "vomss:") - specifies the  web services address of this VO's VOMS service     3rd token - specifies the 'group' account assigned each member; here it is "cdf"__ 
group vomss://voms.cnaf.infn.it:8443/voms/cdf cdf      
__Note that for Fermilab VO the support center is used__ 
# USER-VO-MAP fermilab FERMILAB -- 2 -- Fermilab Grid Support Center (helpdesk-admin@fnal.gov) group vomss://voms.fnal.gov:8443/voms/fermilab fermilab   :     
__Some VO's may have multiple VOMS lines__ 
# USER-VO-MAP usatlas ATLAS -- 10 -- (usatlas-support-l@lists.bnl.gov) 
#group vomss://vo.racf.bnl.gov:8443/voms/atlas?/atlas/usatlas usatlas1 
#group vomss://vo.racf.bnl.gov:8443/voms/atlas?/atlas/usatlas usatlas2 
#group vomss://vo.racf.bnl.gov:8443/voms/atlas?/atlas/usatlas usatlas3    :  
</pre>

The syntax of the =# USER-VO-MAP= line is significant for OSG accounting and monitoring to be effective. If you have not already done so, read the [[OsgSupportedVos][OSG Supported VOs]] topic *now*.

Please notice that this configuration file is periodically updated by the OSG GOC and new/updated versions are issued. 
The GOC will send out an email notifying the site administrators of the change who then need to run
<pre>
 pacman update
</pre>
to update the =edg-mkgridmap.conf= file.

For this reason, it is recommended that you do not delete entries, but comment them (using =#=). This will allow you to do a comparison of your current configuration against any new OSG version more accurately and you will be more readily aware of those VOs you omitted intentionally.

Generic information can be found at the [[http://vdt.cs.wisc.edu/extras/edg-mkgridmap.conf.html][VDT edg-mkgridmap configuration file documentation page]].

---+++ Setting up edg-mkgridmap for local users
 You probably want to keep some portion of your current =grid-mapfile= (at least your own entry) as locally known users so that you won't get locked out should there be a problem with a VOMS server.

You can accomplish this by adding the following directive to the end of the =edg-mkgridmap.conf= file.

<pre>
#### GMF_LOCAL: gmf_local grid-mapfile-local 
gmf_local   /etc/grid-security/grid-mapfile-local 
</pre>

The local entries from this file are added to the actual =/etc/grid-security/grid-mapfile= every time the cron script is executed. A couple of key points about this file and the entry shown above:
   * In the configuration file, the location of the local grid-mapfile must contain the fully qualified path 
   * The location and name of the local file shown in above is just a recommendation. You can keep it anywhere and name it anything. 
   * The syntax of the =grid-mapfile-local= is the same as the real =grid-mapfile= 
   * Any =gmf_local= directive(s) *must* (otherwise they could get overwritten) be the last entries in the =edg-mkgridmap.conf= file. 

---+++ Enable the edg-mkgridmap service

<pre>vdt-control --enable edg-mkgridmap </pre>

 You can also force the creation of a new =/etc/grid-security/grid-mapfile= by running
<pre>(YOUR_VDT_LOCATION)/edg/sbin/edg-mkgridmap </pre>
as *root* by hand.

---++ Configure Globus to use the Local authorization mode
The Globus gatekeeper is a CE service (also known as Pre_WS-GRAM) that submits user jobs from the grid to an underlying local batch system. Users present their grid identities (user proxy) to Globus. 
This identity is mapped to a local user (UNIX username) using the PRIMA libraries.
Jobs are then run in the batch system using this local identity.

No configuration changes are needed. The Globus gatekeeper will automatically use the =/etc/grid-security/grid-mapfile=.

---++ WS-GRAM services configuration
WS-GRAM is a CE service that submits user jobs from the grid to an underlying local batch system. Users present their grid identities (user proxy) to WS-GRAM. This identity is mapped to a local user (UNIX username), for example using a gridmap-file (as explained above). Jobs are run in the batch system using this local identity. 

---+++!! WS-GRAM configuration for local auth mode
The default authorization mode for WS_GRAM is Local or Compatibility.  It uses the =/etc/grid-security/grid-mapfile= as the basis for authorization.  

So no changes to the configuration are needed.

---+++!! WS-GRAM services sudoers file
Pre-WS-GRAM and WS-GRAM use two different mechanisms to switch to the appropriate local user.

The <i>pre-WS</i> GRAM processes run as privileged user (root) and can, therefore, change to any local unprivileged user. This mechanism, however, may present security risks: bugs in the code, which runs as root, may be exploited to gain privileged access to the machine.

To mitigate this risk, WS-GRAM processes run as an unprivileged user (either <b>globus</b> or <b>daemon</b>, depending on the local configuration). In order for these users to be able to switch to another local unprivileged user, though, the local =sudo= service must be appropriately configured. The configuration requires editing the =/etc/sudoers= file manually.  

In =$VDT_LOCATION/post-install/README=, the section <i>Globus-Base-WSGRAM-Server</i> describes the modifications to =/etc/sudoers= necessary for the web services GRAM to function properly.  To facilitate the necessary modification, the =configure-osg.py= script produces the necessary additions for the =/etc/sudoers= file and writes them into a new file =$VDT_LOCATION/monitoring/sudo-example.txt= . The administrator should simply copy and paste the content of that file into the =/etc/sudoers= file using =visudo=.
*Note the following:*
   * You __must__ use the same authorization mode for pre-ws and web services.
   * This must be done manually.
   * The path defined in =/etc/sudoer= cannot be soft links. Use full paths only. Therefore, if you have your $VDT_LOCATION (e.g. /opt/local/ce-1.0/) soft linked from a generic directory (e.g. /opt/local/ce), it is the explicit path (e.g. ce-1.0) that *must* used in the =/etc/sudoers= file. If you install another version of the software into a different directory, you must change the =/etc/sudoers= to reflect the new installation since making a softlink will not work.
   * Use the =visudo= command to modify the =/etc/sudoers= file. 
   * Beware of extra whitespace when modifying the =sudoers= file, especially at the end of a line.

Make these changes now, keeping in mind the user under which VDT determined your container will run.

In the example (for Local/Gridmap mode) that follows, the web services user is the _daemon_ user and the real path to the VDT_LOCATION is =/usr/local/osg-ce=:
<pre>
Runas_Alias GLOBUSUSERS = ALL, !root  
daemon ALL=(GLOBUSUSERS)          \
NOPASSWD: /usr/local/osg-ce/globus/libexec/globus-gridmap-and-execute       \
   -g /etc/grid-security/grid-mapfile          /usr/local/osg-ce/globus/libexec/globus-job-manager-script.pl *  
daemon ALL=(GLOBUSUSERS)         \
 NOPASSWD: /usr/local/osg-ce/globus/libexec/globus-gridmap-and-execute         \
 -g /etc/grid-security/grid-mapfile          /usr/local/osg-ce/globus/libexec/globus-gram-local-proxy-tool * 
</pre>

---++ Known issues

---++ More information

Refer to the [[EdgMkgridmapTroubleshootingGuide][edg-mkgridmap troubleshooting guide]] for any problems/errors.

%STOPINCLUDE% 

---++ *Comments*
%COMMENT{type="tableappend"}%

<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = StevenTimm

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = ComputeElement

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = Installation
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %NO%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %YES%


 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = IwonaSakrejda
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %IN_PROGRESS%


############################################################################################################
-->
