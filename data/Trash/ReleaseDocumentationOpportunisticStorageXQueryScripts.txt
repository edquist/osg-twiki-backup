%META:TOPICINFO{author="TedHesselroth" date="1248970797" format="1.1" reprev="1.3" version="1.3"}%
%META:TOPICPARENT{name="OpportunisticStorage"}%
---+!! *<noop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%

---++++ Composition of Commands

The commands to be composed are first described abstractly, the variables coming from either user inputs of XPath expressions. The definitions here will later be expressed as XQuery scripts, runnable against the information service. 

Endpoints are the same regardless of SRM client used. Different client implementations use different argument lists, hence a different xquery script for each implementation.

---+++++ Space Reservation

SRM_SERVICE_ENDPOINT is the value of <nop>GlueSEUniqueID in the <nop>GlueSE element of a site's BDII information.

---++++++ srm-reserve-space  
<verbatim>
srm-reserve-space -space_description=$DESCRIPTION -desired_size=$REQUESTED_SIZE -guaranteed_size=$GUARANTEED_SIZE -lifetime=$LIFETIME $SRM_SERVICE_ENDPOINT
</verbatim>

---++++++ srm-sp-reserve  
<verbatim>
srm-sp-reserve -serviceurl $SRM_SERVICE_ENDPOINT -size $REQUESTED_SIZE -gsize $GUARANTEED_SIZE -lifetime $LIFETIME
</verbatim>


---+++++ SRM Copy

The commands use the service URL, defined as

---++++++ SURL
<verbatim>
$SRM_SERVICE_ENDPOINT?SFN=$VO_PATH/filename
</verbatim>

SRM_SERVICE_ENDPOINT and VO_PATH are as defined in previous sections. Additional directory levels may be placed between VO_PATH and filename. They are created on the storage element if they do not exist.

---++++++ srmcp  
<verbatim>
srmcp -srm_protocol_version=2 -space_token=$SPACE_TOKEN file:////path/to/file $SURL
</verbatim>

SPACE_TOKEN is that returned by the above space reservation command. It is optional but should be used for SCEC production.

---++++++ srm-copy  
<verbatim>
srm-copy file:////path/to/file $SURL -spacetoken $SPACE_TOKEN
</verbatim>

---++++ XQuery Scripts

These scripts define the composition of storage-related commands based on Glue Schema. The scripts can be run on the OSG BDII service using the OSG Storage Discovery tool. Links to the project development pages can be found at [[http://cd-97177.fnal.gov:8088/wiki/xpathsearch][XPathSearch Development Site]]. For example, the xquery for SURL based on VO name can be run by invoking

<verbatim>
xquerybase ../osg-discovery-0.5-r217/bin/find_surls_for_vo.xq vo=engage
</verbatim>

or more conveniently by the supplied wrapper script

<verbatim>
find_surls_for_vo vo=engage
</verbatim>

---+++++ srm-reserve-space

*Script Name*

srm_reserve_space.xq

*Parameters*
%TABLE{ headerbg="#eeeeee" headercolor="#000000" databg="#ffffff" tableborder="1" columnwidths="120," cellpadding="2" cellspacing="1" dataalign="left" valign="top" sort="off"}%
| *name* | *definition* | *required* |
|  vo | VO Name | yes |
| description | user-supplied description | no |
| requested_size | Size of reservation in bytes | yes |
| guaranteed_size | Size to be guaranteed in bytes | no |
| lifetime | Time to expiration | no |
| storage_element_id | <nop>GlueSEUniqueID | no |
Non-required parameters should be supplied with a value of "".

*Script*
<verbatim>
xquery version "1.0";

declare variable $storage_element_id as xs:string external;
declare variable $vo as xs:string external;
declare variable $description as xs:string external;
declare variable $requested_size as xs:string external;
declare variable $guaranteed_size as xs:string external;
declare variable $lifetime as xs:string external;

declare variable $description_arg := if ($description="") then '' else concat(" -space_description=", $description);
declare variable $requested_size_arg := if ($requested_size="") then '' else concat(" -desired_size=", $requested_size);
declare variable $guaranteed_size_arg := if ($guaranteed_size="") then '' else concat(" -guaranteed_size=", $guaranteed_size);
declare variable $lifetime_arg := if ($lifetime="") then '' else concat(" -lifetime=", $lifetime);

if ($storage_element_id="") then
string-join(
for $voinfo in //GlueSE/GlueSEControlProtocol[@GlueSEControlProtocolVersion='2.2.0']/../GlueSA/GlueVOInfo[@GlueVOInfoAccessControlBaseRule=$vo]
  let $endpoint := $voinfo/../../GlueSEControlProtocol[@GlueSEControlProtocolVersion='2.2.0']/@GlueSEControlProtocolEndpoint
  return
  concat("srm-reserve-space", $description_arg, $requested_size_arg, $guaranteed_size_arg, $lifetime_arg, " srm", substring($endpoint, 6), "&#xA;"), 
"")
else
string-join(
for $voinfo in //GlueSE[@GlueSEUniqueID=$storage_element_id]/GlueSEControlProtocol[@GlueSEControlProtocolVersion='2.2.0']/../GlueSA/GlueVOInfo[@GlueVOInfoAccessControlBaseRule=$vo]
  let $endpoint := $voinfo/../../GlueSEControlProtocol[@GlueSEControlProtocolVersion='2.2.0']/@GlueSEControlProtocolEndpoint
  return
  concat("srm-reserve-space", $description_arg, $requested_size_arg, $guaranteed_size_arg, $lifetime_arg, " srm", substring($endpoint, 6), "&#xA;"), 
"")
</verbatim>

*Example Output*
<verbatim>
[tdh@camp5 xquery]$ ../osg-discovery-0.5-r225/bin/srm_reserve_space vo=engage description=mydesc requested_size=3000 guaranteed_size=2000 lifetime=1000
srm-reserve-space -space_description=mydesc -desired_size=3000 -guaranteed_size=2000 -lifetime=1000 srm://abitibi.sbgrid.org:8443/srm/managerv2
srm-reserve-space -space_description=mydesc -desired_size=3000 -guaranteed_size=2000 -lifetime=1000 srm://sigmorgh.hpcc.ttu.edu:49443/srm/v2/server.
srm-reserve-space -space_description=mydesc -desired_size=3000 -guaranteed_size=2000 -lifetime=1000 srm://se01.cmsaf.mit.edu:8443/srm/managerv2
srm-reserve-space -space_description=mydesc -desired_size=3000 -guaranteed_size=2000 -lifetime=1000 srm://cit-se.ultralight.org:8443/srm/managerv2
srm-reserve-space -space_description=mydesc -desired_size=3000 -guaranteed_size=2000 -lifetime=1000 srm://cit-se.ultralight.org:8443/srm/managerv2
srm-reserve-space -space_description=mydesc -desired_size=3000 -guaranteed_size=2000 -lifetime=1000 srm://cit-se2.ultralight.org:8443/srm/v2/server
srm-reserve-space -space_description=mydesc -desired_size=3000 -guaranteed_size=2000 -lifetime=1000 srm://ff-se.unl.edu:8443/srm/v2/server
srm-reserve-space -space_description=mydesc -desired_size=3000 -guaranteed_size=2000 -lifetime=1000 srm://fndca1.fnal.gov:8443/srm/managerv2
srm-reserve-space -space_description=mydesc -desired_size=3000 -guaranteed_size=2000 -lifetime=1000 srm://srm.unl.edu:8443/srm/managerv2
srm-reserve-space -space_description=mydesc -desired_size=3000 -guaranteed_size=2000 -lifetime=1000 srm://srm.ihepa.ufl.edu:8443/srm/managerv2
srm-reserve-space -space_description=mydesc -desired_size=3000 -guaranteed_size=2000 -lifetime=1000 srm://osg-east.hms.harvard.edu:10443/srm/v2/server
srm-reserve-space -space_description=mydesc -desired_size=3000 -guaranteed_size=2000 -lifetime=1000 srm://osg.hpcc.nd.edu:8443/srm/managerv2
srm-reserve-space -space_description=mydesc -desired_size=3000 -guaranteed_size=2000 -lifetime=1000 srm://dcache07.unl.edu:8443/srm/v2/server
</verbatim>

---+++++ srm-sp-reserve

*Script Name*

srm_sp_reserve.xq

*Parameters*
%TABLE{ headerbg="#eeeeee" headercolor="#000000" databg="#ffffff" tableborder="1" columnwidths="120," cellpadding="2" cellspacing="1" dataalign="left" valign="top" sort="off"}%
| *name* | *definition* | *required* |
|  vo | VO Name | yes |
| description | user-supplied description | no |
| requested_size | Size of reservation in bytes | yes |
| guaranteed_size | Size to be guaranteed in bytes | no |
| lifetime | Time to expiration | no |
| storage_element_id | <nop>GlueSEUniqueID | no |
Non-required parameters should be supplied with a value of "".

*Script*
<verbatim>
xquery version "1.0";

declare variable $storage_element_id as xs:string external;
declare variable $vo as xs:string external;
declare variable $description as xs:string external;
declare variable $requested_size as xs:string external;
declare variable $guaranteed_size as xs:string external;
declare variable $lifetime as xs:string external;

declare variable $description_arg := if ($description="") then '' else concat(" -userdesc ", $description);
declare variable $requested_size_arg := if ($requested_size="") then '' else concat(" -size ", $requested_size);
declare variable $guaranteed_size_arg := if ($guaranteed_size="") then '' else concat(" -gsize ", $guaranteed_size);
declare variable $lifetime_arg := if ($lifetime="") then '' else concat(" -lifetime ", $lifetime);

if ($storage_element_id="") then
string-join(
for $voinfo in //GlueSE/GlueSEControlProtocol[@GlueSEControlProtocolVersion='2.2.0']/../GlueSA/GlueVOInfo[@GlueVOInfoAccessControlBaseRule=$vo]
  let $endpoint := $voinfo/../../GlueSEControlProtocol[@GlueSEControlProtocolVersion='2.2.0']/@GlueSEControlProtocolEndpoint
  return
  concat("srm-sp-reserve", " -serviceurl", " srm", substring($endpoint, 6), $requested_size_arg, $guaranteed_size_arg, $lifetime_arg, $description_arg, "&#xA;"), 
"")
else
string-join(
for $voinfo in //GlueSE[@GlueSEUniqueID=$storage_element_id]/GlueSEControlProtocol[@GlueSEControlProtocolVersion='2.2.0']/../GlueSA/GlueVOInfo[@GlueVOInfoAccessControlBaseRule=$vo]
  let $endpoint := $voinfo/../../GlueSEControlProtocol[@GlueSEControlProtocolVersion='2.2.0']/@GlueSEControlProtocolEndpoint
  return
  concat("srm-sp-reserve", " -serviceurl", " srm", substring($endpoint, 6), $requested_size_arg, $guaranteed_size_arg, $lifetime_arg, $description_arg, "&#xA;"), 
"")
</verbatim>

*Example Output*
<verbatim>
[tdh@camp5 xquery]$ ../osg-discovery-0.5-r225/bin/srm_sp_reserve vo=engage description=mydesc requested_size=3000 guaranteed_size=2000 lifetime=1000
srm-sp-reserve -serviceurl srm://abitibi.sbgrid.org:8443/srm/managerv2 -size 3000 -gsize 2000 -lifetime 1000 -userdesc mydesc
srm-sp-reserve -serviceurl srm://sigmorgh.hpcc.ttu.edu:49443/srm/v2/server. -size 3000 -gsize 2000 -lifetime 1000 -userdesc mydesc
srm-sp-reserve -serviceurl srm://se01.cmsaf.mit.edu:8443/srm/managerv2 -size 3000 -gsize 2000 -lifetime 1000 -userdesc mydesc
srm-sp-reserve -serviceurl srm://cit-se.ultralight.org:8443/srm/managerv2 -size 3000 -gsize 2000 -lifetime 1000 -userdesc mydesc
srm-sp-reserve -serviceurl srm://cit-se.ultralight.org:8443/srm/managerv2 -size 3000 -gsize 2000 -lifetime 1000 -userdesc mydesc
srm-sp-reserve -serviceurl srm://cit-se2.ultralight.org:8443/srm/v2/server -size 3000 -gsize 2000 -lifetime 1000 -userdesc mydesc
srm-sp-reserve -serviceurl srm://ff-se.unl.edu:8443/srm/v2/server -size 3000 -gsize 2000 -lifetime 1000 -userdesc mydesc
srm-sp-reserve -serviceurl srm://fndca1.fnal.gov:8443/srm/managerv2 -size 3000 -gsize 2000 -lifetime 1000 -userdesc mydesc
srm-sp-reserve -serviceurl srm://srm.unl.edu:8443/srm/managerv2 -size 3000 -gsize 2000 -lifetime 1000 -userdesc mydesc
srm-sp-reserve -serviceurl srm://srm.ihepa.ufl.edu:8443/srm/managerv2 -size 3000 -gsize 2000 -lifetime 1000 -userdesc mydesc
srm-sp-reserve -serviceurl srm://osg.hpcc.nd.edu:8443/srm/managerv2 -size 3000 -gsize 2000 -lifetime 1000 -userdesc mydesc
srm-sp-reserve -serviceurl srm://dcache07.unl.edu:8443/srm/v2/server -size 3000 -gsize 2000 -lifetime 1000 -userdesc mydesc
</verbatim>

---+++++ SURL

*Script Name*

find_surls_for_vo.xq

*Parameters*
%TABLE{ headerbg="#eeeeee" headercolor="#000000" databg="#ffffff" tableborder="1" columnwidths="120," cellpadding="2" cellspacing="1" dataalign="left" valign="top" sort="off"}%
| *name* | *definition* | *required* |
| vo | VO name | yes |

*Script*
<verbatim>
xquery version "1.0";
declare variable $vo as xs:string external;
string-join(
for $voinfo in //GlueSE/GlueSEControlProtocol[@GlueSEControlProtocolVersion='2.2.0']/../GlueSA[@GlueSAFreeOnlineSize!=0]/GlueVOInfo[@GlueVOInfoAccessControlBaseRule=$vo][@GlueVOInfoPath]
  let $rootpath := $voinfo/@GlueVOInfoPath
  let $endpoint := $voinfo/../../GlueSEControlProtocol[@GlueSEControlProtocolVersion='2.2.0']/@GlueSEControlProtocolEndpoint
    return concat("srm", substring($endpoint, 6), "?SFN=", $rootpath,  "/TESTFILE", "&#xA;"), 
"")
</verbatim>

*Example Output*
<verbatim>
[tdh@camp5 xquery]$ ../osg-discovery-0.5-r217/bin/find_surls_for_vo engage
srm://abitibi.sbgrid.org:8443/srm/managerv2?SFN=/opt/osg-shared/se/data/vo/vo/engage/TESTFILE
srm://sigmorgh.hpcc.ttu.edu:49443/srm/v2/server.?SFN=/mnt/hep/TESTFILE
srm://cit-se2.ultralight.org:8443/srm/v2/server?SFN=/mnt/hadoop/osg/TESTFILE
srm://ff-se.unl.edu:8443/srm/v2/server?SFN=/panfs/panasas/CMS/data/engage/TESTFILE
srm://fndca1.fnal.gov:8443/srm/managerv2?SFN=/pnfs/fnal.gov/usr/fermigrid/volatile/engage/TESTFILE
srm://osg-east.hms.harvard.edu:10443/srm/v2/server?SFN=/osg/storage/data/engage/TESTFILE
srm://dcache07.unl.edu:8443/srm/v2/server?SFN=/mnt/hadoop/user/engage/TESTFILE
</verbatim>

---+++++ srmcp

*Script Name*

find_srmcp.xq

*Parameters*
%TABLE{ headerbg="#eeeeee" headercolor="#000000" databg="#ffffff" tableborder="1" columnwidths="120," cellpadding="2" cellspacing="1" dataalign="left" valign="top" sort="off"}%
| *name* | *definition* | *required* |
| vo | VO name | yes |
| space_token | Token from space reservation | no |

*Script*
<verbatim>
xquery version "1.0";
declare variable $vo as xs:string external;
declare variable $space_token as xs:string external;

declare variable $space_token_arg := if ($space_token="") then '' else concat(" -space_token=", $space_token);
declare variable $cmd := concat("srmcp -srm_protocol_version=2", $space_token_arg, " file:////path/to/file");

string-join(
for $voinfo in //GlueSE/GlueSEControlProtocol[@GlueSEControlProtocolVersion='2.2.0']/../GlueSA[@GlueSAFreeOnlineSize!=0]/GlueVOInfo[@GlueVOInfoAccessControlBaseRule=$vo][@GlueVOInfoPath]
  let $rootpath := $voinfo/@GlueVOInfoPath
  let $endpoint := $voinfo/../../GlueSEControlProtocol[@GlueSEControlProtocolVersion='2.2.0']/@GlueSEControlProtocolEndpoint
    return concat($cmd, " srm", substring($endpoint, 6), "?SFN=", $rootpath,  "/TESTFILE", "&#xA;"), 
"")
</verbatim>

*Example Output*
<verbatim>
[tdh@camp5 xquery]$ ../osg-discovery-0.5-r217/bin/find_srmcp vo=engage space_token=12345
srmcp -srm_protocol_version=2 -space_token=12345 file:////path/to/file srm://abitibi.sbgrid.org:8443/srm/managerv2?SFN=/opt/osg-shared/se/data/vo/vo/engage/TESTFILE
srmcp -srm_protocol_version=2 -space_token=12345 file:////path/to/file srm://sigmorgh.hpcc.ttu.edu:49443/srm/v2/server.?SFN=/mnt/hep/TESTFILE
srmcp -srm_protocol_version=2 -space_token=12345 file:////path/to/file srm://cit-se2.ultralight.org:8443/srm/v2/server?SFN=/mnt/hadoop/osg/TESTFILE
srmcp -srm_protocol_version=2 -space_token=12345 file:////path/to/file srm://ff-se.unl.edu:8443/srm/v2/server?SFN=/panfs/panasas/CMS/data/engage/TESTFILE
srmcp -srm_protocol_version=2 -space_token=12345 file:////path/to/file srm://fndca1.fnal.gov:8443/srm/managerv2?SFN=/pnfs/fnal.gov/usr/fermigrid/volatile/engage/TESTFILE
srmcp -srm_protocol_version=2 -space_token=12345 file:////path/to/file srm://osg-east.hms.harvard.edu:10443/srm/v2/server?SFN=/osg/storage/data/engage/TESTFILE
srmcp -srm_protocol_version=2 -space_token=12345 file:////path/to/file srm://dcache07.unl.edu:8443/srm/v2/server?SFN=/mnt/hadoop/user/engage/TESTFILE
</verbatim>

---+++++ srm-copy

*Script Name*

find_srm_copy.xq

*Parameters*
%TABLE{ headerbg="#eeeeee" headercolor="#000000" databg="#ffffff" tableborder="1" columnwidths="120," cellpadding="2" cellspacing="1" dataalign="left" valign="top" sort="off"}%
| *name* | *definition* | *required* |
| vo | VO name | yes |
| space_token | Token from space reservation | no |

*Script*
<verbatim>
xquery version "1.0";
declare variable $vo as xs:string external;
declare variable $space_token as xs:string external;

declare variable $space_token_arg := if ($space_token="") then '' else concat(" -spacetoken ", $space_token);

string-join(
for $voinfo in //GlueSE/GlueSEControlProtocol[@GlueSEControlProtocolVersion='2.2.0']/../GlueSA[@GlueSAFreeOnlineSize!=0]/GlueVOInfo[@GlueVOInfoAccessControlBaseRule=$vo][@GlueVOInfoPath]
  let $rootpath := $voinfo/@GlueVOInfoPath
  let $endpoint := $voinfo/../../GlueSEControlProtocol[@GlueSEControlProtocolVersion='2.2.0']/@GlueSEControlProtocolEndpoint
    return concat("srm-copy file:////path/to/file", " srm", substring($endpoint, 6), "?SFN=", $rootpath,  "/TESTFILE", $space_token_arg, "&#xA;"), 
"")
</verbatim>

*Example Output*
<verbatim>
[tdh@camp5 xquery]$ ../osg-discovery-0.5-r217/bin/find_srm_copy vo=engage space_token=12345
srm-copy file:////path/to/file srm://abitibi.sbgrid.org:8443/srm/managerv2?SFN=/opt/osg-shared/se/data/vo/vo/engage/TESTFILE -spacetoken 12345
srm-copy file:////path/to/file srm://sigmorgh.hpcc.ttu.edu:49443/srm/v2/server.?SFN=/mnt/hep/TESTFILE -spacetoken 12345
srm-copy file:////path/to/file srm://cit-se2.ultralight.org:8443/srm/v2/server?SFN=/mnt/hadoop/osg/TESTFILE -spacetoken 12345
srm-copy file:////path/to/file srm://ff-se.unl.edu:8443/srm/v2/server?SFN=/panfs/panasas/CMS/data/engage/TESTFILE -spacetoken 12345
srm-copy file:////path/to/file srm://fndca1.fnal.gov:8443/srm/managerv2?SFN=/pnfs/fnal.gov/usr/fermigrid/volatile/engage/TESTFILE -spacetoken 12345
srm-copy file:////path/to/file srm://dcache07.unl.edu:8443/srm/v2/server?SFN=/mnt/hadoop/user/engage/TESTFILE -spacetoken 12345
</verbatim>
-- Main.TedHesselroth - 29 Jul 2009
