%META:TOPICINFO{author="RobertEngel" date="1276652947" format="1.1" reprev="1.34" version="1.34"}%
%META:TOPICPARENT{name="ValidatingComputeElement"}%
---+!! *<nop>%SPACEOUT{ "%TOPIC%" }%*
%DOC_STATUS_TABLE%
%TOC{depth="2"}%

---++ About this Document

%ICON{hand}% This document is for OSG users. Simple tests will be introduced which may help testing the correct authentication with and operation of grid resources. This document also provides a _step-by-step guide_ to determine the approximate cause of an error followed by recommendations on how to fix it.

%STARTINCLUDE%
%BR%

%EDITTHIS%
%BR%


---++ Authentication Test

The purpose of your [[ReleaseDocumentation/CertificateWhatIs][grid certificate]] is to authenticate yourself with every service provided by a _%LINK_GLOSSARY_CE%_. The authentication process is based on the [[http://en.wikipedia.org/wiki/X.509][X.509 Public Key Infrastructure]] which consists of a private key (=userkey.pem=) and a public key (=usercert.pem=). Both files are by default located in =$HOME/.globus=:

<pre class="screen">
[robert@osg-job ~]$ ls -al $HOME/.globus
total 68
drwxr-x---  4 robert robert  4096 Mar 18 18:50 .
drwx------ 29 robert robert 12288 Jul 28 08:38 ..
drwxrwxr-x  5 robert robert  4096 Jul 20 11:18 .gass_cache
drwx------  4 robert robert  4096 Mar 27 12:14 job
-rw-r-----  1 robert robert  1724 Dec 16  2008 usercert.pem
-r--------  1 robert robert  1919 Dec 16  2008 userkey.pem
</pre>

To display detailed information about your grid certificate %HELP_GRID_PROXY_INFO% can be used:

<pre class="screen">
[robert@osg-job ~]$ grid-proxy-info
subject  : /DC=org/DC=doegrids/OU=People/CN=Robert Engel 392994/CN=1692124231
issuer   : /DC=org/DC=doegrids/OU=People/CN=Robert Engel 392994
identity : /DC=org/DC=doegrids/OU=People/CN=Robert Engel 392994
type     : Proxy draft (pre-RFC) compliant impersonation proxy
strength : 512 bits
path     : /tmp/x509up_u500
timeleft : 291:11:00  (12.1 days)
</pre>

_Identity_ is sometimes also referred to as _Grid Identity_ or more frequently as _%LINK_GLOSSARY_DN%_. The last line of the output above indicates how long your current grid proxy will be valid. A grid proxy is said to have _expired_ if there is not time left on it. To _renew_  your grid proxy the program %HELP_GRID_PROXY_INIT% is used together with your grid password:

<pre class="screen">
[robert@osg-job ~]$ grid-proxy-init -valid 500:00
Your identity: /DC=org/DC=doegrids/OU=People/CN=Robert Engel 392994
Enter GRID pass phrase for this identity:
Creating proxy ................................. Done
Your proxy is valid until: Tue Aug 18 08:06:35 2009
</pre>

---++ Mapping Test

A valid grid proxy does not guarantee that you may successfully authenticate with a remote grid resource. For a successful authentication your _%LINK_GLOSSARY_DN%_ must be _mapped_ on the remote resource. A simple and quick way to check if your *DN* is mapped is to use %HELP_GLOBUSRUN%:

<pre class="screen">
[ligo@osg-ldg ~]$ globusrun -a -r osg-ce.ligo.caltech.edu

GRAM Authentication test successful
</pre>

%NOTE% This example requires the _Grid Resource Allocation Manager (%LINK_GLOSSARY_GRAM%)_ to be available on the resource. This is usually the case on a _%LINK_GLOSSARY_CE%_, but not on a  _%LINK_GLOSSARY_SE%_. If you want to test authentication with a Storage Element, use the next example instead.

---++ Data Transfer Test

Data can be transferred to and from a grid resource using a version of ftp that supports grid authentication called _%LINK_GLOSSARY_GRIDFTP%_. The %HELP_GLOBUS_URL_COPY% command can be used for that purpose.

To verify that !GridFTP is working correctly we will 

   1 create a file using =dd=
   1 transfer the file _to_ the grid resource using =globus-url-copy=
   1 transfer the file back _from_ the grid resource using =globus-url-copy=
   1 compare both files using =diff=

First let's create the test file:

<pre class="screen">
[robert@osg-job ~]$ dd if=/dev/zero of=/tmp/osg-ce.ligo.caltech.edu.test.0 bs=1k count=1024
1024+0 records in
1024+0 records out
1048576 bytes (1.0 MB) copied, 0.005332 seconds, 197 MB/s
</pre>

Next let's transfer the file using %HELP_GLOBUS_URL_COPY%:

<pre class="screen">
[robert@osg-job ~]$ globus-url-copy file:///tmp/osg-ce.ligo.caltech.edu.test.0 gsiftp://osg-ce.ligo.caltech.edu/~/osg-ce.ligo.caltech.edu.test.0
[robert@osg-job ~]$ echo $?
0
</pre>

To copy the file back to your resource use:

<pre class="screen">
[robert@osg-job ~]$ globus-url-copy gsiftp://osg-ce.ligo.caltech.edu/~/osg-ce.ligo.caltech.edu.test.0 file:///tmp/osg-ce.ligo.caltech.edu.test.1
[robert@osg-job ~]$ echo $?
0
</pre>

Finally let's compare the _original_ with the _copy_ received back from the remote resource:

<pre class="screen">
[robert@osg-job ~]$ diff /tmp/osg-ce.ligo.caltech.edu.test.0  /tmp/osg-ce.ligo.caltech.edu.test.1
[robert@osg-job ~]$ echo $?
0
</pre>

%NOTE% The =file= protocol in the *URI* is used for files on a local file system. In this case no authentication is performed with the local resource before the file is read or written. Replacing =file= by =gsiftp= always requires a %LINK_GLOSSARY_GRIDFTP% server running at the resource specified in the URI.

 
---++ Job Submission Test

---+++ Job Submission using GRAM

The <b>G</b>rid <b>R</b>esource <b>A</b>llocation <b>M</b>anager (%LINK_GLOSSARY_GRAM%) is a service running on a %LINK_GLOSSARY_CE% that services your job submission request and which puts your job into execution after successful authentication.

Here we use the %HELP_GLOBUS_JOB_RUN% command to execute the =id= command on the remote resource using the default *fork* %LINK_GLOSSARY_JM%:
 
<pre class="screen">
[robert@osg-job ~]$ globus-job-run osg-ce.ligo.caltech.edu /usr/bin/id
uid=506(ligo) gid=506(ligo) groups=506(ligo)
</pre>

Upon success =/usr/bin/id= returns information about the user account which has been used to execute the program itself on the grid resource. This is the account that your _%LINK_GLOSSARY_DN% is mapped to_. Unlike the [[ReleaseDocumentation/CESimpleTest#Mapping_Test][Mapping Test]] this test also verifies that the account exists and that the job manager was able to run the command on your behalf on the compute element.

%NOTE% Please open a ticket with the %LINK_GOC_OPEN_TICKET% for the resource in case the command did not succeed.

---+++ Test the Availability of a Job Manager

A _%LINK_GLOSSARY_JM%_ is a process running on the _%LINK_GLOSSARY_CE%_ which is managing the execution of your job. By default the job manager =fork= will be used to _fork_ your program directly on the compute element. As a general rule of thumb you should %RED%avoid to use fork%ENDCOLOR% and to execute programs on the compute element unless that is your intention. A not complete list of job managers includes =fork=, =managedfork=, =ccs=, =condor=, =lsf=, =pbs= and =sge=. Depending on the setup of the grid resource more than one job manager may be supported.

Just like in the previous example we can use %HEP_GLOBUS_JOB_RUN% to verify that the =fork= job manager is available and used for the execution:

<pre class="screen">
[robert@osg-job ~]$ globus-job-run osg-ce.ligo.caltech.edu/jobmanager-fork /usr/bin/id
uid=506(ligo) gid=506(ligo) groups=506(ligo)
</pre>

Notice how we append =/jobmanager-fork= to the grid resource to explicitly request it. This can be used to detect if a certain job managers such as =condor= is available:

<pre class="screen">
[robert@osg-job ~]$ globus-job-run osg-ce.ligo.caltech.edu/jobmanager-condor /bin/hostname
dom118
</pre>

Because the job is scheduled to be executed through _%LINK_GLOSSARY_CONDOR%_ this command will likely require more time to complete. Here we used the =/bin/hostname= command to return the _hostname_ of the worker node executing the job. To specify a job manager that is not supported by the grid resource creates a convenient way to find out what job managers are supported by the resource from the comfort of the command line:

<pre class="screen">
[robert@osg-job ~]$ globus-job-run osg-ce.ligo.caltech.edu/jobmanager-pbs /bin/hostname
GRAM Job submission failed because the gatekeeper failed to find the requested service (error code 93)
[robert@osg-job ~]$ echo $?
93
</pre>

%NOTE% The <b>names for job managers are case sensitive</b> and are <b>all lower case for %LINK_GLOSSARY_GRAM%</b>.

<!-- missing section waiting to be written 
---+++ Job Submission using GRAM-WS
-->

---++ Troubleshooting

---+++ !GridFTP

Several causes can make the [[ReleaseDocumentation/CESimpleTest#Data_Transfer_Test][Data Transfer Test]] fail:

   1 the !GridFTP daemon is not answering on the default port =2811= or the remote resource is down
   1 the directory on the server where you want to write does not exist
   1 the directory on the server where you want to write is mounted read-only
   1 your unix account on the server side does not give you access to the directory you want to access for writing

Here we assume that you successfully completed the [[ReleaseDocumentation/CESimpleTest#Mapping_Test][Mapping Test]].

---++++ Test that the !GridFTP service is answering on the default port 2811

Here we will use =telnet= to connect to the default !GridFTP port =2811= on the server side:

<pre class="screen">
robert@osg-job ~]$ telnet osg-ce.ligo.caltech.edu 2811
Trying 131.215.114.48...
Connected to osg-ce.ligo.caltech.edu (131.215.114.48).
Escape character is '^]'.
220 osg-ce.ligo.caltech.edu GridFTP Server 2.8 (gcc64dbg, 1217607445-63) [VDT patched 4.0.8] ready.
Connection closed by foreign host.
</pre>

!GridFTP is available if you received a 'Connected to ...' message. Otherwise you may want to contact the %LINK_GOC_OPEN_TICKET% and submit a trouble ticket for the resource!

---++++ Test that the target directory on the !GridFTP server exists

Here we will use =globus-job-run= to remotely view the target directory on the !GridFTP server:

<pre class="screen">
[robert@osg-job ~]$ globus-job-run osg-ce.ligo.caltech.edu /bin/bash -c "ls -al ~"
total 17632
drwxr-xr-x 18 ligo ligo    69632 Jun 14 18:40 .
drwxr-xr-x 43 root root     4096 Jun  8 14:06 ..
-rw-------  1 ligo ligo     1118 Jun 14 16:34 .Xauthority
-rw-------  1 ligo ligo    27105 Jun 10 19:50 .bash_history
-rw-------  1 ligo ligo       33 Jan 21  2009 .bash_logout
-rw-------  1 ligo ligo      414 Sep 28  2009 .bash_profile
-rwx------  1 ligo ligo      225 Jul 14  2009 .bashrc
drwx------  4 ligo ligo     4096 Dec  7  2009 .globus
-rw-rw-r--  1 ligo ligo       36 Mar 17 20:55 .gnuplot_history
-rw-------  1 ligo ligo       42 May 28 12:22 .lesshst
drwxrwxr-x  3 ligo ligo     4096 Aug 22  2009 .mc
drwx------  2 ligo ligo     4096 Apr 22 15:10 .ssh
drwx------  3 ligo ligo     4096 Jun 13  2009 .subversion
-rwxr-xr-x  1 ligo ligo    10582 Jun  8 10:11 .viminfo
-rw-r--r--  1 ligo ligo  1048576 Jun 14 18:13 osg-ce.ligo.caltech.edu.test.0
</pre>

If the directory is not available you can _try_ to create it using =globus-job-run= 

<pre class="screen">
[robert@osg-job ~]$ globus-job-run osg-ce.ligo.caltech.edu /bin/bash -c "mkdir -p /tmp/example"
[robert@osg-job ~]$ echo $?
0
</pre>

If you are certain that the directory should exist on the server, you may want to contact the %LINK_GOC_OPEN_TICKET% and submit a trouble ticket for the resource!

---++++ Test that the target directory on the !GridFTP server is not mounted read-only

<pre class="screen">
[robert@osg-job ~]$ globus-job-run osg-ce.ligo.caltech.edu /bin/bash -c "/bin/mount"
/dev/mapper/VolGroup00-LogVol00 on / type ext3 (rw)
proc on /proc type proc (rw)
sysfs on /sys type sysfs (rw)
devpts on /dev/pts type devpts (rw,gid=5,mode=620)
/dev/xvda1 on /boot type ext3 (rw)
tmpfs on /dev/shm type tmpfs (rw)
none on /proc/sys/fs/binfmt_misc type binfmt_misc (rw)
sunrpc on /var/lib/nfs/rpc_pipefs type rpc_pipefs (rw)
10.10.1.2:/home on /home type nfs (rw,addr=10.10.1.2)
fuse on /mnt/hadoop type fuse (rw,nosuid,nodev,allow_other,default_permissions)
</pre>

%NOTE% This test will only return a meaningful result for partitions that are _mounted_. It will not report partitions that are _automounted_.

If you are certain that the directory should be mounted or be mounted with write-access, you may want to contact the %LINK_GOC_OPEN_TICKET% and submit a trouble ticket for the resource!

---++++ Test that your remote unix account has sufficient privileges

Please compare the result of =id= on the server side:

<pre class="screen">
[robert@osg-job ~]$ globus-job-run osg-ce.ligo.caltech.edu /bin/bash -c "id"
uid=506(ligo) gid=506(ligo) groups=506(ligo)
</pre>

with the ownership and group membership information of the target directory on the !GridFTP server.

If you are certain that the directory should be mounted or be mounted with write-access, you may want to contact the %LINK_GOC_OPEN_TICKET% and submit a trouble ticket for the resource!

---+++ GRAM

Several causes can make the [[ReleaseDocumentation/CESimpleTest#Job_Submission_Test][Job Submission Test]] fail:

   1 the !GRAM daemon is not answering on the default port =2911= or the remote resource is down
   1 your Distinguished Name is mapped to a unix account that does not exist
   1 you are trying to access a *jobmanager* that is not supported on the remote resource

Here we assume that you successfully completed the [[ReleaseDocumentation/CESimpleTest#Authentication_Test][Authentication Test]].

---++++ Test that the GRAM service is answering on the default port 2911

Here we will use =telnet= to connect to the default GRAM port =2911= on the server side:

<pre class="screen">
[robert@osg-job ~]$ telnet osg-ce.ligo.caltech.edu 2119
Trying 131.215.114.48...
Connected to osg-ce.ligo.caltech.edu (131.215.114.48).
Escape character is '^]'.
Connection closed by foreign host.
</pre>

GRAM is running if you receive a 'Connected to ...' message. Otherwise you may want to contact the %LINK_GOC_OPEN_TICKET% to open a trouble ticket for the resource.

---++++ Test that your Distinguished Name is mapped to an unknown unix account

In this case the [[ReleaseDocumentation/CESimpleTest#Mapping_Test][Mapping Test]] will succeed, but the jobmanager will report that it failed to put the job into execution. Please open a ticket with the %LINK_GOC_OPEN_TICKET%.

---++++ Test if a jobmanager is supported

By default jobamanager *fork* is used to execute your command on the gatekeeper. To test if a different jobamanager is supported by the resource, try to submit the =id= command to the jobmanager:

<pre class="screen">
[robert@osg-job ~]$ globus-job-run osg-ce.ligo.caltech.edu:2119/jobmanager-pbs /bin/bash -c "id"
GRAM Job submission failed because the gatekeeper failed to find the requested service (error code 93)
</pre>

The list of known jobmanagers supported by GRAM includes =fork=, =managedfork=, =condor=, =sge=, =pbs=, =lsf=, =ccs=. The spelling is _case-sensitive_ and differs slightly for *GRAM-WS*: =Fork=, =ManagedFork=, =Condor=, =SGE=, =PBS=, =LSF=, =CCS=! To complicate matters further it is called a 'FactoryType' by *GRAM-WS*.

Please open a ticket with the %LINK_GOC_OPEN_TICKET% if you are certain that the jobmanager you provided should be supported by the resource.

%STOPINCLUDE%

---++ *Comments*
| Just a test | Main.RobertEngel | 18 Mar 2010 - 23:00 |
%COMMENT{type="tableappend"}%

<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = RobertEngel

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = ComputeElement

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = HowTo
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %YES%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %YES%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %YES%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = SuchandraThapa
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %YES%


 DEAR DOCUMENT TESTER
 ====================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = IwonaSakrejda
 Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %YES%
############################################################################################################
-->

%META:TOPICMOVED{by="ForrestChristian" date="1166042277" from="Integration.CESimpleTest050" to="Integration/ITB_0_5.CESimpleTest"}%
