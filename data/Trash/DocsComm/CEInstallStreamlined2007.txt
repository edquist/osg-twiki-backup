%META:TOPICINFO{author="KyleGross" date="1225985934" format="1.1" version="1.12"}%
%LINKCSS%

<!-- This is the default OSG Integration template. Please modify it in the sections indicated to create your topic! --> 

<!-- By default the title is the WikiWord used to create this topic !-->
<!-- if you want to modify it to something more meaningful, just replace %TOPIC% below with i.e "My Topic"!-->

---+!! %SPACEOUT{ "%TOPIC%" }%
%TOC%

%STARTINCLUDE%
%EDITTHIS%

<!-- taken from ITB_0_5/AH_CEInstallGuideRootCondorNoSE -->

%INCLUDE{"ReleaseDocumentation.BeforeStartingComputeElementInstallation"}%
%INCLUDE{"ReleaseDocumentation.DocumentationConventions"}%
%INCLUDE{"ReleaseDocumentation.PacmanInstall"}%
%INCLUDE{"ReleaseDocumentation.PreInstallationChecklistCE"}%
%INCLUDE{"ReleaseDocumentation.WorkerNodeClient"}%

%INCLUDE{"AH_CEInstallingServicesRootCondorNoSE"}%
To see what version of the OSG CE software you've installed and what services came along, run:
<pre class="screen">
# <b>source $VDT_LOCATION/setup.sh </b>
# <b>./osg-version </b>
 and
# <b>vdt-version </b>
</pre>
For more info, see [[AH_CESoftWareDiscover]]. (Note that the GUMS client gets installed with the CE, but does not show up on this list.)

---++ Obtain and Configure PKI Certificates
You will have to obtain at least a host certificate and possibly others.  For testing purposes later on, you'll need a personal certificate, too.  The [[AH_CEConfigurePKI]] document takes you through the process. If you already have these certificates, it tells you where to copy them and what permissions to give them.  Ignoring your personal certificate, here's what you want to end up with:
<pre class="screen">
<i>... in /etc/grid-security ...</i>
-r--r--r--    1 root     root         1469 May 15 16:44 hostcert.pem
-r--------    1 root     root         1679 May 15 16:46 hostkey.pem
drwxr-xr-x    2 daemon   daemon       4096 May 15 16:50 http
drwxr-xr-x    2 daemon   daemon       4096 May 15 16:48 ldap

<i>... in /etc/grid-security/ldap ...</i>
-r--r--r--    1 daemon   daemon       1473 May 15 16:48 ldapcert.pem
-r--------    1 daemon   daemon       1675 May 15 16:48 ldapkey.pem

<i>... in /etc/grid-security/http ...</i>
-r--r--r--    1 daemon   daemon       1473 May 15 16:50 httpcert.pem
-r--------    1 daemon   daemon       1679 May 15 16:50 httpkey.pem
</pre>

%RED% From Siddhartha:
If exp'd gridadmin: grid interface website, submit request on your behalf, and get it right away. Craig knows about this.
%ENDCOLOR%

---++ Configure the OSG CE software
Before you configure, invoke the =gums-host-cron= script once manually. This will create a gridmap file. This will allow you to run a simple gridmap test after configuring.
<pre class="screen">
# cd $VDT_LOCATION/gums/bin
# ./gums-host-cron
</pre>
By default it runs every 6 hours. To learn how to change the timing and other info, see [[Integration/ITB_0_5/ReleaseDocumentation.ComputeElementAuthorization#Full_privilege_mode_cron_gums_ho][gums-host-cron]]. 

To configure OSG, you'll run the =$VDT_LOCATION/monitoring/configure-osg.sh= script. You will be prompted for a lot of information. Beforehand:
   * Consult the [[AH_CESiteAdminGuide]], and make sure you've prepared for all the questions it will ask you.
   * Create the app, data, wn_tmp, site_read and site_write directories associated with local storage. (and possibly others -- for GIP, SRM, etc.%RED%How do you know?%ENDCOLOR%) 
      * Follow the appropriate links from [[AH_CESiteAdminGuide]] to find requirements on these directories. 
      * *Important:* set the directory permissions properly, as listed in [[ReleaseDocumentation.LocalStorageConfiguration]].

Now run the configuration, with the information at your fingertips:
<pre class="screen">
# cd $VDT_LOCATION/monitoring
# ./configure-osg.sh
</pre>

More information on what happens during the configuration is available at [[ReleaseDocumentation.ConfigureOSGAttributes]].

---++ Start Services
Starting and stopping services is done via the =vdt-control= script. No services are running at this point. To start them up, go to your $VDT_LOCATION, and run:
<pre class="screen">
# source setup.[c]sh
# vdt-control --on
<i>... output ...</i>
enabling cron service fetch-crl... ok
enabling cron service vdt-rotate-logs... ok
skipping init service 'gris' -- marked as disabled
enabling inetd service globus-gatekeeper... ok
enabling inetd service gsiftp... ok
enabling init service mysql... ok
enabling init service globus-ws... ok
skipping cron service 'edg-mkgridmap' -- marked as disabled
enabling cron service gums-host-cron... ok
skipping init service 'MLD' -- marked as disabled
enabling init service apache... ok
enabling init service tomcat-5... ok
enabling cron service gratia-condor... ok
</pre>
The services that are disabled are deprecated and should remain disabled.

More information about services is available in [[ReleaseDocumentation.StartingServices]].

---++ Condor Batch System

Start Condor. Then re-source the VDT setup script to continue.
<pre class="screen">
# cd $VDTSETUP_CONDOR_LOCATION
# cd ..
# source setup.[c]sh
# vdt-control --on condor
# cd $VDT_LOCATION   ###This variable isn't defined properly at this point; use the path name to this location
# source setup.[c]sh
</pre>

---++ Set up Managed Fork
To set up the Managed Fork jobmanager, run:
<pre class="screen">
# cd $VDT_LOCATION
# source $VDT_LOCATION/setup.sh
# pacman -get OSG:ManagedFork
</pre>
<!--Respond "y" to the question about trusting the cache. (this question didn't come up) -->

To set the managed fork jobmanager as the default, execute the following command.
<pre class="screen">
# $VDT_LOCATION/vdt/setup/configure_globus_gatekeeper --managed-fork y --server y
</pre>
For more information on configuring, disabling, etc., see [[ReleaseDocumentation.ManagedFork]].


---++ Globus Configuration
Globus has been pre-configured for this installation. All you need to do is start services, and you did that above, before configurating the OSG CE software.  If you want to alter the configuration, see [[ReleaseDocumentation.ConfiguringGlobusJobManagerBrief]].


%INCLUDE{"ReleaseDocumentation.CESimpleTest"}%

---++ Authorizing Users: Full Privilege with GUMS and PRIMA

The GUMS-Client package was installed with OSG CE software, and you've started the =gums-host-cron= job.  Establish local accounts on the CE to match those that will be used by the GUMS service. Your local GUMS administrator can identify these for you, or you can get the list from the =osg-user-vo-map.txt= which is generated in the steps below.

Two files need to be copied to the =/etc/grid-security= directory: =prima-authz.conf= and =gsi-authz.conf=.  
<pre class="screen">
# <b>cp $VDT_LOCATION/post-install/gsi-authz.conf /etc/grid-security/. </b>
# <b>cp $VDT_LOCATION/post-install/prima-authz.conf /etc/grid-security/. </b>
</pre>

%NOTE% =gsi-authz.conf= is the key to the callout being invoked.  If you remove this file (or rename it), the Globus services will revert to use of the <i>grid-mapfile</i>.

Edit the =/etc/grid-security/prima-authz.conf= file, changing the <b>imsContact</b> attribute to point to your GUMS service.  By default, the installation has the log file verbosity set to 'debug'.  You may want to change this to 'info' (just comment and uncomment the lines shown).

The <i>gums.authz</i> entry is only used if you wish to use the <i>gums</i> client tool to test specific mappings from this host.  Documentation of this can be found on the [[http://grid.racf.bnl.gov/GUMS/][GUMS web site]].  This same functionality can be executed using the GUMS web UI.

<pre class="programlisting">
<em>... in this example cmssrv09 was the CE node...</em>
imsContact https://<b>cmssrv09.fnal.gov</b>:8843/gums/services/GUMSAuthorizationServicePort

# logging levels supported are debug, info, error, none
logLevel    debug
#logLevel    info
</pre>

The GUMS-Client package has its essential files under =$VDT_LOCATION/gums=.
Edit the =$VDT_LOCATION/gums/etc/gums-client.properties= configuration file to point to the appropriate GUMS server:  Upon installation the file contains 2 entries both populated with the hostname of the CE node you are configuring.  In this example, cmssrv09.   %BLUE% This file editing should no longer be necessary since we set VDT_GUMS_HOST before the CE install.
%ENDCOLOR%

<pre class="programlisting">
 gums.location=https://cmssrv09:8443/gums/services/GUMSAdmin
 gums.authz=https://cmssrv09:8443/gums/services/GUMSAuthorizationServicePort
</pre>

For detailed information see [[ReleaseDocumentation.ComputeElementAuthorization]]; it discusses all authorization methods.

In the earlier test case, you only authorized yourself as a local user and used the gridmap file.  Now, before even knowing if you're set up with gums authorization, check that your system is communicating with PRIMA. In one window, run =tail -f $VDT_LOCATION/globus/var/globus-gatekeeper.log= to watch the messages.  In another window, run a job, e.g.:
<pre class="screen">
globus-job-run $(hostname -f):2119/jobmanager-fork /usr/bin/id
</pre>
In your first window, if you see messages like the following:
<pre class="screen">
 PID: 9300 -- PRIMA DEBUG prima_saml_support.cpp:456 received AuthorizationDecisionStatement
 PID: 9300 -- PRIMA DEBUG prima_saml_support.cpp:466 Parsed statement - Decision is: Deny
 PID: 9300 -- PRIMA DEBUG prima_saml_support.cpp:474 Found action: access_as_local_identity
 PID: 9300 -- PRIMA ERROR  prima_module.c:408  Identity Mapping Service did not permit mapping
</pre>
then it's working properly; you just don't have authorization in GUMS.

Now authorize yourself and other users before performing the *OSG Registration* of your service (otherwise no one but you will be able to access it!).  Do this before doing the rest of the monitoring configuration steps below, otherwise you may  have to repeat the steps later. See the information at  [[ReleaseDocumentation.ComputeElementAuthorization#Full_Privilege_Requirements][Osg CE Authorization, Full Privilege Requirements]].  In a nutshell: create local accounts on the CE to match those that will be assigned by the !GUMS service. What are those accounts? Ask your !GUMS service administrator or look at =grid3-user-vo-map.txt=. 

---+++ Retest Full Privilege Configuration
You will need a =/etc/grid-security/grid-mapfile=, (CEMon needs it to run).  The file can be empty. Run the [[ReleaseDocumentation.CEInstallGuide#Site_Verification][Site Verification]] script again locally (as a regular user, *not root*)) and verify that the authorization still works. 

To check which id you get mapped to, run (using your fully-qualified gatekeeper host in the command and your own certificate):
<pre class="screen">
 $ <b>source $VDT_LOCATION/setup.sh </b>   <em>OR $VDT_LOCATION/setup.<b>csh</b> </em>
 $ <b>grid-proxy-init </b>
    <em>(enter your passphrase)</em>
 $ <b>globus-job-run <em>your-gatekeeper-host</em>:2119/jobmanager-fork /usr/bin/id </b>
</pre>

%NOTE% Some sites may require VirtualOrganizations/VOInfo-qualified proxies.  If so, replace =grid-proxy-init= with =voms-proxy-init= in the step above.

When  authorizing in full privilege mode, you will see the following extra entry in your =$VDT_LOCATION/globus/var/globus-gatekeeper.log= file when jobs are submitted:

<pre class="programlisting">
 PID: 20269 -- PRIMA INFO  Mapping service "https://fermigrid3.fnal.gov:8443/gums/services/GUMSAuthorizationServicePort" returned local user "uscms112" for globus user "/DC=org/DC=doegrids/OU=People/CN=John Weigand 458491" 
</pre>

%NOTE% In RHEL4/SL4/Rocks 4, PRIMA requires a shared library =/usr/lib/libcom_err.so.3.0.0= which is not part of most default Redhat-like installations.  It's provided by the rpm compat-libcom_err.

---++ Installing and Configuring Globus Web Services
Instructions and configuration of WS-GRAM can be viewed at [[ReleaseDocumentation.GlobusWebServicesInstall]]. %BR%
%RED% First part "basics" contains commands that are only informational; go to Authorization Modes %ENDCOLOR%
For full privilege setup, all you need is:
<pre class="screen">
> cd $VDT_LOCATION
> source setup.sh
> ./vdt/setup/configure_prima_gt4 --enable \
               --gums-server YOUR_GUMS_SERVICE
</pre>
This brings up some messages; follow this documentation, not those messages. %BR%

Notes that haven't been turned into doc yet: %BR%
Need to do sudoers thing -- find user under which VDT has the services run: In Preinstall info, it says " if there's already a globus user, the web services container will run as globus; else as daemon.%BR%
In visudo, copy in do shift colon, then set list to check that there are no whitespaces after the slashes.%BR%
My =vdt-control --on globus-ws ...=
failed; did we forget to configure web services?%BR%
need to clone the host certs and have them owned by same owner as web services -- problem when you put in certs after ce install, which i did.
John thinks certs should be in place first. %BR%
Run
$VDT_LOCATION/vdt/setup/configure_globus_ws%BR%
and%BR%
$VDT_LOCATION/vdt/setup/configure_globus_wsgram

if it doesn't work, go see "starting services" to do the vdt register thing.

---++Monitoring Setup: !GIP and !CEMon

There is no extra installation or configuration to do for GIP or !CEMon. 
   * For information about GIP (information collected, validation web page, etc.) see [[ReleaseDocumentation.GenericInformationProvider]].
   * CEMon requires that =/etc/grid-security/grid-mapfile= exist. It can be an empty file. For more info about CEMon (about, config files, verifying that it's functional) , see [[ReleaseDocumentation.CEMonOnComputeElement]].

%INCLUDE{"ReleaseDocumentation.CESiteVerify"}%

---++ Located behind a firewall?
Grid components which are located behind a network firewall face special challenges for Grid setup and operations. See [[ReleaseDocumentation.ComputeElementFirewalls]].

---++ OSG Shutdown Guide
In VDT 1.6.1 and later, all services (=/etc/init.d=, =/etc/xinetd.d=, =cron=) should be turned on/off using the =$VDT_LOCATION/vdt/sbin/vdt-control= script.  This section will provide just a general overview. There is a <i>man</i> page available for the script, just type =man vdt-control=. You can also [[http://vdt.cs.wisc.edu/releases/1.6.1/man/vdt-control.html read the man page online]]

To view all services controlled by <i>vdt-control</i>:
<pre class="screen">
&gt; <b>source $VDT_LOCATION/setup.sh </b>
&gt; <b>vdt-control --list </b>
Service            | Type   | Desired State
-------------------+--------+--------------
fetch-crl          | cron   | enable
vdt-rotate-logs    | cron   | enable
gris               | init   | do not enable
globus-gatekeeper  | inetd  | enable
gsiftp             | inetd  | enable
mysql              | init   | enable
globus-ws          | init   | enable
edg-mkgridmap      | cron   | do not enable
gums-host-cron     | cron   | enable
MLD                | init   | enable
apache             | init   | enable
tomcat-5           | init   | enable
condor             | init   | enable
gratia-condor      | cron   | enable
</pre>

%NOTE% This is output from a fully enabled installation.

To shutdown <em>all</em> services:

<pre class="screen">
# <b>source $VDT_LOCATION/setup.sh </b>
# <b>vdt-control --off </b>
     <i>Output</i>
disabling cron service gratia-condor... ok
disabling init service condor... FAILED! (see vdt-install.log)
    found conflicting, non-VDT init service /etc/rc.d/init.d/condor
    use the --force option to stop the init service
disabling init service tomcat-5... ok
disabling init service apache... ok
disabling init service MLD... ok
disabling cron service gums-host-cron... ok
disabling cron service edg-mkgridmap... ok
disabling init service globus-ws... ok
disabling init service mysql... ok
disabling inetd service gsiftp... ok
disabling inetd service globus-gatekeeper... ok
disabling init service gris... ok
disabling cron service vdt-rotate-logs... ok
disabling cron service fetch-crl... ok
</pre>
Notice Condor failed. To shutdown Condor, go to the directory above $CONDOR_LOCATION (i.e., the directory containing the setup scripts), and shut it down individually:
<pre class="screen">
# <b>cd $CONDOR_LOCATION</b>
# <b>cd ..</b>
# <b>source setup.sh </b>
# <b>vdt-control --off  condor</b>
  <i> Output</i>
disabling init service condor... ok
</pre>

To disable any other <b>individual</b> services installed with the OSG CE software:

<pre class="screen">
# <b>source $VDT_LOCATION/setup.sh </b>
# <b>vdt-control --off  <i>service</i> </b>
</pre>


---+++/etc/xinetd.d services
For =/etc/xinetd.d= services (none for this installation), the scripts will be removed from the directory.  The =xinetd.d= daemon will be restarted.

---+++/etc/init.d services
For each of the =/etc/init.d= services (tomcat-5, apache, globus-ws, mysql), the script will be removed from the directory  and the service will be stopped.

---+++crontabs
For =root= cron entries, the entry will be removed from the crontab. %RED%Which file is this?%ENDCOLOR%

For more information see [[ReleaseDocumentation.ShuttingDownCE]]

<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.AnneHeavey - 08 May 2007%BR%
-- Main.JohnWeigand - 05 Oct 2006 - updated the "Activate your site" TOC entry for the new file and site-status script.<br>

%STOPINCLUDE%
%INCLUDE{"Integration.WhuReferences"}%


%BOTTOMMATTER%

-- Main.AnneHeavey - 16 Aug 2007

%META:TOPICMOVED{by="AnneHeavey" date="1193338340" from="Integration/ITB_0_7.CEInstallStreamlined" to="DocsComm.CEInstallStreamlined2007"}%
