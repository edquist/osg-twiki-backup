%META:TOPICINFO{author="TedHesselroth" date="1271192898" format="1.1" reprev="1.5" version="1.5"}%
%META:TOPICPARENT{name="Storage"}%
%DOC_STATUS_TABLE%
https://twiki.grid.iu.edu/twiki/pub/Storage/WebHome/images.jpg
---++++ Background

Basics from the dCache Book

%RED%What is Space Reservation?%ENDCOLOR%
<pre>%BLACK%Space reservation is a promise by the storage system to make certain amount of storage %BLACK%space %ENDCOLOR%%ENDCOLOR%</pre><pre>%BLACK%%BLACK%of certain type available for usage for a specified period of time. %ENDCOLOR% %ENDCOLOR%</pre>

%RED%How does it work?%ENDCOLOR%
<pre>%BLACK%%BLACK%Space reservation is made using srmReserveSpace function. In case of successful reservation, %ENDCOLOR%%ENDCOLOR%</pre><pre>%BLACK%%BLACK%a unique name, %ENDCOLOR%called space token is assigned to the reservation. Space token can be used during %ENDCOLOR%</pre><pre>%BLACK%the transfer operations to tell the system to put the files being manipulated or transferred into an %ENDCOLOR%</pre><pre>%BLACK%associated space reservation . A storage system ensures that the reserved amount of the disk space%ENDCOLOR%</pre><pre>%BLACK%is indeed available, thus providing a guarantee that a client does not run out of space until all space promised %ENDCOLOR%</pre><pre>%BLACK%by the reservation has been used. When files are deleted, the space is returned to the space reservation. %ENDCOLOR%</pre>

---++++ Setup 

*Steps required to get Space Reservation to work are as follows:*

<font color="red"><b>Step 1)</font></b>  <u>[[ReleaseDocumentation.PoolManager][ReleaseDocumentation.PoolManager.conf]]</u>  

<pre>     Edit ReleaseDocumentation.PoolManager.conf on the node where Pool Manager domain is running (basically Admin node). </pre>

<font color="red"><b>Step 2)</font></b>  <u>dCacheSetup</u> 

<pre>     Edit dCacheSetup on the node running SpaceManager (SRM node) to:</pre>

<font color="red">a.</font> Activate the SRM Space Manager 

    _srmSpaceManagerEnabled_ = *yes*

<font color="red">b.</font> Specify values for following parameters 

    The values specified below are the default values and can be overridden by transfer request specified by user.

            _SpaceManagerDefaultRetentionPolicy_ = *CUSTODIAL*              (Other options are REPLICA and OUTPUT)

	    _SpaceManagerDefaultAccessLatency_ = *NEARLINE*                  (Other option is ONLINE)

         To understand options available for above two parameters, read [[http://www.dcache.org/manuals/Book/cf-srm-intro.shtml][dCache Book- Chapter 14 Section 1.1.3]]

	    _SpaceManagerReserveSpaceForNonSRMTransfers_ = *false*       (Other option is true)

	    _SpaceManagerLinkGroupAuthorizationFileName_ = */opt/d-cache/etc/LinkGroupAuthorization.conf*


*A relevant note from the dCache Book:* 
</pre>
If the reservation token is not specified, and implicit space reservation is enabled, then a space reservation will be 
performed implicitly for each SRM v1.1 and SRM 2.2 srmPrepareToPut or srmCopy in pull mode. If an Access Latency 
and a Retention Policy are specified, the user defined retention policy and default access latency are used. If the user 
has not specified Access Latency or Retention Policy (or if SRM v1.1 is used) , the system will attempt to extract special tags 
(not surprisingly called AccessLatency and RetentionPolicy) from PNFS namespace from the directory to which file is being written. 
If the tags are present, then their values will determine the default Access Latency or Retention Policy that will be used for implicit 
space reservations. If the tags are not present, then system wide defaults will be used. If no implicit space reservation can be made, 
the transfer will fail. (Note: some clients also have default values, which are used when not explicitly specified by the user. I this 
case server side defaults will have no effect. ) </pre>

<font color="red"><b>Step 3)</font></b>  <u>LinkGroupAuthorization.conf</u> 

<pre>Create a LinkGroupAuthorization.conf file on the SRM node. This file is used to specify who has access to which Link Groups.</pre>

*A relevant note from the dCache Book:*   For Space Reservation to work properly, each pool should be assigned to one and only one link and each link should 
be assigned to one and only one link group.

<font color="red"><b>Step 4)</font></b>  <u>dCacheSetup</u> 

<pre>     Edit dCacheSetup on the node running GridFTP to:</pre>

<font color="red">a.</font> Activate the SRM Space Manager 

    _srmSpaceManagerEnabled_ = *yes*

---++++ Example Setup

Link groups for custodial and volatile must be set up in [[ReleaseDocumentation.PoolManager][ReleaseDocumentation.PoolManager.conf]]. It is sufficient for testing to have all pools be custodial by default.

*Steps for editing [[ReleaseDocumentation.PoolManager][ReleaseDocumentation.PoolManager.conf]]*

<font color="red">(a)</font> _Create the pools_
<pre>
psu create pool gwdca02_1
psu create pool gwdca02_2
psu create pool gwdca02_3
psu create pool gwdca01_1
psu create pool gwdca01_2
psu create pool gwdca01_3
</pre>
<font color="red">(b)</font> _Create the Pool Groups and assign pools to unique Pool Groups_

Below 2 pool groups - namely "default" and "volatile" are being created
<pre>
psu create pgroup default
psu addto  pgroup default gwdca01_1
psu addto  pgroup default gwdca01_2
psu addto  pgroup default gwdca01_3

psu create pgroup volatile
psu addto  pgroup volatile gwdca02_1
psu addto  pgroup volatile gwdca02_2
psu addto  pgroup volatile gwdca02_3
</pre>
<font color="red">(c)</font> _Create Links_
<pre>
# default - will be linkGrouped as custodial storage area
psu create link default-link any-store world-net any-protocol
psu set link default-link -readpref=10 -writepref=10 -cachepref=10 -p2ppref=-1
psu add link default-link default

# volatile - needed for linkGroups to work even if all actual storage is custodial
psu create link volatile-link any-store world-net any-protocol
psu set link volatile-link -readpref=10 -writepref=10 -cachepref=10 -p2ppref=-1
psu add link volatile-link volatile
</pre>

<font color="red">(d)</font> _Create Link Groups_
<pre>
psu create linkGroup default-link-group
psu create linkGroup volatile-link-group
</pre>
<font color="red">(e)</font> _Set properties of Link Group_

These properties determine what kind of space is associated with the link group
<pre>
psu set linkGroup attribute default-link-group HSM=any
psu set linkGroup custodialAllowed default-link-group true
psu set linkGroup onlineAllowed default-link-group true
psu set linkGroup nearlineAllowed default-link-group true
psu set linkGroup replicaAllowed default-link-group true
psu set linkGroup outputAllowed default-link-group true

psu set linkGroup attribute volatile-link-group HSM=None
psu set linkGroup custodialAllowed volatile-link-group true
psu set linkGroup onlineAllowed volatile-link-group true
psu set linkGroup nearlineAllowed volatile-link-group true
psu set linkGroup replicaAllowed volatile-link-group true
psu set linkGroup outputAllowed volatile-link-group true
</pre>
<font color="red">(f)</font> _Add links to Link Group_
<pre>
psu addto linkGroup default-link-group default-link
psu addto linkGroup volatile-link-group volatile-link
</pre>

*Sample Link Group Authorization File*
<pre>
LinkGroup default-link-group
*/Role=*

LinkGroup volatile-link-group
*/Role=*
</pre>




-- Main.NehaSharma - 15 Nov 2007


<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = TedHesselroth 

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = Storage

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = HowTo
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %NO%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %NO%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = FirstName
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %NO%


 DEAR DOCUMENT TESTER
 ====================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = FirstLast
 Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %NO%
############################################################################################################
-->

%META:TOPICMOVED{by="TedHesselroth" date="1271192816" from="Storage.SpaceResServerSetup" to="ReleaseDocumentation.SpaceResServerSetup"}%
