%META:TOPICINFO{author="JohnWeigand" date="1140806417" format="1.0" version="1.37"}%
%META:TOPICPARENT{name="VoAdmins"}%
<!-- This is the default OSG Integration template. 
Please modify it in the sections indicated to create your topic!
If you have any comments/complaints about this template, then please email me:
rwg@hep.uchicago.edu.  (Adapted from Atlas wiki template, Ed Moyse)
--> 

<!-- By default the title is the WikiWord used to create this topic !-->
<!-- if you want to modify it to something more meaningful, just replace %TOPIC% below with i.e "My Topic"!-->

---+!!<nop>How to Install VOMS
%TOC%
%STARTINCLUDE%
---++Introduction
The [[http://hep-project-grid-scg.web.cern.ch/hep-project-grid-scg/voms.html VOMS]] (Virtual Organization Membership Service) has three main parts: 
<OL>
<LI>A !MySql database which is a persistent repository for VO membership information, 
<LI>The VOMS Admin which provides the Web UI/services to maintain the VO membership. This requires Apache/Tomcat-4.
<LI>The VOMS server, a daemon process which services the <i>voms-proxy-init</i> requests.
</OL>

Also  included in the installation is a VOMS client containing the <i>voms-proxy-init</i> for testing.

Here we describe how to install and configure VOMS on your Linux machine. When you install VOMS as described here, you get all three parts.  It comes with a test VO called VDT. We suggest that you use it for testing. You're going to need to create your real VO with the appropriate name. Instructions for doing that are also on this page.

We also describe how to remove a VO from VOMS, and how to uninstall VOMS, should the need arise.

All the sample commands are shown with Bourne shell syntax.  Substitute appropriate values as needed.

---++Pre-requisites for VOMS  Installation

---+++Pacman
You will use pacman to install VOMS.  See the 
<a href="http://osg.ivdgl.org/twiki/bin/view/Integration/PacmanInfo">Pacman guide</a>
 for download and installation instructions.

---+++Certificates
If you do not already have the necessary certificates on this host, this can  be done as a post-install step. Instructions for getting the certificate can be found at this 
<A HREF="http://www.cs.wisc.edu/vdt/requesting_cert.html">VDT site</A>. 
		  Also refer to any instructions you may find in the $VDT_LOCATION/vdt/post-install/README that may be related to this.

<OL>
<LI><b>host certificate</b>: Used by the VOMS server.  The host certificate should be installed in /etc/grid-security with ownership and permissions as:
<pre>
/etc/grid-security
-rw-r--r--  1 root	root	 1176 Nov  7 16:38 hostcert.pem
-r--------  1 root	root	  887 Nov  7 16:38 hostkey.pem
</pre> 

<p>
<LI><b>http certificate</b>: Used by apache.  The http certificate for your system should be installed in  /etc/grid-security/http with ownership and permission as:
<pre>
/etc/grid-security
-rw-r--r--  1 root root 1176 Nov  7 16:38 httpcert.pem
-r--------  1 root root  887 Nov  7 16:38 httpkey.pem
</pre>
 If you do not already have one on this machine, this will have to be done as a post-install step. Instructions for getting the certificate can be found at this 
<A HREF="http://www.cs.wisc.edu/vdt/requesting_cert.html">VDT site</A>. 
		  Also refer to any instructions you may find in the $VDT_LOCATION/vdt/post-install/README that may be related to this.
<p>
</OL>

---+++Known Problems
Review the "Known Problems" section of the ItbRel015 or ItbRel016 page depending on the version being installed.

---+++Previous installations
If you have an OSG VOMS running and you're about to reinstall or if any of the following daemons are installed and running on your machine, see the [[#ShutdownGuide][Shutdown instructions]] below. 


	 
---++What's  Getting Installed

---+++Software
These instructions are for  ITB 0.3.6 (VDT 1.3.10) release of VOMS which installs this software
<pre>
	 Apache HTTPD 2.2.0
	 CA Certificates v11 (includes IGTF 1.0 CAs)
	 EDG CRL Update 1.2.5
	 GPT 3.2
	 Java SDK 1.4.2_10
	 Logrotate 3.7
	 MySQL 4.1.11
	 Apache Tomcat 5.0.28
	 VOMS 1.6.10.2
	 VOMS Admin (client 1.2.10, interface 1.0.2, server 1.2.10) 1.2.10-r0
</pre>

---+++Services - /etc/init.d
The services installed and activated are:
<pre>
<b>/etc/init.d</b>
-rwxr-xr-x  1 root root  1684 Feb 21 23:02 edg-crl-upgraded
-rwxr-xr-x  1 root root  6591 Feb 21 23:02 mysql
-rwxr-xr-x  1 root root  4039 Feb 21 23:03 apache 
-rwxr-xr-x  1 root root  3289 Feb 21 23:03 tomcat-5
-rwxr-xr-x  1 root root  8890 Feb 22 09:24 voms
</pre>

In addition, during the installation, a test VO called 'VDT' will be created  if  your host certificate is available before you install.  If the host certificate is not available, configuration of the 'VDT' VO will have to be performed separately.

Note: The <i>edg-mkgridmap</i> client in previous releases of VDT (1.3.2 and below) may be incompatible with this release.	If this is of concern to you, you will have to run both an older and a newer VOMS to retain compatibility with the older versions of <i>edg-mkgridmap</i>..

---++Installing VOMS

---+++Installation user
 Must be done as root.

---+++Installation package
After intalling pacman:
<pre>
&gt  cd &lt PACMAN_DIR &gt
&gt  source setup.sh
</pre>

---+++Installation location
 Wherever you like.  Shown below as as the VDT_LOCATION variable.
<pre>
&gt  VDT_LOCATION=/usr/local/osg
&gt  mkdir $VDT_LOCATION
</pre>

---+++Installation Cache
 iVDGL:osg-pre
<pre>
&gt  cd $VDT_LOCATION 
&gt  pacman -get  iVDGL:osg-pre
</pre>

---+++Installation output/questions
<pre>
	  :
Do you want to add [http://hep.uchicago.edu/ivdgl/] to [trusted.caches]? (y or n): <b><i>y</b></i>
	:	-----------------------------------------------------
Do you want to add [http://vdt.cs.wisc.edu/vdt_1310_cache] to [trusted.caches]? (y or n): <b><i>y</b></i>
	:	-----------------------------------------------------
The VDT is unable to recognize your platform.  This version of the VDT is
supported on several Linux releases:

	 RedHat 7 x86
	 RedHat 9 x86
	 RedHat Enterprise Linux 3 AS x86, x86-64 and ia64
	 RedHat Enterprise Linux 4 AS x86
	 Fedora Core 3 x86
	 Fedora Core 4 x86
	 Debian 3.1 x86
	 ROCKS 3.3 x86 
	 Fermi Scientific Linux 3.0 x86
	 SuSE Linux 9 ia64

The VDT may work on other platforms, but it's not guaranteed.  If you
encounter problems and send mail to the VDT team for support please mention 
that you are installing the VDT on an unsupported platform.

Do you wish to continue? [y/n] <b><i>y</b></i>
	:	-----------------------------------------------------
	:
VDT 1.3.10 installs a variety of software, each with its own license.
In order to continue, you must agree to the licenses.
You can view the licenses online at:

	  http://vdt.cs.wisc.edu/licenses/1.3.10

After the installation has completed, you will also be able to
view the licenses in the "licenses" directory.

Do you agree to the licenses? [y/n]  <b><i>y</b></i>
	:	-----------------------------------------------------
	 :
The VDT typically installs public certificates and signing policy files
for the well-known public CA's. This is necessary in order for you to
perform GSI authentication with any remote Grid services (that have
service/host certificates signed by these CA's).

For more information please refer to the VDT documentation:
http://vdt.cs.wisc.edu/setup_ca.html

Where would you like to install CA files?
Choices:
		  r (root)  - install into /etc/grid-security/certificates
				(existing CA files will be preserved)
		  l (local) - install into $VDT_LOCATION/globus/share/certificates
		  n (no)	 - do not install
<b><i>r</b></i>
	:	-----------------------------------------------------	

Several services provided by the VDT create unbounded log files.  If you wish, we can rotate those file on a daily basis.
Would you like to setup daily rotation of VDT log files?
Possible Answers:
	  y: Yes. Please remove any old instances of the service and run
		  this one..
	  n: No. Please remove any old instances of the service, but don't
		  run this one.
	  s: Skip. Don't run the service from this installation, and if
		  there is already an instance running, leave it alone.
<b><i>y</b></i>
	:	-----------------------------------------------------

If you would like, we can configure VOMS to start automatically at boot time.

Configuring the VOMS daemon requires
  - changes to /etc/init.d (or /etc/rc.d/init.d)
  - starting up a MySQL server
  - starting up an Apache and Tomcat server

Would you like to enable the VOMS server to run automatically?

Possible Answers:
	  y: Yes. Please remove any old instances of the service and run
		  this one..
	  n: No. Please remove any old instances of the service, but don't
		  run this one.
	  s: Skip. Don't run the service from this installation, and if
		  there is already an instance running, leave it alone.
 
	<b><i>y</b></i>
	:	-----------------------------------------------------

Do you want the EDG CRL update daemon to be run automatically when
your computer starts up? If so, we will install one file,
edg-crl-updated, into etc/rc.d/init.d/.

It will periodically update the Europen DataGrid (EDG) certificate
revocation lists (CRLs) It is essential if you are collaborating with
people from the EDG, and not important if you are not.

Do you want the EDG CRL update daemon to be installed? [y/n] <b><i>y</b></i>
	:	-----------------------------------------------------
	:
	:
Downloading [configure_voms-1-222.tar.gz] from [vdt.cs.wisc.edu]...
</pre>
The above line should be the last line of output you see.  The version number of the tarball may be different 
than that shown above.  Do not be concerned with this.

---+++Verify the  installation completed successfully
To verify  the pacman installation was successful, there should be a setup.(c)sh in the VDT_LOCATION.	If present, source it.
<pre>
&gt  cd $VDT_LOCATION
&gt  source setup.sh
</pre>
<b>Note:</b> This does not necessarily indicated that everything was installed and configured successfully.  It just verifies that the pacman installation completed successfully.  There is a lot of other magic that occurs during the process that should be validated.



---++Verifying the Success of the Installation
If all the required certificates were in place prior to the pacman installation, a default VO called <i>VDT</i> has been created already and all the deamon services should be up and running.
This section will take you through the steps necessary to verify that and can also serve as a basic operational trouble shooting guide.

If the certificates were installed <b>after</b> the pacman installation, then you should go to the next section (<a href="#Creating_a_new_VO">Creating a new VO</a>)  and create a <i>VDT</i> VO for test/play purposes.  Then return here to varify the configuration.

For  all the verifications, you will need to source the VDT setup.(c)sh script:
<pre>
&gt  cd &lt VDT_LOCATION &gt
&gt  source setup.sh
</pre>

---+++Verifying  the edg-crl-upgrade daemon
The edg-crl-upgrade daemon  (essential if you are collaborating with EDG people) updates the certificate revocation lists on a daily (default) basis.
<pre>
<b>/etc/init.d</b>
-rwxr-xr-x  1 root root  1684 Feb 21 23:02 edg-crl-upgraded
</pre>
To verify it is running:
<pre>
&gt	ps -efwww |  grep edg-crl-upgrade
root  13268  1  0 Feb21 ?	00:00:00 /bin/sh /usr/local/osg/edg/sbin/edg-crl-upgrade
</pre>
<b>Note:</b>  Verify that it is the only one running and the path contains your VDT_LOCATION.


To verify it created the crl files:
<pre>
&gt	ls -l  $X509_CADIR/*.r0
-rw-r--r--  1 root root  61312 Feb 22 10:48 /usr/local/osg/globus/TRUSTED_CA/01621954.r0
-rw-r--r--  1 root root	7657 Feb 22 10:48 /usr/local/osg/globus/TRUSTED_CA/03aa0ecb.r0
-rw-r--r--  1 root root	1868 Feb 22 10:48 /usr/local/osg/globus/TRUSTED_CA/1149214e.r0
		 :	
</pre>
<b>Note:</b> The number of crl files does not directly correlate to the number of CAs, 
			 but there should be at least 1 and they should never be more than a day old
			  unless you've change the default interval.



---+++Verifying  the apache/tomcat daemon
Apache and Tomcat are used to access the WEB user interface of  VOMS. 
<pre>
<b>/etc/init.d</b>
-rwxr-xr-x  1 root root 4039 Feb 21 23:03 apache
-rwxr-xr-x  1 root root 3289 Feb 21 23:03 tomcat-5
</pre>
To verify <b>apache</b> is running:
<pre>
&gt	ps -efwww |  grep  apache
<b>apache</b>	 2585 10881  0 Feb21 ?		  00:00:00 /usr/sbin/httpd
<b> (there will be a number of these)</b>
			 :
root		8924	  1  0 Feb21 ?		  00:00:03 /usr/local/osg/<b>apache</b>/bin/httpd -d /usr/local/osg/<a>apache</b> 
			-k start -f  /usr/local/osg/<b>apache</b>/conf/httpd.conf
daemon	15165  8924  0 09:24 ?		  00:00:00 /usr/local/osg/<b>apache</b>/bin/httpd 
<b>(and a number of these)</b>
</pre>
<b>Note:</b>  Verify that it is the only one running and the path contains your VDT_LOCATION.  
In the case of apache, there should be several <i>/usr/bin/httpd</i> processes owned by apache running in
addition to the <i>$VDT_LOCATION/apache/bin/httpd</i> processes.

To verify <b>tomcat</b> is running:
<pre>
	&gt	ps -efwww |  grep tomcat
	daemon	15238	  1  0 09:24 pts/2	 00:00:15 /usr/local/osg/jdk1.4/bin/java	  
	-Djava.endorsed.dirs=/usr/local/osg/<b>tomcat</b>/v5/common/endorsed
	-classpath	 /usr/local/osg/jdk1.4/lib/tools.jar:/usr/local/osg/tomcat/v5/bin/bootstrap.jar:/usr/local/osg/tomcat/v5/bin/commons-logging-api.jar 
	-Dcatalina.base=/usr/local/osg/tomcat/v5 -Dcatalina.home=/usr/local/osg/tomcat/v5		
	-Djava.io.tmpdir=/usr/local/osg/tomcat/v5/temp org.apache.catalina.startup.Bootstrap start
</pre>
<b>Note:</b>  
<UL>
<LI>There should be only one tomcat process running with <i>init (pid=1)</i> as it's parent.
<LI>Verify that it is the only one running and the path contains your VDT_LOCATION.
</UL>

---+++Verifying  the mysql daemon
!MySql  is used to provide persistent storage of the VOMS VO membership data.
<pre>
	<b>/etc/init.d</b>
	-rwxr-xr-x  1 root root 6591 Feb 21 23:02 mysql
</pre>
To verify it is running:
<pre>
&gt	ps -efwww |  grep  mysql  
root		6606	  1  0 Feb21 ?		  00:00:00 /bin/sh /usr/local/osg/mysql/real-bin/mysqld_safe 
--defaults-file=/usr/local/osg/mysql/var/my.cnf --datadir=/usr/local/osg/vdt-app-data/mysql/var 
--pid-file=/usr/local/osg/vdt-app-data/mysql/var/cmssrv08.fnal.gov.pid
<b>(The parent mysql process is the only one displayed here)</b>
</pre>
<b>Note:</b>  Verify that it is the only one running and the path contains your VDT_LOCATION.

---+++Verifying the VOMS WEB UI
If all the certificates were in place prior to the pacman installation, a default VO called <i>VDT</i> was configured.
To verify it is accessible:
<OL>
<LI>Point a certificate-enabled browser window to				 
		  <i>https://<b>your.host.name</b>:8443/edg-voms-admin/VDT</i>
  <UL><LI>You should be prompted for your certificates passphrase
				<LI>You should get a <i>Welcome to the VDT VO</i> page
	</UL>
<LI>In  the left hand menu under <i>FOR VO USERS</i>, select <i>My membership details</i>.<br>
			The membership details page should say <i>You are not currently a member of this VO</i>, which you  are not yet.
<LI>Do a <i>Back</i>  in your browser.
<LI.>Now select <i>Administer the VO </i>  under the <i>FOR VO MANAGERS</i>  item on the left menu..<br>
			 Then slect <i>Create a New VO User</i> from the new menu.  You should get <i>Access denied</i>.
<LI>Do a <i>Back</i> in your browser, twice, to return to the main page again.
<LI>Select <i>Configuration information</i> under the <i>Configuration</i> menu item.  The 3 items 
		  displayed provide the syntax and data content used for the various authorization modes available on the grid  for your VO.  
</OL>
At this point, you know your VOMS WEB UI is functional.

---+++Verifying the VOMS server daemon
The VOMS server's only purpose is to service <i>voms-proxy-init</i> requests for your VO.
<pre>
<b>/etc/init.d</b>
--rwxr-xr-x  1 root root 8890 Feb 22 09:24 voms
</pre>
To verify <b>voms</b> is running:
<pre>
&gt	ps -efwww | grep edg-voms
daemon	13033	  1  0 Feb21 ?		  00:00:00 /usr/local/osg/voms/sbin/edg-voms  --conf	/usr/local/osg/voms/etc/voms/<b>VDT</b>/voms.conf
daemon	15396	  1  0 Feb21 ?		  00:00:00 /usr/local/osg/voms/sbin/edg-voms --conf /usr/local/osg/voms/etc/voms/<b>VDT</b>/voms.conf
</pre>
<b>Note:</b> 
<UL>
<LI>There are individual <i>VOMS servers</i> for each VO, each using a unique port
			to service requests.
<LI>There are usually 2 <i>edg-voms</i> processes that are running for each VO.
		  There are times when only 1 is running and the server works fine.  
			This is one of those mysteries in life that one just accepts.
<LI>Verify that  the path contains your <i>VDT_LOCATION</i>.
</UL>

---+++Verifying the VOMS version
The voms-admin and voms server versions can be verified using the following command:
<pre>
&gt  voms-admin -vo VDT  -version
voms-admin v1.2.10-1
server side is v1.2.10
</pre>
If the versions do not display, then there is a problem with either the web interface or the VOMS server.

---++Securing your server
All access to VOMS is through apache and tomcat, even the command line <i>voms-admin</i> command.  To secure your server and require only authenticated access, run the following command.
<pre>
 &gt  $VDT_LOCATION/vdt/setup/configure_apache --secure
 &gt  /etc/init.d/apache restart
</pre>


---++Creating a VO - the configure_voms script

Additional functions performed by the <i>configure_voms</i> script are:
<OL>
<LI>
A Global-ACL is created for the host certificate for this server with <i>allow all</i> 
capabilities.  This allows the <i>root</i> user on this machine to update the VOMS VO using the command line interface
command <i>voms-admin</i>.  So, in effect, the <i>root</i> user is already a VO-Admin  in this VO.
<p>
This <i>root</i> user capability can be removed <b>after</b> an individual  is assigned the VO-Admin role as described in the next section.
<p>
<LI>
A second Global-ACL is created with <i>allow list</i> capabilities for anyone that presents a 
certificate issued by a known VO.  The purpose for this is two-fold:
<p>
  <UL>
		<LI>Those sites using <a href="http://osg.ivdgl.org/twiki/bin/view/Integration/GumsAdmins">GUMS servers</a> will be able to access your VO without the VO-Admin having to individually provide this Global-ACL capability on a case by case basis.	This is the default configuration and can be changed.
<p>
		<LI>It allows VO members or (those that think they are VO members) to query the VOMS to troubleshoot problems in getting voms proxies and verify their membership in various groups and role asssignments. 
  </UL>
</OL>

---+++Creation of the default VDT VO 
As you have already seen, a VO called <i>VDT</i> has already been created during the initial
installation process.  This was done be executing:
<pre>
	$VDT_LOCATION/vdt/setup/configure_voms  --server y  --vo <b>VDT</b> 
</pre>
Many default values  applied during this process.  The values applied can  be viewed in the 
<i>$VDT_LOCATION/vdt-install.log</i> and searching for  
'loaded by vdt/setup/configure_voms'.



---+++Creating Your Own VO

---++Enabling a VOMS VO
Several things have to be done to actually enable your VO to begin accepting membership, used for voms proxy generation, and used for the Compatiblity and Full  Privilege 
<a href="http://osg.ivdgl.org/twiki/bin/viewauth/Integration/OsgCEAuthorization">authorization modes</a> on compute (CE) and storage (SE) element  nodes.

The following sub-sections will reference the default <i>VDT</i> in the text and examples.  When enabling your 
'real' VO, the same steps are required and, where different, it will be noted.


---+++Establishing a VO-Admin
A person (or persons) can be designated as the VO-Admin for the VOMS VO created.  This person(s) has 
adminstrative capabilty within VOMS that the normal VO member will not have.  

There are 2 options for adding this capability to an individual:
<OL>
  <LI>The individual <u>is not</u> a member of the VO.	A Global-ACL for that individual with <i>allow all</i> capability allows a person to administer the VO's VOMS from the command line and WEB UI.<p>
		  <UL>
		  <LI>Individual's certificate file is available:
<pre>
&gt  voms-admin -vo <b>VO</b> add-acl-entry Global-ACL allow all <b>usercert.pem</b>
</pre>
			 <LI>Individual's certificate file is <u>not</u> available:
<pre>
&gt  voms-admin -vo <b>VO</b>  -nousercert  add-acl-entry  Global-ACL allow all "<b>USER DN</b>" "<b>USER CA</b>"
</pre>
			  </UL>

  <LI>The individual <u>is</u> a member of the VO.  This can be accomplished by giving the individual the Global-ACL
			  capablility above or by first adding them to the VO as a member (described in the next section) and then assigning them the <i>VO-Admin</i> role with the following command:<p>
		  <UL>
		  <LI>Individual's certificate file is available:	  
<pre>
&gt  voms-admin -vo <b>VO</b> assign-role  <b>GROUP</b> VO-Admin <b>usercert.pem</b>
</pre>
			 <LI>Individual's certificate file is <u>not</u> available:
<pre>
&gt  voms-admin -vo <b>VO</b> assign-role  <b>GROUP</b> VO-Admin  "<b>USER DN</b>" "<b>USER CA</b>"
</pre>
			  </UL>		
</OL>

---+++Adding  a user to the VO
Individuals with the <i>VO-Admin</i> role or the  <i>allow all</i> Global-ACL are referred to as VO Managers in VOMS and are the only ones who can add new members via the web ui.
In normal practice, users will request VO membership by accessing the <i>New user registration</i> menu item on the main VOMS web page.  This document will not go into the details of that process here, nor will it address the basic usage and navigation of the VOMS web ui.

The purpose of this section is to show you how to add a user for the purposes of assigning the <i>VO-Admin</i> role as a part of the initial setup.	

Four data items are required for each user:
<UL><LI>DN
			 <LI>CA
			  <LI>Common Name (CN part of the DN or just 1st and last name so you can be easily identified)
			  <LI>email address 
</UL>

If you have the user's certificate file available, then these 4 items are derived from that.
		  <UL>
		  <LI>Individual's certificate file is available:	  
<pre>
&gt  voms-admin -vo <b>VO</b> add-member  <b>GROUP</b>  <b>usercert.pem</b>
</pre>
			 <LI>Individual's certificate file is <u>not</u> available:
<pre>
&gt  voms-admin -vo <b>VO</b> add-member  <b>GROUP</b>	"<b>USER DN</b>" "<b>USER CA</b>"  "<b>USER CN</b>" <b>USER EMAIL</b>"
</pre>
			  </UL>		

If you have added the user for the purpose of assigning the <i>VO-Admin</i> role, you will want to re-visit the
<a href="VomsWhatToDo#Establishing_a_VO_Admin">Establishing a VO-Admin</a> section above to assing the role.

---+++Verifying you are a VO-Admin
If you've established yourself with the <i>VO-Admin</i> role or with the <i>allow all</i> Global-ACL, you can now go back the VOMS web ui in a browser with your certificate and from the main menu:
<UL><LI>Under <i>For VO Managers</i>, select <i>Administer the VO</i>
			 <LI>Then, select <i>Global ACL</i>
</UL>
You should no longer see the <i>Access Denied</i> error and should be able to see the Global-ACL's  tthat have been created.	As a <i>VO-Admin</i>, you can do amything you want.  

<b>Note:</b>  A user with the <i>VO-Admin</i> role only has these privileges in the VOMS web ui.  The command line <i>voms-admin</i>  does not authorize using the VOMS roles.  It allow <i>voms-admin</i> command line capability, you must establish a Global-ACL with the capability you desire.  By default, only the <i>root</i> user has this on inittial installation.


---++Testing access
There are several functions on the grid that access your VOMS VO:
<OL><LI>voms proxy generation (<i>voms-proxy-init</i>)
			<LI>user-vo map file generation on the CE nodes
					<UL><LI>gums-host-cron for all authorization modes.</UL>
			 <LI>gridmap-file generation on the CE nodes
					<UL><LI><i>edg-mkgridmap</i> for Grid3 authorization mode</UL>
			  <LI>GUMS  interface  for Compatibility and Full Privilege authorization modes.
</OL>

---+++ Testing voms-proxy-init
The <i>voms-proxy-init</i> client command was included in the installation. The client <i>voms-proxy-init</i> uses a configuration file that contains the necessary arguments to access a VO's VOMS server.  On the VOMS server node, this file is  located in the <i>$VDT_LOCATION/voms/etc/vomses</i> directory and looks like this for the <i>VDT</i> VO:
<pre>
"VDT" "cmssrv08.fnal.gov" "15000" "/DC=org/DC=doegrids/OU=Services/CN=cmssrv08.fnal.gov" "VDT" "32"
</pre>
Tokens:
<OL>
<LI>Considered a "nickname"  and , although the default is the VO name, it can be any value you desire to identify the VO you wish  to get a proxy from..  
<LI>The hostname of the voms server
<LI>Port number the server is listening on.
<LI>DN of the server's VOMS certificate
<LI>VO name
<LI>Globus version supported
</OL>
<P>
The <i>vomse</i>s file syntax/values for each VO you create, can be viewed on the web ui for your VO by selecting <i>Configuration information</i> on the left hand menu of the main page.
<p>
On the server, there is no need to create a <i>$HOME/.glite/vomses</i> file containing the VOMS servers you wish to access.  The <i>voms-proxy-init</i> command will search the <i>vomses</i> directory  on this server for this file. 

So to test the <i>voms-proxy-init</i> command, you need to do the following:

1. If you have not already added yourself as a member of the VO,  do so now.

2. Then, as yourself (not <i>root</i> user),
<pre>
&gt  source VDT_LOCATION/setup.sh
&gt  voms-proxy-init --voms=VDT:/VDT
<b>...output follows.. </b>
Cannot find file or dir: /home/weigand/.glite/vomses
Your identity: /DC=org/DC=doegrids/OU=People/CN=John Weigand 458491
Enter GRID pass phrase:
<b><i>... your passphrase...</b></i>
Your proxy is valid until Sat Feb 25 00:17:33 2006

Creating temporary proxy ............................. Done
Contacting  cmssrv08.fnal.gov:15000 [/DC=org/DC=doegrids/OU=Services/CN=cmssrv08.fnal.gov] "VDT"

Warning: Cannot find file or dir: /home/weigand/.glite/vomses Done
Creating proxy .................................................... Done
Your proxy is valid until Sat Feb 25 00:17:33 2006
</pre>

A couple of things about the output you might want to be aware of: regarding the output above:
<UL>
<LI>The warnings about not finding a <i>$HOME/.glite/vomses</i> are not a problem, since on the server it is using the <i>./vomses</i> directory mentioned earlier.
<LI>The temporary proxy it generates is the good old grid proxy.  This is used for the access to VOMS and just temporary.
</UL>

3. To verify the output of the voms proxy has the extended attributes the VOMS service provides. The extended attribute and location of the proxy file are highlighted in the output:
<pre>
&gt  voms-proxy-info --all
<b>... output follows....</b>
WARNING: Unable to verify signature!
Error: Cannot find certificate of AC issuer for vo VDT
subject	: /DC=org/DC=doegrids/OU=People/CN=John Weigand 458491/CN=proxy
issuer	 : /DC=org/DC=doegrids/OU=People/CN=John Weigand 458491
identity  : /DC=org/DC=doegrids/OU=People/CN=John Weigand 458491
type		: proxy
strength  : 512 bits
path		: <b>/tmp/x509up_u500</b>
timeleft  : 11:51:40
=== VO VDT extension information ===
VO		  : VDT
subject	: /DC=org/DC=doegrids/OU=People/CN=John Weigand 458491
issuer	 : /DC=org/DC=doegrids/OU=Services/CN=cmssrv08.fnal.gov
<b>attribute : /VDT/Role=NULL/Capability=NULL</b>
timeleft  : 11:51:40
</pre>

4. Now try one for a group you do not belong to, e.g., /MyGroup
<pre>
&gt  voms-proxy-init --voms=VDT:/VDT
<b>...output follows.. </b>
Cannot find file or dir: /home/weigand/.glite/vomses
Your identity: /DC=org/DC=doegrids/OU=People/CN=John Weigand 458491
Enter GRID pass phrase:
Your proxy is valid until Sat Feb 25 00:32:18 2006

Creating temporary proxy .................................. Done
Contacting  cmssrv08.fnal.gov:15000 [/DC=org/DC=doegrids/OU=Services/CN=cmssrv08.fnal.gov] "VDT"
<b>Error: VDT: Unable to satisfy G/MyGroup Request!</b>
</pre>
<b>Note:</b> If a subsequent attempt at a voms proxy fails, as ours did here, the previously generated proxy is still in effect.  You can do another <i>voms-proxy-init --all</i> to verify this.



---+++ Testing edg-mkgridmap
<p>
The <i>mkgridmap</i> file syntax/values for each VO you create, can be viewed on the web ui for your VO by selecting <i>Configuration information</i> on the left hand menu of the main page.

---++Creating a new VO
You won't be able to use the default VO named VDT (the VO name must be unique). You'll have to create a new one (or any number of new ones).
---+++What to expect and what you need to know
When you create a new VO, many things occur. In particular, a database and several files are created, and you need to know what they're used for. CreateNewVoForVomsInfo lists and describes these things.
---+++Before creating the VO
Define the following series of environment variables representing the arguments used on the install command line.  Note: the syntax used for defining this data is in Bourne shell format.  Depending on whether you need to change the value, you may be able to just cut/paste a lot of these
		commands during the installation process.  
		
	 VO=Test	<br />	  
		The name of your VO (shown as Test).  Mixed case is permissable. 
		This will also be the top level (root) group for the VO.

	 PORT=15007	 <br />
		Port number the voms server listens on for voms-proxy-init requests.
		Each VO has a unique instance of the voms server running and listening on a port.

	 SMTP_HOST=smtp.fnal.gov	<br />
		The hostname of the SMTP delivery service at the site of this VOMS server.
		The host must accept emails for delivery.

	 MAIL_FROM=your-email-address <br />
		The sender email address for the notification messages sent by this VOMS service.
		This should be a read address otherwise the failure notifications will end up in 
		/dev/null.

	 PASSWORD=some-unique-password  <br />
		The password of this VO's voms database users mentioned above ($VO_adm, $VO_que, $VO_seq and $VO_upd).
		Please change ffomr what is shown above!

	 VOMS_GROUP=daemon <br />
		The Unix group name of the user the VOMS server runs under. 
		The default with VDT installations is 'daemon'.  

	 TOMCAT_GROUP=daemon <br />
		The Unix group name of the user that tomcat4 runs under. 
		The default with VDT installations is 'daemon'.  

	 CERTDIR=$GLOBUS_PATH/TRUSTED_CA <br />
		Not sure if this has any affect as it does not appear to be picking up
		all the CAs in this directory.  Actually, this is a link and this may
		be the problem.%RED%John -- what was the problem? AH 6/2%ENDCOLOR%

You need to know your root password for the mysql database, if you have one.  If you don't, you don't need one.
If you want to set the root password:
<verbatim>
	  $VDT_LOCATION/mysql/bin/mysqladmin -u root password 'new-password'
	  $VDT_LOCATION/mysql/bin/mysqladmin -u root -h $(hostname) password 'new-password'
</verbatim>
The VDT setup script should set the EDG_LOCATION variable needed by VOMS
if it is installed there. (Check to be sure; it should be set to $VDT_LOCATION/voms.)

---+++Execute the script to create the VO

Execute the $EDG_LOCATION/edg-voms-admin-configure script with the 'install' argument and
the required set of parameters shown below (and described above). This will create a set of sql files containing the ddl and initial data for 
  the VOMS database for your VO. It will create the directories and data files for the VO. If you've set all the variables, you should be able to just cut and paste.

<verbatim> 
  $EDG_LOCATION/sbin/edg-voms-admin-configure install \
		--port			 $PORT \
		--vo				$VO \
		--voalias		 $VO \
		--mail-from	  $MAIL_FROM \
		--smtp-host	  $SMTP_HOST \
		--password		$PASSWORD  \
		--voms-group	 $VOMS_GROUP \
		--tomcat-group  $TOMCAT_GROUP \
		--certdir		 $CERTDIR
</verbatim>

Output (many values will be different for your case):
<verbatim>
WARNING: Fallback to file based DB setup.
WARNING: You must feed the database with the generated SQL files manually.

/data/osg-itb-015/voms/sbin/edg-voms-admin-configure uses the following settings:

	EDG_LOCATION		  /data/osg-itb-015/voms
	EDG_LOCATION_VAR	 /data/osg-itb-015/voms/var
	EDG_TMP				 /tmp
	VO name				 TEST1
	VO alias				TEST1
	vomsd port number	15007
	X509 certificate	 /etc/grid-security/hostcert.pem
	CA certificates	  /data/osg-itb-015/globus/TRUSTED_CA
	config userid		 0
	config group tomcat 2
	config group voms	2
	smtp host			  smtp.fnal.gov
	mail from			  root@cd-94372.dhcp.fnal.gov
	Database name		 voms_TEST1

WARNING: Please feed install-voms-1-mysql-as-root.sql to MySQL by hand.
Creating the database...
processing template 
		  /data/osg-itb-015/voms/etc/edg-voms-admin/databases/MySQL/db_create.sql to 
		  /data/osg-itb-015/voms/var/etc/edg-voms-admin/TEST1/install-voms-2-mysql-as-root.sql
WARNING: Please feed install-voms-2-mysql-as-root.sql to MySQL by hand.
WARNING: Please feed install-voms-3-mysql-as-root.sql to MySQL by hand.
...creating the roles
WARNING: Please feed install-voms-4-mysql-as-root.sql to MySQL by hand.
...inserting the initial values
...saving the settings ... processing template 
		  /data/osg-itb-015/voms/etc/edg-voms-admin/voms.database.properties.template to 
		  /data/osg-itb-015/voms/var/etc/edg-voms-admin/TEST1/voms.database.properties
Installing vomsd configuration ... 
		  /data/osg-itb-015/voms/etc/voms/TEST1/voms.pass
		  /data/osg-itb-015/voms/etc/voms/TEST1/voms.database.properties
Service properties ... processing template 
		  /data/osg-itb-015/voms/etc/edg-voms-admin/voms.service.properties.template to 
		  /data/osg-itb-015/voms/var/etc/edg-voms-admin/TEST1/voms.service.properties
context block ... processing template 
		  /data/osg-itb-015/voms/etc/edg-voms-admin/context.xml.template to 
		  /data/osg-itb-015/voms/var/etc/edg-voms-admin/TEST1/edg-voms-admin-TEST1.xml
Miscellaneous files ... Installation complete.
</verbatim>
End of output

Heed any and all WARNINGS or ERRORS except the following:
<verbatim>
	  WARNING: Fallback to file based DB setup.
	  WARNING: You must feed the database with the generated SQL files manually.
	  WARNING: Please feed install-voms-1-mysql-as-root.sql to MySQL by hand.
	  WARNING: Please feed install-voms-2-mysql-as-root.sql to MySQL by hand.
	  WARNING: Please feed install-voms-3-mysql-as-root.sql to MySQL by hand.
	  WARNING: Please feed install-voms-4-mysql-as-root.sql to MySQL by hand.
</verbatim>
These listed warnings will be processed in the next step.

The file system directories and files have been created as mentioned in the beginning.
You can view their contents:
<verbatim>
  ls -l $EDG_LOCATION/etc/voms
  ls -l $EDG_LOCATION/var/etc/edg-voms-admin
 (Ignore this last one for now) ls -l $EDG_LOCATION/etc/vomses/$VO
</verbatim>
(These are links; see  <tt>/data/osg-itb-016/vdt-app-data/voms/voms</tt> and <tt>/data/osg-itb-016/vdt-app-data/voms/voms-admin</tt>.)

---++ Create the VOMS database for the VO

The voms database for a VO is created in mysql as 'voms_$VO' (e.g., voms_TEST1)

To create it, we need to run the following series of commands (notice they're run as the mysql root user):
<verbatim>
  cd $EDG_LOCATION/var/etc/edg-voms-admin/$VO
  mysql -uroot < install-voms-1-mysql-as-root.sql
  mysql -uroot voms_$VO < install-voms-2-mysql-as-root.sql
  mysql -uroot voms_$VO < install-voms-3-mysql-as-root.sql
  mysql -uroot voms_$VO < install-voms-4-mysql-as-root.sql
</verbatim>
No output indicates success; any output needs to be reconciled.
If all was successful, you should have a voms database for the VO.
You can view this if you go into the mysql database.

---++Get Tomcat Up and Running

Tomcat still does not know about the VO, however. For Tomcat to know about the VO, 
the edg-voms-admin-$VO.xml file must be moved to $VDT_LOCATION/tomcat/v4/webapps. 
This xml configuration file provides the context for the VO within Tomcat.
<verbatim>
cd $EDG_LOCATION/var/etc/edg-voms-admin/$VO
cp -p edg-voms-admin-$VO.xml $VDT_LOCATION/tomcat/v4/webapps/.
</verbatim>
First stop tomcat-4 if you have it running:
<verbatim>
/etc/init.d/tomcat-4 stop
</verbatim>
output (the path shown in the output is $VDT_LOCATION/tomcat):
<verbatim>
Using CATALINA_BASE:	/data/osg-itb-015/tomcat/v4
Using CATALINA_HOME:	/data/osg-itb-015/tomcat/v4
Using CATALINA_TMPDIR: /data/osg-itb-015/tomcat/v4/temp
Using JAVA_HOME:		 /data/osg-itb-015/jdk1.4
</verbatim>

Restart tomcat-4:
<verbatim>
/etc/init.d/tomcat-4 start
</verbatim>
output(the path shown in the output is $VDT_LOCATION/tomcat):
<verbatim>
Using CATALINA_BASE:	/data/osg-itb-015/tomcat/v4
Using CATALINA_HOME:	/data/osg-itb-015/tomcat/v4
Using CATALINA_TMPDIR: /data/osg-itb-015/tomcat/v4/temp
Using JAVA_HOME:		 /data/osg-itb-015/jdk1.4
</verbatim>

---+++Bring up the VOMS-Admin Web UI
Bring up a browser with your personal certificate in it and access the VOMS UI
for your newly created VO. 
The URL is https://your.host.name:8443/edg-voms-admin/{your_VO_name}

You won't be able to do anything in it yet.  Return to the <a href="#AddUserAsAdmin">"Add a user as Admin"</a> section
to progress further.
 
The command below shows a different way to add an admin, and also should allow you to assign
a role, but is failing with a relocation error on sn ssl library in perl.
<verbatim>
	  $EDG_LOCATION/sbin/edg-voms-admin \
				 --url=http://$(hostname):8080/edg-voms-admin/${VO} \
			create-user \
				$certfile \
			assign-role \
				${VO} \
				VO-Admin \
				$certfile 
</verbatim>
---++Start the VOMS server for the VO
Make sure you're root. Run:
<verbatim>
$EDG_LOCATION/etc/init.d/voms start $VO
</verbatim>
Output (showing the VO name; yours will be different):
<verbatim>
Starting edg-voms(TEST1):											 [  OK  ]
</verbatim>
Verify the VOMS server is running:
<verbatim>
$EDG_LOCATION/etc/init.d/voms status $VO
</verbatim>
output (showing the VO name; yours will be different):
<verbatim>
Status edg-voms(Test3): (pid 7715) is running...
</verbatim>
---++Set the Global ACL for list access to each Group
(moved here from VoAdmins page, and lightly edited; needs more clarification by author. AH)

We suggest that you set the global ACL on the web UI to allow access to anyone who presents a valid certificate issued by a known CA.  The following procedure will allow any valid certificate to query the server:
	* Go to the web UI (with a browser with the certificate you use as admin)<br>
		 - https://[YOUR_VOMS_HOST]:8443/edg-voms-admin/[YOUR_VO]
	* Select <b>Administrate VOMS</b> under the <b>Adminstration</b> menu item from the left panel
	* Select <b>Global ACL</b> from the left panel
	* Press <b>Edit this ACL</b>
	* - From the <b>Allow:</b> pull down, select "<b>Allow</b>" <br>
		- From the <b>Operation</b> pull down, select "<b>list</b>".<br>
		  <b>NOTE:</b> Be sure to select "list", default is "all".	You do NOT want "all".<br>
		- From the <b>For</b> selection, select  "<b>Anyone who presents a certificate issued by a known CA</b>"<br>
		- Press "Add new entry"<br>
		- NOTE: If you already have this entry in the list of ACL's you did not need to do this.

Note that this will allow newly-added services to provide access to members of your VO without you specifically adding them to the list of machines allowed to access your list of users (I don't follow this sentence. AH).  To gain access to the member list, such a machine or service (or person) will have to present a valid grid certificate.

Warning:

  At present, there is no way to prevent the harvesting of such a list of users for a potential spoofing attack that would use such a list of users to present a false service on the grid.  To create such an exploit, someone with a valid grid certificate would have to pretend to offer a service that would imitate one that would be discovered by an automatic discovery service.  By having a list of valid users, such a theoretical imitation service could accept jobs and divert them to other purposes.  VO's that are sensitive to the possibility of such a "discovery service" attack and who do not have methods of validating the list of offered services for users should not set the Global ACL as above, and will therefore have to fall back to entering each machine or service on the grid manually that they want to allow access to their list of users.

---++ Test access to your VOMS from a gatekeeper with simple grid-mapfile
(taken from 
"Ye olde grid3 mode" -- and adapted)

Your VO maintains a secure membership
service which may be queried on a gatekeeper node with the utility
<verbatim>
$VDT_LOCATION/edg/sbin/edg-mkgridmap
</verbatim>
To create a <b>grid-mapfile</b> containing an entry for every
member of the VO (probably just yourself, at this stage), first you need to copy and start the <b>edg-gridmapfile-upgraded</b> daemon. (If the ITB is already installed, a file of this name will already be in place.)
<pre> 
	 cp $VDT_LOCATION/post-install/edg-gridmapfile-upgraded /etc/init.d/
	 /etc/init.d/edg-gridmapfile-upgraded start
</pre>

Now, su/ssh to root so that the host certificate can be used.

 The gatekeeper should test the <b>$VDT_LOCATION/edg/sbin/edg-mkgridmap</b> script to ensure
there are no connection errors to your VOMS services. First, make a short conf file with just the users known to your VO.
The default conf file is
<pre>
$VDT_LOCATION/edg/etc/edg-mkgridmap.conf
</pre>
Make yours in the same directory. It can just have one line:
<pre>
group vomss://{your voms host}:8443/edg-voms-admin/{your VO name} {account name}
</pre>
E.g.,
<pre>
group vomss://cd-94372.dhcp.fnal.gov:8443/edg-voms-admin/Test3 aheavey
</pre>
Now, run edg-mkgridmap. The --output argument specifies the grid-mapfile name (e.g., test.out); it is NOT optional. The --conf argument specifies the conf file, e.g., my.conf.
<pre>
  cd $VDT_LOCATION/edg/sbin
  ./edg-mkgridmap --verbose --conf=my.conf --output=test.out
</pre>
Check your output file (shown here as test.out).  It should contain the DN of each member you've added to the VO.  If it does, it worked!


  The most common error is "Internal Server Error" which indicates an
  authentication failure.  This can happen either because access to the
  VOMS DB has not been completed, or because the local site credentials
  (host certificate and key) are not valid.  If this occurs, set the X509_USER_CERT and
  X509_USER_KEY variables to test using a different, valid certificate
  and key.

---++Add users, groups, and roles to your VOMS installation

Go to your VOMS web UI, click Adminstrate VOMS.  Use the Users, Groups and Roles links to add these items.


---++Remove a VO from your VOMS Database
First su/ssh to root.

You need to know your root password for the mysql database, if it exists.
If you did not set a root password, leave dbpasswd empty
If you want to set the root password:
<verbatim>
	 VDT_LOCATION/mysql/bin/mysqladmin -u root password 'new-password'
	 VDT_LOCATION/mysql/bin/mysqladmin -u root -h $(hostname) password 'new-password'
</verbatim>
Set your environment:
<verbatim>
VDT_LOCATION=/data/osg-itb-015
cd $VDT_LOCATION
source setup.sh
</verbatim>
Change the VO variable to the VO you want to remove.
<verbatim>
VO=your_vo_name
</verbatim>
Stop the VOMS server for the VO
<verbatim>
$EDG_LOCATION/etc/init.d/voms stop $VO
</verbatim>
Stop tomcat, remove the VO context file from the /var/tomcat4/webapps directory, and retart tomcat:
<verbatim>
/etc/init.d/tomcat-4 stop
rm -f $VDT_LOCATION/tomcat/v4/webapps/edg-voms-admin-$VO.xml 
/etc/init.d/tomcat-4 start
</verbatim>

This script creates a sql file for cleaning up the database
This file needs to use the mysql script as mysql root.
<verbatim>
$EDG_LOCATION/sbin/edg-voms-admin-configure remove \
  --vo				$VO \
  --voms-group	 $VOMS_GROUP  \
  --tomcat-group  $TOMCAT_GROUP 
</verbatim>

Remove the database and users from the mysql database
<verbatim>
sqlfile=$EDG_LOCATION/var/etc/edg-voms-admin/${VO}/remove-voms-mysql-as-root.sql
</verbatim>

NOTE: you can remove the $DBA_PSWD (mysql root password) from the command and 
enter it at the command line prompt which is more secure:
<verbatim>
mysql -u root -p$DBA_PSWD <$sqlfile
mysql -u root <$sqlfile
</verbatim>

Check:
<verbatim>
ls -l $EDG_LOCATION/etc/voms
ls -l $EDG_LOCATION/var/etc/edg-voms-admin
ls -l $EDG_LOCATION/etc/vomses/$VO
</verbatim>
Remove the following:
	* the voms server configuration directory
	* the tomcat configuration directory
	* the vomses file in the ./vomses directroy for client access
<verbatim>
rm -rf $EDG_LOCATION/var/etc/edg-voms-admin/$VO  ## tomcat configs
rm -f  $EDG_LOCATION/etc/vomses/$VO				  ## vomses file 
</verbatim>
Done!

---++Known Problems
Known problems are documented in the "Known Problems" section of:
	* ItbRel015
	* ItbRel016
---++[[VOMS Release Notes]]
---++[[VOMS Troubleshooting Guide]]

---++Shutdown Guide
#ShutdownGuide
The OSG VOMS starts up several processes.  If you try to re-install/upgrade the OSG VOMS without shutting them down it will fail.  Run the following commands to turn off the OSG VOMS services before upgrading:

<ul>
  <li>/etc/ini.d/edg-crl-upgraded stop
  <li>/etc/init.d/apache stop
  <li>/etc/init.d/tomcat-5  stop
  <li>/etc/init.d/voms stop
  <li>/etc/init.d/mysql stop
</ul>


<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->

*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.AlanSill - 29 Sep 2005<br>
-- Main.AnneHeavey - 18 May 2005<br>
-- Main.JohnWeigand - 13 May 2005<br>
-- Main.JohnWeigand - 14 Jun 2005 - added reference for requesting http certificates<br>

%STOPINCLUDE%

