%META:TOPICINFO{author="KyleGross" date="1225985991" format="1.1" version="1.3"}%
%META:TOPICPARENT{name="ItbRel015"}%
<!-- This is the default OSG Integration template. 
Please modify it in the sections indicated to create your topic!
If you have any comments/complaints about this template, then please email me:
rwg@hep.uchicago.edu.  (Adapted from Atlas wiki template, Ed Moyse)
--> 

<!-- By default the title is the WikiWord used to create this topic !-->
<!-- if you want to modify it to something more meaningful, just replace %TOPIC% below with i.e "My Topic"!-->

---+!!<nop><center>Service/Host Certificate Problem In <br>Privilege/GUMS Authorization Service<br>(Common Name / Issuer Attribute)</center>
%TOC%
%STARTINCLUDE%


---++Introduction
Ran into another problem with service certificates and believe it is something that may have to be resolved within GUMS.   This occured on 4/25/05 in Dan Yocum's installation of OSG-0.1.5 at fnal.


---++Problem Description
When the prima callout on the gatekeeper sends the SAML request to the
/gums/services/GUMSAuthorizationServicePort service, the request contains the following:

<verbatim>
  <Request ...... 
      : 
      <AuthorizationDecisionQuery Resource="/DC=org/DC=doegrids/OU=Services/CN=host/fermigrid1.fnal.gov">
      : 
      : 
    <Assertion AssertionID="c4471bd1be1d6033e2e7efbd92f6df7f" 
          IssueInstant="2005-04-27T14:51:57Z"    
          Issuer="/DC=org/DC=doegrids/OU=Services/CN=host/fermigrid2.fnal.gov"
      :
      :
  </Request>
</verbatim>

In the environment where the problem was detected , the following hosts are involved:  
  1 fermigrid1 = gatekeeper 
  1 fermigrid2 = voms server  (Issuer of the VirtualOrganizations/VOInfoMS proxy) 
  1 fermigrid3 = gums server 


The __Issuer__ attribute of the  __Assertion__  element is passed to GUMS.  The __Issuer__ attribute identifies the VirtualOrganizations/VOInfoMS service that authenticated a user and generated the proxy. The PRIMA part of the authorization service extracts the __Issuer__ attribute from the SAML request shown above and passes it to core GUMS which, I believe, uses the __CN__  (Common Name) of the __Issuer__ string in looking up the hosts in a domain/subdomain that are supported in the __hostGroup__ element of the __gums.config__ file  for that instance of GUMS.  The domain/subdomain is defined in the __wildcard__ attribute of the __hostGroup__ element.  Despite the connotation of   ' __wildcard__ '  as the name of the attribute, you can specify a specific host.

The gums.config file being used in the problem case was:

<verbatim> 
    <hostGroups> 
      <hostGroup className='gov.bnl.gums.WildcardHostGroup' 
         wildcard='*.fnal.gov' 
         groups='group1, group2'
        :
</verbatim>

This  would imply that any  proxy from a VirtualOrganizations/VOInfoMS server in the fnal.gov domain would be able to use the GUMS mappings defined in the __groups__ attribute.

Now the problem, with host certificates above....

I am guessing GUMS is parsing the Issuer string with "/" as a delimiter.  When it gets to the CN part of the Issuer string ('host/germigrid1.fnal.gov'), it is only picking up the 'host' part of the string. Since it ('host' in the wilcard attribute) is not found, GUMS says the requestor is denied and we send a 'DENY' back to the callout.

If I change my gums.config to include 'host' in the wildcard attribute:

<verbatim>
  <hostGroups>
    <hostGroup className='gov.bnl.gums.WildcardHostGroup'
       wildcard='*.fnal.gov,host'
    :
</verbatim>

then  a 'PERMIT' is sent back with the correct account name for the mapping.  It appears to be only recognizing the 'host' part of the CN.

My feeling is that this should be resolved in the GUMS part (rather than the Privilege part) of the authorization service since it deals with functionality of the gums.config file processing.

Hope I explained this correctly and have tested the condition adequately... but don't bet on it.

Comments?

John Weigand 
<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->

*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.JohnWeigand - 29 Apr 2005

%STOPINCLUDE%