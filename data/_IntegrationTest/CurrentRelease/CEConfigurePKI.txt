%META:TOPICINFO{author="StevenTimm" date="1143137323" format="1.0" version="1.3"}%
<!-- This is the default OSG Integration template. 
Please modify it in the sections indicated to create your topic!
If you have any comments/complaints about this template, then please email me:
rwg@hep.uchicago.edu.  (Adapted from Atlas wiki template, Ed Moyse)
--> 

<!-- By default the title is the WikiWord used to create this topic !-->
<!-- if you want to modify it to something more meaningful, just replace %TOPIC% below with i.e "My Topic"!-->

---+!!<nop>Configuring the Public Key Infrastructure
%TOC%
%STARTINCLUDE%

---++ Configuring the Public Key Infrastructure
Minimally, you will need a host certificate and private key to identify of your CE.

---+++ Setup and maintenance of Certificate Authority connection
Configure the DOEGrids Certificate Authority (CA) to be used by default by running the utility below. 

If you are given the option "<b>choose the option  which matches "1c3f2ca8 : ...</b>", <br>
then enter "<b>q</b>" at the prompts.
<pre>
  &gt; $VDT_LOCATION/vdt/setup/setup-cert-request
  Reading from /g3dev/globus/TRUSTED_CA
  Using hash: 1c3f2ca8
  Setting up grid-cert-request
  Running grid-security-config...
  ......
</pre>

A <a href="http://www.cs.wisc.edu/vdt/releases/1.3.10/certificate_authorities.html">list of CAs</a> were added as authorized CAs on your system. 

<b>Important Note:</b> In the past, you had the option of putting these certificates in the 
<i>/etc/grid-security/certificates</i> directory or in the local <i>$VDT_LOCATION/globus/TRUSTED_CA</i> directory.
<b>This is no longer an option.</b>  
The OSG installation is pre-configured to place the certificates in 
the local <i>TRUSTED_CA</i> directory.  The <i>edg-crl-upgrade</i> daemon will be updating CRLs in this local directory only. 
 If you want to maintain certificates in the <i>/etc/grid-security/certificates</i> directory you should 
 link it to the local <i>TRUSTED_CA</i> location (symlink in either direction) and copy the CA files appropriately.

Please review the list of authorized CAs and modify the set in $X509_CERT_DIR= $VDT_LOCATION/globus/TRUSTED_CA as needed to match your local policy.  

The daemon <i>edg-crl-upgrade</i> should be running at all times in the background to refresh the CRLs from these CAs.  If CRLs are not kept current, incoming connections will fail. 

To check that it's running:
<pre>
&gt; ps axwww | grep edg-crl-upgrade
</pre>

If not running, do
<pre>
&gt; /etc/init.d/edg-crl-upgraded start
</pre>


The <a href="http://osg.ivdgl.org/twiki/bin/view/Integration/CertScripts">Certificate Scripts Package Guide</a> which has been installed can assist you with choosing Certificate Authorities to trust and and periodically checking that the CRLs (Certificate Revocation Lists) have not expired.

---+++ Request and Install Host Certificate
After the pacman installation of the OSG CE software completes you should have the PPDG-Cert-Scripts  package installed (in $VDT_LOCATION/cert-scripts) and the instructions below show the use of those scripts.

To authorize this resource for use, a host certificate needs to be obtained from an appropriate Certificate Authority. 
<UL>
<LI>Currently the  <a href="http://www.doegrids.org"> DOEGrids CA</a> is the most common CA in use for OSG participants. 
<LI>The iVDGL and PPDG project instructions for getting a certificate are available on the <a href="http://igoc.ivdgl.indiana.edu/RAinfo/newra/">iVDGL RA</a> and <a href="http://www.ppdg.net/RA">PPDG RA</a> sites (RA is Registration Authority). 
</UL>
	 
Here is a brief guide to the process assuming you have a valid User Certificate. 
 
Run the <i>cert-request</i> script  to generate your host's private key (<tt>hostkey.pem</tt>) and submit the certificate request.
<pre>
	$ cd $VDT_LOCATION
	$ source  ./setup.sh
	$ cert-request -ou s -dir .
	Processing OU=Services request.
	Give reason (1 line) you qualify for certificate, such as
	  member of CMS experiment	 or
	  collaborating with Condor team,  etc.
	 reason: <b><i>testing for PPDG</i></b>
	input full hostname: <b><i>goofy.looney.tunes</i></b>
	Generating a 2048 bit RSA private key
.	....................................+++
	 ..................+++
	 writing new private key to './5842key.pem'
	 -----
	 input your email address: <b><i>address@your.email.server</i></b>
	 input your complete phone number: <b><i>9995551212</i></b>
	Choose a registration authority to which you are affiliated.
	_Enter__this____for this registration authority
		  anl	  ANL: Argonne National Lab
		  epa	  NCC-EPA: Environmental Protection Agency
		  esg	  ESG: Earth System Grid
		  esnet	ESnet: DOE Science network
		  fnal	 FNAL: Fermilab host and service certificates
		  ivdgl	iVDGL:  see www.ivdgl.org
		  lbl	  LBNL: Berkeley Lab
		  lcg	  LCG: LHC Computing Grid
		  nersc	NERSC: computer center, see www.nersc.gov
		  o		 Other: if you can not tell what to choose
		  ornl	 ORNL: Oak Ridge National Lab
		  pnnl	 PNNL: Pacific Northwest National Lab
		  ppdg	 PPDG: includes BNL, JLab, SLAC and many HEP & NP experiments
	(choose from left column): <b><i>ppdg</i></b>
	ppdg
	PPDG
	You must agree to abide by the DOEGrids policies,
	at http://www.doegrids.org/Docs/CP-CPS.pdf
	Do you agree (y,N): <b><i>y</i></b>

	Your Certificate Request has been successfully submitted
	Your Certificate Request id: 2005

		  You will receive a notification email from the CA when your certificate
		  has been issued. Please disregard the instructions to download your
		  certificate though a web browser and use the cert-retrieve script instead.
</pre>

After the certificate is approved you will receive an email which includes the serial number of the new certificate.  Use that serial number to retrieve the certificate and move it to the installation directory.
<pre>
  &gt; cert-retrieve -dir . -certnum 0x299
	using CA doegrids
	Checking that the usercert and ./5842key.pem match
	writing RSA key
	./usercert.pem and ./userkey.pem now contain your Globus credential

	&gt; mv ./usercert.pem /etc/grid-security/hostcert.pem
	&gt; mv ./userkey.pem /etc/grid-security/hostkey.pem
	&gt; chmod 444 /etc/grid-security/hostcert.pem
	&gt; chmod 400 /etc/grid-security/hostkey.pem
</pre>


The following command will verify the certificate is readable.  The output shown will be similar, but specific to your request.
<pre>
	&gt; openssl x509 -text -noout -in /etc/grid-security/hostcert.pem

	Certificate:
		 Data:
			  Version: 3 (0x2)
			  Serial Number: 665 (0x299)
			  Signature Algorithm: sha1WithRSAEncryption
			 Issuer: DC=org, DC=DOEGrids, OU=Certificate Authorities, CN=DOEGrids CA 1
			 Validity
				  Not Before: Dec 13 23:55:14 2005 GMT
				  Not After : Dec 13 23:55:14 2006 GMT
			 Subject: DC=org, DC=doegrids, OU=Services, CN=goofey.looney.tunes
			 .........
.</pre>
	 
---+++ Get an LDAP service certificate to run authenticated MDS (optional)
MDS is the monitoring and directory service. The GRIS (Grid Resource info service, a sensor that collects site data and publishes it to MDS) is 
configured by default to allow anonymous access only.  Only those sites which keep anonymous access available will be able to publish their information to the OSG BDII. 

Instructions are in the 
$VDT_LOCATION/post-install/README on how to allow only authenticated and authorized access.  Authenticated access requires an LDAP service certificate (two files), owned by the MDS owner (if you installed as root, the owner is probably daemon -- check).
<pre>
	$ source $VDT_LOCATION/setup.sh
	$ cert-request -ou s -dir . -host <i>hostname.domain.tld</i> -service ldap
</pre>
And follow the instructions, which are very similar to the host cert instructions, except that you are creating <b>ldapkey.pem</b> and <b>ldapcert.pem</b>. More info on service certificates can be found at the <a href="http://www.cs.wisc.edu/vdt/releases/1.3.10/installation_post.html#servicecert">VDT Post Installation Site</a>





<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->

*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.JohnWeigand - 17 Mar 2006

%STOPINCLUDE%

