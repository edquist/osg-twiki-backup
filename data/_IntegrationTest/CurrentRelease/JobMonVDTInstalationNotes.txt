%META:TOPICINFO{author="ElliotLipeles" date="1133373315" format="1.0" version="1.1"}%
%META:TOPICPARENT{name="JobMonReadinessPlan"}%
<!-- This is the default OSG Integration template. 
Please modify it in the sections indicated to create your topic!
If you have any comments/complaints about this template, then please email me:
rwg@hep.uchicago.edu.  (Adapted from Atlas wiki template, Ed Moyse)
--> 

<!-- By default the title is the WikiWord used to create this topic !-->
<!-- if you want to modify it to something more meaningful, just replace %TOPIC% below with i.e "My Topic"!-->

---+!!<nop>%TOPIC%
%TOC%
%STARTINCLUDE%



---+++ JobMon VDT installation
	* VDT installation of Clarens-JobMon
		* Create a directory as your VDT_LOCATION. For example, /data/vdt/
		* Get pacman http://physics.bu.edu/pacman/
		<verbatim>
		click download and put tarball in VDT_LOCATION 
		tar xzvf  pacman-latest.tar.gz
		cd pacpam-3.13.1
		source setup.(c)sh
		</verbatim>
		* You can't use pacman inside the pacman directory. Please change back to $VDT_LOCATION and start installation
		To check if your platform is supported run:
		<verbatim> 
		pacman -platforms
		</verbatim>
		this may complain about not knowing your platform in which case try:
		<verbatim> 
		pacman -platforms -pretend-platform redhat-7.0
		</verbatim>
		<verbatim> 
		pacman -allow unsupported-platforms
		pacman -get http://www.cs.wisc.edu/vdt/vdt_137_cache:Clarens-JobMon
		</verbatim>


	* Update Clarens
		* host cert/key file. As test purpose, please just copy cert/key file from /opt/openpkg/clarens		  . You might have your own host cert/key. To use that, remember put into right path below and change the owner to daemon.daemon. 
	 <verbatim>
	 b0ucsd03:/opt/openpkg/etc/grid-security/hostcert.pem
	 b0ucsd03:/opt/openpkg/etc/grid-security/hostkey.pem
	 </verbatim>
		* Put them into /etc/grid-security/http/ 
		* make sure the owener.group is daemon.daemon
		* update three files and put into the correct directories
			* [[%ATTACHURL%/JobMonTcpServer.py.txt][$VDT_LOCATION/clarens/share/apache2/clarens/JobMon/JobMonTcpServer.py]]
			* [[%ATTACHURL%/JobMonTcpServer_startup][$VDT_LOCATION/clarens/bin/JobMonTcpServer_startup]]  
			* [[%ATTACHURL%/.clarens_access][$VDT_LOCATION/clarens/share/apache2/clarens/JobMon/.clarens_access]]

	* VDT Configuration
		* Using clarens script: $VDT_LOCATION/clarens/bin/clarens-server-config
		<verbatim>
  Cert/key directory /etc/grid-security/http
  Server private key hostkey.pem
  Server certificate hostcert.pem

  [JobMon]
	  Server name			clarens-1.t2.ucsd.edu			

		</verbatim>
	* apache server configuration:
		* $VDT_LOCATION/apache/conf/httpd.conf
		<verbatim>
		ServerName clarens-1.t2.ucsd.edu
		</verbatim>
		* $VDT_LOCATION/apache/conf/ssl.conf. If you want to change port number, this is where you want to look for. Make sure update all port number. The default is 8443.

	* Start apache server	  
		* $VDT_LOCATION/post-install/apache start
		* link to this webserver and make sure you see the clarens homepage

	* Start JobMonTcpServer
		* $VDT_LOCATION/clarens/bin/JobMonTcpServer_startup
		* Check log file and make sure read correct configuration
		<verbatim>
		cat /tmp/JobMon_TCPServer.log
		[timestamp] JobMon TCP server starts at clarens-1.t2.ucsd.edu:2000
		</verbatim> 

	* Now, you are ready to use JobMon. The latest JobMon client script is in 
		<verbatim>
		$VDT_LOCATION/clarens/bin/JobMon.py
		$VDT_LOCATION/clarens/bin/JobMonDaemon.py	  
		</verbatim>

	* Debug:
		* Here is the place to look at apache server error
		<verbatim>
		$VDT_LOCATION/apache/logs/
		</verbatim>  
	* Other reference
		* VDT cache: http://www.cs.wisc.edu/vdt/vdt_137_cache/
		* Where to apply DOE Grid proxy
			* http://www.doegrids.org/pages/cert-request.html


---+++ JobMon Debug
---++++ CNAF: subject name: USERID problem
	* Igor login to the testnode for me to get kerberose ticket and also grid proxy
<verbatim>
 1007  export KRB5CCNAME=/tmp/schsu
 1008  kinit schsu
 1009  export X509_USER_PROXY=/tmp/xschsu
 1010  globus=proxy-info
 1011  globus-proxy-info
 1012  grid-proxy-info
 1013  kx509
 1014  grid-proxy-info
 1015  kxlist -p
 1016  grid-proxy-info
 1017  history
</verbatim>
	* Here's the grid-proxy-info
<verbatim>
[cdfcaf@cdftest schsu]$ grid-proxy-info
subject  : /DC=gov/DC=fnal/O=Fermilab/OU=People/CN=Shih-chieh Hsu/USERID=schsu
issuer	: /DC=gov/DC=fnal/O=Fermilab/OU=Certificate Authorities/CN=Kerberized CA
identity : /DC=gov/DC=fnal/O=Fermilab/OU=People/CN=Shih-chieh Hsu/USERID=schsu
type	  : end entity credential
strength : 512 bits
path	  : /tmp/xschsu
timeleft : 25:21:57  (1.0 days)
</verbatim>
	*  Igor let me try several commands in cdftest.cnaf.infn.it.  Here's the test
<verbatim>
1. grid-proxy-info shows the subject name with USERID:
[cdfcaf@cdftest schsu]$ grid-proxy-info
subject  : /DC=gov/DC=fnal/O=Fermilab/OU=People/CN=Shih-chieh Hsu/USERID=schsu

2. We can still use this proxy to start JobMon service:
[cdfcaf@cdftest schsu]$ python2 JobMonDaemon.py --serverURL https://fcdfcaf019.fnal.gov:8443/clarens --certfile /tmp/xschsu --keyfile /tmp/xschsu --jobname schsu_cnaf

3. Let's check the registered job in Clarens server:

bash-2.05a$ python2 JobMon.py --serverURL https://fcdfcaf019.fnal.gov:8443/clarens --list
  registered time			jobname					 Subject
----------------------------------------------------
[Tue Oct  4 15:19:14 2005] schsu_cnaf /DC=gov/DC=fnal/O=Fermilab/OU=People/CN=Shih-chieh Hsu/UID=schsu
----------------------------------------------------
total  registered 1

4. As you can see, the subject name in Clarens server side  is UID but not USERID.
	However, JobMon works fine. 
</verbatim>

---+++ How do I know DN(subject name) looks like in Clarens
	*  Using /usr/bin/openssl 
<verbatim>
[cdfcaf@cdftest schsu]$ rpm -qf /usr/bin/openssl
openssl-0.9.7a-33.12

[cdfcaf@cdftest schsu]$ /usr/bin/openssl  x509 -subject -in /tmp/xschsu -noout
subject= /DC=gov/DC=fnal/O=Fermilab/OU=People/CN=Shih-chieh Hsu/UID=schsu
</verbatim>  
-- Main.ShihChiehHsu - 16 Sep 2005

<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->

*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.ElliotLipeles - 30 Nov 2005

%STOPINCLUDE%

