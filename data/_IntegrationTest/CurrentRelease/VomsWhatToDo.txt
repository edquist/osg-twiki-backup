%META:TOPICINFO{author="AnneHeavey" date="1115848075" format="1.0" version="1.2"}%
%META:TOPICPARENT{name="VoAdmins"}%
<!-- This is the default OSG Integration template. 
Please modify it in the sections indicated to create your topic!
If you have any comments/complaints about this template, then please email me:
rwg@hep.uchicago.edu.  (Adapted from Atlas wiki template, Ed Moyse)
--> 

<!-- By default the title is the WikiWord used to create this topic !-->
<!-- if you want to modify it to something more meaningful, just replace %TOPIC% below with i.e "My Topic"!-->

---+!!<nop>%TOPIC%
%TOC%
%STARTINCLUDE%
---++Introduction
Here we describe how to install VOMS on your linux machine, and how to create your VO to use with it.


---++What to expect and what you need to know
During the VOMS installation the following things occur:

	1 A mysql database named voms_$VO is created (where $VO is a variable set to the VO name).
	  Four voms mysql users are created ($VO_adm, $VO_que, $VO_seq and $VO_upd)
		 
	1 To support the VOMS server used to process voms-proxy-init requests, 
	  the following file are created:
%BR%
<verbatim>
		$EDG_LOCATION//etc/voms/$VO
		-rw-r----- 1 root daemon 176 May 10 11:50 voms.conf
</verbatim>
			 contains the command line arguments for the /etc/init.d/voms script.
			 used to start the server.
<verbatim>
			-rw-r----- 1 root daemon  12 May 10 11:50 voms.pass 
</verbatim>
contains the database password for the voms server.

	1 To support the maintenance of the VO in the database running under Tomcat4, 
	  the VOMS UI (a.k.a, edg-voms-admin) uses the following files that are created:
%BR%
<verbatim>
		  $EDG_LOCATION/var/etc/edg-voms-admin/$VO
		  -rw-r-----  1 root root	287 May 10 10:40 install-voms-1-mysql-as-root.sql
</verbatim>
			contains the sql ddl to create the voms database and set some privileges
<verbatim>
		  -rw-r--r--  1 root root 10425 May 10 10:40 install-voms-2-mysql-as-root.sql
</verbatim>
			 contains the sql ddl for creating the voms tables.
<verbatim>
		  -rw-r-----  1 root root  3016 May 10 10:40 install-voms-3-mysql-as-root.sql
</verbatim>
			 contains the sql ddl for setting privileges in the voms users for the VO
<verbatim>
		  -rw-r--r--  1 root root  2163 May 10 10:40 install-voms-4-mysql-as-root.sql
</verbatim>
			 contains the initial set of CAs into the VOMS database based on the
			 certificates specified by the '--certdir' argument of the install command
<verbatim>
		  -rw-r--r--  1 root root	619 May 10 10:40 edg-voms-admin-$VO.xml
</verbatim>
			  This is the tomcat 'Context' element necessary for web access.  It specifies the location of the war file and necessary configuration files.
<verbatim>
		  -rw-r--r--  1 root root  1281 May 10 10:40 voms.database.properties 
</verbatim>
			 This properties file is the configuration file for the Tomcat4 services containing database users and passwords.
<verbatim>
		  -rw-r--r--  1 root root  7696 May 10 10:40 voms.service.properties 
</verbatim>
			 This properties file is the configuration file for the Tomcat4 service non-database related.  The file
			 pretty much documents itself.
<verbatim>
		  drwxr-xr-x  2 root root  4096 May 10 10:40 notification
</verbatim>			 
This is the directory containing the customizable email notification messages that are 
			 generated by VOMS.  
			 Refer to the README file in this directory for usage and customization.

	1 To support the client side voms-proxy-init, the following are created:
		$EDG_LOCATION/var/etc/edg-voms-admin/$VO
<verbatim>
		  -rw-r--r--  1 root root	108 May 10 10:40 vomses
</verbatim>
			 contains the configuration file for accessing this VOMS VO for
			 proxy generation using voms-proxy-init.

---++Before starting the installation

Here is a minimal set of information needed to get started.  It represents the arguments used on the install command.

Note: the syntax used for defining this data is a Bourne shell format for setting
		variables and if these variables are set, you can just cut/paste a lot of these
		commands during the installation process.  You, naturally, can do your own
		variable substitution anywhere the varaible is noted. 
		
	 VO=Test		  
		The name of your VO.  Mixed case is permissable. 
		This will also be the top level (root) group for the VO.

	 PORT=15007	
		Port number the voms server listens on for voms-proxy-init requests.
		Each VO has a unique instance of the voms server running and listening on a port.

	 SMTP_HOST=smtp.fnal.gov  
		The hostname of the SMTP delivery service at the site of this VOMS server.
		The host must accept emails for delivery.

	 MAIL_FROM=weigand@fnal.gov 
		The sender email address for the notification messages sent by this VOMS service.
		This should be a read address otherwise the failure notifications will end up in 
		/dev/null.

	 PASSWORD=XVKJUILKJLJK 
		The password of this VO's voms database users (the 4 of them mentioned earlier).
		Please change ffomr what is shown above.

	 VOMS_GROUP=daemon
		The Unix group name of the user the VOMS server runs under. 
		The default with VDT installations is 'daemon'.  

	 TOMCAT_GROUP=daemon
		The Unix group name of the user that tomcat4 runs under. 
		The default with VDT installations is 'daemon'.  

	 CERTDIR=/data/osg-itb-015/globus/TRUSTED_CA
		Not sure if this has any affect as it does not appear to be picking up
		all the CAs in this directory.  Actually, this is a link and this may
		be the problem.

---++Install VOMS

(this part not yet formatted or re-edited 3/11/05 AH)

NOTE:  Everything must be done as root, so su/ssh to root.

You need to know your root password for the mysql database, if you have one
- if you want to set the root password:
	  VDT_LOCATION/mysql/bin/mysqladmin -u root password 'new-password'
	  VDT_LOCATION/mysql/bin/mysqladmin -u root -h $(hostname) password 'new-password'


Set the installed location of the VOMS software
The VDT setup script should set the EDG_LOCATION variable needed by VOMS
if it is installed there. 

  VDT_LOCATION=/data/osg-itb-015
  cd $VDT_LOCATION
  source setup.sh

Execute the edg-voms-admin-configure script with the 'install' argument and
the required set of parameters shown below and described earlier.
- This will create a set of sql files containing the ddl and initial data for 
  the VOMS database for your VO.  
- It will create the directories and data files for the VO.

  PORT=15007
  VO=Test3
  MAIL_FROM=aheavey@fnal.gov
  SMTP_HOST=smtp.fnal.gov
  PASSWORD=annestest3pw
  VOMS_GROUP=daemon
  TOMCAT_GROUP=daemon
  CERTDIR=/data/osg-itb-015/globus/TRUSTED_CA
  
  $EDG_LOCATION/sbin/edg-voms-admin-configure install \
		--port			 $PORT \
		--vo				$VO \
		--voalias		 $VO \
		--mail-from	  $MAIL_FROM \
		--smtp-host	  $SMTP_HOST \
		--password		$PASSWORD  \
		--voms-group	 $VOMS_GROUP \
		--tomcat-group  $TOMCAT_GROUP \
		--certdir		 $CERTDIR


----- output --------------
WARNING: Fallback to file based DB setup.
WARNING: You must feed the database with the generated SQL files manually.

/data/osg-itb-015/voms/sbin/edg-voms-admin-configure uses the following settings:

	EDG_LOCATION		  /data/osg-itb-015/voms
	EDG_LOCATION_VAR	 /data/osg-itb-015/voms/var
	EDG_TMP				 /tmp
	VO name				 TEST1
	VO alias				TEST1
	vomsd port number	15007
	X509 certificate	 /etc/grid-security/hostcert.pem
	CA certificates	  /data/osg-itb-015/globus/TRUSTED_CA
	config userid		 0
	config group tomcat 2
	config group voms	2
	smtp host			  smtp.fnal.gov
	mail from			  root@cd-94372.dhcp.fnal.gov
	Database name		 voms_TEST1

WARNING: Please feed install-voms-1-mysql-as-root.sql to MySQL by hand.
Creating the database...
processing template 
		  /data/osg-itb-015/voms/etc/edg-voms-admin/databases/MySQL/db_create.sql to 
		  /data/osg-itb-015/voms/var/etc/edg-voms-admin/TEST1/install-voms-2-mysql-as-root.sql
WARNING: Please feed install-voms-2-mysql-as-root.sql to MySQL by hand.
WARNING: Please feed install-voms-3-mysql-as-root.sql to MySQL by hand.
...creating the roles
WARNING: Please feed install-voms-4-mysql-as-root.sql to MySQL by hand.
...inserting the initial values
...saving the settings ... processing template 
		  /data/osg-itb-015/voms/etc/edg-voms-admin/voms.database.properties.template to 
		  /data/osg-itb-015/voms/var/etc/edg-voms-admin/TEST1/voms.database.properties
Installing vomsd configuration ... 
		  /data/osg-itb-015/voms/etc/voms/TEST1/voms.pass
		  /data/osg-itb-015/voms/etc/voms/TEST1/voms.database.properties
Service properties ... processing template 
		  /data/osg-itb-015/voms/etc/edg-voms-admin/voms.service.properties.template to 
		  /data/osg-itb-015/voms/var/etc/edg-voms-admin/TEST1/voms.service.properties
context block ... processing template 
		  /data/osg-itb-015/voms/etc/edg-voms-admin/context.xml.template to 
		  /data/osg-itb-015/voms/var/etc/edg-voms-admin/TEST1/edg-voms-admin-TEST1.xml
Miscellaneous files ... Installation complete.

---- end of output ---------------

Heed any and all WARNINGS or ERRORS except the following:
	  WARNING: Fallback to file based DB setup.
	  WARNING: You must feed the database with the generated SQL files manually.
	  WARNING: Please feed install-voms-1-mysql-as-root.sql to MySQL by hand.
	  WARNING: Please feed install-voms-2-mysql-as-root.sql to MySQL by hand.
	  WARNING: Please feed install-voms-3-mysql-as-root.sql to MySQL by hand.
	  WARNING: Please feed install-voms-4-mysql-as-root.sql to MySQL by hand.

The others will be processed in the next step.

The file system directories and files have been created as mentioned in the beginning.
You can view their contents:

  ls -l $EDG_LOCATION/etc/voms
  ls -l $EDG_LOCATION/var/etc/edg-voms-admin
 (Ignore this last one for now) ls -l $EDG_LOCATION/etc/vomses/$VO


(lots of stuff to go here)

---+++ Test for creating simple grid-mapfile on a gatekeeper using  your new VO
(taken from 
"Ye olde grid3 mode" -- will be adapted)

Your VO maintains a secure membership
service which may be queried on the gatekeeper node with the utility
<b>$VDT_LOCATION/edg/sbin/edg-mkgridmap</b> .
To create a <b>grid-mapfile</b> containing an entry for every
member of the VO (probably just yourself, at this stage), first you need to move and start the <b>edg-gridmapfile-upgraded</b> daemon.
<pre> cp $VDT_LOCATION/post-install/edg-gridmapfile-upgraded /etc/init.d/
</pre>
<pre> /etc/init.d/edg-gridmapfile-upgraded start
</pre>

---+++Setup and testing access to VOMS services from a gatekeeper

 The gatekeeper should test the <b>$VDT_LOCATION/edg/sbin/edg-mkgridmap</b> script to ensure
there are no connection errors to your VOMS services. This needs to be
executed as root so that the host certificate can be used. 
First, make a short conf file with just the users known to your VO.
The default conf file is
<pre>
$VDT_LOCATION/edg/etc/edg-mkgridmap.conf
</pre>
Make yours in the same directory. It can just have one line:
<pre>
group vomss://{your voms host}:8443/edg-voms-admin/{your VO name} {account name}
</pre>
E.g.,
<pre>
group vomss://cd-94372.dhcp.fnal.gov:8443/edg-voms-admin/Test3 aheavey
</pre>
Now, run edg-mkgridmap. The --output argument specifies the grid-mapfile name (e.g., test.out); it is NOT optional. The --conf argument specifies the conf file, e.g., my.conf.

<pre>&gt; <b>cd $VDT_LOCATION/edg/sbin</b>
&gt; <b>./edg-mkgridmap --verbose --conf=my.conf --output=test.out</b>
</pre>

  <b> (Anne stopped here 5/11/05)</b>

  The most common error is "Internal Server Error" which indicates an
  authentication failure.  This can happen either because access to the
  VOMS DB has not been completed, or because the local site credentials
  (host certificate and key) are not valid.  Set the X509_USER_CERT and
  X509_USER_KEY variables to to test using a different, valid, certificate
  and key.

---++++ Setting up edg-mkgridmap for local users

The *edg-mkgridmap* script uses a configuration file to dictate 
  its behavior. This is distributed with the Grid3 parameters
  *$VDT_LOCATION/edg/etc/edg-mkgridmap.conf*.

  The *edg-gridmapfile-upgrade* daemon has a similar configuration
  file *$VDT_LOCATION/edg/etc/edg-gridmapfile-upgrade.conf*.

  One of the parameters specifies a _local_ *grid-mapfile* that
  will be added to the output of the *edg-mkgridmap* command.

There are two steps to make this work:

	* Set the *GRIDMAP_LOCAL_FILE* variable in 
	 *$VDT_LOCATION/edg/etc/edg-gridmapfile-upgrade.conf*:

		==GRIDMAP_LOCAL_FILE=$VDT_LOCATION/edg/etc/grid-mapfile-local==

	* Add a new directive to the end of the *$VDT_LOCATION/edg/etc/edg-mkgridmap.conf*:

  Now local *grid-mapfile* entries to this file will be 
  added every time the script is executed.

<tt><b>gmf_local <i>/usr/local/grid</i>/edg/etc/grid-mapfile-local</b></tt>


<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->

*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.AnneHeavey - 11 May 2005
-- Main.John Weigand - 11 May 2005

%STOPINCLUDE%

