%META:TOPICINFO{author="JohnWeigand" date="1134407073" format="1.0" version="1.19"}%
%META:TOPICPARENT{name="ValidationPageRel01"}%
<!-- This is the default OSG Integration template. 
Please modify it in the sections indicated to create your topic!
If you have any comments/complaints about this template, then please email me:
rwg@hep.uchicago.edu.  (Adapted from Atlas wiki template, Ed Moyse)
--> 

<!-- By default the title is the WikiWord used to create this topic !-->
<!-- if you want to modify it to something more meaningful, just replace %TOPIC% below with i.e "My Topic"!-->

---+!!<nop>%TOPIC%
%TOC%
%STARTINCLUDE%


---++Introduction
The [[http://monalisa.caltech.edu][MonALISA]] (Monitoring Agents in A Large Integrated Services Architecture) system provides a distributed service for monitoring, control and global optimization of complex systems. It is based on an ensemble of autonomous multi-threaded, agent-based subsystems which are registered as dynamic services and are able to collaborate and cooperate in performing a wide range of monitoring and decision tasks in large scale distributed applications, and to be discovered and used by other services or clients that require such information. 

---++ Installing the !MonALISA software package
If you are installing OSG 0.3.3 or later, !MonALISA is download in the CE node distribution but not automatically configured and installed.

Prior to OSG  0.3.3, the !MonALISA software package is <u>not </u> downloaded by default in the CE package.
You will have to downbload itit <i>after</i> you have downloaded the CE node.  

To download !MonALISA:
<pre>
  cd  YOUR_PACMAN_DIR
  source setup.sh

  cd YOUR_VDT_LOCATION
  pacman -get iVDGL:MonaLisa

  Package [MonaLisa] found in [http://hep.uchicago.edu/ivdgl/]...
  Package [MonaLisa] found in [http://vdt.cs.wisc.edu/vdt/vdt_138_cache]...
  Package [MonaLisa-Questions] found in [http://vdt.cs.wisc.edu/vdt/vdt_138_cache]...
  Package [Configure-MonaLisa] found in [http://vdt.cs.wisc.edu/vdt/vdt_138_cache]...
  Downloading [MonaLisa-1.3.8.tar.gz] from [vdt.cs.wisc.edu]...
  Downloading [configure_monalisa-1-70.tar.gz] from [vdt.cs.wisc.edu]...
  Downloading [monalisa-1.4.4.tar.gz] from [vdt.cs.wisc.edu]...
		10/17847 kB downloaded...										17/17 MB downloaded...
</pre>
Once downloaded, you will need to run the <b>VDT_LOCATION/vdt./setup/configure_monalisa</b> script to install and configure !MonALISA.

---++Configuration 

After installing [[http://monalisa.caltech.edu][MonALISA]] from the OSG Repository the configuration script vdt/setup/configure_monalisa must be run. This script needs to know the VDT_LOCATION so it is best to 
source the VDT_LOCATION/setup.sh(csh) script prior to running (or run it with the
 '<b>--vdt-install VDT_LOCATION</b>'  option .

For a VDT installed !MonALISA, the configuration variables are stored in 
VDT_LOCATION/vdt-app-data/MonaLisa/monalisa.properties.  After the initial download is complete, this file contains the
default values the !MonALISA will be populated with.  <b>These must be changed</b> as not all answers can be resolved 
automatically.

<TABLE border=1>
<TR bgcolor="blue">
  <TD><center><font color=white><b>
	 VDT_LOCATION/vdt-app-data/Monalisa/<BR>
	 monalisa.properties
	 </center></font></b></TD>
  <TD><B><center><font color=white>Command line<br> arguments</center></font></b></TD>
  <TD><B><center><font color=white>Description</font></center></b></TD>
</TD</TR>
<TR><TD valign=top></TD>
  <TD valign=top>--help</TD><TD valign=top>
	Lists all options
</TD</TR>
<TR><TD valign=top></TD>
  <TD valign=top>--server y|n</TD><TD valign=top>
	Installs the MLD startup script in /etc/init.d.  It does not start the !MonALISA server.
</TD</TR>
<TR><TD valign=top></TD>
  <TD valign=top>
			Pre OSG-ITB 0.3.3:<br>
			--prompt y|n <p>
			OSG-ITB 0.3.3:<br>
			--prompt<br>--noprompt
</TD><TD valign=top>
	If 'y' or --prompt, puts you in question/answer mode. <b>Recommended.</b><p>
	If 'n' or --noprompt, then you need the command line arguments for the attributes you wish to change.<p>
	The script uses the monalisa.properties file (1st column) for all missing arguments.<br>
	This file is always updated regardless of the prompt mode.
</TD</TR>
<TR><TD valign=top> 
VDT_LOCATION="/storage/local/data1/osg"</TD>
  <TD valign=top>--vdt-install</TD><TD valign=top>
	Parent directory of the !MonALISA installation.
	<b>
	Required unless you source the VDT_LOCATION/setup.sh script first.
</TD</TR>
<TR><TD valign=top>
CONTACT_NAME="root"<BR>
CONTACT_EMAIL="root@cmssrv09.fnal.gov"</TD>
  <TD valign=top>--contact-name<BR>--contact-email</TD><TD valign=top>
	This is the name and email address of the person responsible for the site/CE node.
</TD</TR>
<TR><TD valign=top>
MONITOR_GROUP="Test"</TD>
  <TD valign=top>--monitor-group</TD><TD valign=top> 
	  This specifies the group in which !MonALISA places your site/CE for monitoring.
	  <BR>For the OSG, use <b>OSG</b>.
	  <BR>For the OSG ITB, use <b>OSG-ITB</b>.
</TD</TR>
<TR><TD valign=top>
FARMNAME="cmssrv09.fnal.gov"</TD>
  <TD valign=top>--farm</TD><TD valign=top>
	 This is the name by which your CE (where we're using "CE" as equivalent to "site")
	 will be seen by the world, so please choose a name that represents your institution/site.
	 Make sure this name is <b>unique</b> in the OSG-ITB !MonALISA environment.
	 <P>
	 <B>Important:</B> This should be the same as the <b><i>SITE_NAME</i></b> you used when you
		 ran <b><i>configure-osg.sh</i></b> when you were setting up the CE node.
	 <P>
	 How to tell what names are already there? Go to [[http://monalisa.caltech.edu][MonALISA]], click on Repositories, then click
	 on OSG-ITB (the name you will enter as your monitor group name, below). This brings up a map
	 of the OSG-ITB sites. When you're done with the configuration and you start up the daemon, your
	 site should show up here.
</TD</TR>
<TR><TD valign=top>
GANGLIA="y"<BR>
GANGLIA_HOST="localhost"<BR>
GANGLIA_PORT="8649"</TD>
  <TD valign=top><BR>--ganglia-host<BR>--ganglia-port</TD><TD valign=top>
	 To enable Ganglia interaction with MonALISA, answer "y" when asked if you want to connect to a
	 ganglia instance. Otherwise answer "n" for no.
	 <p>
	 If yes, then the hostname and the port on which that Ganglia instance runs is required.
	 <p>
	 To test if !MonALISA is able to access Ganglia monitoring information just telnet on the
	 <b><i>gmond</i></b> port and check if you get an XML.
	 <OL><b><i>telnet localhost 8649</b></i></OL>
</TD</TR>
<TR><TD valign=top>
USER="daemon"</TD>
  <TD valign=top>--user</TD><TD valign=top>
	 The username under which !MonALISA runs on your CE node. <<br>
	 In most cases it will be either daemon or monalisa.
</TD</TR>
<TR><TD valign=top>
VO_MODULES="y"</TD>
  <TD valign=top>--vo-modules y|n</TD><TD valign=top>
	 If yes, then job submission and job queue metrics will be collected by !MonALISA.
	 <p>
	 See [[VOModulesDescription][VO_Modules Description]] for more details on the metrics.
</TD</TR>
<TR><TD valign=top>
CITY=<BR>
COUNTRY=<BR>
LAT="0"<BR>
LONG="0"</TD>
  <TD valign=top>--city<BR>--country<BR>--latitude<BR>--longitude</TD><TD valign=top>
	These attributes will identify your site/node on the world map.<br>
	You can find some approximate values for your geographic location from:
	<OL>http://geotags.com/ <br>
	 or you can search your location on Google.
	</OL>
	<P>
	Use only numbers to specify the geographic location.<br>
	<b>Important:</b> Use "-" to specify West (longitude) or South (latitude).
	For example, for the longitude of 118W, use -118.
</TD</TR>
<TR><TD valign=top>
GLOBUS_LOCATION="$GLOBUS_LOCATION"<BR>
CONDOR_LOCATION="$CONDOR_LOCATION"<BR>
CONDOR_CONFIG="$CONDOR_CONFIG"<BR>
FBS_LOCATION=""<BR>
LSF_LOCATION=""<BR>
PBS_LOCATION=""<BR>
SGE_LOCATION=""</TD>
  <TD valign=top>--globus-location<BR>
				 --condor-location<BR>
				 --condor-config<BR>
				 --fbs-location<BR>
				 --pbs-location<BR>
				 --lsf-location<BR>
				 --sge-location<BR>
					 </TD><TD valign=top>
	This information about Globus and the job managers is needed by the VO_Modules metrics
	See [[VOModulesDescription][VO_Modules Description]] for more details.
	<p>
	The VDT installation attempts to detect what you have and where its at to initially populate
	these values.
</TD</TR>
<TR><TD valign=top>
SHOULD_UPDATE="n"</TD>
  <TD valign=top>--auto-update y|n</TD><TD valign=top>
	<b>It is recommended that this be set to "n".</b>
	<p>
	This tells MonALISA to look (if set to "y") for software updates whenever a restart of
	the !MonALISA daemon (/etc/init.d/MLD) is performed.
	<P>
	For the OSG and OSG-ITB installation the recommendation is to <b>NOT</b> have automatic
	software updates.  This insures consistency in the metrics being reported for site.

</TD</TR>
</TABLE>




 

Here is an example execution of the configuration script with the <b>--prompt</b> argument specfied:<br>
Note:  The <b>--server y</b> argument is also used so the MLD startup file is installed in /etc/init.d.

<pre>
#  source VDT_LOCATION/setup.sh
<b>Pre OSG-ITB 0.3.3:</b>
	 #  $VDT_LOCATION/vdt/setup/configure_monalisa  --prompt y --server y
<b>OSG-ITB 0.3.3:</b>
	 #  $VDT_LOCATION/vdt/setup/configure_monalisa  --prompt  --server y

To configure MonaLisa you need to specify a few parameters.
Please answer the following questions:

Please specify user account to run MonaLisa daemons as: [daemon] daemon

This is the name you will be seen by the world, so please choose
a name that represents you. Make sure this name is unique in the
MonaLisa environment.
Please specify the farm name: [cmssrv09.fnal.gov] ITB_INSTALL_TEST

Your Monitor Group name is important to group your site correctly
in the global site list. OSG users should enter "OSG"

Please enter your monitor group name: [Test] OSG-ITB

Please enter your contact name (your full name): [root] John_Weigand

Contact email (your email): [root@cmssrv09.fnal.gov] weigand@fnal.gov

City (server's location): [] Batavia,IL
Country: [] USA

  You can find some approximate values for your geographic location from:
http://geotags.com/
or you can search your location on Google

For USA: LAT  is about	29 (South)		...  48 (North)
			LONG is about -123 (West coast) ... -71 (East coast)

Location latitude ( -90 (S) .. 90 (N) ): [0] 41.50
Location longitude ( -180 (W) .. 180 (E) ): [0] -88.18

Will you connect to a Ganglia instance (y/n): [y] n

Do you want to run OSG_VO_Modules (y/n): [y] y

Please specify GLOBUS location: [/storage/local/data1/osg/globus] /storage/local/data1/osg/globus

Please specify CONDOR location: [/storage/local/data1/osg/condor] /storage/local/data1/osg/condor

Please specify the path to condor_config: [/storage/local/data1/osg/condor/etc/condor_config] /storage/local/data1/osg/condor/etc/condor_config
Please specify PBS location: []
Please specify LSF location: []
Please specify FBS location: []
Please specify SGE location: []

Do you want to enable the MonALISA auto-update feature (y/n): [n] n

Applying Site Env Variables [ /storage/local/data1/osg/MonaLisa/Service/CMD/site_env ]
		  VDT_LOCATION = /storage/local/data1/osg
		  GLOBUS_LOCATION = /storage/local/data1/osg/globus
		  CONDOR_LOCATION = /storage/local/data1/osg/condor
		  CONDOR_CONFIG = /storage/local/data1/osg/condor/etc/condor_config
		  PBS_LOCATION =
		  LSF_LOCATION =
		  FBS_LOCATION =
		  SGE_LOCATION =
		  SGE_ROOT =
Applying ML Env Variables [ /storage/local/data1/osg/MonaLisa/Service/CMD/ml_env ]
		  FARM_HOME = ${MonaLisa_HOME}/Service/VDTFarm
		  JAVA_HOME = /storage/local/data1/osg/jdk1.4
		  MONALISA_USER = daemon
		  FARM_CONF_FILE = ${FARM_HOME}/vdtFarm.conf
		  FARM_NAME = ITB_INSTALL_TEST
		  SHOULD_UPDATE = false
		  MonaLisa_HOME = /storage/local/data1/osg/MonaLisa
Applying ML Properties [ /storage/local/data1/osg/MonaLisa/Service/VDTFarm/ml.properties ]
		  MonaLisa.LAT = 41.50
		  MonaLisa.ContactEmail = weigand@fnal.gov
		  lia.Monitor.group = OSG-ITB
		  MonaLisa.LONG = -88.18
		  MonaLisa.Country = USA
		  MonaLisa.ContactName = John_Weigand
		  MonaLisa.Location = Batavia,IL
Enabling ML modules [ /storage/local/data1/osg/MonaLisa/Service/VDTFarm/vdtFarm.conf ]
		  Ganglia = disabled
		  monPN_Condor = enabled
		  monPN_PBS = disabled
		  VO Modules (monOsgVoJobs and monOsgVO_IO) = enabled
		  GridFTP log = /storage/local/data1/osg/globus/var/log/gridftp.log
ML configuration was written successfully!
</pre>

---++Automatically start the MonALISA server.
In order to get the MLD startup script installed (if you did not do so when configuring), then run:
<pre>
	 cd VDT_LOCATION
	  source setup.sh
	  $VDT_LOCATION/vdt/setup/configure_monalisa --server y
</pre>

Verify the services have been added and activated (on some systems this will not occur as shown below):
<pre>
	chkconfig --list MLD
	MLD				 0:off	1:off	2:off	3:off	4:off	5:off	6:off
</pre>

To activate the services for the run level:
<pre>
	chkconfig MLD on
</pre>

To start manually:
<pre>
# /etc/init.d/MLD start 
</pre>

---++Configuration files
  
If you want more detail than we present in this section, check the [[http://monalisa.caltech.edu/documentation/ml_ser_ug.html][Service User Guide]] on [[http://monalisa.caltech.edu/][MonALISA]] web site.

---+++ml_env

The file for the global configuration is <b>$MonaLisa_HOME/Service/CMD/ml_env</b>. Configuration parameters in this file are:

<TABLE border=1>
<TR><TD valign=top>
MONALISA_USER 
</TD><TD>
 The name of the user that is running the service. It will not start from other accounts or from the root account.
</TD><TD></TR>

<TR><TD valign=top>
JAVA_HOME 
</TD><TD>
 The path to your current JDK.
</TD><TD></TR>

<TR><TD valign=top>
SHOULD_UPDATE
</TD><TD>
	 Whether or not MonALISA should check for updates when it is started. If this parameter is "true" when MonALISA is started, first it will check for updates and after that it will start. If set to "false" it will not check for updates. This parameter is also used to check for autoupdates when it is running. Please see [[http://monalisa.caltech.edu/documentation/ml_ser_ug.html#start-ml-service-with-autoupdate][Section 2.7, “How to start a Monitoring Service with Autoupdate”]] from the service user guide.
</TD><TD></TR>

<TR><TD valign=top>
!MonaLisa_HOME
</TD><TD>
	 Path to your MonALISA installation directory. Environment variables can also be used. (e.g ${HOME}/MonaLisa)
</TD><TD></TR>

<TR><TD valign=top>
FARM_HOME
</TD><TD>
	 Path to a directory where reside your farm specific files. It's better to place this directory in the Service directory. (e.g. You can use the variable !MonaLisa_HOME defined above. ${MonaLisa_HOME}/Service/MyTest. MonALISA comes with a simple example in ${MonaLisa_HOME}/Service/myFarm.
</TD><TD></TR>

<TR><TD valign=top>
FARM_CONF_FILE
</TD><TD>
	 The file used at the startup of the services to define the clusters, nodes and the monitor modules to be used. It should be in the ${FARM_HOME} directory. (e.g FARM_CONF_FILE="${FARM_HOME}/mytest.conf").
</TD><TD></TR>

<TR><TD valign=top>
FARM_NAME
</TD><TD>
	 The name for your farm (as entered in the configuration above). (e.g FARM_HOME="Caltech_OSG"). We would like to ask the users to use short names to describe the SITE on which they are running MonALISA.
</TD><TD></TR>

<TR><TD valign=top>
JAVA_OPTS
</TD><TD>
	 An optional parameter to pass parameters directly to the Java Virtual Machine (e.g JAVA_OPTS="-Xmx=128m").
</TD><TD></TR>
</TABLE>


---+++site_env

	This file is used to configure the location for the local batch queuing system used by VO_Modules. To edit it:
<pre>
> cd $VDT_LOCATION/MonaLisa/Service/CMD
> vi site_env
</pre>
Here is an example:

<verbatim>
VDT_LOCATION=/usr/local/OSG-0.1.4
export VDT_LOCATION

. $VDT_LOCATION/setup.sh

GLOBUS_LOCATION=/usr/local/OSG-0.1.4/globus
export GLOBUS_LOCATION

CONDOR_LOCATION=/usr/local/OSG-0.1.4/condor
export CONDOR_LOCATION
</verbatim>

---+++vdtFarm.conf
  In this file are specified the modules which are used for monitoring. Here is a simple snapshot.  If the final line (*Tracepath...), is missing from yours, you'll need to add it in to have MonALISA use the Tracepath module.

<verbatim>
#
# Monitoring the Mater node
# The /proc files are used to collect data
#
*Master
>localhost
monProcLoad%30
monProcStat%30
monProcIO%30
#
# Get the monitoring information for the farm
# nodes using Ganglia.
# if the ganglia master demon is running on a
# different system that this one (where MonALISA
# is running) please change the "localhost"  with
# the appropriate system . If Ganglia demon is
# running on a different port that the default one
# please also change the port no.
#
*PN_vdt{monIGangliaTCP, localhost, 8649}%30

# the ABping module
*ABPing{monABPing, localhost, " "}
#
# the VO Jobs module
# these  modules require the VDT environment to run correctly
#
*VO_JOBS{monVoJobs,localhost}%300
#
# the VO io module
#
*VO_IO{monVOgsiftpIO, localhost, }%300
*Tracepath{monTracepath, localhost, " "}
</verbatim>

---++Start Monalisa 
Once you've completed the configuration, start the daemon manually:
<pre>
# /etc/init.d/MLD start 
</pre>
Go to [[http://monalisa.caltech.edu][MonALISA]], click on Repositories, then click on OSG-ITB and verify that your site is represented there. 

---++Some things to look for in your MonALISA log file.
After MonALISA has started, here are a couple items to look for related to the
 <b>VDT_LOCATION/monitoring/grid3-user-vo-map.txt</b> file:
<OL>
 <LI>INFO: osgVO_IO-monOsgVO_IO:  [ computeVoAcctsDiff ] Dead VOs [  No VOs removed ]
		<br>- If a VO was identified as 'dead', it means you  user-vo-map file contained a VO that no users will be mapped to.
<p>
  <LI>osgVO_IO-monOsgVO_IO[validateMappings]: No VO account for unix account (des)<br>
			 osgVO_IO-monOsgVO_IO[validateMappings]:  ignoredUNIXAccts = des
		<br>- Says the 'des' UNIX account will not map to a VO.
</OL>



---++Impact Of  MonALISA On Host Services
CPU  consumption on the host (CE) server is collected using the 'ps' command.  If you are showing 0 (zero) CPU on that
node, there may be a problem with the command.

The MonALISA monitoring agents should have a minimal impact the cpu load  of the host (CE) servers.  The  job and gridftp
metrics collected by the VO_Modules processes have generally  been the biggest consumers of CPU on the host server.
Potential things to look at are:
	* The level of CPU used when your [[VOModulesDescription#Job_Manager_Queue_Status_Metrics][job manager status command]] is executed.
	* The size of your  globus-gatekeeper.log  and gridftp.log files.  Both of these log files are parsed to collect the job and gridftp metrics.  If logrotate (or your own script)  is performed daily on these logs,  CPU utilization will be minimal.  These files should be rotated at midnight and no more that once per day.




<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->

*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.RobGardner - 09 Mar 2005<br>
-- Main.IosifLegrand - 18 Mar 2005<br>
-- Main.AnneHeavey - 2 Jun 2005<br>
-- Main.JohnWeigand - 03 Jun 2005 - added [[VOModulesDescription][VO_Modules Description]]  page to VO_Modules TOC<br>
-- Main.JohnWeigand - 13 Jun 2005 - added  Impact Of  MonALISA On Host Services to TOC<br>
-- Main.JohnWeigand - 30 Nov 2006 - updated for ITB 03.1 / VDT 1.3.8 releases

%STOPINCLUDE%

