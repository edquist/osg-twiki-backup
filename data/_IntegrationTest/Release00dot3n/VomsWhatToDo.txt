%META:TOPICINFO{author="ElizabethChism" date="1466010183" format="1.1" version="1.53"}%
%META:TOPICPARENT{name="VoAdmins"}%
<!-- This is the default OSG Trash/Integration template. 
Please modify it in the sections indicated to create your topic!
If you have any comments/complaints about this template, then please email me:
rwg@hep.uchicago.edu.  (Adapted from Atlas wiki template, Ed Moyse)
--> 

<!-- By default the title is the WikiWord used to create this topic !-->
<!-- if you want to modify it to something more meaningful, just replace %TOPIC% below with i.e "My Topic"!-->

---+!!<nop>How to Install VirtualOrganizations/VOInfoMS
%TOC%
%STARTINCLUDE%
---++Introduction
The [[http://hep-project-grid-scg.web.cern.ch/hep-project-grid-scg/voms.html VirtualOrganizations/VOInfoMS]] (Virtual Organization Membership Service) has three main parts: 
<OL>
<LI>A !MySql database which is a persistent repository for VirtualOrganizations/VOInfo membership information, 
<LI>The VirtualOrganizations/VOInfoMS Admin which provides the Web UI/services to maintain the VirtualOrganizations/VOInfo membership. This requires Apache/Tomcat-4.
<LI>The VirtualOrganizations/VOInfoMS server, a daemon process which services the <i>voms-proxy-init</i> requests.
</OL>

Also  included in the installation is a VirtualOrganizations/VOInfoMS client containing the <i>voms-proxy-init</i> for testing.

Here we describe how to install and configure VirtualOrganizations/VOInfoMS on your Linux machine. When you install VirtualOrganizations/VOInfoMS as described here, you get all three parts.  It comes with a test VirtualOrganizations/VOInfo called VDT. We suggest that you use it for testing. You're going to need to create your real VirtualOrganizations/VOInfo with the appropriate name. Instructions for doing that are also on this page.

We also describe how to remove a VirtualOrganizations/VOInfo from VirtualOrganizations/VOInfoMS if the need arises.

---++Known Problems
<OL>
<p><LI>
GOC ticket 66899 / 
<a href="http://vdt.cs.wisc.edu/rt/index.html?user=guest&pass=guest&q=1478">VDT ticket 1478</a> -
Problem running <i>configure-voms</i> script after <i>root</i> password for <nop>MySql database is set.
<br><b>Resolution</b>: Fixed in VDT 1.3.11.

<p><LI>
GOC ticket 74637/ 
<a href="http://vdt.cs.wisc.edu/rt/index.html?user=guest&pass=guest&q=1517">VDT ticket 1517</a> -
Problem with the the script to remove a VirtualOrganizations/VOInfo from the VirtualOrganizations/VOInfoMS instance. .  Running <i>configure-voms  --remove</i> does not work.
<br><b>Resolution</b>: Fixed in VDT 1.3.11.

<p><LI>
GOC ticket 74641/ 
<a href="http://vdt.cs.wisc.edu/rt/index.html?user=guest&pass=guest&q=1516">VDT ticket 1516</a> -
The <i>configure-voms</i> script does not set up the log rotation of the VirtualOrganizations/VOInfoMS log files correctly.
<br><b>Resolution</b>: Fixed in VDT 1.3.11.

</OL>

%INCLUDE{"InstallationAssistance"}%

%INCLUDE{"PacmanInfo"}%

---++Pre-requisites for VirtualOrganizations/VOInfoMS  Installation

---+++Certificates
If you do not already have the necessary certificates on this host, this can  be done as a post-install step. Instructions for getting the http certificate can be found in the $VDT_LOCATION/vdt/post-install/README.

<OL>
<LI><b>host certificate</b>: Used by the VirtualOrganizations/VOInfoMS server.  The host certificate should be installed in /etc/grid-security with ownership and permissions as:
<pre>
/etc/grid-security
-rw-r--r--  1 root   root    1176 Nov  7 16:38 hostcert.pem
-r--------  1 root   root     887 Nov  7 16:38 hostkey.pem
</pre> 
<font color=darkblue><b>Note:</b></font>  During the installation process, the host certificates are cloned, i.e., a copy made and named <i>vomscert(key).pem</i> with ownership by <i>daemon</i>.  This is done since the VirtualOrganizations/VOInfoMS server is set up to run as daemon and it is not known if other services on this host also require a host certificate. <font color=darkblue><b>This is  especially important to be aware when the host certificate is renewed or replaced.  These "cloned" certs need to be "re-cloned" manually.</b></font>

<p>
<LI><b>http certificate</b>: Used by apache.  The http certificate for your system should be installed in  /etc/grid-security/http with ownership and permission as:
<pre>
/etc/grid-security
-rw-r--r--  1 root root 1176 Nov  7 16:38 httpcert.pem
-r--------  1 root root  887 Nov  7 16:38 httpkey.pem
</pre>
 If you do not already have one on this machine, this will have to be done as a post-install step. Instructions for getting the certificate can be found at this 
<A HREF="http://www.cs.wisc.edu/vdt/requesting_cert.html">VDT site</A>. 
        Also refer to any instructions you may find in the $VDT_LOCATION/vdt/post-install/README that may be related to this.
<p>
</OL>


---+++Previous installations
If you have an OSG VirtualOrganizations/VOInfoMS running and you're about to reinstall or if any of the following daemons are installed and running on your machine, see the [[#ShutdownGuide][Shutdown instructions]] below. 


    
---++What's  Getting Installed

---+++Software
These instructions are for  ITB 0.3.6 (VDT 1.3.10) release of VirtualOrganizations/VOInfoMS which installs this software
<pre>
    Apache HTTPD 2.2.0
    CA Certificates v11 (includes IGTF 1.0 CAs)
    EDG CRL Update 1.2.5
    GPT 3.2
    Java SDK 1.4.2_10
    Logrotate 3.7
    MySQL 4.1.11
    Apache Tomcat 5.0.28
    VOMS 1.6.10.2
    VOMS Admin (client 1.2.10, interface 1.0.2, server 1.2.10) 1.2.10-r0
</pre>

---+++Services - /etc/init.d
The services installed and activated are:
<pre>
<b>/etc/init.d</b>
-rwxr-xr-x  1 root root  1684 Feb 21 23:02 edg-crl-upgraded
-rwxr-xr-x  1 root root  6591 Feb 21 23:02 mysql
-rwxr-xr-x  1 root root  4039 Feb 21 23:03 apache 
-rwxr-xr-x  1 root root  3289 Feb 21 23:03 tomcat-5
-rwxr-xr-x  1 root root  8890 Feb 22 09:24 voms
</pre>

In addition, during the installation, a test VirtualOrganizations/VOInfo called 'VDT' will be created  if  your host certificate is available before you install.  If the host certificate is not available, configuration of the 'VDT' VirtualOrganizations/VOInfo will have to be performed separately.

Note: The <i>edg-mkgridmap</i> client in previous releases of VDT (1.3.2 and below) may be incompatible with this release.   If this is of concern to you, you will have to run both an older and a newer VirtualOrganizations/VOInfoMS to retain compatibility with the older versions of <i>edg-mkgridmap</i>..



---++Installing VirtualOrganizations/VOInfoMS

---+++Installation user
 Must be done as root.

---+++Installation package
After installing pacman:
<pre>
&gt  cd &lt PACMAN_DIR &gt
&gt  source setup.sh
</pre>

---+++Installation location
 Wherever you like.  Shown below as as the VDT_LOCATION variable.
<pre>
&gt  VDT_LOCATION=/usr/local/osg
&gt  mkdir $VDT_LOCATION
</pre>

---+++Installation Cache
 iVDGL:voms
<pre>
&gt  cd $VDT_LOCATION 
&gt  pacman -get  iVDGL:voms
</pre>

---+++Installation output/questions
<pre>
     :
Do you want to add [http://hep.uchicago.edu/ivdgl/] to [trusted.caches]? (y or n): <b><i>y</b></i>
   :   -----------------------------------------------------
Do you want to add [http://vdt.cs.wisc.edu/vdt_1310_cache] to [trusted.caches]? (y or n): <b><i>y</b></i>
   :   -----------------------------------------------------
The VDT is unable to recognize your platform.  This version of the VDT is
supported on several Linux releases:

    RedHat 7 x86
    RedHat 9 x86
    RedHat Enterprise Linux 3 AS x86, x86-64 and ia64
    RedHat Enterprise Linux 4 AS x86
    Fedora Core 3 x86
    Fedora Core 4 x86
    Debian 3.1 x86
    ROCKS 3.3 x86 
    Fermi Scientific Linux 3.0 x86
    SuSE Linux 9 ia64

The VDT may work on other platforms, but it's not guaranteed.  If you
encounter problems and send mail to the VDT team for support please mention 
that you are installing the VDT on an unsupported platform.

Do you wish to continue? [y/n] <b><i>y</b></i>
   :   -----------------------------------------------------
   :
VDT 1.3.10 installs a variety of software, each with its own license.
In order to continue, you must agree to the licenses.
You can view the licenses on-line at:

     http://vdt.cs.wisc.edu/licenses/1.3.10

After the installation has completed, you will also be able to
view the licenses in the "licenses" directory.

Do you agree to the licenses? [y/n]  <b><i>y</b></i>
   :   -----------------------------------------------------
    :
The VDT typically installs public certificates and signing policy files
for the well-known public CA's. This is necessary in order for you to
perform GSI authentication with any remote Grid services (that have
service/host certificates signed by these CA's).

For more information please refer to the VDT documentation:
http://vdt.cs.wisc.edu/setup_ca.html

Where would you like to install CA files?
Choices:
        r (root)  - install into /etc/grid-security/certificates
            (existing CA files will be preserved)
        l (local) - install into $VDT_LOCATION/globus/share/certificates
        n (no)    - do not install
<b><i>r</b></i>
   :   -----------------------------------------------------   

Several services provided by the VDT create unbounded log files.  If you wish, we can rotate those file on a daily basis.
Would you like to setup daily rotation of VDT log files?
Possible Answers:
     y: Yes. Please remove any old instances of the service and run
        this one..
     n: No. Please remove any old instances of the service, but don't
        run this one.
     s: Skip. Don't run the service from this installation, and if
        there is already an instance running, leave it alone.
<b><i>y</b></i>
   :   -----------------------------------------------------

If you would like, we can configure VOMS to start automatically at boot time.

Configuring the VOMS daemon requires
  - changes to /etc/init.d (or /etc/rc.d/init.d)
  - starting up a MySQL server
  - starting up an Apache and Tomcat server

Would you like to enable the VOMS server to run automatically?

Possible Answers:
     y: Yes. Please remove any old instances of the service and run
        this one..
     n: No. Please remove any old instances of the service, but don't
        run this one.
     s: Skip. Don't run the service from this installation, and if
        there is already an instance running, leave it alone.
 
   <b><i>y</b></i>
   :   -----------------------------------------------------

Do you want the EDG CRL update daemon to be run automatically when
your computer starts up? If so, we will install one file,
edg-crl-updated, into etc/rc.d/init.d/.

It will periodically update the European DataGrid (EDG) certificate
revocation lists (CRLs) It is essential if you are collaborating with
people from the EDG, and not important if you are not.

Do you want the EDG CRL update daemon to be installed? [y/n] <b><i>y</b></i>
   :   -----------------------------------------------------
   :
   :
Downloading [configure_voms-1-222.tar.gz] from [vdt.cs.wisc.edu]...
</pre>
The above line should be the last line of output you see.  The version number of the tarball may be different 
than that shown above.  Do not be concerned with this.

---+++Verify the  installation completed successfully
To verify  the pacman installation was successful, there should be a setup.(c)sh in the VDT_LOCATION.   If present, source it.
<pre>
&gt  cd $VDT_LOCATION
&gt  source setup.sh
</pre>
<b>Note:</b> This does not necessarily indicated that everything was installed and configured successfully.  It just verifies that the pacman installation completed successfully.  There is a lot of other magic that occurs during the process that should be validated.



---++Verifying the Success of the Installation
If all the required certificates were in place prior to the pacman installation, a default VirtualOrganizations/VOInfo called <i>VDT</i> has been created already and all the daemon services should be up and running.
This section will take you through the steps necessary to verify that and can also serve as a basic operational trouble shooting guide.

If the certificates were installed <b>after</b> the pacman installation, you will probably fail on most of the verification steps and will have to restart each daemon manually.

For  all the verifications, you will need to source the VDT setup.(c)sh script:
<pre>
&gt  cd &lt VDT_LOCATION &gt
&gt  source setup.sh
</pre>

---+++Verifying  the edg-crl-upgrade daemon
The edg-crl-upgrade daemon  (essential if you are collaborating with EDG people) updates the certificate revocation lists on a daily (default) basis.
<pre>
<b>/etc/init.d</b>
-rwxr-xr-x  1 root root  1684 Feb 21 23:02 edg-crl-upgraded
</pre>
To verify it is running:
<pre>
&gt   ps -efwww |  grep edg-crl-upgrade
root  13268  1  0 Feb21 ?   00:00:00 /bin/sh /usr/local/osg/edg/sbin/edg-crl-upgrade
</pre>
<b>Note:</b>  Verify that it is the only one running and the path contains your VDT_LOCATION.


To verify it created the crl files:
<pre>
&gt   ls -l  $X509_CADIR/*.r0
-rw-r--r--  1 root root  61312 Feb 22 10:48 /usr/local/osg/globus/TRUSTED_CA/01621954.r0
-rw-r--r--  1 root root   7657 Feb 22 10:48 /usr/local/osg/globus/TRUSTED_CA/03aa0ecb.r0
-rw-r--r--  1 root root   1868 Feb 22 10:48 /usr/local/osg/globus/TRUSTED_CA/1149214e.r0
       :   
</pre>
<b>Note:</b> The number of crl files does not directly correlate to the number of CAs, 
          but there should be at least 1 and they should never be more than a day old
           unless you've change the default interval.



---+++Verifying  the apache/tomcat daemon
Apache and Tomcat are used to access the WEB user interface of  VirtualOrganizations/VOInfoMS. 
<pre>
<b>/etc/init.d</b>
-rwxr-xr-x  1 root root 4039 Feb 21 23:03 apache
-rwxr-xr-x  1 root root 3289 Feb 21 23:03 tomcat-5
</pre>
To verify <b>apache</b> is running:
<pre>
&gt   ps -efwww |  grep  apache
<b>apache</b>    2585 10881  0 Feb21 ?        00:00:00 /usr/sbin/httpd
<b> (there will be a number of these)</b>
          :
root      8924     1  0 Feb21 ?        00:00:03 /usr/local/osg/<b>apache</b>/bin/httpd -d /usr/local/osg/<a>apache</b> 
         -k start -f  /usr/local/osg/<b>apache</b>/conf/httpd.conf
daemon   15165  8924  0 09:24 ?        00:00:00 /usr/local/osg/<b>apache</b>/bin/httpd 
<b>(and a number of these)</b>
</pre>
<b>Note:</b>  Verify that it is the only one running and the path contains your VDT_LOCATION.  
In the case of apache, there should be several <i>/usr/bin/httpd</i> processes owned by apache running in
addition to the <i>$VDT_LOCATION/apache/bin/httpd</i> processes.

To verify <b>tomcat</b> is running:
<pre>
   &gt   ps -efwww |  grep tomcat
   daemon   15238     1  0 09:24 pts/2    00:00:15 /usr/local/osg/jdk1.4/bin/java     
   -Djava.endorsed.dirs=/usr/local/osg/<b>tomcat</b>/v5/common/endorsed
   -classpath    /usr/local/osg/jdk1.4/lib/tools.jar:/usr/local/osg/tomcat/v5/bin/bootstrap.jar:/usr/local/osg/tomcat/v5/bin/commons-logging-api.jar 
   -Dcatalina.base=/usr/local/osg/tomcat/v5 -Dcatalina.home=/usr/local/osg/tomcat/v5      
   -Djava.io.tmpdir=/usr/local/osg/tomcat/v5/temp org.apache.catalina.startup.Bootstrap start
</pre>
<b>Note:</b>  
<UL>
<LI>There should be only one tomcat process running with <i>init (pid=1)</i> as it's parent.
<LI>Verify that it is the only one running and the path contains your VDT_LOCATION.
</UL>

---+++Verifying  the mysql daemon
!MySql  is used to provide persistent storage of the VirtualOrganizations/VOInfoMS VirtualOrganizations/VOInfo membership data.
<pre>
   <b>/etc/init.d</b>
   -rwxr-xr-x  1 root root 6591 Feb 21 23:02 mysql
</pre>
To verify it is running:
<pre>
&gt   ps -efwww |  grep  mysql  
root      6606     1  0 Feb21 ?        00:00:00 /bin/sh /usr/local/osg/mysql/real-bin/mysqld_safe 
--defaults-file=/usr/local/osg/mysql/var/my.cnf --datadir=/usr/local/osg/vdt-app-data/mysql/var 
--pid-file=/usr/local/osg/vdt-app-data/mysql/var/cmssrv08.fnal.gov.pid
<b>(The parent mysql process is the only one displayed here)</b>
</pre>
<b>Note:</b>  Verify that it is the only one running and the path contains your VDT_LOCATION.

---+++Verifying the VirtualOrganizations/VOInfoMS WEB UI
If all the certificates were in place prior to the pacman installation, a default VirtualOrganizations/VOInfo called <i>VDT</i> was configured.
To verify it is accessible:
<OL>
<LI>Point a certificate-enabled browser window to             
        <i>https://<b>your.host.name</b>:8443/voms/VDT</i>
  <UL><LI>You should be prompted for your certificates passphrase
            <LI>You should get a <i>Welcome to the VDT VO</i> page
   </UL>
<LI>In  the left hand menu under <i>FOR VirtualOrganizations/VOInfo USERS</i>, select <i>My membership details</i>.<br>
         The membership details page should say <i>You are not currently a member of this VO</i>, which you  are not yet.
<LI>Do a <i>Back</i>  in your browser.
<LI.>Now select <i>Administer the VO </i>  under the <i>FOR VirtualOrganizations/VOInfo MANAGERS</i>  item on the left menu..<br>
          Then select <i>Create a New VirtualOrganizations/VOInfo User</i> from the new menu.  You should get <i>Access denied</i>.
<LI>Do a <i>Back</i> in your browser, twice, to return to the main page again.
<LI>Select <i>Configuration information</i> under the <i>Configuration</i> menu item.  The 3 items 
        displayed provide the syntax and data content used for the various authorization modes available on the grid  for your VO.  
</OL>
At this point, you know your VirtualOrganizations/VOInfoMS WEB UI is functional.

---+++Verifying the VirtualOrganizations/VOInfoMS server daemon
The VirtualOrganizations/VOInfoMS server's only purpose is to service <i>voms-proxy-init</i> requests for your VO.
<pre>
<b>/etc/init.d</b>
--rwxr-xr-x  1 root root 8890 Feb 22 09:24 voms
</pre>
To verify <b>voms</b> is running:
<pre>
&gt   ps -efwww | grep edg-voms
daemon   13033     1  0 Feb21 ?        00:00:00 /usr/local/osg/voms/sbin/edg-voms  --conf   /usr/local/osg/voms/etc/voms/<b>VDT</b>/voms.conf
daemon   15396     1  0 Feb21 ?        00:00:00 /usr/local/osg/voms/sbin/edg-voms --conf /usr/local/osg/voms/etc/voms/<b>VDT</b>/voms.conf
</pre>
<b>Note:</b> 
<UL>
<LI>There are individual <i>VirtualOrganizations/VOInfoMS servers</i> for each VO, each using a unique port
         to service requests.
<LI>There are usually 2 <i>edg-voms</i> processes that are running for each VO.
        There are times when only 1 is running and the server works fine.  
         This is one of those mysteries in life that one just accepts.
<LI>Verify that  the path contains your <i>VDT_LOCATION</i>.
</UL>

---+++Verifying the VirtualOrganizations/VOInfoMS version
The voms-admin and voms server versions can be verified using the following command:
<pre>
&gt  voms-admin -vo VDT  -version
voms-admin v1.2.10-1
server side is v1.2.10
</pre>
If the versions do not display, then there is a problem with either the web interface or the VirtualOrganizations/VOInfoMS server.

---++Securing your server
All access to VirtualOrganizations/VOInfoMS is through apache and tomcat, even the command line <i>voms-admin</i> command.  To secure your server and require only authenticated access, run the following command.
<pre>
 &gt  $VDT_LOCATION/vdt/setup/configure_apache --secure
 &gt  /etc/init.d/apache restart
</pre>

---++Configuring VirtualOrganizations/VOInfoMS - the configure_voms script
The <i>$VDT_LOCATION/vdt/setup/configure_voms</i> script has been provided for creating and removing VOs from VirtualOrganizations/VOInfoMS.

You may be wondering why you are being told about this script before describing the installation process.  
During the VirtualOrganizations/VOInfoMS installation process, this script is executed and creates a 'test' VirtualOrganizations/VOInfo called <i>VDT</i>.  After the installation is completes, the verification process  uses this <i>VDT</i> tests VirtualOrganizations/VOInfo to determine the success of the installation.  By reviewing this section of the documentation now, you will be more aware of what to look for when you create your own VirtualOrganizations/VOInfo(s).

The <i>configure_voms</i> script is also used to remove any VOs that are no longer needed and will be documented here as well.

---+++Creating a VO
All VOs should be created using the <i>configure_voms</i> script.
<p>Syntax:
<pre>
 configure_voms --server &lt y,n &gt
                --vo &lt vo name &gt
                --mail-from &lt from address on voms mail &gt
                --smtp-host &lt outgoing smtp host &gt
                --vdt-install &lt VDT installation root &gt
</pre>

<b>Note:</b> The <i>$VDT_LOCATION/vdt-install.log</i> contains any messages from its execution  that are not visible in stdout/err on the command line.


The <i>configure_voms</i> script does the following (note: the examples that follow show the files for the <i>VDT</i> test VirtualOrganizations/VOInfo that is created):
<OL>
<LI>The host certificate in the <i>/etc/grid-security</i> directory is cloned as vomscert(key).pem owned by the <i>daemon</i> user.  This only occurs when the first VirtualOrganizations/VOInfo is created.
<p>
<LI>Creates a !MySql database called <i>voms_VDT</i>.
<p>
<LI>Creates all the necessary VirtualOrganizations/VOInfoMS configuration files for your VO.
<pre>
<b>$VDT_LOCATION/vdt-app-data/voms  </b>
-rw-r--r--  1 root root    5 Feb 27 23:08 last_port   <b>(Maintains the last port number assigned a  VO's server)</b>
drwxr-xr-x  5 root root 4096 Feb 27 23:08 voms   <b>(VOMS server configuration data for each VO)</b>
drwxr-xr-x  5 root root 4096 Feb 27 23:08 voms-admin   <b>(WEB UI configuration data for each VO)</b>
drwxr-xr-x  2 root root 4096 Feb 27 23:08 vomses   <b>(voms-proxy-init configuration file for each VO)</b>

<b>$VDT_LOCATION/vdt-app-data/voms/voms/VDT</b>
-rw-r-----  1 daemon daemon 341 Feb 27 23:03 voms.conf  
-rw-r-----  1 daemon daemon  23 Feb 27 23:03 voms.pass   

<b>$VDT_LOCATION/vdt-app-data/voms/voms-admin/VDT</b>
-rw-r--r--  1 root   root    700 Feb 27 23:03 voms-admin-VDT.xml
-rw-r-----  1 daemon daemon 1092 Feb 27 23:03 voms.database.properties
-rw-r--r--  1 root   root     95 Feb 27 23:03 vomses                      
-rw-r--r--  1 root   root   9349 Feb 27 23:03 voms.service.properties

<b>$VDT_LOCATION/vdt-app-data/voms/vomses</b>
-rw-r--r--  1 root root 100 Feb 27 23:03 VDT   <b>(grid-proxy-init  configuration file for the VDT VO)</b>

<b>&gt cat VDT</b>
"VDT" "cmssrv08.fnal.gov" "15000" "/DC=org/DC=doegrids/OU=Services/CN=cmssrv08.fnal.gov" "VDT" "32"

</pre>
<p>
<LI>Updates the apache, tomcat and glite configuration files for the new VirtualOrganizations/VOInfoMS VO.
<p>
<LI>Restarts all the necessary services including the VirtualOrganizations/VOInfoMS server.
</OL>

Additional functions performed by the <i>configure_voms</i> script are:
<OL>
<LI>
A Global-ACL is created for the host certificate for this server with <i>allow all</i> 
capabilities.  This allows the <i>root</i> user on this machine to update the VirtualOrganizations/VOInfoMS VirtualOrganizations/VOInfo using the command line interface
command <i>voms-admin</i>.  So, in effect, the <i>root</i> user is already a VirtualOrganizations/VOInfo-Admin  in this VO.
<p>
This <i>root</i> user capability can be removed <b>after</b> an individual  is assigned the VirtualOrganizations/VOInfo-Admin role as described in the next section.
<p>
<LI>
A second Global-ACL is created with <i>allow list</i> capabilities for anyone that presents a 
certificate issued by a known VO.  The purpose for this is two-fold:
<p>
  <UL>
      <LI>Those sites using <a href="http://osg.ivdgl.org/twiki/bin/view/Trash/Trash/Integration/GumsAdmins">GUMS servers</a> will be able to access your VirtualOrganizations/VOInfo without the VirtualOrganizations/VOInfo-Admin having to individually provide this Global-ACL capability on a case by case basis.   This is the default configuration and can be changed.
<p>
      <LI>It allows VirtualOrganizations/VOInfo members or (those that think they are VirtualOrganizations/VOInfo members) to query the VirtualOrganizations/VOInfoMS to troubleshoot problems in getting voms proxies and verify their membership in various groups and role assignments. 
  </UL>
</OL>

-
Many default values were applied during this process.  The values applied can  be viewed in the 
<i>$VDT_LOCATION/vdt-install.log</i> and searching for  
'loaded by vdt/setup/configure_voms'.



---+++Removing a VO 
*NOTE:* Removing a VirtualOrganizations/VOInfo is not functional in releases up to OSG Version 0.4.1. (See Known Problems)

The <i>configure_voms</i> script is also used to remove a VirtualOrganizations/VOInfo from the VirtualOrganizations/VOInfoMS installation:
<pre>
 configure_voms  -vo &lt vo name &gt  --remove
</pre>
The script will 
<UL><LI>stop the VirtualOrganizations/VOInfo's VirtualOrganizations/VOInfoMS server, 
          <LI>remove the associated !MySql database, 
          <LI>remove all configuration files for the VO
           <LI>restart tomcat and apache
</UL>



---++Enabling a VirtualOrganizations/VOInfoMS VO
Several things have to be done to actually enable your VirtualOrganizations/VOInfo to begin accepting membership, used for voms proxy generation, and used for the Compatibility and Full  Privilege 
<a href="http://osg.ivdgl.org/twiki/bin/view/Trash/Trash/Integration/OsgCEAuthorization">authorization modes</a> on compute (CE) and storage (SE) element  nodes.

The following sub-sections will reference the default <i>VDT</i> in the text and examples.  When enabling your 
'real' VO, the same steps are required and, where different, it will be noted.


---+++Establishing a VirtualOrganizations/VOInfo-Admin
A person (or persons) can be designated as the VirtualOrganizations/VOInfo-Admin for the VirtualOrganizations/VOInfoMS VirtualOrganizations/VOInfo created.  This person(s) has 
administrative capability within VirtualOrganizations/VOInfoMS that the normal VirtualOrganizations/VOInfo member will not have.  

There are 2 options for adding this capability to an individual:
<OL>
  <LI>The individual <u>is not</u> a member of the VO.   A Global-ACL for that individual with <i>allow all</i> capability allows a person to administer the VirtualOrganizations/VOInfo's VirtualOrganizations/VOInfoMS from the command line and WEB UI.<p>
        <UL>
        <LI>Individual's certificate file is available:
<pre>
&gt  voms-admin -vo <b>VO</b> add-acl-entry Global-ACL allow all <b>usercert.pem</b>
</pre>
          <LI>Individual's certificate file is <u>not</u> available:
<pre>
&gt  voms-admin -vo <b>VO</b>  -nousercert  add-acl-entry  Global-ACL allow all "<b>USER DN</b>" "<b>USER CA</b>"
</pre>
           </UL>

  <LI>The individual <u>is</u> a member of the VO.  This can be accomplished by giving the individual the Global-ACL
           capability above or by first adding them to the VirtualOrganizations/VOInfo as a member (described in the next section) and then assigning them the <i>VirtualOrganizations/VOInfo-Admin</i> role with the following command:<p>
        <UL>
        <LI>Individual's certificate file is available:     
<pre>
&gt  voms-admin -vo <b>VO</b> assign-role  <b>GROUP</b> VO-Admin <b>usercert.pem</b>
</pre>
          <LI>Individual's certificate file is <u>not</u> available:
<pre>
&gt  voms-admin -vo <b>VO</b> assign-role  <b>GROUP</b> VO-Admin  "<b>USER DN</b>" "<b>USER CA</b>"
</pre>
           </UL>      
</OL>

---+++Adding  a user to the VO
Individuals with the <i>VirtualOrganizations/VOInfo-Admin</i> role or the  <i>allow all</i> Global-ACL are referred to as VirtualOrganizations/VOInfo Managers in VirtualOrganizations/VOInfoMS and are the only ones who can add new members via the web ui.
In normal practice, users will request VirtualOrganizations/VOInfo membership by accessing the <i>New user registration</i> menu item on the main VirtualOrganizations/VOInfoMS web page.  This document will not go into the details of that process here, nor will it address the basic usage and navigation of the VirtualOrganizations/VOInfoMS web ui.

The purpose of this section is to show you how to add a user for the purposes of assigning the <i>VirtualOrganizations/VOInfo-Admin</i> role as a part of the initial setup.   

Four data items are required for each user:
<UL><LI>DN
          <LI>CA
           <LI>Common Name (CN part of the DN or just 1st and last name so you can be easily identified)
           <LI>email address 
</UL>

If you have the user's certificate file available, then these 4 items are derived from that.
        <UL>
        <LI>Individual's certificate file is available:     
<pre>
&gt  voms-admin -vo <b>VO</b> add-member  <b>GROUP</b>  <b>usercert.pem</b>
</pre>
          <LI>Individual's certificate file is <u>not</u> available:
<pre>
&gt  voms-admin -vo <b>VO</b> add-member  <b>GROUP</b>   "<b>USER DN</b>" "<b>USER CA</b>"  "<b>USER CN</b>" <b>USER EMAIL</b>"
</pre>
           </UL>      

If you have added the user for the purpose of assigning the <i>VirtualOrganizations/VOInfo-Admin</i> role, you will want to re-visit the
<a href="VomsWhatToDo#Establishing_a_VO_Admin">Establishing a VirtualOrganizations/VOInfo-Admin</a> section above to assign the role.




---+++Verifying you are a VirtualOrganizations/VOInfo-Admin
If you've established yourself with the <i>VirtualOrganizations/VOInfo-Admin</i> role or with the <i>allow all</i> Global-ACL, you can now go back the VirtualOrganizations/VOInfoMS web ui in a browser with your certificate and from the main menu:
<UL><LI>Under <i>For VirtualOrganizations/VOInfo Managers</i>, select <i>Administer the VO</i>
          <LI>Then, select <i>Global ACL</i>
</UL>
You should no longer see the <i>Access Denied</i> error and should be able to see the Global-ACL's  that have been created.   As a <i>VirtualOrganizations/VOInfo-Admin</i>, you can do anything you want.  

<b>Note:</b>  A user with the <i>VirtualOrganizations/VOInfo-Admin</i> role only has these privileges in the VirtualOrganizations/VOInfoMS web ui.  The command line <i>voms-admin</i>  does not authorize using the VirtualOrganizations/VOInfoMS roles.  It allow <i>voms-admin</i> command line capability, you must establish a Global-ACL with the capability you desire.  By default, only the <i>root</i> user has this on initial installation.


---++Testing access to your VirtualOrganizations/VOInfo's VirtualOrganizations/VOInfoMS server
There are several functions on the grid that access your VirtualOrganizations/VOInfoMS VO:
<OL><LI>voms proxy generation (<i>voms-proxy-init</i>)
          <LI>grid-mapfile generation on the CE nodes
               <UL><LI><i>edg-mkgridmap</i> for Grid3 authorization mode</UL>
           <LI>GUMS  interface  for Compatibility and Full Privilege authorization modes.
</OL>

---+++ Testing voms-proxy-init
The <i>voms-proxy-init</i> client command was included in the installation. The client <i>voms-proxy-init</i> uses a configuration file that contains the necessary arguments to access a VirtualOrganizations/VOInfo's VirtualOrganizations/VOInfoMS server.  On the VirtualOrganizations/VOInfoMS server node, this file is  located in the <i>$VDT_LOCATION/voms/etc/vomses</i> directory and looks like this for the <i>VDT</i> VO:
<pre>
"VDT" "cmssrv08.fnal.gov" "15000" "/DC=org/DC=doegrids/OU=Services/CN=cmssrv08.fnal.gov" "VDT" "32"
</pre>
Tokens:
<OL>
<LI>Considered a "nickname"  and , although the default is the VirtualOrganizations/VOInfo name, it can be any value you desire to identify the VirtualOrganizations/VOInfo you wish  to get a proxy from..  
<LI>The hostname of the voms server
<LI>Port number the server is listening on.
<LI>DN of the server's VirtualOrganizations/VOInfoMS certificate
<LI>VirtualOrganizations/VOInfo name
<LI>Globus version supported
</OL>
<P>
The <i>vomses</i> file syntax/values for each VirtualOrganizations/VOInfo you create, can be viewed on the web ui for your VirtualOrganizations/VOInfo by selecting <i>Configuration information</i> on the left hand menu of the main page.
<p>
On the server, there is no need to create a <i>$HOME/.glite/vomses</i> file containing the VirtualOrganizations/VOInfoMS servers you wish to access.  The <i>voms-proxy-init</i> command will search the <i>vomses</i> directory  on this server for this file. 

So to test the <i>voms-proxy-init</i> command, you need to do the following:

1. If you have not already added yourself as a member of the VO,  do so now.

2. Then, as yourself (not <i>root</i> user),
<pre>
&gt  source VDT_LOCATION/setup.sh
&gt  voms-proxy-init --voms=VDT:/VDT
<b>...output follows.. </b>
Cannot find file or dir: /home/weigand/.glite/vomses
Your identity: /DC=org/DC=doegrids/OU=People/CN=John Weigand 458491
Enter GRID pass phrase:
<b><i>... your passphrase...</b></i>
Your proxy is valid until Sat Feb 25 00:17:33 2006

Creating temporary proxy ............................. Done
Contacting  cmssrv08.fnal.gov:15000 [/DC=org/DC=doegrids/OU=Services/CN=cmssrv08.fnal.gov] "VDT"

Warning: Cannot find file or dir: /home/weigand/.glite/vomses Done
Creating proxy .................................................... Done
Your proxy is valid until Sat Feb 25 00:17:33 2006
</pre>

A couple of things about the output shown above that you might want to be aware of::
<UL>
<LI>The warnings about not finding a <i>$HOME/.glite/vomses</i> are not a problem, since on the server it is using the <i>./vomses</i> directory mentioned earlier.
<LI>The temporary proxy it generates is the good old grid proxy.  This is used for the access to VirtualOrganizations/VOInfoMS and just temporary.
</UL>

3. To verify the output of the voms proxy has the extended attributes the VirtualOrganizations/VOInfoMS service provides. The extended attribute and location of the proxy file are highlighted in the output:
<pre>
&gt  voms-proxy-info --all
<b>... output follows....</b>
WARNING: Unable to verify signature!
Error: Cannot find certificate of AC issuer for vo VDT
subject   : /DC=org/DC=doegrids/OU=People/CN=John Weigand 458491/CN=proxy
issuer    : /DC=org/DC=doegrids/OU=People/CN=John Weigand 458491
identity  : /DC=org/DC=doegrids/OU=People/CN=John Weigand 458491
type      : proxy
strength  : 512 bits
path      : <b>/tmp/x509up_u500</b>
timeleft  : 11:51:40
=== VO VDT extension information ===
VO        : VDT
subject   : /DC=org/DC=doegrids/OU=People/CN=John Weigand 458491
issuer    : /DC=org/DC=doegrids/OU=Services/CN=cmssrv08.fnal.gov
<b>attribute : /VDT/Role=NULL/Capability=NULL</b>
timeleft  : 11:51:40
</pre>

4. Now try one for a group you do not belong to, e.g., /MyGroup
<pre>
&gt  voms-proxy-init --voms=VDT:/MyGroup
<b>...output follows.. </b>
Cannot find file or dir: /home/weigand/.glite/vomses
Your identity: /DC=org/DC=doegrids/OU=People/CN=John Weigand 458491
Enter GRID pass phrase:
Your proxy is valid until Sat Feb 25 00:32:18 2006

Creating temporary proxy .................................. Done
Contacting  cmssrv08.fnal.gov:15000 [/DC=org/DC=doegrids/OU=Services/CN=cmssrv08.fnal.gov] "VDT"
<b>Error: VDT: Unable to satisfy G/MyGroup Request!</b>
</pre>
<b>Note:</b> If a subsequent attempt at a voms proxy fails, as ours did here, the previously generated proxy is still in effect.  You can do another <i>voms-proxy-init --all</i> to verify this.



---+++ Testing edg-mkgridmap
The <i>edg-mkgridmap</i> is run on a site's Compute Element (CE) node to generated a <i>grid-mapfile</i> file.  This script is not provided as a part of the VirtualOrganizations/VOInfoMS installation, so you will have to go a CE node to test this.  You do not have to be the <i>root</i> user on the CE node, but you will need to have a personal certificate available.
<p>
The <i>mkgridmap</i> file syntax/values for each VirtualOrganizations/VOInfo you create, can be viewed on the web ui for your VirtualOrganizations/VOInfo by selecting <i>Configuration information</i> on the left hand menu of the main page.
<pre>
group vomss://cmssrv08.fnal.gov:8443/voms/VDT  .VDT
</pre>
<b>Note:</b> This is an EDG format for the account name.   You will likely want to change it to the group account you want assigned for your CE node.  The example above is for a <i>group</i> account assignment.
<p>
To test on a CE node.
<UL><LI>In some writable area, create a <i>edg-mkgridmap.conf</i> file and populate it with the example configuration file on your VirtualOrganizations/VOInfoMS server.  It will be the only entry.
<pre>
&gt  echo 'group vomss://cmssrv08.fnal.gov:8443/voms/VDT  .VDT' >./edg-mkgridmap.conf
</pre>
          <LI>Execute the edg-mkgridmap allowing the output to go to stdout:
<pre>
&gt  edg-mkgridmap --conf ./edg-mkgridmap.conf 
Enter PEM pass phrase: 
<b>... output follows ...</b>
"/DC=org/DC=doegrids/OU=People/CN=John Weigand 458491" .VDT
"/DC=org/DC=doegrids/OU=Services/CN=cmssrv08.fnal.gov"  .VDT
</pre>
</UL>

---+++ Testing the GUMS interface
The GUMS authorization server periodically 'pulls' the VirtualOrganizations/VOInfo membership data for it's authorization and account assignment  functions from the various VirtualOrganizations/VOInfo's VirtualOrganizations/VOInfoMS servers.  

Unfortunately, there is no way of testing this except with an installed GUMS server which this document does not address.


---++[[VirtualOrganizations/VOInfoMS Release Notes]]

---++[[VirtualOrganizations/VOInfoMS Trash/Troubleshooting Guide]]

---++Shutdown Guide
#ShutdownGuide
The OSG VirtualOrganizations/VOInfoMS starts up several processes.  If you try to re-install/upgrade the OSG VirtualOrganizations/VOInfoMS without shutting them down it will fail.  Run the following commands to turn off the OSG VirtualOrganizations/VOInfoMS services before upgrading:

<ul>
  <li>/etc/ini.d/edg-crl-upgraded stop  (assuming you activate it)
  <li>/etc/init.d/apache stop
  <li>/etc/init.d/tomcat-5  stop
  <li>/etc/init.d/voms stop
  <li>/etc/init.d/mysql stop
</ul>


<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->

*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.AlanSill - 29 Sep 2005<br>
-- Main.AnneHeavey - 18 May 2005<br>
-- Main.JohnWeigand - 13 May 2005<br>
-- Main.JohnWeigand - 14 Jun 2005 - added reference for requesting http certificates<br>
-- Main.JohnWeigand - 28 Feb 2006 - updated for OSG 0.3.6 release<br>

%STOPINCLUDE%