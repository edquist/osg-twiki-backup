%META:TOPICINFO{author="KyleGross" date="1476285085" format="1.1" version="1.10"}%
%META:TOPICPARENT{name="JobMonReadinessPlan"}%
<!-- This is the default OSG Trash/Trash/Integration template. 
Please modify it in the sections indicated to create your topic!
If you have any comments/complaints about this template, then please email me:
rwg@hep.uchicago.edu.  (Adapted from Atlas wiki template, Ed Moyse)
--> 

<!-- By default the title is the WikiWord used to create this topic !-->
<!-- if you want to modify it to something more meaningful, just replace %TOPIC% below with i.e "My Topic"!-->

---+!!<nop>%TOPIC%
%TOC%
%STARTINCLUDE%
 
---+++ Introduction
   * This manual will help you download, install and test JobMon package
   * You will start one apache server for Clarens service and one python TCP server for JobMon wakeup service
   
---+++ Prerequisite
   * host cert/key file for your Clarens server
   * The default owner.group for apache server is daemon.daemon. You could change it in the configuration but make sure the host cert/key are readable by the user. e.g.:
      * Put host cert/key file into /etc/grid-security/http/ 
      <verbatim>
    /etc/grid-security/http/hostcert.pem
    /etc/grid-security/http/hostkey.pem
    </verbatim>  
      * Change the owener.group to daemon.daemon

---+++ Clarens-JobMon VDT installation
   * The installation is based on pacman-3.17 and vdt 1.3.10. If newer [[http://physics.bu.edu/pacman/][pacman]] and [[http://vdt.cs.wisc.edu/whats_new.html][VDT]] versions are available, use that instead. 
   * VDT installation of Clarens-JobMon
      * Create a directory as your VDT_LOCATION. For example, /data/vdt/
      * Get pacman http://physics.bu.edu/pacman/
      <verbatim>
      cd $VDT_LOCATION 
      wget http://physics.bu.edu/pacman/sample_cache/tarballs/pacman-latest.tar.gz
      tar xzvf  pacman-latest.tar.gz
      cd pacman-3.17
      source setup.(c)sh
      </verbatim>
      * You can't use pacman inside the pacman directory. Please change back to $VDT_LOCATION and start installation
      <verbatim>
cd $VDT_LOCATION
pacman -get ttp://www.cs.wisc.edu/vdt/vdt_1310_cache:Clarens-JobMon
      </verbatim>
         * This may complain about not knowing your platform
         <verbatim>
-
- Platform [linux-fermi-7.3] is not yet supported.
- Contact Pacman headquarters at http://physics.bu.edu/pacman/ to request a new platform.
- Use [% pacman -pretend-platform <platform>] to override.
-
        </verbatim>
         * To check if your platform is supported run:
         <verbatim> 
      pacman -platforms
         </verbatim>
         * Choose the closetst platform and do
         <verbatim> 
      pacman -pretend-platform redhat-7.3
      pacman -get http://www.cs.wisc.edu/vdt/vdt_1310_cache:Clarens-JobMon
         </verbatim>

   *  Using pacman-3.17 it is neccesary to remove the Cookie module that comes with pacman due to a conflict with the standard Cookie module:
         <verbatim>
         rm pacman-3.17/src/Cookie.*
         </verbatim> 

   * VDT Configuration
      * Using clarens script: $VDT_LOCATION/clarens/bin/clarens-server-config, some configuration examples:
      <verbatim>
  Cert/key directory /etc/grid-security/http
  Server private key hostkey.pem
  Server certificate hostcert.pem

  Modulde configuration [JobMon]
     clean time          300
     FIFO path           /vdt/data/JobMonLog
     Server name         clarens-1.t2.ucsd.edu         
     Server port         2000
      </verbatim>
   * apache server configuration:
      * $VDT_LOCATION/apache/conf/httpd.conf. The default non-SSL connection port number is 80.
      <verbatim>
      ServerName clarens-1.t2.ucsd.edu
      </verbatim>
      * $VDT_LOCATION/apache/conf/extra/httpd-ssl.conf. The default SSL connection port number is 8443. You could change to other port number by modifying this file. 

   * Set default Clarens administration group
      * run the configuration utility $VDT_LOCATION/clarens/bin/clarens-server-config
      * Change the value of *System admins* in the *system* module to a list of certificate DNs
      * The list of system admin DNs is a colon-separated string


   * Start apache server     
      * $VDT_LOCATION/post-install/apache start
      * link to this webserver and make sure you see the clarens homepage

   * Start JobMonTcpServer      
      * Edit VDT_LOCATION in the script $VDT_LOCATION/clarens/bin/JobMonTcpServer_startup and execut it. 
      * Check log file and make sure the python script server reads correct configuration
      <verbatim>
      cat /tmp/JobMon_TCPServer.log
      [timestamp] JobMon TCP server starts at clarens-1.t2.ucsd.edu:2000
      </verbatim> 

   * Debug:
      * Here is the place to look at apache server error
      <verbatim>
      $VDT_LOCATION/apache/logs/
      </verbatim>  
   * Other reference
      * VDT cache: http://www.cs.wisc.edu/vdt/vdt_1310_cache/
      * Where to apply DOE Grid proxy
         * http://www.doegrids.org/pages/cert-request.html


---+++ Using JobMon and JobMonDaemon 
   * Now, you are ready to use JobMon. The latest JobMon client script is in 
      <verbatim>
      $VDT_LOCATION/clarens/bin/JobMon.py
      $VDT_LOCATION/clarens/bin/JobMonDaemon.py     

To Use the script, you have to put following script together with them in the same directory
      $VDT_LOCATION/clarens/lib/python/site-packages/ClarensDpe.py
      </verbatim>
   * To know more about using JobMon and JobMonDaemon, see [[http://jobmon.sourceforge.net/Usage.html][html]]  

---+++ JobMon Debug
---++++ CNAF: subject name: USERID problem
   * Igor login to the testnode for me to get kerberose ticket and also grid proxy
<verbatim>
 1007  export KRB5CCNAME=/tmp/schsu
 1008  kinit schsu
 1009  export X509_USER_PROXY=/tmp/xschsu
 1010  globus=proxy-info
 1011  globus-proxy-info
 1012  grid-proxy-info
 1013  kx509
 1014  grid-proxy-info
 1015  kxlist -p
 1016  grid-proxy-info
 1017  history
</verbatim>
   * Here's the grid-proxy-info
<verbatim>
[cdfcaf@cdftest schsu]$ grid-proxy-info
subject  : /DC=gov/DC=fnal/O=Fermilab/OU=People/CN=Shih-chieh Hsu/USERID=schsu
issuer   : /DC=gov/DC=fnal/O=Fermilab/OU=Certificate Authorities/CN=Kerberized CA
identity : /DC=gov/DC=fnal/O=Fermilab/OU=People/CN=Shih-chieh Hsu/USERID=schsu
type     : end entity credential
strength : 512 bits
path     : /tmp/xschsu
timeleft : 25:21:57  (1.0 days)
</verbatim>
   *  Igor let me try several commands in cdftest.cnaf.infn.it.  Here's the test
<verbatim>
1. grid-proxy-info shows the subject name with USERID:
[cdfcaf@cdftest schsu]$ grid-proxy-info
subject  : /DC=gov/DC=fnal/O=Fermilab/OU=People/CN=Shih-chieh Hsu/USERID=schsu

2. We can still use this proxy to start JobMon service:
[cdfcaf@cdftest schsu]$ python2 JobMonDaemon.py --serverURL https://fcdfcaf019.fnal.gov:8443/clarens --certfile /tmp/xschsu --keyfile /tmp/xschsu --jobname schsu_cnaf

3. Let's check the registered job in Clarens server:

bash-2.05a$ python2 JobMon.py --serverURL https://fcdfcaf019.fnal.gov:8443/clarens --list
  registered time         jobname                Subject
----------------------------------------------------
[Tue Oct  4 15:19:14 2005] schsu_cnaf /DC=gov/DC=fnal/O=Fermilab/OU=People/CN=Shih-chieh Hsu/UID=schsu
----------------------------------------------------
total  registered 1

4. As you can see, the subject name in Clarens server side  is UID but not USERID.
   However, JobMon works fine. 
</verbatim>

---+++ How do I know DN(subject name) looks like in Clarens
   *  Using /usr/bin/openssl 
<verbatim>
[cdfcaf@cdftest schsu]$ rpm -qf /usr/bin/openssl
openssl-0.9.7a-33.12

[cdfcaf@cdftest schsu]$ /usr/bin/openssl  x509 -subject -in /tmp/xschsu -noout
subject= /DC=gov/DC=fnal/O=Fermilab/OU=People/CN=Shih-chieh Hsu/UID=schsu
</verbatim>  
-- Main.ShihChiehHsu - 16 Sep 2005

<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->

*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.ElliotLipeles - 30 Nov 2005

*Minor updates*:%BR%
Changed VDT version to 1.3.8
-- Main.ConradSteenberg - 15 Mar 2006
%STOPINCLUDE%