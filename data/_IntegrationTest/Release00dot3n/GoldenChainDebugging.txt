%META:TOPICINFO{author="KyleGross" date="1225985984" format="1.1" version="1.9"}%
%META:TOPICPARENT{name="SiteAdmins"}%
<!-- This is the default OSG Integration template. 
Please modify it in the sections indicated to create your topic!
If you have any comments/complaints about this template, then please email me:
rwg@hep.uchicago.edu.  (Adapted from Atlas wiki template, Ed Moyse)
--> 

<!-- By default the title is the WikiWord used to create this topic !-->
<!-- if you want to modify it to something more meaningful, just replace %TOPIC% below with i.e "My Topic"!-->

---+!!<nop>%TOPIC%
%TOC%
%STARTINCLUDE%


---++Introduction

The authorization configuration of OSG is one of the major enhancements over the Grid3 functionality. It does introduce a number of new components (known affectionately as "the Golden Chain") that need to work together and so has plenty of opportunity for confusion, particularly on error. The goal of this page is to document a set of debugging steps and diagnostics to tell what is working and what is going wrong.

The Golden Chain is the following set of steps performed to do full role based authorization:

   1 Get a VirtualOrganizations/VOInfoMS extended proxy with the attributes you wish to use
   1 Submit a request to a service (site_verify will initiate a simple request as you to test. The rest should be automaticly performed behind the scenes.)
   1 Gatekeeper PRIMA modules parse the proxy attributes and contact the GUMS service for uid mapping
   1 GUMS service checks its database and configuration to map a local user id for that DN + attributes and returns the answer to the gatekeeper.
   1 The gatekeeper performs the job as the assigned user
   ! GUMS generates a reverse mapfile (user-to-VirtualOrganizations/VOInfo mapping) called grid3-user-vo-map.txt to map local usage to VirtualOrganizations/VOInfo for accounting purposes. (When generated manually using $VDT_LOCATION/gums/bin/gums-host generateGrid3UserVoMap,
 by default it sends output only to standard out; use -f filename to save it to a file.)

To start, go ahead and configure the compute elements to use the services per the Privilege installation instructions you've followed in the admin guide (VomsAdmins, GumsAdmins). Run $VDT_LOCATION/verify/site_verify, and if it passes the authentication stage, then the configuration is correct and the services are running. If it fails, then some debugging needs to be
done. The sections below contain debugging information for the different OSG authorization configuration modes.

---++General Triage

There are a few things which are common to all these tests and those are prerequisites tested here:
   
   
   * Make sure you're running site_verify as yourself, not as root.
   * Do you have a valid grid proxy ?
      * Issue the command "grid-proxy-info -all" and if you get an error, there is a basic problem with your configuration.
         * If you don't have grid-proxy-info in your path, there may be a problem with your environment setup. Have you done a $VDT_LOCATION/setup.sh ?
   * Do you have a good network connection ?
      * (** A good test to test for presence of firewall might be good here.**)

   * If you as an admin just activated PRIMA on a gatekeeper: Do you have a working VDT/Globus installation on your gatekeeper?
      * Please temporarily rename your /etc/grid-security/gsi-authz.conf file (which if present activates the PRIMA module), and try to submit a simple job to the gatekeeper. You must have a minimal /etc/grid-security/grid-mapfile in place. If it works you can put the gsi-authz.conf file back in place, if not then you need to fix your Globus/VDT setup first.

---++Full Privilege authorization mode

In the full privilege mode, the following components need to work (test in the following order):

---+++VirtualOrganizations/VOInfoMS server: to get an extended grid proxy
      * Test this by using the voms-proxy-init, for example the successful creation of a proxy certificate that has VirtualOrganizations/VOInfo/role information (in this case for the uscms VO) included looks like this 
<pre>
[mlorch@gyoza7 mlorch]$ voms-proxy-init -voms uscms
Your identity: /DC=org/DC=doegrids/OU=People/CN=Markus Lorch 98196
Enter GRID pass phrase:
Creating temporary proxy .................................................... Done
Contacting  cmssrv08.fnal.gov:15050 [/DC=org/DC=doegrids/OU=Services/CN=cmssrv08.fnal.gov] "uscms" Done
Creating proxy ............................................................................................................... Done
Your proxy is valid until Mon May  2 18:35:34 2005
</pre>
You can verifiy the contents of your VirtualOrganizations/VOInfoMS proxy certificate by doing
<pre>
[mlorch@gyoza7 mlorch]$ voms-proxy-info -all
error = 5025
WARNING: Unable to verify signature!
subject   : /DC=org/DC=doegrids/OU=People/CN=Markus Lorch 98196/CN=proxy
issuer    : /DC=org/DC=doegrids/OU=People/CN=Markus Lorch 98196
identity  : /DC=org/DC=doegrids/OU=People/CN=Markus Lorch 98196
type      : proxy
strength  : 512 bits
path      : /tmp/x509up_u9525
timeleft  : 11:57:37
VO        : uscms
subject   : /DC=org/DC=doegrids/OU=People/CN=Markus Lorch 98196
issuer    : /DC=org/DC=doegrids/OU=Services/CN=cmssrv08.fnal.gov
attribute : /uscms/Role=NULL/Capability=NULL
attribute : /uscms/hipt/Role=NULL/Capability=NULL
attribute : /uscms/production/Role=NULL/Capability=NULL
attribute : /uscms/spectra/Role=NULL/Capability=NULL
attribute : /uscms/gumstest/Role=NULL/Capability=NULL
attribute : /uscms/admin/Role=NULL/Capability=NULL
timeleft  : 11:57:37
</pre>
The warning "Unable to verify signature!" is typical as your machine will not have the certificate of the VirtualOrganizations/VOInfoMS server available that issued the attributes, thats not a problem. The list of attributes shows you what the VirtualOrganizations/VOInfoMS server returned. Only the first attribute in the list (i.e., /uscms/Role=NULL/Capability=NULL in this case) will be used to determine your local user account.

A voms-proxy-init output like the following indicates a mismatch between voms-client and voms-server:
<pre>
[mlorch@gyoza7 mlorch]$ voms-proxy-init --voms cmssrv17:/uscms
Your identity: /DC=org/DC=doegrids/OU=People/CN=Markus Lorch 98196
Enter GRID pass phrase:
Creating temporary proxy ................................................ Done
Contacting  cmssrv17.fnal.gov:15001 [/DC=org/DC=doegrids/OU=Services/CN=cmssrv17.fnal.gov] "uscms" Done
bad class
Function: d2i_ASN1_SET
nested asn1 erroraddress=134839912 offset=2
Function: (null)
error parsing set elementaddress=134839910 offset=940806918
Function: d2i_ASN1_SET
nested asn1 erroraddress=134839895 offset=15
Function: (null)
error parsing set elementaddress=134839892 offset=-1208586188
Function: d2i_ASN1_SET
nested asn1 erroraddress=134839620 offset=272
Function: (null)
nested asn1 erroraddress=134839616 offset=4
Function: (null)
Creating proxy ................................. Done
Your proxy is valid until Mon May  2 18:48:07 2005
</pre>

---+++PRIMA modules: on gatekeeper to parse the extended proxy and communicate with GUMS
      * The gatekeeper uses the PRIMA module, an authorization plug-in, to parse the VirtualOrganizations/VOInfo/role information from the extended VirtualOrganizations/VOInfoMS proxy and contact a GUMS server for a local mapping. If your job submission fails after you activate PRIMA you should look in the gatekeeper log (vdt/globus/var/globus-gatekeeper) for error messages. The output of a successful authorization procedure looks like this:

<pre>
 PID: 30871 -- Notice: 0: GATEKEEPER_ACCT_FD=5 (/opt/vdt-1.3.3-test0303/globus/var/accounting.log)
TIME: Mon May  2 06:52:28 2005
 PID: 30871 -- Notice: 6: Got connection 131.225.206.62 at Mon May  2 06:52:28 2005

TIME: Mon May  2 06:52:28 2005
 PID: 30871 -- Notice: 5: Authenticated globus user: /DC=org/DC=doegrids/OU=People/CN=Markus Lorch 98196
 PID: 30871 -- PRIMA INFO  Mapping service: "https://gyoza7.fnal.gov:8444/privilege/services/ExampleAuthorizationServicePort" returned local user: "uscms01" and local group: "uscms" (9545) for globus user: "/DC=org/DC=doegrids/OU=People/CN=Markus Lorch 98196" 
 PID: 30871 -- PRIMA INFO  Mapping service "https://gyoza7.fnal.gov:8444/privilege/services/ExampleAuthorizationServicePort" returned local user "uscms01" for globus user "/DC=org/DC=doegrids/OU=People/CN=Markus Lorch 98196" 
TIME: Mon May  2 06:52:30 2005
 PID: 30871 -- Notice: 0: GRID_SECURITY_HTTP_BODY_FD=9
TIME: Mon May  2 06:52:30 2005
 PID: 30871 -- Notice: 5: Requested service: jobmanager 
TIME: Mon May  2 06:52:30 2005
 PID: 30871 -- Notice: 5: Authorized as local user: uscms01
TIME: Mon May  2 06:52:30 2005
 PID: 30871 -- Notice: 5: Authorized as local uid: 60076
TIME: Mon May  2 06:52:30 2005
 PID: 30871 -- Notice: 5:           and local gid: 5063
TIME: Mon May  2 06:52:30 2005
 PID: 30871 -- Notice: 0: executing /opt/vdt-1.3.3-test0303/globus/libexec/globus-job-manager
TIME: Mon May  2 06:52:30 2005
 PID: 30871 -- Notice: 0: GATEKEEPER_JM_ID 2005-05-02.06:52:30.0000030871.0000000000 for /DC=org/DC=doegrids/OU=People/CN=Markus Lorch 98196 on 131.225.206.62
</pre>




----++++ERROR-old VirtualOrganizations/VOInfoMS
<pre>
TIME: Mon May  2 06:44:51 2005
 PID: 30514 -- Notice: 0: GATEKEEPER_ACCT_FD=5 (/opt/vdt-1.3.3-test0303/globus/var/accounting.log)
TIME: Mon May  2 06:44:51 2005
 PID: 30514 -- Notice: 6: Got connection 131.225.206.62 at Mon May  2 06:44:51 2005

TIME: Mon May  2 06:44:51 2005
 PID: 30514 -- Notice: 5: Authenticated globus user: /DC=org/DC=doegrids/OU=People/CN=Markus Lorch 98196
 PID: 30514 -- PRIMA ERROR  prima_gss_assist.c:632  Error extracting VOMS Attribute 
0:error:0D0680A8:asn1 encoding routines:ASN1_CHECK_TLEN:wrong tag:tasn_dec.c:946:
0:error:0D06C03A:asn1 encoding routines:ASN1_D2I_EX_PRIMITIVE:nested asn1 error:tasn_dec.c:628:
0:error:0D08303A:asn1 encoding routines:ASN1_TEMPLATE_D2I:nested asn1 error:tasn_dec.c:542:Field=voms_attr_values, Type=VOMS_ATTRIBUTE
 PID: 30514 -- PRIMA INFO  Mapping service "https://gyoza7.fnal.gov:8444/privilege/services/ExampleAuthorizationServicePort" returned local user "mlorch" for globus user "/DC=org/DC=doegrids/OU=People/CN=Markus Lorch 98196" 
TIME: Mon May  2 06:44:52 2005
 PID: 30514 -- Notice: 0: GRID_SECURITY_HTTP_BODY_FD=9
TIME: Mon May  2 06:44:52 2005
 PID: 30514 -- Notice: 5: Requested service: jobmanager 
TIME: Mon May  2 06:44:52 2005
 PID: 30514 -- Notice: 5: Authorized as local user: mlorch
TIME: Mon May  2 06:44:52 2005
 PID: 30514 -- Notice: 5: Authorized as local uid: 9525
TIME: Mon May  2 06:44:52 2005
 PID: 30514 -- Notice: 5:           and local gid: 5063
TIME: Mon May  2 06:44:52 2005
 PID: 30514 -- Notice: 0: executing /opt/vdt-1.3.3-test0303/globus/libexec/globus-job-manager
TIME: Mon May  2 06:44:52 2005
 PID: 30514 -- Notice: 0: GATEKEEPER_JM_ID 2005-05-02.06:44:52.0000030514.0000000000 for /DC=org/DC=doegrids/OU=People/CN=Markus Lorch 98196 on 131.225.206.62
</pre>

----++++ERROR-wrong PRIMA modules.

<pre>
TIME: Mon May 16 14:27:00 2005
 PID: 29947 -- Notice: 6: /usr/local/grid0.1.5/globus/sbin/globus-gatekeeper pid
=29947 starting at Mon May 16 14:27:00 2005

TIME: Mon May 16 14:27:00 2005
 PID: 29947 -- Notice: 0: GATEKEEPER_ACCT_FD=5 (/usr/local/grid0.1.5/globus/var/
accounting.log)
TIME: Mon May 16 14:27:00 2005
 PID: 29947 -- Notice: 6: Got connection 131.225.80.74 at Mon May 16 14:27:00 20
05

TIME: Mon May 16 14:27:00 2005
 PID: 29947 -- Notice: 5: Authenticated globus user: /DC=gov/DC=fnal/O=Fermilab/
OU=People/CN=Dane Skow/UID=dane
</pre>

This is a particularly subtle error since the prima module is aborted before any error message can get written.
A quick way to test for a common cause for this error is to look for missing libraries from the prima module.

<pre>
ldd $VDT_LOCATION/prima/lib/libprima_authz_module_gcc32dbg.so
</pre>
should show no missing libraries in a correctly functioning installation. Particularly in some configurations 
where you've installed VDT using pacman's "-pretend" mode, there may be unresolved references. You can either resolve them (e.g. modifying LD_LIBRARY_PATH appropriately) or install the staticly compiled version of the PRIMA modules used for the RH 7.2 VDT version. (%RED% Is there an elegant way of doing this %ENDCOLOR% ?)

You may want to set the logLevel to "debug" in /etc/grid-security/prima-authz.conf to get more clues. 


---+++GUMS server: to map the DN + attributes to a local user id
      * Do you know where your GUMS server is running ? PRIMA thinks it is running here (*pointer to configfile entry*)
      * Test this by running XXX (*need a detailed test here*)

---+++GUMS client: is installed on gatekeeper to get the reverse user mapping information needed for accounting
      * Test this by running XXX (*need a detailed test here*)

---++Compatability mode Privilege authorization

---+++PRIMA modules: on gatekeeper to communicate with GUMS
      * Look in the gatekeeper log for error messages. You may want to set the logLevel to "debug" in /etc/grid-security/prima-authz.conf to get more clues. 

---+++GUMS server: to map the DN to a local user id
      * Do you know where your GUMS server is running ? PRIMA thinks it is running here (*pointer to configfile entry*)
      * Test this by running XXX (*need a detailed test here*)

---+++GUMS client: is installed on gatekeeper to get the reverse user mapping information needed for accounting
      * Test this by running XXX (*need a detailed test here*) (*Is this needed in this mode?*)

---++Grid3 mode authorization

      * Look in the gatekeeper log for error messages. (*Need some extended debugging info here*)


<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->

*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.DaneSkow - 15 Apr 2005

%STOPINCLUDE%

%META:TOPICMOVED{by="DaneSkow" date="1113599939" from="Integration.GoldenChainTest" to="Integration.GoldenChainDebugging"}%
