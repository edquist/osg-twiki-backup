%META:TOPICINFO{author="ShihChiehHsu" date="1130975121" format="1.0" version="1.1"}%
<!-- This is the default OSG Integration template. 
Please modify it in the sections indicated to create your topic!
If you have any comments/complaints about this template, then please email me:
rwg@hep.uchicago.edu.  (Adapted from Atlas wiki template, Ed Moyse)
--> 

<!-- By default the title is the WikiWord used to create this topic !-->
<!-- if you want to modify it to something more meaningful, just replace %TOPIC% below with i.e "My Topic"!-->

---+!!<nop>%TOPIC%
%TOC%
%STARTINCLUDE%
	  

---++ Introduction
	The JobMon system allows users to view process status and log files interactively as the job runs. This facilitates debugging and reduces unnecessary resource consumption due to user error.
	* See also [[http://jobmon.sourceforge.net/][JobMon SourceForge]]

---++ Readiness and Integration Plan
  We describe a service readiness and integration plan for JobMon, following guidelines set forth in VDT release 1.3.7 and later. Since the service is already developed and "ready", the following focuses on integration aspects. 

---+++ Description of Service
There are three separate places where code is run in an individual transaction. There is the persistent Clarens web-service generally located at the execution site. The job runs a  JobMonDaemon  process which runs the communication and executes the commands on the worker node. The  JobMonDaemon  persists for as long as the job is executing. Finally there is the client code, which a users executes when they want to interact with the remote job, this persists only until the transaction has completed.

---+++ Dependencies and interactions with other services
JobMon relies on [[http://clarens.sourceforge.net/][Clarens]] Grid-Enabled Web Services Framework for authentication and authorization for commands requests.

---+++ Resources required
	* Clarens + Apache + pyhthon2.2.2
	* static external IP connections to WAN  

---+++ Installation and Configuration
	* VDT installation of Clarens-JobMon
		* Create a directory as your VDT_LOCATION. For example, /data/vdt/
		* Get pacman http://physics.bu.edu/pacman/
		<verbatim>
		click download and put tarball in VDT_LOCATION 
		tar xzvf  pacman-latest.tar.gz
		cd pacpam-3.13.1
		source setup.(c)sh
		</verbatim>
		* You can't use pacman inside the pacman directory. Please change back to $VDT_LOCATION and start installation
		To check if your platform is supported run:
		<verbatim> 
		pacman -platforms
		</verbatim>
		this may complain about not knowing your platform in which case try:
		<verbatim> 
		pacman -platforms -pretend-platform redhat-7.0
		</verbatim>
		<verbatim> 
		pacman -allow unsupported-platforms
		pacman -get http://www.cs.wisc.edu/vdt/vdt_137_cache:Clarens-JobMon
		</verbatim>


	* Update Clarens
		* host cert/key file. As test purpose, please just copy cert/key file from /opt/openpkg/clarens		  . You might have your own host cert/key. To use that, remember put into right path below and change the owner to daemon.daemon. 
	 <verbatim>
	 b0ucsd03:/opt/openpkg/etc/grid-security/hostcert.pem
	 b0ucsd03:/opt/openpkg/etc/grid-security/hostkey.pem
	 </verbatim>
		* Put them into /etc/grid-security/http/ 
		* make sure the owener.group is daemon.daemon
		* update three files and put into the correct directories
			* [[%ATTACHURL%/JobMonTcpServer.py.txt][$VDT_LOCATION/clarens/share/apache2/clarens/JobMon/JobMonTcpServer.py]]
			* [[%ATTACHURL%/JobMonTcpServer_startup][$VDT_LOCATION/clarens/bin/JobMonTcpServer_startup]]  
			* [[%ATTACHURL%/.clarens_access][$VDT_LOCATION/clarens/share/apache2/clarens/JobMon/.clarens_access]]

	* VDT Configuration
		* Using clarens script: $VDT_LOCATION/clarens/bin/clarens-server-config
		<verbatim>
  Cert/key directory /etc/grid-security/http
  Server private key hostkey.pem
  Server certificate hostcert.pem

  [JobMon]
	  Server name			clarens-1.t2.ucsd.edu			

		</verbatim>
	* apache server configuration:
		* $VDT_LOCATION/apache/conf/httpd.conf
		<verbatim>
		ServerName clarens-1.t2.ucsd.edu
		</verbatim>
		* $VDT_LOCATION/apache/conf/ssl.conf. If you want to change port number, this is where you want to look for. Make sure update all port number. The default is 8443.

	* Start apache server	  
		* $VDT_LOCATION/post-install/apache start
		* link to this webserver and make sure you see the clarens homepage

	* Start JobMonTcpServer
		* $VDT_LOCATION/clarens/bin/JobMonTcpServer_startup
		* Check log file and make sure read correct configuration
		<verbatim>
		cat /tmp/JobMon_TCPServer.log
		[timestamp] JobMon TCP server starts at clarens-1.t2.ucsd.edu:2000
		</verbatim> 


---+++ Testing and Validation
	* Now, you are ready to use JobMon. The latest JobMon client script is in 
		<verbatim>
		$VDT_LOCATION/clarens/bin/JobMon.py
		$VDT_LOCATION/clarens/bin/JobMonDaemon.py	  
		</verbatim>
	* Query Registered JobList
	<verbatim>
python2 JobMonDaemon.py --serverURL https://clarens-1.t2.ucsd.edu:8443/clarens --joblist
	</verbatim>
	* Start a JobMonDaemon
	<verbatim>
python2 JobMonDaemon.py --jobname testjob --serverURL https://clarens-1.t2.ucsd.edu:8443/clarens --certfile /tmp/x509up_u11394 --keyfile /tmp/x509up_u11394
	</verbatim>
	* Query "ls" command 
	<verbatim>
python2 JobMon.py --serverURL https://clarens-1.t2.ucsd.edu:8443/clarens --jobname testjob --command "ls -l"
	</verbatim>

	* To know more about client usage of JobMon [[http://jobmon.sourceforge.net/Usage.html][html]]
---++ Links to Documents
	* Design Overview [[http://jobmon.sourceforge.net/JobMonDesign.ps][ps]] [[http://jobmon.sourceforge.net/JobMonDesign.pdf][pdf]] [[http://jobmon.sourceforge.net/JobMonDesign/index.html][html]]

---++ Kown Issues
---+++ How do I know DN(subject name) looks like in Clarens
	*  Using /usr/bin/openssl 
	<verbatim>
[cdfcaf@cdftest schsu]$ rpm -qf /usr/bin/openssl
openssl-0.9.7a-33.12

[cdfcaf@cdftest schsu]$ /usr/bin/openssl  x509 -subject -in /tmp/xschsu -noout
subject= /DC=gov/DC=fnal/O=Fermilab/OU=People/CN=Shih-chieh Hsu/UID=schsu
</verbatim>  

---++ Contact Information
	* [[mailto:conrad@hep.caltech.edu][Conrad Steenberg]], California Institute Technology
	* [[mailto:schsu@fnal.gov][Shih-Chieh Hsu]], University of California San Diego
	* [[mailto:lipeles@fnal.gov][Elliot Lipeles]], University of California San Diego
	* [[mailto:fkw@fnal.gov][Frank Würthwein]], University of California San Diego


<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->

*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.ShihChiehHsu - 02 Nov 2005

%STOPINCLUDE%

