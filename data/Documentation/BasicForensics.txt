%META:TOPICINFO{author="JamesBarlow" date="1271172638" format="1.1" version="1.5"}%
%META:TOPICPARENT{name="BestPractices"}%

%DOC_STATUS_TABLE%

---++ Basic Forensic Techniques

Here are some basic steps one can take when investigating an incident on a machine used in the OSG.  These are by no means comprehensive in everything that should be looked into.  But they can give a good indication if there is a problem, and also what additional steps may need to be taken.

---+++ Inspect batch system
   * Where did the job run?
      * Fork jobmanager or batch system
      * If batch system, which node
      * For Condor 
         * =% condor_q -l job_id=
         * =% condor_q –l userid=
      * For PBS
         * =% qstat -f job_identifier=
      * Review your batch system logs

---+++Locate user processes
   * What processes are running for a user?
      * =% ps -u mis -U mis uwww=
      * Remember to locate processes on both Computing Element (CE) and Worker Node (WN)

---+++Does the job have any open files or ports?
   * Use lsof and/or netstat
      * =% lsof -u mis -P=
      * =% netstat -ap=
   * Did you find them?
      * An open hidden file (check /tmp and other world writable directories)
      * An open TCP connection
   * If the process running is a script - review the script code and try to identify what it is trying to do
   * If the executables were binary files
      * Use strings command
      * Look for hostnames, email addresses, usernames, passwords, and other clues

---+++ Killing suspicious user jobs 
   * Remove job from batch system
      * Condor: =% condor_rm cluster_id=
      * PBS: =% qdel job_id=
   * Kill any lingering processes associated with the suspicious user
      * =% kill -9 process_id=
      * =% killall process_name=
   * Make sure all the suspicious user processes have been terminated

---+++ What Ifs
   * All DNs from the VO are getting mapped to the same user DN.
      * Killing all the user process on the CE
         * Kills Condor-G grid-manager and Globus jobmanager processes of other users in the VO
         * VO should be able to recover from these failures
      * Selective killing of jobs associated with user DN
         * Possible by looking at logfiles, process timestamps
         * Will be tedious
         * Decision at the discretion of the sites
         * VOs will appreciate it 
   * User process is aggressively forking?
      * After killing suspicious processes, check for new processes using ps
      * Node shutdown/reboot may be required
      * *Beware of lingering effects (example: cron, at)&#8207;*
  
---+++ Handling Escalations
   * Investigate the incident
      * Follow your home organization’s security procedures and policies
      * Determine if there were any compromises arising from the incident
   * If you suspect that any other user accounts, certificates, proxies have been compromised due to this incident immediately notify security@opensciencegrid.org
   * Any other policies/procedures for sites to follow? 
   * If the attacker succeeded in escalating the privileges by installing rootkits, the simple forensic techniques we have discussed here will be insufficient. 
      * Once an attacker has root access we can no longer rely on the commands we run on the node.
      * Run host and network based rootkit detector tools.
      * Review network traffic flows.
      * It would be advisable to remove the machine from the network, analyze the compromise, and wipe the machine clean.
      * Detailed discussion on topics regarding root level compromise is outside the scope of this page.


<!-- CONTENT MANAGEMENT PROJECT

   DEAR DOCUMENT OWNER
   ===================

   Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER          = JamesBarlow

   Please define the document area, choose one of the defined areas from the next line
   DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = Security

   define the primary role the document serves, choose one of the defined roles from the next line
   DOC_ROLE = (Scientist|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

   Please define the document type, choose one of the defined types from the next line
   DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = Knowledge
   
   Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

   Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

   change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %YES%

   change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %YES%

   change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


   DEAR DOCUMENT REVIEWER
   ======================

   Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = MineAltunay
  
   Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %NO%


   DEAR DOCUMENT TESTER
   ====================

   Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = AnandPadmanabhan
  
   Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %IN_PROGRESS%
 
-->