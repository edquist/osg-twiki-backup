%META:TOPICINFO{author="ShawnMcKee" date="1414595517" format="1.1" version="1.10"}%
%META:TOPICPARENT{name="DeployperfSONAR"}%
%LINKCSS%

<!-- This is the default OSG documentation template. Please modify it in -->
<!-- the sections indicated to create your topic.                        --> 

<!-- By default the title is the WikiWord used to create this topic. If  -->
<!-- you want to modify it to something more meaningful, just replace    -->
<!-- %TOPIC% below with i.e "My Topic".                                  -->

---+!! %SPACEOUT{ "Installation and Upgrade Details" }%
%TOC%

%STARTINCLUDE%

This page documents installing or upgrading *perfSONAR* for WLCG/OSG Sites.  In case, this is the first time you're trying to install and integrate your perfSONAR into WLCG or OSG, please consult https://twiki.opensciencegrid.org/bin/view/Documentation/IntegrationPS

For any questions or help with WLCG perfSONAR setup, please contact wlcg-perfsonar-support (cern.ch) or open GGUS ticket for WLCG perfSONAR Monitoring Support Unit (available from 5th November). We strongly recommend anyone maintaining/using perfSONAR to join https://lists.internet2.edu/sympa/subscribe/perfsonar-user and https://lists.internet2.edu/sympa/subscribe/perfsonar-announce

The current baseline version for WLCG/OSG is perfSONAR 3.4, we recommend all sites to reinstall. In case you have updated to 3.3 and secured appropriately against !ShellShock and !POODLE, please see the [[#UpgradeGuide][Upgrade Guide]]. If you have already upgraded to 3.4, you still need to *re-configure your instances*, please see [[#ConfigMethod][Choosing Configuration Method]].

<!--
For OSG/WLCG  installations  that  are  currently running  v3.3.x and were secured appropriately such that =Shellshock=  compromise  wasn't  a risk, please see  the  Upgrade section  below.

For  other  installations that  are running  older versions or  may have  been at risk for  being compromised,  we  are  suggesting  a clean (re)install (see  "Installing  perfSONAR" below).   *NOTE:*  A  clean (re)install will  lose all existing data on the  node.   If you want  to try to preserve the data  (not recommended) please see http://docs.perfsonar.net/manage_update.html#migrating-from-a-3-3-2-livecd-liveusb for information on backing  up  and migrating your  data.   
-->

---++ Installing perfSONAR

The following is step by step guide to install perfSONAR 3.4 for WLCG and OSG. For general troubleshooting please go [[https://twiki.opensciencegrid.org/bin/view/Documentation/TroubleFAQPS][here]], in case you have any questions please contact wlcg-perfsonar-support (cern.ch) or open GGUS ticket for WLCG perfSONAR support unit. For OSG sites that don't participate in WLCG, please contact OSG operations. 

---+++ Installation
   * For sites using perfSONAR Net Install - please follow http://docs.perfsonar.net/install_centos_netinstall.html#step-by-step-guide
   * For sites using perfSONAR Full Install - please follow http://docs.perfsonar.net/install_centos_fullinstall.html#step-by-step-guide
   * For general configuration of perfSONAR - please follow http://docs.perfsonar.net/install_config_first_time.html

#ConfigMethod
---+++ Choosing Configuration Method

For sites participating in WLCG (including OSG sites also in OSG), please follow [[#WlcgConfig][WLCG specific configuration]], for all the others please follow [[#OsgConfig][OSG specific configuration]]. Please avoid following both guides, they're mutually exclusive.

#WlcgConfig
---+++ WLCG Configuration
 
   1. We recommend all sites to stop *NDT/NPAD* on your instances - please follow http://docs.perfsonar.net/manage_services.html#enabling-disabling-services
   2. Make sure to configure all the [[PSAdminInfo][administrative information]] for your perfSONAR installation.
   3. Please configure your mesh URL(s) in */opt/perfsonar_ps/mesh_config/etc/agent_configuration.conf* - set this according to the [[http://grid-monitoring.cern.ch/perfsonar_config.txt][following table]]. If you're unable to find your perfSONAR hostname in the table, please contact WLCG perfSONAR support. Please only copy/paste _mesh_ blocks, relevant to your perfSONAR host.
   4. *Security configuration*. Some sites are concerned about having port 80 and/or 443 open.  The working group would like to emphasize that these ports provide access to the perfSONAR web interface and are very useful to users and network administrators.   Our recommendation is to keep them open but for sites with strong concerns we have some rules documented below to customize  iptables to block ports 80 and 443.  It is *required* that either port 80 or port 443 be accessible from the WLCG monitoring subnets shown below:
      <verbatim>
# Allow HTTP/HTTPS only from our monitoring subnets and your site's subnets 
# Replace <LOCAL_SUBNET> with your site subnet/netmask, e.g. 193.87.10.0/255.255.255.0 or 193.87.10.0/24
# OSG monitoring subnet
iptables -I INPUT 4 -p tcp --dport 443 -s 129.79.53.0/24 -j ACCEPT
# CERN subnet
iptables -I INPUT 4 -p tcp --dport 443 -s 137.138.0.0/17 -j ACCEPT
# Infrastructure monitoring (hosted at AGLT2)
iptables -I INPUT 4 -p tcp --dport 443 -s 192.41.231.110/32 -j ACCEPT
# Replace <LOCAL_SUBNET> appropriately to allow access from your local systems
iptables -I INPUT 4 -p tcp --dport 443 -s <LOCAL_SUBNET> -j ACCEPT
iptables -I INPUT 5 -p tcp --dport 443 -j REJECT

#OSG monitoring subnet
iptables -I INPUT 4 -p tcp --dport 80 -s 129.79.53.0/24 -j ACCEPT
# CERN subnet
iptables -I INPUT 4 -p tcp --dport 80 -s 137.138.0.0/17 -j ACCEPT
# Infrastructure monitoring (hosted at AGLT2)
iptables -I INPUT 4 -p tcp --dport 80 -s 192.41.231.110/32 -j ACCEPT
# Replace <LOCAL_SUBNET> appropriately to allow access from your local systems
iptables -I INPUT 4 -p tcp --dport 80 -s <LOCAL_SUBNET> -j ACCEPT
iptables -I INPUT 5 -p tcp --dport 80 -j REJECT


/sbin/service iptables save
   </verbatim>
   5. In case you have *central/campus firewall*, please ensure the following ports are opened on it for all your perfSONAR hosts:
   <verbatim>
# General purpose ports needed to do perfSONAR measurements
ICMP/type 255, 
NTP UDP port:123, 
TRACEROUTE/PING UDP ports: 33434-33634
OWAMP TCP port:861, UDP ports: 8760-9960
BWCTL TCP ports: 4823, 6001-6200, 5000-5900  UDP ports: 6001-6200, 5000-5900 

# HTTP and/or HTTPS ports are needed to access your perfSONAR web interface 
# and the measurement archive and to check availability of your instances by the infrastructure monitoring
# At a minimum either port 80 or 443 *must* be open to the WLCG monitoring subnets.  
# Our recommendation is to have either HTTP or HTTPS open to allow users and network admins access to the perfSONAR web.
HTTP/HTTPS ports 80,443 - 
from source subnets OSG_NET (129.79.53.0/24), AGLT2_NET (192.41.231.110/32) and CERN_NET (137.138.0.0/17)
   </verbatim>
   6. We *strongly recommend* configuring perfSONAR in *dual-stack mode* (both IPv4 and IPv6) 
      * In case your site has IPv6 support, the only necessary step is to get both A and AAAA records for your perfSONAR DNS names (as well as ensuring the reverse is in place).
      * All existing meshes will support both IPv4 and IPv6 testing.  Sites with both IPv4 and IPv6 addresses testing to sites that also have both will run *two* tests.   A side effect of this is that as more sites provide IPv6 addresses, the amount of testing will increase.  
      * At some future point when most sites have IPv6, we may need to adjust the testing frequency to reduce the overall amount of testing
   7.  Finally, please ensure your perfSONARs are *registered* either in [[RegisterPSinOIM][OIM]] or in [[PerfSONARInGOCDB][GOCDB]] (service types to use are net.perfSONAR.Bandwidth, net.perfSONAR.Latency). Please note, that only registered perfSONARs will be able to use the new mesh configuration system.

Some additional security related information, including instructions on how to allow x509 authorization are in SecureperfSONAR.

For any further questions, please consult [[https://twiki.opensciencegrid.org/bin/view/Documentation/TroubleFAQPS][Troubleshooting]] pages, perfSONAR documentation (http://docs.perfsonar.net) or contact WLCG perfSONAR Supporting Unit. 

#OsgConfig
---+++ OSG Configuration
   * We are working on OSG specific meshes but they are net ready yet.  An announcement will be sent out on appropriate OSG mailing lists notifying sites when this is ready.
   * Make sure to configuration all the [[PSAdminInfo][administrative information]] for your perfSONAR installation.
   * *Security configuration*. Some sites are concerned about having ports 80 and/or 443 open. OSG would like to emphasize that these ports provide access to the perfSONAR web interface and are very useful to users and network administrators.   Our recommendation is to keep them open but for sites with strong concerns we have some rules documented below to customize  iptables to block ports 80 and 443.  It is *required* that either ports 80 or port 443 be accessible from the OSG monitoring subnet shown below:
      <verbatim>
# Allow HTTP/HTTPS only from OSG and your site's subnets 
#  replace <LOCAL_SUBNET> with your site subnet/netmask, e.g. 193.87.10.0/255.255.255.0 or 193.87.10.0/24
# OSG monitoring subnet
iptables -I INPUT 5 -p tcp --dport 443 -s 129.79.53.0/24 -j ACCEPT
# Replace <LOCAL_SUBNET> appropriately to allow access from your local systems
iptables -I INPUT 5 -p tcp --dport 443 -s <LOCAL_SUBNET> -j ACCEPT
iptables -I INPUT 5 -p tcp --dport 443 -j REJECT

#OSG monitoring subnet
iptables -I INPUT 5 -p tcp --dport 80 -s 129.79.53.0/24 -j ACCEPT
# Replace <LOCAL_SUBNET> appropriately to allow access from your local systems
iptables -I INPUT 5 -p tcp --dport 80 -s <LOCAL_SUBNET> -j ACCEPT
iptables -I INPUT 5 -p tcp --dport 80 -j REJECT

/sbin/service iptables save
   </verbatim>
   * In case you have central/campus firewall, please ensure the following ports are opened on it for all your perfSONAR hosts:
   <verbatim>
# General purpose ports needed to do perfSONAR measurements
ICMP/type 255, 
NTP UDP port:123, 
TRACEROUTE/PING UDP ports: 33434-33634
OWAMP TCP port:861, UDP ports: 8760-9960
BWCTL TCP ports: 4823, 6001-6200, 5000-5900  UDP ports: 6001-6200, 5000-5900 

# HTTP and/or HTTPS ports are needed to access your perfSONAR web interface and the measurement archive and to check availability of your instances by the infrastructure monitoring
# At a minimum either port 80 or 443 *must* be open to the OSG monitoring subnet.  Our recommendation is to have either HTTP or HTTPS open to allow users and network admins access to the perfSONAR web UI.
HTTP/HTTPS ports 80,443 source subnet OSG_NET (129.79.53.0/24)
   </verbatim>
   * We *strongly recommend* configuring perfSONAR in *dual-stack mode* (both IPv4 and IPv6) 
      * In case your site has IPv6 support, the only necessary step is to get both A and AAAA records for your perfSONAR DNS names (as well as ensuring the reverse is in place).
      * All existing meshes will support both IPv4 and IPv6 testing.  Sites with both IPv4 and IPv6 addresses testing to sites that also have both will run *two* tests.   A side effect of this is that as more sites provide IPv6 addresses, the amount of testing will increase.  
      * At some future point when most sites have IPv6, we may need to adjust the testing frequency to reduce the overall amount of testing
   *  Finally, please ensure your perfSONARs are registered in [[RegisterPSinOIM][OIM]]  (service types to use are net.perfSONAR.Bandwidth, net.perfSONAR.Latency)

For any further questions, please consult [[https://twiki.opensciencegrid.org/bin/view/Documentation/TroubleFAQPS][Troubleshooting]] pages, perfSONAR documentation (http://docs.perfsonar.net) or contact OSG support. 

#UpgradeGuide  
---++ Upgrading perfSONAR

Please run the following:
<verbatim>
# yum clean all
# yum update
# reboot
</verbatim> 

Note, it's *very important to reboot* otherwise your update is incomplete. 

Please reconfigure your boxes following either [[#WlcgConfig][WLCG Configuration]] or [[#OsgConfig][OSG Configuration]]. If unsure about which method to follow, please check [[#ConfigMethod][Choosing Configuration Method]]. For any further questions, please consult [[https://twiki.opensciencegrid.org/bin/view/Documentation/TroubleFAQPS][Troubleshooting]] pages, perfSONAR documentation (http://docs.perfsonar.net) or contact directly WLCG or OSG perfSONAR support units. 


%STOPINCLUDE%

%BOTTOMMATTER%

-- Main.ShawnMcKee - 14 Oct 2014