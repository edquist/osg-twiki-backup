%META:TOPICINFO{author="SuchandraThapa" date="1348506870" format="1.1" version="1.6"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! Installing GSI !OpenSSH
%DOC_STATUS_TABLE%
%TOC{depth="3"}%

---+ About This Document

This document gives instructions on installing and using the GSI !OpenSSH server available in the OSG repository and configuring it so that you can use on your cluster.
 

---+ Engineering Considerations

---+ Requirements
---++ Host and OS
The GSI !OpenSSH rpms will require an user account and group in order for the privilege separation to work.  

---++ Users and Groups
The rpms will try to create the =gsisshd= user and group and the =/var/empty/gsisshd= directory with the correct ownership when you install it if these are not present.  If you are using a configuration management system or ROCKS, you should make sure that these users and groups are created before the rpms are installed to avoid potential issues.  The gsisshd user should have an empty home directory.  By default, this is home directory set to  =/var/empty/gsisshd=  and belongs to the =gsisshd= user and group.  You may change it if needed to something else as long as the ownerships remain the same.

#NetworkingReq
---++ Networking
%STARTSECTION{"Firewalls"}%
%INCLUDE{"FirewallInformation" section="FirewallTable" lines="gsissh"}%
%ENDSECTION{"Firewalls"}%

You'll find more client specific details also in the [[#Firewall_Considerations][Firewall section]] of this document.

---+ Installation procedure
%INCLUDE{"YumRepositories" section="OSGRepoBrief" TOC_SHIFT="+"}%

%STARTSECTION{"InstallGSIOpenSSHRPMs"}%
---++ GSI !OpenSSH Installation
 Start with installing GSI !OpenSSH from the repository
<pre  class="rootscreen">
%UCL_PROMPT_ROOT% yum install gsi-openssh-server
</pre>

---+ Configuration and Operations

#ImportantFiles
---++ Useful configuration and log files

Configuration Files
| *Service or Process* | *Configuration File* | *Description* |
| gsisshd | =/etc/gsissh/sshd_config= | Configuration file |
| gsisshd | =/etc/sysconfig/gsisshd= | Environment variables for gsisshd |
| gsisshd | =/etc/lcmaps.db= | LCMAPS configuration |

Log Files
| *Service or Process* | *Log File* | *Description* |
| gsisshd | =/var/log/messages= | All log messages |

Other Files
| *Service or Process* | *File* | *Description* |
| gsisshd | =/etc/grid-security/hostcert.pem= | Host certificate |
| gsisshd | =/etc/grid-security/hostcert.pem= | Key certificate |
| gsisshd | =/etc/gsissh/ssh_host_rsa_key= | RSA Host key | 
| gsisshd | =/etc/gsissh/ssh_host_dsa_key= | DSA Host key |


---++ Configuration
In order to get a running instance of the GSI !OpenSSH server, you'll need to change the default configuration.  However, before you go any further, you'll need to decide whether you want GSI !OpenSSH to be your primary ssh service or not (e.g. whether the GSI !OpenSSH service will replace your existing SSH service).  If you choose not to replace your existing service, you'll need to change the port setting in the GSI !OpenSSH configuration to another port (e.g. 2222) so that you can run both SSH services at the same time.  Regardless of your choice, you should probably have both services use the same host key.  In order to do this, symlink =/etc/gsissh/ssh_host_dsa_key= and =/etc/gsissh/ssh_host_rsa_key= to =/etc/ssh/ssh_host_dsa_key= and =/etc/ssh/ssh_host_rsa_key=  respectively. 
%NOTE% Regardless of the authorization method used for the user,  any account that will be used with GSI !OpenSSH must have a shell assigned to it and not be locked (have !! in the password field of =/etc/shadow=).

---++ Using a gridmap file for authorization
In order to use , you'll need to create mappings in your =/etc/grid-security/grid-mapfile= for the DNs that you will allow to login.  The mappings should be entered one to a line, with each line consisting of DN followed by the account the DN should map to.  Also, you should ensure that the =/etc/grid-security/gsi-authz.conf= file is empty or that all of the lines in the file are commented out using a =#= at the beginning of the line.

%NOTE% The mappings will not consider VOMS extensions so the first mapping that matches will be used regardless of the VO role or VO present in the users proxy

An example of the =/etc/grid-security/grid-mapfile= follows:
<pre class="file">
"/DC=org/DC=doegrids/OU=People/CN=USER NAME 123456" useraccount
</pre>
---++ Using LCMAPS and GUMS for authorization
In order to use LCMAPS callouts with GSI !OpenSSH, you'll first need to edit =/etc/grid-security/gsi-authz.conf= to indicate that Globus should do a GSI callout for authorization.  The file should contain the following:
<pre class="file">
globus_mapping liblcas_lcmaps_gt4_mapping.so lcmaps_callout
</pre>
so that LCMAPS is used.  Next, install the lcmaps rpms:
<pre  class="rootscreen">
%UCL_PROMPT_ROOT% yum install lcmaps lcmaps-plugins-basic lcmaps-plugins-gums-client lcmaps-plugins-saz-client lcmaps-plugins-scas-client lcmaps-plugins-verify-proxy  lcas-lcmaps-gt4-interface
</pre>
After this, you'll also need to ensure that several environment variables are defined when gsisshd is run.  This is done by editing =/etc/sysconfig/gsisshd= and adding the following if it's not already present:
<pre class="file">
export LLGT_LOG_IDENT=gsisshd-lcmaps
export LCMAPS_DB_FILE=/etc/lcmaps.db
export LCMAPS_POLICY_NAME=authorize_only
export LLGT_LIFT_PRIVILEGED_PROTECTION=1
#level 0: no messages, 1: errors, 2: also warnings, 3: also notices,
#  4: also info, 5: maximum debug
export LCMAPS_DEBUG_LEVEL=3
</pre>
Finally, you'll need to modify  =/etc/lcmaps.db= so that the =gumsclient= entry has the correct endpoint for your gums server.



---++ Starting and Enabling Services
To start the services:
   1. To start GSI !OpenSSH you can use the service command, e.g.: <pre class="rootscreen">
%UCL_PROMPT_ROOT% /sbin/service gsisshd start
</pre>

You should also enable the appropriate services so that they are automatically started when your system is powered on: 
   * To enable !OpenSSH by default on the node: <pre class="rootscreen">
%UCL_PROMPT_ROOT% /sbin/chkconfig gsisshd on
</pre>

---++ Stopping and Disabling Services
To stop the services:
   1. To stop !OpenSSH you can use: <pre class="rootscreen">
%UCL_PROMPT_ROOT% /sbin/service gsisshd stop
</pre>

In addition, you can disable services by running the following commands.  However, you don't need to do this normally.
   * Optionally, to disable !OpenSSH: <pre class="rootscreen">
%UCL_PROMPT_ROOT% /sbin/chkconfig gsisshd off
</pre>

---+ Troubleshooting
You can get information on troubleshooting errors on the [[http://grid.ncsa.illinois.edu/ssh/ts_server.html][NCSA page]].


---++ Test GSI !OpenSSH

After starting the =gsisshd= service you can check if it is running correctly<pre  class="screen">
%UCL_PROMPT% grid-proxy-init
Your identity: /DC=org/DC=doegrids/OU=People/CN=User Name
Enter GRID pass phrase for this identity:
Creating proxy .................................................................. Done
%UCL_PROMPT% gsissh localhost -p 2222
Last login: Tue Sep 18 16:08:03 2012 from itb4.uchicago.edu
%UCL_PROMPT%  </pre>



---+ How to get Help?
To get assistance please use this [[HelpProcedure][Help Procedure]].


---+ References

---+ Comments
%COMMENT{type="tableappend"}%

<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################ 
   DEAR DOCUMENT OWNER
   ===================

   Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER          = SuchandraThapa

   Please define the document area, choose one of the defined areas from the next line
   DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       =  ComputeElement

   define the primary role the document serves, choose one of the defined roles from the next line
   DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager|Documenter)
   * Local DOC_ROLE       = SysAdmin

   Please define the document type, choose one of the defined types from the next line
   DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = Installation
   
   Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

   Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

   change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %YES%

   change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %YES%

   change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   reviewed during the DOC workshop
   * Local RELEASE_READY  = %NO%


   DEAR DOCUMENT REVIEWER
   ======================

   Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = 
  
   Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %IN_PROGRESS%


   DEAR DOCUMENT TESTER
   ====================

   Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = 
  
   Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %IN_PROGRESS%
############################################################################################################ 
-->



-- Main.SuchandraThapa - 13 Sep 2012