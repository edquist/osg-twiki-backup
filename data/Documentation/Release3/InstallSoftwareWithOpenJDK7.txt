%META:TOPICINFO{author="MatyasSelmeci" date="1369081486" format="1.1" reprev="1.3" version="1.3"}%
%DOC_STATUS_TABLE%

---+!! Installing OSG Software to Use !OpenJDK 7

%TOC{depth="2"}%

---# About This Document

This document explains how to install Java-based OSG Software components in such a way that the only Java implementation installed and available afterward is !OpenJDK 7. The procedure is intended for site administrators who want to ensure that their systems are running only a current, supported Java implementation; specifically, it is part of the OSG plan to migrate away from all Java 6 implementations, which are no longer supported by their vendors.

The procedure below does *not* describe how to install or configure specific components. For that, please refer to the Release3/WebHome documentation index.

<!-- Variables used in this Document 
   * Local UCL_USER = root
   * Local UCL_HOST = host
-->

---# Applicable Versions (Optional)

Currently, only the Java-based software contained in the =osg-upcoming-testing= repositories have been tested with !OpenJDK 7. As the name indicates, the packages are still in public testing, so they are not suitable for production use at this time. See the [[SoftwareTeam.Java6Migration][Software team’s Java migration project page]] for more information about the overall project.

---# Background

Many OSG Software packages, including !BeStMan 2, Gratia, GUMS, HDFS, Pegasus, and VOMS Admin, contain Java code. Historically, we built and tested them using the Oracle JDK 1.6 implementation of Java 6. We even included the Oracle distributions in the OSG Software stack. However, Oracle officially discontinued public support for Java 6 at the end of February 2013, including security fixes. This is a problem for us due to the numerous security flaws in Java that people keep discovering. Therefore we must move away from Oracle JDK 1.6 and Java 6 in general. [[Java6Migration_draft][As announced earlier]], our plan has been to migrate all OSG Software Java components to work with !OpenJDK 7.

---# Requirements

To use !OpenJDK 7, the system must have or be able to install the =java-1.7.0-openjdk= package from the operating system vendor’s yum repository. This package is available on both EL5 and EL6 systems, although only the latest releases of EL5 systems contain it. Thus, you may need to upgrade your operating system to obtain !OpenJDK 7 for these instructions.

To see if your system has !OpenJDK 7 available:

   1. Install the =yum-utils= package, if not already installed (run =rpm -q yum-utils= to check)
   1. Check for the !OpenJDK 7 package:<pre class="screen">repoquery java-1.7.0-openjdk</pre>

The =repoquery= command should return at least one line of output, something like this:

<pre class="screen">java-1.7.0-openjdk-1:1.7.0.19-2.3.9.1.el5_9.x86_64</pre>

If it does not, then you probably need to update your operating system to the latest release, which is beyond the scope of this document.

---# Installation Instructions

---## Install OSG Java-Based Software

   1. Install Java-based software from the OSG Upcoming testing software repository:\
      <p>Follow the detailed installation instructions contained in the documents linked from the [[WebHome][documentation home page]].</p>\
      <p>For each =yum= command used, be sure to enable the Upcoming testing repository by using the following =yum= command-line option:</p>\
      <pre class="rootscreen">... --enablerepo=osg-upcoming-testing ...</pre>

Installing any Java-based components from this repository will cause !OpenJDK 7 to be installed as well.

---## Fix Bad Symlinks from Oracle JDK

   1. Check to see if the =jdk= package is installed:\
      <pre class="rootscreen">%UCL_PROMPT_ROOT% rpm -q jdk</pre>\
      <p>If the RPM is installed, there will be a line of output containing the RPM name and version.\
      *If not installed,* skip to the next section!</p>
   1. Remove incorrect symlinks:\
      <pre class="rootscreen">%UCL_PROMPT_ROOT% rm -f /usr/bin/java /usr/bin/javac /usr/bin/javadoc /usr/bin/jar</pre>
   1. Reinstall !OpenJDK 7 to create corrected symlinks:\
      <pre class="rootscreen">%UCL_PROMPT_ROOT% yum reinstall java-1.7.0-openjdk java-1.7.0-openjdk-devel</pre>

---## Select Preferred Java Version

   1. Select the preferred version of the Java VM:\
      <pre class="rootscreen">%UCL_PROMPT_ROOT% alternatives --config java</pre>\
      Select =jre-1.7.0-openjdk=.
   1. Verify the correct version is in place:\
      <pre class="rootscreen">%UCL_PROMPT_ROOT% java -version</pre>\
      The version should start with =1.7=

---## Select Preferred JDK Version

   1. Check to see if the development packages are installed:\
      <pre class="rootscreen">%UCL_PROMPT_ROOT% rpm -q java-1.7.0-openjdk-devel</pre>\
      <p>If the RPM is installed, there will be a line of output containing the RPM name and version.\
      *If not installed,* skip to the next section!</p>
   1. Select the preferred version of the Java development tools:\
      <pre class="rootscreen">%UCL_PROMPT_ROOT% alternatives --config javac</pre>\
      Select =java-1.7.0-openjdk=.
   1. Verify the correct version is in place:\
      <pre class="rootscreen">%UCL_PROMPT_ROOT% javac -version</pre>\
      The version should start with =1.7=

---## Optional: Purge Other JDK Packages

Additional steps are necessary if you want to remove all other versions of Java
from your system. Even if you do not follow these steps, the previous steps
ensure that !OpenJDK 7 is the preferred Java runtime for OSG apps.

---### Install yum-utils to get yumdownloader

A script called yumdownloader is necessary for one of the steps. It is found in
the yum-utils package.

<pre class="rootscreen">%UCL_PROMPT_ROOT% yum install -y yum-utils</pre>

In the next set of steps, you will erase the old JDKs to keep them from being
used, while not letting yum erase the packages that "require" the old JDKs.
This is done by forcefully erasing the packages and then adding entries for
them back into rpm's database. That will also allow you to install other
Java-based software later without worrying about it bringing in old JDKs.

   1. Make a directory to hold RPMs of the old JDKs\
   <pre class="rootscreen">%UCL_PROMPT_ROOT% mkdir -p /tmp/javarpms; cd /tmp/javarpms</pre>
   1. Save a list of old JDKs that are installed\
   <pre class="rootscreen">%UCL_PROMPT_ROOT% rpm -qa | egrep '^(java|jdk)-1.[1-6]' | grep -v java-1.7.0 &gt; oldjava.txt</pre>
   1. Download RPMs for the old JDKs\
   <pre class="rootscreen">%UCL_PROMPT_ROOT% xargs -a oldjava.txt yumdownloader</pre>
   1. Erase old JDKs, without removing dependant Java software\
   <pre class="rootscreen">%UCL_PROMPT_ROOT% xargs -a oldjava.txt rpm -ev --nodeps</pre>
   1. Add entries for the old JDKs into RPM's database -- essentially making it pretend they are installed\
   <pre class="rootscreen">%UCL_PROMPT_ROOT% rpm -ivh --justdb *.rpm</pre>

---## Restart Java-Based Services

If you have any Java-based services, such as VOMS-Admin or GUMS, then restart them by using the =service= command.

---# Get Help/Support

To get assistance please use [[Documentation/Release3.HelpProcedure][this page]]. 


---# Comments

%COMMENT{type="tableappend"}%


<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = TimCartwright

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|General|Integration|Monitoring|Operations|Security|Storage|Tier3|User|VO)
   * Local DOC_AREA       = General

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (Developer|Documenter|Scientist|Student|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (HowTo|Installation|Knowledge|Navigation|Planning|Training|Troubleshooting)
   * Local DOC_TYPE       = Installation
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %YES%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %YES%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY = %NO%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER = 
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED = %IN_PROGRESS%


 DEAR DOCUMENT TESTER
 ====================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER = 
 Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED = %IN_PROGRESS%
############################################################################################################
-->
