%META:TOPICINFO{author="JeffDost" date="1320234225" format="1.1" reprev="1.1" version="1.1"}%
%DOC_STATUS_TABLE%
---+!! Instructions for Upgrading Hadoop

%TOC{depth="2"}%

---+ About This Document

%ICON{hand}% This document is intended for System Administrators that want to upgrade their Hadoop install to the new OSG hosted rpms.

%INCLUDE{"Documentation/DocumentationTeam/DocConventions" section="Header"}%
%INCLUDE{"Documentation/DocumentationTeam/DocConventions" section="CommandLine"}%

---+ Applicable Versions (Optional)

%GRAY%
In case the procedure differs significantly for different versions of the OSG or VDT, please include this section.
%ENDCOLOR%

The applicable software versions for this document are %RED%OSG Version >= x.y%ENDCOLOR% and %RED%VDT Version >= a.b%ENDCOLOR%.

---+ Introduction (Optional)

%GRAY%
%NOTE% This section may sometimes be called differently, such as "About Compute Element Services".

This optional section may contain a brief technical description. It may explain what the purpose of the installed software is and when it is needed. It should help the reader make a decision if the content of the document is relevant for him. It may also explain terms being used throughout the document complete with links to the Glossary if possible. See for example  the introduction of the [[ReleaseDocumentation.WorkerNodeClient#What_is_the_Worker_Node_Client_a][Worker Node Client]].

%ENDCOLOR%

---+ Engineering Considerations (Optional)

%GRAY%
Please provide this section if an extensive amount of planning is required before the installation can proceed. This could be installations that require services and/or software to be installed on several machines.
%ENDCOLOR%

---+ How to get Help?

%GRAY%Link the main help page here. List additional sources that could be helpful to the reader!
%ENDCOLOR%

To get assistance please use [[Documentation/Release3.HelpProcedure][this page]]. 

---+ Requirements

%GRAY%
This section serves as a possible early exit point for readers of the document. It must list all requirements that have to be met in order for a typical installation to succeed. All tools mentioned must be linked. All terminologies used should be linked to the Glossary explaining them. For example:
%ENDCOLOR%

   1 verify that your operating system is [[http://vdt.cs.wisc.edu/releases/2.0.0/requirements.html][supported]].
   1 except for worker node installations a valid [[GetHostServiceCertificates][grid host certificate]] is required.
   1 to test and use the installation a valid [[CertificateUserGet][grid user certificate]] is required.

---+ Upgrade Procedure

%GRAY%
This section should contain the entire installation procedure. The configuration of the software should be contained in an own subsection (see below) if it requires a significant amount of work and cannot easily be included in the installation procedure presented here.

The first item should be a numbered list of steps that provide the reader with an overview about the installation process. For example:
%ENDCOLOR%

The installation procedure consists of the following steps:
   1 install the [[Documentation/GlossaryC#DefsCA][CA Certificates]] and the %LINK_GLOSSARY_CRL%
   1 configure logfile rotation and automatic updates of [[Documentation/GlossaryC#DefsCA][CA Certificates]] and the %LINK_GLOSSARY_CRL%

%GRAY%
%NOTE% Each step listed in the numbered list above should have its own subsection.

%NOTE% This procedure covers the success legs only. Everything else should be included in the 'Troubleshooting' section at the bottom! 
%ENDCOLOR%

%NOTE% Throughout this document it will be stated which node the relevant instructions apply to.  It can apply to one of the following:
   * *Namenode*
   * *Datanode*
   * *Secondary Namenode*
   * *GridFTP node*
   *  *SRM node*

---++ Initializing the YUM Repository

%NOTE% This must be done on *all nodes*

%INCLUDE{"Documentation.InstallVDTRepo"}%

---++ Stop Running Services

---+++ Stopping !BeStMan2

On your *SRM Node* run:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% service bestman2 stop
</pre>

---+++ Stopping Hadoop

On your *Namenode*, *Secondary Namenode*, and *Datanodes* run:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% service hadoop stop
</pre>

---++ Special  !GridFTP Pre-Upgrade Instructions

Upgrading your *GridFTP Node* first requires an extra manual step due to version collisions of the =lcas= and =lcas-lcmaps-gt4-interface= rpms between repos.  To avoid depsolving issues first remove these packages before proceeding with the rest of the upgrade instructions:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% yum remove lcas
</pre>

<pre class="rootscreen">
%UCL_PROMPT_ROOT% yum remove lcas-lcmaps-gt4-interface
</pre>

Choose "yes" when asked to remove packages that depend on these.  Also make note of any warning messages regarding backups of config files, e.g.:

<pre class="file">
warning: /etc/lcmaps/lcmaps.db saved as /etc/lcmaps/lcmaps.db.rpmsave
</pre>

---++ Perform Yum Update

On *all nodes* run:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% yum update
</pre>

Again, make note of any warning messages regarding backups of config files saved to =*.rpmsave= locations.

---++ Install !GridFTP

You must manually install the new version of !GridFTP since it was removed in the previous steps above.

<pre class="rootscreen">
%UCL_PROMPT_ROOT% yum install osg-gridftp-hdfs
</pre>

---+ Configuration Procedure

%GRAY%
Non-trivial configuration steps for the software should be presented here. Include an overview of the configuration procedure if the procedure itself is lengthy:
%ENDCOLOR%

In the next step we will configure the service using following steps:

   1 edit this file
   1 open that firewall port
   1 ...

%GRAY%
Steps listed as part of the numbered list above should have their own sub-section inside this section. For example:
%ENDCOLOR%

---++ Update Config Files as Needed

Review any =*.rpmsave= files reported in the process and update as needed.  A few of these locations have been changed for the new rpms.  The most relevant changes are listed here:

| Service | Old Location | New Location |
| !GridFTP | /etc/lcmaps/lcmaps.db | /etc/lcmaps.db |
| Gratia Transfer Probe | /opt/vdt/gratia/probe/gridftp-transfer/ProbeConfig | /etc/gratia/gridftp-transfer/ProbeConfig |
| Hadoop Storage Probe | /opt/vdt/gratia/probe/hadoop-storage/ProbeConfig | /etc/gratia/hadoop-storage/ProbeConfig |
| Hadoop Storage Probe | /opt/vdt/gratia/probe/hadoop-storage/storage.cfg | /etc/gratia/hadoop-storage/storage.cfg |

---++ Notable Changes for !GridFTP

Note the change in location of the =lcmaps.db= file listed above.  Once you update the new file you need to perform this additional step:

Edit =/etc/grid-security/gsi-authz.conf= and uncomment the globus callout:

<pre class="file">
globus_mapping /usr/lib64/liblcas_lcmaps_gt4_mapping.so lcmaps_callout
</pre>

---++ Notable Changes for Gratia Transfer Probe

Note the change in location of the =ProbeConfig= file listed above.  In addition, the Transfer Probe no longer uses =osg-user-vo-map-cron= to generate the =user-vo-map= file.  Instead =gums-host-cron= is used.  To ensure the file gets generated, run it first by hand:

<pre class="rootscreen">
%UCL_PROMPT_ROOT%  gums-host-cron
</pre>

=user-vo-map= should be created in the following location:

=/var/lib/osg/user-vo-map=

Ensure =ProbeConfig= is updated to point to the new location of this file in the =UserVOMapFile= field.

To have cron regularly update this file start the following service:

<pre class="rootscreen">
%UCL_PROMPT_ROOT%  service gums-client-cron start
</pre>

---++ Notable Changes for Hadoop Storage Probe

Note the config file location changes listed above.  Please ensure the following lines are correct in =storage.cfg=:

<pre class="file">
gratia_location = /etc/gratia
ProbeConfig = %(gratia_location)s/hadoop-storage/ProbeConfig
</pre>

---+ Service Activation and Deactivation (Optional)

%GRAY%
If applicable, this section contains steps required to activate and deactivate the software. Please reuse the material that has been written on the topic here [[ReleaseDocumentation.StartingServices][About VDT Services]]. For example like this:

<verbatim>
%INCLUDE{"ReleaseDocumentation.StartingServices" section="Activate" TOC_SHIFT="" INPUT_SERVICE="mysql"}%
%INCLUDE{"ReleaseDocumentation.StartingServices" section="Deactivate" TOC_SHIFT="" INPUT_SERVICE="mysql"}%
</verbatim>

The =INPUT_SERVICE= variable is optional.

This section may also contain the location of a log file that allows the reader to quickly verify the operation of the service.
%ENDCOLOR%


---+ Validation of Service Operation (Optional)

%GRAY%
Occasionally the steps to validate the success and correct operation of an installation may be _non-trivial_. Please use this _optional_ section to describe how the user can verify the success of the installation.

%NOTE% This section should not become a user guide! Please link to the applicable sections of the user documentation if the service validation requires the reader to execute a user command.
%ENDCOLOR%

---+ Troubleshooting (Optional)

%GRAY%
Please include this section if you can provide useful troubleshooting information here. Use sub sections for each topic you want to address.
%ENDCOLOR%

---++ File Locations

%GRAY%
Locations of configuration files, input/output files, log files, etc. that are important for an administrator to know about if something doesn't work. Please use a table if you have more than 2 files to list.
%ENDCOLOR%

---++ Known Issues

%GRAY%
Restrictions and/or work around for known issues. 
%ENDCOLOR%

---++ &lt;How can I resolve this Problem?&gt;

%GRAY%
Use sub-sections for each problem you want to address in particular. Link to ReleaseDocumentation.HelpProcedure at the end if the problem could not be resolved.
%ENDCOLOR%


---+ References (Optional)

%GRAY%
References to additional information.  This document should be as concise as possible, but the reader can use these links if he/she wants more background or information. Link related material here, such as the user guide to the software the user was just installing.
%ENDCOLOR%

---+ Comments
%COMMENT{type="tableappend"}%

<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = JeffDost

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|General|Integration|Monitoring|Operations|Security|Storage|Tier3|User|VO)
   * Local DOC_AREA       = Storage

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (Developer|Documenter|Scientist|Student|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (HowTo|Installation|Knowledge|Navigation|Planning|Training|Troubleshooting)
   * Local DOC_TYPE       = Installation
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %YES%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %YES%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = DouglasStrain
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %IN_PROGRESS%


 DEAR DOCUMENT TESTER
 ====================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = DouglasStrain
 Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %IN_PROGRESS%
############################################################################################################
-->
-- Main.JamesWeichel - 03 Feb 2010
