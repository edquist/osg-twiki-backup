%META:TOPICINFO{author="BrianLin" date="1484842654" format="1.1" version="1.3"}%
<style type="text/css">
code em, pre em { color: red; font-weight: normal; font-style: normal; }
</style>

<div style="border: 1px solid black; margin: 1em 0; padding: 1em; background-color: #FFDDDD; font-weight: 600;">
---+!! Draft Documentation
Consider this document to be a late draft: The technical content has been reviewed, and is *mostly* complete and accurate. Here are the known issues with the document now:
   * It needs a troubleshooting section
   * The suggested use of CA certificates must be reviewed
   * The section on optional backup balancers needs further review and clarifications
   * The section on disabling ARP needs further review and clarifications
We expect to complete the document during the week of 17&ndash;20 January 2017.
</div>

---+ Load Balancing !GridFTP

%TOC{depth="3"}%

---++ About This Guide

!GridFTP is designed for high throughput data transfers and in many cases can handle all of the transfers for a site. However, in some cases it may be useful to run multiple !GridFTP servers to distribute the load. For such sites, we recommend using a [[https://en.wikipedia.org/wiki/Load_balancing_(computing)][load balancer]] to distribute requests and present the appearance of a single high-throughput !GridFTP server.

One general-purpose technology for implementing a load balancer on Linux is [[http://www.linuxvirtualserver.org/whatis.html][Linux Virtual Server]] (LVS). To use it with !GridFTP, a single load balancer listens on a virtual IP address, monitors the health of the set of real !GridFTP servers, and forwards requests to available ones. Optionally, there can be one or more inactive, backup load balancers that can activate and take over the virtual IP address in case the primary load balancer fails, resulting in a system that is more resilient to failure. LVS is implemented by the [[http://www.linuxvirtualserver.org/software/ipvs.html][IP Virtual Server]] kernel module, which can be managed by userspace services on the load balancers such as [[http://www.keepalived.org][keepalived]].

This guide explains how to install, configure, run, test, and troubleshoot the =keepalived= service on a load balancing host for a set of [[Documentation.Release3/InstallOSGGridFTP][GridFTP]] servers.


---++ Before Starting

%INCLUDE{"Documentation/Release3.DocumentationSnippets" section="OsgPreReqs"}%


---++ Installing Keepalived on Load Balancers

Whether you run a single load balancer, or have one active load balancer and some inactive backups, each load balancer host must have the =keepalived= software installed, configured, and running.

%NOTE% Do not install =keepalived= on the !GridFTP servers themselves.

The =keepalived= package is available from the operating system repositories. Install it on each load balancer host using the following commands:

<ol>
%INCLUDE{"Documentation/Release3/OSGReleaseSeries" section="Update"}%
  <li>
    <p>Install the =keepalived= package:</p>
    <pre class="rootscreen">%UCL_PROMPT_ROOT% yum install keepalived</pre>
  </li>
</ol>


---++ Configuring the Load Balancer(s)

On the primary load balancer, edit =/etc/keepalived/keepalived.conf=:

<pre class="file">global_defs {
   router_id <span style="background-color: #FFCCFF;">LABEL FOR YOUR LVS</span>
}

vrrp_instance VI_gridftp {
    state MASTER
    interface <span style="background-color: #FFCCFF;">INTERFACE (e.g. eth0)</span>
    virtual_router_id <span style="background-color: #FFCCFF;">ARBITRARY ID, 0–255</span>
    priority 100
    virtual_ipaddress {
        <span style="background-color: #FFCCFF;">VIRTUAL IP ADDRESS</span>/<span style="background-color: #FFCCFF;">SUBNET MASK</span> dev <span style="background-color: #FFCCFF;">INTERFACE (e.g., eth0)</span>
    }
}

virtual_server <span style="background-color: #FFCCFF;">VIRTUAL IP ADDRESS</span> 2811 {
    delay_loop 10
    lb_algo wlc
    lb_kind DR
    protocol tcp

    real_server <span style="background-color: #FFCCFF;">GRIDFTP SERVER #1 IP ADDRESS</span> 2811 {
        TCP_CHECK {
            connect_timeout 3
        }
    }
    real_server <span style="background-color: #FFCCFF;">GRIDFTP SERVER #2 IP ADDRESS</span> 2811 {
        TCP_CHECK {
            connect_timeout 3
        }
    }
    <span style="background-color: #FFCCFF;">[&hellip;]</span>
}</pre>

%NOTE% Use the same =VIRTUAL IP ADDRESS= throughout your LVS configuration.

%NOTE% In the =virtual_server= section, write one =real_server= subsection per !GridFTP server behind the load balancer.

#OptionalConfig
---+++ Optional Configuration

The following configuration steps are optional and will likely not be required for setting up a small cluster of !GridFTP hosts. If you do not need any of the following special configurations, skip to [[#ConfigureReal][the section on configuring your real servers]].

   * [[#BackupLoadBalancers][Adding backup load balancers]]
   * [[#EmailNotifications][Enabling e-mail notifications]]

#BackupLoadBalancers
---++++ Adding backup load balancers

If you need to add backup load balancers, copy =/etc/keepalived/keepalived.conf= from your primary load balancer and change the =state= and priority attributes under your =vrrp_instance VI_gridftp= section:

%NOTE% Priority specifies the order of preferred load balancer fall back where larger values corresponds to a higher preference.

<pre class="file">vrrp_instance VI_gridftp {
    state BACKUP
    interface <span style="background-color: #FFCCFF;">INTERFACE (e.g. eth0)</span>
    virtual_router_id <span style="background-color: #FFCCFF;">SAME ID AS MASTER LOAD BALANCER</span>
    priority <span style="background-color: #FFCCFF;">PRIORITY INTEGER</span>
    virtual_ipaddress {
        <span style="background-color: #FFCCFF;">VIRTUAL IP ADDRESS</span>/<span style="background-color: #FFCCFF;">SUBNET MASK</span> dev <span style="background-color: #FFCCFF;">INTERFACE (e.g., eth0)</span>
    }
}
</pre>

#EmailNotifications
---++++ Enabling e-mail notifications

To receive e-mails when the state of your LVS cluster changes, update the =global_defs= section of =/etc/keepalived/keepalived.conf= for each of your load balancer nodes:

<pre class="file">
notification_email {
<span style="background-color: #FFCCFF;">NOTIFY EMAIL ADDRESS #1</span>
<span style="background-color: #FFCCFF;">NOTIFY EMAIL ADDRESS #2</span>
<span style="background-color: #FFCCFF;">...</span>
}
notification_email_from <span style="background-color: #FFCCFF;">FROM EMAIL ADDRESS</span>
smtp_server <span style="background-color: #FFCCFF;">SMTP SERVER IP ADDRESS</span>
smtp_connect_timeout 60
router_id <span style="background-color: #FFCCFF;">STRING IDENTIFYING MACHINE</span>
</pre>

#ConfigureReal
---++ Configuring Your Real Servers

Each real server requires changes to its IP configuration and potentially its arptables: 

   * [[#AddingVIP][Adding your virtual IP address]]
   * [[#DisableArp][Disabling ARP]] &minus; if your real servers are on the same network segment as the virtual IP

#AddingVIP
---+++ Adding your virtual IP address

Use the same virtual IP address as your load balancers as the secondary IP on your real servers. Add it using the =ip= tool:

<pre class="rootscreen">%UCL_PROMPT_ROOT% ip addr add <span style="background-color: #D1CAF2;">VIRTUAL IP ADDRESS</span>/<span style="background-color: #D1CAF2;">SUBNET MASK</span> dev <span style="background-color: #D1CAF2;">INTERFACE (e.g. eth0)</span></pre>

TODO: How to persist across reboots?

#DisableArp
---+++ Disabling ARP

If your real servers are only listening on the same network as your virtual IP address, skip to [[#UsingKeepalived][the section on using keepalived]]. If your real servers and load balancer(s) are on the same network segment, you will have to disable ARP on the real servers to avoid [[http://kb.linuxvirtualserver.org/wiki/ARP_Issues_in_LVS/DR_and_LVS/TUN_Clusters][ARP race conditions]]:

<ol>
  <li>
    <p>Select the appropriate RPM:</p>
%TABLE{sort="off"}%
| *If your operating system version is…* | *Then use the following package(s)…* |
| Enterprise Linux 6 | =arptables_jf= |
| Enterprise Linux 7 | =arptables= |    
  </li>
  <li>
    <p>Install the arptables software:</p>
    <pre class="rootscreen">%UCL_PROMPT_ROOT% yum install arptables_jf</pre>
  </li>
  <li>
    <p>Disable ARP:</p>
    <pre class="rootscreen">%UCL_PROMPT_ROOT% arptables -F
%UCL_PROMPT_ROOT% arptables -A IN -d <span style="background-color: #D1CAF2;">VIRTUAL IP ADDRESS</span> -j DROP
%UCL_PROMPT_ROOT% arptables -A OUT -s <span style="background-color: #D1CAF2;">VIRTUAL IP ADDRESS</span> -j mangle --mangle-ip-s <span style="background-color: #D1CAF2;">REAL IP ADDRESS</span></pre>  </li>
  </li>
  <li>
    <p>Save ARP tables to survive reboots:</p>
    <pre class="rootscreen">%UCL_PROMPT_ROOT% arptables-save > /etc/sysconfig/arptables</pre>    
  </li>
</ol>

#UsingKeepalived
---++ Using Keepalived

---+++ Managing the keepalived service

%TABLE{sort="off"}%

On the load balancer nodes, =keepalived= is the only additional service required for running an LVS. As a reminder, here are common service commands (all run as =root=):

%TABLE{sort="off"}%
| *To &hellip;* | *On EL&nbsp;6, run the command&hellip;* | *On EL&nbsp;7, run the command&hellip;* |
| Start a service | =service keepalived start= | =systemctl start keepalived= |
| Stop a service | =service keepalived stop= | =systemctl start keepalived= |
| Enable a service to start during boot | =chkconfig keepalived on= | =systemctl enable keepalived= |
| Disable a service from starting during boot | =chkconfig keepalived off= | =systemctl disable keepalived= |

---++ Getting Help

To get assistance with =keepalived= in front of OSG Software services, please use the [[Documentation.HelpProcedure][this page]].

#ReferenceSection
---++ Reference

   * [[http://www.linuxvirtualserver.org/whatis.html][Linux Virtual Server homepage]]
   * [[http://www.keepalived.org/index.html][Keepalived homepage]]
   * [[https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Load_Balancer_Administration/index.html][RHEL 7 Load Balancer Administration Guide]]
   * [[https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Load_Balancer_Administration/index.html][RHEL 6 Load Balancer Administration Guide]]
   * [[https://github.com/gattebury/gridftp-with-lvs][T2 Nebraska LVS installation notes]]
