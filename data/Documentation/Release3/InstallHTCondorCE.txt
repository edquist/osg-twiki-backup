%META:TOPICINFO{author="MarcoMambelli" date="1363643293" format="1.1" version="1.12"}%
%META:TOPICPARENT{name="Blueprint.WebHome"}%
---+ About this Document

The HTCondor-CE software aims to provide an end-to-end gatekeeper technology built entirely out of core HTCondor components.  As a goal, we aim for the HTCondor-CE to be a particular "configuration" of HTCondor, and not include any non-HTCondor daemons.

The HTCondor-CE approach is under active investigation; this page provides *developer documentation* for installing and configuration the CE.

---+ Requirements and Preparation

---++ Host and OS
   * A host to install the Compute Element
   * An Redhat Enterprise Linux version 5 or 6 host (compatible systems such as !CentOS or !ScientificLinux are fine).
   * Root access

---++ Users
The following user is needed by HTCondor-CE at all sites
   * =condor=: The HTCondor-CE will be run as root, but perform most of its operations as the =condor= user.

The above user will be added to the system automatically when the HTCondor RPM installs.  If your fabric management automatically overwrites users and groups, you will want to create this user beforehand.

All sites running PBS, LSF, SGE, SLURM will need any grid user's home directories mounted on the HTCondor-CE and any worker nodes.

---++ Certificates
| *Certificate* | *User that owns certificate* | *Path to certificate* |
| Host certificate | =root= | =/etc/grid-security/hostcert.pem= <br> =/etc/grid-security/hostkey.pem= |

[[Documentation/Release3.GetHostServiceCertificates][Here]] are instructions to request a host certificate.

---++ Networking

As of HTCondor-CE version 0.5.4, two incoming TCP ports are required:
   * 9619: A HTCondor collector runs on this port; this allows the various HTCondor daemons to be located.
   * 9620: The HTCondor condor_shared_port. This daemon allows all the HTCondor daemons to share a single port.

Only ephemeral outgoing ports are necessary.

---++ Software Repositories
You need to have the [[https://twiki.grid.iu.edu/bin/view/Documentation/Release3/InstallComputeElement#Install_the_Yum_Repositories_req][OSG release repository]] installed and enabled on this host.

---++ HTCondor Versions
One goal of the HTCondor-CE is to use the site's condor_* binaries, but run a completely different set of daemons (similar to OSG's condor-cron for RSV).

Unfortunately, during the development phase, you'll need the latest-greatest version of HTCondor due to a few prerequisite patches.  Install HTCondor 7.9.2 or later.

---+ Installation

First, install certificates and authorization:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% yum install osg-ca-certs fetch-crl lcmaps lcas-lcmaps-gt4-interface
</pre>

Do one of the following, depending on your batch system:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% yum install condor-ce-condor gratia-probe-condor
%UCL_PROMPT_ROOT% yum install condor-ce-pbs gratia-probe-pbs-lsf
</pre>

(Note - in the future, we will use meta-RPMs to put this all into one step)

---+ Configure the CE

---++ Setup authorization
If you are using GUMS, you need to configure =/etc/lcmaps.db=, as you would a [[Documentation.Release3.InstallComputeElement][GRAM-based OSG-CE]].  Remember to uncomment the line in =/etc/grid-security/gsi-authz.conf=.

If you are not using GUMS, you will need to add the appropriate lines to =/etc/condor-ce/condor_mapfile=.

%NOTE% Once gsi-authz.conf is in place, your site's HTCondor will attempt to utilize the LCMAPS callouts if enabled in the condor_mapfile.  If this is not the desired behavior, set GSI_AUTHZ_CONF=/dev/null in the HTCondor configuration.

---++ Setup Job Routes

%NOTE% This section covers just the basic customizations; a site needing more elaborate configurations should refer to [[HTCondorCERoutes][this page]].

The HTCondor-CE depends on the [[http://research.cs.wisc.edu/htcondor/manual/v7.8/5_6HTCondor_Job.html][HTCondor JobRouter]] to transform an incoming grid job into a batch system job.  This is controlled by a job _route_; default routes are installed in =/etc/condor-ce/config.d/02-ce-*.conf=.  Each route corresponds to a separate job transformation.

The built-in routes contain only the minimal base functionality needed for starting jobs at a small site.  A larger site may [[HTCondorCERoutes][want to refer to this document]] for hints on how to better customize their site.

Place customizations in =/etc/condor-ce/config.d/99-local.conf= (or a similarly named file which overrides 02-*; files in the directory are evaluated in alphabetical order), not the original =02-ce-*.conf=.

For HTCondor sites, =02-ce-condor.conf= assumes that the SPOOL location for the site schedd is in the "normal" location of /var/lib/condor/spool, and the schedd's name is =$(FULL_HOSTNAME)=.  You must customize these if you run a non-RPM version of HTCondor.

---++ Other Site Customization

The Unix environment variables for the HTCondor-CE daemons is controlled by =/etc/sysconfig/condor-ce=.

You can place site HTCondor-CE configuration customizations in =/etc/condor-ce/config.d=; do not edit files installed by the HTCondor-CE, as edits will be lost on upgrade.  Instead, use site customization files to override default settings.

---++ Home Directories

If your site uses the HTCondor batch system, no home directories are necessary.  All data movement is handled via HTCondor file transfer.

For all other batch systems, home directories for all grid users must exist and be exported to the worker nodes.

---+ Smoke Testing

---++ Included test utilities

You can use the =condor_ce_run= utility to send test jobs to a remote HTCondor-CE.  For example, to run the =env= binary in the remote batch system, you can do:

<pre>
condor_ce_run -r %RED%condorce.example.com:9619%ENDCOLOR% env
</pre>

With the =-r= flag, HTCondor will submit directly to the remote schedd.  Without the flag, it will submit to the local schedd using the grid universe.

---++ Test by hand

From a test submit host, use this file to submit to the CE:
<pre>
universe = grid
grid_resource = condor %RED%condorce.example.com condorce.example.com:9619%ENDCOLOR%

executable = test.sh
output = test_g.out
error = test_g.err
log = test_g.log

ShouldTransferFiles = YES
WhenToTransferOutput = ON_EXIT

x509userproxy = %RED%/tmp/x509up_uXXXX%ENDCOLOR%

queue
</pre>

Replace =condorce.example.com= with the hostname of the Condor-CE.  Replace uXXXX with your submitting user's id (the output of =id -u=).

---+ Operations

---++ Starting and Stopping Services

The following services need to be enabled with =chkconfig= and started with =service=:
   * =condor-ce=: This is the set of Condor daemons which implement the Condor-CE.
   * Batch system: You need to have your batch system started for the Condor-CE to interact with it; batch system operation does not change, even for Condor sites.
   * =fetch-crl=: This maintains the validity of the CRL files in =/etc/grid-security/certificates=.
   * =gratia-probe-cron=: This service enables or disables a cron job, which uploads accounting information to the OSG.

---++ Log Files

   * =/var/log/condor/*=: HTCondor daemon files.
   * =/var/log/condor/user/*=, =/var/log/condor/Gridmanager.*=: Per-user log files recording individual submissions and interactions with the batch system.
   * =/var/log/messages=: LCMAPS sends authentication and authorization information into syslog; check this if you are having authz difficulties.

---++ Known Issues

   * (PBS Sites; blahp < 1.18.3.bosco) The blahp requires you to use old-style proxies; the newest =voms-proxy-init= will generate new-style proxies by default.  In HTCondor-CE 0.4 and prior, you need to hand-install /usr/bin/grid-proxy-info via yum.
      * You have hit this issue if the job goes on hold with the error "Attempts to submit failed" and you have the line =blah_job_submit() failed: Unable to limit the proxy= in =/var/log/condor-ce/GridmanagerLog.%RED%$USER%ENDCOLOR%= on the Condor-CE host.
   * (Client authorization; condor < 7.9.2) You need to add <pre>GSI_DAEMON_NAME=/DC=org/DC=doegrids/OU=Services/CN=%RED%condor-ce.example.com%ENDCOLOR%
CERTIFICATE_MAPFILE = /etc/condor/condor_mapfile
</pre> to the Condor configuration on the submit host (update the condor-ce.example.com line appropriately).  You also need to have a line like <pre>GSI "\/DC\=org\/DC\=doegrids\/OU\=Services\/CN\=%RED%condor-ce.example.com%ENDCOLOR%" %RED%condor-ce%ENDCOLOR%@ce.opensciencegrid.org</pre> in =/etc/condor/condor_mapfile=.
   * (!DigiCert CA hostcert, htcondor-ce < 0.5.4) or (non-OSG CA for hostcert or service certificate).  The hostcert for the HTCondor-CE service needs to be recognized by HTCondor's mapfile system.  If your host certificate is actually a service certificate, or from a non-OSG CA, you will need to add this to the =/etc/condor-ce/condor_mapfile=.  For versions prior to 0.5.4, you need the following for a !DigiCert-issued hostcert: <pre>GSI "^\/DC\=com\/DC\=DigiCert-Grid\/O=Open Science Grid\/OU\=Services\/CN\=(host\/)?([A-Za-z0-9.\-]*)$" \2@daemon.opensciencegrid.org</pre>

%META:TOPICMOVED{by="BrianBockelman" date="1355365789" from="Blueprint.CondorCE" to="Documentation.InstallHTCondorCE"}%
