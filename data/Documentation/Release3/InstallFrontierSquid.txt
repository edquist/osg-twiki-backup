%META:TOPICINFO{author="DaveDykstra" date="1383229876" format="1.1" version="1.16"}%
%DOC_STATUS_TABLE%

---+!! Frontier Squid Caching Proxy Installation Guide

%TOC{depth="3"}%

---# About This Document

This document is intended for System Administrators who are installing =frontier-squid=, the OSG distribution of the Frontier Squid software.

%INCLUDE{"Documentation/DocumentationTeam/DocConventions" section="Header"}%
%INCLUDE{"Documentation/DocumentationTeam/DocConventions" section="CommandLine"}%

---# Applicable Versions

The applicable software versions for this document are %RED%OSG Version >= 3.1.14 %ENDCOLOR%.  The version of frontier-squid installed should be %RED% >= 2.7.STABLE9-13.5.osg %ENDCOLOR%.

---# About Frontier Squid

Frontier Squid is a distribution of the well-known [[http://squid-cache.org][squid HTTP caching proxy software]] that is optimized for use with applications on the Worldwide LHC Computing Grid (WLCG).  Its most important feature is that it correctly supports the HTTP standard headers Last-Modified and If-Modified-Since better than other distributions of squid. The [[http://frontier.cern.ch][Frontier distributed database caching system]], which is used by the LHC projects ATLAS and CMS, depends on proper working of this feature, so that is the main reason why that project maintains its own squid distribution. Older versions of squid2 (including the one distributed with Red Hat EL 5) and all versions of squid3 (including the one on Red Hat EL 6) do not correctly support this feature, as documented in the infamous [[http://bugs.squid-cache.org/show_bug.cgi?id=7][squid bug #7]]. Also, the frontier-squid package contains a couple of related patches that are not in any standard squid distribution. Details are in the beginning paragraph of the [[http://twiki.cern.ch/twiki/bin/view/Frontier/MyOwnSquid][MyOwnSquid twiki page]]. Although the package expressly supports If-Modified-Since, it also works well with applications that do not require If-Modified-Since including CVMFS.

In addition, the package has several additional features:
   1. A configuration file generator, so configuration customizations can be preserved across package upgrades even when the complicated standard configuration file changes.
   1. The ability to easily run multiple squid processes listening on the same port, in order to support more networking throughput than can be handled by a single CPU core (squid2 is single-threaded).
   1. Automatic cleanup of the old cache files in the background when starting squid, to avoid problems with cache corruption.
   1. Default access control lists to permit remote performance monitoring from shared WLCG squid monitoring servers at CERN.
   1. The default log format is more human readable and includes contents of client-identifying headers.
   1. It chooses default options found to be important by years of operational experience on the WLCG.

The OSG distribution of frontier-squid is a straight rebuild of the upstream frontier-squid package for the convenience of OSG users.

---# Frontier Squid Is Recommended

The OSG recommends that all sites run a caching proxy for HTTP and HTTPS to help reduce bandwidth and improve throughput. Starting in OSG 3.1.24 (released 24 September 2013), all CE installations *include* Frontier Squid. We encourage all sites to configure and use this service, as described below.

Also starting in OSG 3.1.24, the =osg-configure= configuration tool (version 1.0.45 or later) warns users who have not added the proxy location to their CE configuration. For now, this is merely a warning, but in the future the warning will be changed to an error, so that all site administrators set up and use a caching proxy.

---# Engineering Considerations

If you will be supporting the Frontier application at your site, review the [[http://twiki.cern.ch/twiki/bin/view/Frontier/InstallSquid#Hardware][upstream documentation Hardware considerations section]] to determine how to size your equipment.

---# Requirements

---## Host and OS
   * OS is %SUPPORTED_OS%. 
   * Root access

---## Users
The frontier-squid installation will create one user account unless it already exists.

| *User* | *Comment* |
| =squid= | Reduced privilege user that the squid process runs under.  Set the default gid of the "squid" user to be a group that is also called "squid". |

The package can instead use another user name of your choice if you create a configuration file before installation.  Details are in the [[http://twiki.cern.ch/twiki/bin/view/Frontier/InstallSquid#Preparation][upstream documentation Preparation section]].

---## Networking

%STARTSECTION{"Firewalls"}%
%INCLUDE{"Documentation/Release3.FirewallInformation" section="FirewallTable" lines="squid,squidmonitor"}% \
%ENDSECTION{"Firewalls"}%

The addresses of the WLCG monitoring servers for use in firewalls are listed in the [[http://twiki.cern.ch/twiki/bin/view/Frontier/InstallSquid#Enabling_monitoring][upstream documentation Enabling monitoring section]].

---# Install Instructions
%INCLUDE{"YumRepositories" section="OSGRepoBrief" TOC_SHIFT="+"}%

---## Install frontier-squid

After meeting the requirements in the previous section, install frontier-squid with this command: <pre class="rootscreen">
%UCL_PROMPT_ROOT% yum install frontier-squid </pre>

Then enable it to start at boot time with this command: <pre class="rootscreen">
%UCL_PROMPT_ROOT% chkconfig frontier-squid on</pre>

---# Configuring frontier-squid

To configure frontier-squid consult the [[http://twiki.cern.ch/twiki/bin/view/Frontier/InstallSquid#Configuration][upstream documentation Configuration section]] because it is exactly the same as the OSG distribution.  Note particularly the difference between ordinary squid in that configuration changes have to be made in =/etc/squid/customize.sh= and not in =/etc/squid/squid.conf=.

---# Starting and stopping services

%STARTSECTION{"Starting"}%
Starting frontier-squid:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% service frontier-squid start
</pre> 

Stopping frontier-squid:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% service frontier-squid stop
</pre> 

%ENDSECTION{"Starting"}%


---# Testing the installation of frontier-squid

As any user on another computer, do the following (where %RED%yoursquid.your.domain%ENDCOLOR% is the fully qualified domain name of your squid server):
<pre class="screen">
%UCL_PROMPT% export http_proxy=http://%RED%yoursquid.your.domain%ENDCOLOR%:3128
%UCL_PROMPT% wget -qdO/dev/null http://frontier.cern.ch 2>&1|grep X-Cache
X-Cache: MISS from %RED%yoursquid.your.domain%ENDCOLOR%
%UCL_PROMPT% wget -qdO/dev/null http://frontier.cern.ch 2>&1|grep X-Cache
X-Cache: HIT from %RED%yoursquid.your.domain%ENDCOLOR%
</pre>

If the grep doesn't print anything, try removing it from the pipeline to see if errors are obvious.  If the second try says MISS again, something is probably wrong with the squid cache writes.

If your squid will be supporting the Frontier application, it is also good to do the test in the [[http://twiki.cern.ch/twiki/bin/view/Frontier/InstallSquid#Testing_the_installation][upstream documentation Testing the installation section]].

---# Frontier-squid log files

Log file contents are explained in the [[http://twiki.cern.ch/twiki/bin/view/Frontier/InstallSquid#Log_file_contents][upstream documentation Log file contents section]].

%BR%

---# How to get Help?
To get assistance please use [[HelpProcedure][Help Procedure]].

---# *Comments*
%COMMENT{type="tableappend"}%


<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
   DEAR DOCUMENT OWNER
   ===================

   Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER          = DaveDykstra

   Please define the document area, choose one of the defined areas from the next line
   DOC_AREA = (ComputeElement|General|Integration|Monitoring|Operations|Security|Storage|Tier3|User|VO)
   * Local DOC_AREA       = General

   define the primary role the document serves, choose one of the defined roles from the next line
   DOC_ROLE = (Developer|Documenter|Scientist|Student|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

   Please define the document type, choose one of the defined types from the next line
   DOC_TYPE = (HowTo|Installation|Knowledge|Navigation|Planning|Training|Troubleshooting)
   * Local DOC_TYPE       = Installation
   
   Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

   Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

   change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %YES%

   change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %YES%

   change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %YES%


   DEAR DOCUMENT REVIEWER
   ======================

   Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = MarcoMambelli
  
   Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %YES%


   DEAR DOCUMENT TESTER
   ====================

   Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = MarkoSlyz
  
   Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %YES%
############################################################################################################
-->
