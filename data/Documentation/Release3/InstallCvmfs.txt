%META:TOPICINFO{author="DouglasStrain" date="1338931904" format="1.1" reprev="1.1" version="1.1"}%
%LINKCSS%
---+!! %SPACEOUT{ "Install cvmfs" }%
%DOC_STATUS_TABLE%
%TOC{depth="3"}%

---+ About this Document

Here we describe how to install the cvmfs (Cern-VM file system client).
This document is intended for system administrators who wish to install 
this client to have HTTP storage access.

---+ Requirements

---++ Host and OS

   * OS is %SUPPORTED_OS%. 
   * Root access
   * automount should be installed
   * fuse should be installed (or will be as part of the installation)

---++ Users

This installation will create one user:

%STARTSECTION{"Users"}%
| *User* | *Comment* |
| =cvmfs= | !CernVM-FS service account |
%ENDSECTION{"Users"}%

---++ Networking

You will need out-bound access to the cvmfs HTTP server.  
You may also want to consider creating a local squid server.

---+ Install Instructions

%INCLUDE{"YumRepositories" section="OSGRepoBrief" headingoffset="1"}%

---++ Installing cvmfs

The following will install cvmfs from the OSG repository.  It will also install cern public keys as well as fuse if you do not have it.
<pre class="rootscreen">
yum install cvmfs
</pre>

---++ Setup of fuse and automount

Add the following to =/etc/fuse.conf= in order to allow fuse to do proper file ownership:
<pre class=file>
user_allow_other
</pre>

Add the following to =/etc/auto.master= to allow cvmfs to automount:

<pre class=file>
/cvmfs /etc/auto.cvmfs
</pre>

---++ Setup of cvmfs

Edit =/etc/cvmfs/default.local= to enter in your cvmfs settings:

<pre class="file">
CVMFS_REPOSITORIES=%RED%atlas.cern.ch,atlas-condb.cern.ch,lhcb.cern.ch,cms.cern.ch.conf%ENDCOLOR%
CVMFS_CACHE_BASE=/var/scratch/cvmfs
CVMFS_QUOTA_LIMIT=%RED%10000%ENDCOLOR%
CVMFS_HTTP_PROXY=%RED%"http://cmsfrontier1.fnal.gov:3128;http://cmsfrontier2.fnal.gov:3128;http://cmsfrontier3.fnal.gov:3128;http://cmsfrontier4.fnal.gov:3128"%ENDCOLOR%
</pre>

Set up your repositories in CVMFS_REPOSITORIES.  A full list of repositories is found here http://cernvm.cern.ch/portal/cvmfs/examples.

Set up a list of cvmfs HTTP proxies to retrieve from in CVMFS_HTTP_PROXY.  You can get the closest HTTP proxy from the following script:
http://cernvm.cern.ch/config/proxy.cgi.

Set up the cache limit in CVMFS_QUOTA_LIMIT (in MB).  Recommended for most application is 10-20GB.

Once all your settings are complete, run =service cvmfs restartautofs= for all settings to take effect.

---+ Verification of cvmfs

If cvmfs is working, you should be able to browse =/cvmfs/REPOSITORY= for each 
repository that you have configured, for instance =/cvmfs/atlas.cern.ch=.

The command =service cvmfs probe= will verify that all of your mount points are working correctly.

---++ Troubleshooting problems

If no directories exist under =/cvmfs/=, you can try the following steps to debug:

   * Mount it manually =mkdir /mnt/ cvmfs= then =mount &#8722;t cvmfs REPOSITORYNAME /mnt/cvmfs=.  If this works, then cvmfs is working, but there is a problem with automount.
   * If that doesn't work and doesn't give any explanatory errors, try =cvmfs_config chksetup= or =cvmfs_configshowconfig REPOSITORYNAME= to verify your setup

---+ Starting and Stopping services

cvmfs can be started via:
<pre class="rootscreen">
$ service cvmfs start
Starting CernVM-FS:                         %GREEN%[  OK  ]%ENDCOLOR%
</pre>

cvmfs can be stopped via:
<pre class="rootscreen">
$ service cvmfs stop
Shutting down CernVM-FS:                         %GREEN% [  OK  ]%ENDCOLOR%
</pre>

*IMPORTANT NOTE*: If you have made changes to automount settings, you restart autofs as well:
<pre class="rootscreen">
$ service cvmfs restartautofs
Shutting down CernVM-FS:                         %GREEN% [  OK  ]%ENDCOLOR%
Stopping automount:                       %GREEN%[  OK  ]%ENDCOLOR%
Starting automount:                       %GREEN%[  OK  ]%ENDCOLOR%
Starting CernVM-FS:                         %GREEN%[  OK  ]%ENDCOLOR%
</pre>

---+ Screendump of Install


%TWISTY{
mode="div"
showlink="Click here for a full installation example."
hidelink="Hide the example"
showimgleft="%ICONURLPATH{toggleopen-small}%"
hideimgleft="%ICONURLPATH{toggleclose-small}%"
}%
<pre class="screen">
[root@fermicloud051 ~]# rpm -Uvh http://dl.fedoraproject.org/pub/epel/5/i386/epel-release-5-4.noarch.rpm
Retrieving http://dl.fedoraproject.org/pub/epel/5/i386/epel-release-5-4.noarch.rpm
warning: /var/tmp/rpm-xfer.i8hvMo: Header V3 DSA signature: NOKEY, key ID 217521f6
Preparing...                ########################################### [100%]
   1:epel-release           ########################################### [100%]
[root@fermicloud051 ~]# yum -y install yum-priorities
Loaded plugins: kernel-module
epel                                                     | 3.4 kB     00:00
epel/primary_db                                          | 3.7 MB     00:01
Excluding Packages from SLF 5 base
Finished
Reducing SLF 5 base jdk to included packages only
Finished
Excluding Packages from SLF 5 security updates
Finished
Reducing SLF 5 security updates jdk only to included packages only
Finished
Excluding Packages from SL 5 base
Finished
Reducing SL 5 base jdk to included packages only
Finished
Setting up Install Process
Resolving Dependencies
--> Running transaction check
---> Package yum-priorities.noarch 0:1.1.16-16.el5 set to be updated
--> Finished Dependency Resolution
Beginning Kernel Module Plugin
Finished Kernel Module Plugin

Dependencies Resolved

================================================================================
 Package               Arch          Version               Repository      Size
================================================================================
Installing:
 yum-priorities        noarch        1.1.16-16.el5         sl-base         14 k

Transaction Summary
================================================================================
Install       1 Package(s)
Upgrade       0 Package(s)

Total download size: 14 k
Downloading Packages:
yum-priorities-1.1.16-16.el5.noarch.rpm                  |  14 kB     00:00
Running rpm_check_debug
Running Transaction Test
Finished Transaction Test
Transaction Test Succeeded
Running Transaction
  Installing     : yum-priorities                                           1/1

Installed:
  yum-priorities.noarch 0:1.1.16-16.el5

Complete!
[root@fermicloud051 ~]# rpm -Uvh http://repo.grid.iu.edu/osg-release-latest.rpm
Retrieving http://repo.grid.iu.edu/osg-release-latest.rpm
warning: /var/tmp/rpm-xfer.PUMQzE: Header V3 DSA signature: NOKEY, key ID 824b8603
Preparing...                ########################################### [100%]
   1:osg-release            ########################################### [100%]
[root@fermicloud051 ~]# rpm -Uvh http://repo.grid.iu.edu/osg-release-latest.rpm
Retrieving http://repo.grid.iu.edu/osg-release-latest.rpm
warning: /var/tmp/rpm-xfer.PUMQzE: Header V3 DSA signature: NOKEY, key ID 824b8603
Preparing...                ########################################### [100%]
   1:osg-release            ########################################### [100%]
[root@fermicloud051 ~]# yum install --enablerepo=osg-development cvmfs
Loaded plugins: kernel-module, priorities
osg                                                      | 1.9 kB     00:00
osg/primary_db                                           | 1.1 MB     00:00
osg-development                                          | 1.9 kB     00:00
osg-development/primary_db                               | 362 kB     00:00
Excluding Packages from SLF 5 base
Finished
Reducing SLF 5 base jdk to included packages only
Finished
Excluding Packages from SLF 5 security updates
Finished
Reducing SLF 5 security updates jdk only to included packages only
Finished
Excluding Packages from SL 5 base
Finished
Reducing SL 5 base jdk to included packages only
Finished
1066 packages excluded due to repository priority protections
Setting up Install Process
Resolving Dependencies
--> Running transaction check
---> Package cvmfs.x86_64 0:2.0.13-1.osg.el5 set to be updated
--> Processing Dependency: cvmfs-keys >= 1.2 for package: cvmfs
--> Processing Dependency: fuse for package: cvmfs
--> Running transaction check
---> Package cvmfs-keys.noarch 0:1.4-1.osg.el5 set to be updated
---> Package fuse.x86_64 0:2.7.4-8.el5 set to be updated
--> Finished Dependency Resolution
Beginning Kernel Module Plugin
Finished Kernel Module Plugin

Dependencies Resolved

================================================================================
 Package         Arch        Version                 Repository            Size
================================================================================
Installing:
 cvmfs           x86_64      2.0.13-1.osg.el5        osg-development      1.3 M
Installing for dependencies:
 cvmfs-keys      noarch      1.4-1.osg.el5           osg-development      3.7 k
 fuse            x86_64      2.7.4-8.el5             sl-base               83 k

Transaction Summary
================================================================================
Install       3 Package(s)
Upgrade       0 Package(s)

Total download size: 1.4 M
Is this ok [y/N]: y
]Downloading Packages:
(1/3): cvmfs-keys-1.4-1.osg.el5.noarch.rpm               | 3.7 kB     00:00
(2/3): fuse-2.7.4-8.el5.x86_64.rpm                       |  83 kB     00:00
(3/3): cvmfs-2.0.13-1.osg.el5.x86_64.rpm                 | 1.3 MB     00:00
--------------------------------------------------------------------------------
Total                                           5.4 MB/s | 1.4 MB     00:00
warning: rpmts_HdrFromFdno: Header V3 DSA signature: NOKEY, key ID 824b8603
osg-development/gpgkey                                   | 1.7 kB     00:00
Importing GPG key 0x824B8603 "OSG Software Team (RPM Signing Key for Koji Packages) <vdt-support@opensciencegrid.org>" from /etc/pki/rpm-gpg/RPM-GPG-KEY-OSG
Is this ok [y/N]: y
Is this ok [y/N]: y
Running rpm_check_debug
Running Transaction Test
Finished Transaction Test
Transaction Test Succeeded
Running Transaction
  Installing     : fuse                                                     1/3
  Installing     : cvmfs-keys                                               2/3
  Installing     : cvmfs                                                    3/3

Installed:
  cvmfs.x86_64 0:2.0.13-1.osg.el5

Dependency Installed:
  cvmfs-keys.noarch 0:1.4-1.osg.el5          fuse.x86_64 0:2.7.4-8.el5

Complete!
[root@fermicloud051 ~]# echo "user_allow_other" >> /etc/fuse.conf
[root@fermicloud051 ~]# echo "/cvmfs /etc/auto.cvmfs" >> /etc/auto.master
[root@fermicloud051 ~]# echo "CVMFS_REPOSITORIES=atlas.cern.ch,atlas-condb.cern.ch,lhcb.cern.ch,cms.cern.ch.conf" >> /etc/cvmfs/default.local
[root@fermicloud051 ~]# echo "CVMFS_CACHE_BASE=/var/scratch/cvmfs" >> /etc/cvmfs/default.local
[root@fermicloud051 ~]# echo "CVMFS_QUOTA_LIMIT=1000" >> /etc/cvmfs/default.local
[root@fermicloud051 ~]# echo "CVMFS_HTTP_PROXY=\"http://cmsfrontier1.fnal.gov:3128;http://cmsfrontier2.fnal.gov:3128;http://cmsfrontier3.fnal.gov:3128\"" >> /etc/cvmfs/default.local
[root@fermicloud051 ~]# cat /etc/cvmfs/default.local
CVMFS_REPOSITORIES=atlas.cern.ch,atlas-condb.cern.ch,lhcb.cern.ch
CVMFS_CACHE_BASE=/var/scratch/cvmfs
CVMFS_QUOTA_LIMIT=1000
CVMFS_HTTP_PROXY="http://cmsfrontier1.fnal.gov:3128;http://cmsfrontier2.fnal.gov:3128;http://cmsfrontier3.fnal.gov:3128"
[root@fermicloud051 ~]# service cvmfs restartautofs
Shutting down CernVM-FS:                                   [  OK  ]
Stopping automount:                                        [  OK  ]
Starting automount:                                        [  OK  ]
Starting CernVM-FS:                                        [  OK  ]
[root@fermicloud051 ~]# service cvmfs probe
Probing /cvmfs/atlas.cern.ch                               [  OK  ]
Probing /cvmfs/atlas-condb.cern.ch                         [  OK  ]
Probing /cvmfs/lhcb.cern.ch                                [  OK  ]
[root@fermicloud051 ~]# ls /cvmfs/atlas.cern.ch/
repo
[root@fermicloud051 ~]# ls /cvmfs/atlas.cern.ch/repo/sw
agis       AtlasSiteConfig.sh       cctools    database  Generators  local      pacman-3.29  python    tags
atlas-gcc  AtlasSiteConfig.sh.orig  ChangeLog  ddm       JEM-WN      nightlies  PandaPilot   software
</pre>
%ENDTWISTY% 

---+ File Locations


%STARTSECTION{"Locations"}%

| *Service/Process* | *Configuration File* | *Description* |
|cvmfs|/etc/cvmfs/default.local|cvmfs environment settings and repository setup|
|fuse|/etc/fuse.conf|fuse settings|
|automount|/etc/auto.master|automount settings|



%ENDSECTION{"Locations"}%


---+ How to get Help?

If you cannot resolve the problem, there are several ways to receive help:

   * For CERN VM support contact cernvm.support@cern.ch.
   * For bug support and issues, submit a ticket to the [[https://ticket.grid.iu.edu/goc][Grid Operations Center]].
   * For community support and best-effort software team support contact osg-software@opensciencegrid.org.

For a full set of help options, see [[HelpProcedure][Help Procedure]].

---+ References

   * http://cernvm.cern.ch/portal/filesystem/techinformation
   * https://cernvm.cern.ch/project/trac/downloads/cernvm/cvmfstech-2.0-5.pdf

---+ Comments
%COMMENT{type="tableappend"}%



<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = DouglasStrain

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = Storage

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = Installation
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %NO%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %NO%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = NehaSharma
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %NO%


 DEAR DOCUMENT TESTER
 ====================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = NehaSharma
 Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %NO%
############################################################################################################
-->




-- Main.DouglasStrain - 01 Sep 2011
