%META:TOPICINFO{author="DaveDykstra" date="1366379979" format="1.1" version="1.12"}%
%LINKCSS%
---+!! %SPACEOUT{ "Install cvmfs" }%
%DOC_STATUS_TABLE%
%TOC{depth="3"}%

---# About this Document

Here we describe how to install the cvmfs (Cern-VM file system) client.
This document is intended for system administrators who wish to install 
this client to have HTTP storage access.

---# Requirements

---## Host and OS

   * OS is %SUPPORTED_OS%. 
   * Root access
   * automount should be installed
   * fuse should be installed (or will be as part of the installation)

---## Users

This installation will create one user:

%STARTSECTION{"Users"}%
| *User* | *Comment* |
| =cvmfs= | !CernVM-FS service account |
%ENDSECTION{"Users"}%

---## Networking

You will need out-bound access to the cvmfs HTTP server.  
You may also want to consider creating a local squid server.

---# Install Instructions

%INCLUDE{"YumRepositories" section="OSGRepoBrief" headingoffset="1"}%

---## Installing cvmfs

The following will install cvmfs from the OSG repository.  It will also install cern public keys as well as fuse and autofs if you do not have them.
<pre class="rootscreen">
yum install cvmfs
</pre>

---## Setup of fuse and automount

Create or edit =/etc/fuse.conf=. It should contain the following in order to allow fuse to do proper file ownership:
<pre class=file>
user_allow_other
</pre>

Create or edit =/etc/auto.master=. It should contain the following in order to allow cvmfs to automount:

<pre class=file>
/cvmfs /etc/auto.cvmfs
</pre>

---## Configuring cvmfs

Create or edit =/etc/cvmfs/default.local=, a file that controls the cvmfs configuration. Below is a sample configuration, *but please note* that you will need to edit the parts in red. In particular, the =CVMFS_HTTP_PROXY= line below only works within the .fnal.gov domain.

<pre class="file">
CVMFS_REPOSITORIES=%RED%atlas.cern.ch,atlas-condb.cern.ch,lhcb.cern.ch,cms.cern.ch%ENDCOLOR%
CVMFS_CACHE_BASE=%RED%/var/cache/cvmfs%ENDCOLOR%
CVMFS_QUOTA_LIMIT=%RED%10000%ENDCOLOR%
CVMFS_HTTP_PROXY=%RED%"http://cmsfrontier1.fnal.gov:3128|http://cmsfrontier2.fnal.gov:3128|http://cmsfrontier3.fnal.gov:3128|http://cmsfrontier4.fnal.gov:3128"%ENDCOLOR%
</pre>

Set up your repositories in CVMFS_REPOSITORIES.  A full list of repositories is found here http://cernvm.cern.ch/portal/cvmfs/examples.

Set up a list of cvmfs HTTP proxies to retrieve from in CVMFS_HTTP_PROXY.   Vertical bars separating proxies means to load balance between them and try them all before continuing.
A semicolon between proxies means to try that one only after the previous ones have failed.  A special proxy called DIRECT can be placed last
in the list to indicate directly connecting to servers if all other proxies fail.  This is acceptable for small sites but discouraged for large sites because
of the potential load that could be put upon the stratum one servers.

Set up the cache limit in CVMFS_QUOTA_LIMIT (in MB).  Recommended for most applications is 10-20GB.  This is the limit for each repository used, not the combined limit.
This cache will be stored in CVMFS_CACHE_BASE.

Create =/etc/cvmfs/domain.d/cern.ch.local= and set CVMFS_SERVER_URL to read from closest stratum one servers first.   The available servers are in the same document as the repositories, http://cernvm.cern.ch/portal/cvmfs/examples.  For example, if you are closest to Fermilab use:

<pre class="file">
CVMFS_SERVER_URL="http://cvmfs.fnal.gov:8000/opt/@org@;http://cvmfs.racf.bnl.gov:8000/opt/@org@;http://cvmfs-stratum-one.cern.ch:8000/opt/@org@;http://cernvmfs.gridpp.rl.ac.uk:8000/opt/@org@"
</pre>


---## Starting up cvmfs

Once all your settings are complete, run the following command:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% service cvmfs restartautofs 
</pre>
for all settings to take effect.

---# Verifying cvmfs

Once you start up cvfms, you should be able to see the =/cvmfs= directory. But note that it will initially appear to be empty:

<pre class="screen">
%UCL_PROMPT% ls /cvmfs
%UCL_PROMPT%
</pre>

Directories within =/cvmfs= will not be mounted until you examine them. For instance:

<pre class="screen">
%UCL_PROMPT% ls /cvmfs
%UCL_PROMPT% ls -l /cvmfs/atlas.cern.ch
total 1
drwxrwxr-x 1 cvmfs cvmfs 5 Jun 13  2011 repo/
%UCL_PROMPT% ls -l /cvmfs
total 5
drwxr-xr-x 1 cvmfs cvmfs    3 Apr  1  2011 atlas.cern.ch/
</pre>

You can also run the following command to verify that all of your mount points are working correctly.

<pre class="rootscreen">
%UCL_PROMPT_ROOT% /sbin/service cvmfs probe
Probing /cvmfs/atlas.cern.ch                               [  %GREEN%OK%ENDCOLOR%  ]
Probing /cvmfs/cms.cern.ch                                 [  %GREEN%OK%ENDCOLOR%  ]
</pre>
---## Troubleshooting problems

If no directories exist under =/cvmfs/=, you can try the following steps to debug:

   * Mount it manually =mkdir /mnt/cvmfs= then =mount -t cvmfs REPOSITORYNAME /mnt/cvmfs=.  If this works, then cvmfs is working, but there is a problem with automount.
   * If that doesn't work and doesn't give any explanatory errors, try =cvmfs_config chksetup= or =cvmfs_config showconfig REPOSITORYNAME= to verify your setup

---# Starting and Stopping services

cvmfs can be started via:
<pre class="rootscreen">
%UCL_PROMPT_ROOT%  service cvmfs start
Starting CernVM-FS:                         %GREEN%[  OK  ]%ENDCOLOR%
</pre>

cvmfs can be stopped via:
<pre class="rootscreen">
%UCL_PROMPT_ROOT%  service cvmfs stop
Shutting down CernVM-FS:                         %GREEN% [  OK  ]%ENDCOLOR%
</pre>
Note: stopping cvmfs does not prevent it from starting again when files are accessed under /cvmfs.  It just unmounts what is currently mounted.

*IMPORTANT NOTE*: If you have made changes to automount settings, you restart autofs as well:
<pre class="rootscreen">
%UCL_PROMPT_ROOT%  service cvmfs restartautofs
Shutting down CernVM-FS:                         %GREEN% [  OK  ]%ENDCOLOR%
Stopping automount:                       %GREEN%[  OK  ]%ENDCOLOR%
Starting automount:                       %GREEN%[  OK  ]%ENDCOLOR%
Starting CernVM-FS:                         %GREEN%[  OK  ]%ENDCOLOR%
</pre>

---# Screendump of Install


%TWISTY{
mode="div"
showlink="Click here for a full installation example."
hidelink="Hide the example"
showimgleft="%ICONURLPATH{toggleopen-small}%"
hideimgleft="%ICONURLPATH{toggleclose-small}%"
}%
<pre class="screen">
[root@fermicloud051 ~]# rpm -Uvh http://dl.fedoraproject.org/pub/epel/5/i386/epel-release-5-4.noarch.rpm
Retrieving http://dl.fedoraproject.org/pub/epel/5/i386/epel-release-5-4.noarch.rpm
warning: /var/tmp/rpm-xfer.i8hvMo: Header V3 DSA signature: NOKEY, key ID 217521f6
Preparing...                ########################################### [100%]
   1:epel-release           ########################################### [100%]
[root@fermicloud051 ~]# yum -y install yum-priorities
Loaded plugins: kernel-module
epel                                                     | 3.4 kB     00:00
epel/primary_db                                          | 3.7 MB     00:01
Excluding Packages from SLF 5 base
Finished
Reducing SLF 5 base jdk to included packages only
Finished
Excluding Packages from SLF 5 security updates
Finished
Reducing SLF 5 security updates jdk only to included packages only
Finished
Excluding Packages from SL 5 base
Finished
Reducing SL 5 base jdk to included packages only
Finished
Setting up Install Process
Resolving Dependencies
--> Running transaction check
---> Package yum-priorities.noarch 0:1.1.16-16.el5 set to be updated
--> Finished Dependency Resolution
Beginning Kernel Module Plugin
Finished Kernel Module Plugin

Dependencies Resolved

================================================================================
 Package               Arch          Version               Repository      Size
================================================================================
Installing:
 yum-priorities        noarch        1.1.16-16.el5         sl-base         14 k

Transaction Summary
================================================================================
Install       1 Package(s)
Upgrade       0 Package(s)

Total download size: 14 k
Downloading Packages:
yum-priorities-1.1.16-16.el5.noarch.rpm                  |  14 kB     00:00
Running rpm_check_debug
Running Transaction Test
Finished Transaction Test
Transaction Test Succeeded
Running Transaction
  Installing     : yum-priorities                                           1/1

Installed:
  yum-priorities.noarch 0:1.1.16-16.el5

Complete!
[root@fermicloud051 ~]# rpm -Uvh http://repo.grid.iu.edu/osg-release-latest.rpm
Retrieving http://repo.grid.iu.edu/osg-release-latest.rpm
warning: /var/tmp/rpm-xfer.PUMQzE: Header V3 DSA signature: NOKEY, key ID 824b8603
Preparing...                ########################################### [100%]
   1:osg-release            ########################################### [100%]
[root@fermicloud051 ~]# rpm -Uvh http://repo.grid.iu.edu/osg-release-latest.rpm
Retrieving http://repo.grid.iu.edu/osg-release-latest.rpm
warning: /var/tmp/rpm-xfer.PUMQzE: Header V3 DSA signature: NOKEY, key ID 824b8603
Preparing...                ########################################### [100%]
   1:osg-release            ########################################### [100%]
[root@fermicloud051 ~]# yum install --enablerepo=osg-development cvmfs
Loaded plugins: kernel-module, priorities
osg                                                      | 1.9 kB     00:00
osg/primary_db                                           | 1.1 MB     00:00
osg-development                                          | 1.9 kB     00:00
osg-development/primary_db                               | 362 kB     00:00
Excluding Packages from SLF 5 base
Finished
Reducing SLF 5 base jdk to included packages only
Finished
Excluding Packages from SLF 5 security updates
Finished
Reducing SLF 5 security updates jdk only to included packages only
Finished
Excluding Packages from SL 5 base
Finished
Reducing SL 5 base jdk to included packages only
Finished
1066 packages excluded due to repository priority protections
Setting up Install Process
Resolving Dependencies
--> Running transaction check
---> Package cvmfs.x86_64 0:2.0.13-1.osg.el5 set to be updated
--> Processing Dependency: cvmfs-keys >= 1.2 for package: cvmfs
--> Processing Dependency: fuse for package: cvmfs
--> Running transaction check
---> Package cvmfs-keys.noarch 0:1.4-1.osg.el5 set to be updated
---> Package fuse.x86_64 0:2.7.4-8.el5 set to be updated
--> Finished Dependency Resolution
Beginning Kernel Module Plugin
Finished Kernel Module Plugin

Dependencies Resolved

================================================================================
 Package         Arch        Version                 Repository            Size
================================================================================
Installing:
 cvmfs           x86_64      2.0.13-1.osg.el5        osg-development      1.3 M
Installing for dependencies:
 cvmfs-keys      noarch      1.4-1.osg.el5           osg-development      3.7 k
 fuse            x86_64      2.7.4-8.el5             sl-base               83 k

Transaction Summary
================================================================================
Install       3 Package(s)
Upgrade       0 Package(s)

Total download size: 1.4 M
Is this ok [y/N]: y
]Downloading Packages:
(1/3): cvmfs-keys-1.4-1.osg.el5.noarch.rpm               | 3.7 kB     00:00
(2/3): fuse-2.7.4-8.el5.x86_64.rpm                       |  83 kB     00:00
(3/3): cvmfs-2.0.13-1.osg.el5.x86_64.rpm                 | 1.3 MB     00:00
--------------------------------------------------------------------------------
Total                                           5.4 MB/s | 1.4 MB     00:00
warning: rpmts_HdrFromFdno: Header V3 DSA signature: NOKEY, key ID 824b8603
osg-development/gpgkey                                   | 1.7 kB     00:00
Importing GPG key 0x824B8603 "OSG Software Team (RPM Signing Key for Koji Packages) <vdt-support@opensciencegrid.org>" from /etc/pki/rpm-gpg/RPM-GPG-KEY-OSG
Is this ok [y/N]: y
Is this ok [y/N]: y
Running rpm_check_debug
Running Transaction Test
Finished Transaction Test
Transaction Test Succeeded
Running Transaction
  Installing     : fuse                                                     1/3
  Installing     : cvmfs-keys                                               2/3
  Installing     : cvmfs                                                    3/3

Installed:
  cvmfs.x86_64 0:2.0.13-1.osg.el5

Dependency Installed:
  cvmfs-keys.noarch 0:1.4-1.osg.el5          fuse.x86_64 0:2.7.4-8.el5

Complete!
[root@fermicloud051 ~]# echo "user_allow_other" >> /etc/fuse.conf
[root@fermicloud051 ~]# echo "/cvmfs /etc/auto.cvmfs" >> /etc/auto.master
[root@fermicloud051 ~]# echo "CVMFS_REPOSITORIES=atlas.cern.ch,atlas-condb.cern.ch,lhcb.cern.ch,cms.cern.ch.conf" >> /etc/cvmfs/default.local
[root@fermicloud051 ~]# echo "CVMFS_CACHE_BASE=/var/cache/cvmfs" >> /etc/cvmfs/default.local
[root@fermicloud051 ~]# echo "CVMFS_QUOTA_LIMIT=1000" >> /etc/cvmfs/default.local
[root@fermicloud051 ~]# echo "CVMFS_HTTP_PROXY=\"http://cmsfrontier1.fnal.gov:3128|http://cmsfrontier2.fnal.gov:3128|http://cmsfrontier3.fnal.gov:3128|http://cmsfrontier4.fnal.gov:3128\"" >> /etc/cvmfs/default.local
[root@fermicloud051 ~]# cat /etc/cvmfs/default.local
CVMFS_REPOSITORIES=atlas.cern.ch,atlas-condb.cern.ch,lhcb.cern.ch
CVMFS_CACHE_BASE=/var/cache/cvmfs
CVMFS_QUOTA_LIMIT=1000
CVMFS_HTTP_PROXY="http://cmsfrontier1.fnal.gov:3128|http://cmsfrontier2.fnal.gov:3128|http://cmsfrontier3.fnal.gov:3128|http://cmsfrontier4.fnal.gov:3128"
[root@fermicloud051 ~]# service cvmfs restartautofs
Shutting down CernVM-FS:                                   [  OK  ]
Stopping automount:                                        [  OK  ]
Starting automount:                                        [  OK  ]
Starting CernVM-FS:                                        [  OK  ]
[root@fermicloud051 ~]# service cvmfs probe
Probing /cvmfs/atlas.cern.ch                               [  OK  ]
Probing /cvmfs/atlas-condb.cern.ch                         [  OK  ]
Probing /cvmfs/lhcb.cern.ch                                [  OK  ]
[root@fermicloud051 ~]# ls /cvmfs/atlas.cern.ch/
repo
[root@fermicloud051 ~]# ls /cvmfs/atlas.cern.ch/repo/sw
agis       AtlasSiteConfig.sh       cctools    database  Generators  local      pacman-3.29  python    tags
atlas-gcc  AtlasSiteConfig.sh.orig  ChangeLog  ddm       JEM-WN      nightlies  PandaPilot   software
</pre>
%ENDTWISTY% 

---# File Locations

%STARTSECTION{"Locations"}%

| *Service/Process* | *Configuration File* | *Description* |
|cvmfs|/etc/cvmfs/default.local|cvmfs environment settings and repository setup|
|fuse|/etc/fuse.conf|fuse settings|
|automount|/etc/auto.master|automount settings|



%ENDSECTION{"Locations"}%


---# How to get Help?

If you cannot resolve the problem, there are several ways to receive help:

   * For CERN VM support contact cernvm.support@cern.ch.
   * For bug support and issues, submit a ticket to the [[https://ticket.grid.iu.edu/goc][Grid Operations Center]].
   * For community support and best-effort software team support contact osg-software@opensciencegrid.org.

For a full set of help options, see [[HelpProcedure][Help Procedure]].

---# References

   * http://cernvm.cern.ch/portal/filesystem/techinformation
   * https://cernvm.cern.ch/project/trac/downloads/cernvm/cvmfstech-2.0-5.pdf

---# Comments
| http://cernvm.cern.ch/config/proxy.cgi doesn&#39;t seem to return anything. Does this only work locally at CERN? | Main.SoichiHayashi | 27 Feb 2013 - 16:29 |
| Section 3.4 contains invalid command line. | Main.SoichiHayashi | 27 Feb 2013 - 16:31 |
| I was seeing following message.&#60;br /&#62;&#60;br /&#62;cvmfs_config chksetup&#60;br /&#62;Warning: no public key (CVMFS_PUBLIC_KEY) defined for atlas.cern.ch&#60;br /&#62;Warning: no public key (CVMFS_PUBLIC_KEY) defined for atlas-condb.cern.ch&#60;br /&#62;Warning: no public key (CVMFS_PUBLIC_KEY) defined for lhcb.cern.ch&#60;br /&#62;Warning: no public key (CVMFS_PUBLIC_KEY) defined for cms.cern.ch&#60;br /&#62;&#60;br /&#62;I had to add following to /etc/cvmfs/default.conf&#60;br /&#62;&#62; CVMFS_PUBLIC_KEY=/etc/cvmfs/keys/cern.ch.pub&#60;br /&#62;and restart cvmfs | Main.SoichiHayashi | 27 Feb 2013 - 17:10 |
%COMMENT{type="tableappend"}%



<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = DouglasStrain

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = Storage

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = Installation
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %YES%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %YES%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %YES%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = AlainRoy
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %YES%


 DEAR DOCUMENT TESTER
 ====================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = DaveDykstra
 Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %YES%
############################################################################################################
-->
