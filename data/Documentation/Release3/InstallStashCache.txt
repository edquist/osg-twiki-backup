%META:TOPICINFO{author="BrianLin" date="1436909049" format="1.1" version="1.2"}%
<style type="text/css">
code em, pre em { color: red; font-weight: normal; font-style: normal; }
</style>

---+ Installing and Using !StashCache

%TOC{depth="3"}%

---++ About This Guide

This document describes how to install a !StashCache cache, a server that caches files locally rather than serving files to the !StashCache federation. The installation utilizes !XRootD and HTCondor for file storage and monitoring, respectively.

%NOTE% Currently, !StashCache is only supported on EL6 hosts.

---++ Before Starting

Before starting the installation process, consider the following points:

   * *User IDs:* If they do not exist already, the installation will create the Linux user IDs =condor= and =xrootd=
   * *Service certificate:* The !StashCache service uses a host certificate at =/etc/grid-security/host*.pem=
   * *Network ports:* The !StashCache service must talk to the central collector on port 9619 (TCP) and !XRootD services on port 1094 (TCP)
   * *Hardware requirements:* We recommend that a !StashCache server has at least 10Gbps connectivity, 1TB of disk space, and 8GB of RAM.

As with all OSG software installations, there are some one-time steps to prepare in advance:

   * Ensure the host has [[SupportedOperatingSystems][a supported operating system]]
   * Obtain root access to the host
   * Prepare [[YumRepositories][the required Yum repositories]]
   * Install [[InstallCertAuth][CA certificates]]


---++ Installing the !StashCache daemon

The !StashCache daemon consists of an !XRootD server and an HTCondor-based service for collecting and reporting statistics about the cache. To simplify installation, OSG provides convenience RPMs that install all required software with a single command:

<ol>
%INCLUDE{"Documentation/Release3/OSGReleaseSeries" section="Update"}%
  <li>
    <p>Install the !StashCache metapackage from OSG's upcoming repository:</p>
    <pre class="rootscreen">%UCL_PROMPT_ROOT% yum install stashcache-daemon fetch-crl stashcache-cache-server --enablerepo=osg-upcoming</pre>
  </li>
  <li>
    <p>Mount the disk that will be used for the cache to =/stash=.
  </li>
</ol>

---++ Configuring !StashCache

The following section describes required configuration to have a functional !StashCache cache. For more advanced configuration, see the section on [[#OptionalConfiguration][optional configuration]].

---+++ Modifying the !XRootD configuration

Modify =XROOTD_DEFAUL_OPTIONS= in the !XRootD system configuration, =/etc/sysconfig/xrootd=, so that it uses the configuration file provided by the =stashcache-cache-server= package: 

<pre class="file">
XROOTD_DEFAULT_OPTIONS="-l /var/log/xrootd/xrootd.log -c <span style="background-color: #FFCCFF;">/etc/xrootd/xrootd-stashcache-cache-server.cfg</span> -k fifo"
</pre>

#OptionalConfiguration
---+++ Optional configuration

The following configuration is not required to have a functional !StashCache cache but can be set to improve your cache's performance.

---++++ Adjust disk utilization
To adjust the disk utilization of your !StashCache cache, modify the values of =pfc.diskusage= in =/etc/xrootd/xrootd-stashcache-cache-server.cfg=:
<pre class="file">
pfc.diskusage <span style="background-color: #FFCCFF;">0.98 .99</span>
</pre>

The first value and second values correspond to the low and high usage watermarks, respectively, in percentages. When the high watermark is reached, the !XRootD service will automatically purge cache objects down to the low watermark. 

---++ Using !StashCache

---+++ Managing !StashCache and associated services
Ensure that your =/stash= disk is mounted, and then start the =xrootd= and =condor= services:

%TABLE{sort="off"}%
| *Software* | *Service name* | *Notes* |
| Fetch CRL | On EL 6: =fetch-crl-boot= and =fetch-crl-cron= %BR% On EL 5: =fetch-crl3-boot= and =fetch-crl3-cron= | See [[InstallCertAuth#Start_Stop_fetch_crl_A_quick_gui][CA documentation]] for more info |
| !XRootD | =xrootd= | |
| HTCondor | =condor= | |

Start the services in the order listed and stop them in reverse order. As a reminder, here are common service commands (all run as =root=):

%TABLE{sort="off"}%
| *To &hellip;* | *Run the command &hellip;* |
| Start a service | =service <em>SERVICE-NAME</em> start= |
| Stop a service | =service <em>SERVICE-NAME</em> stop= |
| Enable a service to start during boot | =chkconfig <em>SERVICE-NAME</em> on= |
| Disable a service from starting during boot | =chkconfig <em>SERVICE-NAME</em> off= |

---+++ Validating !StashCache

To verify that your cache is being monitored properly, run the following command:

<pre class="screen">
%UCL_PROMPT% condor_status -any -l -const 'Name=="xrootd@<span style="background-color: #D1CAF2;">hostname</span>"'
</pre>

Where <span style="background-color: #D1CAF2;">hostname</span> is the string returned by the =hostname= command. The output of the above command should provide an HTCondor !ClassAd that details the status of your cache.

---++ Getting Help

To get assistance, please use the [[Documentation.HelpProcedure][this page]].

-- Main.LincolnBryant - 09 Jul 2015
