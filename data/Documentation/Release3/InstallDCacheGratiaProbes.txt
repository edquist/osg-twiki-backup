%META:TOPICINFO{author="NehaSharma" date="1377009991" format="1.1" version="1.9"}%
%META:TOPICPARENT{name="InstallBestPractices"}%
%LINKCSS%
---+!! %SPACEOUT{ "InstallDCacheGratiaProbes" }%
%DOC_STATUS_TABLE%
%TOC%

---+ 1.0 About this Document

This document describes how you can setup the Gratia Storage and Transfer probes for dCache based Storage Element.

---+ 2.0 Requirements

---++ 2.1 Host and OS

   1. OS is %SUPPORTED_OS%. 
   1. [[http://fedoraproject.org/wiki/EPEL][EPEL]] repos enabled.
   1. Root access
   1. Preferably, the probe should be installed on the dCache admin node. If you need to install it on another node, make sure to configure the postgres database running on dCache admin node to allow remote access from node on which probe is installed.

---++ 2.2 Certificates

%STARTSECTION{"Certificates"}%
| *Certificate* | *User that owns certificate* | *Path to certificate* |
| Host certificate | =root= | =/etc/grid-security/hostcert.pem= <br> =/etc/grid-security/hostkey.pem= |
%ENDSECTION{"Certificates"}%

[[InstallCertScripts][Instructions]] to request a service certificate.
You will also need a copy of CA certificates (see below). 

---+ 3.0 Why do I need these probes?
<!-- conventions used in this document
   * Local UCL_HOST = %URLPARAM{"INPUT_HOST" encode="quote" default="dCache-admin"}%
-->
If you have a dCache based Storage Element, you should install these probes. The probes report storage related information to [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/GratiaSiteCollector][the central Gratia collector]]. 
   * The dCache-transfer probe reports the details of each file transfer into or out of a dCache file server. 
   * The dCache-storage probe is responsible for reporting storage capacity and storage usage to the central Gratia collector. The information reported is:
      * The storage capacity and amount used for each dCache pool.
      * The storage capacity and amount used for each SRM Space reservation.

---+ 4.0 Installation
%INCLUDE{"YumRepositories" section="OSGRepoBrief" headingoffset="1"}%
%INCLUDE{"InstallCertAuth" section="OSGBriefCaCerts" TOC_SHIFT="+"}%

---++ 4.1 Installing dCache Gratia probes
<pre class="rootscreen">
%UCL_PROMPT_ROOT% yum install dcache-gratia-probe
</pre>

---+ 5.0 Configuration

To configure dCache transfer probe you will need to modify the configuration file ==/etc/gratia/dCache-transfer/ProbeConfig as follows
<pre class="file">
    CollectorHost="gratia-osg-%RED%itb%ENDCOLOR%.opensciencegrid.org:80"
    SSLHost="gratia-osg-%RED%itb%ENDCOLOR%.opensciencegrid.org:443"
    SSLRegistrationHost="gratia-osg-%RED%itb%ENDCOLOR%.opensciencegrid.org:80"
    UserVOMapFile="%RED%/var/lib/osg/user-vo-map%ENDCOLOR%"
    SiteName="%RED%YOUR SITE NAME%ENDCOLOR%"
    Grid="OSG-%RED%ITB%ENDCOLOR%"
    EnableProbe="%RED%1%ENDCOLOR%"
     DBHostName="%RED%dcache-adminhost%ENDCOLOR%"
</pre>
%ICON{note}% If you are installing on dCache admin node you don't need to change !DBHostName (localhost is a default)

To configure dCache storage probe you will need to modify the configuration file ==/etc/gratia/dCache-storage/ProbeConfig as follows
<pre class="file">
    CollectorHost="gratia-osg-%RED%itb%ENDCOLOR%.opensciencegrid.org:80"
    SSLHost="gratia-osg-%RED%itb%ENDCOLOR%.opensciencegrid.org:443"
    SSLRegistrationHost="gratia-osg-%RED%itb%ENDCOLOR%.opensciencegrid.org:80"
    UserVOMapFile="%RED%/var/lib/osg/user-vo-map%ENDCOLOR%"
    SiteName="%RED%YOUR SITE NAME%ENDCOLOR%"
    Grid="OSG-%RED%ITB%ENDCOLOR%"
    EnableProbe="%RED%1%ENDCOLOR%"
    InfoProviderUrl="http://%RED%dcache-adminhost%ENDCOLOR%:2288/info"
</pre>
%ICON{warning}% Please use ITB for testing.

You will also need to configure ==/etc/gums/gums-client.properties== in order to accurately collect grid resource usage and metrics by VO for transfer submitted using grid proxies or where voms proxy information is not available.<pre class="file">
gums.location=https://%RED%GUMS_HOST%ENDCOLOR%:8443/gums/services/GUMSAdmin
gums.authz=https://%RED%GUMS_HOST%ENDCOLOR%:8443/gums/services/GUMSXACMLAuthorizationServicePort
</pre>
%ICON{warning}% if you are not using a default port (8443) you have to change it as well.

---+ 6.0 Start
   1. To start the Gratia transfer probe for dCache
<pre class="rootscreen">
%UCL_PROMPT_ROOT% service  gratia-dcache-transfer start
Starting gratia-dcache-transfer:                           [  OK  ]
</pre>
   1. The Gratia storage probe for dCache is a cronjob. The cron file ==gratia-probe-dCache-storage.cron== is located in ==/etc/cron.d==.
If you want to test it you can run it manually as follows
<pre class="rootscreen">
%UCL_PROMPT_ROOT% /usr/share/gratia/dCache-storage/dCache-storage_meter.cron.sh
</pre>

---+ 7.0 Stop
   1. To stop the Gratia transfer probe for dCache
<pre class="rootscreen">
%UCL_PROMPT_ROOT% service  gratia-dcache-transfer stop
Stop gratia-dcache-transfer:                           [  OK  ]
</pre>
    2. To stop the Gratia storage probe for dCache, comment the cron job in file ==/etc/cron.d/gratia-probe-dCache-storage.cron== as follows
<pre class="file">
#0 * * * * root "perl -e 'sleep rand 3600' && /usr/share/gratia/dCache-storage/dCache-storage_meter.cron.sh"
</pre>

---+ 8.0 Test
  1. First make sure that Gratia transfer probe for dCache is running
<pre class="rootscreen">
%UCL_PROMPT_ROOT%  ps auxww|grep gratia-dcache-transfer
root      2680  2.3  0.2 174584 11080 ?        S    14:32   0:19 /usr/bin/python /usr/share/gratia/dCache-transfer/gratia-dcache-transfer
</pre>
   1. Check the log files, located under ==/var/log/gratia==
   1. Verify that you can see the reports in gratia collector you have specified in configuration. Be aware that it could some delay due to Collector being under heavy load is possible. So, be patient. 

To access the information about Gratia transfer probe for dCache, go to http://[gratia_host]:[gratia_port]/gratia-reporting/, click on "Custom SQL Query" on the left site menu frame, and enter the following query into provided text box
<pre class="file">
select * from MasterTransferSummary where ProbeName like 'dCache-transfer:%RED%dcache_adminhost%ENDCOLOR%';
</pre>
click on "Execute Query" and you will see the total number of transfers per user.

To access the information about the Gratia storage probe for dCache, go to http://[gratia_host]:[gratia_port]/gratia-reporting/, click on "Custom SQL Query" on the left site menu frame, and enter the following query into provided text box
<pre class="file">
select * from StorageElement where ProbeName like 'dCache-storage:%RED%dcache_adminhost%ENDCOLOR%';
</pre>

Click on "Execute Query" and you will see the storage information. 

To check ITB Gratia collector click here [[http://gratia-osg-itb.opensciencegrid.org/gratia-reporting/][ITB Gratia]].
To check OSG Gratia collector click here [[http://gratia-osg-transfer.opensciencegrid.org/gratia-reporting/][OSG Gratia]].
       

<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = NehaSharma

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = Storage

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = HowTo
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %NO%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %NO%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = DouglasStrain
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %IN_PROGRESS%

 DEAR DOCUMENT TESTER
 ======================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER       = DouglasStrain
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %IN_PROGRESS%
############################################################################################################
-->

%META:TOPICMOVED{by="JamesWeichel" date="1317239434" from="Documentation.InstallDCacheGratiaProbes" to="Documentation/Release3.InstallDCacheGratiaProbes"}%
