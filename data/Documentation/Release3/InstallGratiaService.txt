%META:TOPICINFO{author="TanyaLevshina" date="1335895340" format="1.1" reprev="1.3" version="1.3"}%
%DOC_STATUS_TABLE%

---+!! Install Gratia Service
%TOC%

<!-- conventions used in this document
   * Local UCL_HOST = %URLPARAM{"INPUT_HOST" encode="quote" default="gratia"}%
   * Local UCL_USER = %URLPARAM{"INPUT_USER" encode="quote" default="user"}%
   * Local UCL_DOMAIN = %URLPARAM{"INPUT_DOMAIN" encode="quote" default="opensciencegrid.org"}%
   * Set TWISTY_OPTS_DETAILED = mode="div" showlink="Show Detailed Output" hidelink="Hide" showimgleft="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" hideimgleft="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" remember="on" start="hide" 
-->
%STARTINCLUDE%
%EDITTHIS%

---+ About this Document
This document is for Site System Administrators. 
---+ Introduction
---+ Requirements
---++ Users
---++ Certificates
You will need one service certificate. [[GetHostServiceCertificates][Here]] are instructions to request a host certificate. Optional, you can use the host certificate instead as explained in the [[#Setup_the_Service_Certificates][section below]].

| *Certificate* | *User that owns certificate* | *Path to certificate* |
| Tomcat service certificate | =tomcat= | =/etc/grid-security/http/httpcert.pem= <br> =/etc/grid-security/http/httpkey.pem= |

---++ Networking

Firewall information - here

%NOTE% 
---++ Additional Requirements
---+ Installation Procedure

%INCLUDE{"YumRepositories" section="OSGRepoBrief" TOC_SHIFT="+"}%

%INCLUDE{"InstallCertAuth" section="OSGBriefCaCerts" TOC_SHIFT="+"}%

%STARTSECTION{"InstallOSGGratiaServiceRPMs"}%
 

Install OSG-VOMS:<pre class="rootscreen">
%UCL_PROMPT_ROOT% yum install gratia-service
</pre>  %TWISTY{%TWISTY_OPTS_DETAILED%}%   <pre class="rootscreen">
%UCL_PROMPT_ROOT% yum install osg-voms
yum install gratia-service
Loaded plugins: kernel-module, priorities
osg                                                                                                                                 | 1.9 kB     00:00     
osg/primary_db                                                                                                                      | 1.0 MB     00:00     
1290 packages excluded due to repository priority protections
Setting up Install Process
Resolving Dependencies
--> Running transaction check
---> Package gratia-service.noarch 0:1.12-2.osg.el5 set to be updated
epel/filelists_db                                                                                                                   | 5.4 MB     00:01     
fermi-base/filelists                                                                                                                |  21 kB     00:00     
fermi-security/filelists_db                                                                                                         | 9.4 MB     00:00     
osg/filelists_db                                                                                                                    | 566 kB     00:00     
sl-base/filelists_db                                                                                                                | 3.6 MB     00:00     
--> Processing Dependency: /usr/share/java/xml-commons-apis.jar for package: gratia-service
--> Processing Dependency: emi-trustmanager-tomcat for package: gratia-service
--> Processing Dependency: grid-certificates for package: gratia-service
--> Processing Dependency: mysql-server for package: gratia-service
--> Processing Dependency: vo-client-edgmkgridmap for package: gratia-service
--> Running transaction check
---> Package emi-trustmanager-tomcat.noarch 0:3.0.0-3 set to be updated
--> Processing Dependency: emi-trustmanager for package: emi-trustmanager-tomcat
--> Processing Dependency: bouncycastle for package: emi-trustmanager-tomcat
---> Package mysql-server.x86_64 0:5.0.95-1.el5_7.1 set to be updated
--> Processing Dependency: mysql = 5.0.95-1.el5_7.1 for package: mysql-server
--> Processing Dependency: libmysqlclient.so.15(libmysqlclient_15)(64bit) for package: mysql-server
--> Processing Dependency: perl-DBD-MySQL for package: mysql-server
--> Processing Dependency: perl(DBI) for package: mysql-server
--> Processing Dependency: perl-DBI for package: mysql-server
--> Processing Dependency: libmysqlclient_r.so.15(libmysqlclient_15)(64bit) for package: mysql-server
--> Processing Dependency: libmysqlclient_r.so.15()(64bit) for package: mysql-server
--> Processing Dependency: libmysqlclient.so.15()(64bit) for package: mysql-server
---> Package osg-ca-certs.noarch 0:1.27-2.osg.el5 set to be updated
---> Package vo-client-edgmkgridmap.noarch 0:41-3.osg.el5 set to be updated
---> Package xml-commons-apis.x86_64 0:1.3.02-0.b2.7jpp.10 set to be updated
--> Running transaction check
---> Package bouncycastle.x86_64 0:1.45-6.el5 set to be updated
--> Processing Dependency: java >= 1:1.6 for package: bouncycastle
---> Package emi-trustmanager.noarch 0:3.0.3-1.sl5 set to be updated
---> Package mysql.x86_64 0:5.0.95-1.el5_7.1 set to be updated
---> Package perl-DBD-MySQL.x86_64 0:3.0007-2.el5 set to be updated
---> Package perl-DBI.x86_64 0:1.52-2.el5 set to be updated
--> Running transaction check
---> Package java-1.6.0-openjdk.x86_64 1:1.6.0.0-1.25.1.10.6.el5_8 set to be updated
--> Processing Dependency: tzdata-java for package: java-1.6.0-openjdk
--> Processing Dependency: libgif.so.4()(64bit) for package: java-1.6.0-openjdk
--> Running transaction check
---> Package giflib.x86_64 0:4.1.3-7.1.el5_3.1 set to be updated
---> Package tzdata-java.x86_64 0:2012b-3.el5 set to be updated
--> Finished Dependency Resolution
Beginning Kernel Module Plugin
Finished Kernel Module Plugin

Dependencies Resolved

===========================================================================================================================================================
 Package                                   Arch                     Version                                         Repository                        Size
===========================================================================================================================================================
Installing:
 gratia-service                            noarch                   1.12-2.osg.el5                                  osg                               75 M
Installing for dependencies:
 bouncycastle                              x86_64                   1.45-6.el5                                      epel                             4.0 M
 emi-trustmanager                          noarch                   3.0.3-1.sl5                                     osg                              271 k
 emi-trustmanager-tomcat                   noarch                   3.0.0-3                                         osg                               30 k
 giflib                                    x86_64                   4.1.3-7.1.el5_3.1                               sl-base                           39 k
 java-1.6.0-openjdk                        x86_64                   1:1.6.0.0-1.25.1.10.6.el5_8                     fermi-security                    36 M
 mysql                                     x86_64                   5.0.95-1.el5_7.1                                fermi-security                   4.9 M
 mysql-server                              x86_64                   5.0.95-1.el5_7.1                                fermi-security                   9.9 M
 osg-ca-certs                              noarch                   1.27-2.osg.el5                                  osg                              281 k
 perl-DBD-MySQL                            x86_64                   3.0007-2.el5                                    sl-base                          147 k
 perl-DBI                                  x86_64                   1.52-2.el5                                      sl-base                          605 k
 tzdata-java                               x86_64                   2012b-3.el5                                     fermi-security                   181 k
 vo-client-edgmkgridmap                    noarch                   41-3.osg.el5                                    osg                              5.6 k
 xml-commons-apis                          x86_64                   1.3.02-0.b2.7jpp.10                             sl-base                          387 k

Transaction Summary
===========================================================================================================================================================
Install      14 Package(s)
Upgrade       0 Package(s)

Total download size: 132 M
Is this ok [y/N]: y
Downloading Packages:
(1/14): vo-client-edgmkgridmap-41-3.osg.el5.noarch.rpm                                                                              | 5.6 kB     00:00     
(2/14): emi-trustmanager-tomcat-3.0.0-3.noarch.rpm                                                                                  |  30 kB     00:00     
(3/14): giflib-4.1.3-7.1.el5_3.1.x86_64.rpm                                                                                         |  39 kB     00:00     
(4/14): perl-DBD-MySQL-3.0007-2.el5.x86_64.rpm                                                                                      | 147 kB     00:00     
(5/14): tzdata-java-2012b-3.el5.x86_64.rpm                                                                                          | 181 kB     00:00     
(6/14): emi-trustmanager-3.0.3-1.sl5.noarch.rpm                                                                                     | 271 kB     00:00     
(7/14): osg-ca-certs-1.27-2.osg.el5.noarch.rpm                                                                                      | 281 kB     00:00     
(8/14): xml-commons-apis-1.3.02-0.b2.7jpp.10.x86_64.rpm                                                                             | 387 kB     00:00     
(9/14): perl-DBI-1.52-2.el5.x86_64.rpm                                                                                              | 605 kB     00:00     
(10/14): bouncycastle-1.45-6.el5.x86_64.rpm                                                                                         | 4.0 MB     00:00     
(11/14): mysql-5.0.95-1.el5_7.1.x86_64.rpm                                                                                          | 4.9 MB     00:00     
(12/14): mysql-server-5.0.95-1.el5_7.1.x86_64.rpm                                                                                   | 9.9 MB     00:00     
(13/14): java-1.6.0-openjdk-1.6.0.0-1.25.1.10.6.el5_8.x86_64.rpm                                                                    |  36 MB     00:02     
(14/14): gratia-service-1.12-2.osg.el5.noarch.rpm                                                                                   |  75 MB     00:07     
-----------------------------------------------------------------------------------------------------------------------------------------------------------
Total                                                                                                                       11 MB/s | 132 MB     00:11     
warning: rpmts_HdrFromFdno: Header V3 DSA signature: NOKEY, key ID 217521f6
epel/gpgkey                                                                                                                         | 1.7 kB     00:00     
Importing GPG key 0x217521F6 "Fedora EPEL <epel@fedoraproject.org>" from /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL
Is this ok [y/N]: y
warning: rpmts_HdrFromFdno: Header V3 DSA signature: NOKEY, key ID 824b8603
osg/gpgkey                                                                                                                          | 1.7 kB     00:00     
Importing GPG key 0x824B8603 "OSG Software Team (RPM Signing Key for Koji Packages) <vdt-support@opensciencegrid.org>" from /etc/pki/rpm-gpg/RPM-GPG-KEY-OSG
Is this ok [y/N]: y
Running rpm_check_debug
Running Transaction Test
Finished Transaction Test
Transaction Test Succeeded
Running Transaction
  Installing     : perl-DBI                                                                                                                           1/14 
  Installing     : mysql                                                                                                                              2/14 
  Installing     : perl-DBD-MySQL                                                                                                                     3/14 
  Installing     : mysql-server                                                                                                                       4/14 
  Installing     : giflib                                                                                                                             5/14 
  Installing     : xml-commons-apis                                                                                                                   6/14 
  Installing     : emi-trustmanager                                                                                                                   7/14 
  Installing     : vo-client-edgmkgridmap                                                                                                             8/14 
  Installing     : tzdata-java                                                                                                                        9/14 
  Installing     : java-1.6.0-openjdk                                                                                                                10/14 
  Installing     : bouncycastle                                                                                                                      11/14 
  Installing     : emi-trustmanager-tomcat                                                                                                           12/14 
  Installing     : osg-ca-certs                                                                                                                      13/14 
  Installing     : gratia-service                                                                                                                    14/14 

Installed:
  gratia-service.noarch 0:1.12-2.osg.el5                                                                                                                   

Dependency Installed:
  bouncycastle.x86_64 0:1.45-6.el5                 emi-trustmanager.noarch 0:3.0.3-1.sl5                    emi-trustmanager-tomcat.noarch 0:3.0.0-3       
  giflib.x86_64 0:4.1.3-7.1.el5_3.1                java-1.6.0-openjdk.x86_64 1:1.6.0.0-1.25.1.10.6.el5_8    mysql.x86_64 0:5.0.95-1.el5_7.1                
  mysql-server.x86_64 0:5.0.95-1.el5_7.1           osg-ca-certs.noarch 0:1.27-2.osg.el5                     perl-DBD-MySQL.x86_64 0:3.0007-2.el5           
  perl-DBI.x86_64 0:1.52-2.el5                     tzdata-java.x86_64 0:2012b-3.el5                         vo-client-edgmkgridmap.noarch 0:41-3.osg.el5   
  xml-commons-apis.x86_64 0:1.3.02-0.b2.7jpp.10   

Complete!
</pre> %ENDTWISTY%
%ENDSECTION{"InstallOSGGratiaServiceRPMs"}%

---+ Configure
The configuration requires some initial steps.
%STARTSECTION{"ConfigureMysqlServer"}%
---++ Configure !MySQL Database

Before you will be able configure Gratia Service you will need to have access to !MySQL database.  The !MySQL software is installed with the =gratia-service= package. By default it will be using port 3306 and will not have password for ==root==. It is recommended to replace  a default configuration file that is installed with mysqld server (==/etc/my.cnf==)  with ==/usr/share/gratia/my-cnf.template==:
<pre class="file">
[mysqld]
datadir = /var/lib/mysql
socket =  /var/lib/mysql/mysql.sock
user = mysql
port = 3306

log_bin = /var/lib/mysql/mysql-bin
log =     /var/log/mysqld.log
log_bin_trust_function_creators = 1
expire_logs_days = 7
sync_binlog=1

innodb_file_per_table
innodb_data_home_dir = /var/lib/mysql
innodb_data_file_path = ibdata1:500M;ibdata2:10M:autoextend
innodb_log_group_home_dir = /var/lib/mysql
innodb_flush_log_at_trx_commit = 1
innodb_buffer_pool_size = 256M
innodb_additional_mem_pool_size = 20M
innodb_log_file_size = 64M
innodb_log_files_in_group = 2
innodb_log_buffer_size = 8M
innodb_lock_wait_timeout = 50
innodb_thread_concurrency = 2
# To prevent too large of innodb history list which affects inserts
innodb_max_purge_lag=50000



# Uncomment the following line for debugging purposes.
#log-warnings=2

# Default to using old password format for compatibility with mysql 3.x
# clients (those using the mysqlclient10 compatibility package).
old_passwords=1

# Disabling symbolic-links is recommended to prevent assorted security risks;
# to do so, uncomment this line:
# symbolic-links=0
</pre>

If you are planning to collect data from a very large number of probes you can use ==/usr/share/gratia/my-cnf.large-site.template==. This configuration is used at Fermilab for the OSG collector that gathers data from all OSG sites.

In order to replace mysql configuration just copy template to ==/etc/my.cnf==:
:<pre class="rootscreen">
%UCL_PROMPT_ROOT% cp /usr/share/gratia/my-cnf.template /etc/my.cnf
</pre>
*Note* The default mysqld port (3306) is used in this configuration file. If you prefer to use some other port you have to change it here before proceeding with any other actions.

You will need to start mysqld at this time:
:<pre class="rootscreen">
%UCL_PROMPT_ROOT%service mysqld start
</pre>
%ENDSECTION{"ConfigureMysqlServer"}%
%STARTSECTION{"ConfigureGratiaService"}%
---++ Configure Gratia Service
Gratia Service configuration setting is splitted between two files. The first file,  ==/etc/gratia/collector/service-authorization.properties==,  contains gratia mysql related information:
<pre class="file">
########################################################################
# Gratia Service Authorization File.
########################################################################
[gratia]
# These are filled in automatically
gratia.reporting.version=v1.12
gratia.services.version=v1.12
#
# ##########  DB access parameters
#
service.mysql.rootpassword=%RED%ROOTDBPASSWORD%ENDCOLOR%
service.mysql.user=%RED%DBUSER%ENDCOLOR%
service.mysql.password=%RED%DBPASSWORD%ENDCOLOR%
service.reporting.user=reader
service.reporting.password=reader
#
</pre>
It is wise to set a password for the ==root== user. In order to do so you will need to modify %RED%ROOTDBPASSWORD%ENDCOLOR% with the actual password for the ==root== user of mysql database. It is will be set automatically when you create ==gratia== database. If for some reason you don't want to set this password you have to comment this line in configuration file. You have also defined the user name for gratia database owner %RED%DBUSER%ENDCOLOR% and set password for this user by modfying %RED%DBPASSWORD%ENDCOLOR%.

The second file,  ==/etc/gratia/collector/service-configuration.properties==,  contains gratia service related information (only the properties that must be modified are provided in the screen below:
<pre class="file">
...
service.mysql.url=jdbc:mysql://%RED%DBHOSTNAME:DBPORT%ENDCOLOR%/gratia
....
service.open.connection=http://%RED%HOSTNAME%ENDCOLOR%:%BLUE%8880%ENDCOLOR%
service.secure.connection=https://%RED%HOSTNAME%ENDCOLOR%:%BLUE%8443%ENDCOLOR%
....
</pre>

Where %RED%DBHOSTNAME:DBPORT%ENDCOLOR% could be replace with ==localhost:3306== if you didn't change default mysql port.  The service secure and open connections properties should be modified by replacing  %RED%HOSTNAME%ENDCOLOR% with an actual name of the host the service is installed. You can modify open and secure ports as well. Keep in mind that gratia probes will have to be configured accordingly so the information that is gathered by probe could be sent  to gratia service.

You can also configure the administrative login to Gratia service at this time. Please read the detailed instructions in ==/etc/gratia/collector/service-configuration.properties== under 
==# ##########  Administrative login== section.
After finishing with configuration you will need to run ==/usr/share/gratia/install-database== script that performs the following steps:
   1. set mysql password for the user ==root== if it is defined in ==service-authorization.properties== file
   1. create ==gratia== database
   1. grant approriate privelages for gratia database user    

%ENDSECTION{"ConfigureGratiaService"}%
%STARTSECTION{"ConfigureTomcatService"}%
---++ Configure Tomcat options
Make sure that you have the host,  and Tomcat service certificates/keys in the right directories and with the correct owners and permissions (=600= for key and =644= the certificate). [[GetHostServiceCertificates][Host certificate]] is required and must be in =/etc/grid-security/hostcert.pem= and =hostkey.pem=. It is recommended to provide also service certificates for Tomcat. If you don't, here are the instructions to copy the host certificate/key and set the correct owner (permissions are preserved).  Note that if you did not previously have a  tomcat user on your system, they were added during the RPM install:
   1. Tomcat service is running as user ==tomcat== and requires its service certificate and key in ==/etc/grid-security/http==. To copy the host certificate/key for this service, you need to do the following:<pre class="rootscreen">
%UCL_PROMPT_ROOT% cd /etc/grid-security
%UCL_PROMPT_ROOT% mkdir /etc/grid-security/http
%UCL_PROMPT_ROOT% cp hostcert.pem http/httpcert.pem
%UCL_PROMPT_ROOT% cp hostkey.pem http/httpkey.pem
%UCL_PROMPT_ROOT% chown -R tomcat:tomcat http
</pre>
%ENDSECTION{"ConfigureTomcatService"}%
---+ Comments

%COMMENT{type="tableappend"}%

<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = TanyaLevshina

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = General

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = Installation
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %NO%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local TEST_READY   = %NO%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = StevenTimm
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %NO%


DEAR DOCUMENT TESTER
 ====================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = Hyun Woo Kim
 Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %NO%
############################################################################################################
-->
