%META:TOPICINFO{author="NehaSharma" date="1340054585" format="1.1" reprev="1.3" version="1.3"}%
%META:TOPICPARENT{name="WebHome"}%
%LINKCSS%
---+!! %SPACEOUT{ "Edg-mkgridmap" }%
%DOC_STATUS_TABLE%
%TOC%

---+ Edg-Mkgridmap
(IN PROGRESS)

This document describes how you can use =edg-mkgridmap=  to authorize users accessing the resources that you provide. 

---++ Configuration
   * First, you need to tell =edg-mkgridmap=, which Virtual Organizations (VOs) you wish to support. 
      For this, edit the =/etc/edg-mkgridmap.conf= such that all VOs that you wish to support are present and uncommented and all VOs that you do not wish to support are either commented or not present.
Here is an example in which =cdf= VO is disabled and =fermilab= VO is enabled
<pre class="file">
[root@fermicloud046 ~]# cat /etc/edg-mkgridmap.conf 
#### GROUP: group URI [lcluser]
#
#-------------------
# USER-VO-MAP cdf CDF -- 1 -- Dennis Box (dbox@fnal.gov)     
#group vomss://voms.fnal.gov:8443/voms/cdf cdf
#group vomss://voms.cnaf.infn.it:8443/voms/cdf cdf
#-------------------
# USER-VO-MAP fermilab FERMILAB -- 2 -- Fermilab Service Desk (servicedesk@fnal.gov)  
group vomss://voms.fnal.gov:8443/voms/fermilab fermilab
[root@fermicloud046 ~]#
</pre>

---+++ I have some local users I want to support on my site. How do I tell edg-mkgridmap about them?
First, you need to create a local gridmap-file, each line of which should contain mapping of form =DN username=. Here, =DN= is the Distinguished Name of the user you want to support and =username= is the name of local user to which this DN should be mapped to. 
Second, you need to configure =edg-mkgridmap= such that it knows about this local gridmap-file. For this, you need to use the =gmf_local= directive.
So, for example, your =edg-mkgridmap.conf= would now look like
<pre class="file">
[root@fermicloud046 ~]# cat /etc/edg-mkgridmap.conf 
#### GROUP: group URI [lcluser]
#
#-------------------
# USER-VO-MAP cdf CDF -- 1 -- Dennis Box (dbox@fnal.gov)     
#group vomss://voms.fnal.gov:8443/voms/cdf cdf
#group vomss://voms.cnaf.infn.it:8443/voms/cdf cdf
#-------------------
# USER-VO-MAP fermilab FERMILAB -- 2 -- Fermilab Service Desk (servicedesk@fnal.gov)  
group vomss://voms.fnal.gov:8443/voms/fermilab fermilab
gmf_local /etc/grid-security/local-gridmap-file
[root@fermicloud046 ~]#
</pre>

---++ Execution/Enabling
   * Second, you need to configure ==edg-mkgridmap== to run automatically via a cron job. To enable this, you need to run the following command.

<pre class="rootscreen">
[root@fermicloud046 ~]# /sbin/service edg-mkgridmap start
Enabling periodic edg-mkgridmap:                           [  OK  ]
[root@fermicloud046 ~]#
</pre>
The entry in cron file (=/etc/cron.d/edg-mkgridmap-cron=) looks like
<pre class="file">
[root@fermicloud046 ~]# cat /etc/cron.d/edg-mkgridmap-cron 
# Cron job running by default every 6 hours.
# The lock file can be enabled or disabled via a
# service edg-mkgridmap start
# chkconfig edg-mkgridmap on

# Note the lock file not existing is success hence the the slightly odd logic
# below.
# run every 6 hours but sleep for random time every 5 hours

0 */6 * * * root perl -e 'sleep rand 18000'; [ ! -f /var/lock/subsys/edg-mkgridmap ] || /usr/sbin/edg-mkgridmap
[root@fermicloud046 ~]#
     </pre>
*Note*: As you can see above, that this cron will run every 6 hours. If you do not want to wait that long, you can execute the command =/usr/sbin/edg-mkgridmap= directly on command line

You can also chkconfig it on, so it automatically starts if the machine was rebooted
<pre class="rootscreen">
[root@fermicloud046 ~]# chkconfig edg-mkgridmap on
[root@fermicloud046 ~]# chkconfig --list edg-mkgridmap
edg-mkgridmap  	0:off	1:off	2:on	3:on	4:on	5:on	6:off
[root@fermicloud046 ~]#
</pre>

To chkconfig it off, do following
<pre class="rootscreen">
[root@fermicloud046 ~]# chkconfig edg-mkgridmap off
[root@fermicloud046 ~]# chkconfig --list edg-mkgridmap
edg-mkgridmap  	0:off	1:off	2:off	3:off	4:off	5:off	6:off
[root@fermicloud046 ~]#
</pre>

---+++What happens behind the scenes?
It reads the =/etc/edg-mkgridmap.conf= configuration file, and contacts VOMS server (for each VO that is uncommented ) to retrieve list of all users that belong to that VO. It then, reads =/etc/osg/local-user-vo-map= file to see if there are any local users that you may have defined on your site. If you have defined such local users, it will append them to the list of users that it already has. The resulting file =/var/lib/osg/user-vo-map= will contain the complete list of all the users that you wished to support *minus* the users for which you do not (currently) have account on your machine . Each line in this file is a mapping between the user DN and the local user to which the user got mapped to.
So, for example, if you wish to support users from "fermilab" and "cdf" VOs, but on your machine, only have account for "fermilab" user, then in the resulting =/var/lib/osg/user-vo-map= file, you will only see entry like
<pre class="rootscreen">
[root@fermicloud046 ~]# cat /var/lib/osg/user-vo-map
# User-VO map
# Generated by generate-vo-map
# The voi line is used by MonaLISA, and is the lower-case version of all VO names
# The VOc line is used by MonaLISA, and is the proper-case version of all VO names
# Other lines are of the form <account> <VO>

#voi cdf fermilab 
#VOc CDF FERMILAB 

fermilab fermilab
[root@fermicloud046 ~]# 
</pre>
---++ Disabling
     If, for some reason, you want to disable the automatic execution of =edg-mkgridmap=, run following command
     <pre class="rootscreen">
[root@fermicloud046 ~]# /sbin/service edg-mkgridmap stop
Disabling periodic edg-mkgridmap:                          [  OK  ]
[root@fermicloud046 ~]#
     </pre>

---++ Troubleshooting
Troubleshooting information on edg-mkgridmap can be found [[https://www.opensciencegrid.org/bin/view/ReleaseDocumentation/EdgMkgridmapTroubleshootingGuide][here]]
*Note to Self* - The troubleshooting document needs update. It assumes pacman based installations.

<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = NehaSharma

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = Security

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = HowTo
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %NO%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %NO%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %NO%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = AlainRoy
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %IN_PROGRESS%

############################################################################################################
-->
-- Main.NehaSharma - 18 Jun 2012
