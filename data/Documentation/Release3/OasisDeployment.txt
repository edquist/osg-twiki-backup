%META:TOPICINFO{author="JoseCaballero" date="1413318491" format="1.1" reprev="1.6" version="1.6"}%
*WORK IN PROGRESS!!!*

*WORK IN PROGRESS!!!*

*WORK IN PROGRESS!!!*

*WORK IN PROGRESS!!!*

---+!! %SPACEOUT{ "Deployment of OASIS 2" }%
<!--
%DOC_STATUS_TABLE%
-->

%TOC{depth="3"}%

---# About this Document
This document describes how to install and configure OASIS 2 in a server host, an user login host, and a replica host.  

%INCLUDE{"Documentation/DocumentationTeam/DocConventions" section="Header"}%
%INCLUDE{"Documentation/DocumentationTeam/DocConventions" section="CommandLine"}%

---# Applicable versions
The applicable software versions for this document are OASIS 2.0.0 and, as requirements, CVMFS server 2.0.x and 2.1.x.

---# Requirements
QUESTION: Do we need an specific requirement section, or they are already explained in other twikies (CVMFS, ...) and can be linked???

---# Install Instructions

These instructions apply to the 3 hosts, if needed: the server host, the user login host, and the replica host. 
In the case of the server host and the replica host, CVMFS need to be installed first. 
Instructions to install CVMFS can be found here [[https://twiki.grid.iu.edu/bin/view/Documentation/Release3/InstallCvmfsStratum1][here]]

Install the OASIS RPM:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% yum -y install oasis</pre>

*TEMPORARY SOLUTION:*

as the RPM is not yet available in the OSG repo, meanwhile it can be installed from source code:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% mkdir src
%UCL_PROMPT_ROOT% cd src
%UCL_PROMPT_ROOT% svn co http://svn.usatlas.bnl.gov/svn/oasis/oasis-server/trunk/ .
%UCL_PROMPT_ROOT% python setup.py bdist_rpm
%UCL_PROMPT_ROOT% rpm -Uhv dist/oasis-2.0.0-1.noarch.rpm
</pre>


---# Configuration

---## Hosts configuration

The instructions in the next sections applies to both the user login host and the server host, if they are separate hosts. The content of the OASIS configuration files in both hosts *must be identical*.

No configuration is needed for the replica host. 

---## Configuration files

The same configuration must be identical in the user login host and the server host. No configuration is needed for the replica host. 

There are at least 3 configuration files: the oasis.conf, the oasisprojects.conf, the oasisprobes.conf.
Then, for each project (typically a VO, but not necessarily), there is a dedicated {project}probes.conf.

The format of the configuration files is similar to the Microsoft INI files. 
The configuration file consists of sections, led by a =[section]= header and followed by =name: value= entries, with continuations in the style of [[http://tools.ietf.org/html/rfc822.html][RFC 822]] (see section 3.1.1, “LONG HEADER FIELDS”); =name=value= is also accepted. Note that leading whitespace is removed from values. The optional values can contain format strings which refer to other values in the same section, or values in a special =[DEFAULT]= section. Additional defaults can be provided on initialization and retrieval. Lines beginning with '#' or ';' are ignored and may be used to provide comments.

Configuration files may include comments, prefixed by specific characters (# and ;). Comments may appear on their own in an otherwise empty line, or may be entered in lines holding values or section names. In the latter case, they need to be preceded by a whitespace character to be recognized as a comment. (For backwards compatibility, only ; starts an inline comment, while # does not.)

It supports interpolation. This means values can contain format strings which refer to other values in the same section, or values in a special =[DEFAULT]= section. Additional defaults can be provided on initialization.

As the python package !ConfigParser is being used to digest the configuration files, a wider explanation and examples can be found in the [[https://docs.python.org/2/library/configparser.html][python documentation page]].

---### Location of the configuration files

After installing OASIS 2 from RPM, examples of the configuration files are located under directory =/usr/share/doc/oasis-2.x.y/=.
They need to be copied to the real destination. At least =oasis.conf= *must* be placed under =/etc/oasis/=. Therefore, it is a good practice, for consistency, to place all of them at the same path. 

<pre class="rootscreen">
%UCL_PROMPT_ROOT% cp /usr/share/doc/oasis-2.0.0/oasis.conf-example /etc/oasis/oasis.conf
%UCL_PROMPT_ROOT% cp /usr/share/doc/oasis-2.0.0/oasisprojects.conf-example /etc/oasis/oasisprojects.conf
%UCL_PROMPT_ROOT% cp /usr/share/doc/oasis-2.0.0/oasisprobes.conf-example /etc/oasis/oasisprobes.conf
</pre>

Also the sysconfig file and the logrotation file need to be copied from the same place to final destination.
In the case of the login host:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% cp /usr/share/doc/oasis-2.0.0/oasis.logrotate-login-example /etc/logrotate.d/oasis
</pre>

In the case of the server host:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% cp /usr/share/doc/oasis-2.0.0/oasis.sysconfig-example /etc/sysconfig/oasis
%UCL_PROMPT_ROOT% cp /usr/share/doc/oasis-2.0.0/oasis.logrotate-server-example /etc/logrotate.d/oasis
</pre>


---### Configuring /etc/oasis/oasis.conf

It is the main configuration file for OASIS. 

It has a single section, called *[OASIS]*. This head section name can not changed.

| *Variable* | *Description* | *Mandatory* |
| =sleep= | it is the time between cycles for the daemon, waiting to see if all threads, one per Project, need to be shutdown Time is expressed in seconds.  | MANDATORY |
| =email= | email address to notify CRITICAL events | OPTIONAL |
| =SMTPServer= | SMTP server to be used to send email notifications | OPTIONAL |
| =projectsconf= | path to the oasisproject.conf configuration file | MANDATORY |
| =probesconf= | path to the configuration file with generic OASIS probes | MANDATORY |
| =flagfilebasedir= | path to the flagfiles. *WARNING*: in the case where the user login host is a different machine than the server hosts, this path *must* be in a shared filesystem. Default: =/var/run/oasis/= | OPTIONAL |

A typical configuration file looks like this:

<pre class="file">
[OASIS]

sleep = 100 
email = neo@matrix.net
SMTPServer = server
projectsconf = /etc/oasis/oasisprojects.conf
probesconf = /etc/oasis/oasisprobes.conf
</pre>


---### Configuring /etc/oasis/oasisprojects.conf

 Configuration file for Projects. The filename is the value of the variable =projectsconf= from the =oasis.conf= file.
A Project is each particular setup for content that needs to be distributed together, and separate from the rest *FIXME: FIND A BETTER WAY TO EXPLAIN IT* .Typically a Project corresponds to a Virtual Organization (VO), but not always.

 This configuration file has a section per Project. The name of the section has no meaning, it is just a string. 

| *Variable* | *Description* | *Mandatory* |
| =VO= | The Virtual Organization, when makes sense. | NOT MANDATORY, unless it is being used for interpolation in other variables. |
| =OSG_APP= | for legacy reasons, we maintain the environment variable $OSG_APP | MANDATORY if it is being used for interpolation in other variables, or in case the jobs expect the environment to have a variable $OSG_APP. |
| =user= | the UNIX ID of the entity calling oasisCLI or the UNIX ID the daemon needs to drop privileges to.  It will be the only UNIX ID allowed to do some tasks, e.g. to write in the project scratch area.| MANDATORY |
| =projectname= | the name of the project, typically the same than the VO.  *WARNING*: unless having a strong reason against it, use the same value than =VO=. Several parts in the code may still be mixing VO and project to calculate paths.  Therefore, the recommended value is  =projectname = %(VO)s= | MANDATORY |
| =srcdir= | path to the project scratch area.  It is the place where the user payload will put new content.  Unless very unique conditions, it should be the same than %(OSG_APP)s/&lt;vo&gt; if that is not the case, then the installation jobs will write new content under  $OSG_APP/&lt;vo&gt; but the transfer tool will copy from a different place. | MANDATORY |
| =destdir= | path to the final place for the files to be distributed.  Examples: <BR><UL><LI>for cvmfs 2.0 is /cvmfs/oasis.opensciencegrid.org/&lt;vo&gt;,</LI><LI>for cvmfs 2.1 is  /cvmfs/&lt;vo&gt;.opensciencegrid.org/ </LI></UL> | MANDATORY |
| =destdiruser= | the owner of the destination tree filesystem.  Typically, the owner of the CVMFS repository. | MANDATORY only when distribution tool is cvmfs21 |
| =projectprobesconf= | path to the configuration files for probes | MANDATORY. *NOTE*: the file can be left blank if no probes needed. |
| =sleep= | time between cycles for each thread (one per project) Time is expressed in seconds | MANDATORY |
| =starttimeout= | maximum time to wait when process detects there is a flagfile, so a previous installation and publishing task is still going on.  The current process can wait a little bit, but not forever.  Time is expressed in seconds | MANDATORY |
| =finishtimeout= | maximum time the user process can stay waiting for the daemon process to finish.  When the user process runs the installation payload it leaves a flagfile asking for publication.  The daemon process will see that flagfile, run probes on the new content, transfer files to final place, publish them, and notify the user process (via the same flagfile) everything is done. This waiting time needs a timeout.  Time is expressed in seconds | MANDATORY |
| =distributiontool= | it is the name of the plugin with code to interact with the 3rd party underlying technology for files distribution.  Current options are: cvmfs20 = code to interact with CVMFS server version 2.0.x cvmfs21 = code to interact with CVMFS server version 2.1.x | MANDATORY |

A typical configuration file looks like this:

<pre class="file">
[DEFAULT]

OSG_APP = /home/data/
projectname = %(VO)s
srcdir = %(OSG_APP)s/%(projectname)s
destdir = /cvmfs/%(projectname)s.opensciencegrid.org 
distributiontool = cvmfs21
sleep = 100 
starttimeout = 600 
finishtimeout = 600 
destdiruser = oasis

enabled = True

[PROJECT1]
VO = vo1
user = user1
projectprobesconf = /etc/oasis/proj1probes.conf

[PROJECT2]
VO = vo2 
user = user2
projectprobesconf = /etc/oasis/proj2probes.conf
</pre>



---### Configuring /etc/oasis/oasisprobes.conf

It is the configuration file with generic probes for all projects. It can be left blank if no probes are needed, but the file must exists. The filename is the value of the variable =probesconf= from the =oasis.conf= file.

The section name is just an unique string, it is not the actual name of the probe. This allows to have several probes of the same type, but with different sets of parameters. 


| *Variable* | *Description* | * Mandatory * |
| =probe= | is the actual name of probe.  The probe code will be invoked by a wrapper whose name is /usr/bin/oasis-runprobe-&lt;probe&gt; where &lt;probe&gt; is the value of this variable 'probe' In case of a project-specific probe, therefore, it can be something like  &lt;project&gt;-&lt;probe&gt;, which will be invoked by wrapper /usr/bin/oasis-runprobe-&lt;project&gt;-&lt;probe&gt; | MANDATORY |
| =options= | list of input options to be passed raw to the probe | OPTIONAL |
| =enabled= | True/False variable.  The probe is only executed is enabled = True | MANDATORY |
| =level= | warning/abort. If warning, just logs a WARNING message, but return 0 (OK) if abort, logs a CRITICAL message and return 1 (probe failed) or some other RC | MANDATORY |
 
A typical configuration file looks like this:

<pre class="file">
[DEFAULT]
enabled = True

[probe1]
probe = probename1 
options = "foo"
level = warning

[probe2]
probe = probename2 
level = abort
</pre>

---### Configuring /etc/oasis/&lt;project&gt;probes.conf

Each Project requires a dedicated configuration file for the specific probes that only apply to that project. It can be left blank if no probes are needed, but the file must exists. The filename is the value of the variable =projectprobesconf= from the =oasisprojects.conf= file.
The format is the same than =oasisprobes.conf= 

---# Creating the project

After the configuration files have been properly setup, each project has to be created. 

<pre class="rootscreen">
%UCL_PROMPT_ROOT% oasis-admin-projectadd --help
oasis-admin-projectadd:
 
 Syntax:
     oasis-admin-projectadd [--help|-h] [--verbose|-v] [--project &lt;name&gt;]
 
 Description:
     prepares everything to start working with a new project.
     Creates, if needed, the UNIX user account,
     the scratch directory and destination directory.
     For the destination directory, a new repository in CVMFS is created if needed.
     All the needed information to create the project is read 
     from the "projects" configuration file.
     The value of input option --project must match the value
     of variable "project" in configuration file oasisprojects.conf
 
 Options:               
     --help | -h         Displays usage and exits 
     --verbose | -v      Enters in DEBUG mode for the logging
     --project &lt;name&gt;    Name of the project being created

%UCL_PROMPT_ROOT% oasis-admin-projectadd --project &lt;projectname&gt; </pre>

This command will create the UNIX ID account =user=, the user scratch area =srcdir=, and the destination area =destdir=.

---# Start

Once the configuration files have been properly setup, and the projects have been created, the oasis daemon must be started on the server host:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% service oasisd start
</pre>


-- Main.JoseCaballero - 08 Oct 2014



























