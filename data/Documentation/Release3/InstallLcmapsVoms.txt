%META:TOPICINFO{author="BrianLin" date="1496246601" format="1.1" reprev="1.6" version="1.6"}%
%META:TOPICPARENT{name="WebHome"}%
<style type="text/css">
code em, pre em { color: red; font-weight: normal; font-style: normal; }
</style>

<div style="border: 1px solid black; margin: 1em 0; padding: 1em; background-color: #FFDDDD; font-weight: 600;">
---+!! Draft Documentation
Consider this document to be a late draft: The technical content has been reviewed, and is *mostly* complete and accurate. Here are the known missing sections of the document now:
   * Verification section
   * GUMS and edg-mkgridmap transition instructions
</div>

---+ Installing and Maintaining the LCMAPS VOMS Plugin
%TOC%

---++ About This Guide

LCMAPS is a software library for using grid credentials of incoming jobs to map jobs to specific Unix accounts. The LCMAPS VOMS plugin enables LCMAPS to make mapping decisions based on the VOMS attributes of grid credentials, e.g., <code>/cms/Role=production/Capability=NULL</code>.

The OSG provides a default set of mappings from VOMS attributes to Unix accounts. By configuring LCMAPS, you can override these mappings, including changing the Unix account that a VO is mapped to, banning a VO, banning a specific user, or adding a VO that is not in the OSG's set of mappings.

Use this page to learn how to install and configure the LCMAPS VOMS plugin to authorize users to access your resources on a per-VO basis.


---++ Requirements

%INCLUDE{"Documentation/Release3.DocumentationSnippets" section="OsgPreReqs"}%

---++ Installing the LCMAPS VOMS Plugin

Install =lcmaps=, the default mapfile, and the configuration tools:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% yum install lcmaps vo-client-lcmaps-voms osg-configure-misc
</pre>

---++ Configuring the LCMAPS VOMS Plugin

%WARNING%%RED%TODO I've tested this on a CE, but not on e.g. a !GridFTP node with just the minimum software installed. -matyas%ENDCOLOR%

---+++ Enabling the LCMAPS VOMS plugin with osg-configure

To configure your host to use LCMAPS VOMS plugin authorization, 

   1. If you are installing authorization on an OSG 3.3 CE, add the following line to =/etc/sysconfig/condor-ce=:\
<pre class="file">export LLGT_VOMS_ENABLE_CREDENTIAL_CHECK=1</pre>
   1. Edit =/etc/osg/config.d/10-misc.ini= and set the following options:
   <pre class="file">glexec_location = UNAVAILABLE
edit_lcmaps_db = True
authorization_method = vomsmap</pre>

#UnixAccounts
---+++ Supporting mapped VOs and users 

Unix accounts must exist for each VO or user you choose to support in the [[#RefConfigFiles][mapfiles]]:

   1. Consult the default VO mappings in =/usr/share/osg/voms-mapfile-default= to determine the mapped Unix account names. Each of the mapfiles has the following format:\
<pre class="file">
"&lt;VO or user&gt;" &lt;Unix account&gt;
</pre>
   1. Create Unix accounts for each VO and user that you wish to support
   1. Edit =/etc/osg/config.d/40-siteinfo.ini= and specify the supported VOs per [[Documentation.Release3/IniConfigurationOptions#Subcluster_Resource_Entry_Config][Subcluster or ResourceEntry section]]:\
<pre class="file">
allowed_vos="VO1,VO2..."
</pre>

---+++ Applying configuration settings

Making changes to the OSG configuration files in the =/etc/osg/config.d= directory does not apply those settings to software automatically. For the OSG settings, use the [[IniConfigurationOptions][osg-configure]] tool to validate (to a limited extent) and apply the settings to the relevant software components. The =osg-configure= software is included automatically in an HTCondor-CE installation.

   1. <p>Make all changes to =.ini= files in the =/etc/osg/config.d= directory</p>\
       <p><strong>Note:</strong> This document describes the critical settings for the LCMAPS VOMS plugin and related software. You may need to configure other software that is installed on your host, too.</p>
   1. Validate the configuration settings:\
<pre class="rootscreen">%UCL_PROMPT% osg-configure -v</pre>
   1. Once the validation command succeeds without errors, apply the configuration settings:\
<pre class="rootscreen">%UCL_PROMPT% osg-configure -c</pre>

#OptionalConfig
---+++ Optional configuration

You can map or ban users by their certificates' Distinguished Names (DNs) or by their proxies' VOMS attributes; see the following subsections. For a table of the configuration files and their order of evaluation, consult the [[#RefConfigFiles][reference section]].

   * [[#OptionalMapVos][Mapping VOs]]
   * [[#OptionalMapUsers][Mapping users]]
   * [[#OptionalBanVos][Banning VOs]]
   * [[#OptionalBanUsers][Banning users]]

#OptionalMapVos
---++++ Mapping VOs

=/etc/grid-security/voms-mapfile= is used to map VOs to Unix accounts based on their VOMS attributes. An example of the format of a =voms-mapfile= follows:

<pre class="file">
# map GLOW jobs to the 'glow' Unix account.
"/GLOW/*" glow
</pre>

Each non-commented line is a shell-style pattern which is compared against the user's VOMS attributes, and a Unix account that the user will be mapped to if the pattern matches.

%NOTE%The Unix account must exist for the user to be mapped. If a VO's Unix account is missing, that VO will not be able to access your resources.

#OptionalMapUsers
---++++ Mapping users

=/etc/grid-security/grid-mapfile= is used to map specific users to Unix accounts based on their certificates' DNs. An example of the format of a =grid-mapfile= follows:

<pre class="file">
# map Matyas's FNAL DN to the 'matyas' Unix account
"/DC=gov/DC=fnal/O=Fermilab/OU=People/CN=Matyas Selmeci/CN=UID:matyas" matyas
</pre>

%NOTE%The Unix account must exist for the user to be mapped. If a user's Unix account is missing, that user will not be able to access your resources.

#OptionalBanVos
---++++ Banning VOs

=/etc/grid-security/ban-voms-mapfile= is used to ban an entire VO or a role withing a VO from accessing resources on your machine. An example of the format of a =ban-voms-mapfile= follows:

<pre class="file">
# ban CMS production jobs
"/cms/Role=production/*"
</pre>

Each non-commented line is a shell-style pattern which is compared against a user's VOMS attributes. If the pattern matches, that user will be unable to access your resources.

%WARNING%=/etc/grid-security/ban-voms-mapfile= _must_ exist, even if you are not banning any VOs. In that case, the file should be blank. If the file does not exist, LCMAPS will ban every user.

#OptionalBanUsers
---++++ Banning users

=/etc/grid-security/ban-mapfile= is used to ban specific users from accessing your resources based on their certificates' DNs. An example of the format of a =ban-mapfile= follows:

<pre class="file">
# ban Matyas's FNAL DN
"/DC=gov/DC=fnal/O=Fermilab/OU=People/CN=Matyas Selmeci/CN=UID:matyas"
</pre>

%WARNING%=/etc/grid-security/ban-mapfile= _must_ exist, even if you are not banning any users. In that case, the file should be blank. If the file does not exist, LCMAPS will ban every user.

---++ Verifying the LCMAPS VOMS Plugin

_Coming soon..._

---++ Reference

#RefConfigFiles
---+++ Configuration Files

The files are evaluated in the following order, with earlier files taking precedence over later ones:

| *File*                                | *Provider* | *Purpose*         |
| =/etc/grid-security/ban-mapfile=      | Admin      | Ban DNs           |
| =/etc/grid-security/ban-voms-mapfile= | Admin      | Ban VOs           |
| =/etc/grid-security/grid-mapfile=     | Admin      | Map DNs           |
| =/etc/grid-security/voms-mapfile=     | Admin      | Map VOs           |
| =/usr/share/osg/voms-mapfile-default= | OSG        | Map VOs (default) |

#RefManConfig
---+++ Manual Configuration

LCMAPS is configured in =/etc/lcmaps.db=. Since the VOMS plugin is a new component, configuration for it may not be present in the existing =/etc/lcmaps.db= file.

You will need to make sure the following lines are present in the "Module definitions" section (the top section, before =authorize_only=) of =/etc/lcmaps.db=:

<pre class="file">
gridmapfile = "lcmaps_localaccount.mod"
              "-gridmap /etc/grid-security/grid-mapfile"
banfile = "lcmaps_ban_dn.mod"
          "-banmapfile /etc/grid-security/ban-mapfile"
banvomsfile = "lcmaps_ban_fqan.mod"
              "-banmapfile /etc/grid-security/ban-voms-mapfile"
vomsmapfile = "lcmaps_voms_localaccount.mod"
              "-gridmap /etc/grid-security/voms-mapfile"
defaultmapfile = "lcmaps_voms_localaccount2.mod"
                 "-gridmap /usr/share/osg/voms-mapfile-default"

verifyproxy = "lcmaps_verify_proxy.mod"
          "--allow-limited-proxy"
          " -certdir /etc/grid-security/certificates"

verifyproxynokey = "lcmaps_verify_proxy2.mod"
          "--allow-limited-proxy"
          "--discard_private_key_absence"
          " -certdir /etc/grid-security/certificates"
</pre>

Then, you will need to make sure that the =authorize_only= section contains only the following uncommented lines:
<pre class="file">
verifyproxynokey -&gt; banfile
banfile -&gt; banvomsfile | bad
banvomsfile -&gt; gridmapfile | bad
gridmapfile -&gt; good | vomsmapfile
vomsmapfile -&gt; good | defaultmapfile
defaultmapfile -&gt; good | bad
</pre>

In addition, you will need to edit =/etc/grid-security/gsi-authz.conf= and ensure it contains the following uncommented line:<pre class="file">
globus_mapping liblcas_lcmaps_gt4_mapping.so lcmaps_callout
</pre>


%META:TOPICMOVED{by="MatyasSelmeci" date="1494453594" from="Documentation/Release3.LcmapsVoms" to="Documentation/Release3.InstallLcmapsVoms"}%
