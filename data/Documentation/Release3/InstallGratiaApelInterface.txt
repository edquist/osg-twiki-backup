%META:TOPICINFO{author="JohnWeigand" date="1365520242" format="1.1" reprev="1.1" version="1.1"}%
%DOC_STATUS_TABLE%



---+!! Install Gratia-APEL Interface
%TOC%

<!-- conventions used in this document
   * Set APEL_FAQ=[[https://twiki.cern.ch/twiki/bin/view/EMI/APELFAQ][APEL FAQ and Troubleshooting]]
   * Set APEL_SERVER=[[https://wiki.egi.eu/wiki/APEL/Server][APEL Server]]
   * Set APEL_SUMMARY_RECS=[[https://wiki.egi.eu/wiki/APEL/MessageFormat#Summary_Job_Records][APEL Job Summary Records]]
   * Set EGI_PORTAL                        = [[http://accounting.egi.eu/osg.php][EGI Accounting Portal]]
   * Set EGI_PORTAL_OSG_VIEW   = [[http://accounting.egi.eu/osg.php][EGI Accounting Portal - OSG view]]
   * Set EGI_PORTAL_TIER1_VIEW = [[http://accounting.egi.eu/tier1.php][EGI Accounting Portal - Tier 1 view]]
   * Set EGI_PORTAL_TIER2_VIEW = [[http://accounting.egi.eu/tier2.php][EGI Accounting Portal - Tier 2 view]]
   * Set EGI_PORTAL_USER_VIEW = [[http://www3.egee.cesga.es/gridsite/accounting/CESGA/user/user_view.html][EGI Accounting Portal - User view]]
   * Set EGI_PORTAL_VOMEMBER_VIEW = [[https://accounting.egi.eu/user/vomem.php][EGI Accounting Portal - VO Member view]]
   * Set OIM_HOME= [[http://oim.grid.iu.edu/][OIM (OSG Information Management System)]]
   * Set MYOSG_HOME= [[http://myosg.grid.iu.edu/about][MyOSG]]

   * Local UCL_HOST = %URLPARAM{"INPUT_HOST" encode="quote" default="gratia"}%
   * Local UCL_USER = %URLPARAM{"INPUT_USER" encode="quote" default="user"}%
   * Local UCL_DOMAIN = %URLPARAM{"INPUT_DOMAIN" encode="quote" default="opensciencegrid.org"}%
   * Set TWISTY_OPTS_DETAILED = mode="div" showlink="Show Detailed Output" hidelink="Hide" showimgleft="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" hideimgleft="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" remember="on" start="hide" 
-->


%STARTINCLUDE%
%EDITTHIS%

---+ About this Document
This document is for the individual or group responsible for running the interface between Gratia and the APEL/WLCG/EGI accounting systems.
Here we describe how to install and configure the Gratia-APEL interface on a Linux machine.
When you install this service, as described here, You get all parts: !MySQL client, httpd, APEL SSM and the Gratia-APEL interface service.

This is currently only supported on an EL5 (Red Hat Enterprise Linux 5-based OS, including Red Hat Enterprise Linux 5-based OS).

---+ Introduction
Accounting records collected by Gratia are forwarded to the EGI accounting system, APEL. This is important for US-LHC Tier1 and Tier2 facilities which have to demonstrate to the LHC project delivered computing resources on behalf of ATLAS, CMS and ALICE collaborations, in accordance with signed Memorandum of Understanding agreements. The software parses and analyzes Gratia accounting records for an OSG __resource_group__ , scales wall time and cpu usage into <nop>HepSpec2006 for the processor type, and then forwards this data to the %APEL_SERVER% at the EGI GOC

The APEL Accounting Portal at RAL has been storing CPU accounting results for WLCG.  On behalf on the ATLAS, CMS and ALICE Tier 1 and Tier 2 that are part of OSG, OSG uploads usage information from Gratia to the APEL accounting system.  This OSG data can be viewed in the 
%EGI_PORTAL_OSG_VIEW%.  APEL is using OSG __resource groups__  registered in %OIM_HOME% and viewable in %MYOSG_HOME%

---+ Requirements

---++ Host and OS
   * A host to install the Gratia Service (Pristine node desired)
   * OS is %SUPPORTED_OS%. The APEL/SSM interface software is currently only supported on EL5
   * Root access

---++ Users
At this time, _root_ user is the only one configured to run this interface.
| *User* | *Default uid* | *Comment* |
| =root= | 0 | Runs the interface (cron) and owns the service certificate and configuration files |

---++ Certificates
You will need one service certificate.  This is a requirement of the APEL/SSM protocol.  
This certificate must be registered with the EGI broker network.
You can use a host certificate but the advantage of using a service certificate allows you to port the interface to another node without
re-registering it with APEL. Instructions for requesting a certificate can be found [[GetHostServiceCertificates][Here]].

| *Certificate* | *User that owns certificate* | *Path to certificate* |
| Service certificate | =root= | =/etc/grid-security/gratia-apelcert.pem= <br> =/etc/grid-security/gratia-apelkey.pem= |


Before you can send your messages to the APEL server, you must send your certificate DN to the APEL-SUPPORT@JISCMAIL.AC.UK 
mailing list, e.g. output from running:
<pre class="screen">
openssl x509 -subject -noout -in your_cert_pem_file
</pre>

---+ Installation Procedure

%INCLUDE{"YumRepositories" section="OSGRepoBrief" TOC_SHIFT="+"}%

%INCLUDE{"InstallCertAuth" section="OSGBriefCaCerts" TOC_SHIFT="+"}%

---++ Install the Gratia-APEL interface
:<pre class="rootscreen">
%UCL_PROMPT_ROOT% yum install gratia-apel
</pre>
%TWISTY{%TWISTY_OPTS_DETAILED%}%   <pre class="rootscreen">
%UCL_PROMPT_ROOT% yum install gratia-apel
Loaded plugins: kernel-module, priorities
Excluding Packages from SLF 5 base
Finished
Reducing SLF 5 base jdk to included packages only
Finished
Excluding Packages from SLF 5 security updates
Finished
Reducing SLF 5 security updates jdk only to included packages only
Finished
Excluding Packages from SL 5 base
Finished
Reducing SL 5 base jdk to included packages only
Finished
1106 packages excluded due to repository priority protections
Setting up Install Process
Examining /root/APEL-RPMS/gratia-apel-0.10-1.noarch.rpm: gratia-apel-0.10-1.noarch
Marking /root/APEL-RPMS/gratia-apel-0.10-1.noarch.rpm to be installed
Resolving Dependencies
--> Running transaction check
---> Package gratia-apel.noarch 0:0.10-1 set to be updated
--> Processing Dependency: fetch-crl3 for package: gratia-apel
--> Processing Dependency: httpd for package: gratia-apel
--> Processing Dependency: mysql for package: gratia-apel
--> Processing Dependency: osg-ca-certs for package: gratia-apel
--> Processing Dependency: osg-version for package: gratia-apel
--> Processing Dependency: python-daemon for package: gratia-apel
--> Processing Dependency: python-ldap for package: gratia-apel
--> Processing Dependency: stomppy for package: gratia-apel
--> Running transaction check
---> Package fetch-crl3.noarch 0:3.0.7-1.el5 set to be updated
---> Package httpd.x86_64 0:2.2.3-74.sl5 set to be updated
--> Processing Dependency: libaprutil-1.so.0()(64bit) for package: httpd
--> Processing Dependency: libapr-1.so.0()(64bit) for package: httpd
---> Package mysql.x86_64 0:5.0.95-5.el5_9 set to be updated
--> Processing Dependency: perl(DBI) for package: mysql
---> Package osg-ca-certs.noarch 0:1.33-1.osg.el5 set to be updated
---> Package osg-version.noarch 0:3.1.15-1.osg.el5 set to be updated
---> Package python-daemon.noarch 0:1.5.2-3.el5 set to be updated
--> Processing Dependency: python-lockfile for package: python-daemon
---> Package python-ldap.x86_64 0:2.2.0-2.1 set to be updated
---> Package stomppy.noarch 0:3.0.3-1.el5.1 set to be updated
--> Processing Dependency: python-ssl for package: stomppy
--> Running transaction check
---> Package apr.x86_64 0:1.2.7-11.el5_6.5 set to be updated
---> Package apr-util.x86_64 0:1.2.7-11.el5_5.2 set to be updated
--> Processing Dependency: libpq.so.4()(64bit) for package: apr-util
---> Package perl-DBI.x86_64 0:1.52-2.el5 set to be updated
---> Package python-lockfile.noarch 0:0.8-3.el5 set to be updated
---> Package python-ssl.x86_64 0:1.15-3.el5 set to be updated
--> Running transaction check
---> Package postgresql-libs.x86_64 0:8.1.23-6.el5_8 set to be updated
--> Finished Dependency Resolution
Beginning Kernel Module Plugin
Finished Kernel Module Plugin

Dependencies Resolved

================================================================================
 Package          Arch    Version             Repository                   Size
================================================================================
Installing:
 gratia-apel      noarch  0.10-1              /gratia-apel-0.10-1.noarch   28 M
Installing for dependencies:
 apr              x86_64  1.2.7-11.el5_6.5    sl-base                     119 k
 apr-util         x86_64  1.2.7-11.el5_5.2    sl-base                      79 k
 fetch-crl3       noarch  3.0.7-1.el5         epel                         45 k
 httpd            x86_64  2.2.3-74.sl5        fermi-security              1.3 M
 mysql            x86_64  5.0.95-5.el5_9      fermi-security              4.9 M
 osg-ca-certs     noarch  1.33-1.osg.el5      osg                         290 k
 osg-version      noarch  3.1.15-1.osg.el5    osg                         3.8 k
 perl-DBI         x86_64  1.52-2.el5          sl-base                     605 k
 postgresql-libs  x86_64  8.1.23-6.el5_8      fermi-security              197 k
 python-daemon    noarch  1.5.2-3.el5         epel                         29 k
 python-ldap      x86_64  2.2.0-2.1           sl-base                     123 k
 python-lockfile  noarch  0.8-3.el5           epel                         18 k
 python-ssl       x86_64  1.15-3.el5          epel                         26 k
 stomppy          noarch  3.0.3-1.el5.1       epel                         38 k

Transaction Summary
================================================================================
Install      15 Package(s)
Upgrade       0 Package(s)

Total size: 35 M
Total download size: 7.7 M
Downloading Packages:
--------------------------------------------------------------------------------
Total                                           7.2 MB/s | 7.7 MB     00:01
Running rpm_check_debug
Running Transaction Test
Finished Transaction Test
Transaction Test Succeeded
Running Transaction
Installing     : apr                                                     1/15 
Installing     : python-ldap                                             2/15 
Installing     : python-ssl                                              3/15 
Installing     : postgresql-libs                                         4/15 
Installing     : apr-util                                                5/15 
Installing     : httpd                                                   6/15 
Installing     : perl-DBI                                                7/15 
Installing     : mysql                                                   8/15 
Installing     : stomppy                                                 9/15 
Installing     : python-lockfile                                        10/15 
Installing     : python-daemon                                          11/15 
Installing     : osg-ca-certs                                           12/15 
Installing     : fetch-crl3                                             13/15 
Installing     : osg-version                                            14/15... in pre
Installing     : gratia-apel                                            15/15 

Installed:
  gratia-apel.noarch 0:0.10-1                                                   

Dependency Installed:
  apr.x86_64 0:1.2.7-11.el5_6.5            apr-util.x86_64 0:1.2.7-11.el5_5.2
  fetch-crl3.noarch 0:3.0.7-1.el5          httpd.x86_64 0:2.2.3-74.sl5
  mysql.x86_64 0:5.0.95-5.el5_9            osg-ca-certs.noarch 0:1.33-1.osg.el5
  osg-version.noarch 0:3.1.15-1.osg.el5    perl-DBI.x86_64 0:1.52-2.el5
  postgresql-libs.x86_64 0:8.1.23-6.el5_8  python-daemon.noarch 0:1.5.2-3.el5
  python-ldap.x86_64 0:2.2.0-2.1           python-lockfile.noarch 0:0.8-3.el5
  python-ssl.x86_64 0:1.15-3.el5           stomppy.noarch 0:3.0.3-1.el5.1

Complete!
</pre> %ENDTWISTY%

---+ Configure

---++ Configure SSM using test broker
When the SSM software is initially installed, the default configuration is set to talk to the SSM
test broker/services and SSM needs to be run once to create some directories.

You will need the service certificate you previously installed and will need to modify the SSM config files
for that service certificate:

__/etc/gratia-apel/ssm/ssm.cfg__
<pre class="file">
   :
################################################################################
# Required: Certificate configuration
[certificates]
#certificate: /etc/grid-security/hostcert-ssm.pem
#key: /etc/grid-security/hostkey-ssm.pem
certificate: %RED%your_service_cert_file%ENDCOLOR%
key: /etc/grid-security/%RED%your_service_cert_file%ENDCOLOR%
cadir: /etc/grid-security/certificates
check-crls: false
   :
</pre>




---+ Services

---+ Test


---+ Troubleshooting

---+ How to get Help?
To get assistance, please use [[HelpProcedure][Help Procedure]].

---+ References
Gratia Documents
   * [[Accounting/WebHome][Accounting Web/The Gratia project]]
   * [[Accounting/GratiaInterfacesApelLcg][Gratia Interfaces- APEL/WLCG]]
   * [[Accounting/ApelWlcgDevelopersCorner][APEL/WLCG Developers Corner twiki]].

APEL Documents
   * [[https://wiki.egi.eu/wiki/APEL/SSM][APEL SSM]]
   * [[https://wiki.egi.eu/wiki/APEL/Server][APEL/Servier]]


---+ Comments
%COMMENT{type="tableappend"}%


%STOPINCLUDE%

<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
---++!! Major updates
<!--Future editors should add their signatures beneath yours!-->
-- Main.JohnWeigand - 08 Apr 2013
