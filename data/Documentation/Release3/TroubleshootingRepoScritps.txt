%META:TOPICINFO{author="TimCartwright" date="1453327482" format="1.1" version="1.2"}%
---+ Troubleshooting Guide for Yum Repository Scripts

%TOC{depth="3"}%

---++ About This Guide

The =repo1.grid.iu.edu= and =repo2.grid.iu.edu= hosts contain the OSG Yum software repositories plus related services and tools. In particular, the =mash= software is used to download RPMs from where they are built (at the University of Wisconsin–Madison), and there are some associated scripts to configure and invoke =mash= periodically. Use this guide to monitor the =mash= system for problems and to perform basic troubleshooting when such problems arise.

---++ Monitoring 

To monitor the repository hosts for proper =mash= operation, do the following steps on each host:

   1. Access the =mash= update log at http://repo1.grid.iu.edu/web/log/ or http://repo2.grid.iu.edu/web/log/
   1. Examine the “Last modified” timestamp for 

---+++ Repos not updating

You should see up-to-date timestamps on all the update log files for repo1 and repo2:

http://repo1.grid.iu.edu/web/log/<br/>
http://repo2.grid.iu.edu/web/log/

If one or both of them show these logs behind more than a couple hours (and more obviously, multiple days), while the =update_all_repos.err= log file has a current timestamp, there is a good chance that a mash process has hung and future runs scheduled in cron can't acquire a lock.

In this case the =update_all_repos.err= log may have an error message like:

<pre class="file">
Wed %RED%Jan 20%ENDCOLOR% 18:10:02 UTC 2016: Can't acquire lock, is update_all_repos.sh already running?
</pre>

If =ps= shows a =mash= processes running from (say) a previous day, killing its process group tends to be enough to allow new repo updates to run.

For example:

<pre class="rootscreen">
[0] 18:53:13 UTC [root@repo2:~]# ps -C %BLUE%mash%ENDCOLOR% -o pid,ppid,pgid,start,command
  PID  PPID  %GREEN%PGID%ENDCOLOR%  STARTED COMMAND
24551 24549 %GREEN%23455%ENDCOLOR%   %RED%Jan 15%ENDCOLOR% /usr/bin/python /usr/bin/%BLUE%mash%ENDCOLOR% osg-3.1-el5-release -o
24552 24551 %GREEN%23455%ENDCOLOR%   %RED%Jan 15%ENDCOLOR% /usr/bin/python /usr/bin/%BLUE%mash%ENDCOLOR% osg-3.1-el5-release -o
[0] 18:56:51 UTC [root@repo2:~]# kill -TERM -%GREEN%23455%ENDCOLOR%
[0] 18:57:20 UTC [root@repo2:~]# ps -C %BLUE%mash%ENDCOLOR% -o pid,ppid,pgid,start,command
  PID  PPID  PGID  STARTED COMMAND
[1] 18:57:23 UTC [root@repo2:~]# 
</pre>

---++ Future directions

---+++ Timeouts

We hope to add timeouts which will handle and log the case of =mash= processes hanging.
