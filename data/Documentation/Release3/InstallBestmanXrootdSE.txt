%META:TOPICINFO{author="DouglasStrain" date="1314912849" format="1.1" reprev="1.3" version="1.3"}%
%META:TOPICPARENT{name="RPMTempDocuments"}%
%LINKCSS%
---+!! %SPACEOUT{ "Install !Bestman Xrootd SE" }%
%TOC%

---+ Installing the !BeStMan !XRootD Storage Element from RPMs

This page explains how to install the !BeStMan Storage Element with underlying !XRootD storage.



---++ Requirements

   * A RHEL5 (or !CentOS 5, SL5) machine with [[http://fedoraproject.org/wiki/EPEL][EPEL]] repos enabled.
   * A working !XRootD Server.  See InstallXrootd for details.

---++ Install Instructions

Note that this package is primarily intended for Bestman-Gateway acting as an endpoint for !XRootD server.  If you have not installed an !XRootD server yet, follow the instructions in InstallXrootd.

%INCLUDE{"InstallVDTRepo" headingoffset="1"}%

---+++ Certificates 
!GridFTP, which is a part of this meta-package, requires a certificate package to run.  If you require a specific certificate package, follow the InstallCACerts instructions to install it.   If you do not install a grid certificate package first, the install procedure will install one for you as part of its dependencies.  (usually osg-ca-certs).


---++ Package installation instructions

First, you will need to install the !BeStMan Gateway !XRootD Storage element meta-package:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% yum --enablerepo=osg-development --nogpgcheck install osg-se-bestman-xrootd
</pre> 


---+++ Configuring !GridFTP GUMS support

By default, !GridFTP uses a gridmap file, found in =/etc/grid-security/gridmap-file=.
If you want to use GUMS security (recommended), you will need to enable using the following steps:

First, edit =/etc/grid-security/gsi-authz.conf= and uncomment the globus callout.
<pre class="file">
globus_mapping /usr/lib64/liblcas_lcmaps_gt4_mapping.so lcmaps_callout
</pre> 
This should be =/usr/lib64= for x86_64 architectures and =/usr/lib= for i386 architectures.

Next edit =/etc/lcmaps.db= to edit your gums information:
<pre class="file">
# Module definitions
path = /usr/lib64/modules

...
gumsclient = "lcmaps_gums_client.mod"
             "-resourcetype ce"
             "-actiontype execute-now"
             "-capath /etc/grid-security/certificates"
             "-cert   /etc/grid-security/hostcert.pem"
             "-key    /etc/grid-security/hostkey.pem"
             "--cert-owner root"
# Change this URL to your GUMS server
             "--endpoint https://*gums.fnal.gov:8443*/gums/services/GUMSXACMLAuthorizationServicePort"
</pre> 

If you would like to run SAZ, you will need to enable the relevant lines in the above file as well (more documentation to be added later).


---+++ Configuring !GridFTP !XRootD support

Edit =/etc/sysconfig/globus-gridftp-server= and uncomment and edit !XRootD information.
<pre class="file">
#############################################
# xrootd-dsi module support
#############################################
# Note: This defines the path of the posix preload mount and
# which xrootd server it points.
# NOTE:  local_path is where the access via this node (ie GridFTP)
# will be from.  remote_path refers to the path on the XRootD node.
# Uncommenting this will set the XrootD location
export XROOTD_VMP="redirector:1094:/local_path=/remote_path"

# Uncommenting these will enable xrootd posix preload support
# Set XROOTDLIB to /usr/lib64 for 64 bit architectures
# and /usr/lib for 32 bit architectures.
export XROOTDLIB=/usr/lib64
export LD_PRELOAD=$XROOTDLIB/libXrdPosixPreload.so
</pre> 
*NOTE:* The syntax of the above environment variables is a little confusing, so make sure that you 
adhere to the following directions for XROOTD_VMP:
   * Redirector:  This is the hostname and domain of the local !XRootD redirector server.
   * local_path:  This is the path used to access the !GridFTP server (ie this server).
   * remote_path:  This is the path used to access the !XRootD redirector.


Edit =/etc/gridftp.conf= and uncomment the module to load the !XRootD DSI (Data Storage Infrastructure) module.
Note: If you have not run gridftp yet, this file may be in =/etc/gridftp.conf.default=
<pre class="file">
load_dsi_module posix
</pre> 

---++ Coming soon: xrootdfs



---++Edit Bestman Settings

Bestman settings and environment variables are stored in =/etc/bestman2/conf/bestman2.rc=.
You should review these settings to make sure all of them comply with your environment.
In particular, you will likely need to modify the following settings:
<pre class="file">
BESTMAN_GUMSCERTPATH=/etc/grid-security/http/httpcert.pem
BESTMAN_GUMSKEYPATH=/etc/grid-security/http/httpkey.pem
...
localPathListAllowed=/tmp
CertFileName=/etc/grid-security/http/httpcert.pem
KeyFileName=/etc/grid-security/http/httpkey.pem
GUMSserviceURL=https://GUMS_HOST:8443/gums/services/GUMSAuthorizationServicePort
</pre>

!BeStMan requires two sets of certificate pairs.  One is for host services.  When clients connect to !BeStMan,
they will receive this certificate (*CertFileName*, *KeyFileName*) as proof of the server's identity.  The second
certificate pair (*BESTMAN_GUMSCERTPATH* and *BESTMAN_GUMSKEYPATH*) 
is used to communicate with Gums when verifying identity information.  Note: these two can 
(and usually will be) the same files, but can be split if your Gums setup requires a specific identity.

*localPathListAllowed* determines which paths users will be able to access via SRM.

Modify *GUMSserviceURL* to use your local Gums installation.

---+++ Modify =/etc/sudoers=

!BeStman requires the "sudo" command in order to write information as the proper user.
You will need to give the bestman user the proper permissions to run these commands.

Modify =/etc/sudoers= and comment the following line.
<pre class="file">
#Defaults    requiretty
</pre>

Then add the following lines at the end of the =/etc/sudoers= file.
<pre class="file">
Cmnd_Alias SRM_CMD = /bin/rm, /bin/mkdir, /bin/rmdir, /bin/mv, /bin/cp, /bin/ls
Runas_Alias SRM_USR = ALL, !root
bestman   ALL=(SRM_USR) NOPASSWD: SRM_CMD
</pre>

---+++ (Optional) Copying certificates to a bestman location

!BeStMan requires a certificate pair to function.  In order to use lcg-utils, this must be a host
certificate (rather than a service certificate).  The following shows how to copy your certificates
<pre class="rootscreen">
cp /etc/grid-security/hostkey.pem /etc/grid-security/bestman/bestmankey.pem
cp /etc/grid-security/hostcert.pem /etc/grid-security/bestman/bestmancert.pem
chown -R bestman:bestman /etc/grid-security/bestman/
</pre> 
Then modify *CertFileName*, *KeyFileName* in =/etc/bestman2/conf/bestman2.rc=.


---++ Starting and Stopping !GridFTP

Starting !GridFTP:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% service globus-gridftp-server start
</pre> 


Stopping !GridFTP:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% service globus-gridftp-server stop
</pre> 

---++ Starting and Stopping !BeStMan

Starting !BeStMan:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% service bestman2 start
</pre> 

Stopping !BeStMan:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% service bestman2 stop
</pre> 




-- Main.DouglasStrain - 29 Aug 2011
