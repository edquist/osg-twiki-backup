%META:TOPICINFO{author="DouglasStrain" date="1318371318" format="1.1" version="1.9"}%
%META:TOPICPARENT{name="InstallBestPractices"}%
%LINKCSS%
---+!! %SPACEOUT{ "Install !Bestman Xrootd SE" }%
%TOC%

---+ Installing the !BeStMan !XRootD Storage Element from RPMs

This page explains how to install the !BeStMan Storage Element with underlying !XRootD storage.



---++ Requirements

   * A RHEL5 (or !CentOS 5, SL5) machine with [[http://fedoraproject.org/wiki/EPEL][EPEL]] repos enabled.
   * A working !XRootD Server.  See Documentation/Release3.InstallXrootd for details.

---++ Install Instructions

Note that this package is primarily intended for Bestman-Gateway acting as an endpoint for !XRootD server.  If you have not installed an !XRootD server yet, follow the instructions in Documentation/Release3.InstallXrootd.

%INCLUDE{"Documentation.InstallVDTRepo" headingoffset="1"}%

---+++ Certificates 
!GridFTP, which is a part of this meta-package, requires a certificate package to run.  If you require a specific certificate package, follow the Documentation/Release3.InstallCACerts instructions to install it.   If you do not install a grid certificate package first, the install procedure will install one for you as part of its dependencies.  (usually osg-ca-certs).


---++ Package installation instructions

First, you will need to install the !BeStMan Gateway !XRootD Storage element meta-package. But first install the JDK without GPG checking (this is a workaround for a problem we'll fix soon):

<pre class="rootscreen">
%UCL_PROMPT_ROOT% yum --enablerepo=osg-testing --nogpgcheck install jdk
%UCL_PROMPT_ROOT% yum --enablerepo=osg-testing install osg-se-bestman-xrootd
</pre> 


---+++ Configuring !GridFTP GUMS support

By default, !GridFTP uses a gridmap file, found in =/etc/grid-security/gridmap-file=.
If you want to use GUMS security (recommended), you will need to enable using the following steps:

First, edit =/etc/grid-security/gsi-authz.conf= and uncomment the globus callout.
<pre class="file">
globus_mapping /usr/lib64/liblcas_lcmaps_gt4_mapping.so lcmaps_callout
</pre> 
This should be =/usr/lib64= for x86_64 architectures and =/usr/lib= for i386 architectures.

Next edit =/etc/lcmaps.db= to edit your gums information:
<pre class="file">
# Module definitions
path = /usr/lib64/modules

...
gumsclient = "lcmaps_gums_client.mod"
             "-resourcetype ce"
             "-actiontype execute-now"
             "-capath /etc/grid-security/certificates"
             "-cert   /etc/grid-security/hostcert.pem"
             "-key    /etc/grid-security/hostkey.pem"
             "--cert-owner root"
# Change this URL to your GUMS server
             "--endpoint https://*gums.fnal.gov:8443*/gums/services/GUMSXACMLAuthorizationServicePort"
</pre> 

If you would like to run SAZ, you will need to enable the relevant lines in the above file as well (more documentation to be added later).


---+++ Configuring !GridFTP !XRootD support

Edit =/etc/sysconfig/gridftp.conf.d/xrootd-dsi-environment= and modify the XROOTD_VMP to use your Xrootd redirector.
<pre class="file">
#############################################
# xrootd-dsi module support
#############################################
# Note: This defines the path of the posix preload mount and
# which xrootd server it points.
# NOTE:  local_path is where the access via this node (ie GridFTP)
# will be from.  remote_path refers to the path on the XRootD node.
# Uncommenting this will set the XrootD location
export XROOTD_VMP="redirector:1094:/local_path=/remote_path"

# Uncommenting these will enable xrootd posix preload support
# Set XROOTDLIB to /usr/lib64 for 64 bit architectures
# and /usr/lib for 32 bit architectures.
export XROOTDLIB=/usr/lib64
export LD_PRELOAD=$XROOTDLIB/libXrdPosixPreload.so
</pre> 
*NOTE:* The syntax of the above environment variables is a little confusing, so make sure that you 
adhere to the following directions for XROOTD_VMP:
   * Redirector:  This is the hostname and domain of the local !XRootD redirector server.
   * local_path:  This is the path used to access the !GridFTP server (ie this server).
   * remote_path:  This is the path used to access the !XRootD redirector.

*Note:* The xrootd-dsi module overloads the =gridftp.conf= file and uses the alternate file =/etc/xrootd-dsi/gridftp-xrootd.conf=.  If you have made local changes to your =gridftp.conf= file, then you will need to carry them over to =/etc/xrootd-dsi/gridftp-xrootd.conf=.

---++ Configuring xrootdfs

Though the DSI module will work for !GridFTP, you 

Modify ==/etc/fstab== by adding the following entries:
<pre class="file">
....
xrootdfs                %RED%/mnt/xrootd%ENDCOLOR%              fuse    rdr=xroot://%RED%redirector1.domain.com%ENDCOLOR%:1094/%RED%/path/%ENDCOLOR%,uid=xrootd 0 0
</pre>
Replace =/mnt/xrootd= with the path that you would like to access with !BeStMan.  This should also match the !GridFTP settings for the =XROOTD_VMP= local path.
Create ==/mnt/xrootd== directory.
Once you are finished, you can mount it:
<pre class="file">
mount /mnt/xrootd
</pre>

You should now be able to run UNIX commands such as =ls /mnt/xrootd= to see the contents of the !XRootD server.

---+++ (Optional) Configuring secured xrootdfs

If you want to enable security for access to xrootd via xrootdfs you will need to modify xrootd  configuration and perform several steps to make xrootdfs secured.
   1. On the node where you have installed xrootd-server rpm execute the following command:<pre class="rootscreen">$ xrdsssadmin -k  %RED%my_key_name%ENDCOLOR% -u anybody -g usrgroup add %RED%keyfile%ENDCOLOR% </pre> e.g:<pre class="rootscreen">xrdsssadmin -k top_secret  -u anybody -g usrgroup add /etc/xrootd/xrootd.key</pre>
   1. Set ownership<pre class="rootscreen">chown xrootd.xrootd /etc/xrootd/xrootd.key</pre> 
   1. On the node where xrootdfs is installed modify ==/etc/fstab== add security information:<pre class="rootscreen">
xrootdfs                %RED%/mnt/xrootd%ENDCOLOR%              fuse    rdr=xroot://%RED%redirector1.domain.com%ENDCOLOR%:1094/%RED%/path/redirector1%ENDCOLOR%,uid=xrootd,sss=%RED%keyfile%ENDCOLOR%  0 0</pre>
   1. Modify xrootd configuration (==/etc/xrootd/xrootd-clustered.cfg==) on every data server by adding the following segment: <pre class="file">
     # ENABLE_SECURITY_BEGIN
        xrootd.seclib /usr/lib64/libXrdSec.so
        #the line below should be before "sec.protocol ... unix"
        %RED%sec.protocol /usr/lib64  sss -s keyfile%ENDCOLOR%
        sec.protocol /usr/lib64 unix
        # this specify that we use the 'unix' authentication module, additional one can be specified.
        # this is the authorization file
        acc.authdb /etc/xrootd/auth_file
        ofs.authorize
        # ENABLE_SECURITY_END
</pre>
   1. Copy  %RED%keyfile%ENDCOLOR%  on every data server node. Restart xrootd cluster by following [[https://twiki.grid.iu.edu/bin/view/SoftwareTeam/HowToInstallXrootd][these instructions]]
   1. on xroodfs node execute mount:<pre class="rootscreen">
$ mount %RED%/mnt/xrootd%ENDCOLOR%
</pre>
   1. Verify that you can access the mount point (df,ls) and can not write into unauthorized path, e.g:<pre class="rootscreen">
$ cp /bin/sh /mnt/xrootd/tlevshin/test1
cp: cannot create regular file `/mnt/xrootd/tlevshin/test1': Permission denied
</pre> Login as yourself and try, e.g:<pre class="rootscreen">
$ su - tlevshin
$ cp /bin/sh /mnt/xrootd/tlevshin/test1
</pre>


---++Edit Bestman Settings

Bestman settings and environment variables are stored in =/etc/bestman2/conf/bestman2.rc=.
You should review these settings to make sure all of them comply with your environment.
In particular, you will likely need to modify the following settings:
<pre class="file">
BESTMAN_GUMSCERTPATH=%RED%/etc/grid-security/http/httpcert.pem%ENDCOLOR%
BESTMAN_GUMSKEYPATH=%RED%/etc/grid-security/http/httpkey.pem%ENDCOLOR%
...
%RED%supportedProtocolList=gsiftp://host1.domain.tld%ENDCOLOR%
%RED%localPathListAllowed=/mnt/xrootd%ENDCOLOR%
CertFileName=%RED%/etc/grid-security/http/httpcert.pem%ENDCOLOR%
KeyFileName=%RED%/etc/grid-security/http/httpkey.pem%ENDCOLOR%
GUMSserviceURL=https://%RED%GUMS_HOST:8443%ENDCOLOR%/gums/services/GUMSAuthorizationServicePort
</pre>

!BeStMan requires two sets of certificate pairs.  One is for host services.  When clients connect to !BeStMan,
they will receive this certificate (*CertFileName*, *KeyFileName*) as proof of the server's identity.  The second
certificate pair (*BESTMAN_GUMSCERTPATH* and *BESTMAN_GUMSKEYPATH*) 
is used to communicate with Gums when verifying identity information.  Note: these two can 
(and usually will be) the same files, but can be split if your Gums setup requires a specific identity. 

Make sure that all the files have right permissions and are owned by ==bestman== user.

*localPathListAllowed* determines which paths users will be able to access via SRM.

Modify *GUMSserviceURL* to use your local Gums installation.

---+++ Modify =/etc/sudoers=

!BeStman requires the "sudo" command in order to write information as the proper user.
You will need to give the bestman user the proper permissions to run these commands.

Modify =/etc/sudoers= and comment the following line.
<pre class="file">
#Defaults    requiretty
</pre>

Then add the following lines at the end of the =/etc/sudoers= file.
<pre class="file">
Cmnd_Alias SRM_CMD = /bin/rm, /bin/mkdir, /bin/rmdir, /bin/mv, /bin/cp, /bin/ls
Runas_Alias SRM_USR = ALL, !root
bestman   ALL=(SRM_USR) NOPASSWD: SRM_CMD
</pre>

---+++ (Optional) Copying certificates to a bestman location

!BeStMan requires a certificate pair to function.  In order to use lcg-utils, this must be a host
certificate (rather than a service certificate).  The following shows how to copy your certificates
<pre class="rootscreen">
cp /etc/grid-security/hostkey.pem /etc/grid-security/bestman/bestmankey.pem
cp /etc/grid-security/hostcert.pem /etc/grid-security/bestman/bestmancert.pem
chown -R bestman:bestman /etc/grid-security/bestman/
</pre> 
Then modify *CertFileName*, *KeyFileName* in =/etc/bestman2/conf/bestman2.rc=.

---++ Configure Xrootd Gratia Probes
If you have enabled xrootd data server to push monitoring information you may also want to configure and enable Gratia xrootd transfer and storage probe. In order to do so you have to modify configuration ==/etc/gratia/xrootd-transfer/ProbeConfig== and ==/etc/gratia/xrootd-storage/ProbeConfig==:<pre class="file">
    CollectorHost="gratia-osg-%RED%itb%ENDCOLOR%.opensciencegrid.org:80"
    SSLHost="gratia-osg-%RED%itb%ENDCOLOR%.opensciencegrid.org:443"
    SSLRegistrationHost="gratia-osg-%RED%itb%ENDCOLOR%.opensciencegrid.org:80"

    SiteName="%RED%YOUR SITE NAME%ENDCOLOR%"
    Grid="OSG-%RED%ITB%ENDCOLOR%"
    EnableProbe="%RED%1%ENDCOLOR%"
     
</pre>
You will also need to configure ==/etc/gums/gums-client.properties== in order to accurately collect grid resource usage and metrics by VO for transfer submitted using grid proxies or where voms proxy information is not available.<pre class="file">
gums.location=https://%RED%GUMS_HOST%ENDCOLOR%:8443/gums/services/GUMSAdmin
gums.authz=https://%RED%GUMS_HOST%ENDCOLOR%:8443/gums/services/GUMSXACMLAuthorizationServicePort
</pre>
%ICON{warning}% if you are not using a default port (8443) you have to change it as well.

---++ Starting and Stopping !GridFTP

Starting !GridFTP:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% service globus-gridftp-server start
</pre> 


Stopping !GridFTP:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% service globus-gridftp-server stop
</pre> 

---++ Starting and Stopping !BeStMan

Starting !BeStMan:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% service bestman2 start
</pre> 

Stopping !BeStMan:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% service bestman2 stop
</pre> 


---++ Starting and Stopping Gratia Probes

Starting transfer and storage probes:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% service gratia-xrootd-transfer start
%UCL_PROMPT_ROOT% service gratia-xrootd-storage start
</pre> 

Stopping probes:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% service gratia-xrootd-transfer stop
%UCL_PROMPT_ROOT% service gratia-xrootd-storage stop
</pre> 


-- Main.DouglasStrain - 29 Aug 2011

%META:TOPICMOVED{by="JamesWeichel" date="1317239731" from="Documentation.InstallBestmanXrootdSE" to="Documentation/Release3.InstallBestmanXrootdSE"}%
