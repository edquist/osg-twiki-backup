%META:TOPICINFO{author="MatyasSelmeci" date="1351806820" format="1.1" reprev="1.5" version="1.5"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! OSG Cleanup Scripts 
%TOC{}%

---+ About this Document
<!-- useful variable definitions
   * Local UCL_HOST = ce
   * Local UCL_CWD = /opt/osg-%VERSION%
   * Local UCL_SERVICE = vdt-cleanup
   * Set TWISTY_OPTS_DETAILED = mode="div" showlink="Show Detailed Output" hidelink="Hide" showimgleft="/twiki/pub/TWiki/TWikiDocGraphics/toggleopen-small.gif" hideimgleft="/twiki/pub/TWiki/TWikiDocGraphics/toggleclose-small.gif" remember="on" start="hide" 
-->

%ICON{"hand"}% This Document is for System Administrators. It introduces the usage of cleanup scripts provided by the %LINK_VDT% to perform maintenance on a %LINK_GLOSSARY_CE%.

---+ About the Cleanup Procedure

The cleanup script located at =/usr/sbin/osg-cleanup= is run by the =cron= daemon on the user's behalf.  The default scripts that ship with it will clean up various Globus files and directories that are left behind.  It is possible to add custom scripts (see below) to do cleanup specific to your site.

The following files and directories in users' home directories will be cleaned.  Note that the locations of these can be overriden (see [[https://twiki.grid.iu.edu/bin/view/Documentation/Release3/RelocatingGlobusDirs][here]] for details):
   * Globus state directory: =/var/lib/globus/gram_job_state=
   * User gass cache =&lt;user home&gt;/.globus/.gass_cache=
   * User Globus job directory =&lt;user home&gt;/.globus/job=
   * User GRAM job manager logs =&lt;user home&gt;/gram_job_mgr_&lt;integer&gt;.log=
   * User GRAM scratch directories =&lt;user home&gt;/gram_scratch_&lt;random string&gt;=
   * Globus Scheduler Event Generator logs =/var/lib/globus/globus-seg-*/*=

---+ Installation

The cleanup scripts are provided by the osg-cleanup RPM and are installed as part of the [[ReleaseDocumentation/ComputeElementInstall][Compute Element Installation]].

The following configuration settings can be found in =/etc/osg/config.d/10-misc.ini=.  It is not necessary to modify them unless you want to customize the behavior of the cleanup scripts.


%TWISTY{%TWISTY_OPTS_DETAILED% showlink="Show the sample 10-misc.ini configuration"}% 

<pre class="file">
; The OSG cleanup scripts are provided to help remove Globus files that                         
; build up over time on your system.  For more information see the Twiki:                       
;  https://twiki.grid.iu.edu/bin/view/Documentation/Release3/InstallCleanupScripts              

; The age in days after which files that have not been accessed should be                       
; deleted. Jobs that run longer than this number of days may be killed because                  
; necessary files may be removed.  If this is a problem for you do not run the                  
; osg-cleanup scripts and email vdt-support@opensciencegrid.org                                 
; Default = 14                                                                                  
;cleanup_age_in_days = 14                                                                       

; The user's home directories that should be cleaned up.  The default value                     
; is @vo-file.  This will open osg-user-vo-map.txt and try to get the list                      
; of users from this file.  Alternatively you can specify a whitespace                          
; separated list of users.                                                                      
;cleanup_users_list = @vo-file                                                                  

; The cron time at which the cleanup script will run.  By default it will run                   
; once a day during the night.                                                                  
;cleanup_cron_time = 15 1 * * *                                    
</pre>

%IMPORTANT% If you set the age to 14 days, jobs that run for longer than 14 days may be killed because necessary files are cleaned up.  You should set this value to a number of days higher than you expect your long running jobs to take to complete.  If this is a problem for you then do not use the =osg-cleanup= script.

%ENDTWISTY%

---+ Starting OSG Cleanup Scripts

To start the osg-cleanup cron job, run this command:
<pre>
$ /sbin/service osg-cleanup-cron start
</pre>

---+ Advanced Topic: Adding Custom Cleanup Scripts

The cron job automatically executes all scripts found in =/usr/libexec/osg-cleanup= directory that are:

   * owned by _root_
   * permissions set to _0700_

The following environment variables are available to all children cleanup scripts:

| *Variable* | *Comment* |
| $OSG_CLEANUP_AGE | Age in days after which files will be deleted. |
| $OSG_CLEANUP_USER_FILE | Path to a file containing a list of user accounts and home directories to clean up.  The format is: &lt;user&gt; &lt;user home&gt; |

---+ Validation of Service Operation

   1 Verify that the log file =/var/log/osg/osg-cleanup.log= has been created and inspect its contents.
   1 Run the cleanup script =/usr/sbin/osg-cleanup= with the =--dry-run= option and inspect the output
<pre class="rootscreen">/usr/sbin/osg-cleanup --dry-run</pre>

---+ Known Issues

The =--dry-run= option causes the scripts in =/usr/libexec/osg-cleanup= to not be run, decreasing its ability to validate the operation.

The scripts do not clean up custom user directories listed in RVF files. See the ticket [[https://jira.opensciencegrid.org/browse/SOFTWARE-828][SOFTWARE-828]] for details.

---+ *Comments*
%COMMENT{type="tableappend"}%
