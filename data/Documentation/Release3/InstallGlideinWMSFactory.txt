%META:TOPICINFO{author="MarcoMambelli" date="1384191991" format="1.1" reprev="1.12" version="1.12"}%
%META:TOPICPARENT{name="NavTechGlideinWMS"}%
<!-- Local variables
   * Set CONDORREL = 7.6.0
   * Set AS_OF_DATE = May 27, 2011
-->

---+!! !GlideinWMS Factory Installation
%DOC_STATUS_TABLE%
%TOC{depth="3"}%

---+ About This Document

This document describes how to install the Glidein Workflow Managment System (!GlideinWMS) Factory instance.

This document assumes expertise with Condor and familiarity with the glideinWMS software.  It *does not* cover anything but the simplest possible install.   Please consult the [[http://www.uscms.org/SoftwareComputing/Grid/WMS/glideinWMS/doc.prd/install.html][Glidein WMS reference documentation]] for advanced topics, including non-=root=, non-RPM-based installation.

This document covers three primary components of the frontend:
   * *WMS Collector / Schedd*: A set of =condor_collector= processes that control the submission of pilots to Grid entries.  
   * *Glidein Factory*: 

%INCLUDE{"Documentation/DocumentationTeam/DocConventions" section="Header"}%
%INCLUDE{"Documentation/DocumentationTeam/DocConventions" section="CommandLine"}%

---+ Requirements

---++ Host and OS
   1 A host to install the !GlideinWMS Frontend (pristine node). 
   1 OS is %SUPPORTED_OS%.  Currently most of our testing has been done on Scientific Linux 6.
   1 Root access

The Glidein WMS VO Frontend has the following requirements:
   * *CPU*: 4-8 for a large installation (1 should suffice on a small install)
   * *RAM*: 4-8GB on a large installation (1GB should suffice for small installs)
   * *Disk*:  10GB will be plenty sufficient for all the binaries, config and log files related to glideinWMS.  If you are a large site with need to keep significant history and logs, you may want to allocate 100GB+ to store long histories.

---++ Users
The Glidein WMS Frontend installation will create the following users unless they are already created.

%STARTSECTION{"Users"}%
| *User* | *Default uid* | *Comment* |
| =condor= | none | Condor user (installed via dependencies). |
| =gfactory= | none | This user runs the Glidein VO factory. |

Note that, if you use a different user (or =gfactory= has a different group than =gfactory=),
then you will have to modify =/etc/condor/privsep_config= to allow condor to use the
condor root switchboard.


%ENDSECTION{"Users"}%

---++ Certificates 

| *Certificate* | *User that owns certificate* | *Path to certificate* |
| Host certificate | =root= | =/etc/grid-security/hostcert.pem= <br> =/etc/grid-security/hostkey.pem= |

[[GetHostServiceCertificates][Here]] are instructions to request a host certificate.
 
The host certificate/key is used for authorization,  however, 
authorization between the factory and the wms collector is done by file system authentication.


---++ Networking
%STARTSECTION{"Firewalls"}%
%INCLUDE{"FirewallInformation" section="FirewallTable" lines="http,condorcollector"}%

It must must be on the public internet, with at least one port open to the world; all worker nodes will load data from this node trough HTTP. Note that worker nodes will also need outbound access in order to access this HTTP port. 

%ENDSECTION{"Firewalls"}%



---+ Installation Procedure

%INCLUDE{"YumRepositories" section="OSGRepoBrief" TOC_SHIFT="+"}%

%INCLUDE{"InstallCertAuth" section="OSGBriefCaCerts" TOC_SHIFT="+"}%

%STARTSECTION{"InstallGWMSFactory"}%

---++ Download and install the Factory RPM

The RPM is available in the OSG repository:

Install the RPM and dependencies (be prepared for a lot of dependencies).

   <pre class="rootscreen">%UCL_PROMPT_ROOT% yum install glideinwms-factory</pre>

This will install the current production release verified and tested by OSG with default condor configuration.
This command will install the glideinwms factory, condor, the OSG client, and all the required dependencies.
If you wish to install a different version of !GlideinWMS, add the "--enablerepo" argument to the command as follows:

   * =yum install --enablerepo=osg-testing glideinwms-factory=: The most recent production release, still in testing phase.  This will usually match the current tarball version on the !GlideinWMS home page.  (The osg-release production version may lag behind the tarball release by a few weeks as it is verified and packaged by OSG).  Note that this will also take the osg-testing versions of all dependencies as well.
   * =yum install --enablerepo=osg-contrib glideinwms-factory=:  The most recent development series release, ie version 3 release.  This has newer features such as cloud submission support, but is less tested.


%ENDSECTION{"InstallGWMSFactory"}%


---+ Configuration Procedure 

After installing the RPM you need to configure the components of the Glidein WMS VO Frontend:
   1. Edit Factory configuration options
   1. Edit Condor configuration options
   1. Create a Condor grid map file
   1. Reconfigure and Start factory

---++ Download condor tarballs

You will need to download Condor tarballs for each architecture that you want to deploy pilots on.
At this point, glideinWMS factory does not support pulling condor binaries from your system area.
Suggested is that you put these binaries in =/var/lib/gwms-factory/condor= but any =gfactory= accessible location should suffice.

---++ Configuring the Factory

The configuration file is =/etc/gwms-factory/glideinWMS.xml=.  The next steps will describe each line that you will need to edit for most cases, but you may want to 
review the whole file to be sure that it is configured correctly.

---+++ Frontend security configuration

In the security section, you will need to provide each frontend that is allowed to communicate with the factory:
   <pre class="file">
   &lt;security allow_proxy="frontend" key_length="2048" pub_key="RSA" reuse_oldkey_onstartup_gracetime="900"&gt;
      &lt;frontends&gt;
         &lt;frontend name="%ORANGE%vofrontend_sec_name%ENDCOLOR%" identity="%GREEN%vofrontend_service%ENDCOLOR%@FACTORY_COLLECTOR_HOSTNAME"&gt;
            &lt;security_classes&gt;
               &lt;security_class name="%RED%frontend_sec_class%ENDCOLOR%" username="frontend"/&gt;
            &lt;/security_classes&gt;
         &lt;/frontend&gt;
      &lt;/frontends&gt;
   &lt;/security&gt;
   </pre>

These attributes are very important to get exactly right or the frontend will not be trusted.  This should match a security of the frontend in the following way:
<pre class="file">
   &lt; security classad_proxy="/tmp/vo_proxy" proxy_DN="%BLUE%/DC=org/DC=doegrids/OU=People/CN=Some Name 123456%ENDCOLOR%" proxy_selection_plugin="ProxyAll" security_name="%ORANGE%frontend_sec_name%ENDCOLOR%" sym_key="aes_256_cbc"&gt;
      &lt;proxies&gt;
         &lt;proxy absfname="/tmp/vo_proxy" security_class="%RED%frontend_sec_class%ENDCOLOR%"/&gt;
      &lt;/proxies&gt;
   &lt;/security &gt;
</pre>
Note that the identity of the frontend must match what *condor* authenticates the DN of the frontend to.  In =/etc/condor/certs/condor_mapfile=
(See next section for more details), there must be an entry:
<pre class="file">
GSI "%BLUE%^\/DC\=org\/DC\=doegrids\/OU\=People\/CN\=Some\ Name\ 834323%ENDCOLOR%$" %GREEN%vofrontend_service%ENDCOLOR%
</pre>


---+++ Web server configuration

Verify web area:
   <pre class="file">
       &lt;stage base_dir="/var/lib/gwms-factory/web-area/stage" use_symlink="True" web_base_url="http://HOSTNAME:PORT/factory/stage"/&gt;
   </pre>
This will determine the location of your web server.  It is advisable (but not necessarily) to change the port here and in apache by modifying the "Listen" directive in =/etc/httpd/conf/httpd.conf=.  Note that web servers are an often attacked piece of infrastruture, so you may want to go through the Apache configuration in 
=/etc/httpd/conf/httpd.conf= and disable unneeded modules.

---+++ Entry configuration

Entries are grid endpoints (Compute Elements) that can accept job requests and run pilots (which will run user jobs).
Each needs to be configured to go to a specific gatekeeper.

An example test entry is provided in the configuration file.  At the very least, you will need to modify the entry line:
   <pre class="file">
       &lt;entry name="%RED%ENTRY_NAME%ENDCOLOR%" enabled="True" gatekeeper="%RED%gatekeeper.domain.tld/jobmanager-condor%ENDCOLOR%" gridtype="gt2" rsl="(queue=default)(jobtype=single)" schedd_name="schedd_glideins4@fermicloud121.fnal.gov" verbosity="std" work_dir="OSG" &gt;
   </pre>
You will need to modify the entry name and gatekeeper.  This will determine the gatekeeper that you access.  Specific gatekeepers often require specific "rsl" attributes that determine the job queue that you are in or other attributes.  Add them in the rsl.  Also, be sure to distribute your entries across the various condor schedd work managers to balance load.  Several schedd options are configured by default for you:  schedd_glideins2, schedd_glideins3, schedd_glideins4, schedd_glideins5, as well as the default schedd.  This can be modified in the condor configuration.  Add any specific options, such as limitations on jobs/pilots or glexec/voms requirements in the entry section below the above line.

More information on options can be found here:
http://www.uscms.org/SoftwareComputing/Grid/WMS/glideinWMS/doc.prd/factory/configuration.html

---++ Configuring Tarballs

Each pilot will download condor binaries from the staging area.  Often, multiple binaries are needed to support various architectures and platforms. 
Currently, you will need to provide at least one tarball for glideinWMS to use.  (Using the system binaries is currently not supported).

Download a condor tarball from: http://research.cs.wisc.edu/condor/downloads-v2/download.pl.  Suggested is to put the binaries in =/var/lib/gwms-factory/condor=, but any factory-accessible location will do just fine.

Once you have downloaded the tarball, configure it in =/etc/gwms-factory/glideinWMS.xml= like in the following:
   <pre class="file">
     &lt; condor_tarball arch="default" base_dir="/var/lib/gwms-factory/condor/condor-7.6.6-x86_64_rhap_5-stripped" os="default" version="default"/&gt;
   </pre>

---++ Configuring Condor

The condor configuration for the frontend is placed in =/etc/condor/config.d=.
   * 00_gwms_factory_general.config
   * 01_gwms_factory_collectors.config
   * 02_gwms_factory_schedds.config
   * 03_gwms_factory_local.config

Get rid of the pre-loaded condor default. 
<pre class="rootscreen">
  rm /etc/condor/config.d/00personal_condor.config
</pre>

For most installations, the items you need to modify are in =03_gwms_local.config=.  The lines you will have to edit are:

   1. Credentials of the machine.  You can either run using a proxy, or a service certificate.  It is recommended to use a host certificate and specify it's location in the 
variables =GSI_DAEMON_CERT= and =GSI_DAEMON_KEY=.  The host certificate should be owned by =root= and have the correct permissions, 600.
   1. Condor ids in the form UID.GID (both are integers)
   1. Condor admin email it will email when services fail.
   <pre class="file">
#-- Condor user: condor
CONDOR_IDS =
#--  Contact (via email) when problems occur
CONDOR_ADMIN =

############################
# GSI Security config
############################
#-- Grid Certificate directory
GSI_DAEMON_TRUSTED_CA_DIR= /etc/grid-security/certificates

#-- Credentials
GSI_DAEMON_CERT =  /etc/grid-security/hostcert.pem
GSI_DAEMON_KEY  =  /etc/grid-security/hostkey.pem

#-- Condor mapfile
CERTIFICATE_MAPFILE= /etc/condor/certs/condor_mapfile

###################################
# Whitelist of condor daemon DNs
###################################
#DAEMON_LIST = COLLECTOR, MASTER, NEGOTIATOR, SCHEDD, STARTD
</pre>

After configuring condor, be sure to restart condor:

<pre class="rootscreen">
service condor restart</pre>


---+++ Configuring Condor Privilege Separation

Lastly, verify the settings in =/etc/condor/privsep_config=.  By default,
the values in this file should not need to be modified.  However,
if your user/group differs from =gfactory= / =gfactory=, or if you are operating
a factory with multiple frontends, you will have to modify this file.

This file controls the condor root switchboard, which allows the factory
to change permissions of files, specifically the proxies and files
passed to it by the frontends.

<pre class="file">
valid-caller-uids = gfactory
valid-caller-gids = gfactory
valid-target-uids = fecmsucsd : fehcc : fecmscern
valid-target-gids = fecmsucsd : fehcc : fecmscern
valid-dirs = /var/lib/gwms-factory/client-proxies
valid-dirs = /var/lib/gwms-factory/client-logs
valid-dirs = /var/log/gwms-factory/client
valid-dirs = /var/lib/gwms-factory
valid-dirs = /var/log/gwms-factory
procd-executable = /usr/sbin/condor_procd
</pre>

Thus, the =valid-called-uids= and =valid-caller-gids= should match the user/group of your factory user.
The =valid-target-uids= and =valid-target-gids= should be a colon-separated list of all the frontend
users and groups.  This should match the security_classes section in =/etc/gwms-factory/glideinWMS.xml=.


---+++ Using UW Madison Condor RPM

The above procedure will work if you are using the OSG condor RPMS.
If you are using the UW Madison Condor RPMS, be aware of the following changes:

   * This Condor RPM uses a file =/etc/condor/condor_config.local= to add your local machine slot to the user pool.
   * If you want to disable this behavior (recommended), you should blank out that file or comment out the line in =/etc/condor/condor_config= for LOCAL_CONFIG_FILE.  (Make sure that LOCAL_CONFIG_DIR is set to =/etc/condor/config.d=)
   * Note that the variable LOCAL_DIR is set differently in UW Madison and OSG RPMs.  This should not cause any more problems in the glideinwms RPMs, but please take note if you use this variable in your job submissions or other customizations.



---++ Create a Condor grid mapfile.

The Condor grid mapfile (=/etc/condor/certs/condor_mapfile=) is used for authentication between the glidein running on a remote worker node, and the local collector.  Condor uses the mapfile to map certificates to pseudo-users on the local machine.  It is important that you map the DN's of each frontend you are talking to.

Below is an example mapfile, by default found in =/etc/condor/certs/condor_mapfile=:
   <pre class="file">
GSI "^\/DC\=org\/DC\=doegrids\/OU\=People\/CN\=Some\ Name\ 123456$" frontend
GSI (.*) anonymous
FS (.*) \1 </pre>
Each frontend needs a line that maps to the user specified in the identity argument in the frontend security section of the factory configuration.

After configuring the mapfile, be sure to restart condor:

<pre class="rootscreen">
service condor restart</pre>

---++ Reconfigure and verify installation

In order to use the factory, first you must reconfigure it.
Each time you change the configuration you must reconfigure it using the "upgrade" or "reconfigure" option in order to 
populate scripts and information correctly. 

*IMPORTANT NOTE*

Before you start the factory service first time, you should always use the "upgrade" option. 

<pre class="rootscreen">
%UCL_PROMPT_ROOT% service gwms-factory upgrade </pre>

After reconfiguring, you can start the factory:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% service gwms-factory start </pre>


---+ Service Activation and Deactivation

*IMPORTANT NOTE* 

Anytime you change the =/etc/gwms-factory/glideinWMS.xml= file, you will need
to reconfigure the factory with:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% service gwms-factory upgrade </pre>

These services need to be running for the factory to function:
   * Condor <pre class="rootscreen">
%UCL_PROMPT_ROOT% service condor start </pre>
   * Httpd <pre class="rootscreen">
%UCL_PROMPT_ROOT% service httpd start</pre>
   * VO Frontend <pre class="rootscreen">
%UCL_PROMPT_ROOT% service gwms-factory start </pre>

To stop the factory:<pre class="rootscreen">
%UCL_PROMPT_ROOT% service gwms-factory stop </pre>

---+ Validation of Service Operation

The validation of the factroy is the submission of actual jobs.

You can also check that the services are up and running:
<pre class="screen">
%UCL_PROMPT% condor_status -any

MyType               TargetType           Name

glidefactory         None                 TEST_ENTRY@gfactory_instance@
glidefactoryclient   None                 TEST_ENTRY@gfactory_instance@
glideclient          None                 TEST_ENTRY@gfactory_instance@
Scheduler            None                 hostname.fnal.gov
DaemonMaster         None                 hostname.fnal.gov
Negotiator           None                 hostname.fnal.gov
Scheduler            None                 schedd_glideins2@hostname
Scheduler            None                 schedd_glideins3@hostname
Scheduler            None                 schedd_glideins4@hostname
Scheduler            None                 schedd_glideins5@hostname
Collector            None                 wmscollector_service@hostname
</pre>

You should have one "glidefactory" classad for each entry that you have enabled.
If you have already configured the frontends, 
you will also have one glidefactoryclient and one glideclient classad for each frontend / entry.

---+ File Locations

|  *File Description*  |  *File Location*  | *Comment*|
|Configuration file | /etc/gwms-factory/glideinWMS.xml | Main configuration file |
|Logs | /var/log/gwms-factory/server/factory | Overall server logs |
|| /var/log/gwms-factory/server/entry_NAME | Specific entry logs (generally more useful) |
|| /var/log/gwms-factory/client | Glidein Pilot logs seperated by user and entry.  |
|Startup script | /etc/init.d/gwms-factory ||
|Web Directory | /var/lib/gwms-factory/web-area ||
|Web Base| /var/lib/gwms-factory/web-base ||
|Working Directory | /var/lib/gwms-factory/work-dir/ ||


---+ Troubleshooting

---++ Failed authentication errors

If you get messages such as these in the logs, the factory does not trust the frontend and will not submit glideins.

<pre class="screen">
WARNING: Client fermicloud128-fnal-gov_OSG_gWMSFrontend.main (secid: frontend_name) not in white list. Skipping request
</pre>
  * This error means that the frontend name in the security section of the factory does not match the security_name in the frontend.

<pre class="screen">
Client fermicloud128-fnal-gov_OSG_gWMSFrontend.main (secid: frontend_name) is not coming from a trusted source; AuthenticatedIdentity vofrontend_condor@fermicloud130.fnal.gov!=vofrontend_factory@fermicloud130.fnal.gov. Skipping for security reasons.
</pre>
  * This error means that the identity in the security section of the factory does not match what the =/etc/condor/certs/condor_mapfile= authenticates the frontend to in condor (!AuthenticatedIdentity in the classad).

Make sure the attributes are correctly lined up as in the Frontend security configuration section above.

---++ Glideins start but do not connect to User pool / VO Frontend

Check the appropriate job err and out logs in =/var/log/gwms-factory/client= to see if any errors were reported.
Often, this will be a pilot unable to access a web server or with an invalid proxy.  Also, verify that the condor_mapfile is correct on the VO Frontend's user pool collector and configuration.

---++ Condor_root_switchboard errors

Make sure that you run =service gwms-factory upgrade= instead of the more light-weight =service gwms-factory reconfig=
to ensure that all scripts are created correctly. 

Next verify =/etc/condor/privsep_config= to make sure the users are listed correctly.

Lastly, verify that permissions are correct.  The parent directory of all valid-dirs must be owned by root.

---+ References

   * http://www.uscms.org/SoftwareComputing/Grid/WMS/glideinWMS/doc.prd
   * http://twiki.grid.iu.edu/bin/view/Documentation/Release/GlideinWMSVOFrontendInstall


---+ Comments
%COMMENT{type="tableappend"}%

<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = MarcoMambelli

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|General|Integration|Monitoring|Operations|Security|Storage|Tier3|User|VO)
   * Local DOC_AREA       = General

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (Developer|Documenter|Scientist|Student|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (HowTo|Installation|Knowledge|Navigation|Planning|Training|Troubleshooting)
   * Local DOC_TYPE       = Installation
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %YES%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %YES%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = ParagMhashilkar
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %IN_PROGRESS%


 DEAR DOCUMENT TESTER
 ====================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = ParagMhashilkar
 Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %IN_PROGRESS%
############################################################################################################
-->

-- Main.DouglasStrain - 21 Feb 2012
