%META:TOPICINFO{author="DaveDykstra" date="1409331038" format="1.1" reprev="1.1" version="1.1"}%
%LINKCSS%
---+!! %SPACEOUT{ "Install a CVMFS Stratum 1" }%
%DOC_STATUS_TABLE%
%TOC{depth="3"}%

---# About this Document
This document describes how to install a CVMFS Stratum 1.  There are many different variations on how to do that, but this document focuses on the configuration of the OSG GOC Stratum 1 oasis-replica.opensciencegrid.org.  It is applicable to other Stratum 1s as well, very likely with modifications (some of which are suggested in the document below).  

%INCLUDE{"Documentation/DocumentationTeam/DocConventions" section="Header"}%
%INCLUDE{"Documentation/DocumentationTeam/DocConventions" section="CommandLine"}%

---# Applicable versions
The applicable software versions for this document are cvmfs and cvmfs-server >= 2.1.19-1.

---# Requirements

---## Host and OS

   * OS is a 64-bit %SUPPORTED_OS%. 
   * Root access
   * Adequate disk space for the repositories that will be served, at =/srv/cvmfs=.   About 10GB should be reserved for apache and squid logs under /var/log on a production server, although they normally will not get that large.  A Stratum 1 that is also a repository server should have at least 5GB available at =/var/cache=.

---## Users and Groups

This installation will create one user unless it already exists:

%STARTSECTION{"Users"}%
| *User* | *Comment* |
| =cvmfs= | !CernVM-FS service account |
%ENDSECTION{"Users"}%

The installation will also create a cvmfs group and default the cvmfs user to that group.

In addition, if the fuse rpm is not for some reason already installed, installing the repository server packages will also install fuse and that will create another group:

%STARTSECTION{"Groups"}%
| *Group* | *Comment* | *Group members* |
| =cvmfs= | !CernVM-FS service account | none |
| =fuse= | !FUSE service account | =cvmfs= |
%ENDSECTION{"Groups"}%

---# Install Instructions

All CVMFS Stratum 1s require cvmfs-server software and apache (httpd).  It is highly recommended to also install frontier-squid and frontier-awstats on the same machine to be able to easily join the WLCG [[http://wlcg-squid-monitor.cern.ch/snmpstats/indexcvmfs.html][MRTG]] and [[http://wlcg-squid-monitor.cern.ch/awstats/cvmfs.html][awstats]] monitoring systems.  The recommended configuration for frontier-squid below does not do any caching, it is just for monitoring.

---## Installing cvmfs-server and httpd

The OSG GOC Stratum 1 has to function as a repository server in addition to an ordinary Stratum 1.   This is done quite differently on Redhat EL5 and EL6 systems.  Instructions are also provided for how to install cvmfs-server on Stratum 1s that do not have to be repository servers, which is the same on both versions of operating systems.  Choose one of the following three sections.

---### Installing CVMFS repository server on RHEL5

Redhat EL5-based systems that are not Scientific Linux-based should first build the [[http://ftp.scientificlinux.org/linux/scientific/5x/SRPMS/SL/aufs-0.20090202.cvs-6.sl5.src.rpm][SL5 aufs source rpm]] and install the resulting rpm in their own yum repository. 

Follow these instructions to install:<pre class="rootscreen">
%UCL_PROMPT_ROOT% rpm -i http://cvmrepo.web.cern.ch/cvmrepo/yum/cvmfs/EL/5/x86_64/cvmfs-release-2-4.el5.noarch.rpm
%UCL_PROMPT_ROOT% yum -y install aufs cvmfs-server.x86_64 cvmfs.x86_64</pre>

---### Installing CVMFS repository server on RHEL6

Redhat EL6-based systems running a CVMFS repository server have to get their kernel from CERN: <pre class="rootscreen">
%UCL_PROMPT_ROOT% rpm -i http://cvmrepo.web.cern.ch/cvmrepo/yum/cvmfs/EL/6/x86_64/cvmfs-release-2-4.el6.noarch.rpm
%UCL_PROMPT_ROOT% yum -y install --enablerepo=cernvm-kernel kernel aufs2-util cvmfs-server.x86_64 cvmfs.x86_64
%UCL_PROMPT_ROOT% reboot</pre>

---### Installing CVMFS stratum 1 code without repository server code

On Redhat EL5, first do this command:<pre class="rootscreen">
%UCL_PROMPT_ROOT% rpm -i http://cvmrepo.web.cern.ch/cvmrepo/yum/cvmfs/EL/5/x86_64/cvmfs-release-2-4.el5.noarch.rpm</pre>

On Redhat EL6, first do this command:<pre class="rootscreen">
%UCL_PROMPT_ROOT% rpm -i http://cvmrepo.web.cern.ch/cvmrepo/yum/cvmfs/EL/6/x86_64/cvmfs-release-2-4.el6.noarch.rpm</pre>

Then on either type of system to install do:<pre class="rootscreen">
%UCL_PROMPT_ROOT% yum -y install cvmfs-server.x86_64</pre>

---## Installing frontier-squid and frontier-awstats

Do these commands to install frontier-squid and frontier-awstats:<pre class="rootscreen">
%UCL_PROMPT_ROOT% rpm -i http://frontier.cern.ch/dist/rpms/RPMS/noarch/frontier-release-1.1-1.noarch.rpm
%UCL_PROMPT_ROOT% yum -y install frontier-awstats</pre>

---# Configuring

---# Verifying




<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = DaveDykstra

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = Storage

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = Installation
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %NO%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %NO%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %NO%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %NO%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = MarcoMambelli
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %NO%


 DEAR DOCUMENT TESTER
 ====================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = VinceNeal
 Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %NO%
############################################################################################################
-->



-- Main.DaveDykstra - 29 Aug 2014
