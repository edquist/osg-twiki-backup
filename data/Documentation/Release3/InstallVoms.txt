%META:TOPICINFO{author="MarcoMambelli" date="1314749889" format="1.1" reprev="1.5" version="1.5"}%
%DOC_STATUS_TABLE%

---+!! Install VOMS
%TOC%

<!-- conventions used in this document
   * Local UCL_HOST = %URLPARAM{"INPUT_HOST" encode="quote" default="voms"}%
   * Local UCL_USER = %URLPARAM{"INPUT_USER" encode="quote" default="user"}%
   * Local UCL_DOMAIN = %URLPARAM{"INPUT_DOMAIN" encode="quote" default="opensciencegrid.org"}%
-->
%STARTINCLUDE%
%EDITTHIS%

---+ Introduction
The Virtual Organization Membership Service (VOMS - https://twiki.cnaf.infn.it/cgi-bin/twiki/view/VOMS/WebHome) has three main parts: 
   * !MySQL database which is a persistent repository for VO membership information, 
   * VOMS admin which provides the Web UI/services to maintain the VO membership. This requires Apache/Tomcat.
   * VOMS server, a daemon process which services the <i>voms-proxy-init</i> requests.


---+ About this Document
This document is for VO System Administrators. 

Here we describe how to install and configure VOMS on your Linux machine. When you install VOMS as described here, you get all three parts: !MySQL database, VOMS admin and VOMS server.  It comes with a test VO called VDT. We suggest that you use it for testing. You're going to need to create your real VO with the appropriate name. Instructions for doing that are also on this page, in the configuration section.

We also describe how to remove a VO from VOMS if the need arises.

The installation section will give you a bare-bone installation. In order to use VOMS you need to go through the configuration: run =configure_voms= to create your VO, probably enable read-only access to your VO and probably set a VO-admin to add/remove users.
The other sections help in troubleshooting and knowing what is running.


---+ How to get Help?
To get assistance please use [[HelpProcedure][this page]].


---+ Requirements
   * A host to install the VOMS Service (Pristine node)
   * OS is Red Hat Enterprise Linux 5 32 and 64 bit and variants (Scientific Linux 5 and !CentOS 5). Currently most of our testing has been done on Scientific Linux 5.
   * OSG and EPEL yum repositories must be enabled. YumRepositories contains instructions to install and enable the repositories.
   * Root access
   * Host certificate. [[][Here]] are instructions to request a host certificate.
   * VOMS and Tomcat service certificats (optional, you can use the host certificate instead)
   * allow inbound and outbound network connection _to all GUMS servers that may query this VOMS_
   * Testing Requirements:
      * The Subject and Issuer of a voms admin certificate (it could be your certificate)
      * Access to your own certificate if you want to create your  voms proxy 
      * Your certificate uploaded into a browser if you want to test voms-admin WEB UI


---+ Installation Procedure
Install one of set of CA certificates:
%INCLUDE{"Documentation.InstallCACerts" headingoffset="1"}%

%STARTSECTION{"InstallOSGVomsRPMs"}%
Make sure that the OSG repository is enabled:
   1. Enable OSG repos by editing ==/etc/yum.repos.d/osg-testing.repo==:<pre class="file">
[osg-testing]
name=OSG Software for Enterprise Linux 5 - Development - $basearch
baseurl=http://vdt.cs.wisc.edu/repos/3.0/el5/testing/$basearch
failovermethod=priority
priority=98
enabled=%RED%1%ENDCOLOR%
</pre>

Install OSG-VOMS:
   1. Install osg-voms:<pre class="rootscreen">
%UCL_PROMPT_ROOT% yum install osg-voms
</pre>
   1. Install  xml-commons-apis:<pre class="rootscreen">
%UCL_PROMPT_ROOT% yum install xml-commons-apis
</pre>
%ICON{warning}%from https://twiki.cern.ch/twiki/bin/view/EMI/VOMSystemAdministratorGuide
Manually install xml-commons-apis libraries (after having installed the right metapackage for your installation), as the ones provided by the JRE cause warnings when starting/stopping tomcat.

*NOTE*: osg-voms is not yet in osg-testing, it is only in osg-development, so you'll have to test form that repository until the package has been promoted.
%ENDSECTION{"InstallOSGVomsRPMs"}%


---+ Configure

%STARTSECTION{"ConfigureMysqlSrever"}%

Configure !MySQL Database:

Before you will be able configure VOMS you will need to have access to !MySQL database.  The !MySQL software is installed with the =osg-voms= package. By default it will be using port 3306 and will not have password for ==root==. 

It is not necessary to change the port number if you don't want to. If you want to modify the port you will need to edit ==/etc/my.cnf== file and add a new port:<pre class="file">
[mysqld]
datadir=/var/lib/mysql
socket=/var/lib/mysql/mysql.sock
port=%RED%MYSQL_PORT_NUMBER%ENDCOLOR%
</pre>   
It is wise to set a password for the ==root== user. Run the following command to set the password:<pre class="rootscreen">
%UCL_PROMPT_ROOT% /etc/init.d/mysqld start
%UCL_PROMPT_ROOT% mysqladmin -u root password %RED%top_secret%ENDCOLOR%
</pre> 
%ENDSECTION{"ConfigureMysqlSrever"}%

%STARTSECTION{"PrepareServiceCertificates"}%
Make sure that you have the VOMS and Tomcat service certificates/keys in the right directories and with the correct owners and permissions (=600= for key and =644= the certificate). If you dont, here are the instructions to copy the host certificates and set the correct owner (permissions are preserved):
   1. VOMS-core daemon is running as user ==voms== and requires its service certificate and key in ==/etc/grid-security/voms==. To copy the host certificate/key for this service, you need to do the following:<pre class="rootscreen">
%UCL_PROMPT_ROOT% cd /etc/grid-security
%UCL_PROMPT_ROOT% cp hostcert.pem voms/vomscert.pem
%UCL_PROMPT_ROOT% cp hostkey.pem voms/vomskey.pem
%UCL_PROMPT_ROOT% chown -R voms.voms voms
</pre>
   1. Tomcat service is running as user ==tomcat== and requires its service certificate and key in ==/etc/grid-security/http==. To copy the host certificate/key for this service, you need to do the following:<pre class="rootscreen">
%UCL_PROMPT_ROOT% cd /etc/grid-security
%UCL_PROMPT_ROOT% mkdir /etc/grid-security/http
%UCL_PROMPT_ROOT% cp hostcert.pem http/httpcert.pem
%UCL_PROMPT_ROOT% cp hostkey.pem http/httpkey.pem
%UCL_PROMPT_ROOT% chown -R tomcat.tomcat http
</pre>
%ENDSECTION{"PrepareServiceCertificates"}%

%STARTSECTION{"ConfigureVoms"}%
Now, you can create the database and configure VOMS-core and VOMS-admin:
   1. Run ==voms-admin-configure== script:<pre class="rootscreen">
%UCL_PROMPT_ROOT% voms-admin-configure install --dbtype mysql --vo %RED%VO_NAME%ENDCOLOR% \
    --createdb --deploy-database  --dbauser root  --dbapwd %RED%MYSQL_ROOT_PASSD%ENDCOLOR% \
    --dbusername  admin-%RED%VO_NAME%ENDCOLOR% --dbpassword %RED%secret %ENDCOLOR% \
    --port %RED%VOMS_PORT%ENDCOLOR%  --mail-from %RED%email%ENDCOLOR% --smtp-host %RED%smtp.domain%ENDCOLOR% \
    --sqlloc /usr/lib%RED%64%ENDCOLOR%/voms/libvomsmysql.so --cert /etc/grid-security/voms/vomscert.pem \
    --key  /etc/grid-security/voms/vomskey.pem --read-access-for-authenticated-clients 
</pre> For example::<pre class="rootscreen">
%UCL_PROMPT_ROOT% voms-admin-configure install --dbtype mysql --vo test1 --createdb \
     --deploy-database --dbauser root --dbapwd  top_secret \
     --dbusername admin_test1 --dbpassword secret 
     --port 15001 --mail-from tlevshin@fnal.gov --smtp-host smtp.fnal.gov \
     --sqlloc /usr/lib64/voms/libvomsmysql.so --cert /etc/grid-security/voms/vomscert.pem \
     --key  /etc/grid-security/voms/vomskey.pem --read-access-for-authenticated-clients 
</pre>
   1. Add a local admin:<pre class="rootscreen">
%UCL_PROMPT_ROOT% /usr/sbin/voms-db-deploy.py add-admin --vo %RED%VO_NAME%ENDCOLOR%  \
        --dn  %RED%HOST_CERT_SUBJECT%ENDCOLOR% \
        --ca %RED%HOST_CERT_ISSUER%ENDCOLOR% 
</pre>For example:<pre class="rootscreen">
%UCL_PROMPT_ROOT% /usr/sbin/voms-db-deploy.py add-admin --vo test1 \
     --dn /DC=org/DC=doegrids/OU=Services/CN=fermicloud002.fnal.gov \
     --ca "/DC=org/DC=DOEGrids/OU=Certificate Authorities/CN=DOEGrids CA 1"
</pre>
%ENDSECTION{"ConfigureVoms"}%

%STARTSECTION{"ConfigureTrustManager"}%
Configure Tomcat's trust manager:
   1. You have to configure Tomcat in order to enable EMI trustmanager:<pre class="rootscreen">
%UCL_PROMPT_ROOT% /var/lib/trustmanager-tomcat/configure.sh
Info: using default install root: /
Info: using default configuration file: //var/lib/trustmanager-tomcat/config.properties
Info: using default configuration directory: //var/lib/trustmanager-tomcat
Info: you can clean up using the following commands
      mv -f /etc/tomcat5/server.xml.old-trustmanager /etc/tomcat5/server.xml
      rm -f /usr/share/tomcat5/server/lib/bcprov*.jar
      rm -f /usr/share/tomcat5/server/lib/log4j*.jar
      rm -f /usr/share/tomcat5/server/lib/trustmanager-*.jar
      rm -f /etc/tomcat5/log4j-trustmanager.properties
      rm -f //var/lib/trustmanager-tomcat/server.xml
</pre>
%ENDSECTION{"ConfigureTrustManager"}%

---+ Services Startup/Shutdown
VOMS has its persistent repository in a !MySQL database, that requires =mysql= to be running in order to be queried.
All grid interactions require updated CA certificates and CRLs.
Then the _voms server_ is a daemon servicing authentication requests and _voms-admin_, requiring Tomcat, is a Web UI/service to manage the VO membership. 

%STARTSECTION{"StartVOMSServices"}%
To start VOMS you need to start several services:
   1. You need an updated CRL before you can use VOMD, to do so<pre class="rootscreen">
%UCL_PROMPT_ROOT% fetch-crl
</pre>
   1. !MySQL server needs to be running if it is not already:<pre class="rootscreen">
%UCL_PROMPT_ROOT% service mysqld start
</pre>
   1. Start voms server<pre class="rootscreen">
%UCL_PROMPT_ROOT% service voms start
</pre>
   1, Start Tomcat, required by voms-admin:<pre class="rootscreen">
%UCL_PROMPT_ROOT% service tomcat5 start
</pre>
   1. Start voms-admin:<pre class="rootscreen">
%UCL_PROMPT_ROOT% service voms-admin start
</pre>
%ENDSECTION{"StartVOMSServices"}%

%STARTSECTION{"StopVOMSServices"}%
To stop VOMS you need to stop voms and voms-admin, and also the services they use if nothing else is using them:
   1. Stop voms-admin:<pre class="rootscreen">
%UCL_PROMPT_ROOT% service voms-admin stop
</pre>
   1. Stop voms server<pre class="rootscreen">
%UCL_PROMPT_ROOT% service voms stop
</pre>
   1, Stop Tomcat, if no other application is using it:<pre class="rootscreen">
%UCL_PROMPT_ROOT% service tomcat5 stop
</pre>
   1. Stop !MySQL server if no other application is using it:<pre class="rootscreen">
%UCL_PROMPT_ROOT% service mysql stop
</pre>
%ENDSECTION{"StopVOMSServices"}%


---+ Test
To test VOMS you can add a member (her/his certificate) to a VO using voms-admin, login in the Web UI and then use the voms server to generate a proxy for that certificate. 

---++ Voms-admin test
Add a member(yourself) to the VO:<pre class="rootscreen">
%UCL_PROMPT_ROOT% voms-admin --vo %RED%VO_NAME%ENDCOLOR% --host %RED%HOST_NAME%ENDCOLOR% \
       --nousercert create-user %RED%USER_CERT_SUBJECT%ENDCOLOR% %RED%USRT_CERT_ISSUER%ENDCOLOR% \
       %RED%USER_COMMON_NAME%ENDCOLOR% %RED%email%ENDCOLOR% 
</pre> For example:<pre class="rootscreen">
%UCL_PROMPT_ROOT% voms-admin --vo test1 --host fermicloud002 --nousercert create-user \
   "/DC=org/DC=doegrids/OU=People/CN=Joe Doe 12345" "/DC=org/DC=DOEGrids/OU=Certificate Authorities/CN=DOEGrids CA 1" 
   "Joe Doe" jdoe@fnal.gov
</pre>Assign VOAdmin role to yourself, so you can manage the VO using the Web UI:<pre class="rootscreen">
voms-admin --vo %RED%VO_NAME%ENDCOLOR% --host %RED%HOST_NAME%ENDCOLOR% \
    --nousercert assign-role  %RED%/VO_NAME%ENDCOLOR%  VO-Admin  \
      %RED%USER_CERT_SUBJECT%ENDCOLOR% %RED%USRT_CERT_ISSUER%ENDCOLOR% 
</pre>For example:<pre class="rootscreen">
%UCL_PROMPT_ROOT% voms-admin --vo test1 --host fermicloud002 --nousercert assign-role /test1   VO-Admin  \
   "/DC=org/DC=doegrids/OU=People/CN=Joe Doe 12345" "/DC=org/DC=DOEGrids/OU=Certificate Authorities/CN=DOEGrids CA 1" </pre>

Check the Web UI by accessing ==https://%RED%hostname%ENDCOLOR%:8443/vomses==. If you have your certificate loaded into the browser you will be able to manage the VO.

---++ Voms-core test:
Use ==voms-proxy-init== to generate proxy. Login as user, create ==vomses== file (e.g. =~/.vomses=):<pre class="file">
"%RED%alias%ENDCOLOR%" "%RED%HOST_NAME%ENDCOLOR%" "%RED%PORT%ENDCOLOR%" "%RED%HOST DN%ENDCOLOR%" "%RED%VO_NAME%ENDCOLOR%"
</pre> For example:
<pre class="file">
"test1" "fermicloud002.fnal.gov" "15001" "/DC=org/DC=doegrids/OU=Services/CN=fermicloud002.fnal.gov" "test1"
</pre> Generate voms proxy<pre class="screen">
%UCL_PROMPT% voms-proxy-init -voms %RED%VO_NAME%ENDCOLOR% -vomses ~/vomses
</pre>

%STOPINCLUDE%



---+ References
EMI documentation:
   1. [[https://twiki.cern.ch/twiki/bin/view/EMI/EMIVomsDocumentation][EMI VOMS documentation]]
   1. [[https://twiki.cern.ch/twiki/bin/view/EMI/EMIVomsAdminUserGuide261][VOMS Admin User Guide]]
   1. [[https://twiki.cern.ch/twiki/bin/view/EMI/VOMSystemAdministratorGuide][VOMS System Admin Guide]]

<!--
[[http://www.eu-emi.eu/documentation][EMI]]/gLite documentation:
https://twiki.cnaf.infn.it/twiki/bin/view/VOMS/WebArchitecture
https://twiki.cern.ch/twiki/bin/view/EGEE/VomsAdminUserGuide
https://twiki.cern.ch/twiki/bin/view/EGEE/VomsInstallGuide_32
https://twiki.cern.ch/twiki/bin/view/LCG/VomsFAQforServiceManagers
https://edms.cern.ch/file/973684/1/voms-guide.pdf
-->

---+ *Comments*
%COMMENT{type="tableappend"}%

<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = MarcoMambelli

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = VO

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = Installation
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local TEST_READY   = %YES%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = TanyaLevshina
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %IN_PROGRESS%


DEAR DOCUMENT TESTER
 ====================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = MarcoMambelli
 Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %IN_PROGRESS%

############################################################################################################
-->

%META:TOPICMOVED{by="MarcoMambelli" date="1314748373" from="Documentation.Rel3InstallVoms" to="Documentation/Release3.InstallVoms"}%
