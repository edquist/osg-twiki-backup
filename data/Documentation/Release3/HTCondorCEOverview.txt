%META:TOPICINFO{author="BrianLin" date="1412882680" format="1.1" reprev="1.3" version="1.3"}%
---+ HTCondor CE Overview

At the heart of the OSG Compute Element (CE) is the job gateway software.  The job gateway anchors three core pieces of functionality:

   * *Remote access*: The gatekeeper provides a network service with a well-defined protocol that remote clients can contact and interact with.
   * *Authentication and authorization*: The gatekeeper is responsible for authenticating the client and deciding on what actions said client is authorized to perform.
   * *Job delegation*: The gatekeeper accepts an abstract description of a resource to allocate and directs the job to the local resource manager for resource allocation

One of the options for a job gateway solution in the OSG is a piece of software called HTCondor-CE.  The HTCondor-CE is a special configuration of the HTCondor software to provide the three core pieces of functionality.

---++ Remote Access

HTCondor provides remote access using a custom communication protocol called [[http://research.cs.wisc.edu/htcondor/doc/flexible_sessions.pdf][CEDAR]].  CEDAR provides a RPC and messaging mechanism over UDP or TCP, and can provide various levels of integrity or encryption based upon the session parameters.

---++ Authentication and Authorization

Out-of-the-box, the HTCondor-CE defaults to GSI-based authentication and authorization (same as Globus GRAM), which will work with pre-existing GUMS servers or Grid mapfiles. Additionally, it can be reconfigured to provide alternate authentication mechanisms such as Kerberos, SSL, shared secret, or even IP-based authentication.

---++ Job Delegation

The HTCondor-CE delegates jobs by having the client submit HTCondor jobs to a scheduler running on the CE (the condor_schedd daemon).  We refer to this as the "grid job".  A separate daemon, the !JobRouter, is responsible for transforming the grid job to a format that the site's resource manager can consume. This job transformation happens according to sets of customizable "job routes" that can handle and add attributes to specific jobs. We refer to the transformed job as the "routed job". For a site with a HTCondor batch system, the !JobRouter will transform and mirror the grid job into the routed job in the site's batch system.  The process is illustrated below:

<img src="%ATTACHURLPATH%/ce_condorbatchsystem.png" alt="condor-ce-condor-schematics.png" width='320' height='306' /> 

Notice the !JobRouter copies the job directly into the site's batch system and does not make use of =condor_submit=. This means that if the HTCondor batch system is setup to add attributes to incoming jobs when they are submitted (i.e. =SUBMIT_EXPRS=), these attributes will not be added to the routed jobs.

Submission into a non-HTCondor batch system is done slightly differently: in the case of a PBS batch system, the routed job stays in the HTCondor-CE schedd (as the !JobRouter does not know how to submit directly into the PBS queue), and the routed job is submitted into PBS using the blahp daemon, resulting in the batch job. See the illustration below:

<img src="%ATTACHURLPATH%/ce_otherbatchsystem.png" alt="condor-ce-condor-schematics.png" width='320' height='306' /> 

Notice the blahp, not the !JobRouter, does the submission to PBS in this case. The blahp daemon is a common piece of software for interacting with batch systems - in addition to being integrated in the HTCondor grid universe, it also is used by the BOSCO project and the CREAM CE. 

Note there is no requirement that the job be routed into a batch system - given the appropriate transform logic. the !JobRouter could also transform the grid job into VM running in Amazon EC2, an OpenStack instance, or a job for another HTCondor-CE!

-- Main.BrianLin - 09 Oct 2014

%META:FILEATTACHMENT{name="ce_condorbatchsystem.png" attachment="ce_condorbatchsystem.png" attr="" comment="A diagram of the HTCondor CE/HTCondor batch system job submission" date="1412871085" path="ce_condorbatchsystem.png" size="22860" stream="ce_condorbatchsystem.png" tmpFilename="/usr/tmp/CGItemp14227" user="BrianLin" version="1"}%
%META:FILEATTACHMENT{name="ce_otherbatchsystem.png" attachment="ce_otherbatchsystem.png" attr="" comment="A diagram of the HTCondor CE/non-HTCondor batch system job submission" date="1412871141" path="ce_otherbatchsystem.png" size="23591" stream="ce_otherbatchsystem.png" tmpFilename="/usr/tmp/CGItemp18203" user="BrianLin" version="1"}%
