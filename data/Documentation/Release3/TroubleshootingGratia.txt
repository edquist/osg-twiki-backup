%META:TOPICINFO{author="AlainRoy" date="1333473986" format="1.1" reprev="1.2" version="1.2"}%
%META:TOPICPARENT{name="WebHome"}%
%DOC_STATUS_TABLE%

---+!! Troubleshooting Gratia Accounting

%TOC%

---+ About this document
%RED%DRAFT: This document is in progress. It is not done and should not be considered useful yet.%ENDCOLOR% 

This document will help you troubleshoot problems with the Gratia Accounting, particularly with problems in collecting and reporting accounting information to the central OSG accounting service. See also other documents recommended in the Reference section below.

This document follows the general OSG documentation conventions: %TWISTY{%TWISTY_OPTS_OUTPUT% showlink="Click to expand document conventions..."}%
%INCLUDE{"Documentation/DocumentationTeam/DocConventions" section="Header"}%
%INCLUDE{"Documentation/DocumentationTeam/DocConventions" section="CommandLine"}%
%ENDTWISTY%

---++ How to get Help?
To get assistance please use [[HelpProcedure][Help Procedure]]. 

---+ Understanding Gratia Probes

Gratia is software used in OSG to gather accounting information. The information is collected from individual resources at a site, such as a Compute Element or a Storage Element. The program that collects the data is called a "Gratia probe". The information is transfered to a Gratia server. Most sites will choose to send the accounting data to the central OSG Gratia server, but you can also use a Gratia server at your site (which can send forward the data to the central OSG Gratia server). Here is a diagram:

<img src="%ATTACHURLPATH%/gratia-basics.png" alt="gratia-basics.png" height='300' />    

A few definitions:

   * *Gratia probe*: A piece of software that collects accounting data from the computer on which it's running, and transmits it to a Gratia server.
   * *Gratia server*: A server that collects Gratia accounting data from one or more sites and can share it with users via a web page. 
   * *Reporter*: A web service running on the Gratia server. Users can connect to the reporter via a web browser to explore the Gratia data.
   * *Collector*: A web service running ont he Gratia server that collects data from one or more Gratia probes. Users do not directly interact with the collector.

You can see the central Gratia reports at [[http://gratia-osg-prod-reports.opensciencegrid.org/gratia-reporting/][the central OSG Gratia server]].

You can see a fancier version of the Gratia data at [[http://display.grid.iu.edu/][display.grid.iu.edu]]. This is *not* running a Gratia collector, but is a separate service. 

---++ Overall process of how Gratia probes work

<pre class="file">
Every N minutes, cron job runs (or service works) [todo, check what N is]
	Reads ProbeConfig
	Grabs files from /var/lib/gratia/tmp/gratifiles/...
	Pushes data to Gratia collector as a bundle. (May wait for extra time if don't have a full bundle)
	Everything is logged to /var/log/gratia
	If fails:
		Nothing is removed from /var/lib/gratia/tmp/gratiafiles
		Errors are logged to log files
		Will try again next time. 
		In some cases, failed transfers get moved somewhere else. No details, [todo] ask Brian
</pre>


---++ Running Gratia probes

<pre class="rootscreen">
service gratia-probes-cron start
service gratia-probes-cron stop
service gratia-probes-cron status
</pre>

---++ Configuring Gratia

=osg-configure= does the editing, at least on the CE. 

Some bits on Gratia from config.ini

Some bits on Gratia's ProbeConfig dir.

---+ Common Gratia Problems

PER_JOB_HISTORY_DIR

Debugging trick: give bad URL for collector so you can see the files. these files have a brief lifetime because they are created by the probe and (normally) sent immediately. 


---+ Appendix: Important Gratia files

This document cannot cover all the errors you might experience. If you need to look for more data, you can look at log files for the various services on your CE. 

| *File* | *Purpose* |
| =/var/log/gratia/%RED%DATE%ENDCOLOR%.log | Log file that records information about processing and uploading of Gratia accounting data |
| =/var/log/gratia/gridftpTransfer.log= | Log file specific to the Gratia !GridFTP probe |
| =/var/lib/gratia/data= | Location for Condor and PBS job data before being processed by Gratia<br>Condor's =PER_JOB_HISTORY_DIR= should be set to this location |
| =/var/lib/gratia/tmp/gratiafiles= | Location for temporary Gratia data as it is being processed. Usually empty.<br>If you have file more than 30 minutes old in this directory, there may be a problem |
| =/etc/gratia/%RED%PROBE-NAME%ENDCOLOR%/ProbeConfig= | Configuration for Gratia probes<br>There is one per probe type</br>Normally you don't need to edit this |
---+ References
TBD

---+ Comments
%COMMENT{type="tableappend"}%


<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = AlainRoy

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = User

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = Installation
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %NO%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %NO%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %NO%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = TanyaLevshina 	
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %NO%


 DEAR DOCUMENT TESTER
 ====================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = TanyaLevshina 	
 Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %NO%
############################################################################################################
-->

%META:FILEATTACHMENT{name="gratia-basics.png" attachment="gratia-basics.png" attr="h" comment="" date="1333473469" path="gratia-basics.png" size="61665" stream="gratia-basics.png" tmpFilename="/usr/tmp/CGItemp50177" user="AlainRoy" version="1"}%
