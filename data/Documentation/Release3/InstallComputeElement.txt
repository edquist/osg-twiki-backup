%META:TOPICINFO{author="SoichiHayashi" date="1321722173" format="1.1" reprev="1.30" version="1.30"}%
%META:TOPICPARENT{name="InstallBestPractices"}%
%DOC_STATUS_TABLE%

---+!! Installing the Compute Element
%TOC%

---+ Requirements
A RHEL5 (or !CentOS 5, SL5) machine with [[http://fedoraproject.org/wiki/EPEL][EPEL]] repos enabled.

%INCLUDE{"YumRepositories" section="OSGRepoBrief" TOC_SHIFT="+"}%
%INCLUDE{"InstallCertAuth" section="OSGBriefCaCerts" TOC_SHIFT="+"}%

---+ Install the CE
   1 Install the CE RPM.  Do *ONE* of the following installation lines, depending on your batch system  <pre class="rootscreen">
%UCL_PROMPT_ROOT% yum --enablerepo=osg-testing install osg-ce-condor 
%UCL_PROMPT_ROOT% yum --enablerepo=osg-testing install osg-ce-pbs 
%UCL_PROMPT_ROOT% yum --enablerepo=osg-testing install osg-ce-lsf 
%UCL_PROMPT_ROOT% yum --enablerepo=osg-testing install osg-ce-sge
%UCL_PROMPT_ROOT% yum --enablerepo=osg-testing install osg-ce</pre>
The last one configures Globus to use the fork job manager.
To install managedfork, do the following:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% yum --enablerepo=osg-testing install globus-gram-job-manager-managedfork
</pre>

#ConfigureCE
---+ Configuration Instructions

---++ Run =osg-configure=

Edit the files in =/etc/osg/config.d=, then run this command to check that your configuration looks good

<pre class="rootscreen">
%UCL_PROMPT_ROOT% osg-configure -v
</pre>

Then run this command to configure your CE.

<pre class="rootscreen">
%UCL_PROMPT_ROOT% osg-configure -c 
</pre>

More documentation will go here soon, including hints on how to use your old config.ini file if you like. 

---++ Globus Gatekeeper

Installing the above packages will result in the Globus gatekeeper being installed and enabled as well as the appropriate jobmanager being installed and configured. To turn on the Globus gatekeeper:

<pre class="rootscreen">
%UCL_PROMPT_ROOT% /sbin/service globus-gatekeeper start
Started globus-gatekeeper                                  [  %GREEN%OK%ENDCOLOR%  ]
</pre>

   * globus-gatekeeper init script fails silently if you don't have /etc/grid-security/hostcert.pem / hostkey.pem

---++ Condor-specific notes

   * The Condor jobmanager is configured to not use a shared file system.  There are some rare use cases where this break; if you think this is causing issues, set =isNFSLite=0= in =/etc/globus/globus-condor.conf=.
   * You can control the mapping of jobs to Condor accounting groups using the files =/etc/osg/extattr_table.txt= and =/etc/osg/uid_table.txt=.  See the OSG's documentation on group accounting for more information.

---++ PBS-specific notes
   * The location of =qsub=, =qstat=, and =qdel= are configured in the file =/etc/globus/globus-pbs.conf=.  Confirm that the locations are correct for your PBS installation.  They default to the PBS locations in EPEL, for example: =/usr/bin/qstat-torque=.
   * A new feature of Globus is SEG.  In order for SEG to work, the pbs server logs need to be available to the globus-gatekeeper.  If they are not available (for example, the pbs_server is not running on the gatekeeper), you can turn off by removing the option in =/etc/grid-services/jobmanager-pbs=.
      * If the server_logs are available, then their location is configured in =/etc/globus/globus-pbs.conf=.


---++ Authorization

---+++ Authorization Option #1: GUMS

   * Edit =/etc/lcmaps.db= (modify value passed to argument "--endpoint") and =/etc/gums/gums-client.properties= (change both gums.location and gums.authz entries) to reflect your GUMS server
   * Uncomment the single line in =/etc/grid-security/gsi-authz.conf=

#CeEdgMkgridmap
---+++ Authorization Option #2: edg-mkgridmap

   * Edit =/etc/edg-mkgridmap.conf=
   * <pre class="rootscreen">%UCL_PROMPT_ROOT% /sbin/service edg-mkgridmap start</pre>

edg-mkgridmap is a cron job, but you control whether it runs or not using an init script, as shown above. 

---++ Gratia

   * Edit /etc/gratia/[jobmanger-you-are-using]/ProbeConfig, configuring it like an existing CE.  Make sure you set !EnableProbe="1", otherwise the probe will never run.
   * This will be performed by a near-future configure-osg.

---++ CEMon

Make sure =/etc/grid-security/grid-mapfile= exists, even if it is empty (i.e. =touch /etc/grid-security/grid-mapfile=).

You can either use the httpcert/httpkey or hostcert/hostkey. However, make sure the "tomcat" user has access to whichever cert/key pair you decide to use. 
You can use the hostcert/key as follows

<pre class="rootscreen">
mkdir /etc/grid-security/http
cp /etc/grid-security/hostkey.pem /etc/grid-security/http
cp /etc/grid-security/hostcert.pem /etc/grid-security/http
chown -R tomcat:tomcat /etc/grid-security/http
chmod 0400 /etc/grid-security/http/hostkey.pem
</pre>

Make a directory for the GIP to use:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% mkdir /var/gip
%UCL_PROMPT_ROOT% mkdir /var/gip/tmp
</pre>

   * (Deprecated info alert!) gip no longer uses /var/gip/tmp. It stores tmp ldif files under /var/cache/gip (Make sure it's owned by tomcat). gip still uses /var/gip/log to store gip.log

---++ Other

Run =gums-host-cron= by hand once:
<pre class="rootscreen">
%UCL_PROMPT_ROOT% gums-host-cron
</pre>

---+ Start Services

<pre class="rootscreen">
%UCL_PROMPT_ROOT% /sbin/service fetch-crl-cron start
%UCL_PROMPT_ROOT% /sbin/service fetch-crl-boot start
%UCL_PROMPT_ROOT% /sbin/service condor start # Replace with batch system of your choice
%UCL_PROMPT_ROOT% /sbin/service globus-gatekeeper start
%UCL_PROMPT_ROOT% /sbin/service globus-gridftp-server start
%UCL_PROMPT_ROOT% /sbin/service tomcat5 start  # Tomcat is used for CEMon
%UCL_PROMPT_ROOT% /sbin/service gums-client-cron start
</pre>

Run 'chkconfig <service-name> on' command for any services that you want to start automatically after system reboot.

---+ Stop Services

Run following commands, only if you need to stop any services.

<pre class="rootscreen">
%UCL_PROMPT_ROOT% /sbin/service fetch-crl-cron stop
%UCL_PROMPT_ROOT% /sbin/service fetch-crl-boot stop
%UCL_PROMPT_ROOT% /sbin/service condor stop # Replace with batch system of your choice
%UCL_PROMPT_ROOT% /sbin/service globus-gatekeeper stop
%UCL_PROMPT_ROOT% /sbin/service globus-gridftp-server stop
%UCL_PROMPT_ROOT% /sbin/service tomcat5 stop  # Tomcat is used for CEMon
%UCL_PROMPT_ROOT% /sbin/service gums-client-cron stop
</pre>
---+ References

---+ Comments
%COMMENT{type="tableappend"}%

<!-- CONTENT MANAGEMENT PROJECT
############################################################################################################
 DEAR DOCUMENT OWNER
 ===================

 Thank you for claiming ownership for this document! Please fill in your FirstLast name here:
   * Local OWNER = AlainRoy

 Please define the document area, choose one of the defined areas from the next line
 DOC_AREA = (ComputeElement|Storage|VO|Security|User|Monitoring|General|Integration|Operations|Tier3)
   * Local DOC_AREA       = User

 define the primary role the document serves, choose one of the defined roles from the next line
 DOC_ROLE = (EndUser|Student|Developer|SysAdmin|VOManager)
   * Local DOC_ROLE       = SysAdmin

 Please define the document type, choose one of the defined types from the next line
 DOC_TYPE = (Troubleshooting|Training|Installation|HowTo|Planning|Navigation|Knowledge)
   * Local DOC_TYPE       = Installation
  Please define if this document in general needs to be reviewed before release ( %YES% | %NO% )
   * Local INCLUDE_REVIEW = %YES%

 Please define if this document in general needs to be tested before release ( %YES% | %NO% )
   * Local INCLUDE_TEST   = %YES%

 change to %YES% once the document is ready to be reviewed and back to %NO% if that is not the case
   * Local REVIEW_READY   = %YES%

 change to %YES% once the document is ready to be tested and back to %NO% if that is not the case
   * Local TEST_READY     = %YES%

 change to %YES% only if the document has passed the review and the test (if applicable) and is ready for release
   * Local RELEASE_READY  = %NO%


 DEAR DOCUMENT REVIEWER
 ======================

 Thank for reviewing this document! Please fill in your FirstLast name here:
   * Local REVIEWER       = SuchandraThapa 	
 Please define the review status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local REVIEW_PASSED  = %IN_PROGRESS%


 DEAR DOCUMENT TESTER
 ====================

 Thank for testing this document! Please fill in your FirstLast name here:
   * Local TESTER         = SuchandraThapa 	
 Please define the test status for this document to be in progress ( %IN_PROGRESS% ), failed ( %NO% ) or passed ( %YES% )
   * Local TEST_PASSED    = %IN_PROGRESS%
############################################################################################################
-->

%META:TOPICMOVED{by="MarcoMambelli" date="1318875735" from="Documentation/Release3.InstallCE" to="Documentation/Release3.InstallComputeElement"}%
