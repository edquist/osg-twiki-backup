%META:TOPICINFO{author="BrianLin" date="1411681428" format="1.1" reprev="1.3" version="1.3"}%
%TOC{depth="3"}%

---+ Troubleshooting HTCondor CE

Other HTCondor CE pages:
   * HTCondor CE overview and architecture (coming soon)
   * [[InstallHTCondorCE][Installing HTCondor CE]]
   * [[HTCondorCERoutes][Configuring HTCondor CE job routes]]

---++ HTCondor CE Troubleshooting Data

---+++ Job Router Log

The HTCondor CE job router log is the only log file produced by the job router itself. It contains valuable information when trying to troubleshoot issues with job routing.

*Location:*
<pre>/var/log/condor-ce/JobRouterLog</pre>

*Key contents:*
   * Every attempt to route a job
   * Routing success and failure messages
   * Job attribute changes (based on chosen route)
   * Job router process warnings and errors

*What to look for:*

   * Job is considered for routing:\
      <pre class="file">09/17/14 15:00:56 JobRouter (src=86.0,route=Local_LSF): <span style="background-color: yellow;">found candidate job</span></pre>\
      <p>In parentheses are the original HTCondor CE job ID (e.g., =86.0=) and the route (e.g., =Local_LSF=).</p>
   * Job is successfully routed:\
      <pre class="file">09/17/14 15:00:57 JobRouter (src=86.0,route=Local_LSF): <span style="background-color: yellow;">claimed job</span></pre>

---++ HTCondor CE Troubleshooting Tools

---+++ condor_ce_job_router_tool

---++++ Usage

To help troubleshoot your routes and how jobs will match to them. To get a dump of all of your routes (the output will look long because it combines your routes with =JOB_ROUTER_DEFAULTS=), run the following command:

<pre class="screen">
%UCL_PROMPT_ROOT% condor_ce_job_router_tool -config
</pre>

%TWISTY{%TWISTY_OPTS_OUTPUT% showlink="Show sample output..."}%
<pre class="screen">
Route 1
Name         : "Local_PBS"
Universe     : 9
MaxJobs      : 10000
MaxIdleJobs  : 2000
GridResource : batch pbs
Requirements : target.osgTestPBS is true
ClassAd      : 
    [
        set_osg_environment = "OSG_GRID='/etc/osg/wn-client/' OSG_SITE_READ='None' OSG_APP='/share/osg/app' OSG_HOSTNAME='fermicloud136.fnal.gov' OSG_DATA='UNAVAILABLE' OSG_GLEXEC_LOCATION='None' GLOBUS_LOCATION='/usr' OSG_STORAGE_ELEMENT='False' OSG_SITE_NAME='local' OSG_WN_TMP='None' PATH='/bin:/usr/bin:/sbin:/usr/sbin' OSG_SITE_WRITE='None' OSG_DEFAULT_SE='None' OSG_JOB_CONTACT='host.name/jobmanager-condor'"; 
        set_requirements = true; 
        MaxJobs = 10000; 
        copy_environment = "orig_environment"; 
        eval_set_remote_SMPGranularity = ifThenElse(InputRSL.xcount isnt null,InputRSL.xcount,ifThenElse(xcount isnt null,xcount,ifThenElse(default_xcount isnt null,default_xcount,1))); 
        delete_PeriodicRemove = true; 
        GridResource = "batch pbs"; 
        set_RoutedJob = true; 
        name = "Local_PBS"; 
        MaxIdleJobs = 2000; 
        eval_set_environment = debug(strcat("HOME=",userHome(Owner,"/")," ",ifThenElse(orig_environment is undefined,osg_environment,strcat(osg_environment," ",orig_environment)))); 
        eval_set_RequestMemory = ifThenElse(InputRSL.maxMemory isnt null,InputRSL.maxMemory,ifThenElse(maxMemory isnt null,maxMemory,ifThenElse(default_maxMemory isnt null,default_maxMemory,2000))); 
        eval_set_remote_NodeNumber = ifThenElse(InputRSL.xcount isnt null,InputRSL.xcount,ifThenElse(xcount isnt null,xcount,ifThenElse(default_xcount isnt null,default_xcount,1))); 
        eval_set_remote_queue = ifThenElse(InputRSL.queue isnt null,InputRSL.queue,ifThenElse(queue isnt null,queue,ifThenElse(default_queue isnt null,default_queue,""))); 
        eval_set_remote_cerequirements = ifThenElse(InputRSL.maxWallTime isnt null,strcat("Walltime == ",string(60 * InputRSL.maxWallTime)," && CondorCE == 1"),"CondorCE == 1"); 
        delete_osgTestPBS = true; 
        Requirements = target.osgTestPBS is true; 
        eval_set_RequestCpus = ifThenElse(InputRSL.xcount isnt null,InputRSL.xcount,ifThenElse(xcount isnt null,xcount,ifThenElse(default_xcount isnt null,default_xcount,1))); 
        delete_CondorCE = true; 
        TargetUniverse = 9
    ]

Route 2
Name         : "Condor Test"
Universe     : 5
MaxJobs      : 10000
MaxIdleJobs  : 2000
GridResource : 
Requirements : true
ClassAd      : 
    [
        set_osg_environment = "OSG_GRID='/etc/osg/wn-client/' OSG_SITE_READ='None' OSG_APP='/share/osg/app' OSG_HOSTNAME='fermicloud136.fnal.gov' OSG_DATA='UNAVAILABLE' OSG_GLEXEC_LOCATION='None' GLOBUS_LOCATION='/usr' OSG_STORAGE_ELEMENT='False' OSG_SITE_NAME='local' OSG_WN_TMP='None' PATH='/bin:/usr/bin:/sbin:/usr/sbin' OSG_SITE_WRITE='None' OSG_DEFAULT_SE='None' OSG_JOB_CONTACT='host.name/jobmanager-condor'"; 
        eval_set_accounting_group = "accounting_group"; 
        set_requirements = true; 
        MaxJobs = 10000; 
        copy_environment = "orig_environment"; 
        eval_set_remote_SMPGranularity = ifThenElse(InputRSL.xcount isnt null,InputRSL.xcount,ifThenElse(xcount isnt null,xcount,ifThenElse(default_xcount isnt null,default_xcount,1))); 
        delete_PeriodicRemove = true; 
        set_RoutedJob = true; 
        name = "Condor Test"; 
        MaxIdleJobs = 2000; 
        eval_set_environment = debug(strcat("HOME=",userHome(Owner,"/")," ",ifThenElse(orig_environment is undefined,osg_environment,strcat(osg_environment," ",orig_environment)))); 
        eval_set_accounting_group_user = "blin_user"; 
        eval_set_RequestMemory = ifThenElse(InputRSL.maxMemory isnt null,InputRSL.maxMemory,ifThenElse(maxMemory isnt null,maxMemory,ifThenElse(default_maxMemory isnt null,default_maxMemory,2000))); 
        eval_set_remote_NodeNumber = ifThenElse(InputRSL.xcount isnt null,InputRSL.xcount,ifThenElse(xcount isnt null,xcount,ifThenElse(default_xcount isnt null,default_xcount,1))); 
        eval_set_remote_queue = ifThenElse(InputRSL.queue isnt null,InputRSL.queue,ifThenElse(queue isnt null,queue,ifThenElse(default_queue isnt null,default_queue,""))); 
        eval_set_remote_cerequirements = ifThenElse(InputRSL.maxWallTime isnt null,strcat("Walltime == ",string(60 * InputRSL.maxWallTime)," && CondorCE == 1"),"CondorCE == 1"); 
        Requirements = true; 
        eval_set_RequestCpus = ifThenElse(InputRSL.xcount isnt null,InputRSL.xcount,ifThenElse(xcount isnt null,xcount,ifThenElse(default_xcount isnt null,default_xcount,1))); 
        delete_CondorCE = true; 
        TargetUniverse = 5
    ]
</pre>
%ENDTWISTY%

To see how the !JobRouter is treating a job that's currently in the CE's queue, you can pipe the output of =condor_ce_q=:

<pre class="screen">
%UCL_PROMPT_ROOT% condor_ce_q -l %RED%&lt;job id&gt;%ENDCOLOR% | condor_ce_job_router_tool -match-jobs -ignore-prior-routing -jobads -
</pre>

%TWISTY{%TWISTY_OPTS_OUTPUT% showlink="Show sample output..."}%
<pre class="screen">
Matching jobs against routes to find candidate jobs.

Checking for candidate jobs. routing table is:
Route Name             Submitted/Max        Idle/Max     Throttle
Local_PBS                      0/  10000       0/   2000     none
Condor Test                    0/  10000       0/   2000     none

Umbrella constraint: ((target.x509userproxysubject =!= UNDEFINED) && (target.x509UserProxyExpiration =!= UNDEFINED) && (time() < target.x509UserProxyExpiration) && (target.JobUniverse =?= 5 || target.JobUniverse =?= 1)) && ( (target.osgTestPBS is true) || (true) ) && (target.ProcId >= 0 && target.JobStatus == 1 && (target.StageInStart is undefined || target.StageInFinish isnt undefined) && target.Managed isnt "ScheddDone" && target.Managed isnt "External" && target.Owner isnt Undefined && target.RoutedBy isnt "htcondor-ce")
Checking Job src=162,0 against all routes
	Route Matches: Condor Test
Found candidate job src=162,0,route=Condor Test
1 candidate jobs found
</pre>
%ENDTWISTY%

Or for a job that's already left the queue, you'll want to use =condor_ce_history=:

<pre class="screen">
%UCL_PROMPT_ROOT% condor_ce_history -l %RED%&lt;job id&gt;%ENDCOLOR% | condor_ce_job_router_tool -match-jobs -ignore-prior-routing -jobads -
</pre>

%NOTE% If the proxy for the job has expired, the job will not match any routes. We can work around this constraint with some quick hacking:

<pre class="screen">
%UCL_PROMPT_ROOT% condor_ce_history -l %RED%&lt;job id&gt;%ENDCOLOR% | sed "s/^\(x509UserProxyExpiration\) = .*/\1 = `date +%s --date '+1 sec'`/" | condor_ce_job_router_tool -match-jobs -ignore-prior-routing -jobads -
</pre>

Alternatively, you can provide a file containing the !JobAd as the input and edit attributes to your liking within that file:

<pre class="screen">
%UCL_PROMPT_ROOT% condor_ce_job_router_tool -match-jobs -ignore-prior-routing -jobads %RED%&lt;JobAd file&gt;%ENDCOLOR%
</pre>

---++++ Diagnosing incorrect routing

   1. *If your job isn't matching to any route*, you can tell when you see =0 candidate jobs found= in your output. This means that when compared to your !JobAd, the Umbrella constraint doesn't evaluate to =true=. When troubleshooting, you will want to look at all the expressions prior to the =ProcId= expression since it and everything following it is logic tacked on by the !JobRouter so that routed jobs don't get routed again (this logic is dealt with the flag =-ignore-prior-routing=).  %TWISTY{%TWISTY_OPTS_OUTPUT% showlink="Show sample output..."}%<pre class="screen">
Umbrella constraint: ((target.x509userproxysubject =!= UNDEFINED) && (target.x509UserProxyExpiration =!= UNDEFINED) && (time() < target.x509UserProxyExpiration) && (target.JobUniverse =?= 5 || target.JobUniverse =?= 1)) && ( (target.osgTestPBS is true) || (true) ) && (target.ProcId >= 0 && target.JobStatus == 1 && (target.StageInStart is undefined || target.StageInFinish isnt undefined) && target.Managed isnt "ScheddDone" && target.Managed isnt "External" && target.Owner isnt Undefined && target.RoutedBy isnt "htcondor-ce")
%RED%0 candidate jobs found%ENDCOLOR%
</pre> %ENDTWISTY%
   1. *If your job matches more than one route*, the tool will tell you by showing all the routes below the job ID: <pre class="screen">Checking Job src=162,0 against all routes
	Route Matches: Local_PBS
	Route Matches: Condor Test
</pre> To troubleshoot why this is occuring, you will need to look at the combined Requirements expressions and compare it to the !JobAd provided. The combined Requirements expression in my case is the part highlighted in %RED%RED%ENDCOLOR%:  <pre class="screen">Umbrella constraint: ((target.x509userproxysubject =!= UNDEFINED) && (target.x509UserProxyExpiration =!= UNDEFINED) && (time() < target.x509UserProxyExpiration) && (target.JobUniverse =?= 5 || target.JobUniverse =?= 1)) && %RED%( (target.osgTestPBS is true) || (true) )%ENDCOLOR% && (target.ProcId >= 0 && target.JobStatus == 1 && (target.StageInStart is undefined || target.StageInFinish isnt undefined) && target.Managed isnt "ScheddDone" && target.Managed isnt "External" && target.Owner isnt Undefined && target.RoutedBy isnt "htcondor-ce")
</pre>Both routes evaluate to =true= for the !JobAd I provided because it had =osgTestPBS = true=. Make sure your routes are mutually exclusive, otherwise you may have jobs routed to the wrong places!

---+++ condor_ce_trace

---+++ condor_ce_ping

---+++ condor_ce_status

---++ General Troubleshooting Steps

---+++ Making Sure Packages Are Up-To-Date

HTCondor CE is still changing often, and so it is important to make sure that the relevant RPMs are up-to-date.

   1. Determine packages to check on your system\
       <p>How?</p>
   1. Update packages\
       <pre class="screen">yum update <em>packages</em></pre>\
       <p>If you just want to see the packages to update, but do not want to perform the update now, answer <code>N</code> at the prompt.</p>

---++ HTCondor CE Troubleshooting Items

---+++ Jobs Stay Idle Forever

Jobs stay idle in queue forever. Example:

<pre class="screen"></pre>

%NOTE% Jobs may take a while to match and run.

Check the following subsections in order.

---++++ Make sure the underlying batch system can run jobs

[Brief description of troubleshooting step or issue, if needed.]

*Procedure*
   1. Manually create and submit a simple job (e.g., =sleep=)
   1. Check for errors in the submission itself
   1. Watch the job in the batch system queue (e.g., using =condor_q=)
   1. If the job runs, check for errors

*Next actions*

If the underlying batch system does not run a simple manual job, it will probably not run a job coming from HTCondor CE. Once you can run simple manual jobs on your batch system, then try HTCondor CE again.

---++++ Is the Job Router handling incoming jobs at all?

Is it the routes/JobRouter? Are they getting picked up by the job_router? Search for src=<job id> in /var/log/condor-ce/JobRouterLog. You should find some strings that say it's being claimed by route=<route name>. If they don't match a route, they'll go on hold after 30 min (I think?). If they're matching the WRONG route, routes are matched in a 'round robin' type way so routes should be designed to be exclusive.

---++++ Verify correct operation within the BLAHP

Are there any errors in GridmanagerLog.<job owner>? blahp/gahp output gets dumped here.

---++++ Verify ability to change permissions on key files

[Brief description of troubleshooting step or issue, if needed.]

*Sample failure*

<pre class="file">09/17/14 14:45:42 Error: Unable to chown '/var/lib/condor-ce/spool/1/0/cluster1.proc0.subproc0/env' from 12345 to 54321</pre>

*Next actions*

   1. As root, try to change ownership on a file
   1. If using a shared file system, verify that root squash is turned off\
       <pre class="screen">do stuff here</pre>

---+++ Jobs Go on Hold

---++++ Symptoms

Jobs go on hold.

<pre class="screen"></pre>

---++ Further Help with HTCondor CE

---+++ Something

---+++ Requesting Help From OSG

Blah.

   1. <p>Gather basic HTCondor CE and related information</p>
   1. <p>Gather basic system information</p>\
       <pre class="screen">osg-system-profiler &gt; ~/osg-system-profiler-<span style="background-color: yellow;">YYYYMMDD</span>.txt</pre>
   1. <p>Send email to goc@opensciencegrid.org</p>
      * Describe issue and expected or desired behavior
      * Include basic HTCondor CE and related information
      * Attach osg-system-profiler output
