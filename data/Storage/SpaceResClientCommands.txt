%META:TOPICINFO{author="KyleGross" date="1225985967" format="1.1" version="1.6"}%
%META:TOPICPARENT{name="SpaceReservation"}%
Here are instructions for making and using space reservations.

---++++++ Using Opportunistic Storage

Check that the site's storage element is configured for opportunistic use. The site's policy page may have this information <font color="red">?</font>, or if they have made use of their information service to publish the info, you can find it with the following ldap command

<verbatim>
ldapsearch ... need to work out ldap search command
</verbatim>

In the meantime, contact your VirtualOrganizations/VOInfo administration for the storage element endpoint.

With the above information, create a space reservation as follows

<verbatim>
 /opt/d-cache/srm/bin/srm-reserve-space -desired_size=5000000000 -guaranteed_size=5000000000 -retention_policy=REPLICA \
-access_latency=ONLINE -lifetime=86400 -space_desc=my5GB srm://srmserver.oursite.edu:8443
</verbatim>

with the retention policy of REPLICA. The above would reserve 5 GB for 24 hours. You will see the space token printed in the output.

<verbatim>
Space token =112
</verbatim>

To use the space, include the space token in the command line of the srm client.

<verbatim>
/opt/vdt/srm-v1-client/bin/srmcp -space_token=112 -2 file:////home/myusername/test1 \
srm://srmserver.oursite.edu:8443/srm/managerv2?SFN=/pnfs/oursite.edu/data/public/mydir/test1
</verbatim>

where the endpoint and rootpath are those obtained from the site's web page or information service. Remember, files written to opportunistic storage are temporary and will be removed when the space reservation they were written with has expired.

Depending on how the site policy, it may be possible to skip the step of making the space reservation and write into the opportunistic space without specifying a space token. In this case, be aware that a temporary space reservation is then automatically made, which expires immediately after the transfer is completed. Therefore, the file might be removed at any time thereafter. It is best to verify that the site has a policy of retaining such files for a sufficient amount of time before using this feature. 

---+++++ Effects from mismatch of attributes

---++++++ srm-reserve-space

With no pools explicity linked to the volatile link group (as above), this reservation will succeed, but transfers will actually fail with a "no space available" message.

<verbatim>
 /opt/d-cache/srm/bin/srm-reserve-space -desired_size=1000000 -guaranteed_size=1000000 -retention_policy=REPLICA \
-access_latency=ONLINE -lifetime=86400 -space_desc=tedsmillion srm://testsrmserver.fnal.gov:8443
</verbatim>

The correct value for retention_policy in this case is CUSTODIAL.

<verbatim>
 /opt/d-cache/srm/bin/srm-reserve-space -desired_size=1000000 -guaranteed_size=1000000 -retention_policy=CUSTODIAL \
-access_latency=ONLINE -lifetime=86400 -space_desc=tedsmillion srm://testsrmserver.fnal.gov:8443
</verbatim>

You will see the token in the output

<verbatim>
Space token =18
</verbatim>

---++++++ srmcp

The token is used in srmcp. Even then, if the client (srmcp) specifies -retention_policy=REPLICA on the srmcp command line, the transfer will fail for the same reason. 

<verbatim>
/opt/d-cache/srm/bin/srmcp -retry_num=0 -srm_protocol_version=2 -space_token=18 \
file:////tmp/testfile srm://testsrmserver.fnal.gov:8443/pnfs/fnal.gov/data/test1
</verbatim>

Note: if the client specifies retention_policy=REPLICA on the command line,

<verbatim>
/opt/d-cache/srm/bin/srmcp -retry_num=0 -srm_protocol_version=2 -retention_policy=REPLICA -space_token=18 \
file:////tmp/testfile srm://testsrmserver.fnal.gov:8443/pnfs/fnal.gov/data/test1
</verbatim>

The option will be ignored and the file will be written to the custodial pool group.

-- Main.TedHesselroth - 16 April 2006