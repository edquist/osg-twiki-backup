%META:TOPICINFO{author="TedHesselroth" date="1248901136" format="1.1" reprev="1.7" version="1.7"}%
%META:TOPICPARENT{name="OpportunisticStorage"}%
---+!! *<noop>%SPACEOUT{ "%TOPIC%" }%*

---+++++ Purpose

The use of storage in the OSG by the [[http://www.scec.org][Southern California Earthquake Center]] is another step towards fully-automated open storage. Besides actually providing storage and compute resources to SCEC, the goal of this project is to exercise some of the new supporting infrastructure for opportunistic storage, namely, the discovery tools. As such, some managed coordination is needed for the initial production.

---+++++ The Use Case

The SCEC use case is summarized by

   * 1 Terabyte of data
   * 700,000 files
   * Uploaded to SE once, then read by jobs
   * Data is read in job context by posix IO
      * Size per read:
      * Read proximities (i.e., are subsequent reads "near" each other such that caching will be effective):

The files are in 20 tarred packages. Data placement is done by uploading a tar file to the SE, then unpacking it into the SE by a job running on the computing element. Then consensus from experts is that 700,000 files will not present a problem to Storage Elements, though it is estimated that in a Hadoop installation it will result in an additional memory consumption of 700 MB in the Namenode. We also conclude that dCache would not reliably support posix IO without significant changes to the SCEC codebase; therefore we will not pursue participation by dCache sites for this project.

---+++++ Initial Participating Sites

These sites have agreed to support SCEC

   * Purdue
   * Caltech
   * University of Oklahoma
   * University of Nebraska at Omaha
   * University of Florida (tentative)

The plan is for Purdue to host the proof-of-concept tests and early production, then expansion to production on all the above sites, followed by expansion to other sites in the OSG. The VO to be used is initially the "engage" VO, though at a later point that may be changed to a "scec" VO. The following table shows the status of the project per-site. The table will be maintained by Ted Hesselroth, but site administrators may edit it themselves if they wish.


---++ Key

| *Symbol* | *Meaning* |
| %ICON{led-box-yellow}%  | Partial |
| %ICON{led-box-green}% | Complete |
| %ICON{led-box-red}% | Issue |
| %ICON{led-box-gray}% | Note |

---++ Workflow Checklist

%TABLE{ headerbg="#eeeeee" headercolor="#000000" databg="#ffffff" tableborder="1" columnwidths="120," cellpadding="2" cellspacing="1" dataalign="left" valign="top" sort="off"}%


| *Site*  | *Participation Confirmed* | *SE authz* | *CE authz* | *Space Res* | *BDII* | *First Upload* | *First CE/SE Test* | *Full Upload* | *Full CE/SE Test* | *Site Production*  | *Grid Production* | *VO change* | *Closure* |
| [[http://tiny.cc/5zqNy][Purdue]] | <p>%ICON{led-box-green}% </p> | | | | | | | | | | | | |
| [[http://tiny.cc/W1A6i][Caltech]] | <p>%ICON{led-box-green}% </p> | | | | <p>%ICON{led-box-green}% </p> | | | | | | | | |
| [[http://tiny.cc/Yzglz][U of Oklahoma]] | <p>%ICON{led-box-green}% </p> | | | | | | | | | | | | |
| [[http://tiny.cc/E7s5m][U of Nebraska-Omaha]] | <p>%ICON{led-box-green}% </p> | <p>%ICON{led-box-green}% </p>  | <p>%ICON{led-box-green}% </p> | |<p>%ICON{led-box-green}% </p> | | | | | | | | |
| [[http://tiny.cc/hgqaq][U of Florida]] | <p>%ICON{led-box-green}% </p> | | | | | | | | | | | | |

---+++++ Notes on Workflow Checklist Table

   * SE Authz is authorization on the Storage Element for the "engage" VO, by the means provided by the site's particular SRM implementation. SE authorization for space reservation by "engage" VO is encouraged.
   * CE Authz is authorization on the Storage Element for the "engage" VO.
   * Space reservation should be made by "engage" VO unless prohibited by site policy.
   * BDII is the value of "BDII Check" of the BDII Checklist table.
   * First Upload and First CE Test refer to the proof-of-concept test using a single SCEC tarfile.
   * Full Upload and Full CE Test refer to realistic jobs using all SCEC tarfiles.
   * Site Production is an optional intermediate step of production by direct submission to the site
   * Grid Production is production by jobs submitted to the OSG Resource Selection Service, to be run on any of the sites which host SCEC data.
   * VO Change is support of a potential "scec" VO, rather than "engage".
   * Closure means that no additional steps are needed by the site. A link to a site's summary or feedback on the project may be placed here.

---++++ BDII Checklist

#BDIIChecklistTable
%TABLE{ headerbg="#eeeeee" headercolor="#000000" databg="#ffffff" tableborder="1" columnwidths="120," cellpadding="2" cellspacing="1" dataalign="left" valign="top" sort="off"}%


| *Site*  | *SE FQAN* | *VO Path* | *SRM Endpoint* | *Available Space* | *SE Mount*  | *Space Token* | *BDII Check* |
| [[http://tiny.cc/5zqNy][Purdue]] | dcache.rcac.purdue.edu | |<p>%ICON{led-box-green}% </p> | | | | |
| [[http://tiny.cc/W1A6i][Caltech]] | cit-se2.ultralight.org | <p>%ICON{led-box-green}% </p> | <p>%ICON{led-box-green}% </p> | <p>%ICON{led-box-green}% </p> | | | <p>%ICON{led-box-green}% </p> |
| [[http://tiny.cc/Yzglz][U of Oklahoma]] | ouhep00.nhn.ou.edu | | | | | | |
| [[http://tiny.cc/E7s5m][U of Nebraska-Omaha]] | ff-srm.unl.edu | <p>%ICON{led-box-green}% </p> | <p>%ICON{led-box-green}% </p> | <p>%ICON{led-box-green}% </p> | | |<p>%ICON{led-box-green}% </p> |
| [[http://tiny.cc/hgqaq][U of Florida]] | srm.ihepa.ufl.edu | <p>%ICON{led-box-green}% </p> | <p>%ICON{led-box-green}% </p> | | | | |

---+++++ Notes on BDII Checklist Table

   * SE FQDN is taken from the service URI on <nop>MyOSG. Click on the site name in the table to view the <nop>MyOSG entry. Needed for checks of BDII info.
   * The columns for VO Path, SRM Endpoint, SE Mount, Available Space and Space Token refer to entries in the OSG BDII.
   * VO Path publishes the rootpath under which the "engage" VO is allowed to read and write.
   * SRM Endpoint is the URI of the storage web service.
   * Available Space indicates that there is enough space for a 1 TB space reservation to be made.
   * SE Mount tells whether the SE is accessible from worker nodes via a mount point. Optional until supported by OSG GIP.
   * Space Token is used by clients to access the reservation. Optional until Space Reservation from Workflow is finished.
   * BDII check will be done by Ted Hesselroth with the OSG Storage Discovery Tool. The tool will then be used in the steps leading up to production. When BDII check is complete, value is copied to BDII column of Workflow Checklist table.

---+++++ BDII Check XPath Expressions

FQDN is defined in the BDII Checklist table.

---++++++ VO Path
<verbatim>
//GlueSE[@GlueSEUniqueID='$FQDN']/GlueSA/GlueVOInfo[@GlueVOInfoAccessControlBaseRule=$vo]/@GlueVOInfoPath
</verbatim>

where $vo is the name of the VO, i.e., 'engage'. The name should be surrounded by single quotes in XPath use.

---++++++ SRM Endpoint
<verbatim>
//GlueSE[@GlueSEUniqueID='$FQDN']/GlueSEControlProtocol[@GlueSEControlProtocolVersion='2.2.0']/@GlueSEControlProtocolEndpoint
</verbatim>

---++++++ SRM Service Endpoint

The SRM service endpoint is defined as the above SRM endpoint with "httpg" replaced by "srm".

---++++++ Available Space
<verbatim>
//GlueSE[@GlueSEUniqueID='$FQDN']/GlueSA/@GlueSAFreeOnlineSize
</verbatim>

---++++++ SE Mount
<verbatim>
//GlueCESEBind[@GlueCESEBindSEUniqueID='$FQDN']/@GlueCESEBindCEAccesspoint
or
//GlueCESEBind[@GlueCESEBindSEUniqueID='$FQDN']/@GlueCESEBindMountInfo
</verbatim>

and in <nop>GlueSE

<verbatim>
//GlueSE[@GlueSEUniqueID='$FQDN']/GlueSEAccessProtocol[@GlueSEAccessProtocolType='file']
</verbatim>

---++++++ Space Token
<verbatim>
//GlueSE[@GlueSEUniqueID='$FQDN']/GlueSA/GlueVOInfo[@GlueVOInfoAccessControlBaseRule=$vo]/@GlueVOInfoTag
</verbatim>


---++++ Composition of Commands

Endpoints are the same regardless of SRM client used. Different client implementations use different argument lists. The definitions here can be expressed as XQuery scripts, runnable against the information service. For the xquery implementation of these definitions, see the links to the XQuery Scripts page below each definition.

---+++++ Space Reservation

SRM_SERVICE_ENDPOINT is as defined in the previous section.

---++++++ srm-reserve-space  
<verbatim>
srm-reserve-space -space_description=$DESCRIPTION -desired_size=$REQUESTED_SIZE -guaranteed_size=$GUARANTEED_SIZE -lifetime=$LIFETIME $SRM_SERVICE_ENDPOINT
</verbatim>

For the XQuery implementation, see [[https://twiki.grid.iu.edu/bin/view/Storage/OpportunisticStorageXQueryScripts#srm-reserve-space][XQuery Script for srm-reserve-space]].

---++++++ srm-sp-reserve  
<verbatim>
srm-sp-reserve -serviceurl $SRM_SERVICE_ENDPOINT -size $REQUESTED_SIZE -gsize $GUARANTEED_SIZE -lifetime $LIFETIME
</verbatim>

For the XQuery implementation, see [[https://twiki.grid.iu.edu/bin/view/Storage/OpportunisticStorageXQueryScripts#srm_sp_reserve][XQuery Script for srm-sp-reserve]].

---+++++ SRM Copy

The commands use the service URL, defined as

---++++++ SURL
<verbatim>
$SRM_SERVICE_ENDPOINT?SFN=$VO_PATH/filename
</verbatim>

SRM_SERVICE_ENDPOINT and VO_PATH are as defined in previous sections. Additional directory levels may be placed between VO_PATH and filename. They are created on the storage element if they do not exist.

For the XQuery implementation, see [[https://twiki.grid.iu.edu/bin/view/Storage/OpportunisticStorageXQueryScripts#SURL][XQuery Script for SURL]].

---++++++ srmcp  
<verbatim>
srmcp -srm_protocol_version=2 -space_token=$SPACE_TOKEN file:////path/to/file $SURL
</verbatim>

SPACE_TOKEN is that returned by the above space reservation command. It is optional but should be used for SCEC production.

For the XQuery implementation, see [[https://twiki.grid.iu.edu/bin/view/Storage/OpportunisticStorageXQueryScripts#srmcp][XQuery Script for srmcp]].

---++++++ srm-copy  
<verbatim>
srm-copy file:////path/to/file $SURL -spacetoken $SPACE_TOKEN
</verbatim>

For the XQuery implementation, see [[https://twiki.grid.iu.edu/bin/view/Storage/OpportunisticStorageXQueryScripts#srm_copy][XQuery Script for srm-copy]].

-- Main.TedHesselroth - 08 Jul 2009
