%META:TOPICINFO{author="TedHesselroth" date="1285011224" format="1.1" reprev="1.1" version="1.1"}%
%META:TOPICPARENT{name="OSGPublicStorage"}%
---+!! *<noop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%

---++ Making Allocations


These steps are needed.

---+++ Storage Area Registration

Each OSG Storage Element participating in opportunistic storage is registered by the OSG production coordinator in the allocation database. 

   1. The PC runs an OSG Discovery Tool storage area discovery utility of the PC Utilities to discover storage areas which qualify as public storage. 
   1. Upon verification, the PC runs a storage area registration utility which saves the output of the tool into the Storage Area Registry of the Allocation Accounting Service for every VO that has installed the AAS and requested storage. 
   1. The PC runs the storage area registry broadcast tool to propagate that information to all other AAS instances. 
   1. The PC runs the storage area registration test utility, which verifies that the above information has been successfully entered in the databases.

---+++ Public Storage Monitoring

The step is needed to support public storage allocation. These actions could be performed by a VOA-owned cron job

   1. The Pigeon Tool storage area verification tool of the VOA Utilities is invoked by the VOA.
   1. The VO’s Access Record Repository Catalog (ARR) is updated with the discovery and access results by the storage resource update utility. 

---+++ Requesting an Allocation

   1. To request an allocation, the VOA communicates with the PC, and include the following information.
   * The size of the allocation
   * The needed lifetime of the allocation.
   * The expiration time of the allocation will be set using this lifetime and the time that the allocation is made.
   * Optionally, other requirements pertaining to the site’s storage and compute resources.


---+++ Granting Allocations

When a VO requests space, an allocation must be done on a registered storage area.

   1. The PC runs an allocation decision tool that shows the PC the storage areas that could meet the allocation request.
   1. The PC selects a storage resource which meets the needs of the allocation.
   1. The PC enters the allocation into the AAS of every VO using the allocation update utility. This redundancy serves as a backup in case the VO loses its AAS database. 
   1. The PC checks that the allocation has been successfully entered by running the storage area info utility.
   1. The VOA confirms the allocation by running the allocation test utility.

   * Diagram of operations to make an allocation <br />
     <img src="https://twiki.grid.iu.edu/twiki/pub/Storage/OSGPublicStorage/pub_storage_1.jpg" alt="pub_storage_1.jpg" width='800' height='600' />    

---++ Changing an Allocation

   1. The VOA communicates to the PC a request to release, resize, or change the lifetime of an allocation. If the request is to release an allocation, it should first be cleaned up (see below).
   1. The PC uses the storage area info utility to decide whether the request can be met.
   1. The PC uses the Allocation update utility to change the corresponding attribute on the allocation object in the AAS of every VO.


---++ Allocation or Dataset Cleanup by a VO

Allocations are normally kept clean by users defining collections of files called "datasets", and deleting datasets when they expire or are no longer needed. See

   1. The VOA or user calls the allocation cleanup tool or the dataset cleanup tool. The allocation  cleanup tool does the following.
   * It tool checks the expiration attribute of every allocation object
   * For every expired allocation, it finds all datasets that refer to the allocation. This includes the default dataset for files that are not in any other dataset.
   * It deletes each dataset using the dataset operation tool.


---++ Allocation or Dataset Cleanup using the Operations Toolkit

If a VO does not clean up.

   1. The PC checks for expired allocations using the Allocation query utility. 
   1. The PC may work with the VOA of an expired allocation to extend the lifetime of the allocation, or to have the VO remove its files 

Otherwise, the following steps are done

   1. The PC runs a tool to construct a list of site file names of all the files in the expired allocation.
   1. The PC forwards the list of site file names to the site administrator.
   1. The site administrator examines the list to try to ensure that no harm will be done by the deletions.
   1. The site administrator executes the public storage cleanup tool using the list as input.
   1. The site administrator informs the PC that the files have been deleted.
   1. The PC sets the space used attribute of the allocation object to zero in all AAS instances.

-- Main.TedHesselroth - 20 Sep 2010
