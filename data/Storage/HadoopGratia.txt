%META:TOPICINFO{author="MichaelThomas" date="1250526930" format="1.1" version="1.4"}%
%META:TOPICPARENT{name="Hadoop"}%
---+!! *<noop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%

The grid-enabled Hadoop DFS utilizes normal Globus !GridFTP servers with a specialized plugin in order to do transfers.  Because it uses this server software, we are able to take advantage of the OSG's accounting system.  The system, Gratia, has a plugin which monitors the Globus !GridFTP logs and reports any transfer data to a central collector.

The instructions on this page must be followed for every !GridFTP server on Hadoop.

---+ Assumptions and Prerequisites

This page assumes:

   * You have a working Hadoop install as documented in [[HadoopInstallation][this guide]].
   * You have a working !GridFTP install on top of Hadoop, [[HadoopGridFTP][as documented here]].

---+ Yum-based Installation

We assume that you are using the Caltech Hadoop repository from the caltech-hadoop RPM, [[HadoopInstallation#Yum_install][as documented here]].  Run the following command:

<verbatim>
yum install gratia-probe-gridftp-transfer
</verbatim>

When an update is released, you may run the following to upgrade:

<verbatim>
yum upgrade gratia-probe-gridftp-transfer
</verbatim>

---++ Files and Directories Used

This RPM *does not* using Linux-standard file locations.  Here are the most relevant file and directory locations:

| Purpose | Needs Editing? | Location |
| Probe Configuration | Yes | /opt/vdt/gratia/probe/gridftp-transfer/ProbeConfig |
| Probe Executables | No | /opt/vdt/gratia/probe/gridftp-transfer |
| Log files | No | /opt/vdt/gratia/var/logs |
| Temporary files | No | /opt/vdt/gratia/var/tmp |

---+ Configuration

The RPM installs the Gratia probe into the system crontab, but does not configure it.  The configuration of the probe is controlled by the file

<verbatim>
/opt/vdt/gratia/probe/gratia-transfer/ProbeConfig
</verbatim>

This is usually one XML node spread over multiple lines.  Note that comments (#) have no effect on this file.  You will need to edit the following:

| Attribute | Needs Editing | Value |
| !ProbeName | Maybe | This should be set to "gridftp-transfer:&lt;hostname&gt;", where &lt;hostname&gt; is the fully-qualified domain name of your gridftp host. |
| !CollectorHost | Maybe | Set to the hostname and port of the central collector.  By default it sends to the OSG collector.  See below. |
| !SiteName | Yes | Set to the resource group name of your site as registered in OIM. |
| !GridftpLogDir | Yes | Set to /var/log, or wherever your current gridftp logs are located |
| !Grid | Maybe | Set to "ITB" if this is a test resource; otherwise, leave as OSG. |
| !UserVOMapFile | Maybe | Set to the location of your osg-user-vo-map.txt; see below for information about this file. |
| !SuppressUnknownVORecords| Maybe | Set to 1 to suppress any records that can't be matched to a VO; 0 is strongly recommended. |
| !SuppressNoDNRecords | Maybe | Set to 1 to suppress records that can't be matched to a DN; 0 is strongly recommended. |
| !EnableProbe | Yes | Set to 1 to enable the probe. |

---++ Selecting a collector host

The collector is the central server which logs the !GridFTP transfers into a database.  There are usually three options:

   1 *OSG Transfer Collector*: This is the primary collector for transfers in the OSG.  Use !CollectorHost="gratia-osg-transfer.opensciencegrid.org:80".
   1 *OSG-ITB Transfer Collector*: This is the test collector for transfers in the OSG.  Use !CollectorHost="gratia-osg-transfer.opensciencegrid.org:8881".
   1 *Site local collector*: If your site has set up its own collector, then your admin will be able to give you an endpoint to use.  Typically, this is along the lines of !CollectorHost="<hostname>:8880".

---++ Generating osg-user-vo-map.txt

The osg-user-vo-map.txt is a simple, space-separated format that contains 2 columns; the first is a unix username and the second is the VO which that username corresponds to.  This file is auto-generated by OSG utilities on the OSG CE.  We do not have the generation utilities converted for the gridftp server yet.

We currently recommend using a cron job to automatically copy over this file from your CE (can be found in $VDT_LOCATION/osg/etc/osg-user-vo-map.txt) into some directory on your gridftp server, and then updating the attribute !UserVOMapFile in !ProbeConfig to point at it.

Without this file, all gridftp transfers will show up as belonging to the VO "Unknown".

---+ Validation

Run the Gratia probe once by hand to check for functionality:

<verbatim>
/opt/vdt/gratia/probe/gridftp-transfer/gridftp-transfer_meter.cron.sh
</verbatim>

Look for any abnormal termination and report it if it is a non-trivial site issue.  Look in the log files in =/opt/vdt/gratia/var/logs/&lt;date&gt;.log= and make sure there are no error messages printed.