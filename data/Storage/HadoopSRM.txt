%META:TOPICINFO{author="MichaelThomas" date="1249427314" format="1.1" version="1.5"}%
%META:TOPICPARENT{name="Hadoop"}%
---+!! *<noop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%

---+ Installation

Hadoop uses the [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/BestmanGateway][Bestman SRM server]] in gateway mode to provide a SRM interface to Hadoop.  Bestman will use the Hadoop FUSE  interface for namespace operations, such as mkdir, rm, and ls.  Bestman will use a [[HadoopGridFTP][Gridftp]] server for reading and writing files.

There used to be two choices for installation method - RPM-based or Pacman-based.  From feedback we have received from site admins, we are moving forward only with the RPM-based installs.  The Pacman install is documented below for posterity.

---++ Quick Start

Quickstart for the impatient.  This assumes you already have [[HadoopInstallation][Hadoop and FUSE]] installed on the SRM server.

 <verbatim>
rpm -ivh http://newman.ultralight.org/repos/hadoop/4/x86_64/caltech-hadoop-4-1.noarch.rpm
yum install bestman
vi /opt/bestman/conf/bestman.rc # Edit appropriately.
visudo # Add specific sudo privileges for globus
service bestman start
</verbatim>

---++ Prerequisites

You must also have already [[HadoopInstallation][installed and mounted]] 
Hadoop using FUSE. A [[HadoopGridFTP][GridFTP-HDFS]] server must
also be installed, but this does not need to be on the same server
as the BestMan server.  A larger site will prefer to have their GridFTP and BeStMan servers
installed on separate hosts; see the list of
[[HadoopArchitectures][deployment layouts]] for more information.

Bestman is preconfigured to look for the host certificate and key in =/etc/grid-security/globus*.pem=.
These files must exist and be readable by the globus user.




The installation includes the latest CA Certificates package from the OSG as well as the fetch-crl CRL updater.

---++ RPM/YUM Installation

Bestman SRM RPMs for RHEL4 and RHEL5 are available from:

<verbatim>
http://newman.ultralight.org/repos/hadoop/4/x86_64
http://newman.ultralight.org/repos/hadoop/4/i386
http://newman.ultralight.org/repos/hadoop/5/x86_64
http://newman.ultralight.org/repos/hadoop/5/i386
</verbatim>

While it is possible to download and install the RPMs directly, it is recommended that you install the yum repository configuration and install Besman SRM with yum.  This will ensure that all of the required dependant packages are also installed and configured.  To configure your local installation for the yum repository, you should install the caltech-hadoop package from the relevant package:

RHEL4 (32 and 64-bit):

<verbatim>
rpm -ivh http://newman.ultralight.org/repos/hadoop/4/x86_64/caltech-hadoop-4-1.noarch.rpm
</verbatim>

RHEL5 (32 and 64-bit):

<verbatim>
rpm -ivh http://newman.ultralight.org/repos/hadoop/5/x86_64/caltech-hadoop-5-1.noarch.rpm
</verbatim>

Remember, in order to use Bestman SRM, you must have the [[HadoopInstallation][Hadoop and the FUSE kernel module]] already installed on your system in order to use the yum installer.

After installing the caltech-hadoop yum configuration package, you can install the Bestman SRM server with:

<verbatim>
yum install bestman
</verbatim>

Updates can be installed with:

<verbatim>
yum upgrade bestman
</verbatim>

---++ Configuration

The installation of bestman and its dependencies creates several directories.  In addition to the Hadoop installation files, you will also find:

| Log files | =/var/log/bestman= |
| runtime config files | =/opt/bestman/conf/*= |
| Bestman files | =/opt/bestman/= |
| init.d startup script | =/etc/init.d/bestman= |
| CA certificates | =/etc/grid-security/certificates/*= |

Bestman SRM uses the Hadoop FUSE mount to perform namespace operations, such as mkdir, rm, and ls.  As per the [[HadoopInstallation][Hadoop install instructions]], edit =/etc/sysconfig/hadoop= and run =service hadoop-firstboot start=.  It is *not* necessary (or even recommended) to start any hadoop services with =service hadoop start=.

The Bestman SRM configuration file is located in =/opt/bestman/conf/bestman.rc=.  There are a few settings that you need to add or change manually, depending on your site configuration:

<verbatim>
supportedProtocolList=gsiftp://your.gridftp.server1:2811;gsiftp://your.gridftp.server2:2811
GUMSserviceURL=https://your.gums.host:8443/gums/services/GUMSAuthorizationServicePort
localPathListAllowed=/mnt/hadoop;/tmp
</verbatim>

Bestman uses sudo to perform changes to the filesystem namespace.  This ensures that directories get created and file get removed with the proper permissions.  You must manually add permissions.  Append the following to the end of the =/etc/sudoers= file with the =visudo= command:

<verbatim>
Cmnd_Alias SRM_CMD = /bin/rm, /bin/mkdir, /bin/rmdir, /bin/mv, /bin/ls 
Runas_Alias SRM_USR = ALL, !root 
globus ALL=(SRM_USR) NOPASSWD:SRM_CMD
</verbatim>

---++ Running Bestman SRM

Start the Bestman SRM server with the command

<verbatim>
service bestman start
</verbatim>

To start Bestman SRM automatically at boot time:

<verbatim>
chkconfig bestman on
</verbatim>

---+ Pacman Installation

*Beware: The pacman installation method is deprecated!  Do not use for new installs.*

Install the latest BeStMan from the OSG with pacman.

If you are not using GUMS/PRIMA for authentication, first set:
<verbatim>
export VDT_NO_PRIMA=1
</verbatim>

GUMS users don't need to set any special environment variables.  Next, run
<verbatim>
pacman -get http://t2.unl.edu/store/cache:Hadoop-Bestman
</verbatim>

If you are using GUMS, make sure you have set =VDT_GUMS_HOST= to the
hostname of the GUMS server.  This will install the BeStMan server
with the Ganglia load-balancing plugin.

---+ Configuration

The BeStMan configuration file is in =$VDT_LOCATION/bestman/conf/bestman.rc=.
The following configuration options are of interest:
   
   $ =supportedProtocolList=: semi-colon separated list of accessible
      servers, including the protocol, hostname and port for each.
      For example: =gsiftp://red-gridftp1.unl.edu:5000;gsiftp://dcache-s01.unl.edu:5000=
   $ =noSudoOnLs=: use =sudo= to perform =ls= (default: True). Enable
      this option if the SRM daemon's UID can't list a portion of
      your namespace.
   $ =staticTokenList=: list of statically-configured space tokens.
      See the in-file help text for more information.
   $ =GUMSserviceURL=: URL for GUMS lookups.
   $ =accessFileSysViaSudo=: use =sudo= to perform POSIX operations
     in the namespace. Enable this option or the server's =srmMkdir=
     commands will result in directories owned by root.

Add the following lines to =/etc/sudoers= so that BeStMan can
manipulate the filesystem namespace:

<verbatim>
Cmnd_Alias SRM_CMD = /bin/rm, /bin/mkdir, /bin/rmdir, /bin/mv, /bin/cp, /bin/ls
Runas_Alias SRM_USR = ALL, !root
daemon     ALL=(SRM_USR) NOPASSWD: SRM_CMD
</verbatim>

On RHEL 5+ systems you need to make sure the following is commented
out:

<verbatim>
#Defaults    requiretty
</verbatim>

---++ Customization

You may want to enable any of the following customizations.

---+++ JMX Monitoring

This allows service administrators to closely monitor memory usage
and thread activity in a much more Java-centric manner than Ganglia
monitoring. To enable this, add the following command-line arguments
to the call to =java= in =$VDT_LOCATION/bestman/sbin/bestman.server=:

<verbatim>
-Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote=true -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.port=8004
</verbatim>

Note that this allows anyone with access to port 8004 access to read
out your JVM internal metrics.

---+++ Ganglia-Based Selection of GridFTP Servers

By default, the SRM server will select a GridFTP server by cycling
through a static-list (round-robin). Nebraska has developed a
protocol plugin for BeStMan that randomly selects a server from the
list with a probability distribution function built from the load
and memory usage as reported by Ganglia. To enable this, add the
following line to =$VDT_LOCATION/bestman/conf/bestman.rc=:

<verbatim>
protocolSelectionPolicy=class=edu.unl.rcf.BestmanGridftpSelector.BestmanGridftp&jarFile=UNLGangliaBestman.jar&name=gsiftp
</verbatim>

Then, add the following command-line arguments to the call to =java=
in =$VDT_LOCATION/bestman/sbin/bestman.server= after the
=${MAXHEAP}= parameter:

<verbatim>
-Dedu.unl.rcf.BestmanGridftpSelector.host=localhost -Dedu.unl.rcf.BestmanGridftpSelector.port=8649
</verbatim>

-- Main.WillMaier - 19 Mar 2009