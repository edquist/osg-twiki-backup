%META:TOPICINFO{author="MatsRynge" date="1319563354" format="1.1" version="1.8"}%
%META:TOPICPARENT{name="EngageNewUserGuide"}%
%TOC%

---+!! Guide to using OSG for users of the TGYRO application.

---++ Overview

This guide is specifically aimed at enabling TGYRO users to take advantage of the Open Science Grid. It may look daunting at first, but a large fraction of these instructions only need to be followed once; yet more need to be done only once per year. There are two main sections: [[#Authorization_and_authentication][Authorization and authentication]] dealing with how to get the required access to run via the OSG, and [[#Running_TGYRO_jobs_on_the_OSG][Running TGYRO jobs on the OSG]] which tells you what you need to know to submit jobs to OSG sites and obtain the results.

---++ Authorization and authentication.

Perhaps the biggest difference from the methods for running TGYRO with which you are familiar is that one logs onto one machine, =engage-submit.renci.org= in order to submit jobs to any one of several sites. The authentication and authorization requirements of those sites are generally handled using X.509 certificates. The ones used are so-called, "extended attribute" certificates known as, "VOMS proxies." These extended attributes encode information about your, "Virtual Organization" and, particular scientific purpose to enable sites to decide whether to allow you access and how to prioritize your usage with respect to everyone else.

---+++ Obtaining an X.509 certificate (_once only_).

The first thing one needs to do is obtain an X.509 certificate. If you do not already have an X.509 certificate of your own, you should obtain one from the DOE. In order to do this you should use a browser, preferably Mozilla Firefox.

---++++ Ensure your browser recognizes and accepts DOE certificates.

%INCLUDE{"EngageNewUserGuide" section="UpdateDOECAChain"}%

---++++ Apply for a personal certificate

%INCLUDE{"EngageNewUserGuide" section="ApplyForDOECert"}%

---++++ Retrieve your personal certificate

When your certificate has been successfully issued, you will receive an email that contains a link to a page containing all your certificate information. Open that page in your browser and click on <font color="#993399">Import Your Certificate</font> button at the bottom of that page.

---++++ Export your certificate for use in job submission.

See the instructions on the [[http://www.doegrids.org/pages/cert-request.html#Globus][DOEGrids certificate page]].

---+++ Join the Engage VO (_once only_).

%INCLUDE{"EngageNewUserGuide" section="JoinTheEngageVO"}%

Specify your VO representative as, "Christopher H. Green (Engage)."

Ensure that you specify:<verbatim><your-institute> (TGYRO)</verbatim>
as your affiliation to ensure that your application gets routed appropriately.

Be sure to follow immediately the instructions in the "Phase I" email you will receive in order for your application to progress.

You and/or your institute's TGYRO / ITER representative may receive further inquiries, but you should normally receive an email notification that you have been admitted to the Engage VO within one business day. Follow the instructions therein to finalize your admittance to the VO.

---+++ Obtain access to the central Engage VO submit node.

Visit the RENCI [[https://access.renci.org/request][account request page]] and fill in the following information:

   * RENCI contact: John !McGee
   * RENCI contact e-email: mcgee@renci.org
   * Please select "Don't need one" regarding: If you need to be added to the gridmap file please select the appropriate option. 
   * Please give a short description of why you need this account: OSG via Chris Green.

---+++ Renewing your DOEGrids certificate (_once per year only_).

A few weeks before your certificate arrives you will start receiving emails warning you of the impending expiration of your certificate. In order to renew your certificate _at any time before it expires_, do the following:

   1. Ensure you have your current certificate in your browser. For greatest ease use the same browser from which you requested the certificate in the first place; otherwise import from the backup you made (and kept, right?)
   1. Visit http://www.doegrids.org/ and select the "Certificate Renewal" link from the left sidebar.
   1. Follow the instructions. Your certificate will be automatically renewed and imported into your browser.
   1. Follow the instructions [[#Export_your_certificate_for_use][above]].

If your certificate has expired, you will need to [[#Apply_for_a_personal_certificate][request a new one]]. In the comments field, request that your certificate be issued with the same DN (including "random" number) as your existing one, and paste the DN in the comments field also. This can be obtained either from your browser or certificate handling utility or by executing the command from your submit node:<verbatim>openssl x509 -noout -in $HOME/.globus/usercert.pem -subject</verbatim>

---+++ Re-signing the VO Usage Policy (_once per year only_).

Once per year, you should receive an email directing you to re-sign the Acceptable Use Policy, or AUP. Read and agree to abide by the AUP in order to continue membership of the Engage VO for another year.

---+++ Obtain VOMS credentials for job submission (_prior to job submission but not more often than once per 24h_).

%INCLUDE{"EngageNewUserGuide" section="InitUserProxyBasic" EngageFqanExample="Engage:/Engage/Fusion/TGYRO"}%

---+++ Site-specific authorization steps (_once only per site_).

Some sites require special steps to be taken to obtain access. These are listed below, along with the specific actions required.

---+++ NERSC sites.

You must be an authorized user of NERSC resources. If you are not, talk to your project management and follow your group's procedures to obtain access, and in particular, [[https://nim.nersc.gov/][NIM]] login abilities. Assuming this is done, access the [[https://nim.nersc.gov/][NIM]] site and look for the, "Grid Certificates" tab on the right of the main frame. Use the link provided to add your certificate to the list. You will need the information obtained by executing the following command on your grid submission node (the one onto which you [[#Export_your_certificate_for_use][placed your DOE certificate]]):
<verbatim>openssl x509 -noout -in $HOME/.globus/usercert.pem -subject</verbatim>

---++ Running TGYRO jobs on the OSG.

Before attempting to run jobs on the OSG, ensure first that you are able to [[#Obtain_access_to_the_central_Eng][log on to the current Engage submit host at RENCI]], NC, and that you are able to [[#Obtain_VOMS_credentials_for_job][obtain the correct user proxy]] from there. Then:

   1. Ensure you have the correct environment for TGYRO job submission:<pre>. ~greenc/tgyro-suite/setup.sh</pre><em>or</em>:<pre>source ~greenc/tgyro-suite/setup.csh</pre>as appropriate.
   1. Ensure you have a local top-level work directory (eg =~/mpi-work/tgyro=).
   1. Generate your work area, either by importing or copying an older directory or by generating it from a template, eg:<pre>tgyro -g stest_1 -p ~/mpi-work/tgyro</pre>
   1. Submit your job as normal, eg:<pre>tgyro_bat -e stest_1 -n 4 -p ~/mpi-work/tgyro</pre>Answer the questions as appropriate.
   1. Monitor the progress of your job with =condor_q &lt;user&gt;= or =condor_q &lt;job#&gt;=.
   1. Upon completion of the job, expand the results archive, =output_files.tar.bz2=.

Submission of TGYRO jobs is still being improved, so please bookmark [[#Running_TGYRO_jobs_on_the_OSG][this section]] and check back regularly for news of any changes.

If you are interested, here are some [[EngageTGYROTechnicalDetails][technical details]] of how the TGYRO system was adapted to run on the OSG.
-- Main.ChrisGreen - 18 Sep 2009