%META:TOPICINFO{author="BrianLin" date="1379434415" format="1.1" reprev="1.4" version="1.4"}%
%META:TOPICPARENT{name="BrianLin"}%
This is a collection of knowledge gathered from [[https://ticket.grid.iu.edu/goc/13516][GOC Ticket #13516]].


---++ What we know

A job submitted with a proxy with GLOW VO credentials to MIT's CE fails but there aren't any issues with other VOs (attempted with a fermilab and a CMS VO):

<pre class="rootscreen">
%UCL_PROMPT% voms-proxy-init -voms GLOW -cert test/usercert.pem -key test/userkey.pem 
Enter GRID pass phrase:
Your identity: /DC=com/DC=DigiCert-Grid/O=Open Science Grid/OU=People/CN=Brian Lin 1047
Creating temporary proxy ....................... Done
Contacting  glow-voms.cs.wisc.edu:15001 [/DC=org/DC=doegrids/OU=Services/CN=glow-voms.cs.wisc.edu] "GLOW" Done
Creating proxy ................................................................................................. Done

Your proxy is valid until Tue Sep 17 06:11:50 2013

%UCL_PROMPT% globus-job-run localhost /usr/bin/whoami     
GRAM Job submission failed because authentication with the remote server failed (error code 7)

%UCL_PROMPT% voms-proxy-info -all
subject   : /DC=com/DC=DigiCert-Grid/O=Open Science Grid/OU=People/CN=Brian Lin 1047/CN=proxy
issuer    : /DC=com/DC=DigiCert-Grid/O=Open Science Grid/OU=People/CN=Brian Lin 1047
identity  : /DC=com/DC=DigiCert-Grid/O=Open Science Grid/OU=People/CN=Brian Lin 1047
type      : proxy
strength  : 1024 bits
path      : /tmp/x509up_u1758
timeleft  : 11:59:49
key usage : Digital Signature, Key Encipherment, Data Encipherment
=== VO GLOW extension information ===
VO        : GLOW
subject   : /DC=com/DC=DigiCert-Grid/O=Open Science Grid/OU=People/CN=Brian Lin 1047
issuer    : /DC=com/DC=DigiCert-Grid/O=Open Science Grid/OU=Services/CN=glow-voms.cs.wisc.edu
attribute : /GLOW/Role=NULL/Capability=NULL
timeleft  : 11:59:49
uri       : glow-voms.cs.wisc.edu:15001

</pre>

When submitting a job from the CE, the only log file we see affected is =/var/log/tomcat5/gums-service-cybersecurity.log=, where our request is being denied. When submitting a job with no associated VO, we see entries in =/var/log/tomcat5/gums-service-admin.log= that say it's a null mapping so this would seem to imply that GLOW VO users aren't finishing out the mapping logic.

%TWISTY{%TWISTY_OPTS_OUTPUT% showlink="XML Entry in gums-service-cybersecurity.log"}%
<pre class="screen">
<verbatim>
<?xml version="1.0" encoding="UTF-8"?>
<samlp:Response xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol" InResponseTo="ID-1169479693" Version="2.0">
   <saml:Assertion xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion" Version="2.0">
      <saml:Statement xmlns:xacml-saml="urn:oasis:names:tc:xacml:2.0:profile:saml2.0:v2:schema:assertion" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xacml-saml:XACMLAuthzDecisionStatementType">
         <XACMLcontext:Request xmlns:XACMLcontext="urn:oasis:names:tc:xacml:2.0:context:schema:os" xsi:type="XACMLcontext:RequestType">
            <XACMLcontext:Subject SubjectCategory="urn:oasis:names:tc:xacml:1.0:subject-category:access-subject" xsi:type="XACMLcontext:SubjectType">
               <XACMLcontext:Attribute AttributeId="http://authz-interop.org/xacml/subject/subject-x509-id" DataType="http://www.w3.org/2001/XMLSchema#string" xsi:type="XACMLcontext:AttributeType">
                  <XACMLcontext:AttributeValue xsi:type="XACMLcontext:AttributeValueType">/DC=com/DC=DigiCert-Grid/O=Open Science Grid/OU=People/CN=Brian Lin 1047</XACMLcontext:AttributeValue>
               </XACMLcontext:Attribute>
               <XACMLcontext:Attribute AttributeId="http://authz-interop.org/xacml/subject/subject-x509-issuer" DataType="http://www.w3.org/2001/XMLSchema#string" xsi:type="XACMLcontext:AttributeType">
                  <XACMLcontext:AttributeValue xsi:type="XACMLcontext:AttributeValueType">/DC=com/DC=DigiCert-Grid/O=DigiCert Grid/CN=DigiCert Grid CA-1</XACMLcontext:AttributeValue>
               </XACMLcontext:Attribute>
               <XACMLcontext:Attribute AttributeId="http://authz-interop.org/xacml/subject/certificate-serial-number" DataType="http://www.w3.org/2001/XMLSchema#string" xsi:type="XACMLcontext:AttributeType">
                  <XACMLcontext:AttributeValue xsi:type="XACMLcontext:AttributeValueType">-1</XACMLcontext:AttributeValue>
               </XACMLcontext:Attribute>
               <XACMLcontext:Attribute AttributeId="http://authz-interop.org/xacml/subject/validity-not-before" DataType="http://www.w3.org/2001/XMLSchema#dateTime" xsi:type="XACMLcontext:AttributeType">
                  <XACMLcontext:AttributeValue xsi:type="XACMLcontext:AttributeValueType">2013-09-16T19:05:12Z</XACMLcontext:AttributeValue>
               </XACMLcontext:Attribute>
               <XACMLcontext:Attribute AttributeId="http://authz-interop.org/xacml/subject/validity-not-after" DataType="http://www.w3.org/2001/XMLSchema#dateTime" xsi:type="XACMLcontext:AttributeType">
                  <XACMLcontext:AttributeValue xsi:type="XACMLcontext:AttributeValueType">2013-09-17T07:10:12Z</XACMLcontext:AttributeValue>
               </XACMLcontext:Attribute>
            </XACMLcontext:Subject>
            <XACMLcontext:Resource xsi:type="XACMLcontext:ResourceType">
               <XACMLcontext:Attribute AttributeId="urn:oasis:names:tc:xacml:1.0:resource:resource-id" DataType="http://www.w3.org/2001/XMLSchema#string" xsi:type="XACMLcontext:AttributeType">
                  <XACMLcontext:AttributeValue xsi:type="XACMLcontext:AttributeValueType">http://authz-interop.org/xacml/resource/resource-type/ce</XACMLcontext:AttributeValue>
               </XACMLcontext:Attribute>
            </XACMLcontext:Resource>
            <XACMLcontext:Resource xsi:type="XACMLcontext:ResourceType">
               <XACMLcontext:Attribute AttributeId="http://authz-interop.org/xacml/resource/dns-host-name" DataType="http://www.w3.org/2001/XMLSchema#string" xsi:type="XACMLcontext:AttributeType">
                  <XACMLcontext:AttributeValue xsi:type="XACMLcontext:AttributeValueType">t2bat0210.cmsaf.mit.edu</XACMLcontext:AttributeValue>
               </XACMLcontext:Attribute>
            </XACMLcontext:Resource>
            <XACMLcontext:Resource xsi:type="XACMLcontext:ResourceType">
               <XACMLcontext:Attribute AttributeId="http://authz-interop.org/xacml/resource/resource-x509-id" DataType="http://www.w3.org/2001/XMLSchema#string" xsi:type="XACMLcontext:AttributeType">
                  <XACMLcontext:AttributeValue xsi:type="XACMLcontext:AttributeValueType">/DC=org/DC=doegrids/OU=Services/CN=t2bat0210.cmsaf.mit.edu</XACMLcontext:AttributeValue>
               </XACMLcontext:Attribute>
            </XACMLcontext:Resource>
            <XACMLcontext:Resource xsi:type="XACMLcontext:ResourceType">
               <XACMLcontext:Attribute AttributeId="http://authz-interop.org/xacml/resource/resource-x509-issuer" DataType="http://www.w3.org/2001/XMLSchema#string" xsi:type="XACMLcontext:AttributeType">
                  <XACMLcontext:AttributeValue xsi:type="XACMLcontext:AttributeValueType">/DC=org/DC=DOEGrids/OU=Certificate Authorities/CN=DOEGrids CA 1</XACMLcontext:AttributeValue>
               </XACMLcontext:Attribute>
            </XACMLcontext:Resource>
            <XACMLcontext:Action xsi:type="XACMLcontext:ActionType">
               <XACMLcontext:Attribute AttributeId="urn:oasis:names:tc:xacml:1.0:action:action-id" DataType="http://www.w3.org/2001/XMLSchema#string" xsi:type="XACMLcontext:AttributeType">
                  <XACMLcontext:AttributeValue xsi:type="XACMLcontext:AttributeValueType">http://authz-interop.org/xacml/action/action-type/execute-now</XACMLcontext:AttributeValue>
               </XACMLcontext:Attribute>
            </XACMLcontext:Action>
            <XACMLcontext:Environment xsi:type="XACMLcontext:EnvironmentType">
               <XACMLcontext:Attribute AttributeId="urn:oasis:names:tc:xacml:1.0:environment:current-dateTime" DataType="http://www.w3.org/2001/XMLSchema#dateTime" xsi:type="XACMLcontext:AttributeType">
                  <XACMLcontext:AttributeValue xsi:type="XACMLcontext:AttributeValueType">2013-09-16T21:37:18Z</XACMLcontext:AttributeValue>
               </XACMLcontext:Attribute>
               <XACMLcontext:Attribute AttributeId="http://authz-interop.org/xacml/environment/pep-oblig-supported" DataType="http://www.w3.org/2001/XMLSchema#string" xsi:type="XACMLcontext:AttributeType">
                  <XACMLcontext:AttributeValue xsi:type="XACMLcontext:AttributeValueType">http://authz-interop.org/xacml/obligation/afs-token</XACMLcontext:AttributeValue>
               </XACMLcontext:Attribute>
               <XACMLcontext:Attribute AttributeId="http://authz-interop.org/xacml/environment/pep-oblig-supported" DataType="http://www.w3.org/2001/XMLSchema#string" xsi:type="XACMLcontext:AttributeType">
                  <XACMLcontext:AttributeValue xsi:type="XACMLcontext:AttributeValueType">http://authz-interop.org/xacml/obligation/secondary-gids</XACMLcontext:AttributeValue>
               </XACMLcontext:Attribute>
               <XACMLcontext:Attribute AttributeId="http://authz-interop.org/xacml/environment/pep-oblig-supported" DataType="http://www.w3.org/2001/XMLSchema#string" xsi:type="XACMLcontext:AttributeType">
                  <XACMLcontext:AttributeValue xsi:type="XACMLcontext:AttributeValueType">http://authz-interop.org/xacml/obligation/uidgid</XACMLcontext:AttributeValue>
               </XACMLcontext:Attribute>
               <XACMLcontext:Attribute AttributeId="http://authz-interop.org/xacml/environment/pep-oblig-supported" DataType="http://www.w3.org/2001/XMLSchema#string" xsi:type="XACMLcontext:AttributeType">
                  <XACMLcontext:AttributeValue xsi:type="XACMLcontext:AttributeValueType">http://authz-interop.org/xacml/obligation/username</XACMLcontext:AttributeValue>
               </XACMLcontext:Attribute>
            </XACMLcontext:Environment>
         </XACMLcontext:Request>
         <xacml-context:Response xmlns:xacml-context="urn:oasis:names:tc:xacml:2.0:context:schema:os">
            <xacml-context:Result>
               <xacml-context:Decision>Deny</xacml-context:Decision>
               <xacml-context:Status>
                  <xacml-context:StatusCode Value="http://oasis/names/tc/xacml/1.0/status/ok" />
               </xacml-context:Status>
               <xacml:Obligations xmlns:xacml="urn:oasis:names:tc:xacml:2.0:policy:schema:os">
                  <xacml:Obligation FulfillOn="Permit" ObligationId="http://authz-interop.org/xacml/obligation/username" />
               </xacml:Obligations>
            </xacml-context:Result>
         </xacml-context:Response>
      </saml:Statement>
   </saml:Assertion>
</samlp:Response>
</verbatim>
</pre>
%ENDTWISTY%

9/17/13 - Now when I submit a job with a GLOW VO proxy, I don't see a response stanza in the XML output.

---+++ gums-service-developer.log

After turning on DEBUG output for gov.bnl.gums in =/etc/gums/log4j-service.properties=, I submitted a job with no associated VO and got denied as expected. Additionally, =gums-service-admin.log= shows it mapping to 'null'.

<pre class="screen">
17 Sep 2013 11:37:01,220 TP-Processor16 service.GUMSXACMLMappingServiceImpl [DEBUG]: Checking access on '/DC=org/DC=doegrids/OU=Services/CN=t2bat0210.cmsaf.mit.edu' for '/DC=com/DC=DigiCert-Grid/O=Open Science Grid/OU=People/CN=Brian Lin 1047' with fqan 'null'
17 Sep 2013 11:37:01,255 TP-Processor16 service.GUMSXACMLMappingServiceImpl [DEBUG]: Denied access on '/DC=org/DC=doegrids/OU=Services/CN=t2bat0210.cmsaf.mit.edu' for '/DC=com/DC=DigiCert-Grid/O=Open Science Grid/OU=People/CN=Brian Lin 1047' with fqan 'null'
</pre>

Now when trying with the GLOW VO, I get more output but there are a few blank lines in the logs and I don't get a "Denied Access" or "Credentials mapped" response. There are no corresponding entries that show up in =gums-service-admin.log=

<pre class="screen">
17 Sep 2013 11:39:39,445 TP-Processor22 service.GUMSXACMLMappingServiceImpl [DEBUG]: Checking access on '/DC=org/DC=doegrids/OU=Services/CN=t2bat0210.cmsaf.mit.edu' for '/DC=com/DC=DigiCert-Grid/O=Open Science Grid/OU=People/CN=Brian Lin 1047' with fqan '/GLOW/Role=NULL/Capability=NULL'
17 Sep 2013 11:39:39,465 TP-Processor22 service.GUMSXACMLMappingServiceImpl [DEBUG]:
17 Sep 2013 11:39:39,567 TP-Processor24 service.GUMSXACMLMappingServiceImpl [DEBUG]: Checking access on '/DC=org/DC=doegrids/OU=Services/CN=t2bat0210.cmsaf.mit.edu' for '/DC=com/DC=DigiCert-Grid/O=Open Science Grid/OU=People/CN=Brian Lin 1047' with fqan '/GLOW/Role=NULL/Capability=NULL'
17 Sep 2013 11:39:39,583 TP-Processor24 service.GUMSXACMLMappingServiceImpl [DEBUG]:
</pre>

I get the same problem when submitting via an osgedu VO.

---++ Red Herrings?

---+++ VOMS GLOW error in catalina.out

There seems to be an issue with GUMS trying to reach out to glow-voms.cs.wisc.edu but:

   1. The VO members in GLOW seem to be up to date. 
   2. These errors do not correspond to each failed job submission.

%TWISTY{%TWISTY_OPTS_OUTPUT% showlink="Error in catalina.out"}%
<pre class="screen">
AxisFault
 faultCode: {http://schemas.xmlsoap.org/soap/envelope/}Server.userException
 faultSubcode:
 faultString: org.glite.security.voms.admin.persistence.error.VOMSDatabaseException: Cannot open connection
 faultActor:
 faultNode:
 faultDetail:
        {http://xml.apache.org/axis/}hostname:glow-voms.cs.wisc.edu

org.glite.security.voms.admin.persistence.error.VOMSDatabaseException: Cannot open connection
        at org.apache.axis.message.SOAPFaultBuilder.createFault(SOAPFaultBuilder.java:222)
        at org.apache.axis.message.SOAPFaultBuilder.endElement(SOAPFaultBuilder.java:129)
        at org.apache.axis.encoding.DeserializationContext.endElement(DeserializationContext.java:1087)
        at org.apache.xerces.parsers.AbstractSAXParser.endElement(Unknown Source)
        at org.apache.xerces.impl.XMLNSDocumentScannerImpl.scanEndElement(Unknown Source)
        at org.apache.xerces.impl.XMLDocumentFragmentScannerImpl$FragmentContentDispatcher.dispatch(Unknown Source)
        at org.apache.xerces.impl.XMLDocumentFragmentScannerImpl.scanDocument(Unknown Source)
        at org.apache.xerces.parsers.XML11Configuration.parse(Unknown Source)
        at org.apache.xerces.parsers.XML11Configuration.parse(Unknown Source)
        at org.apache.xerces.parsers.XMLParser.parse(Unknown Source)
        at org.apache.xerces.parsers.AbstractSAXParser.parse(Unknown Source)
        at org.apache.xerces.jaxp.SAXParserImpl$JAXPSAXParser.parse(Unknown Source)
        at javax.xml.parsers.SAXParser.parse(Unknown Source)
        at org.apache.axis.encoding.DeserializationContext.parse(DeserializationContext.java:227)
        at org.apache.axis.SOAPPart.getAsSOAPEnvelope(SOAPPart.java:696)
        at org.apache.axis.Message.getSOAPEnvelope(Message.java:435)
        at org.apache.axis.handlers.soap.MustUnderstandChecker.invoke(MustUnderstandChecker.java:62)
        at org.apache.axis.client.AxisClient.invoke(AxisClient.java:206)
        at org.apache.axis.client.Call.invokeEngine(Call.java:2784)
        at org.apache.axis.client.Call.invoke(Call.java:2767)
        at org.apache.axis.client.Call.invoke(Call.java:2443)
        at org.apache.axis.client.Call.invoke(Call.java:2366)
        at org.apache.axis.client.Call.invoke(Call.java:1812)
        at org.glite.security.voms.VOMSCompatibilitySoapBindingStub.getGridmapUsers(VOMSCompatibilitySoapBindingStub.java:344)
        at gov.bnl.gums.userGroup.VOMSUserGroup.retrieveMembers(VOMSUserGroup.java:466)
        at gov.bnl.gums.userGroup.VOMSUserGroup.updateMembers(VOMSUserGroup.java:352)
        at gov.bnl.gums.CoreLogic.updateGroupsImpl(CoreLogic.java:457)
        at gov.bnl.gums.CoreLogic.updateGroups(CoreLogic.java:214)
        at gov.bnl.gums.GUMS$1.run(GUMS.java:90)
        at java.util.TimerThread.mainLoop(Timer.java:512)
        at java.util.TimerThread.run(Timer.java:462)
</pre>
%ENDTWISTY%

---+++ gums.config diff

There were some differences between MIT's GUMS config and a working [with GLOW] Fermicloud VM GUMS config. Changes were made on the Fermicloud VM to match what was on MIT and the Fermicloud GUMS server was still functional.

<pre class="screen">
<verbatim>
--- mit            2013-09-16 15:59:07.494967495 -0500
+++ fermi          2013-09-16 15:56:51.108528790 -0500
@@ -9,12 +9,12 @@
 <vomsUserGroup
-name='GLOW'
-access='read all'
+name='glow'
+access='read self'
 description=''
 vomsServer='glow'
-matchFQAN='exact'
-acceptProxyWithoutFQAN='false'
+matchFQAN='vo'
+acceptProxyWithoutFQAN='true'
 voGroup='/GLOW'/>
</verbatim>
</pre>

-- Main.BrianLin - 16 Sep 2013
