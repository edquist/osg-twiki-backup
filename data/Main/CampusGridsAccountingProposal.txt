%META:TOPICINFO{author="DerekWeitzel" date="1339704653" format="1.1" reprev="1.4" version="1.4"}%
%META:TOPICPARENT{name="DerekWeitzel"}%
---+!! Campus Grids Accounting Proposal
%TOC%


---++ Requirements

The primary concern for campus grids accounting is accurately recording of usage by campus grid users using OSG technology.  This can be broken into:

Accounting for campus grid usage when:
   1. Flocking from campus submitter to a campus Condor cluster (same campus)
   2. Flocking from submitter to [[Documentation.CampusFactoryInstall][Campus Factory]] enabled cluster.
   3. Flocking from submitter to !GlideinWMS frontend and therefore out to OSG.
   4. Flocking from submitter to another campus' Condor cluster.
   5. Flocking from submitter to another campus' Campus Factory enabled cluster.


---++ Proposal

Currently, the [[Accounting.ProbeConfigGlideinWMS][probe installation instructions]] include:

   <pre class="file">
JOBGLIDEIN_ResourceName="$$([IfThenElse(IsUndefined(TARGET.GLIDEIN_ResourceName), IfThenElse(IsUndefined(TARGET.GLIDEIN_Site), IfThenElse(IsUndefined(TARGET.FileSystemDomain), \"Local Job\", TARGET.FileSystemDomain), TARGET.GLIDEIN_Site), TARGET.GLIDEIN_ResourceName)])"
</pre>

This expression is a priority listing of 3 variables it will look for in the resource description
   1. =GLIDEIN_ResourceName= is guaranteed to be on OSG glidein factories.  Therefore, if that is seen, then it is the OIM name of the resource the job ran at.  This will cover case 3.
   1. =GLIDEIN_Site= will be seen on campus factory enabled clusters.  Cover case 2 & 5.
   1. =FileSystemDomain= will be seen on flocked to clusters.  Cover case 1, 4.

Therefore, we %RED%append%ENDCOLOR% the value of the attributes with notation to help us determine the usage.  For example, the Campus Factory enabled clusters can be: <pre>
GLIDEIN_Site%RED%-CF%ENDCOLOR%
</pre>

And for flocked jobs: <pre>
FileSystemDomain%RED%-Flock%ENDCOLOR%
</pre>

New version of the instructions will include:
   <pre class="file">
JOBGLIDEIN_ResourceName="$$([IfThenElse(IsUndefined(TARGET.GLIDEIN_ResourceName), IfThenElse(IsUndefined(TARGET.GLIDEIN_Site), IfThenElse(IsUndefined(TARGET.FileSystemDomain), \"Local Job\", $(TARGET.FileSystemDomain)-Flock), $(TARGET.GLIDEIN_Site)-CF), TARGET.GLIDEIN_ResourceName)])"
</pre>

---++ Technical Details

The probe will make the usage for the different 'grids' look different.  It will do this by adding a new =Grid= type, Campus.  

   1. For case 3, the =Grid= = 'OSG', =ResourceType= = !BatchPilot.
   1. For case 1,2,4 & 5 =Grid= = 'Campus', =ResourceType= = !BatchPilot.

-- Main.DerekWeitzel - 12 Jan 2012
