%META:TOPICINFO{author="AnthonyTiradani" date="1358453092" format="1.1" reprev="1.7" version="1.7"}%
%META:TOPICPARENT{name="JohnWeigand"}%
---+!!<nop>Notes on CMS Certificate Change

<!--

   * Set VIEWTHISTOPIC = <div class="twikiSmall"><a href="%TOPIC%">View this section</a></div> 
 -->

%TOC%

%STARTINCLUDE%

---+ Background
With the deprecation of the DOE CA, CMS users will be requesting new user certificates from the CERN CA.
CMS pool accounts are used for the following proxy FQANs:
   * /cms/Role=cmsuser
   * /cms/uscms/Role=cmsuser
   * /cms   (this also includes those using  grid proxies, if any)

All other FQAN proxies are assigned group accounts and are not an issue at this time.

In GUMS, used for initial authorizations, pool account users are assigned a unix pool account based on their DNs.
If a user uses 2 certificate proxies, GUMS will assign a unique pool account to each.  This works fine unless the
user uses storage. 

The storage system uses unix account (not DN) for its authorization mechanism.  In order to access storage using
either proxy (DN), a manual process is in place to re-map the second proxy DN to the same unix account as the 
first proxy (DN).  

This proposal is to automate that process.


---+ Proposal
The basic concept is to:
   * retrieve a set of DNs from VOMS that for each "user".
   * bounce that against the GUMS MAPPING table to determine if a pool account has been assigned any DN%BR%


---+ VOMRS client script
---++ Notes from Tanya
Install vomrs client from pacman%BR%
For now you should be able to access vomrsdev.fnal.gov as you and do:

Create your proxy and copy it in /tmp on vomrs dev..%BR%
or 
<pre>
   export X509_USER_PROXY=your_proxy
</pre>
Since this a pacman installed VOMRS and certificates are likely installed be RPM, you need to
link the /opt/vomrs/globus/TRUSTED_CA to /etc/grid-security/certificates directory.


  then  do%BR%
      > source /opt/vomrs/setup.sh%BR%
      then %BR%
      as a member you should be able to do:%BR%
      /opt/vomrs/vomrs/client/bin/vomrs_soapclient lcg-voms.cern.ch 8443 vo/cms getMbrDNs%BR%

The real simple way to do it  is to do the following:%BR%
/opt/vomrs/vomrs/client/bin/vomrs_soapclient lcg-voms.cern.ch 8443 vo/cms getMembers%BR%
      returns for each member primary cert:%BR%
        DN%BR%
        CA%BR%
<pre>
e.g:
/opt/vomrs/vomrs/client/bin/vomrs_soapclient vomrsdev.fnal.gov 8443 vomrs/Test getMembers

/DC=org/DC=doegrids/OU=Services/CN=vomrsdev.fnal.gov
/DC=org/DC=DOEGrids/OU=Certificate Authorities/CN=DOEGrids CA 1
/DC=gov/DC=fnal/O=Fermilab/OU=People/CN=Tanya Levshina/CN=UID:tlevshin
/DC=gov/DC=fnal/O=Fermilab/OU=Certificate Authorities/CN=Kerberized CA HSM
/DC=org/DC=doegrids/OU=Services/CN=irods.fnal.gov
/DC=org/DC=DOEGrids/OU=Certificate Authorities/CN=DOEGrids CA 1
/DC=gov/DC=fnal/O=Fermilab/OU=People/CN=Vasya Ivanov/CN=UID:ivanov
/DC=gov/DC=fnal/O=Fermilab/OU=Certificate Authorities/CN=Kerberized CA HSM
</pre>

then for each DN, CA do
<pre>
/opt/vomrs/vomrs/client/bin/vomrs_soapclient lcg-voms.cern.ch 8443 vo/cms getMbrDNs "DN", "CA" 
... this will returns all DN, CA for this member including the primary one ,eg:
/opt/vomrs/vomrs/client/bin/vomrs_soapclient  lcg-voms.cern.ch  8443 vomrs/cms getMbrDNs "/DC=org/DC=doegrids/OU=Services/CN=vomrsdev.fnal.gov" "/DC=org/DC=DOEGrids/OU=Certificate Authorities/CN=DOEGrids CA 1"
/DC=org/DC=doegrids/OU=Services/CN=vomrsdev.fnal.gov
/DC=org/DC=DOEGrids/OU=Certificate Authorities/CN=DOEGrids CA 1
/DC=org/DC=doegrids/OU=People/CN=Tanya Levshina 508821
/DC=org/DC=DOEGrids/OU=Certificate Authorities/CN=DOEGrids CA 1
</pre>

if you don't want to do it and get all the information at once and parse it later you can do :
<pre>
 /opt/vomrs/vomrs/client/bin/vomrs_soapclien 8443  lcg-voms.cern.ch  8443 vomrs/cms  getMembersInfo -1 % % % % % Member full Approved  %
you will get back
1st line: number of members in the list
then for each member:
DN
CA
Institution
RepDN
RepCA
rights
status
status reason
AUP version
AUP exp
Inst exp
email
email confirmation status
vo roles
groups & roles
Additional CERTs - DN1,CA1,DN2,CA@
Personal Info
</pre>

If member doesn't have additional certs it will be an empty line.
<pre>
e.g:
4
/DC=org/DC=doegrids/OU=People/CN=Tanya Levshina  123
/DC=org/DC=DOEGrids/OU=Certificate Authorities/CN=DOEGrids CA 1
Fermilab
/DC=org/DC=doegrids/OU=People/CN=Tanya Levshina  123
/DC=org/DC=DOEGrids/OU=Certificate Authorities/CN=DOEGrids CA 1
full
Approved
Initial member registration
v1.0
2013-6-11
2022-6-11
tlevshin@fnal.gov
Confirmed
Member, Representative, SiteAdmin, VOAdmin
[/Test/Role=Member STATUS:Approved REASON:Group has been assigned during registration TYPE:Active]
/DC=org/DC=doegrids/OU=People/CN=Tanya Levshina 508821, /DC=org/DC=DOEGrids/OU=Certificate Authorities/CN=DOEGrids CA 1, /DC=org/DC=doegrids/OU=Services/CN=vomrsdev.fnal.gov, /DC=org/DC=DOEGrids/OU=Certificate Authorities/CN=DOEGrids CA 1
Phone,123,First name,Tanya,Last name,Levshina
</pre>

---+ Cert Update Scenarios
These scenarios are written with the use case where SRM is allowed to automatically create the user directory for any authenticated and authorized user.  If a site requires manual remapping (e.g. Fermilab), the site will have to do manual remappings for all storage users anyway.
   * The user followed published procedures
      * VOMS Admin queries vomrs and publishes the global list of associations
      * The site admin runs a script daily that reads published list and updates mappings in GUMS
   * The user's original cert expired.  Now the user must perform an initial registration with the new cert.
      * We will provide a script that takes the old DN and the new DN as arguments and performs the mapping
      * This script will have to be run manually by the admin on a per user basis when this occurs
      * The user will have to povide both dns
      * The only way to detect this case is when/if users squawk.
   * The user ignored procedures completely and simply performed an initial registration with the new cert.  The user now has two valid certs.
      * the procedure will have to be the same as the old cert expry issue.

---+ Other Issues
This section just documents some other issues related to pacman versus rpm GUMS/VOMS services.

---++ GUMS Issue with allocating pool accounts
---+++ Weigand 1/10/13
We need to look into how GUMS determines when a pool account application is full.  It currently issue
a WARN message when there are all pool accounts are used.  

It is likely making the determination by doing:%BR%
   * select count(*) from MAPPING where MAP = 'blah' and DN IS NOT NULL;
the result will be misleading.

It needs to do:
   * select count(distinct ACCOUNT) from MAPPING where MAP = 'blah' and DN IS NOT NULL;

This is likely a problem area as I think it does the simple case.

Related, sort of, is whether or not GUMS fills in open accounts (gaps so-to-speak) or just does a 'max(ACCOUNT)'
and only assigns from the "end".

---++ pacman GUMS and RPM VOMS for user group updates
When using the pacman version of GUMS and user group updates are performed against an rpm VOMS server,
and a user has multiple certificates as a single user in VOMS, only 1 of the user's certificates (DNs) is retrieved.
The use case that pointed this out was with the DZERO RPM installed VOMS server,  

I (Weigand) originally had a DOE cert defined in VOMS.  In December 2012, I added a !DigiCert certificate using 
the new VOMS capability to add an additional certificate, for me.  VOMS handled that fine.  I could query VOMS, 
via the UI, and see both certificates associated to me (this is a new feature in the RPM VOMS version).

However, when I had a pacman GUMS do a user group update, only the !DigiCert certificate was retrieved.%BR%
On an RPM GUMS, the user group update retrieved both certificates.

An RPM GUMS and a pacman VOMS works fine.

---++ VOMRS and a user's expired certificates
VOMRS recognizes a user by the certificate used in the browser.  If a user waits until his certificate expires before requesting 
a new one, VOMRS will think it is a new user.  We will no longer be able to associate a set of certificates as a set belonging to 
one user.

---+ To Do List
   * Tanya L.
      * will create a script that will query VOMRS for users and all certificates associated with them 
      * NOTE: This script must be run by a VOMRS admin
   * Tony
      * Need to run Tanya's script daily and publish the results
      * Need to ask for a public place to publish results
   * John
      * Write a script that merges VOMRS with GUMS data and makes appropriate changes to the GUMS DB


-- Main.JohnWeigand - 08 Jan 2013
