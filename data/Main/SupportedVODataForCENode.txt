%META:TOPICINFO{author="BrianBockelman" date="1486494990" format="1.1" version="1.9"}%
%META:TOPICPARENT{name="JohnWeigand"}%
---+!!<nop>Publishing Supported VOs for a Compute Element (CE)
%TOC%
%STARTINCLUDE%

---++Introduction
In the OSG environment, it is necessary to identify the set of VOs that a Compute Element (CE) supports, resource availability data about those nodes  and to collect accounting data for those nodes.

The VO identity is used in the following OSG systems:
   * <nop>Trash.ReleaseDocumentationMonALISA - uses grid3-user-vo-map.txt
   * GIP - uses grid3-user-vo-map.txt
   * VORS - uses the registration databases for sites and then aliases when conflicts occur
   * VOMS Monitor - uses edg-mkgridmap.conf
   * Gratia - uses grid3-user-vo-map.txt
   * <nop>GridCat - uses grid3-user-vo-map.txt (expected to be deprecated so not addressed specifically)

In addition, the VO name is also used in the following:
   * DOE certification site

Unfortunately there is little consistency as to the value used to identify the VO.  The purpose of this document is to identify the known problems and provide resolution.

---++VO Name Usage in the Various Components

---+++<nop>Trash.ReleaseDocumentationMonALISA
uses grid3-user-vo-map.txt


---+++GIP - 
uses grid3-user-vo-map.txt


---+++VORS
uses the registration databases for sites and then aliases when conflicts occur


---+++VOMS Monitor
uses edg-mkgridmap.conf


---+++Gratia
usesgrid3-user-vo-map.txt


---+++<nop>GridCat
uses grid3-user-vo-map.txt (expected to be deprecated so not addressed specifically)

---++grid3-usr-vo-map.txt file
---+++Historical Background.
At this time a little background and explanation of one file, <i>grdi3-user-vo-map.txt</i>,  is needed to better understand the problem.  This file was intended to be used for just this purpose.

The <i>grid3-user-vo-map.txt</i> file was originally used only by <nop>Trash.ReleaseDocumentationMonALISA in the collection of user job metrics.  Since the user data was captured by UNIX account, this file was established to perform the conversion.  
<pre>
#voi  <b>List of identifiers that the UNIX account is initially translated to on the uncommented line</b>
#VOc  <b>List of the VOs that the #voi entries are translated to.  There is a 1 for 1 mapping to #voi.</b>
UNIX_account   #voi_entry <b>Maps the UNIX account to #voi indentifier</b>
</pre>
The translation from UNIX account to reportable VO is actually a double translation:
   * first the UNIX account is translated to the #voi entry on based on the uncommented line entry
   * then the #voi identifier is converted to the reportable VO name using the #voi and #VOc entries (these must be paired lists).
In the example below, UNIX accounts uscms001, uscms002 and uscmsadmin will all have their metrics reported as the USCMS VO.  The metrics collected for ivdgl001 and ivdgl002 users will have their metrics reported as iVDGL.
<pre>
#voi  uscms cms ivdgl            
#VOc USCMS USCMS iVDGL    
uscms001 uscms
uscms002 uscms
   :
uscmsadmin cms
  :
ivdgl001 ivdgl
ivdgl002 ivdgl
</pre>


There are 2 main problems with the use of the <i>grid3-user-vo-map.txt</i> file:
   * Integrity of the data
   * (Mis-)use of the data

---+++Integrity of the data
For those sites using the <i>edg-mkgridmap</i> cron script to update their <i>grid-mapfile</i>, the <i>grid3-user-vo-map.txt</i> file had to be manually maintained.  In many cases, this was not being done.  Keeping this file accurate on a manual basis is pretty much an impossible task as there are no tools to detect changes in the many VO's memberships.

For those sites using GUMS, the <i>grid3-user-vo-map.txt</i> is mechanically updated using the <i>gums-host-cron</i> cron script.  No direct manual maintanence is required.

In both cases, it is possible to have a <i>grid-mapfile</i> entry or an account mapping from GUMS for a UNIX account that does not exist and the user, while authorized, will not be capable of running a job.  If this condition exists for all members of a particular VO, then that VO is not being supported by that site.

On 9/20/06 a conference call was held to address this data integrity issue with the following participants: Shaewon Wang, Leigh Grundhoefer, John Weigand and Alain Roy.   The following enhancements were decided on and will be available with the VDT 1.6.0 release (ITB 0.5.1+).


---++++Sites using edg-mkgridmap
New script: <i>VDT_LOCATION/osg-vo-map/sbin/<b>generate-vo-map</b></i> script (courtesty of Alain Roy):

This script will use the <i>VDT_LOCATION/edg/edg-mkgridmap.conf</i> to generate a <i>grid3-user-vo-map.txt</i> file.  The format of the configuration file will be changed to include the reportable VO name as the second token in the commented line above the VOMS server entry.
<pre>
#1 cdf CDF Subir Sarkar (subir.sarkar@cnaf.infn.it)
group vomss://voms.cnaf.infn.it:8443/voms/cdf cdf
#2 fermilab FermiLab -- Fermilab Grid Support Center (helpdesk-admin@fnal.gov)
group vomss://voms.fnal.gov:8443/voms/fermilab fermilab
#3 ukminos FermiLab -- Fermilab Grid Support Center (helpdesk-admin@fnal.gov)
group vomss://voms.fnal.gov:8443/voms/fermilab/ukminos ukminos
   : 
</pre>
This script will create the <i>grid3-user-vo-map.txt</i> by re-reading the newly generated <i>grid-mapfile</i> in conjunction with the configuration file resulting in:
<pre>
#voi cdf fermilab ukminos          <b>... this is the sub-classification within a reportable VO name</b>
#VOc CDF Fermilab Fermilab    <b>.... this is the reportable VO name</b>
cdf cdf
fermilab fermilab
minos ukminos
</pre>

<b>This script will be incorporated in the <i>edg-mkgridmap</i> cron script</b>


---++++Sites using GUMS
These sites already have the <i>grid3-user-vo-map.txt</i> file created using the gums-host-cron script.

The <i>gums.config</i> contains the quivalent information as the <i>edg-mkgridmap.conf</i> for reportable VO and sub-classifications.
---++++All sites (edg-mkgridmap and GUMS)
New script: <i>VDT_LOCATION/osg-vo-map/sbin/<b>check-vo-map</b></i> script (courtesy of Alain Roy)

This script addresses the issue of a VO having either no members or none of the members of a VO having UNIX accounts available.  It will verify that each potential UNIX account is, in fact, available by doing a 'bin/id'.  If an account does not exist, it will drop that entry from the user vo map file replacing the existing file with the modified one.  

This script will generate the following additional files when complete:
   * <i>osg-supported-vos.txt</i> - This will contain the list of all VOs for which at least one member can be authorized and has an established UNIX account.
   * <i>osg-undefined-accounts.txt</i> - This will contain a list of all accounts that can be authorized/assigned, but no UNIX account exists.

<b>This script will be incorporated in both the <i>edg-mkgridmap</i> and <i>gums-host-cron</i> scripts.</b>



---+++(Mis-)use of the data
With the exception of <nop>Trash.ReleaseDocumentationMonALISA, all the middleware that uses the <i>grid3-user-vo-map.txt</i> appears to be using:
   * either the #voi entry associated with the uncommented UNIX-to-#voi line.
   * or mapping correctly to the #VOc entry, but converting it to lower case before using it.

A meeting was held on 12/6/06 to address this issue with the following participants:  Shaewon Wang, Horst Severini, Rob Quick, John Roeshek and John Weigand.  It was agreed that  the #VOc value should be used. This allows for the mixed-case VO value such as iVDGL.  The  major issue will be acceptance of this by all the reporting/data collection systems.

<b>Open issue:</b>

---++Action items
   1 Shaewon will look into how EGEE is assigning VO names.  Are they using GIP output, another source... whatever? 




       







%STOPINCLUDE%

<!-- MAJOR UPDATES
For significant updates to the topic, consider adding your 'signature' (beneath this editing box) !-->
*Major updates*:%BR%
<!--Future editors should add their signatures beneath yours!-->
-- Main.JohnWeigand - 13 Nov 2006<br>



%INCLUDE{"Trash/Integration.WhuReferences"}%

%META:TOPICMOVED{by="JohnWeigand" date="1163436532" from="Main.OSGUserVoMap" to="Main.SupportedVODataForCENode"}%
