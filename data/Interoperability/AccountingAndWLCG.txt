%META:TOPICINFO{author="JohnWeigand" date="1312401420" format="1.1" reprev="1.22" version="1.22"}%
%META:TOPICPARENT{name="InteroperabilityWithWLCG"}%
<!--
   * Set MYOSG_HOME= [[http://myosg.grid.iu.edu/about][MyOSG]]
   * Set OIM_HOME = [[https://oim.grid.iu.edu/oim/home][OSG Information Management System (OIM)]]
   * Set OIM_SOP    = [[https://twiki.grid.iu.edu/bin/view/Operations/OIMStandardOperatingProcedures][OIM Standard  Operating Procedures]]
   * Set APEL_INTERFACE_DOC = [[Accounting.GratiaInterfacesApelLcg][OSG Accounting APEL/WLCG interface document]]

   * Set LHC_HOME  = [[http://lcg.web.cern.ch/LCG/Default.htm][LCG Worldwide LHC Computing Grid]]
   * Set LHC_REGISTRATION = [[http://lcg.web.cern.ch/LCG/site-help.htm][LHC Site Registration]] 
   * Set LHC_GETTING_STARTED = [[http://lcg.web.cern.ch/LCG/site_start.htm][LHC Getting Started page]]
   * Set LCG_TOPOLOGY = [[http://wlcg-rebus.cern.ch/apps/topology//][WLCG REBUS Topology]]

   * Set EGEE_ACCOUNTING_OSG_VIEW = [[http://www3.egee.cesga.es/gridsite/accounting/CESGA/osg_view.html][EGI Accounting Portal OSG view]]
   * Set EGEE_ACCOUNTING_TIER1_VIEW = [[http://www3.egee.cesga.es/gridsite/accounting/CESGA/tier2_view.html][EGI Accounting Portal Tier 1 view]]
   * Set EGEE_ACCOUNTING_TIER2_VIEW = [[http://www3.egee.cesga.es/gridsite/accounting/CESGA/tier2_view.html][EGI Accounting Portal Tier 2 view]]
   * Set EGEE_MONTHLY_MOU_REPORTS = [[http://lcg.web.cern.ch/LCG/accounts.htm][EGEE Monthly MOU Reports]]

   * Set GRATIA_HOME = [[https://twiki.grid.iu.edu/twiki/bin/view/Accounting/WebHome][Gratia]]
   * Set GRATIA_REPORTING = [[http://gratia-osg-prod-reports.opensciencegrid.org/gratia-reporting][Gratia Accounting Reporting page]]
   * Set GRATIA_VALIDATION_DOCUMENT = [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/ValidateGratia][OSG Validate Gratia documentation]]

   * Set GIP_BDII_VALIDATION_DOCUMENT = [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/ValidateBDII][OSG Validate GIP/BDII documentation]]

   * Set LHC_REGISTRATION_SECTION = [[#LHC_Registration][LHC Registration section]]
   * Set OSG_REGISTRATION_SECTION = [[#OSG_Registration][OSG Registration section]]

   * Set ISSUES_PAGE = [[https://twiki.grid.iu.edu/bin/view/Interoperability/AccountingInteropQuestionsAndIssues][Accounting Systems Interoperability Questions, Issues, and Proposals twiki]]
-->


---+!! *<noop>%SPACEOUT{ "%TOPIC%" }%*



%TOC%
---++ Overview
Accounting records collected by %GRATIA_HOME% are forwarded to the EGI accounting system, APEL.    This is important for US-LHC Tier1 and Tier2 facilities which have to demonstrate to the LHC project delivered computing resources on behalf of ATLAS, ALICE and CMS collaborations, in accordance with signed Memorandum of Understanding (MOU) agreements.  A service outside the OSG software infrastructure (VDT) runs at Fermilab, parses and analyzes accounting records for a resource, scales wall time figures into SPEC_int2000 (!SI2K)  for the processor type, and then forwards to an APEL server at the EGEE GOC.

This accounting data is used to publish monthly Tier 1/2 reports for those OSG registered __resource groups__ that have been registered with LHC and have enabled the !MyOsg !WLCGInformation !InteropAccounting flag and !AccountingName data.

For an OSG __resource group__ (aka LCG site) to be included in WLCG Interoperability reporting the following must occur/exist:
   1 It must be registered in OSG (see the %OSG_REGISTRATION_SECTION%) with the WLCG Interop Accounting data populated for each resource that is to be reported to WLCG.
   1 It must be registered with LCG LHC (see the  %LHC_REGISTRATION_SECTION%)
   1 Verify your accounting data is being reported correctly to the Gratia accounting system.
   1 Verify your data is being reported correctly by GIP.

For a detailed description of the interface, refer to the %APEL_INTERFACE_DOC%.


---++ OSG Registration
A __resource group__ (aka LCG site) must be registered in %OIM_HOME% __with at least one active resource__.  See the %OIM_SOP% for details on what is required.

You can have 1 or more resources within that __resource group__ providing any number of services.  For each resource you want reported to WLCG, for the __resource group__, you need to populate the WLCG Information Interop Accounting data.

The process for enabling Accounting Interoperability when registering (or at later point in time):
   1 Check the box indicating "This is a WLCG resource" (the display will expand to add more information)
   1 Check the box "Should this resource be part of WLCG Interop Accounting?"
   1 Populate the "WLCG Accounting Name" with the Federation Accounting Name of your __resource group__ in the %LCG_TOPOLOGY%

Data will only be forwarded to WLCG for OSG resources that have this !InteropAccounting data populated.  The accounting data will be summarized by __resource group__ (LCG site) for all __resources__ with the Interop Accounting flag set to True.

This data will be viewable in the %EGEE_ACCOUNTING_OSG_VIEW%. However, it will not be used in any WLCG reporting until the __resource group__ is registered with LHC (%LHC_REGISTRATION_SECTION%).

---++ LHC Registration
An OSG __resource group__ must be registered with the %LHC_HOME%. These should be good sections of that page to get started with:
   * %LHC_REGISTRATION% 
   * %LHC_GETTING_STARTED%

When registering in LHC (assumed to be part of the MOU agreement), you will be providing an [[http://gstat-wlcg.cern.ch/apps/topology/][LCG Topology]] that determines how the reporting is done.  __It is very important to understand that the LCG Site is equivalent to the OSG <u>resource group</u> and not the <u>resource</u>  within the <u>resource group</u>__.

Once this registration process is complete, your OSG __resource group__ will be viewable in either the %EGEE_ACCOUNTING_TIER1_VIEW% or %EGEE_ACCOUNTING_TIER2_VIEW%.

Additionally, you will included in the %EGEE_MONTHLY_MOU_REPORTS% issued by  the LCG accounting office.  These are generally available on the 8th of the month for the previous month.

__IMPORTANT:__  If you are deprecating (disabling) an OSG __resource group__ (and maybe replacing it with another), you do __NOT__ want to ask the LCG accounting office to remove the deprecated one.  The %LCG_TOPOLOGY% shown for your Federation Accounting Name is not time sensitive.  You will lose the historical information for the deprecated OSG __resource group__ (LCG site) if you do.

---++ Verify Gratia reporting.
You will need to verify that the accounting data is being reported correctly to Gratia with regard to:
   * The VO the data is being reported as.   The interface only sends data to WLCG for the CMS, ATLAS and ALICE VOs.
   * The Gratia site (!MyOsg resource name) your data is being reported as.

To do this, go the the %GRATIA_REPORTING%:
   * In the left hand menu, select "Daily Usage by VO for Site"
   * In the "Site Name" box, select your site (this is the OSG resource you populated with WLCG Interop Accounting data)
   * Then click on the "Display Report below" button.
   * Verify that the results seem reasonable for the VOs being reported.

To trouble-shoot any reporting problems, first review the %GRATIA_VALIDATION_DOCUMENT%.

If you still feel there is a problem with the data being reported, open a GOC ticket:
   * Go to %MYOSG_HOME%    
   * Select "GOC Ticket"  under "Other Services" on the right hand side.  
   * When you are on the GOC Ticket/Submitter page, under "Central Service Issues", select "Gratia".

---++ Verify GIP/BDII reporting
You will need to verify that GIP (Generic Information Provider) is reporting correctly to the OSG BDII service for the OSG Resource in your __resource group__.

This GIP/BDII data being reported is used to determine a normalization factor for the accounting data sent to APEL/WLCG.

To trouble-shoot any reporting problems, first review the %GIP_BDII_VALIDATION_DOCUMENT%.

If you still feel there is a problem with the data being reported, open a GOC ticket:
   * Go to %MYOSG_HOME%
   * Select "GOC Ticket"  under "Other Services" on the right hand side.
   * When you are on the GOC Ticket/Submitter page, under "Central Service Issues", select "GOC BDII".

---++ Open Issues
Refer to the %ISSUES_PAGE%








---++ *Comments*
%COMMENT{type="tableappend"}%

%META:TOPICMOVED{by="X509_2fDC_3dorg_2fDC_3ddoegrids_2fOU_3dPeople_2fCN_3dKyle_20A_2e_20Gross_20453426" date="1291735234" from="ReleaseDocumentation.AccountingAndWLCG" to="Interoperability.AccountingAndWLCG"}%
