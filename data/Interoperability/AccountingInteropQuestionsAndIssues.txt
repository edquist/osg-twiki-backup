%META:TOPICINFO{author="JohnWeigand" date="1321034663" format="1.1" reprev="1.13" version="1.13"}%
%META:TOPICPARENT{name="AccountingAndWLCG"}%
<!--
   * Set SummaryRecords = [[https://wiki.egi.eu/wiki/APEL/MessageFormat#Summary_Job_Records][Summary Job Records]]
   * Set JobRecords = [[https://wiki.egi.eu/wiki/APEL/MessageFormat#Job_Records][individual Job Records]]
   * Set SummarySyncRecords =[[https://wiki.egi.eu/wiki/APEL/MessageFormat#Summary_Sync_Records][Summary Sync Records]]
-->


---+ Accounting Systems Interoperability Questions And Issues
%TOC%
---++ Introduction
This is where all current questions and issues related to interoperability of the Accounting Systems should be listed.


---++ APEL SSM/ActiveMQ interface
Currently, the Gratia/APEL interface sends the selected Gratia data to WLCG by performing  a direct SQL DML update of a table (OSG_CN_DATA)  in the APEL accounting database.  This will be changing sometime in the future and will be using an SSM/ActiveMQ method to perform this.  There will no longer be any direct access to the APEL database.

This section provides some references/notes/questions on this new interface.

---+++ References
[[https://wiki.egi.eu/wiki/APEL/Server][APEL/Server]]:
This page references a record publisher component which, on the surface, sounds like the capability to retrieve data from APEL.  However, there is no further information about it.%BR%
%BLUE%Will there be the  capability to retrieve data from the APEL database via this new protocol?
%ENDCOLOR%%BR%
%GREEN% They claim that it is possible but not documented. We will need to increase pressure or a least ask them for examples. 
%ENDCOLOR%%BR%

[[https://wiki.egi.eu/wiki/APEL/SSMOverview][SSM Overview]]:
This messaging system will replace the current direct access SQL DML update/access to the APEL database table for OSG (OSG_CN_DATA).

[[https://wiki.egi.eu/wiki/APEL/SSMInstallation][SSM Installation]] - Questions related to the installation of the necessary software are documented in this [[#SSM_Installation][section]].

[[https://wiki.egi.eu/wiki/APEL/MessageFormat][APEL/SSM Message format]] - Questions related to the new messaging protocol are documented in this [[#APEL_SSM_message_format][section]]

[[https://wiki.egi.eu/wiki/APEL/APELSSMExternalTesting][SSM External Testing]] - Question related to testing are documented in this [[#SSM_External_Testing][section]].
 
[[http://activemq.apache.org/python.html][ActiveMQ]] - purely for reference are this time.

---+++ Release date
%BLUE%Is there a hard "drop-dead" date when the current direct access to the APEL accounting will no longer be supported?%ENDCOLOR%%BR%
%GREEN% (Will Rogers 11/11/11 - The 15th December is not a deadline for when we’ll be moving to the new system.  I’m not actually sure where the date came from.  I think we’ll do well to get the new system operational by then.  After it is operational there’ll be at least a couple of months for transition before we close the access to the DB that you’ve got at the moment.
%ENDCOLOR%

---+++ [[https://wiki.egi.eu/wiki/APEL/SSMInstallation][SSM Installation]]
This section contains some questions specific to this document.

__Prerequisites__  %BR%
* __certificates__ %BR%
 The documentation in the [[https://wiki.egi.eu/wiki/APEL/SSMInstallation#Certificates][Certificates section of SSM Installation page]] implies a host certificate should be used.%BR%
 %BLUE%Can a service certificate be used?%ENDCOLOR%%BR%
%GREEN% Yes, you have to send them DN %ENDCOLOR%

 * __Stomp__ %BR%
This is the client software which communicates with Apache !ActiveMQ (the message broker).%BR%
%BLUE%Where can we find documentation on this package?%BR%
http://packages.python.org/stompy/introduction.html ? %ENDCOLOR%%BR%
%GREEN%(Will Rogers 11/11/11) - Stomppy – confusingly there is a stompy and a stomppy.  We’re using the latter.  Its page is here: http://code.google.com/p/stomppy/.
%ENDCOLOR%%BR%
%RED%(John Weigand 11/11/11) - Strange, I think the original doc said we could use stomp and I did with no problems.
Need to change test environment to use the pp one (stomppy).
%ENDCOLOR%%BR%

* __lcg-CA__ %BR%
We use the OSG CA certificates.%BR%
%BLUE%Will this suffice?%ENDCOLOR%%BR%
%GREEN% Should be ok %ENDCOLOR%

* __Installation__ %BR%
Have not got this far so no questions at this time%BR%

__Configuration__ %BR%
The last bullet in this section implies that an acknowledgment is performed indicating the success/failure of the communication between the client and consumer.  This implies some level of synchronous communication.%BR%
%BLUE%Is this just at the message level or does this extend to the APEL database update the consumer is performing?%ENDCOLOR%%BR%
%GREEN% Only message level, database operation is completely separate process %ENDCOLOR%

__Certificates__ %BR%
This implies a host certificate should be used.  It would be easier to implement if a service certificate could be used as this would facilitate running from multiple hosts as needed.%BR%
%BLUE%Can a service certificate be used?%ENDCOLOR%%BR%
%GREEN% Yes%ENDCOLOR%%BR%
%BLUE%(John Weigand 11/2/11 - Requested service cert from Tanya.%ENDCOLOR%%BR%

__Running the SSM__ / __Stopping the SSM__ %BR%
<OL>
<LI>Based on the description, this sounds like a daemon process that is periodically checking a messages directory for files.%BR%
%BLUE%Is there a plan to allow this to be run from init.d services?%ENDCOLOR%%BR%
%GREEN% Yes%ENDCOLOR%%BR%
%BLUE%(John Weigand 11/2/11) - We won't be running this as a daemon service.  We will be running in a "once and done mode". 
So, item 2 below regarding having that type argument would be nice.   %ENDCOLOR%%BR%
%GREEN%(Will Rogers 11/11/11) - It seems a reasonable request to allow a run-once configuration for the SSM.  It is just another task to do, though, so not sure how high priority it will be.
%ENDCOLOR%%BR%
%RED%(John Weigand 11/11/11) - We can wait and see.  In the meantime, I think we will set a procedure (or hack the code) to allow us to operate that way.
%ENDCOLOR%%BR%

<LI> __run-ssm__ script%BR%
a. Our mode of operation is to summarize the Gratia data once per day and send it up to APEL/EGI.  It is a cron scheduled job. Although the previous bullet implies it would be nice to have this as an init.d service, this is not the mode we desire.  We would like a "once and done" mode.
%BR%
%RED%(John Weigand 11/2/11) - Can there be a command line argument (or config file option) that allows the script to terminate when the message has been sent and an acknowledgment received?
%ENDCOLOR%%BR%
%GREEN%(Will Rogers 11/11/11) - It seems a reasonable request to allow a run-once configuration for the SSM.  It is just another task to do, though, so not sure how high priority it will be.
%ENDCOLOR%%BR%
%RED%(John Weigand 11/11/11) - We can wait and see.  In the meantime, I think we will set a procedure (or hack the code) to allow us to operate that way.
%ENDCOLOR%%BR%


b. Associated with this, a "timeout" option/arg would be useful so our interface script is not waiting forever when the transmission is unsuccessful.  This allows us to be aware of a problem (naturally checking for a non-zero return code) and take remedial action, if necessary.
%BR%
%RED%(John Weigand 11/2/11) - Can this also be provided?%ENDCOLOR%%BR%
%GREEN%(Will Rogers 11/11/11) - It seems a reasonable request to allow a run-once configuration for the SSM.  It is just another task to do, though, so not sure how high priority it will be.
%ENDCOLOR%%BR%
%RED%(John Weigand 11/11/11) - We can wait and see.  In the meantime, I think we will set a procedure (or hack the code) to allow us to operate that way.
%ENDCOLOR%%BR%


c. I noticed, while doing some troubleshooting on our end, that the main module looking for messages (__ssm_master.py__) is reading the messages/outgoing directory every 1 second.  This seems extremely frequent.  Our Gratia probes (which handle talking to Gratia) only check every 10 minutes for files.   If this is intended for cron execution and it will terminate in a "once and done" mode this is ok.  However, if a daemon process, this may consume resource unnecessarily.   The frequency could be a config option or command line argument.  This is just an observation as we won't be using it in this mode.
%BR%
%RED%(John Weigand 11/2/11) - Although this does not necessarily affect us because of our intended use, I think this could be a problem.%ENDCOLOR%%BR%
%GREEN%(Will Rogers 11/11/11) -The request for "once and done" applies to the frequency of checking the directory for new messages as well.
%ENDCOLOR%%BR%
%GREEN%(John Weigand 11/11/11) - Not really worried about this one since we will operate in "once and done" mode.
%ENDCOLOR%%BR%

</OL>

---+++ Direct DB Access vs Messaging
The approach taken with the current  interface was to keep it as simple as possible allowing for an easy means of correcting changing data in the OSG Gratia accounting system.  On a daily basis, the interface performs:
   * DELETE from OSG_CN_DATA where Month = mm and Year = yy %BR%
     (this removes all interfaced OSG resource group data for the month)
   * INSERT into OSG_CN_DATA (summarized data) where Month = mm and Year = yy. %BR%
     (for all interfaced OSG resource groups) 
   * commit %BR%
     (this is all one atomic transaction)

This approach could be used for the the following reasons:
   * The current Gratia/APEL interface is performed using a direct SQL DML update of the APEL accounting database. 
   * The required  granularity of the APEL/EGI data is monthly summaries by Site,  VO and DN. 
   * The OSG site's data is segregated from other EGI sites by being stored in an OSG specific table (OSG_CN_DATA).  

The new interface is a messaging based layer which no longer provides us direct access to our data.  It is our understanding that the messages will result  in a database table update (SQL DML REPLACE)  based on certain key fields.  Since we send summary data by site, vo and user DN, and not detail data, we will be sending 
[[https://wiki.egi.eu/wiki/APEL/MessageFormat#Summary_Job_Records][Summary Job Records]]. 

The problem, from the Gratia end of things, is that this now makes it extremely difficult to correct any changes made in Gratia to correct in the APEL/EGI database.  There are (and have been from the beginning) capabilities in Gratia to make corrections in the accounting data collected for things like site and vo.   Individual job records are collected by Gratia and recorded.  Those records themselves rarely change but how the data collected is reported in terms of site and vo  can be changed.  

A recent example of this (although it does not affect the VOs we are currently reporting) is this request (there is a similar correction table for sites).
<blockquote>
NEES users being mapped to Engage rather than engage.  In the !VONameCorrection table, the VOid is pointing to Engage (92) instead of engage (114).  Can you please change the VOid in the !VONameCorrection table to point to engage for the VOName:
/Engage/NEES/Role=NULL/Capability=NULL 
/Engage/UCSDGrid/Role=NULL/Capability=NULL 
</blockquote>

The point of this is that when something like this is effected, the summary data we retrieve  reflects the current state.  If a site or vo were to change, we would have no means of knowing what it was yesterday and the data previously sent would still exist in APEL/EGI.   For us to insure the data in APEL/EGI is reflective of the current Gratia data, we would have to  perform some delta between the previous state and the current state and make adjustments accordingly.  This process would add unneeded complexity and be prone to error.

__Request__ : %BLUE%Can there be a message format that would allow for removing (as in our old DELETE) based on site and yr/mos?  This would simplify processing on our end immensely.  We recognize that we would still have to keep track of changes in site but that is something more manageable. %ENDCOLOR%%BR%
%GREEN% No%ENDCOLOR%%BR%
%RED%(John Weigand 11/2/11) - This will make for a mess that I hope I never have to be a part of.%ENDCOLOR%

The only option we see available, to achieve the same result, would be to create 2nd file/message  of %SummaryRecords% with the same set of "keys" with all time/job fields set to zero.  Then, for each update, we would send this 2nd file (from the previous run) up first.  Then we send the "real" updates for the current run.  

%BLUE%The question then is "Will they be processed sequentially on the APEL end?".%ENDCOLOR%
%BR%
%GREEN% Don't know%ENDCOLOR%
%BR%
%RED%(John Weigand 11/2/11) This is how we are going to do it and hope for the best.%ENDCOLOR%
%BR%
%GREEN%(Will Rogers 11/11/11) Messages ARE applied sequentially, with the exception of duplicates.
%ENDCOLOR%%BR%

---+++ [[https://wiki.egi.eu/wiki/APEL/MessageFormat][APEL SSM message format]]
Gratia will not be sending individual job records to APEL/EGI.  As today, Gratia will be sending summary data based on site, vo and user DN.   

Questions related to the %SummaryRecords%.
<OL>
    <LI> !WallDuration/CPUDuration%BR%
      Currently, the "times" sent up for these fields are in a time scale of hours.  The %JobRecords%  explicitly state these are to be in seconds. 
%BR%  
%GREEN%(Will Rogers 11/11/11) These will be in Hours.  The documentation now reflects this.
%ENDCOLOR%
%BR%


     <LI> !NormalisedWallDuration/!NormalisedCpuDuration%BR%
      Currently, Gratia is sending normalized data using a !SpecInt value.  The %JobRecords% provide for specifying a  !NormalizationFactorUnit. The %SummaryRecords% do not.     We can provide either but would prefer !HepSpec as that is what all new processors are evaluated with.  
%BR% 
%BLUE%Can we assume it is the !HepSpec value that is required? Can the document reflect this?%ENDCOLOR%
%BR% 
%GREEN%(Will Rogers 11/11/11) - Use !HepSpec06 NF factor.  The documentation now reflects this.
%ENDCOLOR%



     <LI>Group/Role%BR%
      In the %SummaryRecords%, there are 2 new fields that we have not been required to populate with the current interface: Group and Role.  We are assuming these are optional and at the discretion of the VOs which, in our case, are cms/atlas/alice.  The documentation indicates that if these are not "published", they will set to "None" in the database. %BR%
%BLUE%Is there any problem if we always "publish" them with a string value of "None"?%ENDCOLOR%
%BR% 
%GREEN%(John Weigand - 11/2/11) -  Testing has shown this to be true.%ENDCOLOR%
</OL>

Questions related to the %SummarySyncRecords%:<OL>
    <LI> %BLUE%Is this file/message also required?%ENDCOLOR%%BR%
    %GREEN% Don't know%ENDCOLOR%%BR%
   %RED%(John Weigand - 11/2/11) - Would be nice to know if we need to be concerned with this and, if so, what is it????%ENDCOLOR%%BR%
   %GREEN%(Will Rogers 11/11/11) - Sync records - these aren’t required if you’re just sending summaries to us.  I’ll update the wiki documentation to make this clearer.
%ENDCOLOR%%BR%
</OL>


---+++ SSM External Testing
Link: [[https://wiki.egi.eu/wiki/APEL/APELSSMExternalTesting][SSM External Testing]]%BR%
We have subscribed to the mailing list but have gone no further as yet but do have some preliminary questions.
<OL>
  <LI>In the Usage section, the interface sounds like it is an asynchronous protocol. %BR%
        %BLUE%Are there plans for this to be synchronous in nature when it goes to production? (in terms of both the message and, more importantly, the database update)?%ENDCOLOR%%BR%
%GREEN%No, it will be completely asynchronous%ENDCOLOR%%BR%
%RED%(John Weigand 11/2/11) - This makes the ability to retrieve data from the EGI portal critical to verifying if the interface worked.%ENDCOLOR%%BR%


<LI>It appears the test environment is limited to just the messaging and database update.
%BLUE%Will there be an environment which tests the complete data flow inclusive of the EGI portal UI?%ENDCOLOR%%BR%
%RED%(John Weigand 11/2/11) - How then do we actually test?%ENDCOLOR%%BR%

</OL>
 

---+++ Retrieval/Publishing of APEL/EGI data
Currently, after the daily update of APEL is performed, we do a retrieval of the data using a SQL select of the data for the following tables:
   * OSG_CN_DATA
   * org_Tier1
   * org_Tier2

This retrieval uses the SQL client capability to output the table data in html, dat and xml formats for access by other OSG applications.  This data is currently used in these OSG site pages:
   * [[http://red-web.unl.edu/gratia/wlcg_reporting#atlas][OSG WLCG Reporting]]
   * [[http://gratia-osg-prod-reports.opensciencegrid.org/gratia-data/interfaces/apel-lcg/][Gratia-APEL WLCG Interface]] (also accessible from the main [[http://gratia-osg-prod-reports.opensciencegrid.org/gratia-reporting][Gratia reporting page]] menu on the left side.)

---++++ Topology data (aka org_Tier1/2 tables)
It is our understanding that the org_Tier1/2 tables are being replaced by the [[http://wlcg-rebus.cern.ch/apps/topology/][WLCG REBUS Topology]].  This site has the capability to "export" the data is a csv format.  This will probably be adequate since the amount of data is relatively small.

There are still a couple questions relative to how this topology data is used. 
It is our understanding that for the data to be reflected in the Tier1/2 views a WLCG Site (OSG resource group) must be registered with LCG accounting and an MOU agreement in effect.
The site will then be populated in the WLCG Topology and only those Sites will have their data reflected in that view under the appropriate Country/Federation Name/Federation Accounting Name in the hierarchy.  Some of these questions have come up as the WLCG Topology does not appear to be time sensitive and Sites can come and go over time.
<OL>
<LI>If a site (OSG resource group) is being removed from service, we assume that site must remain in the topology or any historical data associated with its contribution toward the Federation Accounting Name will be lost.  We recently had this case with a site MWT2_IU being replaced by site MWT2.   We advised them __not__ to have the MWT2_IU removed.
%BLUE%Were we correct in this assumption?%ENDCOLOR%%BR%
%GREEN%No clue %ENDCOLOR%%BR%
%RED%(John Weigand 11/2/11) - It would be nice to get this answered so we understand how OSG sites should handle deprecated sites in <nop>MyOSG/OIM.  In the old interface, there did exists files/tables that masked some of this.%ENDCOLOR%%BR%

<LI>In the past (or maybe still), the org_Tier1/2 tables determined if a site was displayed in the EGI portal under the appropriate view/hierarchy.  There were also 1 or 2 other tables/configuration files (not viewable by us) that took care of this "removal of a site" from service but allowed the historical data to still be visible.  An example of this was a Purdue-Lear site back in 2008 and its data was still viewable by using these other tables/files. 
%BLUE%Are any other tables/configuration files still being used or is the WLCG Topology the sole driver of the data?%ENDCOLOR%%BR%
%RED%(John Weigand 11/2/11) - It would be nice to get this answered so we understand how OSG sites should handle deprecated sites in <nop>MyOSG/OIM.  In the old interface, there did exists files/tables that masked some of this.%ENDCOLOR%%BR%

<LI>%BLUE%When a site is registered in LCG and an MOU agreement reached, should the data for past periods be sent up or does the date of the registration mark the start of the data requirement?%ENDCOLOR%%BR%
%GREEN%No clue %ENDCOLOR%%BR%
%RED%(John Weigand 11/2/11) - Need to know so we can establish the correct procedures.%ENDCOLOR%%BR%

<LI>While documenting all this and in viewing the data on the EGI portal, there appears to be no data prior to April 2009.  We have been sending data up since at least March 2008. 
%BLUE%Is there an "archival" process in effect that we should be aware of?%ENDCOLOR%%BR%
%GREEN%No clue %ENDCOLOR%%BR%
%RED%(John Weigand 11/2/11) - Another "good to know" point.  It should be noted that both links at the bottom of the EGI Accounting Portal that seem to intend to describe this, don't work (for me anyway)%ENDCOLOR%%BR%
</OL>
%GREEN%(Will Rogers 11/11/11) Topology data – we haven’t looked at this recently, so at least I am not sure of the status.  If you think this is urgent, give us another nudge and we’ll have a look.
%ENDCOLOR%%BR%
%RED%(John Weigand 11/11/11) Not urgent but we need to nudge them as we need to understand the procedures to follow.
%ENDCOLOR%%BR%

---++++ OSG site data (aka OSG_CN_DATA)
As mentioned in the  earlier, Gratia needs visibility to the APEL data we publish.  It has been mentioned that the EGI portal allows for the downloading of the data in a csv format using the link at the bottom of the currently displayed table.  However, there does not appear to be a programmatic means of doing this.  The link executes a javascript that apparently access what ever criteria was used to display the page. 
%BLUE%Are there any plans to provide an API for data retrieval? With some criteria?  This is a really much needed requirement.%ENDCOLOR%%BR%
%GREEN%yes, it is possible but not documented yet %ENDCOLOR%%BR%
%RED%(John Weigand 11/2/11) - CRITICAL  Otherwise we have to find a way to accommodate our requirements as described in this section. %ENDCOLOR%%BR%
%GREEN%(Will Rogers 11/11/11) - Feedback from apel system and / or portal – I’ll send another email about this.
%ENDCOLOR%%BR%
%RED%(John Weigand 11/11/11) - Without this capability, I am thinking we will have to modify the code to do a 2nd query summarized by VO so we can provide Nebraska with the data we need and, at the least, we then have a record of what we sent up to validate against the monthly MOU pdf.   Won't be exact but it is better than adding the code to summarize the query by DN.
%ENDCOLOR%%BR%

---++ SSM Testing
1. See  [[ https://wiki.egi.eu/wiki/APEL/SSMInstallation][SSM Installation Instructions]]

__Configuration section__
   * A general statement in the beginning when setting SSM_HOME variable might be useful saying it can be used in the ssm.cfg file but not in the ssm.log.cfg file. 

   * ssm.cfg - Since this in an ini format, might be useful to mention the section. Some were more obvious than others with the wording used. "the topic to send.." was not.  It is in the [producer] section.

__Running the SSM section__ 
   * I think the cd should be to $SSM_HOME/bin not $HOME/bin

   * In the configuration section, for the message store, you suggest using $SSM_HOME/messages but never mention it needs to be created. In addition in this section, you mention putting files to send in $SSM_HOME/messages/outgoing and never mention is obviously needs to be created.   I see where it gets creates on execution of run-ssm Other dirs are too but no mention of what they are for.

2. Testing documented here http://home.fnal.gov/~weigand/SSM/
 
3. Will told me they have a bug such that if the interface detects a problem on their end, it stops.  This is why I could not send yesterday.  They restarted it and the latest file went up.

4. Other issues;
   * They loop in the messages/outgoing directory every 1 sec. This is too much.  If no messages, there should be some sleep period. 
     This should be settable by the user.  
         This could easily be set in ssm-master.py here.. time.sleep(1.0) as the while loop will process all records until there are none.  
      
   * For sites like us sending summary records periodically it would be nicer if we could have a "once and done" option.  
     Maybe it would specify a "retry period" in the event of intermittent failures but would still terminate so we can indicate to our admins the state of the interface.
    This could also be done right in ssm-master.py. It could even have a retry arg/setting.

   * in messages_db.py (_get_message), there is a sort of the messages.
        Why?  This means that to insure an order, I have to be aware of this
        and reflect the order in the file name.  I would expect the
        receiving end to process my files in the order received.
        If, for whatever reason, I have 2 days data in the directory, the 2nd
        days has to go up last or I have to insure I always have only one file.

   * ssm_master.py
          log.debug('Ready for service. Listening for incoming messages.')
        .. should be 'outgoing' as that is the directory we are looking in.
           There is an incoming one and this confuses the issue.


---++ *Comments*

%COMMENT{type="tableappend"}%

%META:TOPICMOVED{by="X509_2fDC_3dorg_2fDC_3ddoegrids_2fOU_3dPeople_2fCN_3dKyle_20A_2e_20Gross_20453426" date="1291735203" from="ReleaseDocumentation.AccountingInteropQuestionsAndIssues" to="Interoperability.AccountingInteropQuestionsAndIssues"}%
