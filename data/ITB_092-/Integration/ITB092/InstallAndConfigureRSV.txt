%META:TOPICINFO{author="ArvindGopu" date="1208807038" format="1.1" version="1.33"}%
%META:TOPICPARENT{name="ComputeElementInstall"}%
---+!! *<nop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%

%STARTINCLUDE%
%BR%
---+ _%INCLUDEHEADING%  %SPACEOUT{ "%TOPIC%" }%_
%EDITTHIS%
%BR%

---++ RSV background

<p> The [[MonitoringInformation.RSV][OSG-RSV]] package, by default, is installed along with the OSG CE but not fully configured. Additional configuration steps are necessary as documented below. Starting with %CACHE% %VERSION% CE, RSV will always include a minimal Condor package called condor-cron that is used to schedule RSV probes and such.

<!-- If you are looking to install !RSV on a monitoring host independent of your CE then please [[http://rsv.grid.iu.edu/documentation/vdt-package.html#install_on_monitoring_host][look here]] for instructions on that. -->

---++ RSV configuration steps

---++++ Before you begin configuring !RSV - Quick request to VTB/ITB testers :-) 
<p> If you get your stuff from the VDT 1.10.0 cache, then please get an updated configure_osg_rsv script and updated probes after getting the CE or !OSG-RSV package [only till VDT 1.10.0a is released]:
   <pre> cd $VDT_LOCATION/osg-rsv/setup
 mv configure_osg_rsv configure_osg_rsv.old
 wget http://rsv.grid.iu.edu/downloads/pre-release/0.9.0/configure_osg_rsv
 chmod +x configure_osg_rsv</pre> 

   <pre> cd $VDT_LOCATION/osg-rsv/bin
 mv probes probes.old
 wget http://rsv.grid.iu.edu/downloads/OSG_RSV_Probes-2.2.2b.tar.gz
 tar -zxvf OSG_RSV_Probes-2.2.2b.tar.gz
 mv rsv-probes probes
 cp -p $VDT_LOCATION/osg-rsv/bin/probes.old/probe_wrapper.pl $VDT_LOCATION/osg-rsv/bin/probes
 cp -p $VDT_LOCATION/osg-rsv/bin/probes.old/add_new_probe $VDT_LOCATION/osg-rsv/bin/probes
 chmod -R go+rX $VDT_LOCATION/osg-rsv/bin/probes/ </pre>

<p> Thanks for your patience!


---++++ Should I use a service certificate or a user certificate?
<p> If you run !RSV right on a CE (SE), and only monitor that CE (SE), then you can use a service certificate to run RSV probes. The important factor is that the <em> service certificate or its proxy, per its policy and the OSG security group's mandate, should not leave the host it was generated for, and can only be used to test that host</em>. If you want to use a service certificate for !RSV,  then:
   * You must get one using [[https://twiki.grid.iu.edu/twiki/bin/view/ReleaseDocumentation/GetGridCertificates#Other_service_certificates][usual methods]]
   * You must ensure that service cert is authorized to run jobs on the CE/SE it is being used to test (GUMS or grid-mapfile) -- (Note from !RSV team: if an admin has more information on this, please add them here - thanks!)
   * Place RSV service cert in /etc/grid-security/ as <tt>rsvkey.pem</tt> and <tt>rsvcert.pem</tt>, or use command line switches to point to those files.

NOTE (to be addressed asap): %RED%  The term "leave the host" above is ambiguous, needs a better definition.  Can you make a proxy with an RSV service cert and do globus-url-copy and globus-job-run, or not. Is that "leaving the host?"   Answer--yes <br> if the proxy is going to any other gatekeeper or gridftp server than the one you are on. According to these docs--you can only monitor this one host with the RSV service cert so any gridftp-uri or ce-uri should only be going to this host---UPDATE: That's correct. %ENDCOLOR%

---++++ Pre-config check list
   * Ensure you have a <strong> valid username for !RSV</strong> (say, =rsvuser=); then as =root=,  replace entries in =<em><strong>italics</strong></em>= to appropriate values, and run the !RSV config script using <u>one of the following example configurations</u>
      * We expect that these command line instructions will have to be used till configure_osg is completely ready to take over configuring packages, including RSV, using a central !OSG-level .ini file.   
      * If you specify =--gridftp-probes=, then the corresponding =--gridftp-uri= is optional; if none is provided (i.e your CE host is where the GridFTP server runs), then those URIs default to the the =--ce-uri= assuming that is provided. 
      * If you configure !SRM probes, then you'll have to also provide a =--srm-dir= value where test files can be copied over to.

---++++ RSV running on OSG CE <strong>not using GUMS</strong>; and <strong>using RSV service cert</strong> to run probes:

   <pre> $VDT_LOCATION/osg-rsv/setup/configure_osg_rsv --user <em><strong>rsvuser</strong></em> --init --server y \
      --ce-probes --ce-uri "<em><strong>&#60;CE_FQDN&#62;</strong></em>" \ 
      --gridftp-probes [--gridftp-uri "<em><strong>&#60;GridFTP_FQDN&#62;</strong></em>" --gridftp-dir <em><strong>/path/to/write/test/file</strong></em>] \ 
      --gratia --grid-type "OSG-ITB" --verbose --setup-for-apache --use-rsv-cert \
      [--rsv-cert-file <em>/path/to/cert/public/cert</em> --rsv-key-file <em>/path/to/cert/private/key</em>] </pre>



      For more example configurations, [[#more_example_configs][see here]]. More information on the !RSV configuration script is [[http://rsv.grid.iu.edu/documentation/vdt-1.8.1a-package.html#configure_osg_rsv_script][available here]].


---++ Start RSV and related services
<p> Start Condor-cron and !RSV services (plus [re]start Apache, if you want the VDT Apache to serve your local status pages, and specified the <tt>--setup-for-apache</tt> switch above).  

<p> <strong>NOTE:</strong> If the services (for e.g., Apache) have already been started as a result of previous steps, then you should stop them and restart them again.

  <pre> ## Assuming you used --server 'y' above, these services should be enabled, but if they are not, then enable them
 ## vdt-control --enable condor-cron osg-rsv apache
 ## If apache is already turned on, then do vdt-control --off apache
 vdt-control --on condor-cron osg-rsv apache </pre>

      More information on this  is [[http://rsv.grid.iu.edu/documentation/vdt-1.8.1a-package.html#start_rsv][available here]].
%RED% By default if you installed an OSG CE install condor-cron and apache will 
already be enabled and started %ENDCOLOR%
---++++ Check if everything is in good shape
   * You can check all the condor-cron RSV jobs that got submitted typing <tt>condor_cron_q</tt>.
   *  After waiting about 15 minutes, check out the local status web page that is created with results of RSV probe runs each day. By default, this page is =$VDT_LOCATION/osg-rsv/output/html/index.html=, but can be reconfigured. You can either view the local status pages directly on the monitoring host ; or you can view these pages on the web at !http://&#60;FQDN_of_monitoring_host&#62;:8443/rsv, once again assuming you [[http://rsv.grid.iu.edu/documentation/vdt-package.html#configure_osg_rsv_script_localweb][configured !RSV to use the !VDT Apache]] to serve them in the above configuration steps. Beware that you <em>need to have an !OSG approved cert loaded in your web browser</em> to be able to view them page. The status pages should look similar to [[http://rsv.grid.iu.edu/documentation/sample_status.html][what is documented here]].

   * Look at Gratia consumer log file: =$VDT_LOCATION/osg-rsv/logs/consumers/gratia-script-consumer.out= to see if probe results were uploaded successfully to the !GOC maintained !RSV database. You should a bunch of entries similar to this:
   <pre>   08-20-2007 16:35:26 - Executing script '/usr/local/grid/ . . . record.py'
   OK </pre>

<!--   * Configure Metrics to run and how often: If this is the first time you're configuring !RSV, then copy the sample metrics file =$VDT_LOCATION/osg-rsv/config/sample_metrics.conf= to =$VDT_LOCATION/osg-rsv/config/&#60;host_FQDN&#62;_metrics.conf=, and make further edits to it if necessary. The sample file has the metrics listed with appropriate (recommended) time intervals. Enable/Disable a particular metric: Any line that starts with *on* is enabled; change that keyword to *off* to disable a metric. For example, if you site runs only the PBS job-manager, then you might disable the other jobmanagers-status probes.
   <pre>   on jobmanagers-status-probe@org.osg.batch.jobmanager-pbs-status 24 */2 * * *</pre>
   More information on this is [[http://rsv.grid.iu.edu/documentation/vdt-1.8.1a-package.html#configure_metrics][available here]]. Go here for documenation on [[http://rsv.grid.iu.edu/documentation/vdt-1.8.1a-package.html#extra_probe_specs][adding custom switches to the !RSV !probes]].
-->

<p><br>

<hr color="#111111">
<p><br>

---++ More Example Configurations
<a name="more_example_configs"></a>
  <p> In the additional examples shown below, replace entries in =<em><strong>italics</strong></em>= to appropriate values

---++++ RSV running one CE/standalong machine <em>monitoring multiple OSG CEs/SEs</em>; <strong>must use user certificate</strong> to run probes:
   <pre> # If you are installing !RSV on a separate host, then get it first:
 # pacman -get http://vdt.cs.wisc.edu/vdt_1100_cache:OSG-RSV
 ## Then do updates as mentioned in earlier section

 $VDT_LOCATION/osg-rsv/setup/configure_osg_rsv --user <em><strong>rsvuser</strong></em> --init --server y \
      --ce-probes --ce-uri "<em><strong>&#60;CE_FQDN1 CE_FQDN2 CE_FQDN3&#62; </strong></em>" \ 
      --srm-probes --srm-uri "<em><strong>&#60;SE_FQDN1 SE_FQDN2 SE_FQDN3&#62;</strong></em>" --srm-dir <em><strong>/pnfs/destination/test/directory</strong></em> \ 
      --gridftp-probes [--gridftp-uri "<em><strong>&#60;GridFTP_FQDN&#62;</strong></em>" --gridftp-dir <em><strong>/path/to/write/test/file</strong></em>] \ 
      --gratia --grid-type "OSG-ITB" --verbose --setup-for-apache \
      --proxy /path/to/rsvuser/proxy</pre>

<!--       --gums-probes [--gums-uri "<em><strong>&#60;CE_FQDN1 CE_FQDN2 CE_FQDN3&#62;</strong></em>"] \  -->

---++++ RSV running on OSG CE <strong>not using GUMS</strong>; <strong>using RSV service cert</strong> to run probes; and with <strong>RSV-Nagios forwarding enabled</strong>
    <p> First you'll have to edit =$VDT_LOCATION/osg-rsv/config/rsv-nagios.conf=, and fill in your Nagios server details -- see comments in that conf file for more details. Contact rsv-dev if you have questions. Then run configure_osg_rsv script as follows.
   <pre> $VDT_LOCATION/osg-rsv/setup/configure_osg_rsv --user <em><strong>rsvuser</strong></em> --init --server y \
      --ce-probes --ce-uri "<em><strong>&#60;CE_FQDN&#62;</strong></em>" \ 
      --gridftp-probes [--gridftp-uri "<em><strong>&#60;GridFTP_FQDN&#62;</strong></em>" --gridftp-dir <em><strong>/path/to/write/test/file</strong></em>] \ 
      --gratia --grid-type "OSG-ITB" --verbose --setup-for-apache --use-rsv-cert \
      --setup-rsv-nagios [--rsv-nagios-conf-file <em><strong>/optional/path/to/rsv-nagios.conf/file</strong></em>]
      [--rsv-cert-file <em>/path/to/cert/public/cert</em> --rsv-key-file <em>/path/to/cert/private/key</em>] </pre>


---++++ RSV running on OSG CE <strong>using GUMS</strong>; and <strong>using RSV service cert</strong> to run probes:
<p> This option is not documented right now because the one !GUMS probe that exists does not work properly, and is being re-written. Do *not* use the =--gums-probes= switch till we update this section of this document. Thank you.

<p>
More information on configuring !RSV and related topics is available in the [[http://rsv.grid.iu.edu/documentation/vdt-package.html][RSV documentation pages]].


%STOPINCLUDE%
%BR%
%COMPLETE2% %BR%
%RESPONSIBLE% -- Main.ArvindGopu - 08 Apr 2008 %BR%
%REVIEW%

%META:TOPICMOVED{by="AnneHeavey" date="1192740955" from="Integration/ITB_0_7.RSVInstallGuide" to="Integration/ITB_0_7.InstallAndConfigureRSV"}%
