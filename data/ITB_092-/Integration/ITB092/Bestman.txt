%META:TOPICINFO{author="IwonaSakrejda" date="1235025298" format="1.1" reprev="1.18" version="1.18"}%
%META:TOPICPARENT{name="WebHome"}%
---+!! *<nop>Berkeley Storage Manager (!BeStMan)*
%TOC%

%STARTINCLUDE%

*Purpose*: The purpose of this document is to provide [[Storage.BeStMan][BeStMan]] based SE administrators the information on how to prepare, install and validate the SE.

---++ Preparation
---+++ Introduction
 Berkeley Storage Manager ([[Storage.BeStMan][BeStMan]]) is a full implementation of SRM v2.2, developed by Lawrence Berkeley National Laboratory, for a small disk based storage and mass storage systems such as HPSS. End users may have their own personal [[Storage.BeStMan][BeStMan]] that manages and gives an SRM interface to their local disks. It works on top of existing disk-based unix file systems, and has been reported so far to work on file systems such as NFS, PVFS, AFS, GFS, and Lustre. It also works with any existing file transfer service, such as gsiftp, http, https, bbftp and ftp. It requires minimal administrative efforts on the deployment and updates. If storage is hierarchical and/or spans multiple file system types and storage systems, [[ReleaseDocumentation.DCache][SRM/dCache]] should be considered.

---++ Installation

While it is possible to deploy Bestman as a personal disk manager, the following descriptions target a more general use installation that provides an SE functionality for serving as a data gateway into your cluster. Bestman is distributed by the VDT and, like other services deployed in the OSG. It installs with Pacman and assumes PacmanInstall steps have been taken. This process will  install in a directory selected by an administrator of the SE (e.g. /opt/osg-1.0/) the necessary software by running the following command line. 
%NOTE% If you are doing a fresh install on a host that has a previous installation, setting =export OLD_VDT_LOCATION = /path-to-old-vdt/= will pre-answer the following questions.

---+++ 

=pacman -get ITB:Bestman=

The install process will ask to accept the vdt-cache, check for prequisites and ask to accept licenses. It will then ask several questions about deploying and enabling services for the GRID access. Specifically (though edited to only show the questions and suggested answers) :
<verbatim>
Do you want to add [http://software.grid.iu.edu/itb/] to [trusted.caches]? (y/n/yall): yall
Do you agree to the licenses? [y/n]  y
Where would you like to install CA files?
Choices:
        r (root)  - install into /etc/grid-security/certificates
                   (existing CA files will be preserved)
        l (local) - install into $VDT_LOCATION/globus/share/certificates
        n (no)    - do not install
r
Do you want to automatically update your CA Certificates? [y/n] y
Would you like to enable Globus GridFTP daemon to run automatically? y
Would you like to setup daily rotation of VDT log files? y
Would you like to enable the Bestman server to run automatically? y
Do you want to update the CA certification revocation lists (CRLs) automatically? [y/n] y
(downloading)                                                             
========== IMPORTANT ==========
The VDT no longer installs certificate authority certificates at install time.
Most of the software installed by the VDT *will not work* until you install
certificates.  To complete your CA certificate installation, see the notes
in the post-install/README file.
</verbatim>

The installation should finish quietly. You can review what has been in stalled by the following commands:
<verbatim>
# source setup.sh
# vdt-version

You have installed a subset of VDT version 1.10.98t:

Software                                                 Status              
--------                                                 ------              
Berkeley Storage Manager (BeStMan) 2.2.1.2.i2            OK                  
Fetch CRL 2.6.6                                          -                   
GPT 3.2autotools2004-NMI-9.0                             -                   
Gratia GridFTP Probe 1.02.1-5                            OK                  
Java 6 SDK 1.6.0_11                                      OK                  
Logrotate 3.7                                            -                   
vdt-update-certs 2.2                                     -                   
Wget 1.11                                                -                   


Status legend:
OK: Software is up to date with the latest release in VDT version 1.10.98
- : Not enough information to determine if updates are available.
See man page for more information.
</verbatim>

And check which services are ready to deploy with:
<verbatim>
# vdt-control --list
Service            | Type   | Desired State
-------------------+--------+--------------
fetch-crl          | cron   | enable
vdt-rotate-logs    | cron   | enable
vdt-update-certs   | cron   | enable
gsiftp             | inetd  | enable
gratia-gridftp-tran| cron   | do not enable
bestman            | init   | enable
</verbatim>


---+++ Configuration

The full review of Bestman configuration options are provided in the [[http://datagrid.lbl.gov/bestman/docs/bestman-guide.html][Bestman Administration Guide]]. The process is controlled by a Bestman-specific configuration script ( =$VDT_LOCATION/bestman/setup/configure= ) with command line arguments to define such items as cache directories, CA cert and CRL locations, service ports, logging information ... During the VDT installation, some defaults are used to do an initial configuration and can be reviewed from the =vdt-install.log= file. For example:
<verbatim>
# grep /bestman vdt-install.log | grep configure
### 2009-02-18 15:27:48 (failsafe_system) cd /opt/osg/itb-0.9.2/bestman/setup; 
./configure     --with-java-home=/opt/osg/itb-0.9.2/jdk1.6    
--with-srm-home=/opt/osg/itb-0.9.2/bestman    
--with-srm-owner=daemon    
--with-cacert-path=/opt/osg/itb-0.9.2/globus/TRUSTED_CA 
--with-certfile-path=/etc/grid-security/http/httpcert.pem   
--with-keyfile-path=/etc/grid-security/http/httpkey.pem  
--with-eventlog-path=/opt/osg/itb-0.9.2/vdt-app-data/bestman/logs    
--with-cachelog-path=/opt/osg/itb-0.9.2/vdt-app-data/bestman/logs 
--with-http-port=10080    
--with-https-port=10443        
--with-replica-storage-path=/opt/osg/itb-0.9.2/vdt-app-data/bestman/cache 
 --with-replica-storage-size=11368 
</verbatim>

This configuration is done by a script =$OSG_LOCATION/vdt/setup/configure_bestman=. This script sets/changes the following Bestman parameters:
<verbatim>
#./configure_bestman --help
Usage: ./configure_bestman --vdt-install <vdt install root>
        --server <y,n>
        --user <bestman user>
        --cert <bestman service cert>
        --key  <bestman service key>
        --http-port <public port number>
        --https-port <secure port number>
        --globus-tcp-port-range <low_port,high_port>
        --volatile-file-lifetime <lifetime in seconds>
        --cache-size <Cache size in MB>
        --gums-host <GUMS hostname>
        --gums-port <GUMS port number>
        --gums-url <GUMS URL>
        --gums-dn <Client DN for GUMS interface>
        --enable-gateway
        --use-xrootd
        --with-tokens-list <token-list>
        --with-transfer-servers <GridFTP server list>
        --with-allowed-paths <List of accessible paths>
        --with-blocked-paths <List of non-accessible paths>

If you specify --user you must specify --cert and --key as well
</verbatim>
The default configuration sets up Bestman to use grid mapfiles, but bestman is also fully capable of using the GUMS server.
If there is a need to change any of the parameters the =configure_bestman= script should be always used. Here is an example
how the owner, ports and dependence on GUMS were changed using this script:
<verbatim>
vdt/setup/configure_bestman --user srm --cert /etc/grid-security/srm/hostcert.pem --key /etc/grid-security/srm/hostkey.pem --server y  --http-port=60080    --https-port=60443 --gums-host osp2.lbl.gov --gums-port 8443
</verbatim>

It is important to notice that --server y should be specified, otherwise the =configure_bestman= script disables the bestman server and then
it needs to be turned on again with the =vdt-control --on bestman=.

---+++ Integration with the information system

Integration of the SE with the central information systems takes place during the Compute Element installation/configuration. See the topic [[ReleaseDocumentation/GenericInformationProviders][Generic Information Providers]]. The SE does not collect or publish information independently.

---++ Validation

Once you have your SE setup and configured, you need to register it with the [[http://datagrid.lbl.gov/sitereg/][LBL monitoring system]]. This will run daily tests against your SE and the results can be viewed [[http://datagrid.lbl.gov/osg/][here]].
---+++ 

---++ More Information

In order to learn more about [[Storage.BeStMan][BeStMan]], please visit the [[http://datagrid.lbl.gov/bestman][BeStMan official website]] and [[Storage.BeStMan][OSG BeStMan Status page]].
---++ References

[[Storage.BeStMan][OSG BeStMan page]]

[[http://datagrid.lbl.gov/bestman][BeStMan website at LBNL]] - User guides and latest downloadable tar files available here. Latest downloadables should be the same version as in VDT.

[[http://hep-t3.physics.umd.edu/HowToForAdmins.html#osgBestman][UMD !BeStMan Admin Instruction]] - UMD experience on how to admin !BeStMan

[[http://wt2.slac.stanford.edu/xrootdfs/bestman-gateway.html][SLAC !BeStMan Gateway mode Instruction]] - SLAC guide on !BeStMan gateway mode

[[http://datagrid.lbl.gov/osg][OSG SRM Daily Testing Results]] - OSG provides SRM v2.2 daily testing. Site registration is needed [[http://datagrid.lbl.gov/sitereg][HERE]]

[[http://sdm.lbl.gov/srm-wg][SRM specification and collaboration]] - from SRM collaboration working group

[[http://s-2.sourceforge.net/][S2]] - A SRM v2.2 test suite from CERN. It provides basic functionality tests based on use cases, and cross-copy tests, as part of the certification process and supports file access/transfer protocols: rfio, dcap, gsidcap, gsiftp
---+++ 

%STOPINCLUDE% 
%BR% 
%COMPLETE2% %BR% 
%RESPONSIBLE% Main.AlexSim - 4 Dec 2007 %BR% 
%REVIEW% Main.RobGardner - 23 May 2008 %BR% 
%REVCOM% Where are the installation instructions?
