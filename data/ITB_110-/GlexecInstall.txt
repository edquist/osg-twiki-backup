%META:TOPICINFO{author="KyleGross" date="1225985961" format="1.1" version="1.17"}%
%META:TOPICPARENT{name="WorkerNodeClient"}%
---+!! *<nop>%SPACEOUT{ "%TOPIC%" }%*
%TOC%

%STARTINCLUDE%
%BR%
---+ _%INCLUDEHEADING%  %SPACEOUT{ "%TOPIC%" }%_
%EDITTHIS%
%BR%

---++What is gLexec and why do you need it
gLexec is adapted from apache's suexec to use grid credentials to run jobs as another 
user.  It is meant to be used by VirtualOrganizations/VOInfo's that run pilot jobs.  In a pilot job one
user submits a job, either PANDA or Condor Glide-in, which then contacts the 
VirtualOrganizations/VOInfo's server and requests a workload once it has gotten the slot.  gLexec is 
used to authenticate the workload and verify that it is an authorized user from 
the VirtualOrganizations/VOInfo who has submitted the workload. 

gLexec has a number of authentication plugins and can be used both by 
EGEE LCAS/LCMAPS and by OSG with GUMS and SAZ.   It is an suid
program and thus must be installed on every single worker node individually. 
It cannot and must not be NFS-exported.  ***Note, however, that clever sysadmins can
install gLexec on an NFS partition with the rest of the worker node client, and then 
replace the nfs-mounted glexec with a symlink to the real glexec executable that is on a local disk***

---++Pre-install steps for gLexec

<b>gLexec must be installed as root</b>.

You must create a <b>"glexec" local user</b> before you attempt the installation. gLexec uses it for privilege separation and installation will fail without.

Starting OSG1.0, gLexec also requires a range of <b>group ids</b> for tracking purposes. 
Set aside at least 3 group ids per batch slot. They must be consecutive, but else can be in any range 
(default range is 65000-65049).

---++Installing the gLexec package

It is recommended that the gLexec package be installed within the OSG
Worker Node Client area because most of its dependencies are the same 
as those within the worker node client.  
To install:

<pre class="screen">
# pacman -get %VDT_CACHE_URL%:Glexec
</pre>
The tail of the install will look like this:
(Warning: screen shot is not yet updated to new VDT version)
<pre>
Downloading [Glexec-1.8.1.tar.gz] from [http://vdt.cs.wisc.edu/software/questions/1.8.1]...
Downloading [VOMS-Client-1.8.1.tar.gz] from [http://vdt.cs.wisc.edu/software/questions/1.8.1]...
Downloading [voms-essentials-1.7.20.1-x86_64_rhas_4.tar.gz] from [http://vdt.cs.wisc.edu/software//voms/1.7.20.1]...
Downloading [voms-client-1.7.20.1-x86_64_rhas_4.tar.gz] from [http://vdt.cs.wisc.edu/software//voms/1.7.20.1]...
Downloading [configure_glexec-1-43.tar.gz] from [http://vdt.cs.wisc.edu/software//configure_glexec/1]...
Downloading [configure_prima-1-257.tar.gz] from [http://vdt.cs.wisc.edu/software//configure_prima/1]...
Downloading [prima-0.7.x86_64_rhas_4.tar.gz] from [http://vdt.cs.wisc.edu/software//prima/0.7]...
Downloading [Chrpath-1.8.1.tar.gz] from [http://vdt.cs.wisc.edu/software/questions/1.8.1]...
Downloading [chrpath-0.13.2.x86_64_rhas_4.tar.gz] from [http://vdt.cs.wisc.edu/software//chrpath/0.13.2-1]...
Downloading [glexec-osg-0.3-x86_64_rhas_4.tar.gz] from [http://vdt.cs.wisc.edu/software//glexec/0.3]...

</pre>

Note that the =setup.sh= file is not changed to put the =glexec= binary into your path.
The install will create config files under =/etc/glexec=, create the =/var/log/glexec=
directory if it does not exist, and change the =glexec= binary to be suid.  (If you do not
see these, check the vdt-install.log and the post-install README file.

---++Post-install Configuration of gLexec
The following steps need to be executed manually after the 
=glexec= pacman install completes:

---+++Configure each node with host cert or proxy
Each node which is executing =glexec= needs to have either a host
certificate or a host proxy distributed from the gatekeeper.
There is a distribution script located at 
=http://fermigrid.fnal.gov/files/glexec/host_dist_latest.tgz=
which can be installed on your gatekeeper and will automatically create
a proxy from your gatekeeper's host certificate and push it out to =/etc/grid-security/hostproxy.pem= and =/etc/grid-security/hostproxykey.pem=.
The =/etc/grid-security/certificates= directory should also be pointing to a 
set of current CA Certificates and CRL files.

---+++Modify /etc/glexec/contrib/gums_interface/getmapping.cfg

Modify the file =/etc/glexec/contrib/gums_interface/getmapping.cfg=
to point to the correct location of your GUMS server.  The gums_url variable
is the only variable you should have to change.
<pre class="screen">
# more /etc/glexec/contrib/gums_interface/getmapping.cfg
# gums_interface/getmapping config file
#
# this is a shell script that gets sourced
#

vdt_location=/usr/local/grid
log_dir=/var/log/glexec

# GUMS config parameters
host_x509_file="/etc/grid-security/hostproxy.pem"
host_key_file="/etc/grid-security/hostproxykey.pem"
gums_url="https://fermigrid3.fnal.gov:8443/gums/services/GUMSAuthorizationServicePort"


# Optional SAZ command
# Leave it blank if you don't use SAZ
sazcmd_location=
sazcfg=

# if set to 1, will map even if SAZ fails
saz_warn_only=0

# monitoring program
# leave empty if none should be used
# if set, it will accept arguments
#   mon_pid log_dir job_id target_uid user_DN [vo issuer [user_FQAN]*]
monitor_exe=/usr/local/grid/glexec-osg/contrib/glexec_monitor/glexec_monitor

</pre>

---+++Modify /etc/glexec/tracking_groups.cfg

Modify the file =/etc/glexec/tracking_groups.cfg=
with the correct tracking group id range.
<pre class="screen">
# This file defines the range of GIDs
# used for tracking purposes
#
# Make sure this range of GIDs is not used for any other purpose
#
min_gid=65000
max_gid=65049
</pre>

---++Testing gLexec

Now as a non-privileged user, do the following (where xxxx below is replaced by the number of your uid, "yourvo" is your vo, etc.):
<pre class="screen">
> cd $VDT_LOCATION
>. setup.sh
> voms-proxy-init -voms yourvo:/yourvo 
> export GLEXEC_CLIENT_CERT=/tmp/x509up_uxxxx
> glexec-osg/sbin/glexec /usr/bin/id
It appears that the value of pthread_mutex_init is 10603520
uid=13160(fnalgrid) gid=9767(fnalgrid)
</pre>
If gLexec is successful, it will print out the uid and gid that your
proxy would normally be mapped to by your gums server.
The gLexec utility also has a process called glexec_monitor which 
runs as root through the life of the glexec'ed process..

---++About the gLexec log files
There are four gLexec log files that are made on each worker node and they have 
four different timestamp formats.  They all live by default in /var/log/glexec:
glexec_log, the main log of each glexec stamp, logs in GMT:
<pre>
glexec[14507]: 20080109T173203Z glexec pid: 14507
glexec[14507]: 20080109T173203Z Reading glexec configuration file failed, continue with default values.
glexec[14507]: 20080109T173203Z uid: real/eff cdffgrid(3377)/root(0), gid: real/eff cdf(3200)/root(0)
</pre>
gums_interface.log, the record of getting the gums mapping, logs in local time:
<pre>
[Wed Jan  9 11:32:04 CST 2008 # 14508] Base subject  '/DC=gov/DC=fnal/O=Fermilab/OU=Robots/CN=cdf/CN=Massimo Casarsa/USERID=casarsa/CN=proxy'
[Wed Jan  9 11:32:04 CST 2008 # 14508] Found subject '/DC=gov/DC=fnal/O=Fermilab/OU=Robots/CN=cdf/CN=Massimo Casarsa/USERID=casarsa'
[Wed Jan  9 11:32:04 CST 2008 # 14508]    Primary   FQAN '/cdf/Role=NULL/Capability=NULL'
[Wed Jan  9 11:32:04 CST 2008 # 14508] GUMS mapped to user 'cdf'
[Wed Jan  9 11:32:04 CST 2008 # 14508] Mapped as (1347,3200)
[Wed Jan  9 11:32:04 CST 2008 # 14508] User authorized by SAZ
[Wed Jan  9 11:32:04 CST 2008 # 14508] Launching monitor
</pre>
lcas_lcmaps.log, log of the lcas and lcmap portions, logs with a %RED%zero-indexed month%ENDCOLOR%  (January=0, February-1, etc.).  Time is local time.
<pre>
LCMAPS 1: 2008-00-09.11:32:03-14507-glexec_get_accounts : lcmaps.mod-runPlugin()
: found plugin /usr/local/grid/glexec-osg/lib64/modules/lcmaps_gums.mod
LCMAPS 1: 2008-00-09.11:32:03-14507-glexec_get_accounts : lcmaps.mod-runPlugin()
: running plugin /usr/local/grid/glexec-osg/lib64/modules/lcmaps_gums.mod
LCMAPS 5: 2008-00-09.11:32:03-14507-glexec_get_accounts :       lcmaps_plugin_gu
ms-plugin_run(): Adding POOL_INDEX :  (void)
LCMAPS 0: 2008-00-09.11:32:03-14507-glexec_get_accounts :       lcmaps_plugin_gu
ms-plugin_run(): gums plugin succeeded
LCMAPS 1: 2008-00-09.11:32:03-14507-glexec_get_accounts : lcmaps.mod-runPlugin()
: found plugin /usr/local/grid/glexec-osg/lib64/modules/lcmaps_dummy_good.mod
LCMAPS 1: 2008-00-09.11:32:03-14507-glexec_get_accounts : lcmaps.mod-runPlugin()
: running plugin /usr/local/grid/glexec-osg/lib64/modules/lcmaps_dummy_good.mod
LCMAPS 0: 2008-00-09.11:32:03-14507-glexec_get_accounts : lcmaps.mod-lcmaps_run_
with_pem_and_return_account(): succeeded
LCMAPS 7: 2008-00-09.11:32:03-14507-glexec_get_accounts : Termination LCMAPS
LCMAPS 1: 2008-00-09.11:32:03-14507-glexec_get_accounts : lcmaps.mod-lcmaps_term
(): terminating
</pre>
For completeness, glexec_monitor.log logs with timestamps in seconds since the Unix epoch.
<pre>
[1199899924#14680 14507] Used DN: "/DC=gov/DC=fnal/O=Fermilab/OU=Robots/CN=cdf/C
N=Massimo Casarsa/USERID=casarsa"
[1199899924#14680 14507] Used VO: "cdf" Issuer: "/C=IT/O=INFN/OU=Host/L=CNAF/CN=
voms.cnaf.infn.it"
[1199899924#14680 14507] Used FQAN: "/cdf/Role=NULL/Capability=NULL"
[1199899924#14680 14507] Parents: 378786030#12047,378786029#12035,378786019#1192
1,378785918#11226,378785910#11141,335634235#13168,335634234#13167,61#1
[1199899924#14680 14507] New uid found: 1347
[1199900526#14680 14507] Terminated, CPU user 17 system 15
[1199900526#14680 14507] All childs terminated
[1199900637#11010 10838] Terminated, CPU user 17 system 14
[1199900637#11010 10838] All childs terminated
</pre>
%STOPINCLUDE%


%BR%
%COMPLETE3% %BR%
%RESPONSIBLE% Main.StevenTimm - 18 Oct 2007 %BR%
%REVIEW%  %BR%
%REVCOM%  %BR%
%REVFLAG%  %BR%