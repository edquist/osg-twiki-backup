%META:TOPICINFO{author="JimBasney" date="1332183361" format="1.1" version="1.10"}%
%META:TOPICPARENT{name="OSGCATransition2012"}%
---+!! Plan for DOEGrids to !DigiCert Distinguished Name Transition

The [[OSGCATransition2012][2012 OSG CA Transition]] will require OSG participants who currently hold certificates from the DOEGrids CA to obtain certificates from a new CA (expected to be the [[http://www.digicert-grid.com/][DigiCert Grid CA]]). Since each [[http://www.igtf.net/][IGTF]] accredited CA must issue certificates with non-overlapping names, the certificates from the new CA will contain different names (called Distinguished Names or DNs). This plan documents the implications of this name change and procedures for making this transition as smooth as possible for OSG participants.

%TOC%

---++ Impacts

One major impact of the DN change is that OSG participants will need to register new DNs in VOMS for any certificates used to submit jobs or access data. This includes both user certificates and pilot certificates.

Another impact is that the DNs for some VOMS servers will change, requiring updates to the [[http://software.grid.iu.edu/pacman/tarballs/vo-client/vomses][vomses]] file. The following 34 VOs currently use DOEGrids DNs for their VOMS server: cdf, fermilab, star, atlas, dosar, dzero, des, GLOW, LIGO, nanohub, i2u2, NWICG, gpn, !CompBioGrid, Engage, osg, ilc, NYSGRID, SBGrid, CIGI, mis, osgedu, !NEBioGrid, Gluex, !GridUNESP, dayabay, hcc, CSIU, suragrid, nees, gcvo, gcedu, dream, and lbne.

DN changes will also impact local account mappings at compute elements and storage elements. In some cases (for example, dCache at BNL), everyone from a given VO is mapped to a single group account at the local site, so changes in individual user DNs won't require updated mappings. In other cases, pool accounts have been assigned to particular users, and DN changes will result in new pool accounts being allocated or will require manual re-mapping of pool accounts. Lastly, in other cases user DNs are manually mapped to local accounts, and these manual mappings will need to be updated. _We need to determine which sites/VOs/users fall into each of these categories to quantify the impact of the DN change._

Other OSG services that will require DN registration updates are:
   * https://twiki.grid.iu.edu (about 350 users, not all DOEGrids)
   * https://oim.grid.iu.edu (over 500 users registered, not all DOEGrids)
   * https://osg-docdb.opensciencegrid.org:440/cgi-bin/DocumentDatabase/ (about 400 DOEGrids users)

_How will user DN changes impact OSG accounting? Do we need to take steps to avoid double-counting users when their DNs change?_

In general, DN changes do not cause problems for server certificates, because clients check that the server certificate matches the server's hostname, rather than checking the full DN of the server certificate. Note however the issue of VOMS server certificates discussed above.

---++ Transition Plan

The following transition plan options are presented *for discussion purposes only* and are *not yet approved*.

When complete, the transition plans must address all the impacts identified above.

Idea: Pick one user per VO to go through the transition steps first, to test them out, before transitioning all other users of that VO.

---+++ Option A: Manual Transition

DN Transition Plan Option A is the default or basline approach that does not rely on developing new software or making changes to the OSG infrastructure.
Each VO is responsible for updating the VOMS registrations for that VO's users, however the VO sees fit.
Manual updates will likely be OK for small VOs, but could be expensive for large VOs. (Need to quantify this...)
(Maybe some VOs require only a small number of pilot certificates registered in VOMS?)

In this option OSG will:
   * Provide documentation for the VOs to assist with the VOMS transition.
   * Provide documentation for the sites to assist with any needed GUMS-related transition steps.
   * Provide a process for users to update their OIM, Twiki, and !DocDB registrations.

---+++ Option B: Algorithmic DN Mapping

DN Transition Plan Option B implements an algorithmic mapping between existing DOEGrids DNs and new !DigiCert DNs to allow pre-registration in VOMS for new !DigiCert DNs. DOEGrids DNs of the form

<verbatim>
   /DC=org/DC=doegrids/OU=People/CN=Name NNNNNN
</verbatim>

are mapped to

<verbatim>
   /DC=com/DC=DigiCert-Grid/O=Open Science Grid/OU=People/CN=Name OSGNNNNN
</verbatim>

For example, 

<verbatim>
   /DC=org/DC=doegrids/OU=People/CN=James Alan Basney 710056
</verbatim>

is mapped to 

<verbatim>
   /DC=com/DC=DigiCert-Grid/O=Open Science Grid/OU=People/CN=James Alan Basney OSG710056
</verbatim>

To implement the DN transition using this algorithmic mapping, first every VOMS administrator adds new !DigiCert-Grid DNs to the VO corresponding to existing DOEGrids DNs already registered with the VO. Scripts will be provided for VOMS administrators to do this in an automated fashion. Next, when users apply for their new !DigiCert-Grid certificates, the OSG CA front-end web application will prompt the user to first authenticate with their existing DOEGrids certificate. If authentication with the DOEGrids certificate is successful, the OSG CA front-end will submit an application for the user's new !DigiCert-Grid certificate for the corresponding !DigiCert-Grid DN. Therefore, when the user's identity is verified and the user's !DigiCert-Grid certificate is issued, the user's new certificate will have a !DigiCert-Grid DN that is already registered in VOMS, matching their previous DOEGrids DN registration.

For users who do not have an existing DOEGrids certificate, the OSG CA front-end web application will submit a request for a new !DigiCert-Grid certificate with =/CN=Name NNNNN=, i.e., without the =OSG= part, so there is no overlap with existing issued certificates. In this case, the users will need to register their new certificates in VOMS as usual.

---+++ Option C: ???

---++ Prior Experience

---+++ UK eScience

"There are technical limitations in VOMS that can be problematic if DNs are preserved when the CA changes.  There's an ongoing issue with the UK eScience CA doing precisely this, and is getting resolved one DN at a type by hand." See: https://ggus.eu/ws/ticket_info.php?ticket=77179

   * This issue seem to be caused because they changed CAs and kept the old DNs (VOMS seems to consider a identity to be the combination of issuer and DN). Since we are changing DNs, this seem irrelevant for us. - Von

---+++ !FermiGrid

Fermilab has gone through two DN transitions as part of the migration
from the experimental Fermilab KCA to the production IGTF accredited
Fermilab KCA.

It was fairly painful for the administrators of !FermiGrid, we managed to
conceal most of the pain from the users.

Since we knew ahead of time what the new DNs were going to look like,
and we could define an expected old to new transformation, we arranged to:

   1. Add the new DNs as "secondary" DNs (in VOMRS) approximately two weeks before the KCA transition,
   2. Made the KCA transition,
   3. Swapped the "primary" and "secondary" DNs (in VOMRS) after the KCA transition,
   4. Two weeks later, we purged all of the old format DNs from VOMRS.

--Keith Chadwick

---++ VO Details

---+++ ALICE

---+++ ATLAS

---+++ CMS

Brian Bockelman reports that CMS relies on individual DN to account mappings for output data.

---+++ LIGO

The LIGO VOMS server (voms.ligo.org) currently uses a DOEGrids certificate and so would be impacted by the DN transition. However, LIGO does not use VOMS widely, so it is a secondary concern.

Every US LIGO user that accesses any LIGO Data Grid (LDG) resources currently has a DOEGrids certificate. LIGO also has a large number (about 300) of server and host certificates from the DOEGrids CA.

User DN updates in LIGO currently require each user to fill out and submit a form that contains their DN and then that causes a process so that each local admin at LDG sites updates a grid-mapfile entry. In the future this information will be part of LIGO's LDAP infrastructure and the grid-mapfiles will be automatically generated from it.

---++ Technical Details

---+++ VOMS

VOMS has the concept of multiple DNs per user, so users can retain their VO roles when their DN changes. It is possible for users to self-register their new certificate in the VOMS server while logged in with their old certificate. However, currently this feature does not work well with GUMS.

Does OSG install VOMS server certs in =/etc/grid-security/vomsdir=?

The [[http://software.grid.iu.edu/pacman/tarballs/vo-client/vomses][vomses]] file will need to be updated for each VOMS server that replaces its DOEGrids certificate.

See [[https://wiki.egi.eu/wiki/FAQ:_renewing_a_personal_certificate]] for VOMRS and VOMS Admin details.

---+++ GUMS

GUMS does not have the concept of multiple DNs per user in the web interface, unless you use the manual mapping feature.  When a user's DN changes, sites:
   * Don't have any files on disk from the user and just ignore it.
   * Already have the user mapped manually, and just alter the manual mapping.
   * Log into the !MySQL interface and change the user account mapping by hand.

For the GUMS-related transition steps / documentation, it would be nice to know how to recycle the old assigned pool accounts, so sites don't need to create twice as many pool accounts for this transition.

An update to the existing GUMS 1.3 version that was last released in OSG 1.2 is in preparation. The new GUMS version (1.3.18.008) will get all DNs from VOMS for each user in a VO. This new version of GUMS has not yet been released.

---+++ edg-mkgridmap

edg-mkgridmap is a simple program that contacts VOMS servers and creates a gridmap file. It is an alternative to GUMS.

---+++ Distinguished Names

Certificates issued by the DOEGrids CA contain distinguished names of the following forms:
   * /DC=org/DC=doegrids/OU=People/CN=<em>full name ID#</em>
   * /DC=org/DC=doegrids/OU=Hosts/CN=<em>fqdn</em>
   * /DC=org/DC=doegrids/OU=Services/CN= <em>servicename</em>

For example:
   * /DC=org/DC=doegrids/OU=People/CN=James Alan Basney 710056
   * /DC=org/DC=doegrids/OU=Hosts/CN=ce.example.edu
   * /DC=org/DC=doegrids/OU=Services/CN=uscmspilot/cmssrv105.fnal.gov

Certificates issued by the !DigiCert Grid CA contain distinguished names of the following forms:
   * /DC=com/DC=DigiCert-Grid/...
   * /DC=com/DC=DigiCertGrid/...
   * /C=US/O=DigiCert Grid/...

For example:
   * /DC=com/DC=DigiCert-Grid/OU=People/CN=Jim Basney
   * /DC=com/DC=DigiCert-Grid/O=Open Science Grid/OU=Services/CN=ce.example.edu