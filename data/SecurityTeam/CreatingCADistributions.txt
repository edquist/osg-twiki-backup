%META:TOPICINFO{author="AnandPadmanabhan" date="1259081184" format="1.1" reprev="1.21" version="1.21"}%
%META:TOPICPARENT{name="PoliciesProcedures"}%
%TOC%
---+ Creating CA Distributions
This page documents the OSG Security Team process for creating new Certificate Authority packages for distribution to OSG sites. Note that you must follow the process through to the end to notify GOC of the new distribution.

Please refer to the separate procedure on [[AddRemoveCA][adding or removing CAs]] before making a new [[CADistribution][CA distribution]].

---++ Setup
   1 Get a user certificate+key in pkcs12 format from the DOEGrids CA. See Documentation.CertificateGet for instructions.
   1 Ask goc@opensciencegrid.org to add permissions for your certificate subject to access the https://osg-svn.rtinfo.indiana.edu/cadist svn repository. 
   1 Verify that rpmbuild is installed. The rpmbuild command is required for making the rpm, so it's best to use a !RedHat machine (any flavor) for this process.
   1 Install an svn client. Version 1.4.x is strongly recommended. Don't use a version 1.5.x client. See http://subversion.tigris.org/getting.html and/or http://www.collab.net/downloads/subversion/svn1.4.html.
   1 Configure svn to use your pkcs12 certificate+key for authentication by adding the following to ~/.subversion/servers, changing the path to your pkcs12 file as appropriate:<br />[groups]<br />iu = *.indiana.edu<br />[iu]<br />ssl-client-cert-file = /home/username/.globus/usercred.p12 
   1 Checkout a copy of the https://osg-svn.rtinfo.indiana.edu/cadist svn repository:<br />$ svn co https://osg-svn.rtinfo.indiana.edu/cadist 
   1 Setup [[http://www.gnupg.org][GPG]] with the security@opensciencegrid.org private key (see [[Security.SecureEmailKeyManagement]]) for signing the distribution.
   1 Install [[http://vdt.cs.wisc.edu/components/fetch-crl.html][fetch-crl]].
   1 Download, import, and verify the IGTF signing key (for example, by verifying the signature):<br/>$ gpg --recv-key 3CDBBC71<br/>$ gpg --check-sigs 3CDBBC71<br/>$ gpg --default-key $OSGSECKEYID --lsign-key 3CDBBC71

---++ Updating to a new IGTF distribution
   1 Change to an empty working directory and set $CAWORKDIR to the path:<br />$ cd `mktemp -d`<br />$ export CAWORKDIR=`pwd` 
   1 Set $IGTF_CERTS_VERSION:<br />$ export IGTF_CERTS_VERSION=1.24
   1 Download the new IGTF distribution tarball (and PGP signature) from http://www.eugridpma.org/distribution/igtf/current/:<br />$ wget http://dist.eugridpma.info/distribution/igtf/current/igtf-policy-installation-bundle-$IGTF_CERTS_VERSION.tar.gz<br/>$ wget http://dist.eugridpma.info/distribution/igtf/current/igtf-policy-installation-bundle-$IGTF_CERTS_VERSION.tar.gz.asc
   1 Verify the PGP signature on the tarball:<br/>$ gpg --verify igtf-policy-installation-bundle-$IGTF_CERTS_VERSION.tar.gz.asc
   1 Unpack the certificates:<br />$ tar xzf igtf-policy-installation-bundle-$IGTF_CERTS_VERSION.tar.gz 
   1 Go to a checkout of the https://osg-svn.rtinfo.indiana.edu/cadist svn repository and make sure it's up-to-date:<br />$ cd ~/svn/osg/cadist/trunk/CA-Certificates-Base<br />$ svn update 
   1 Run the process-igtf-distribution.pl script:<br />$ ./process-igtf-distribution.pl $CAWORKDIR/igtf-policy-installation-bundle-$IGTF_CERTS_VERSION/src/accredited ./certificates > igtf-$IGTF_CERTS_VERSION-update.log 
   1 Review the following three files:<br />igtf-$IGTF_CERTS_VERSION-update.log<br />igtf-$IGTF_CERTS_VERSION-update-diffs.log<br />igtf-$IGTF_CERTS_VERSION-update-script.sh<br />Be sure to understand the differences. Be particularly careful about hashes in the output that have &ldquo;files not in IGTF&rdquo; next to them--they will be deleted! Re-run the process-igtf-distribution.pl script as needed. In case the removal an IGTF CA may impact OSG operations, refer to the procedure for [[AddRemoveCA][removing CAs]].
   1 Run the update script:<br />$ ./igtf-$IGTF_CERTS_VERSION-update-script.sh
   1 Verify changes:<br />$ svn diff > /tmp/diffs 
   1 Update the certificates/INDEX.txt file. Don't miss the version number at the bottom of the page. 
   1 Verify that certificates/INDEX.txt contains the right number of CAs:<br/>$ grep http certificates/INDEX.txt | egrep -v 'www.igtf.net|security.teragrid.org'| wc -l<br/>$ ls certificates/*.0 | wc -l
   1 Update the certificates/CHANGES file. 
   1 Commit all changes:<br />$ svn commit -m "Updated to IGTF version $IGTF_CERTS_VERSION"

---++ Other updates

If any other changes are required:
   1 Refer to the procedure on [[AddRemoveCA][adding or removing CAs]].
   1 Manually apply the changes to the certificates subdirectory. 
   1 Update the INDEX.txt file as needed. 
   1 Update the CHANGES file. 
   1 Commit your changes:<br /> $ svn commit 

---++ Check the CA certificates and CRLs

   1 Run fetch-crl and investigate any error messages:<br/>$ cd certificates<br/>$ $VDT_LOCATION/fetch-crl/sbin/fetch-crl --loc `pwd` --out `pwd`
   1 Check for expired or near-expired CRLs:<br/>$ ../[[%ATTACHURL%/check-crl-expiry.pl.txt][check-crl-expiry.pl]] *.r0
   1 Check for expired or near-expired CAs:<br/>$ ../[[%ATTACHURL%/check-ca-expiry.pl.txt][check-ca-expiry.pl]] *.0
   1 Cleanup:<br/>$ rm *.r0<br/>$ cd ..

---++ Make the CA tarball distribution
   1 Make sure the certificate subdirectory in your svn workspace is up-to-date and contains no local modifications:<br />$ svn status certificates 
   1 Determine the version of the certificates distribution:<br />$ export OUR_CERTS_VERSION=1.0 
   1 Tag the SVN repository:<br />$ svn copy https://osg-svn.rtinfo.indiana.edu/cadist/trunk \<br /> https://osg-svn.rtinfo.indiana.edu/cadist/tags/osg-certificates-$OUR_CERTS_VERSION-igtf-$IGTF_CERTS_VERSION \<br /> -m "Tagging OSG certificates distribution $OUR_CERTS_VERSION containing IGTF version $IGTF_CERTS_VERSION" 
   1 Create the tarball:<br />$ tar cvfz osg-certificates-$OUR_CERTS_VERSION.tar.gz --exclude .svn certificates 
   1 Sign it with the security@opensciencegrid.org PGP key:<br />$ gpg --default-key $OSGSECKEYID -b osg-certificates-$OUR_CERTS_VERSION.tar.gz 
   1 Make the manifest:<br />$ ./make-manifest 
   1 Make the MD5 checksums:<br />$ ( cd certificates; md5sum *.0 ) > cacerts_md5sum.txt

---++ Make the RPM
   1 Verify that $OUR_CERTS_VERSION and $IGTF_CERTS_VERSION are set correctly:<br />$ echo $OUR_CERTS_VERSION $IGTF_CERTS_VERSION
   1 Verify that rpmbuild is in your $PATH:<br />$ which rpmbuild
   1 Run the make-rpm script:<br />$ ./make-rpm

---++ Make the DEB [Under Testing]
   1 Verify that $OUR_CERTS_VERSION and $IGTF_CERTS_VERSION are set correctly:<br />$ echo $OUR_CERTS_VERSION $IGTF_CERTS_VERSION
   1 Verify that dpkg-deb, fakeroot, dpkg-scanpackages and debsigs  are in your $PATH:<br />$ which dpkg-deb fakeroot dpkg-scanpackages debsigs 
      * If any of the tools are not installed on your system you may use build-debian-tools to download and install them <br/> $./build-debian-tools
   1 Run the make-deb script:<br />$ ./make-deb

---++ Save the distribution files in SVN
   1 Copy the files to the svn release directory:<br/>$ cp osg-certificates-$OUR_CERTS_VERSION.tar.gz osg-certificates-$OUR_CERTS_VERSION.tar.gz.sig \<br/> osg-ca-certs-$OUR_CERTS_VERSION-0.noarch.rpm ca-certs-version cacerts_md5sum.txt ../../release
   1 Change to the svn release directory:<br/>$ cd ../../release
   1 Commit the files:<br>$ svn add osg-certificates-$OUR_CERTS_VERSION.tar.gz osg-certificates-$OUR_CERTS_VERSION.tar.gz.sig \<br/> osg-ca-certs-$OUR_CERTS_VERSION-0.noarch.rpm ; <br/>svn commit -m "OSG certificates distribution $OUR_CERTS_VERSION"

---++ Update the web site

Update [[CADistribution]] if there are any significant changes to the contents of the distribution (beyond regular IGTF distribution updates).

---++ Announce the new distribution

Notify the GOC that a new release is available.
The GOC will publish and announce the release.
Send email according to the following template:
<pre>
To: goc@opensciencegrid.org
Cc: osg-security-team@opensciencegrid.org
Subject: Request to immediately deploy NEW OSG CA DISTRIBUTION RELEASE n.x

Tarball Version: n.x
RPM Version: n.x-0
</pre>
The email message must be signed by your DOEGrids certificate.

---++ References
   * [[http://vdt.cs.wisc.edu/internal/igtf-updates.html][VDT Distribution Process]] 
   * [[http://svnbook.red-bean.com/en/1.4/][Subversion Manual]] and [[http://svnbook.red-bean.com/en/1.4/svn.ref.html][Subversion Reference]] 
   * [[https://osg-svn.rtinfo.indiana.edu/cadist/][OSG WebSVN -- CA distribution repo]] 
   * [[http://software.grid.iu.edu/pacman/cadist/][OSG CA Certificates Distribution hosted by the GOC]]
   * [[http://yum.grid.iu.edu/][OSG GOC Yum Repository]]
   * [[http://dist.eugridpma.info/distribution/igtf/current/][IGTF Distribution]] 
   * [[http://security.teragrid.org/TG-CAs.html][TeraGrid CAs]] 
   * [[http://www.tacar.org/][TERENA Academic CA Repository]]
   * [[http://goc.grid.sinica.edu.tw/gocwiki/Procedure_for_new_CA_release][EGEE Procedure]]

%META:FILEATTACHMENT{name="check-ca-expiry.pl.txt" attachment="check-ca-expiry.pl.txt" attr="" comment="a script to check for expired and expiring CA certificates" date="1249503840" path="check-ca-expiry.pl" size="419" stream="check-ca-expiry.pl" tmpFilename="/usr/tmp/CGItemp14259" user="JimBasney" version="1"}%
%META:FILEATTACHMENT{name="check-crl-expiry.pl.txt" attachment="check-crl-expiry.pl.txt" attr="" comment="a script to check for expired and expiring CRLs" date="1249503914" path="check-crl-expiry.pl" size="771" stream="check-crl-expiry.pl" tmpFilename="/usr/tmp/CGItemp14332" user="JimBasney" version="1"}%
