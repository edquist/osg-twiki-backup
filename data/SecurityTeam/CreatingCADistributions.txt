%META:TOPICINFO{author="DougOlson" date="1222713981" format="1.1" version="1.7"}%
%META:TOPICPARENT{name="SecurityTeamWorkingArea"}%
%TOC%
---+ Creating CA Distributions
 This page documents the OSG Security Team process for creating new Certificate Authority packages for distribution to OSG sites.

---++ Setup
   1 Get a user certificate+key in pkcs12 format from the DOEGrids CA or another trusted CA. 
   1 Ask goc@opensciencegrid.org to add permissions for your certificate subject to access the https://osg-svn.rtinfo.indiana.edu/cadist svn repository. 
   1 Verify that rpmbuild is installed. The rpmbuild command is required for making the rpm, so it's best to use a !RedHat machine for this process.
   1 Install an svn client. Version 1.4.x is strongly recommended. Don't use a version 1.5.x client. See http://subversion.tigris.org/getting.html and/or http://www.collab.net/downloads/subversion/svn1.4.html.
   1 Configure svn to use your pkcs12 certificate+key for authentication by adding the following to ~/.subversion/servers, changing the path to your pkcs12 file as appropriate:<br />[groups]<br />iu = *.indiana.edu<br />[iu]<br />ssl-client-cert-file = /home/username/.globus/usercred.p12 
   1 Checkout a copy of the https://osg-svn.rtinfo.indiana.edu/cadist svn repository:<br />$ svn co https://osg-svn.rtinfo.indiana.edu/cadist 
---++ Updating to a new IGTF distribution
   1 Change to an empty working directory and set $CAWORKDIR to the path:<br />$ cd /tmp/osg-certs-20080903<br />$ export CAWORKDIR=`pwd` 
   1 Download the new IGTF distribution tarball from http://www.eugridpma.org/distribution/igtf/current/accredited/:<br />$ wget http://dist.eugridpma.info/distribution/igtf/current/accredited/igtf-policy-installation-bundle-1.24.tar.gz 
   1 Set $IGTF_CERTS_VERSION and unpack the certificates:<br />$ export IGTF_CERTS_VERSION=1.24<br />$ tar xzf igtf-policy-installation-bundle-$IGTF_CERTS_VERSION.tar.gz 
   1 Make an installation directory:<br />$ mkdir made-igtf-$IGTF_CERTS_VERSION 
   1 Configure the installation. We want all of the accredited CAs plus the Fermilab KCA certificate:<br />$ cd igtf-policy-installation-bundle-$IGTF_CERTS_VERSION<br />$ ./configure --prefix=../made-igtf-$IGTF_CERTS_VERSION --with-profile=classic --with-profile=slcs --with-profile=mics --with-authority=FNAL_KCA 
   1 Install the certificates into your temporary directory:<br />$ make install 
   1 Go to a checkout of the https://osg-svn.rtinfo.indiana.edu/cadist svn repository and make sure it's up-to-date:<br />$ cd ~/svn/osg/cadist/trunk/CA-Certificates-Base<br />$ svn update 
   1 Run the process-igtf-distribution.pl script:<br />$ ./process-igtf-distribution.pl $CAWORKDIR/made-igtf-$IGTF_CERTS_VERSION ./certificates > igtf-$IGTF_CERTS_VERSION-update.log 
   1 Review igtf-$IGTF_CERTS_VERSION-update.log, igtf-$IGTF_CERTS_VERSION-update-diffs.log, and igtf-$IGTF_CERTS_VERSION-update-script.sh. Be sure to understand the differences, even though most of them are CVS related or are simple version string changes. Be particularly careful about hashes in the output that have &ldquo;files not in IGTF&rdquo; next to them--they will be deleted! Re-run the process-igtf-distribution.pl script as needed. 
   1 Run the update script:<br />$ ./igtf-$IGTF_CERTS_VERSION-update-script.sh 
   1 Verify changes:<br />$ svn diff > /tmp/diffs 
   1 Update the certificates/INDEX.txt file. Don't miss the version number at the bottom of the page. 
   1 Update the certificates/CHANGES file. 
   1 Commit all changes:<br />$ svn commit 
---++ Updating to a new !TeraGrid CA distribution

If there have been changes to the [[http://security.teragrid.org/TG-CAs.html][TeraGrid CAs]]:
   1 Manually apply the changes to the certificates subdirectory. 
   1 Update the INDEX.txt file as needed. 
   1 Update the CHANGES file. 
   1 Commit your changes:<br />$ svn commit 

---++ Other updates

If any other changes are required:
   1 Manually apply the changes to the certificates subdirectory. 
   1 Update the INDEX.txt file as needed. 
   1 Update the CHANGES file. 
   1 Commit your changes:<br /> $ svn commit 
---++ Make the CA tarball
   1 Make sure the certificate subdirectory in your svn workspace is up-to-date and contains no local modifications:<br />$ svn status certificates 
   1 Determine the version of the certificates distribution:<br />$ export OUR_CERTS_VERSION=1.0 
   1 Tag the SVN repository:<br />$ svn copy https://osg-svn.rtinfo.indiana.edu/cadist/trunk \<br /> https://osg-svn.rtinfo.indiana.edu/cadist/tags/osg-certificates-$OUR_CERTS_VERSION-igtf-$IGTF_CERTS_VERSION \<br /> -m "Tagging OSG certificates distribution $OUR_CERTS_VERSION containing IGTF version $IGTF_CERTS_VERSION" 
   1 Create the tarball:<br />$ tar cvfz osg-certificates-$OUR_CERTS_VERSION.tar.gz --exclude .svn certificates 
   1 Sign it with the security@opensciencegrid.org PGP key:<br />$ gpg --default-key $OSGSECKEYID -b osg-certificates-$OUR_CERTS_VERSION.tar.gz 
---++ Make the manifest
   1 Verify that $OUR_CERTS_VERSION and $IGTF_CERTS_VERSION are set correctly:<br />$ echo $OUR_CERTS_VERSION $IGTF_CERTS_VERSION 
   1 Run the make-manifest script:<br />$ ./make-manifest 
---++ Make the RPM
   1 Verify that $OUR_CERTS_VERSION and $IGTF_CERTS_VERSION are set correctly:<br />$ echo $OUR_CERTS_VERSION $IGTF_CERTS_VERSION
   1 Verify that rpmbuild is in your $PATH:<br />$ which rpmbuild
   1 Run the make-rpm script:<br />$ ./make-rpm
---++ Save the distribution files in SVN
   1 Copy the files to the svn release directory:<br/>$ cp osg-certificates-$OUR_CERTS_VERSION.tar.gz osg-certificates-$OUR_CERTS_VERSION.tar.gz.sig \<br/> osg-ca-certs-$OUR_CERTS_VERSION-0.noarch.rpm ca-certs-version ../../release
   1 Change to the svn release directory:<br/>$ cd ../../release
   1 Commit the files:<br>$ svn add osg-certificates-$OUR_CERTS_VERSION.tar.gz osg-certificates-$OUR_CERTS_VERSION.tar.gz.sig \<br/> osg-ca-certs-$OUR_CERTS_VERSION-0.noarch.rpm; svn commit

---++ Update the web site

Update [[CADistribution]] as needed.

---++ Announce the new distribution

Notify goc@opensciencegrid.org that a new release is available from 
https://osg-svn.rtinfo.indiana.edu/cadist/release/ and 
https://rt-svn.uits.indiana.edu/svn-web/osg/listing.php?repname=cadist&path=%2Frelease%2F#_release_.

---++ References
   * [[http://vdt.cs.wisc.edu/internal/igtf-updates.html][VDT Distribution Process]] 
   * [[http://svnbook.red-bean.com/en/1.4/][Subversion Manual]] and [[http://svnbook.red-bean.com/en/1.4/svn.ref.html][Subversion Reference]] 
   * [[https://rt-svn.uits.indiana.edu/svn-web/osg/][OSG WebSVN]] 
   * [[http://software.grid.iu.edu/pacman/cadist/][OSG CA Certificates Distribution hosted by the GOC]]
   * [[http://yum.grid.iu.edu/][OSG GOC Yum Repository]]
   * [[http://dist.eugridpma.info/distribution/igtf/current/][IGTF Distribution]] 
   * [[http://security.teragrid.org/TG-CAs.html][TeraGrid CAs]] 
   * [[http://www.tacar.org/][TERENA Academic CA Repository]]