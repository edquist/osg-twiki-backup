%META:TOPICINFO{author="DougOlson" date="1285723156" format="1.1" reprev="1.44" version="1.44"}%
%META:TOPICPARENT{name="ReleaseDocumentation.PoliciesProcedures"}%
%TOC%
---+ Creating CA Distributions
*%RED%Page needs update for new ITB -> Production service transition plans%ENDCOLOR%*
<verbatim>
date	Wed, Jul 14, 2010 at 11:44 AM
subject	Re: discuss CA deployment details

Summarizing the discussion of the CA package deployment:
1. We will continue to deploy ITB vs. production files
 through the different svn repo directories as we do now.
2. Email notice to GOC about a new CA package to deploy
 will include the svn directory URL for the source of the files,
 text describing if it is ITB vs. production release,
 the current svn revision number for the release and the svn
 revision number for the previous release (needed for rollback),
 and the package version numbers as is already the practice.
3. for cases where the package contents does not change between an
 ITB vs. production release the security team can just copy
 the tarball, .rpm, .deb files from one svn directory to the other
 and just update the appropriate metadata files (ca-certs-version, etc.)


I will update our security process instructions to reflect this change.
Thanks,
Doug
</verbatim>

This page documents the OSG Security Team process for creating new Certificate Authority packages for distribution to OSG sites. Note that you must follow the process through to the end to notify GOC of the new distribution.

<b>Updated 27,28 April 2010</b> to reflect building a CA package based on the new IGTF layout that makes symlinks from CA files to names including both the new and old hash name forms for openssl 1.0. %RED%<b>In Testing</b>%ENDCOLOR%

Please refer to the separate procedure on [[AddRemoveCA][adding or removing CAs]] before making a new [[ReleaseDocumentation.CADistribution][CA distribution]].

---++ Setup
   1 If this change is NOT critically needed, make the release on a TUESDAY. If it is Critical, go ahead with the release. Inform the GOC about the upcoming changes before you move onto the next step. 
   1 Get a user certificate+key in pkcs12 format from the DOEGrids CA. See ReleaseDocumentation.CertificateGet for instructions.
   1 Ask goc@opensciencegrid.org to add permissions for your certificate subject to access the https://osg-svn.rtinfo.indiana.edu/cadist svn repository. 
   1 Verify that rpmbuild is installed. The =rpmbuild= command is required for making the rpm, so it's best to use a !RedHat machine (any flavor) for this process.
   1 Verify that dpkg-deb, fakeroot, dpkg-scanpackages and debsigs  are in your $PATH:<br /><tt>which dpkg-deb fakeroot dpkg-scanpackages debsigs </tt>
      * If any of the tools are not installed on your system you may use build-debian-tools to download and install them <br/> =./build-debian-tools=
      * source the =setup.sh= file from the installed debian tools directory
   1 Install an =svn= client. Version 1.4.x is strongly recommended. Don't use a version 1.5.x client. See http://subversion.tigris.org/getting.html and/or http://www.collab.net/downloads/subversion/svn1.4.html.
   1 Verify that you have a version of openssl 1.x installed, to be used by mk-index.pl below.
   1 Configure =svn= to use your pkcs12 certificate+key for authentication by adding the following to =~/.subversion/servers= , changing the path to your pkcs12 file as appropriate:<br /> =[groups]= <br /> =iu = *.indiana.edu= <br /> =[iu]= <br /> =ssl-client-cert-file = /home/username/.globus/usercred.p12= 
   1 Checkout a copy of the https://osg-svn.rtinfo.indiana.edu/cadist svn repository:<br /> <tt>svn co https://osg-svn.rtinfo.indiana.edu/cadist</tt>
   1 Setup [[http://www.gnupg.org][GPG]] with the security@opensciencegrid.org private key (see [[Security.SecureEmailKeyManagement]]) for signing the distribution.
   1 Install [[http://vdt.cs.wisc.edu/components/fetch-crl.html][fetch-crl]].
   1 Define variable for OSG Security PGP key<br> =export OSGSECKEYID=7FD42669= <br><it>Note that you should verify the key id value with </it><br/><tt>gpg --list-keys</tt>
   1 Download, import, and verify the IGTF signing key (for example, by verifying the signature):<tt><br/>gpg --recv-key 3CDBBC71<br/>gpg --check-sigs 3CDBBC71<br/> gpg --default-key $OSGSECKEYID --lsign-key 3CDBBC71</tt>

---++ Updating to a new IGTF distribution
   1 Change to an empty working directory and set $CAWORKDIR to the path:<br/><tt>cd `mktemp -d`<br/>export CAWORKDIR=`pwd` </tt>
   1 Set $IGTF_CERTS_VERSION:<br/><tt>export IGTF_CERTS_VERSION=1.34</tt>
   1 Checkout or update the OSG svn directories<br/><tt>cd ~/svn/cadist/trunk/CA-Certificates-Base<br/>svn update<br/>export CABASEDIR=`pwd`</tt>
   1 Set the OSG version (Note that a version for the ITB should have an ITB following the release number).<br/><tt>export OUR_CERTS_VERSION=1.14ITB</tt>
   1 Create the new distribution directory for the release<br/><tt>cd $CABASEDIR<br/>mkdir $OUR_CERTS_VERSION<br/>mkdir $OUR_CERTS_VERSION/certificates<br/>export CADIST=$CABASEDIR/$OUR_CERTS_VERSION/certificates</tt>
   1 Download the new IGTF distribution tarball (and PGP signature) from http://dist.eugridpma.info/distribution/igtf/current/:<br>Note that to get the new symlink layout you may need to download http://dist.eugridpma.info/distribution/igtf/$IGTF_CERTS_VERION-new/:<br/><tt>cd $CAWORKDIR<br/>wget http://dist.eugridpma.info/distribution/igtf/current/igtf-policy-installation-bundle-$IGTF_CERTS_VERSION.tar.gz<br/>wget http://dist.eugridpma.info/distribution/igtf/current/igtf-policy-installation-bundle-$IGTF_CERTS_VERSION.tar.gz.asc</tt>
   1 Verify the PGP signature on the tarball:<br/><tt>gpg --verify igtf-policy-installation-bundle-$IGTF_CERTS_VERSION.tar.gz.asc</tt>
   1 Unpack the certificates:<br/><tt>tar xzf igtf-policy-installation-bundle-$IGTF_CERTS_VERSION.tar.gz</tt>
   1 Select the CAs and install to temporary location<br/><tt>cd igtf-policy-installation-bundle-$IGTF_CERTS_VERSION<br/>./configure --prefix=$CADIST --with-profile=classic --with-profile=mics --with-profile=slcs<br/>make install</tt>
   1 Install the non-IGTF CAs. Refer to the procedure on [[AddRemoveCA][adding or removing CAs]]<br/><tt>cd $CABASEDIR/non-igtf-certificates</tt><br/>for each CA to install, %BLUE% alias %ENDCOLOR% = alias name of the CA<br/><tt>./alias.install $CADIST $OUR_CERTS_VERSION [old]</tt><br/> *Note* that the 3rd argument (old) is required to install the old (non-symlinked) IGTF layout, without a 3rd argument you get the new layout, with symlinks.
   1 compare differences to previous version:<br/><tt>cd $CADIST<br/>for ca in * ; do  echo $ca; diff $ca $CABASEDIR/%RED%previous%ENDCOLOR%/certificates; done<br/>for ca in $CABASEDIR/%RED%previous%ENDCOLOR%/certificates/* ; do  echo $ca; diff $ca . ; done</tt>
      * make sure appropriate extra CA files from $CABASEDIR/non-igtf-certificates are included or removed from the distribution directory, $CADIST
   1 Generate the index files (requires openssl 1.x)<br/><tt>cd $CABASEDIR<br/>./mk-index.pl --version $OUR_CERTS_VERSION --dir $CADIST --out $CADIST/INDEX</tt>
   1 Verify that $CADIST/INDEX.html[.txt] contains the right number of CAs:<br/><tt>ls $CADIST/*.pem | wc  # should agree with the number of CAs listed in $CADIST/INDEX.html and $CADIST/INDEX.txt</tt>
   1 Make the MD5 checksums:<br/><tt>cd $CABASEDIR/$OUR_CERTS_VERSION<br/>( cd $CADIST; md5sum *.0 *.pem ) > cacerts_md5sum.txt<br/>cp cacerts_md5sum.txt $CADIST</tt>
   1 Update the $CADIST/CHANGES file. <br/><tt>cp $CABASEDIR/%RED%previous%ENDCOLOR%/certificates/CHANGES $CADIST</tt><br/>edit $CADIST/CHANGES and remove any temporary editer files like =#CHANGES#= or =CHANGES~=.
   1 Add new distribution to repository<br/><tt>cd $CADIST; chmod 644 *  # make sure permissions are OK<br/>remove any editing temp files<br/>cd $CABASEDIR<br/>svn add $OUR_CERTS_VERSION</tt><br/>Commit all changes:<br /><tt>svn commit -m "Updated to IGTF version $IGTF_CERTS_VERSION, OSG version $OUR_CERTS_VERSION"</tt>

---++ Check the CA certificates and CRLs

   1 Run fetch-crl and investigate any error messages:<br/><tt>pushd $CADIST<br/>$VDT_LOCATION/fetch-crl/sbin/fetch-crl --loc `pwd` --out `pwd`</tt>
   1 Check for expired or near-expired CRLs:<br/><tt>$CABASEDIR/[[%ATTACHURL%/check-crl-expiry.pl.txt][check-crl-expiry.pl]] *.r0</tt>
   1 Check for expired or near-expired CAs:<br/><tt>$CABASEDIR/[[%ATTACHURL%/check-ca-expiry.pl.txt][check-ca-expiry.pl]] *.pem</tt>
   1 Cleanup:<br/><tt>rm *.r0<br/>popd</tt>

---++ Make the CA tarball distribution
   1 Make sure the $CABASEDIR directory in your svn workspace is up-to-date and contains no local modifications:<br/><tt>cd $CABASEDIR<br/>svn status</tt> 
   1 Tag the SVN repository:<br/><tt>svn copy https://osg-svn.rtinfo.indiana.edu/cadist/trunk \<br /> https://osg-svn.rtinfo.indiana.edu/cadist/tags/osg-certificates-$OUR_CERTS_VERSION-igtf-$IGTF_CERTS_VERSION \<br /> -m "Tagging OSG certificates distribution $OUR_CERTS_VERSION containing IGTF version $IGTF_CERTS_VERSION" </tt>
   1 Create the tarball:<br/><tt>cd $CABASEDIR/$OUR_CERTS_VERSION<br/>tar cvfz osg-certificates-$OUR_CERTS_VERSION.tar.gz --exclude .svn certificates</tt> 
   1 Sign it with the security@opensciencegrid.org PGP key:<br/><tt>gpg --default-key $OSGSECKEYID -b osg-certificates-$OUR_CERTS_VERSION.tar.gz</tt> 
   1 Make the manifest:<br/><tt>../make-manifest  [--itb]</tt> <br/> Optionally specify --itb for a release to ITB that is intended to be copied to production.
   1 Visually inspect the manifest file (ca-certs-version).

---++ Make the RPM
   1 Verify that $OUR_CERTS_VERSION and $IGTF_CERTS_VERSION are set correctly:<br/><tt>echo $OUR_CERTS_VERSION $IGTF_CERTS_VERSION</tt>
   1 Verify that rpmbuild is in your $PATH:<br/><tt>which rpmbuild</tt>
   1 Make sure CWD is correct<br/><tt>cd $CABASEDIR/$OUR_CERTS_VERSION</tt>
   1 Run the make-rpm script:<br/><tt>../make-rpm</tt>

---++ Make the DEB
   1 Verify that $OUR_CERTS_VERSION and $IGTF_CERTS_VERSION are set correctly:<br/><tt>echo $OUR_CERTS_VERSION $IGTF_CERTS_VERSION</tt>
   1 Make sure CWD is correct<br/><tt>cd $CABASEDIR/$OUR_CERTS_VERSION</tt>
   1 Run the make-deb script:<br/><tt>../make-deb</tt>

---++ Save the distribution files in SVN

   1 Set the svn release directory
      * For production OSG: <tt>export SVNDIR=$CABASEDIR/../../release</tt>
      * For an ITB release:  <tt>export SVNDIR=$CABASEDIR/../../release-itb</tt>
   1 Copy the files to the svn release directory:<br/><tt>cd $CABASEDIR/$OUR_CERTS_VERSION<br/>cp osg-certificates-$OUR_CERTS_VERSION.tar.gz osg-certificates-$OUR_CERTS_VERSION.tar.gz.sig \<br/> osg-ca-certs-$OUR_CERTS_VERSION-0.noarch.rpm osg-ca-certs-$OUR_CERTS_VERSION-0.deb \<br/>ca-certs-version cacerts_md5sum.txt  $SVNDIR</tt>
   1 Change to the svn release directory:<br/><tt>cd  $SVNDIR</tt>
   1 Commit the files:<br/><tt>svn add osg-certificates-$OUR_CERTS_VERSION.tar.gz osg-certificates-$OUR_CERTS_VERSION.tar.gz.sig \<br/> osg-ca-certs-$OUR_CERTS_VERSION-0.noarch.rpm osg-ca-certs-$OUR_CERTS_VERSION-0.deb; <br/>svn commit -m "OSG certificates distribution $OUR_CERTS_VERSION"</tt>

---++ Update the web site

Update [[ReleaseDocumentation.CADistribution]] if there are any significant changes to the contents of the distribution (beyond regular IGTF distribution updates).

---++ Announce the new distribution
---+++ For a routine production OSG release
Notify the GOC that a new release is available, typically on a Monday since GOC will do the release
on a Tuesday for it's normal update schedule.
The GOC will publish and announce the release.
Send email according to the following template:
<pre>
To: goc@opensciencegrid.org
Cc: osg-security-team@opensciencegrid.org
Subject: Request for routine deployment of  NEW OSG CA DISTRIBUTION RELEASE n.x

Tarball Version: n.x
RPM Version: n.x-0
DEB Version n.x-0

This is a routine update of the CA package and should be deployed in the next scheduled update period.
</pre>
The email message must be signed by your DOEGrids certificate.

---+++ For a URGENT production OSG release
Notify the GOC that an URGENT release is available to be deployed immediately.
The GOC will publish and announce the release.
Send email according to the following template:
<pre>
To: goc@opensciencegrid.org
Cc: osg-security-team@opensciencegrid.org
Subject: Request for URGENT deployment of  NEW OSG CA DISTRIBUTION RELEASE n.x

Tarball Version: n.x
RPM Version: n.x-0
DEB Version n.x-0

This release is for an URGENT security issue and requires immediate deployment.
</pre>
The email message must be signed by your DOEGrids certificate.

---+++ For an ITB release
Notify the GOC that a new release is available.
The GOC will publish and announce the release - or perhaps you should just send a notice to osg-int
after being informed by GOC that it is published.
Send email according to the following template:
<pre>
To: goc@opensciencegrid.org
Cc: osg-security-team@opensciencegrid.org
Subject: Request to immediately deploy NEW OSG-ITB CA DISTRIBUTION RELEASE n.xITB

From https://osg-svn.rtinfo.indiana.edu/cadist/release-itb

Tarball Version: n.xITB
RPM Version: n.xITB-0
DEB Version: n.xITB-0
</pre>
The email message must be signed by your DOEGrids certificate.

---++ Minor Debian revision
For a revision that changes only the debian package but not the other files (like a change to the debian metadata)
one should cd to the releases directory , run the make-deb script with the next revision number (R), check the new file into
svn and inform the GOC to update the apt repository with the new file.
   1 <tt>cd $SVNDIR</tt>
   1 <tt>$CABASEDIR/make-deb --revision R</tt>
   1 <tt>svn add osg-ca-certs-$OUR_CERTS_VERSION-R.deb</tt>
   1 <tt>svn commit -m "revised debian revision for some reason" \<br/>            osg-ca-certs-$OUR_CERTS_VERSION-R.deb</tt>
   1 Send signed email to GOC explaining the update and specifying which file to update in the apt repository.

---++ Release and Build Notes
For releases earlier than those below see the CHANGES file in the distributions.

Viewing the links below requires login to the twiki.
   * [[CaRelOsg116][OSG 1.16, IGTF 1.37 current]]

---++ References
   * [[http://vdt.cs.wisc.edu/internal/igtf-updates.html][VDT Distribution Process]] 
   * [[http://svnbook.red-bean.com/en/1.4/][Subversion Manual]] and [[http://svnbook.red-bean.com/en/1.4/svn.ref.html][Subversion Reference]] 
   * [[https://osg-svn.rtinfo.indiana.edu/cadist/][OSG WebSVN -- CA distribution repo]] 
   * [[http://software.grid.iu.edu/pacman/cadist/][OSG CA Certificates Distribution hosted by the GOC]]
   * [[http://software.grid.iu.edu/][OSG GOC Yum and Apt Repositories]]
   * [[http://dist.eugridpma.info/distribution/igtf/current/][IGTF Distribution]] 
   * [[http://security.teragrid.org/TG-CAs.html][TeraGrid CAs]] 
   * [[http://www.tacar.org/][TERENA Academic CA Repository]]
   * [[http://goc.grid.sinica.edu.tw/gocwiki/Procedure_for_new_CA_release][EGEE Procedure]]

%META:FILEATTACHMENT{name="check-ca-expiry.pl.txt" attachment="check-ca-expiry.pl.txt" attr="" comment="a script to check for expired and expiring CA certificates" date="1249503840" path="check-ca-expiry.pl" size="419" stream="check-ca-expiry.pl" tmpFilename="/usr/tmp/CGItemp14259" user="JimBasney" version="1"}%
%META:FILEATTACHMENT{name="check-crl-expiry.pl.txt" attachment="check-crl-expiry.pl.txt" attr="" comment="a script to check for expired and expiring CRLs" date="1249503914" path="check-crl-expiry.pl" size="771" stream="check-crl-expiry.pl" tmpFilename="/usr/tmp/CGItemp14332" user="JimBasney" version="1"}%
