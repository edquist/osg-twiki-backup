%META:TOPICINFO{author="JimBasney" date="1244043927" format="1.1" reprev="1.14" version="1.14"}%
%META:TOPICPARENT{name="SecurityTeamWorkingArea"}%
%TOC%
---+ Creating CA Distributions
This page documents the OSG Security Team process for creating new Certificate Authority packages for distribution to OSG sites. Note that you must follow the process through to the end to notify GOC of the new distribution.

---++ Setup
   1 Get a user certificate+key in pkcs12 format from the DOEGrids CA or another trusted CA. 
   1 Ask goc@opensciencegrid.org to add permissions for your certificate subject to access the https://osg-svn.rtinfo.indiana.edu/cadist svn repository. 
   1 Verify that rpmbuild is installed. The rpmbuild command is required for making the rpm, so it's best to use a !RedHat machine for this process.
   1 Install an svn client. Version 1.4.x is strongly recommended. Don't use a version 1.5.x client. See http://subversion.tigris.org/getting.html and/or http://www.collab.net/downloads/subversion/svn1.4.html.
   1 Configure svn to use your pkcs12 certificate+key for authentication by adding the following to ~/.subversion/servers, changing the path to your pkcs12 file as appropriate:<br />[groups]<br />iu = *.indiana.edu<br />[iu]<br />ssl-client-cert-file = /home/username/.globus/usercred.p12 
   1 Checkout a copy of the https://osg-svn.rtinfo.indiana.edu/cadist svn repository:<br />$ svn co https://osg-svn.rtinfo.indiana.edu/cadist 
   1 Setup [[http://www.gnupg.org][GPG]] with the security@opensciencegrid.org private key (see [[Security.SecureEmailKeyManagement]]) for signing the distribution.
   1 Download, import, and verify the IGTF signing key (for example, by verifying the signature):<br/>$ gpg --recv-key 3CDBBC71<br/>$ gpg --check-sigs 3CDBBC71<br/>$ gpg --default-key $OSGSECKEYID --lsign-key 3CDBBC71

---++ Updating to a new IGTF distribution
   1 Change to an empty working directory and set $CAWORKDIR to the path:<br />$ mkdir /tmp/osg-certs-20080903<br />$ cd /tmp/osg-certs-20080903<br />$ export CAWORKDIR=`pwd` 
   1 Set $IGTF_CERTS_VERSION:<br />$ export IGTF_CERTS_VERSION=1.24
   1 Download the new IGTF distribution tarball (and PGP signature) from http://www.eugridpma.org/distribution/igtf/current/:<br />$ wget http://dist.eugridpma.info/distribution/igtf/current/igtf-policy-installation-bundle-$IGTF_CERTS_VERSION.tar.gz<br/>$ wget http://dist.eugridpma.info/distribution/igtf/current/igtf-policy-installation-bundle-$IGTF_CERTS_VERSION.tar.gz.asc
   1 Verify the PGP signature on the tarball:<br/>$ gpg --verify igtf-policy-installation-bundle-$IGTF_CERTS_VERSION.tar.gz.asc
   1 Unpack the certificates:<br />$ tar xzf igtf-policy-installation-bundle-$IGTF_CERTS_VERSION.tar.gz 
   1 Make an installation directory:<br />$ mkdir made-igtf-$IGTF_CERTS_VERSION 
   1 Configure the installation. We want all of the accredited CAs plus the Fermilab KCA certificate:<br />$ cd igtf-policy-installation-bundle-$IGTF_CERTS_VERSION<br />$ ./configure --prefix=../made-igtf-$IGTF_CERTS_VERSION --with-profile=classic --with-profile=slcs --with-profile=mics --with-authority=FNAL_KCA 
   1 Install the certificates into your temporary directory:<br />$ make install 
   1 Go to a checkout of the https://osg-svn.rtinfo.indiana.edu/cadist svn repository and make sure it's up-to-date:<br />$ cd ~/svn/osg/cadist/trunk/CA-Certificates-Base<br />$ svn update 
   1 Run the process-igtf-distribution.pl script:<br />$ ./process-igtf-distribution.pl $CAWORKDIR/made-igtf-$IGTF_CERTS_VERSION ./certificates > igtf-$IGTF_CERTS_VERSION-update.log 
   1 Review igtf-$IGTF_CERTS_VERSION-update.log, igtf-$IGTF_CERTS_VERSION-update-diffs.log, and igtf-$IGTF_CERTS_VERSION-update-script.sh. Be sure to understand the differences, even though most of them are CVS related or are simple version string changes. Be particularly careful about hashes in the output that have &ldquo;files not in IGTF&rdquo; next to them--they will be deleted! Re-run the process-igtf-distribution.pl script as needed. 
   1 Run the update script:<br />$ ./igtf-$IGTF_CERTS_VERSION-update-script.sh
   1 Take the executable bit off the IGTF files:<br/>$ svn propdel svn:executable certificates/*
   1 Verify changes:<br />$ svn diff > /tmp/diffs 
   1 Update the certificates/INDEX.txt file. Don't miss the version number at the bottom of the page. 
   1 Verify that certificates/INDEX.txt contains the right number of CAs:<br/>$ grep http certificates/INDEX.txt | egrep -v 'www.igtf.net|security.teragrid.org'| wc -l<br/>$ ls certificates/*.0 | wc -l
   1 Update the certificates/CHANGES file. 
   1 Commit all changes:<br />$ svn commit -m "Updated to IGTF version $IGTF_CERTS_VERSION"

---++ Other updates

If any other changes are required:
   1 Manually apply the changes to the certificates subdirectory. 
   1 Update the INDEX.txt file as needed. 
   1 Update the CHANGES file. 
   1 Commit your changes:<br /> $ svn commit 

---++ Check the CA certificates and CRLs

   1 Run fetch-crl and investigate any error messages:<br/>$ cd certificates<br/>$ $VDT_LOCATION/fetch-crl/sbin/fetch-crl --loc `pwd` --out `pwd`
   1 Check for expired or near-expired CRLs:<br/>$ ../check-crl-expiry.pl *.r0
   1 Check for expired or near-expired CAs:<br/>$ ../check-ca-expiry.pl *.0
   1 Cleanup:<br/>$ rm *.r0<br/>$ cd ..

---++ Make the CA tarball
   1 Make sure the certificate subdirectory in your svn workspace is up-to-date and contains no local modifications:<br />$ svn status certificates 
   1 Determine the version of the certificates distribution:<br />$ export OUR_CERTS_VERSION=1.0 
   1 Tag the SVN repository:<br />$ svn copy https://osg-svn.rtinfo.indiana.edu/cadist/trunk \<br /> https://osg-svn.rtinfo.indiana.edu/cadist/tags/osg-certificates-$OUR_CERTS_VERSION-igtf-$IGTF_CERTS_VERSION \<br /> -m "Tagging OSG certificates distribution $OUR_CERTS_VERSION containing IGTF version $IGTF_CERTS_VERSION" 
   1 Create the tarball:<br />$ tar cvfz osg-certificates-$OUR_CERTS_VERSION.tar.gz --exclude .svn certificates 
   1 Sign it with the security@opensciencegrid.org PGP key:<br />$ gpg --default-key $OSGSECKEYID -b osg-certificates-$OUR_CERTS_VERSION.tar.gz 
---++ Make the manifest
   1 Verify that $OUR_CERTS_VERSION and $IGTF_CERTS_VERSION are set correctly:<br />$ echo $OUR_CERTS_VERSION $IGTF_CERTS_VERSION 
   1 Run the make-manifest script:<br />$ ./make-manifest 

---++ Make the RPM
   1 Verify that $OUR_CERTS_VERSION and $IGTF_CERTS_VERSION are set correctly:<br />$ echo $OUR_CERTS_VERSION $IGTF_CERTS_VERSION
   1 Verify that rpmbuild is in your $PATH:<br />$ which rpmbuild
   1 Run the make-rpm script:<br />$ ./make-rpm

---++ Save the distribution files in SVN
   1 Copy the files to the svn release directory:<br/>$ cp osg-certificates-$OUR_CERTS_VERSION.tar.gz osg-certificates-$OUR_CERTS_VERSION.tar.gz.sig \<br/> osg-ca-certs-$OUR_CERTS_VERSION-0.noarch.rpm ca-certs-version cert_md5sum ../../release
   1 Change to the svn release directory:<br/>$ cd ../../release
   1 Commit the files:<br>$ svn add osg-certificates-$OUR_CERTS_VERSION.tar.gz osg-certificates-$OUR_CERTS_VERSION.tar.gz.sig \<br/> osg-ca-certs-$OUR_CERTS_VERSION-0.noarch.rpm; svn commit -m "OSG certificates distribution $OUR_CERTS_VERSION"

---++ Update the web site

Update [[CADistribution]] if there are any significant changes to the contents of the distribution (beyond regular IGTF distribution updates).

---++ Announce the new distribution

Notify goc@opensciencegrid.org that a new release is available from 
https://osg-svn.rtinfo.indiana.edu/cadist/release/.

---++ References
   * [[http://vdt.cs.wisc.edu/internal/igtf-updates.html][VDT Distribution Process]] 
   * [[http://svnbook.red-bean.com/en/1.4/][Subversion Manual]] and [[http://svnbook.red-bean.com/en/1.4/svn.ref.html][Subversion Reference]] 
   * [[https://osg-svn.rtinfo.indiana.edu/cadist/][OSG WebSVN -- CA distribution repo]] 
   * [[http://software.grid.iu.edu/pacman/cadist/][OSG CA Certificates Distribution hosted by the GOC]]
   * [[http://yum.grid.iu.edu/][OSG GOC Yum Repository]]
   * [[http://dist.eugridpma.info/distribution/igtf/current/][IGTF Distribution]] 
   * [[http://security.teragrid.org/TG-CAs.html][TeraGrid CAs]] 
   * [[http://www.tacar.org/][TERENA Academic CA Repository]]
   * [[http://goc.grid.sinica.edu.tw/gocwiki/Procedure_for_new_CA_release][EGEE Procedure]]
