%META:TOPICINFO{author="AashishSharma" date="1228420990" format="1.1" reprev="1.2" version="1.2"}%
%META:TOPICPARENT{name="IncidentInformation2008"}%
%TOC%
---+ OSG-SEC-2008-MM-DD

OSG was notifed on November 30th, 2008 by fellow grid sites about increased activity in account compromise, root compromise and installation of backdoor on the systems.  

---++ Status

<!--
Suggested status labels:
NEW: Initial report is received but incident is not confirmed.  This is a triage phase.
OPEN: The existence of a security incident requiring response has been confirmed. The response is underway.
RESOLVED: The incident has been resolved but the final report has not been submitted.
CLOSED: The final report has been submitted.
--> 

   * *Status*: (RESOLVED) 
   * *Lead*: Aashish Sharma
   * *Responders*: Mine , Jim Basney, 
   * *References*: _No ticket was created for the incident_

This incident notification user account Carleton E. Detar's account was compromised in Teragrid. This user also has credentials and certificates issued by Fermi Lab account:                                 
                                                                                                              
"/DC=gov/DC=fnal/O=Fermilab/OU=People/CN=Carleton E. Detar/CN=UID:detar"    

---++ Analysis

   * *Severity*: Medium (impact on user account, grid stability not at risk) 
   * *Urgency*: High:  (Since this was on going incident it was necessary to determine that users account was not compromised in OSG realm)

---++ Mitigation Plan

We had to make sure if user Carleton E. Detar had Fermi Lab certificate stored in his compromised account on Teragrid. Also, determine if the user has used his certificate in previous 7 days. 

The user has two certificates : DOEgrids and FNAL issued KCA cert.                                            
The DOEGrids cert was already expired in october.

---+++ Actions to take

Needed to make sure FNAL issued KCA and users Fermi lab issued kerberos credentials are not compromised or stored in Teragrid compromised account home directories. 

---+++ How to monitor progress

Responders should report their actions back to the incident lead. 

---+++ Acceptable response time estimate

Since this was a compromise account, we need to clarify the user activity as soon as possible. 

---+++ List of affected parties

Carleton E. Detar, OSG, Fermi Lab, Teragrid

---+++ Definition of End Of Event

Making certain that users credentials are not compromised in Fermi Lab or outside TG. 

Confirmation from Fermi lab: The FNAL issued KCA cert was NOT in TG account. 

<pre>
Date: Tue, 02 Dec 2008 17:03:46 -0600                                                                         
From: Keith Chadwick <chadwick@fnal.gov>                                                                      
Subject: Re: [SECTY-DISCUSS-OSG_LIMITED_DISTR] TG incident may affect OSG-                                    
 small  chance                                                                                                
In-reply-to: <4935BB40.2060909@fnal.gov>                                                                      
To: Mine Altunay <maltunay@fnal.gov>,                                                                         
        SECURITY-DISCUSS-L@OPENSCIENCEGRID.ORG 

At 4:48 PM -0600 12/2/08, Mine Altunay wrote:
>TG informed us that they discovered a security compromise late last
>night. User Carleton Detar's account at TG is compromised.
>
>The user has two certificates : DOEgrids and FNAL issued KCA cert.
>The DOEGrids cert was already expired in october.
>
>The FNAL issued KCA cert was NOT in TG account. However, there is a
>small  chance if the attacker could access this user's Fermilab account
>from compromised TG account. This is a small likelihood because Fermilab
>uses kerberos authentication and attacker could not gain Fermilab
>password for getting a Kerberos ticket.
>
>Nevertheless , I informed FNAL security team to check if there is a
>problem with this user's FNAL account.
>
>The user is a member of fermilab VO. any of the OSG sites who maps
>Fermilab VO users would allow access to this users FNAL kca cert. His
KCA cert is registered with Fermilab VO.
>
>I will wait until fermilab confirms the user's Kerberos password is
>compromised I am hoping to hear by tonight. In that case we will make an
>announcement to OSG sites to block access and ask fermilab VO to remove
>this user from their VOMS server.

The method to do this is to get the Fermilab CST to "revoke" his
Kerberos account - set it to disallow all tickets and disable the
account in the KDC.

That will automatically remove the affected user from the VO.

No additional action is necessary or required on the part of the
fermilab VO administrators.

-Keith.

>____________________________________
>Here is some additional information about user cdetar [ Carleton E. Detar ]:
>
>The machines we see cdetar logging in to NCSA from fnal are:
>
>- 131.225.202.12  cdetar    lqcd.fnal.gov
>- 131.225.202.1   cdetar    kaon1.fnal.gov
>
>Compromised login from account cdetar was using password based
>authentication. However, looking back at the spread of smiliar incidents
>we would consider all ssh-auth keys  for this user to be compromised as
>well.
>
>We do not have any evidence that users certificate has been compromised.
>We don't see it being used.
>
>Here is the recommendation:
>
>1) user cdetar should change all his passwords and keys - also its
>recommended that user put passphrase on the keys
>2) Flows for both fnal machines should be checked for connections to and
>from: 209.181.189.198 and  209.160.40.14
>3) cdetar should also try to account for all the logins on his systems
>and see if there is any IP address / timestamp which he cannot account for.
>
>
>--
>Mine Altunay, PhD
>Fermi National Laboratory
>Pine and Kirk Roads, Batavia, IL
>Offices: FCC 364 and W8E
>Phone: 630-840-6490
>Cell: 630-200-4687
>
>
>Content-Type: application/x-pkcs7-signature; name="smime.p7s"
>Content-Disposition: attachment; filename="smime.p7s"
>Content-Description: S/MIME Cryptographic Signature
>
</pre>

<pre>

Date: Tue, 02 Dec 2008 17:07:32 -0600                                                                         
From: Keith Chadwick <chadwick@fnal.gov>                                                                      
Subject: Re: [SECTY-DISCUSS-OSG_LIMITED_DISTR] TG incident may affect OSG-                                    
 small  chance                                                                                                
In-reply-to: <p0624080fc55b6e7d35c4@[131.225.82.8]>                                                           
To: Keith Chadwick <chadwick@fnal.gov>,                                                                       
        SECURITY-DISCUSS-L@OPENSCIENCEGRID.ORG     
                                                                                                             
I have reviewed the last ~31 days of the voms service logs on voms.fnal.gov,                                  
and find no evidence of the suspect DNs obtaining voms-proxy-init                                             
proxy credentials for any of the VOs that are supported on this VOMS                                          
server.                                                                                                       
                                                                                                              
-Keith.                                                      
</pre>

---++ Incident Log

---++ Summary

   * *Final Report*: [[https://osg-docdb.opensciencegrid.org:440/][OSG !DocDB Document ###]]

_What was the resolution of the incident?_

<pre>

Because this user has no KCA certificate issued, there is no risk                                             
involving OSG.                                                                                                
                                                                                                              
>From OSG perspective I am ready to close this incident.                                                      
                                                                                                              
Once TG incident response team approves, I like to send a precautionary                                       
announcement to OSG sites concerning malicious IP addresses. There is no                                      
need to mention this user's name or OSG KCA cert as there is no OSG                                           
incident. I rather like our sites to watch for ongoing attacks from                                           
malicious IPs.                                                                                                
                                                                                                              
Aashish Sharma from TG incident response team will prepare a message and                                      
we can broadcast it to our security contacts in OSG once we approve it.                                       
                                                                                                              
Thank you all                                                                                                 
(if you are confused Aashish is also a member of OSG incident response                                        
team too. )                                                                                                   
                                                                                                              
--                                                                                                            
Mine Altunay, PhD                                                                                             
Fermi National Laboratory                                                                                     
Pine and Kirk Roads, Batavia, IL                                                                              
Offices: FCC 364 and W8E                                                                                      
Phone: 630-840-6490                                                                                           
Cell: 630-200-4687          

<pre>


</pre>

What is the long-term mitigation plan (including changes in our operations, middleware or anything else that enabled the event) and timeline?

Monitor for the IP address and user account activity and look for anamolies. 

<pre>

Email Announcement from DFN-CERT

** PLEASE DO NOT REDISTRIBUTE **  CERNCERT-20080805                                                           
                                                                                                              
** This message is sent to the CSIRTs of affected grid infrastructures and                                    
sites and must NOT be publicly archived **                                                                    
                                                                                                              
Dear CSIRTs,                                                                                                  
                                                                                                              
The information below was kindly provided by the DFN CERT (NREN in                                            
Germany), the SWITCH CERT (NREN in Switzerland), the EGEE Operational                                         
Security Coordination Team, the OSG security team, CfA Harvard, ISI                                           
University of South California, CERN security team and several CSIRTs                                         
from various sites.                                                                                           
                                                                                                              
*******************************************************                                                       
* What's new since the last update                            *                                               
*******************************************************                                                       
                                                                                                              
- Further attacks discovered                                                                                  
- New suspicious IP addresses                                                                                 
- Updated rootkit                                                                                             
- Updated tools                                                                                               
                                                                                                              
******************************                                                                                
* Further attacks discovered *                                                                                
******************************                                                                                
                                                                                                              
* ETH (Switzerland) affected (September)                                                                      
                                                                                                              
Several accounts have been compromised at ETH, and connections from a                                         
known malicious IP addresses have been detected between 2008-08-31                                            
23:49:54 - 2008-09-15 13:04:57 (UTC+2).                                                                       
                                                                                                              
* Another peer grid site attacked              
A partner grid site is reporting malicious connections on 2008/11/30 from:                                    
                                                                                                              
209.160.40.14   - m81.nearbygalaxies.org                                                                      
209.181.189.198 - ASN-QWEST - Qwest Communications Corporation                                                
                                                                                                              
* Malicious connections against NCSA                                                                          
                                                                                                              
NCSA reported successful connections from the IP addresses above.                                             
Investigations revealed a root compromised host running a new version (2.2c) of                               
the rootkit, which had been installed on 21st September.                                                      
                                                                                                              
* Malicious connections against CERN                                                                          
                                                                                                              
Based also on the information above, CERN has noticed malicious connections                                   
from a known malicious IP address on 2008-12-02 to one CERN account.                                          
However there is no evidence the attacker gained root access on the targeted                                  
host at CERN.                                                                                                 
                                                                                                              
************************************************                                                              
* New suspicious IP addresses as of 2008-12-04 *                                                              
************************************************                                                              
                                                                                                              
It is believed the attacker logged in from:                                                                   
                                                                                                              
- 64.72.120.48                                                                                                
- 137.248.152.49  [ pc15854.Chemie.Uni-Marburg.DE ]                                                           
- 132.239.95.85    [ npc.ucsd.edu ]                                                                           
- 69.49.172.31                                                                                                
- 207.224.103.198                                                                                             
- 69.129.17.24                                                                                                
- 209.160.40.14                                                                                               
- 209.181.189.198                                                                                             
- 189.6.137.174                                                                                               
- 190.81.35.90                                                                                                
- 202.51.211.2                                                                                                
- 131.142.42.17 (?)                                                                                           
                                                                                                              
The known list of suspicious IP addresses is now:                                                             
                                                                                                              
- 83.134.152.127                                                                                              
- 69.130.104.157                                                                                              
- 69.130.136.116                                                                                              
- 69.130.130.117                                                                                              
- 69.130.104.49                                                                                               
- 69.130.104.157 - h69-130-104-157.lkvlms.dsl.dynamic.tds.net                                                 
- 69.130.182.213 - h69-130-182-213.cytnin.dsl.dynamic.tds.net                                                 
- 69.130.80.36   - h69-130-80-36.kgldga.dsl.dynamic.tds.net                                                   
- 64.27.17.70    - vpn2.pcwerk.com                                                                            
- 208.35.255.106                                                   
- 208.35.255.106                                                                                              
- 66.230.230.230                                                                                              
- 209.181.122.222                                                                                             
- 207.225.248.150                                                                                             
- 207.206.202.54                                                                                              
- 207.206.215.122                                                                                             
- 207.224.215.94                                                                                              
- 209.181.138.229                                                                                             
- 209.181.131.209                                                                                             
- 209.181.242.70                                                                                              
- 208.42.23.94   - v-208-42-23-94.mn.visi.com                                                                 
- 99.236.185.205                                                                                              
- 99.237.220.123                                                                                              
- 208.42.23.94                                                                                                
- 216.184.13.238                                                                                              
- 216.186.49.132                                                                                              
- 75.60.89.233                                                                                                
- 136.159.55.31                                                                                               
                                                                                                              
Note that there are now several IP addresses in the 69.130 network                                            
block. Any connection from this location should be treated as suspicious                                      
and reported.                                                                                                 
                                                                                                              
* Update rootkit *                                                                                            
                                                                                                              
It is believed the attacker is now using a new version "2.2c" of the Phalanx2                                 
rootkit.                                                                                                      
It hides in different locations (ex: /usr/lib/heahu.p2/, /usr/lib/huuuh.p2,                                   
etc.).                                                                                                        
                                                                                                              
While the attacker has mostly been concentrated on SSH keys, it seems now that                                
standard passwords are being sniffed and reused.                                                              
                                                                                                              
At least the 64bit version of the 2.2c backdoor does not support                                              
some characters and should segfault using this command:                                                       
                                                                                                              
(echo SSH-2.0-OpenSSH_3.8.1p1; sleep 1; echo 'pHALANX2!                                                       
'kill_phalanx2'+++++++++++++++'| cut -c 1-31; sleep 1; echo                                                   
'test'; cat)|nc <POSSIBLY_INFECTED_HOSTNAME> 22                                                               
                                                                                                              
(<POSSIBLY_INFECTED_HOSTNAME> is the hostname that is checked for signs of the                                
rootkit)                                                                                                      
                                                                                                              
The resulting syslog message on <POSSIBLY_INFECTED_HOSTNAME> would look like:                                 
<DATE> <POSSIBLY_INFECTED_HOSTNAME> kernel: <malicious_kernel_thread>: segfault                               
at                                                                                                            
0000000000000000 rip 0000000000418900 rsp 0000007fbfff8698 error 4                                            
                                                                                                              
Once the host has been probed, the existence of such a syslog message is a very                               
strong indication it has been infected by the rootkit.                          
                                                                                                              
*************************************************                                                             
* Suspicious SSH key and rootkit detecting tool *                                                             
*************************************************                                                             
                                                                                                              
It is possible to use suspicious SSH keys and rootkit detecting tool                                          
provided by the community. The tools on the page below are kindly                                             
provided by their authors and do not come with any guarantee whatsoever,                                      
use it at your own risk!                                                                                      
                                                                                                              
https://cern.ch/osct/7e0564aeabe51c2b1c69570c8d931bf2                                                         
                                                                                                              
Please report any suspicious activity to enable other sites to search                                         
for the patterns you may have detected. This is essential to prevent the                                      
attack from spreading further in the community.                                                               
                                                                                                              
Regards,                                                                                                      
                                                                                                              
Romain Wartel on behalf of the EGEE Operational Security Coordination Team.                                   
--                                                                                                            
Romain Wartel                           Romain.Wartel@cern.ch                                                 
EGEE Operational Security Coordination Team                                                                   
C.E.R.N. http://www.cern.ch/LCG                                                                               
Information Technology Division http://www.eu-egee.org/security                                               
Bat.28-1-012 http://cern.ch/security                                                                          
CH-1211 Geneva 23, Switzerland   

</pre> 

---++ Access Control

_Uncomment the appropriate access control policy for this incident page. Logout of the twiki and try to access the page to ensure it is not publicly accessible. Do not attach files, as they will not be protected (see  [[http://twiki.org/cgi-bin/view/TWiki/TWikiAccessControl#Controlling_access_to_Attachment][http://twiki.org/cgi-bin/view/TWiki/TWikiAccessControl#Controlling_access_to_Attachment]])._

Incident information accessible by Security Team members and GOC only:
   * #Set ALLOWTOPICVIEW = Main.SecurityTeamGroup, Main.GocGroup
   * #Set ALLOWTOPICCHANGE = Main.SecurityTeamGroup, Main.GocGroup

Incident information accessible by all authenticated twiki users:
   * Set ALLOWTOPICVIEW = Main.GridGroup
   * Set ALLOWTOPICCHANGE = Main.GridGroup
