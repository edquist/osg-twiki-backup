%META:TOPICINFO{author="AnandPadmanabhan" date="1313596379" format="1.1" reprev="1.10" version="1.10"}%
---++Installation of new CA distribution format on Production
%TOC%

The proposed change in the CA package due to the new layout from IGTF to accommodate openssl 1.0 is slated to go into production on OSG with the next IGTF release. The changes have already been identified in [[https://twiki.grid.iu.edu/bin/view/SoftwareTeam/SEP7][SEP7]] and implemented. However since this change affects our security infrastructure significantly the security team will like to have the changes tested on few older versions of production sites before we roll out a production deployment. For this purposes the chosen test sites will be asked to install the CA package from the new production CA cache. Below you will find instructions for how to accomplish this change, how to rollback in case of errors or after the testing is complete and a short survey of the testing.

---+++ Installing the CA package
---++++Pointing to the New cache
%RED%NOTE: if you install the CA using native package please do not continue and let the OSG security team know%ENDCOLOR%

---+++++ Using vdt-ca-manage
Check if you have vdt-ca-manage installed. If not go to the manual update section.
<pre class="rootscreen">
%UCL_PROMPT_ROOT% source $VDT_LOCATION/setup.sh
%UCL_PROMPT_ROOT% which vdt-ca-manage
/opt/osg-1.2.18/vdt/bin/vdt-ca-manage
</pre>

<pre class="rootscreen">
%UCL_PROMPT_ROOT% source $VDT_LOCATION/setup.sh
%UCL_PROMPT_ROOT% vdt-ca-manage setupca --location %RED%local%ENDCOLOR%  --url osg-new
  Setting up CA Certificates for VDT installation at '/opt/osg-1.2.18'
  CA Certificates will be installed into /opt/osg-1.2.18/globus/share/certificates

  Setup completed successfully.
</pre>
*NOTE*: Please use appropriate parameter for --location for your installation. Available options: --location <local|root|PATH>. 

*NOTE*: For a detailed explanation of options see [[ReleaseDocumentation.ComputeElementInstall#Install_a_Certificate_Authority][Install guide]]

*NOTE*: If the vdt-ca-manage command complains about not knowing the osg-new cache please use 
<pre class="rootscreen">
%UCL_PROMPT_ROOT% vdt-ca-manage setupca --location %RED%local%ENDCOLOR%  --url http://software.grid.iu.edu/pacman/cadist/ca-certs-version-new
  Setting up CA Certificates for VDT installation at '/opt/osg-1.2.18'
  CA Certificates will be installed into /opt/osg-1.2.18/globus/share/certificates

  Setup completed successfully.
</pre>

---+++++ Manual Update
%RED%NOTE: Use vdt-ca-manage command for updates when possible. Only do a manual update if your installation does not have vdt-ca-manage installed%ENDCOLOR%

Check if you have vdt-update-certs installed. If it is not installed, *STOP!!! DO NOT MAKE ANY CHANGES* and contact the OSG security team immediately. 
<pre class="rootscreen">
%UCL_PROMPT_ROOT% source $VDT_LOCATION/setup.sh
%UCL_PROMPT_ROOT% which vdt-update-certs
/opt/osg-1.2.18/vdt/sbin/vdt-update-certs
</pre>

   * As superuser edit $VDT_LOCATION/vdt/etc/vdt-update-certs.conf, and change the cacerts_url parameter to:
   <pre class="file">
      cacerts_url = http://software.grid.iu.edu/pacman/cadist/ca-certs-version-new
   </pre>
   * Save the new configuration file and the new Fetch CA and CRLs using instruction in the next section

---++++ Fetch CAs and CRLs
---+++++ Using vdt-ca-manage
Note that fetching CRLs may take a few minutes.
<pre class="rootscreen">
%UCL_PROMPT_ROOT% vdt-ca-manage refreshCA
  Fetching CAs....
  vdt-update-certs
  Log file: /opt/osg-1.2.18/logs/vdt-update-certs.log
  Updates from: http://software.grid.iu.edu/pacman/cadist/ca-certs-version-new

  Nothing to update: your CA certificate installation is already up-to-date.

%UCL_PROMPT_ROOT% vdt-ca-manage fetchCRL
  Fetching CRLs....

  ...done
</pre>
---+++++ Manual Update
%RED%NOTE: Only do a manual update method if your installation does not have vdt-ca-manage installed%ENDCOLOR%
   * Download new CA packages
<pre class="rootscreen">
%UCL_PROMPT_ROOT% $VDT_LOCATION/vdt/sbin/vdt-update-certs-wrapper
</pre>
*TIP*: On an existing install `crontab -l | grep vdt-update-certs-wrapper` as root will give you the command that is run via cron on your system and you can just copy paste it for the step above.
   * Update CRLs
<pre class="rootscreen">
%UCL_PROMPT_ROOT% $VDT_LOCATION/fetch-crl/share/doc/fetch-crl-2.6.6/fetch-crl.cron
</pre>
*TIP*: On an existing install `crontab -l | grep fetch-crl.cron` as root will give you the command that is run via cron on your system and you can just copy paste it for the step above.

---++++ Checking if the location has been updated using
The number of CRLs you have might be different than shown here if some CRL servers cannot be reached immediately.  This is not a problem.
<pre class="rootscreen">
%UCL_PROMPT_ROOT% vdt-ca-manage showcaurl
  http://software.grid.iu.edu/pacman/cadist/ca-certs-version-new
%UCL_PROMPT_ROOT% vdt-version  | grep CA
  CA Certificates 1.21NEW (includes IGTF 1.40 CAs)
%UCL_PROMPT_ROOT% ls -la $VDT_LOCATION/globus/share/certificates/*.pem | wc
     94     846    7334
%UCL_PROMPT_ROOT% ls -la $VDT_LOCATION/globus/share/certificates/*.r0 | wc
     94     846    7334
</pre>

---++++ Restarting services
Some of the services need to be restarted to make use of the new CA certificates. 
---+++++ CE
Restart globus-ws, apache, tomcat, osg-rsv, condor-cron
<pre class="rootscreen">
%UCL_PROMPT_ROOT% vdt-control --off  globus-ws apache tomcat-55 osg-rsv condor-cron
disabling init service osg-rsv... ok
disabling init service apache... ok
disabling init service tomcat-55... ok
disabling init service globus-ws... ok
disabling init service condor-cron... ok
%UCL_PROMPT_ROOT% vdt-control --on  globus-ws apache tomcat-55 osg-rsv condor-cron
enabling init service osg-rsv... ok
enabling init service apache... ok
enabling init service tomcat-55... ok
enabling init service globus-ws... ok
enabling init service condor-cron... ok
</pre>
---+++++GUMS
---+++++VOMS

---++++Verify the operations of compute element 
   1. Use the script =$VDT_LOCATION/verify/site_verify.pl= to see if any problems are being reported and if they are related to the new CA certificates
   2. Execute [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/CESimpleTest][simple CE tests]]
   3. If no problem was noticed leave the new CA package up for atleast 24 hours and report any failures due to CA certificates
   4. Observe RSV probe output and report any failures of RSV probes due to CA certificates.

---+++ WN Client installation
Options for CA installations on worker nodes can be installed [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/WorkerNodeClient#CA_Certificates_Installation_on][here]]. 
Use the same basic procedure above to update the CA packages at appropriate worker nodes based on your installation. 

---+++ Affects on the jobs on your system
If the update runs smoothly, ideally the OSG software in your system will have no issues with this new CA format and the user will not notice any difference. However, if the new CA format causes one or more OSG software to break your users might see some problems. If the authentication system were to break no new jobs may be able to submitted to your site and existing jobs would likely continue to run as long as they don't use their proxy for some tasks.

-- Main.AnandPadmanabhan - 17 Mar 2011
