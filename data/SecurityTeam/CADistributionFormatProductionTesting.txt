%META:TOPICINFO{author="AnandPadmanabhan" date="1300829632" format="1.1" version="1.5"}%
---++Testing of new CA distribution format on Production
%TOC%

The proposed change in the CA package due to the new layout from IGTF to accommodate openssl 1.0 is slated to go into production on OSG with the next IGTF release. The changes have already been identified in [[https://twiki.grid.iu.edu/bin/view/SoftwareTeam/SEP7][SEP7]] and implemented. However since this change affects our security infrastructure significantly the security team will like to have the changes tested on few older versions of Production sites before we roll out a production deployment. For this purposes the chosen test sites will be asked to temporarily install the CA package from the ITB CA cache. Below you will find instructions for how to accomplish this change, how to rollback in case of errors or after the testing is complete and a short survey of the testing.

---+++ Installing the CA package
---++++Pointing to the ITB cache
%RED%NOTE: if you install the CA using native package please do not continue and let the OSG security team know%ENDCOLOR%

---+++++ Using vdt-ca-manage
Check if you have vdt-ca-manage installed. If not go to the manual update section.
<pre class="rootscreen">
%UCL_PROMPT_ROOT% source $VDT_LOCATION/setup.sh
%UCL_PROMPT_ROOT% which vdt-ca-manage
/opt/osg-1.2.18/vdt/bin/vdt-ca-manage
</pre>

<pre class="rootscreen">
%UCL_PROMPT_ROOT% source $VDT_LOCATION/setup.sh
%UCL_PROMPT_ROOT% vdt-ca-manage setupca --location %RED%local%ENDCOLOR%  --url itb
  Setting up CA Certificates for VDT installation at '/opt/osg-1.2.18'
  CA Certificates will be installed into /opt/osg-1.2.18/globus/share/certificates

  Setup completed successfully.
</pre>
*NOTE*: Please use appropriate parameter for --location for your installation. Available options: --location <local|root|PATH>

*NOTE*: If the vdt-ca-manage command complains about not knowing the itb cache please use 
<pre class="rootscreen">
%UCL_PROMPT_ROOT% vdt-ca-manage setupca --location %RED%local%ENDCOLOR%  --url http://software-itb.grid.iu.edu/pacman/cadist/ca-certs-version
  Setting up CA Certificates for VDT installation at '/opt/osg-1.2.18'
  CA Certificates will be installed into /opt/osg-1.2.18/globus/share/certificates

  Setup completed successfully.
</pre>

---+++++ Manual Update
%RED%NOTE: Use vdt-ca-manage command for updates when possible. Only do a manual update if your installation does not have vdt-ca-manage installed%ENDCOLOR%

Check if you have vdt-update-certs installed. If it is not installed, *STOP!!! DO NOT MAKE ANY CHANGES* and contact the OSG security team immediately. 
<pre class="rootscreen">
%UCL_PROMPT_ROOT% source $VDT_LOCATION/setup.sh
%UCL_PROMPT_ROOT% which vdt-update-certs
/opt/osg-1.2.18/vdt/sbin/vdt-update-certs
</pre>

   * As superuser edit $VDT_LOCATION/vdt/etc/vdt-update-certs.conf, and change the cacerts_url parameter to:
   <pre class="file">
      cacerts_url = http://software-itb.grid.iu.edu/pacman/cadist/ca-certs-version
   </pre>
   * Save the new configuration file and the new Fetch CA and CRLs using instruction in the next section

---++++ Fetch CAs and CRLs
---+++++ Using vdt-ca-manage
<pre class="rootscreen">
%UCL_PROMPT_ROOT% vdt-ca-manage refreshCA
  Fetching CAs....
  vdt-update-certs
  Log file: /opt/osg-1.2.18/logs/vdt-update-certs.log
  Updates from: http://software-itb.grid.iu.edu/pacman/cadist/ca-certs-version

  Nothing to update: your CA certificate installation is already up-to-date.

%UCL_PROMPT_ROOT%vdt-ca-manage fetchCRL
  Fetching CRLs....

  ...done
</pre>
---+++++ Manual Update
%RED%NOTE: Only do a manual update method if your installation does not have vdt-ca-manage installed%ENDCOLOR%
   * Download new CA packages
<pre class="rootscreen">
%UCL_PROMPT_ROOT%$VDT_LOCATION/vdt/sbin/vdt-update-certs-wrapper
</pre>
*TIP*: On an existing install `crontab -l | grep vdt-update-certs-wrapper` as root will give you the command that is run via cron on your system and you can just copy paste it for the step above.
   * Update CRLs
<pre class="rootscreen">
%UCL_PROMPT_ROOT%$VDT_LOCATION/fetch-crl/share/doc/fetch-crl-2.6.6/fetch-crl.cron
</pre>
*TIP*: On an existing install `crontab -l | grep fetch-crl.cron` as root will give you the command that is run via cron on your system and you can just copy paste it for the step above.

---++++ Checking if the location has been updated using
<pre class="rootscreen">
%UCL_PROMPT_ROOT% vdt-ca-manage showcaurl
  http://software-itb.grid.iu.edu/pacman/cadist/ca-certs-version
%UCL_PROMPT_ROOT% vdt-version  | grep CA
  CA Certificates 1.17ITB (includes IGTF 1.38 CAs)
%UCL_PROMPT_ROOT% ls -la $VDT_LOCATION/globus/share/certificates/*.pem | wc
     91     819    9365
%UCL_PROMPT_ROOT% ls -la $VDT_LOCATION/globus/share/certificates/*.r0 | wc
     91     819    9373
</pre>

---++++Verify the operations of compute element 
   1. Use the script $VDT_LOCATION/verify/site_verify to see if any problems are being reported and if they are related to the new CA certificates
   2. Execute [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/CESimpleTest][simple CE tests]]
   3. If no problem was noticed leave the new CA package up for atleast 24 hours and report any failures due to CA certificates
   4. Observe RSV probe output and report any failures of RSV probes due to CA certificates.

---+++ WN Client installation
Options for CA installations on worker nodes can be installed [[https://twiki.grid.iu.edu/bin/view/ReleaseDocumentation/WorkerNodeClient#CA_Certificates_Installation_on][here]]. 
Use the same basic procedure above to update the CA packages at appropriate worker nodes based on your installation. 

---+++ Affects on the jobs on your system
If the update runs smoothly, ideally the OSG software in your system will have no issues with this new CA format and the user will not notice any difference. However, if the new CA format causes one or more OSG software to break your users might see some problems. If the authentication system were to break no new jobs may be able to submitted to your site and existing jobs would likely continue to run as long as they don't use their proxy for some tasks.

---+++ Reverting back to production cache

You should revert back to pointing to the OSG production CA cache 
   * After 24-48 hrs once all the tests have been successful or 
   * If the update causes problems with your system

%RED%NOTE%ENDCOLOR%: Reverting back to production cache after testing is extremely important. because we will constantly do tests using ITB cache and we would not want your production site to use ITB cache in the long run. The current tests are a special case and that is why we are asking production sites to temporarily use ITB cache with the active involvement of the production team.

Please follow the following steps to revert back
---++++Pointing to the OSG production cache
---+++++ Using vdt-ca-manage
<pre class="rootscreen">
%UCL_PROMPT_ROOT% source $VDT_LOCATION/setup.sh
%UCL_PROMPT_ROOT% vdt-ca-manage setupca --location %RED%local%ENDCOLOR%  --url osg
  Setting up CA Certificates for VDT installation at '/opt/osg-1.2.18'
  CA Certificates will be installed into /opt/osg-1.2.18/globus/share/certificates

  Setup completed successfully.
</pre>
*NOTE*: Please use appropriate parameter for --location for your installation. Available options: --location <local|root|PATH>

---+++++ Manual Update
%RED%NOTE: Only do a manual update if your installation does not have vdt-ca-manage installed%ENDCOLOR%

   * As superuser edit $VDT_LOCATION/vdt/etc/vdt-update-certs.conf, and change the cacerts_url parameter to:
   <pre class="file">
      cacerts_url = http://software.grid.iu.edu/pacman/cadist/ca-certs-version
   </pre>
   * Save the new configuration file and the new Fetch CA and CRLs using instruction in the next section

---++++ Update CAs and CRLs
---+++++Using vdt-ca-manage 
<pre class="rootscreen">
%UCL_PROMPT_ROOT% vdt-ca-manage refreshCA
  Fetching CAs....
  vdt-update-certs
  Log file: /opt/osg-1.2.18/logs/vdt-update-certs.log
  Updates from: http://software-itb.grid.iu.edu/pacman/cadist/ca-certs-version

  Nothing to update: your CA certificate installation is already up-to-date.

%UCL_PROMPT_ROOT%vdt-ca-manage fetchCRL
  Fetching CRLs....

  ...done
</pre>
---+++++ Manual Update
%RED%NOTE: Only do a manual update method if your installation does not have vdt-ca-manage installed%ENDCOLOR%
   * Download new CA packages
<pre class="rootscreen">
%UCL_PROMPT_ROOT%$VDT_LOCATION/vdt/sbin/vdt-update-certs-wrapper
</pre>
*TIP*: On an existing install `crontab -l | grep vdt-update-certs-wrapper` as root will give you the command that is run via cron on your system and you can just copy paste it for the step above.
   * Update crls
<pre class="rootscreen">
%UCL_PROMPT_ROOT%$VDT_LOCATION/fetch-crl/share/doc/fetch-crl-2.6.6/fetch-crl.cron
</pre>
*TIP*: On an existing install `crontab -l | grep fetch-crl.cron` as root will give you the command that is run via cron on your system and you can just copy paste it for the step above.

---++++ Checking if the location has been updated using
<pre class="rootscreen">
%UCL_PROMPT_ROOT% vdt-ca-manage showcaurl
  http://software.grid.iu.edu/pacman/cadist/ca-certs-version
%UCL_PROMPT_ROOT% vdt-version  | grep CA
  A Certificates 1.17 (includes IGTF 1.38 CAs)
%UCL_PROMPT_ROOT% ls -la $VDT_LOCATION/globus/share/certificates/*.pem | wc
  ls: $VDT_LOCATION/globus/share/certificates/*.pem: No such file or directory
        0       0       0
%UCL_PROMPT_ROOT% ls -la $VDT_LOCATION/globus/share/certificates/*.r0 | wc
       91     819    9373
</pre>

---+++ Questions for Admins
   1. Did you test both CE and WN client?
   1. For how long did your site use the CAs from ITB cache?
   1. Were any user jobs affected?
   1. Did you notice any authentication issues?
   1. Were the RSV probes affected the new CA package?
   1. Have you reverted back to the production cache?

-- Main.AnandPadmanabhan - 17 Mar 2011
