#!/bin/bash

REPO=osg-development # or osg for upgrades

PROBE=condor
#PROBE=psacct
# install probes:
yum install $PROBE
yum install --enablerepo=$REPO gratia-probe-$PROBE

# edit /etc/gratia/condor/ProbeConfig:

awk '

  $1 == "CollectorHost"       {$2 = "\"" HN ":8880\""}
  $1 == "SSLHost"             {$2 = "\"" HN ":8443\""}
  $1 == "SSLRegistrationHost" {$2 = "\"" HN ":8880\""}
  $1 == "SiteName"            {$2 = "\"TEST_" HN_S "\""}
  $1 == "Grid"                {$2 = "\"OSG-ITB\""}
  $1 == "EnableProbe"         {$2 = "\"1\""}
  $1 == "QuarantineUnknownVORecords" {$2 = "\"0\""}

  { print }

' {FS,OFS}="=" HN="$HOSTNAME" HN_S="$(hostname -s)" \
  /etc/gratia/$PROBE/ProbeConfig > /etc/gratia/$PROBE/ProbeConfig.new \
&& mv /etc/gratia/$PROBE/ProbeConfig{.new,}

#   CollectorHost="$HOSTNAME:8880"
#   SSLHost="$HOSTNAME:8443"
#   SSLRegistrationHost="$HOSTNAME:8880"

#   ProbeName="$PROBE:$HOSTNAME"
#   SiteName="TEST_$(hostname -s)"
#   Grid="OSG-ITB"
#   ...
#   EnableProbe="1"
#   QuarantineUnknownVORecords="0"  <-- unless you are setting up a VO

# cron setup:
service gratia-probes-cron start

# start condor:
#condor_master
service $PROBE start

# then ...
# - submit some sleep jobs to condor and wait a few min...

# manual start:
# /usr/share/gratia/condor/condor_meter

# wait a few min and check the web interface:
echo check web interface on:
echo "http://$HOSTNAME:8880/gratia-reporting/"
echo "http://$HOSTNAME:8880/gratia-administration/"

