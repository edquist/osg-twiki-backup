<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
lang="en" xml:lang="en">
<head>
<title>OpenSees OSG Integration Details</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2011-02-11 00:30:18 CST"/>
<meta name="author" content="Marko Slyz"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>
<div id="content">

<h1 class="title">OpenSees OSG Integration Details</h1>

<p><a href="https://twiki.grid.iu.edu/bin/view/Engagement/EngageOpenSeesB">(Up)</a>
</p>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Introduction </a></li>
<li><a href="#sec-2">2 Get a proxy certificate </a></li>
<li><a href="#sec-3">3 Create a Job Submission file </a>
<ul>
<li><a href="#sec-3_1">3.1 Manual Approach </a>
<ul>
<li><a href="#sec-3_1_1">3.1.1 opensees_input_file </a></li>
<li><a href="#sec-3_1_2">3.1.2 opensees_output_directory </a></li>
<li><a href="#sec-3_1_3">3.1.3 opensees_num_runs </a></li>
</ul>
</li>
<li><a href="#sec-3_2">3.2 (Mostly) Automatic Approach </a></li>
</ul>
</li>
<li><a href="#sec-4">4 While the Job is Running </a></li>
<li><a href="#sec-5">5 Automated Tests </a></li>
<li><a href="#sec-6">6 A More Realistic Test Case </a></li>
<li><a href="#sec-7">7 Appendix: Workflow Improvements </a>
<ul>
<li><a href="#sec-7_1">7.1 Untarring multiple output files at once </a></li>
<li><a href="#sec-7_2">7.2 Monitoring a running job </a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Introduction </h2>
<div class="outline-text-2" id="text-1">


<p>
OSG consistes of many <i>sites</i>, each of which is a
network of computers administered by a single
organization. The computers at any particular site
typically have the same software configuration, and
have access to a shared file system for the site.
</p>
<p>
We are going to be running jobs using the Condor
distributed computing system. More specifically, in
this case Condor will actually be running on top of a
system called glideinWMS, which makes it easier to
run at many sites, but that is mostly transparent to
us.
</p>
<p>
Background reading: <a href="https://twiki.grid.iu.edu/bin/view/Documentation/UsingTheGrid">UsingTheGrid</a>.
</p>
</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Get a proxy certificate </h2>
<div class="outline-text-2" id="text-2">


<p>
A proxy certificate is necessary to have permission
to run on OSG. The commands to get one are:
</p>
<pre class="example">
. /opt/osg/osg-1.2/setup.sh
</pre>


<p>
This command sets up the environment so that
condor and its associated commands (including the
ones to get a proxy) work.
</p>
<pre class="example">
voms-proxy-init -valid 72:00 --voms Engage:/Engage/NEES
</pre>


<p>
This gets a proxy certificate good for 3 days
good for running as the Engage VO in the NEES group.
Can add the "-debug" option if there are problems.
</p>
<pre class="example">
voms-proxy-info --all
</pre>


<p>
This lists some information about the new proxy.
</p>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Create a Job Submission file </h2>
<div class="outline-text-2" id="text-3">



</div>

<div id="outline-container-3_1" class="outline-3">
<h3 id="sec-3_1"><span class="section-number-3">3.1</span> Manual Approach </h3>
<div class="outline-text-3" id="text-3_1">


<p>
There is a kind of template file, <i>openseesA.csf</i>,
included in the distribution. The three variables that
need to change from run to run are at the top of the file:
</p>

</div>

<div id="outline-container-3_1_1" class="outline-4">
<h4 id="sec-3_1_1"><span class="section-number-4">3.1.1</span> opensees_input_file </h4>
<div class="outline-text-4" id="text-3_1_1">


<p>
This has to be in gzipped tar format. At the top
level there should be an OpenSees executable, and a
single directory that contains the OpenSees input
files. Both the executable and the directory
can have any valid name, but there must be only
one of each.
</p>
</div>

</div>

<div id="outline-container-3_1_2" class="outline-4">
<h4 id="sec-3_1_2"><span class="section-number-4">3.1.2</span> opensees_output_directory </h4>
<div class="outline-text-4" id="text-3_1_2">


<p>
This is a directory on the submit host where the
output from all of the runs from a particular
condor_submit command (see below) should go. It
just needs to be different from any other directory
names where output goes.
</p>
</div>

</div>

<div id="outline-container-3_1_3" class="outline-4">
<h4 id="sec-3_1_3"><span class="section-number-4">3.1.3</span> opensees_num_runs </h4>
<div class="outline-text-4" id="text-3_1_3">


<p>
This is the number of separate runs that gmMP.tcl
will do. Typically it's the number of lines in the
SAClaRecords.txt file, but could be less.
</p>
</div>
</div>

</div>

<div id="outline-container-3_2" class="outline-3">
<h3 id="sec-3_2"><span class="section-number-3">3.2</span> (Mostly) Automatic Approach </h3>
<div class="outline-text-3" id="text-3_2">


<p>
There is a script called setup_opensees.pl that
partially automates this process. Typing
"setup_opensees.pl -h" will print
out its usage, which currently says
</p>



<pre class="example">             ./setup_opensees.pl
This script modifies a template submit file to have
the proper parameters for running opensees, and also
creates the tar file and a directory for the output.
  This script should be run from the directory where
the submit will occur. All arguments are required
except -a.

-c [filename]
    Input condor submit file to be used as a template
    to run the job.  This can be an actual working
    submit file, but needs to have the
    opensees_input_file, opensees_output_directory,
    and opensees_num_runs macros at the top.

-o [filename]
    Name of condor submit file that will
    incorporate the changes.

-i [name of directory]
   Name of directory that contains the input
   data for OpenSees, like exampleTeraGridCode/.

-e [filename]
   Path to the OpenSees executable.

-t [filename]
   Name of tar file to later be used as input
   to runOpenSeesA.sh.

-d [name of directory]
    Directory on the submit host to store output. A
    relative path is ok.

-a [filename]
   Name of the dag file to produce. If the -a
   argument is not present then this script produces
   a regular condor submit file whose name is
   indicated by -o.
</pre>



<p>
An example of this command is:
</p>



<pre class="example">./setup_opensees.pl -c openseesA.csf -i exampleTeraGridCodeZZZ \
  -e ./OpenSees  -o test4.csf -t opensees_distA2.tgz -d test4_C \
  -a test4.dag
</pre>



<p>
Here the inputs (files or directories that must already exist)
are
</p><dl>
<dt><i>openseesA.csf</i></dt><dd>
is a template submission file,
</dd>
<dt><i>exampleTeraGridCodeZZZ</i></dt><dd>
has the input data for OpenSees,
</dd>
<dt><i>OpenSees</i></dt><dd>
is the executable to run on the worker node,
</dd>
</dl>

<p>and the outputs (files or directories that the
script creates) are:
</p><dl>
<dt><i>test4L.csf</i></dt><dd>
will be the resulting submission file
with the fields filled in,
</dd>
<dt><i>opensees_dist2A.tgz</i></dt><dd>
will have the OpenSees
executable and input data in the form (a
gzipped tar file ) that we send it to the
worker node,
</dd>
<dt><i>test4_C</i></dt><dd>
is the name of the directory where the
the output should go.
</dd>
<dt><i>test4.dag</i></dt><dd>
is the name of a DAG input file to
create.
</dd>
</dl>


<p>
The script will also print a suggested command to run the
job, in this case:<br/>
</p><pre class="example">
  condor_submit_dag -usedagdir test4_C/test4.dag\\
</pre>

<p>or without the -a option the command would be<br/>
</p><pre class="example">
  condor_submit test4L.csf
</pre>


<p>
Further reading:
<a href="http://www.cs.wisc.edu/condor/manual/v7.5/condor_submit.html">http://www.cs.wisc.edu/condor/manual/v7.5/condor\_submit.html</a>
For the -a option:
<a href="http://www.cs.wisc.edu/condor/manual/v7.5/condor_submit_dag.html">http://www.cs.wisc.edu/condor/manual/v7.5/condor\_submit\_dag.html</a>
<a href="http://www.cs.wisc.edu/condor/manual/v7.5/2_10DAGMan_Applications.html#sec:DAGLotsaJobs">http://www.cs.wisc.edu/condor/manual/v7.5/2\_10DAGMan\_Applications.html#sec:DAGLotsaJobs</a>
</p>
</div>
</div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> While the Job is Running </h2>
<div class="outline-text-2" id="text-4">


<p>
The status of the jobs while they are running can be checked
with a command like
</p><pre class="example">
 condor_q [username]
</pre>

<p>The status of the jobs can also be monitored by checking the
log file(s) that condor creates in the submit directory.
</p>
<p>
It is possible to stop the jobs before they're done
by issuing a command like
</p><pre class="example">
condor_rm [cluster #]
</pre>

<p>where the cluster number is printed by condor_submit,
or is listed as the number before the dot by condor_q.
</p>
</div>

</div>

<div id="outline-container-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Automated Tests </h2>
<div class="outline-text-2" id="text-5">


<p>
There is a script called test_opensees.pl that will
try running a couple OpenSees test cases. It expects
the directory exampleTeraGridCodeZZZ and the
executable OpenSees to be in the same directory from
which it is run. It may be run as follows:
</p>
<pre class="example">
./test_opensees.pl
</pre>


<p>
and doesn't need any arguments.
</p>
</div>

</div>

<div id="outline-container-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> A More Realistic Test Case </h2>
<div class="outline-text-2" id="text-6">

<ol>
<li>
Suppose the directory with the input data is called
<code>exampleTeraGridCode_long</code>. Make sure to to modify
userDir in gmMP.tcl to say
<pre class="example">
set userDir "[pwd]/exampleTeraGridCode_long"
</pre>

<p>(This is specific to this user's OpenSees setup.)
</p></li>
<li>
Run this command to set things up:
<pre class="example">
./setup_opensees.pl -c openseesA.csf -o test_fnpB.csf -t opensees_distA2_fnpB.tgz -i exampleTeraGridCode_rl -e ./OpenSees -d test_fnpB -a test_fnpB.dag
</pre>

</li>
<li>
If necessary, fix the dag file to have the runs you'd like.
<pre class="example">
cd test_fnpB
nano test_fnpB.dag
</pre>

</li>
<li>
Submit job using the command from setup_opensees.pl:
<pre class="example">
   condor_submit_dag -usedagdir test_fnpB/test_fnpB.dag
</pre>

</li>
<li>
Check its progress with
<pre class="example">
  condor_q [username]
</pre>

</li>
</ol>


</div>

</div>

<div id="outline-container-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Appendix: Workflow Improvements </h2>
<div class="outline-text-2" id="text-7">



</div>

<div id="outline-container-7_1" class="outline-3">
<h3 id="sec-7_1"><span class="section-number-3">7.1</span> Untarring multiple output files at once </h3>
<div class="outline-text-3" id="text-7_1">


<p>
<a href="untarring_multiple_output_filesA.txt">Here is an example with comments</a> that
uses a for loop to untar
several output files at once.
</p>
</div>

</div>

<div id="outline-container-7_2" class="outline-3">
<h3 id="sec-7_2"><span class="section-number-3">7.2</span> Monitoring a running job </h3>
<div class="outline-text-3" id="text-7_2">

<ol>
<li>
 <code>condor_ssh_to_job  [jobid]</code><br/>
This should start a login session at the
computer where the job is running.
Then it's possible to check
the output files etc using standard
unix commands like less/more, tail, etc.

</li>
<li>
<code>glidein_ls [jobid]</code><br/>
This lists the files in the directory
where condor is running.

<p>
<code>glidein_interactive [jobid] [command]</code><br/>
This runs an arbitrary command in that
directory.
</p>
<p>
It may be that one or the other
of these monitoring options doesn't work for any
particular job, but hopefully at
least one does.
</p>
<p>
<a href="./interactive_access_to_running_jobB.txt">Here is a sample session</a> that
uses these commands.
</p>
</li>
</ol>

<p><a href="https://twiki.grid.iu.edu/bin/view/Engagement/EngageOpenSeesB">(Up)</a>
</p>
</div>
</div>
</div>
<div id="postamble">
<p class="author"> Author: Marko Slyz
</p>
<p class="date"> Date: 2011-02-11 00:30:18 CST</p>
</div>
</div>
</body>
</html>
